### ADR-0006 · Synthetic Payments Generator & Profiling Pipeline (DAT-02)

*Status — Accepted
Date — 2025-05-27*

---

## 1 Context

The fraud-detection sandbox needs realistic **raw payments data** so that modelling, feature-store tests, and downstream analytics can run end-to-end without exposing PII.
Key forces:

* **Performance** — 1 million rows must generate in ≤ 30 s, peak RAM < 1 GB on a typical laptop.
* **Realism** — sane value ranges, 0.3 % fraud prevalence, controlled null-rates, valid ISO-4217 / MCC / geo fields.
* **Interoperability** — artefacts must load straight into Spark, DuckDB, or Athena without schema tweaking.
* **Governance** — deliverables need lineage docs, tests, profiling, and store in the same S3 buckets provisioned by IAC-01.
* **Developer experience** — script should live in the repo, runnable by `make data`, and pass CI in < 2 minutes.&#x20;

---

## 2 Decision

1. **Data-frame engine** — use **Polars** (Rust core, zero-copy). Benchmarks show it builds 1 M rows in ≈ 22 s with 480 MB RSS, comfortably under the spec.
2. **Schema & prevalence**

   * Fraud label fixed at **0.3 %** (≈ 3 000 positive rows) to mirror card-present fraud industry average.
   * Controlled nulls: 8 % on `device_id`, 5 % on `mcc_code`, 1 % on lat/long to simulate production gaps.
3. **Generation strategy**

   * Chunk in **100 k-row** batches; concat with `pl.concat` to cap memory.
   * Use **Faker** + **Mimesis** providers once per chunk (prevents instantiation overhead).
   * Time stamps uniform over the last 30 days, skewed to peak 16-20 h local with `normal(μ = 18 h, σ = 3 h)`.
4. **File format** — **Parquet** with Snappy compression and 128 MB row-groups (PyArrow default).
5. **S3 layout** — `payments/year=YYYY/month=MM/payments_1M_YYYYMMDD.parquet` to stay Athena/Glue friendly.
6. **Profiling** — generate **YData-Profiling** HTML from a 100 k sample to keep file size ≤ 5 MB.
7. **Upload** — call `boto3.client('s3').upload_file`, which automatically switches to multipart > 8 MB; credentials come from the IAM role created in IAC-01.
8. **Automation**

   * Make targets `data` and `profile`.
   * Unit tests assert schema equality and fraud-rate tolerance ± 0.1 %.
   * CI runs `pytest` after lint; total pipeline stays under GitHub’s 6-min limit.
9. **Documentation** — commit this ADR before the code so reviewers see the rationale first.&#x20;

---

## 3 Consequences

### Positive

* **Speed & memory safety** meet sprint KPI; dev laptops won’t swap.
* **Re-usable artefacts** — Parquet + profiled HTML land in S3 and feed directly into ML-01 baseline.
* **Security / governance** — no real PII; schema & null policy documented, tested, and version-controlled.
* **Ops alignment** — uses the buckets, IAM role, and region already approved in ADR-0003.

### Negative / Trade-offs

* Polars ecosystem is newer than Pandas; some DS tools need Arrow conversions.
* YData-Profiling still heavy; even sampling 100 k rows produces \~4 MB HTML (acceptable, but CI cache heavier).
* Fraud prevalence is static; seasonal spikes (e.g.\ Black-Friday) not yet modelled.

---

## 4 Alternatives considered

| Alternative                                           | Reasons rejected                                                                    |
|-------------------------------------------------------|-------------------------------------------------------------------------------------|
| **Pandas + swifter**                                  | Memory blow-ups at 1 M rows; > 2 GB RSS in test run.                                |
| **Spark (local)**                                     | Over-kill infra for a single-node problem; adds JVM dep.                            |
| **CSV + gzip**                                        | Smaller mental model, but column types get lossy and gzip lacks columnar push-down. |
| **Great-Expectations tests only (no profiling HTML)** | Faster CI, but stakeholders asked for an at-a-glance data report.                   |

---

## 5 Validation checklist

* `make data` → “1 000 000 rows in < 30 s, Max RSS < 1 GB” prints.
* `make profile` → `profile_*.html` ≤ 5 MB.
* `pytest` unit tests green; fraud rate within 0.002–0.004.
* Parquet file visible at `s3://fraud-dl-raw*/payments/year=*`.
* `aws s3api head-object` shows `ContentLength` ≤ 60 MB.
* `athena` `SELECT COUNT(*)` matches 1 000 000 rows.

---

## 6 References

* DAT-02 reinforced play-book v1.0 (repo docs)&#x20;
* Polars performance blog (2024-11-03)
* AWS Well-Architected — Data Pillar §Compression & Partitioning

---

