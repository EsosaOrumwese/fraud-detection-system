# ADR-0010 · Local Airflow 3 Stack for Orchestration (ORCH-01)

*Status — Accepted*  
*Created — 2025-06-12*  
*Revised — 2025-06-14 (switch to CeleryExecutor & ASF template)*  
*Author — Esosa Orumwese*

---

## 1 Context  

Sprint-02 introduces automated daily pipelines.  
We need a reproducible, laptop-friendly **Apache Airflow 3.0** installation so developers can build & debug DAGs before we graduate to MWAA (managed) in a later milestone.

Key forces  

| Force                    | Why it matters                                     |
|--------------------------|----------------------------------------------------|
| **Recruiter signal**     | Airflow is de-facto standard; demo UI is expected. |
| **Zero-to-UI in < 30 s** | On-boarding, CI smoke-tests, workshop sessions.    |
| **Cross-platform**       | x86_64 & Apple Silicon (M-series) laptops.         |
| **Auditability**         | Compose YAML committed; linted in pre-commit & CI. |
| **Cost & RAM**           | LocalExecutor only; each service capped at 1 GB.   |

---

## 2 Decision  

### 2.1 Folder layout  

```

orchestration/airflow/
├── docker-compose.yml      # 95 % identical to ASF template
├── scripts/bootstrap.sh    # one-shot .env generator
├── dags/  plugins/  config/  logs/   # mapped into containers
└── .env  (git-ignored)

````

### 2.2 Container topology  

| Service          | Image                        | Purpose                          |
|------------------|------------------------------|----------------------------------|
| **postgres**     | `postgres:15`                | Metadata & result DB             |
| **redis**        | `redis:7.2-bookworm`         | Celery broker                    |
| **airflow-init** | `apache/airflow:3.0.2`       | One-shot DB migrate + admin user |
| **webserver**    | same image → `webserver` cmd | UI                               |
| **scheduler**    | same image → `scheduler` cmd | DAG parsing / scheduling         |
| **worker**       | same image → `celery worker` | Task execution                   |

Executor = **`CeleryExecutor`** (scale-out friendly).  
`AIRFLOW_UID` set in `.env` to ensure non-root file ownership on host.  
Multi-arch: adding `IMAGE_ARCH_SUFFIX=-arm64` in `.env` pulls Apple-Silicon images.

### 2.3 Bootstrap & secrets  

`bootstrap.sh` (idempotent) creates `.env` with:

* random **FERNET_KEY** & **SECRET_KEY**  
* **AIRFLOW_UID** (`$(id -u)` or 50000 fallback)  
* optional **IMAGE_ARCH_SUFFIX**

### 2.4 Dev-experience helpers  

* **Make targets**: `airflow-up`, `airflow-down`, `airflow-logs`, guarded by an idempotent **bootstrap script** that creates Fernet & Flask secret keys in a `.env` file (git-ignored).  
* `.gitignore` excludes `logs/` and `postgres_data/`.  
* Pre-commit hook `compose-lint` runs `docker compose config` to block YAML mistakes early.  
* CI job (5 s) repeats the same lint in the GitHub Actions workflow.

### 2.5 Safety rails  

* `mem_limit: 1g` on both Airflow containers prevents laptop fan spin-ups.  
* Health-checks ensure the scheduler waits for Postgres before starting.  
* No volumes are mounted in CI, so the workflow never persists data between runs.

---

## 3 Consequences

| ✅ Pros                                                  | ⚠️ Cons / Trade-offs                                |
|---------------------------------------------------------|-----------------------------------------------------|
| Mirrors **real-world prod** topology (Celery + broker). | Adds **redis + worker** containers → +300 MB RAM.   |
| Uses upstream template → least surprise for new hires.  | Compose file is longer; more env vars to manage.    |
| `AIRFLOW_UID` prevents root-owned artefacts.            | Celery adds latency vs. LocalExecutor for tiny DAGs |
| Health-checks & `depends_on` remove first-boot races.   | `.env` secrets still local; prod will need Vault.   |

---

## 4 Change log (delta vs. original ADR-0010 @ 2025-06-11)

| Section           | Old                                  | New                                            |
|-------------------|--------------------------------------|------------------------------------------------|
| **Executor**      | LocalExecutor (2 containers)         | **CeleryExecutor** (web + scheduler + worker)  |
| **Images**        | implicit `apache/airflow:3.0.2`      | same tag, but param-ised for arm64 suffix      |
| **Secrets**       | Fernet/Flask keys generated manually | `.env` auto-generated by `bootstrap.sh`        |
| **Redis**         | not present                          | **Added** broker container                     |
| **Health-checks** | minimal                              | full ASF template checks                       |
| **Make targets**  | `airflow-up/down/logs`               | same plus `airflow-bootstrap`, `airflow-reset` |
| **CI check**      | compose lint                         | unchanged (path updated)                       |

---

## 5 Validation checklist

1. `make airflow-up` ⇒ **six** services running; UI on [http://localhost:8080](http://localhost:8080).
2. Login `admin/admin` (created by init container).
3. Enable `example_bash_operator`, trigger → succeeds (proves worker ↔ scheduler ↔ DB ↔ Redis).
4. `docker compose … config` exits 0 in pre-commit & CI.
5. `make airflow-down && make airflow-reset` leaves no dangling volumes.

---

## 6 Future improvements (unchanged)

* Mount project DAGs, add provider requirements via `_PIP_ADDITIONAL_REQUIREMENTS`.
* DevContainer for VS Code.
* MWAA parity stack (same executor/broker).
* Prometheus metrics, OpenTelemetry traces.

---

## 7 Change history  

| Date       | Author      | Change                                  |
|------------|-------------|-----------------------------------------|
| 2025-06-11 | E. Orumwese | Initial ADR-0010 accepted.              |
| 2025-06-14 | E. Orumwese | Modified ADR-0010, reviews and accepted |

