# ADR-0010 · Local Airflow 3 Stack for Orchestration (ORCH-01)

*Status — Accepted*  
*Created — 2025-06-12*  
*Author — Esosa Orumwese*

---

## 1 Context  

Sprint-02 introduces automated daily pipelines.  
We need a reproducible, laptop-friendly **Apache Airflow 3.0** installation so developers can build & debug DAGs before we graduate to MWAA (managed) in a later milestone.

Key forces  

| Force                    | Why it matters                                     |
|--------------------------|----------------------------------------------------|
| **Recruiter signal**     | Airflow is de-facto standard; demo UI is expected. |
| **Zero-to-UI in < 30 s** | On-boarding, CI smoke-tests, workshop sessions.    |
| **Cross-platform**       | x86_64 & Apple Silicon (M-series) laptops.         |
| **Auditability**         | Compose YAML committed; linted in pre-commit & CI. |
| **Cost & RAM**           | LocalExecutor only; each service capped at 1 GB.   |

---

## 2 Decision  

### 2.1 Container stack (docker-compose v3.9)

| Service     | Image tag                                  | Notes                           |
|-------------|--------------------------------------------|---------------------------------|
| `postgres`  | `postgres:15`                              | Metadata DB; no volumes in CI.  |
| `webserver` | `apache/airflow:3.0.2-python3.10(+-arm64)` | Health-checks; `mem_limit: 1g`. |
| `scheduler` | same as webserver                          | Depends on webserver healthy.   |

Common environment (`x-airflow-env`):

* `AIRFLOW__CORE__EXECUTOR = LocalExecutor` (single-node realism).  
* `AIRFLOW__CORE__LOAD_EXAMPLES = False` (no toy DAG bloat).  
* Connection string to Postgres set via env var (avoids secrets in YAML).  
* `_PIP_ADDITIONAL_REQUIREMENTS` empty for now ­– keeps image pulls fast.

ARM laptops set `IMAGE_ARCH_SUFFIX=-arm64` in `.env` to pull the right variant.

### 2.2 Dev-experience helpers  

* **Make targets**: `airflow-up`, `airflow-down`, `airflow-logs`, guarded by an idempotent **bootstrap script** that creates Fernet & Flask secret keys in a `.env` file (git-ignored).  
* `.gitignore` excludes `logs/` and `postgres_data/`.  
* Pre-commit hook `compose-lint` runs `docker compose config` to block YAML mistakes early.  
* CI job (5 s) repeats the same lint in the GitHub Actions workflow.

### 2.3 Safety rails  

* `mem_limit: 1g` on both Airflow containers prevents laptop fan spin-ups.  
* Health-checks ensure the scheduler waits for Postgres before starting.  
* No volumes are mounted in CI, so the workflow never persists data between runs.

---

## 3 Consequences  

### Positive  

* **One command → UI** (`make airflow-up`) consistently on macOS, Windows WSL, Linux, and in workshop VMs.  
* **Code-as-config** – every change to the orchestration layer is version-controlled and reviewed.  
* **Fast feedback** – pre-commit & CI catch compose syntax issues in <10 s, no containers started.  
* **Future-proof** – image uses Airflow 3.0.x which matches MWAA target version; moving to MWAA later is mostly config lift.

### Negative / Trade-offs  

* LocalExecutor can’t surface multi-worker concurrency bugs; we accept this in dev.  
* Postgres volume grows unless developers run `airflow-down && docker volume rm ...`; README calls this out.  
* Secrets (Fernet, Flask) live in `.env`; developers must never commit the file (git-ignored by default).

---

## 4 Alternatives considered  

| Option                           | Why rejected                                                                |
|----------------------------------|-----------------------------------------------------------------------------|
| **Prefect 2 Cloud quick-start**  | Team pivoted to Airflow for wider adoption & recruiter signal (ADR-0008).   |
| **Kind-based Kubernetes + Helm** | Heavier install, slower inner loop; MWAA is future managed target anyway.   |
| **SQLite + SequentialExecutor**  | Simplest, but fails under parallel task loads; LocalExecutor truer to prod. |

---

## 5 Validation checklist  

* `make airflow-up` → UI at <http://localhost:8080> (admin/admin) in < 40 s.  
* `docker compose … config` passes in pre-commit and CI.  
* Screenshot `docs/img/airflow_ui.png` committed for Sprint-02 demo.  
* Issue **ORCH-01** moved to **Done** with green CI.

---

## 6 Future improvements (Sprint-02 / 03)  

1. Add **Airflow DAG** mounts for `feature_materialise` and `daily_synthetic`.  
2. Install extra providers via `_PIP_ADDITIONAL_REQUIREMENTS` (Feast, AWS).  
3. Publish the stack as a **DevContainer** (`.devcontainer.json`) to reduce local setup.  
4. Replace LocalExecutor with **CeleryExecutor** once multi-worker testing is needed.  
5. Export metrics to Prometheus for Dag-level SLA monitoring.

---

## 7 Change history  

| Date       | Author      | Change                     |
|------------|-------------|----------------------------|
| 2025-06-11 | E. Orumwese | Initial ADR-0010 accepted. |

