$schema: https://json-schema.org/draft/2020-12/schema
$id: decision_payload.schema.yaml
title: Decision Payload
type: object
additionalProperties: false
required:
  - decision_id
  - decision_kind
  - bundle_ref
  - snapshot_hash
  - graph_version
  - eb_offset_basis
  - degrade_posture
  - pins
  - decided_at_utc
  - policy_rev
  - run_config_digest
  - source_event
  - decision
properties:
  decision_id:
    $ref: "#/$defs/hex32"
  decision_kind:
    type: string
    minLength: 1
    maxLength: 128
  bundle_ref:
    $ref: "#/$defs/bundle_ref"
  snapshot_hash:
    $ref: "#/$defs/hex64"
  snapshot_ref:
    type: string
    minLength: 1
    maxLength: 2048
  graph_version:
    $ref: "#/$defs/graph_version"
  eb_offset_basis:
    $ref: "#/$defs/eb_offset_basis"
  degrade_posture:
    $ref: "#/$defs/degrade_posture"
  pins:
    $ref: "#/$defs/pins"
  decided_at_utc:
    $ref: "#/$defs/rfc3339_micros"
  run_config_digest:
    $ref: "#/$defs/hex64"
  policy_rev:
    $ref: "#/$defs/policy_rev"
  source_event:
    $ref: "#/$defs/event_ref"
  context_refs:
    type: array
    items:
      $ref: "#/$defs/context_ref"
  decision:
    type: object
    additionalProperties: true
  reason_codes:
    type: array
    items:
      type: string
      minLength: 1
      maxLength: 128
$defs:
  hex32:
    type: string
    pattern: "^[0-9a-f]{32}$"
  hex64:
    type: string
    pattern: "^[0-9a-f]{64}$"
  platform_run_id:
    type: string
    pattern: "^platform_[0-9]{8}T[0-9]{6}Z$"
  uint64:
    type: integer
    minimum: 0
  rfc3339_micros:
    type: string
    minLength: 1
  pins:
    type: object
    additionalProperties: false
    required:
      - manifest_fingerprint
      - parameter_hash
      - seed
      - scenario_id
      - platform_run_id
      - scenario_run_id
    properties:
      manifest_fingerprint:
        $ref: "#/$defs/hex64"
      parameter_hash:
        $ref: "#/$defs/hex64"
      seed:
        $ref: "#/$defs/uint64"
      scenario_id:
        type: string
        minLength: 1
        maxLength: 256
      platform_run_id:
        $ref: "#/$defs/platform_run_id"
      scenario_run_id:
        $ref: "#/$defs/hex32"
      run_id:
        $ref: "#/$defs/hex32"
  bundle_ref:
    type: object
    additionalProperties: false
    required: [bundle_id]
    properties:
      bundle_id:
        $ref: "#/$defs/hex64"
      registry_ref:
        type: string
        minLength: 1
        maxLength: 2048
      bundle_version:
        type: string
        minLength: 1
        maxLength: 128
  policy_rev:
    type: object
    additionalProperties: false
    required: [policy_id, revision]
    properties:
      policy_id:
        type: string
      revision:
        type: string
      content_digest:
        $ref: "#/$defs/hex64"
  degrade_posture:
    type: object
    additionalProperties: false
    required: [mode, capabilities_mask, policy_rev, posture_seq, decided_at_utc]
    properties:
      mode:
        type: string
        enum: [NORMAL, DEGRADED_1, DEGRADED_2, FAIL_CLOSED]
      capabilities_mask:
        type: object
        additionalProperties: false
        required:
          - allow_ieg
          - allowed_feature_groups
          - allow_model_primary
          - allow_model_stage2
          - allow_fallback_heuristics
          - action_posture
        properties:
          allow_ieg:
            type: boolean
          allowed_feature_groups:
            type: array
            items:
              type: string
              minLength: 1
              maxLength: 128
          allow_model_primary:
            type: boolean
          allow_model_stage2:
            type: boolean
          allow_fallback_heuristics:
            type: boolean
          action_posture:
            type: string
            enum: [NORMAL, STEP_UP_ONLY]
      policy_rev:
        $ref: "#/$defs/policy_rev"
      posture_seq:
        type: integer
        minimum: 0
      decided_at_utc:
        $ref: "#/$defs/rfc3339_micros"
      reason:
        type: string
        maxLength: 2048
      evidence_refs:
        type: array
        items:
          type: object
          additionalProperties: false
          required: [kind, ref]
          properties:
            kind:
              type: string
              minLength: 1
              maxLength: 64
            ref:
              type: string
              minLength: 1
              maxLength: 2048
  eb_offset_basis:
    type: object
    additionalProperties: false
    required: [stream, offset_kind, offsets]
    properties:
      stream:
        type: string
        minLength: 1
        maxLength: 256
      basis_digest:
        $ref: "#/$defs/hex64"
      offset_kind:
        type: string
        enum: [kinesis_sequence, kafka_offset, file_line]
      offsets:
        type: array
        minItems: 1
        items:
          type: object
          additionalProperties: false
          required: [partition, offset]
          properties:
            partition:
              type: integer
              minimum: 0
            offset:
              type: string
              minLength: 1
              maxLength: 128
      window_start_utc:
        $ref: "#/$defs/rfc3339_micros"
      window_end_utc:
        $ref: "#/$defs/rfc3339_micros"
  graph_version:
    type: object
    additionalProperties: false
    required: [version_id, watermark_ts_utc]
    properties:
      version_id:
        $ref: "#/$defs/hex32"
      stream:
        type: string
        minLength: 1
        maxLength: 256
      basis_digest:
        $ref: "#/$defs/hex64"
      watermark_ts_utc:
        $ref: "#/$defs/rfc3339_micros"
      computed_at_utc:
        $ref: "#/$defs/rfc3339_micros"
  eb_ref:
    type: object
    additionalProperties: false
    required: [topic, partition, offset, offset_kind]
    properties:
      topic:
        type: string
        minLength: 1
        maxLength: 256
      partition:
        type: integer
        minimum: 0
      offset:
        type: string
        minLength: 1
        maxLength: 128
      offset_kind:
        type: string
        enum: [file_line, kinesis_sequence, kafka_offset]
      published_at_utc:
        $ref: "#/$defs/rfc3339_micros"
  event_ref:
    type: object
    additionalProperties: false
    required: [event_id, event_type, ts_utc, eb_ref]
    properties:
      event_id:
        type: string
        minLength: 1
        maxLength: 256
      event_type:
        type: string
        minLength: 1
        maxLength: 256
      ts_utc:
        $ref: "#/$defs/rfc3339_micros"
      eb_ref:
        $ref: "#/$defs/eb_ref"
  context_ref:
    type: object
    additionalProperties: false
    required: [event_id, event_type, eb_ref, role]
    properties:
      event_id:
        type: string
        minLength: 1
        maxLength: 256
      event_type:
        type: string
        minLength: 1
        maxLength: 256
      eb_ref:
        $ref: "#/$defs/eb_ref"
      role:
        type: string
        enum: [arrival_events, arrival_entities, flow_anchor]
