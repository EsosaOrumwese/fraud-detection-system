$schema: https://json-schema.org/draft/2020-12/schema
$id: feature_snapshot.schema.yaml
title: Feature Snapshot
type: object
additionalProperties: false
required:
  - snapshot_hash
  - graph_version
  - eb_offset_basis
  - pins
  - created_at_utc
  - features
properties:
  snapshot_hash:
    $ref: "#/$defs/hex64"
  graph_version:
    $ref: "#/$defs/graph_version"
  eb_offset_basis:
    $ref: "#/$defs/eb_offset_basis"
  pins:
    $ref: "#/$defs/pins"
  created_at_utc:
    $ref: "#/$defs/rfc3339_micros"
  features:
    type: object
    additionalProperties: true
  notes:
    type: string
    maxLength: 2048
$defs:
  hex32:
    type: string
    pattern: "^[0-9a-f]{32}$"
  hex64:
    type: string
    pattern: "^[0-9a-f]{64}$"
  uint64:
    type: integer
    minimum: 0
  rfc3339_micros:
    type: string
    minLength: 1
  pins:
    type: object
    additionalProperties: false
    required: [manifest_fingerprint, parameter_hash, seed, scenario_id, run_id]
    properties:
      manifest_fingerprint:
        $ref: "#/$defs/hex64"
      parameter_hash:
        $ref: "#/$defs/hex64"
      seed:
        $ref: "#/$defs/uint64"
      scenario_id:
        type: string
        minLength: 1
        maxLength: 256
      run_id:
        $ref: "#/$defs/hex32"
  eb_offset_basis:
    type: object
    additionalProperties: false
    required: [stream, offset_kind, offsets]
    properties:
      stream:
        type: string
        minLength: 1
        maxLength: 256
      offset_kind:
        type: string
        enum: [kinesis_sequence, kafka_offset, file_line]
      offsets:
        type: array
        minItems: 1
        items:
          type: object
          additionalProperties: false
          required: [partition, offset]
          properties:
            partition:
              type: integer
              minimum: 0
            offset:
              type: string
              minLength: 1
              maxLength: 128
      window_start_utc:
        $ref: "#/$defs/rfc3339_micros"
      window_end_utc:
        $ref: "#/$defs/rfc3339_micros"
  graph_version:
    type: object
    additionalProperties: false
    required: [version_id, watermark_ts_utc]
    properties:
      version_id:
        $ref: "#/$defs/hex32"
      watermark_ts_utc:
        $ref: "#/$defs/rfc3339_micros"
      computed_at_utc:
        $ref: "#/$defs/rfc3339_micros"
