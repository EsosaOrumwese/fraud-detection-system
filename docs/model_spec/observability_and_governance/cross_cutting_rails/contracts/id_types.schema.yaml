$schema: "https://json-schema.org/draft/2020-12/schema"
$id: "docs/model_spec/observability_and_governance/cross_cutting_rails/contracts/id_types.schema.yaml"
title: "Cross-cutting Rails â€” ID & Primitive Types"
description: >
  Reusable JSON-Schema definitions (expressed in YAML) for canonical identifiers,
  references, timestamps, digests, enums, and small composite identity objects
  used across Rails-owned contracts (envelope, receipts, run records).
type: object
additionalProperties: true

$defs:
  # ---------------------------
  # Base primitives
  # ---------------------------

  nonempty_string:
    type: string
    minLength: 1
    maxLength: 4096
    description: "Generic non-empty UTF-8 string."

  opaque_id:
    type: string
    minLength: 1
    maxLength: 512
    description: >
      Opaque identifier. Consumers MUST treat as an atomic token (no parsing assumptions).

  long_ref:
    type: string
    minLength: 1
    maxLength: 2048
    description: >
      Opaque reference string (path/URI/topic/checkpoint/etc.). Must be pinnable and deterministic.

  utc_timestamp:
    type: string
    format: date-time
    pattern: "Z$"
    description: "UTC timestamp in RFC3339 format (date-time), must end with 'Z'."

  utc_timestamp_or_null:
    description: "UTC timestamp (RFC3339) or null (e.g., not yet set at emission)."
    oneOf:
      - $ref: "#/$defs/utc_timestamp"
      - type: "null"

  nonneg_int64:
    type: integer
    minimum: 0
    maximum: 9223372036854775807
    description: "Non-negative 64-bit integer."

  uint64:
    type: integer
    minimum: 0
    maximum: 18446744073709551615
    description: "Unsigned 64-bit integer."

  pos_int64:
    type: integer
    minimum: 1
    maximum: 9223372036854775807
    description: "Positive 64-bit integer."

  # Digest strings are intentionally permissive: algorithm tag + ':' + payload.
  # Payload may be hex/base64/other content-address forms.
  digest:
    type: string
    minLength: 8
    maxLength: 4096
    pattern: "^[A-Za-z0-9][A-Za-z0-9_-]{0,31}:[A-Za-z0-9+/=_-]{16,4096}$"
    description: >
      Content digest in the form "<alg>:<value>" (e.g., "sha256:...").
      Used to bind receipts/gates to exact content.

  reason_code:
    type: string
    minLength: 1
    maxLength: 128
    pattern: "^[A-Z][A-Z0-9_.-]{0,127}$"
    description: >
      Machine-readable reason code token (UPPERCASE recommended),
      e.g., "SCHEMA_INVALID", "PASS_MISSING_OR_INVALID".

  # ---------------------------
  # Canonical identifiers (pinned names)
  # ---------------------------

  parameter_hash:
    allOf:
      - $ref: "#/$defs/opaque_id"
    description: "World identity: content-derived hash of declared world-defining parameters/config."

  manifest_fingerprint:
    allOf:
      - $ref: "#/$defs/opaque_id"
    description: "World identity: identifier of the materialised world-manifest instance."

  scenario_id:
    allOf:
      - $ref: "#/$defs/opaque_id"
    description: "Run identity: identifier of the scenario definition/plan."

  run_id:
    allOf:
      - $ref: "#/$defs/opaque_id"
    description: "Run identity: identifier of a single concrete execution instance."

  seed:
    allOf:
      - $ref: "#/$defs/uint64"
    description: "RNG identity: declared uint64 seed attributable to stochastic outcomes."

  event_id:
    allOf:
      - $ref: "#/$defs/opaque_id"
    description: "Event identity: globally unique identifier for an event instance."

  receipt_id:
    allOf:
      - $ref: "#/$defs/opaque_id"
    description: "Receipt identity: globally unique identifier for a boundary/verification receipt."

  # Producer / issuer / validator identities
  producer_id:
    allOf:
      - $ref: "#/$defs/opaque_id"
    description: "Stable component identifier for an event producer."

  issuer_id:
    allOf:
      - $ref: "#/$defs/opaque_id"
    description: "Stable component identifier for a receipt issuer (boundary service)."

  validator_id:
    allOf:
      - $ref: "#/$defs/opaque_id"
    description: "Stable component identifier for a HashGate validator."

  # Versions
  producer_version:
    allOf:
      - $ref: "#/$defs/nonempty_string"
    description: "Producer build/version identifier (opaque; semver-like allowed)."

  issuer_version:
    allOf:
      - $ref: "#/$defs/nonempty_string"
    description: "Issuer build/version identifier (opaque; semver-like allowed)."

  validator_version:
    allOf:
      - $ref: "#/$defs/nonempty_string"
    description: "Validator build/version identifier (opaque; semver-like allowed)."

  # Refs
  schema_ref:
    allOf:
      - $ref: "#/$defs/long_ref"
    description: >
      Pinned reference identifying the exact authoritative schema version governing an object.

  validated_schema_ref:
    allOf:
      - $ref: "#/$defs/long_ref"
    description: "Pinned reference to the schema that was actually validated at a boundary."

  target_ref:
    allOf:
      - $ref: "#/$defs/long_ref"
    description: >
      Reference to a target object/stream/checkpoint/path that a receipt/gate applies to.

  partition_key:
    type: string
    minLength: 1
    maxLength: 512
    description: "Routing/partition key used by bus/storage partitioning."

  sequence:
    allOf:
      - $ref: "#/$defs/nonneg_int64"
    description: "Optional monotonic ordering indicator within a partition."

  correlation_id:
    allOf:
      - $ref: "#/$defs/opaque_id"
    description: "Optional correlation identifier tying a chain of events across components."

  causation_id:
    allOf:
      - $ref: "#/$defs/opaque_id"
    description: "Optional reference to the causal predecessor event_id."

  trace_id:
    allOf:
      - $ref: "#/$defs/opaque_id"
    description: "Optional distributed tracing trace identifier."

  span_id:
    allOf:
      - $ref: "#/$defs/opaque_id"
    description: "Optional distributed tracing span identifier."

  event_type:
    type: string
    minLength: 1
    maxLength: 256
    pattern: "^[A-Za-z0-9][A-Za-z0-9_.:-]{0,255}$"
    description: >
      Namespaced semantic event type token (examples: "decision.emitted", "feature.vector.materialised").

  # ---------------------------
  # Small pinned enums (used across rails contracts)
  # ---------------------------

  classification:
    type: string
    enum: ["PUBLIC", "INTERNAL", "CONFIDENTIAL", "RESTRICTED"]
    description: "Data classification level."

  ingestion_outcome:
    type: string
    enum: ["ACCEPTED", "REJECTED", "QUARANTINED"]
    description: "Ingestion boundary decision outcome."

  hashgate_outcome:
    type: string
    enum: ["PASS", "FAIL"]
    description: "HashGate verification outcome."

  degrade_mode:
    type: string
    enum:
      - "NORMAL"
      - "REDUCED_FUNCTION"
      - "STALE_ALLOWED"
      - "RULES_ONLY"
      - "GUARDRAILS_ONLY"
      - "FAIL_CLOSED"
    description: "Canonical degrade mode categories."

  # ---------------------------
  # Common arrays / maps
  # ---------------------------

  reason_codes:
    type: array
    minItems: 0
    maxItems: 256
    items:
      $ref: "#/$defs/reason_code"
    uniqueItems: true
    description: "List of machine-readable reason codes."

  extensions_object:
    type: object
    description: >
      Extensions map for additive metadata. Keys should be namespaced (e.g., 'platform.*', 'component_x.*').
    additionalProperties: true

  # ---------------------------
  # Composite identity objects (reusable)
  # ---------------------------

  world_identity:
    type: object
    additionalProperties: false
    required: ["parameter_hash", "manifest_fingerprint"]
    properties:
      parameter_hash:
        $ref: "#/$defs/parameter_hash"
      manifest_fingerprint:
        $ref: "#/$defs/manifest_fingerprint"
    description: "World identity tuple."

  run_identity:
    type: object
    additionalProperties: false
    required: ["scenario_id", "run_id"]
    properties:
      scenario_id:
        $ref: "#/$defs/scenario_id"
      run_id:
        $ref: "#/$defs/run_id"
    description: "Run identity tuple."

  canonical_identity:
    type: object
    additionalProperties: false
    required: ["parameter_hash", "manifest_fingerprint", "scenario_id", "run_id"]
    properties:
      parameter_hash:
        $ref: "#/$defs/parameter_hash"
      manifest_fingerprint:
        $ref: "#/$defs/manifest_fingerprint"
      scenario_id:
        $ref: "#/$defs/scenario_id"
      run_id:
        $ref: "#/$defs/run_id"
      seed:
        $ref: "#/$defs/seed"
    description: >
      Canonical identity tuple required on shared-plane objects.
      'seed' is included when stochasticity applies.

  canonical_identity_with_seed:
    type: object
    additionalProperties: false
    required: ["parameter_hash", "manifest_fingerprint", "scenario_id", "run_id", "seed"]
    properties:
      parameter_hash:
        $ref: "#/$defs/parameter_hash"
      manifest_fingerprint:
        $ref: "#/$defs/manifest_fingerprint"
      scenario_id:
        $ref: "#/$defs/scenario_id"
      run_id:
        $ref: "#/$defs/run_id"
      seed:
        $ref: "#/$defs/seed"
    description: "Canonical identity tuple for stochastic targets (seed required)."
