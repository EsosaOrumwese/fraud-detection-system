$schema: "https://json-schema.org/draft/2020-12/schema"
$id: "docs/model_spec/cross_cutting_rails/contracts/ingestion_receipt.schema.yaml"
title: "Cross-cutting Rails â€” Ingestion Receipt"
description: >
  Canonical receipt for boundary admission decisions (ACCEPTED / REJECTED / QUARANTINED)
  at a plane-entry boundary (e.g., Ingestion Gate). Binds the decision to an exact target
  instance via target_ref + target_digest and records which schema was validated and which
  upstream PASS proofs (if any) justified admission.

type: object
additionalProperties: false

required:
  - schema_ref
  - receipt_id
  - receipt_type
  - issued_at
  - issuer_id
  - issuer_version
  - target_ref
  - target_identity
  - target_digest
  - validated_schema_ref
  - parameter_hash
  - manifest_fingerprint
  - scenario_id
  - run_id
  - outcome
  - reason_codes

properties:
  # ---------------------------
  # Schema authority (self)
  # ---------------------------
  schema_ref:
    $ref: "docs/model_spec/cross_cutting_rails/contracts/id_types.schema.yaml#/$defs/schema_ref"
    description: "Pinned reference to the authoritative schema governing this ingestion receipt."

  # ---------------------------
  # Receipt identity
  # ---------------------------
  receipt_id:
    $ref: "docs/model_spec/cross_cutting_rails/contracts/id_types.schema.yaml#/$defs/receipt_id"
    description: "Unique identifier for this receipt instance."

  receipt_type:
    type: string
    const: "ingestion"
    description: "Receipt class discriminator (pinned)."

  issued_at:
    $ref: "docs/model_spec/cross_cutting_rails/contracts/id_types.schema.yaml#/$defs/utc_timestamp"
    description: "UTC timestamp when this receipt was issued."

  # ---------------------------
  # Issuer provenance (boundary)
  # ---------------------------
  issuer_id:
    $ref: "docs/model_spec/cross_cutting_rails/contracts/id_types.schema.yaml#/$defs/issuer_id"
    description: "Identity of the boundary service issuing this receipt."
  issuer_version:
    $ref: "docs/model_spec/cross_cutting_rails/contracts/id_types.schema.yaml#/$defs/issuer_version"
    description: "Build/version identifier of the boundary service."

  # ---------------------------
  # Target binding (what was evaluated)
  # ---------------------------
  target_ref:
    $ref: "docs/model_spec/cross_cutting_rails/contracts/id_types.schema.yaml#/$defs/target_ref"
    description: >
      Deterministic reference to the submitted target (landing URI, bus topic+partition+offset,
      blob path, etc.).

  target_identity:
    type: object
    minProperties: 1
    additionalProperties: true
    description: >
      Minimal identity for the target. For events this SHOULD include event_id.
      For non-event targets, this MAY include other stable identifiers. Kept flexible
      while still requiring at least one identifying field.
    properties:
      event_id:
        $ref: "docs/model_spec/cross_cutting_rails/contracts/id_types.schema.yaml#/$defs/event_id"
      producer_id:
        $ref: "docs/model_spec/cross_cutting_rails/contracts/id_types.schema.yaml#/$defs/producer_id"
      event_type:
        $ref: "docs/model_spec/cross_cutting_rails/contracts/id_types.schema.yaml#/$defs/event_type"

  target_digest:
    $ref: "docs/model_spec/cross_cutting_rails/contracts/id_types.schema.yaml#/$defs/digest"
    description: >
      Digest (or digest-set reference) binding this receipt to the exact submitted content instance.

  # ---------------------------
  # Schema validation proof
  # ---------------------------
  validated_schema_ref:
    $ref: "docs/model_spec/cross_cutting_rails/contracts/id_types.schema.yaml#/$defs/validated_schema_ref"
    description: "Pinned reference to the schema that the boundary validated the target against."

  # ---------------------------
  # Upstream gate proofs (optional)
  # ---------------------------
  verified_pass_refs:
    type: array
    minItems: 0
    maxItems: 512
    uniqueItems: true
    items:
      $ref: "docs/model_spec/cross_cutting_rails/contracts/id_types.schema.yaml#/$defs/target_ref"
    description: >
      Optional references to upstream PASS/verification receipts that justified admission
      (e.g., engine validation PASS). When admission requires PASS, this MUST be non-empty.

  # ---------------------------
  # Canonical identity tuple
  # ---------------------------
  parameter_hash:
    $ref: "docs/model_spec/cross_cutting_rails/contracts/id_types.schema.yaml#/$defs/parameter_hash"
  manifest_fingerprint:
    $ref: "docs/model_spec/cross_cutting_rails/contracts/id_types.schema.yaml#/$defs/manifest_fingerprint"
  scenario_id:
    $ref: "docs/model_spec/cross_cutting_rails/contracts/id_types.schema.yaml#/$defs/scenario_id"
  run_id:
    $ref: "docs/model_spec/cross_cutting_rails/contracts/id_types.schema.yaml#/$defs/run_id"
  seed:
    $ref: "docs/model_spec/cross_cutting_rails/contracts/id_types.schema.yaml#/$defs/seed"
    description: >
      Present when the admitted/rejected/quarantined target is stochastic or derived from stochastic inputs.
      (Conditional requirement enforced by boundary policy.)

  # ---------------------------
  # Outcome + reasons
  # ---------------------------
  outcome:
    $ref: "docs/model_spec/cross_cutting_rails/contracts/id_types.schema.yaml#/$defs/ingestion_outcome"
    description: "Boundary decision outcome."

  reason_codes:
    $ref: "docs/model_spec/cross_cutting_rails/contracts/id_types.schema.yaml#/$defs/reason_codes"
    description: >
      Machine-readable reason codes. MUST be non-empty when outcome is REJECTED or QUARANTINED.
      MAY be empty when outcome is ACCEPTED.

  # ---------------------------
  # Optional conflict details (for idempotency conflicts)
  # ---------------------------
  conflict:
    type: object
    additionalProperties: false
    description: >
      Optional structured detail for idempotency conflicts (same idempotency key, different content/identity).
      Included primarily when outcome is REJECTED/QUARANTINED due to IDEMPOTENCY_CONFLICT.
    required:
      - conflict_key
      - conflict_value
      - existing_target_ref
      - existing_target_digest
    properties:
      conflict_key:
        type: string
        minLength: 1
        maxLength: 128
        description: "What key was reused (e.g., 'event_id')."
      conflict_value:
        $ref: "docs/model_spec/cross_cutting_rails/contracts/id_types.schema.yaml#/$defs/nonempty_string"
        description: "The reused key value (opaque)."
      existing_target_ref:
        $ref: "docs/model_spec/cross_cutting_rails/contracts/id_types.schema.yaml#/$defs/target_ref"
        description: "Reference to the previously admitted/known target instance."
      existing_target_digest:
        $ref: "docs/model_spec/cross_cutting_rails/contracts/id_types.schema.yaml#/$defs/digest"
        description: "Digest of the previously admitted/known target instance."
      existing_receipt_ref:
        $ref: "docs/model_spec/cross_cutting_rails/contracts/id_types.schema.yaml#/$defs/target_ref"
        description: "Optional reference to the previously issued receipt (if addressable)."
      notes:
        $ref: "docs/model_spec/cross_cutting_rails/contracts/id_types.schema.yaml#/$defs/nonempty_string"

  # ---------------------------
  # Optional notes + extensions
  # ---------------------------
  notes:
    $ref: "docs/model_spec/cross_cutting_rails/contracts/id_types.schema.yaml#/$defs/nonempty_string"
    description: "Optional human-readable summary."

  extensions:
    $ref: "docs/model_spec/cross_cutting_rails/contracts/id_types.schema.yaml#/$defs/extensions_object"
    description: "Optional additive metadata; must not contradict canonical fields."

allOf:
  # Enforce: if outcome is not ACCEPTED, reason_codes must be non-empty.
  - if:
      properties:
        outcome:
          const: "ACCEPTED"
    then:
      properties:
        reason_codes:
          minItems: 0
    else:
      properties:
        reason_codes:
          minItems: 1
