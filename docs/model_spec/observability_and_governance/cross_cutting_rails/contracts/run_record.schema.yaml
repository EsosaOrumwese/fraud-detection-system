$schema: "https://json-schema.org/draft/2020-12/schema"
$id: "docs/model_spec/cross_cutting_rails/contracts/run_record.schema.yaml"
title: "Cross-cutting Rails â€” Run Record"
description: >
  Canonical run anchor object produced by the Scenario Runner (or equivalent control plane).
  A Run Record binds a concrete execution (run_id) to a scenario (scenario_id) and a world
  (parameter_hash + manifest_fingerprint), and pins the authoritative inputs the run intends
  to use. Consumers treat this as a run-scoped authority surface.

type: object
additionalProperties: false

required:
  - schema_ref
  - parameter_hash
  - manifest_fingerprint
  - scenario_id
  - run_id
  - created_at
  - runner_id
  - runner_version
  - status

properties:
  # ---------------------------
  # Schema authority (self)
  # ---------------------------
  schema_ref:
    $ref: "docs/model_spec/cross_cutting_rails/contracts/id_types.schema.yaml#/$defs/schema_ref"
    description: >
      Pinned reference to the authoritative schema governing this Run Record instance.

  # ---------------------------
  # Canonical identity tuple (run anchor)
  # ---------------------------
  parameter_hash:
    $ref: "docs/model_spec/cross_cutting_rails/contracts/id_types.schema.yaml#/$defs/parameter_hash"
  manifest_fingerprint:
    $ref: "docs/model_spec/cross_cutting_rails/contracts/id_types.schema.yaml#/$defs/manifest_fingerprint"
  scenario_id:
    $ref: "docs/model_spec/cross_cutting_rails/contracts/id_types.schema.yaml#/$defs/scenario_id"
  run_id:
    $ref: "docs/model_spec/cross_cutting_rails/contracts/id_types.schema.yaml#/$defs/run_id"
  seed:
    $ref: "docs/model_spec/cross_cutting_rails/contracts/id_types.schema.yaml#/$defs/seed"
    description: >
      Declared RNG identity for the run. Required if the run's execution semantics rely on
      stochastic outcomes that must be replayable/auditable.

  # ---------------------------
  # Provenance (who created this run record)
  # ---------------------------
  created_at:
    $ref: "docs/model_spec/cross_cutting_rails/contracts/id_types.schema.yaml#/$defs/utc_timestamp"
    description: "UTC timestamp when this Run Record was created."

  runner_id:
    $ref: "docs/model_spec/cross_cutting_rails/contracts/id_types.schema.yaml#/$defs/producer_id"
    description: >
      Identity of the run orchestrator / Scenario Runner that authored this Run Record.

  runner_version:
    $ref: "docs/model_spec/cross_cutting_rails/contracts/id_types.schema.yaml#/$defs/producer_version"
    description: "Build/version identifier of the Scenario Runner."

  created_by:
    $ref: "docs/model_spec/cross_cutting_rails/contracts/id_types.schema.yaml#/$defs/nonempty_string"
    description: >
      Optional human or service principal that requested the run (SSO user or service name).
      This is provenance, not an access control mechanism.

  # ---------------------------
  # Rails conformance pin (optional but recommended)
  # ---------------------------
  rails_version:
    $ref: "docs/model_spec/cross_cutting_rails/contracts/id_types.schema.yaml#/$defs/nonempty_string"
    description: >
      Rails version this run asserts compatibility with (e.g., "v1.0"). Used for governance
      and migration windows.

  # ---------------------------
  # Status / lifecycle
  # ---------------------------
  status:
    type: string
    enum: ["PLANNED", "STARTED", "COMPLETED", "FAILED", "CANCELLED"]
    description: "Lifecycle state of the run."

  planned_at:
    $ref: "docs/model_spec/cross_cutting_rails/contracts/id_types.schema.yaml#/$defs/utc_timestamp"
    description: "UTC timestamp when the run entered PLANNED."

  started_at:
    $ref: "docs/model_spec/cross_cutting_rails/contracts/id_types.schema.yaml#/$defs/utc_timestamp"
    description: "UTC timestamp when the run entered STARTED."

  completed_at:
    $ref: "docs/model_spec/cross_cutting_rails/contracts/id_types.schema.yaml#/$defs/utc_timestamp"
    description: "UTC timestamp when the run entered COMPLETED."

  failed_at:
    $ref: "docs/model_spec/cross_cutting_rails/contracts/id_types.schema.yaml#/$defs/utc_timestamp"
    description: "UTC timestamp when the run entered FAILED."

  cancelled_at:
    $ref: "docs/model_spec/cross_cutting_rails/contracts/id_types.schema.yaml#/$defs/utc_timestamp"
    description: "UTC timestamp when the run entered CANCELLED."

  failure_reason_codes:
    $ref: "docs/model_spec/cross_cutting_rails/contracts/id_types.schema.yaml#/$defs/reason_codes"
    description: "Machine-readable reason codes for FAILED/CANCELLED states."

allOf:
  - if:
      properties:
        status: { const: "PLANNED" }
    then:
      required: ["planned_at"]
  - if:
      properties:
        status: { const: "STARTED" }
    then:
      required: ["started_at"]
  - if:
      properties:
        status: { const: "COMPLETED" }
    then:
      required: ["completed_at"]
  - if:
      properties:
        status: { const: "FAILED" }
    then:
      required: ["failed_at", "failure_reason_codes"]
      properties:
        failure_reason_codes: { minItems: 1 }
  - if:
      properties:
        status: { const: "CANCELLED" }
    then:
      required: ["cancelled_at", "failure_reason_codes"]
      properties:
        failure_reason_codes: { minItems: 1 }

  # ---------------------------
  # Scenario + plan pinning (tool-agnostic)
  # ---------------------------
  scenario_ref:
    $ref: "docs/model_spec/cross_cutting_rails/contracts/id_types.schema.yaml#/$defs/target_ref"
    description: >
      Deterministic reference to the scenario definition object that produced this run.

  # Optional declared intent window (if scenario runner chooses to capture it here)
  intent_window:
    type: object
    additionalProperties: false
    required: ["start_at", "end_at"]
    properties:
      start_at:
        $ref: "docs/model_spec/cross_cutting_rails/contracts/id_types.schema.yaml#/$defs/utc_timestamp"
      end_at:
        $ref: "docs/model_spec/cross_cutting_rails/contracts/id_types.schema.yaml#/$defs/utc_timestamp"
    description: >
      Optional declared window for the run's intended domain-time coverage.
      Interpretation is component-owned but timestamps must be UTC.

  # ---------------------------
  # Authority pins (what this run is allowed to consume)
  # ---------------------------
  authority_pins:
    type: array
    minItems: 0
    maxItems: 2048
    description: >
      List of authoritative inputs/policy packs/contracts the run is pinned to.
      These are references + digests so consumers can prove exactly what inputs were intended.
    items:
      type: object
      additionalProperties: false
      required: ["ref", "digest"]
      properties:
        ref:
          $ref: "docs/model_spec/cross_cutting_rails/contracts/id_types.schema.yaml#/$defs/target_ref"
          description: "Deterministic reference to an authority surface / bundle / contract."
        digest:
          $ref: "docs/model_spec/cross_cutting_rails/contracts/id_types.schema.yaml#/$defs/digest"
          description: "Digest binding this pin to an exact content instance."
        classification:
          $ref: "docs/model_spec/cross_cutting_rails/contracts/id_types.schema.yaml#/$defs/classification"
          description: "Optional sensitivity classification of the pinned surface."
        purpose:
          $ref: "docs/model_spec/cross_cutting_rails/contracts/id_types.schema.yaml#/$defs/nonempty_string"
          description: "Human-readable purpose for this pin (e.g., 'fraud_policy_pack', 'model_bundle')."
        required_pass_ref:
          $ref: "docs/model_spec/cross_cutting_rails/contracts/id_types.schema.yaml#/$defs/target_ref"
          description: >
            Optional reference to the PASS/verification receipt that must be valid before consuming this pin.
            (Used when pins are themselves gated.)

  # ---------------------------
  # Free-form notes + extensions
  # ---------------------------
  notes:
    $ref: "docs/model_spec/cross_cutting_rails/contracts/id_types.schema.yaml#/$defs/nonempty_string"
    description: "Optional human notes about the run."

  extensions:
    $ref: "docs/model_spec/cross_cutting_rails/contracts/id_types.schema.yaml#/$defs/extensions_object"
    description: >
      Additive metadata map for run-specific annotations. Must not contradict canonical identity fields.
