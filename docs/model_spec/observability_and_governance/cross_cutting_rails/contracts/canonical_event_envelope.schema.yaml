$schema: "https://json-schema.org/draft/2020-12/schema"
$id: "docs/model_spec/cross_cutting_rails/contracts/canonical_event_envelope.schema.yaml"
title: "Cross-cutting Rails — Canonical Event Envelope"
description: >
  Platform-owned canonical metadata envelope for all shared-plane events.
  Components MUST emit this envelope unchanged (field names + semantics) and own only
  their payload schema. Boundaries validate this envelope + the referenced payload schema.

type: object
additionalProperties: false

required:
  - event_id
  - event_type
  - producer_id
  - producer_version
  - occurred_at
  - emitted_at
  - schema_ref
  - parameter_hash
  - manifest_fingerprint
  - scenario_id
  - run_id
  - partition_key
  - payload

properties:
  # ---------------------------
  # Event identity
  # ---------------------------
  event_id:
    $ref: "docs/model_spec/cross_cutting_rails/contracts/id_types.schema.yaml#/$defs/event_id"
  event_type:
    $ref: "docs/model_spec/cross_cutting_rails/contracts/id_types.schema.yaml#/$defs/event_type"

  # ---------------------------
  # Producer provenance
  # ---------------------------
  producer_id:
    $ref: "docs/model_spec/cross_cutting_rails/contracts/id_types.schema.yaml#/$defs/producer_id"
  producer_version:
    $ref: "docs/model_spec/cross_cutting_rails/contracts/id_types.schema.yaml#/$defs/producer_version"

  # ---------------------------
  # Time semantics (UTC)
  # ---------------------------
  occurred_at:
    $ref: "docs/model_spec/cross_cutting_rails/contracts/id_types.schema.yaml#/$defs/utc_timestamp"
  emitted_at:
    $ref: "docs/model_spec/cross_cutting_rails/contracts/id_types.schema.yaml#/$defs/utc_timestamp"
  ingested_at:
    $ref: "docs/model_spec/cross_cutting_rails/contracts/id_types.schema.yaml#/$defs/utc_timestamp_or_null"
    description: >
      Set by plane-entry boundary on acceptance (may be null/omitted at producer emission).

  # ---------------------------
  # Schema authority
  # ---------------------------
  schema_ref:
    $ref: "docs/model_spec/cross_cutting_rails/contracts/id_types.schema.yaml#/$defs/schema_ref"
    description: >
      Pinned reference to the authoritative event schema governing this event (envelope + payload).
      Boundaries MUST resolve and validate against this schema_ref.

  # ---------------------------
  # Canonical identity & lineage
  # ---------------------------
  parameter_hash:
    $ref: "docs/model_spec/cross_cutting_rails/contracts/id_types.schema.yaml#/$defs/parameter_hash"
  manifest_fingerprint:
    $ref: "docs/model_spec/cross_cutting_rails/contracts/id_types.schema.yaml#/$defs/manifest_fingerprint"
  scenario_id:
    $ref: "docs/model_spec/cross_cutting_rails/contracts/id_types.schema.yaml#/$defs/scenario_id"
  run_id:
    $ref: "docs/model_spec/cross_cutting_rails/contracts/id_types.schema.yaml#/$defs/run_id"
  seed:
    $ref: "docs/model_spec/cross_cutting_rails/contracts/id_types.schema.yaml#/$defs/seed"
    description: >
      Required when stochasticity affects the event or it is derived from stochastic inputs.
      (Conditional requirement is enforced by component/boundary policy, not structural schema.)

  # ---------------------------
  # Routing / ordering
  # ---------------------------
  partition_key:
    $ref: "docs/model_spec/cross_cutting_rails/contracts/id_types.schema.yaml#/$defs/partition_key"
  sequence:
    $ref: "docs/model_spec/cross_cutting_rails/contracts/id_types.schema.yaml#/$defs/sequence"
    description: >
      Optional monotonic ordering indicator within partition_key. Only relied upon if a producer/plane
      contract explicitly defines ordering guarantees.

  # ---------------------------
  # Correlation / tracing (optional, reserved)
  # ---------------------------
  correlation_id:
    $ref: "docs/model_spec/cross_cutting_rails/contracts/id_types.schema.yaml#/$defs/correlation_id"
  causation_id:
    $ref: "docs/model_spec/cross_cutting_rails/contracts/id_types.schema.yaml#/$defs/causation_id"
  trace_id:
    $ref: "docs/model_spec/cross_cutting_rails/contracts/id_types.schema.yaml#/$defs/trace_id"
  span_id:
    $ref: "docs/model_spec/cross_cutting_rails/contracts/id_types.schema.yaml#/$defs/span_id"

  # ---------------------------
  # Extensions (additive metadata only)
  # ---------------------------
  extensions:
    type: object
    description: >
      Additive metadata map. Keys SHOULD be namespaced. MUST NOT duplicate or contradict canonical
      envelope fields. Reserved platform keys may appear here for degrade marking.
    additionalProperties: true
    properties:
      platform.degraded:
        type: boolean
        description: "True if event produced in a degraded mode (see rails §10)."
      platform.classification:
        $ref: "docs/model_spec/cross_cutting_rails/contracts/id_types.schema.yaml#/$defs/classification"
        description: "Optional data classification tag for routing/access posture (rails §9)."
      platform.degrade_mode:
        $ref: "docs/model_spec/cross_cutting_rails/contracts/id_types.schema.yaml#/$defs/degrade_mode"
      platform.degrade_reason_codes:
        $ref: "docs/model_spec/cross_cutting_rails/contracts/id_types.schema.yaml#/$defs/reason_codes"
      platform.last_good_ref:
        $ref: "docs/model_spec/cross_cutting_rails/contracts/id_types.schema.yaml#/$defs/target_ref"
        description: "Reference to last-known-good surface/receipt used in stale/cached degrade."
      platform.degrade_entered_at:
        $ref: "docs/model_spec/cross_cutting_rails/contracts/id_types.schema.yaml#/$defs/utc_timestamp"

  # ---------------------------
  # Payload (component-owned)
  # ---------------------------
  payload:
    type: object
    description: >
      Component-owned payload. Structure is governed by schema_ref (envelope + payload).
    additionalProperties: true
