# contracts/run_status_event.payload.schema.yaml
version: "0.1.0"
$id: "docs/model_spec/control_and_ingress/scenario_runner/contracts/run_status_event.payload.schema.yaml"
$schema: "https://json-schema.org/draft/2020-12/schema"

title: "Scenario Runner â€” Run Status Event (Payload Only)"
description: >
  Payload schema for Scenario Runner run lifecycle status-change events.
  This schema defines PAYLOAD ONLY. The event envelope is Platform Rails-owned and MUST use
  the canonical event envelope contract. Payload does not repeat the canonical identity tuple.

type: object
additionalProperties: false

required:
  - new_status
  - status_at_utc
  - run_record_ref

properties:
  new_status:
    $ref: "#/$defs/run_status"
    description: "The run lifecycle status after the transition."

  previous_status:
    $ref: "#/$defs/run_status"
    description: "Optional prior lifecycle status (if known)."

  status_at_utc:
    $ref: "#/$defs/rfc3339_micros_z"
    description: "UTC timestamp (Z) when the run entered new_status."

  # Anchors / pointers (audit)
  run_record_ref:
    $ref: "#/$defs/target_ref"
    description: "Reference to the current Run Record revision (Rails run_record)."

  run_record_digest:
    $ref: "#/$defs/digest"
    description: "Optional digest binding to the exact Run Record bytes."

  run_facts_view_ref:
    $ref: "#/$defs/target_ref"
    description: "Optional reference to the Run Facts View revision current at emission time."

  run_facts_view_digest:
    $ref: "#/$defs/digest"
    description: "Optional digest binding to the exact Run Facts View bytes."

  # Optional correlation to engine invocation attempts
  engine_request_id:
    type: string
    minLength: 1
    maxLength: 128
    description: "Optional correlation/idempotency identifier used for engine invocation."

  # Failure/cancellation details
  reason_codes:
    $ref: "#/$defs/reason_codes"
    description: >
      Reason codes explaining FAILED/CANCELLED outcomes. MUST be non-empty when new_status is
      FAILED or CANCELLED.

  notes:
    type: string
    maxLength: 2048
    description: "Optional human notes (non-semantic)."

  extensions:
    type: object
    description: "Additive metadata for future evolution (must not contradict canonical fields)."
    additionalProperties: true

allOf:
  # Enforce: FAILED/CANCELLED must include reason_codes (non-empty)
  - if:
      properties:
        new_status:
          enum: ["FAILED", "CANCELLED"]
    then:
      required: ["reason_codes"]
      properties:
        reason_codes:
          minItems: 1

$defs:
  run_status:
    type: string
    enum: ["PLANNED", "STARTED", "COMPLETED", "FAILED", "CANCELLED"]

  rfc3339_micros_z:
    type: string
    pattern: "^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}(\\.\\d{1,6})?Z$"
    description: "RFC3339 UTC timestamp with 'Z' suffix; optional fractional seconds up to micros."

  target_ref:
    type: string
    minLength: 1
    maxLength: 2048
    description: "Deterministic reference to a persisted artefact/surface (path/URI/etc.)."

  digest:
    type: string
    minLength: 8
    maxLength: 4096
    pattern: "^[A-Za-z0-9][A-Za-z0-9_-]{0,31}:[A-Za-z0-9+/=_-]{16,4096}$"
    description: "Content digest in the form '<alg>:<value>' (e.g., 'sha256:...')."

  reason_code:
    type: string
    minLength: 1
    maxLength: 128
    pattern: "^[A-Z][A-Z0-9_.-]{0,127}$"
    description: "Machine-readable reason code token (UPPERCASE recommended)."

  reason_codes:
    type: array
    minItems: 0
    maxItems: 256
    uniqueItems: true
    items:
      $ref: "#/$defs/reason_code"
    description: "List of machine-readable reason codes."
