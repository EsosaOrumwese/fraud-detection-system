# contracts/scenario_definition.schema.yaml
version: "0.1.1"
$id: "docs/model_spec/control_and_ingress/scenario_runner/contracts/scenario_definition.schema.yaml"
$schema: "https://json-schema.org/draft/2020-12/schema"

title: "Scenario Runner - Scenario Definition"
description: >
  Read-only scenario catalogue item (authority surface) describing a scenario overlay that may be
  referenced by Scenario Runner run requests and mapped to the Data Engine invocation `scenario_binding`.
  This object is platform/control-plane owned. It is NOT a Data Engine internal spec and MUST NOT
  encode engine segment/state internals. It exists to make scenario intent pinnable, auditable, and
  governable (IDs, versions, knobs, and pinned upstream artefacts).

type: object
additionalProperties: false

required:
  - schema_ref
  - scenario_id
  - scenario_version
  - name
  - created_at
  - knobs

properties:
  # ---------------------------
  # Schema authority (self)
  # ---------------------------
  schema_ref:
    $ref: "#/$defs/schema_ref"
    description: "Pinned reference to the authoritative schema governing this Scenario Definition."

  # ---------------------------
  # Scenario identity (used in engine scenario_binding)
  # ---------------------------
  scenario_id:
    $ref: "#/$defs/scenario_id"
    description: >
      Scenario identifier used in Scenario Runner run requests and mapped into engine invocation
      `scenario_binding` (single id or scenario_set). Must be stable.

  scenario_version:
    $ref: "#/$defs/version_token"
    description: >
      Version token for this scenario definition. New meaning/knobs MUST be introduced as a new
      version rather than mutating an existing published definition.

  status:
    type: string
    enum: ["ACTIVE", "DEPRECATED"]
    default: "ACTIVE"
    description: "Lifecycle status of this scenario definition."

  # ---------------------------
  # Human-facing metadata
  # ---------------------------
  name:
    $ref: "#/$defs/nonempty_string_256"
    description: "Short human-readable name (stable label)."

  description:
    type: string
    maxLength: 4096
    description: "Optional longer description of what the scenario represents."

  tags:
    type: array
    minItems: 0
    maxItems: 128
    uniqueItems: true
    items:
      $ref: "#/$defs/nonempty_string_64"
    description: "Optional tags for grouping/search (informative)."

  # ---------------------------
  # Provenance (control-plane)
  # ---------------------------
  created_at:
    $ref: "#/$defs/utc_timestamp_z"
    description: "UTC timestamp (Z) when this scenario definition was published."

  created_by:
    type: string
    minLength: 1
    maxLength: 256
    description: >
      Optional principal/service that authored or published this definition (provenance only).

  # ---------------------------
  # Scenario knobs (platform-owned)
  # ---------------------------
  knobs:
    type: object
    description: >
      Scenario knobs as a key/value map. Keys SHOULD be namespaced (e.g., 'traffic.*', 'fraud.*',
      'timing.*') to avoid collisions. This is control-plane intent: it may inform governance and
      analysis even if the engine only consumes scenario_id.
    additionalProperties:
      $ref: "#/$defs/knob_value"

  # ---------------------------
  # Pins to upstream authority surfaces (optional but recommended)
  # ---------------------------
  authority_pins:
    type: array
    minItems: 0
    maxItems: 2048
    description: >
      Optional references to authoritative artefacts this scenario depends on (policy packs, overlay
      configs, documentation, etc.). Pins should be refs + digests when available.
    items:
      $ref: "#/$defs/authority_pin"

  notes:
    type: string
    maxLength: 2048
    description: "Optional human notes (non-semantic)."

  extensions:
    type: object
    description: "Additive metadata for future evolution (must not contradict canonical fields)."
    additionalProperties: true

$defs:
  # ---------------------------
  # Base primitives
  # ---------------------------
  nonempty_string_64:
    type: string
    minLength: 1
    maxLength: 64

  nonempty_string_256:
    type: string
    minLength: 1
    maxLength: 256

  schema_ref:
    $ref: "../../../observability_and_governance/cross_cutting_rails/contracts/id_types.schema.yaml#/$defs/schema_ref"

  utc_timestamp_z:
    allOf:
      - $ref: "../../../observability_and_governance/cross_cutting_rails/contracts/id_types.schema.yaml#/$defs/utc_timestamp"
      - type: string
        pattern: "^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}Z$"
    description: "UTC timestamp with 'Z' suffix (RFC3339 subset)."

  version_token:
    type: string
    minLength: 1
    maxLength: 128
    description: >
      Version token (semver-like or date-like). Treated as opaque by consumers.

  # ---------------------------
  # Scenario ID (aligned to engine invocation schema: int or string)
  # ---------------------------
  scenario_id:
    description: "Scenario identifier (Rails string or non-negative int)."
    anyOf:
      - $ref: "../../../observability_and_governance/cross_cutting_rails/contracts/id_types.schema.yaml#/$defs/scenario_id"
      - type: integer
        minimum: 0

  # ---------------------------
  # Knob values (generic JSON-compatible values)
  # ---------------------------
  knob_value:
    description: "Scenario knob value (JSON-compatible)."
    oneOf:
      - type: string
        maxLength: 4096
      - type: integer
      - type: number
      - type: boolean
      - type: "null"
      - type: array
        maxItems: 4096
        items: {}
      - type: object
        maxProperties: 4096
        additionalProperties: {}

  # ---------------------------
  # Authority pin (ref + digest, aligned with run_record authority_pins pattern)
  # ---------------------------
  authority_pin:
    type: object
    additionalProperties: false
    required: ["ref"]
    properties:
      ref:
        $ref: "../../../observability_and_governance/cross_cutting_rails/contracts/id_types.schema.yaml#/$defs/target_ref"
        description: "Deterministic reference to an authority surface / bundle / contract."

      digest:
        $ref: "../../../observability_and_governance/cross_cutting_rails/contracts/id_types.schema.yaml#/$defs/digest"
        description: "Optional content digest binding this pin to an exact content instance."

      classification:
        $ref: "../../../observability_and_governance/cross_cutting_rails/contracts/id_types.schema.yaml#/$defs/classification"
        description: "Optional sensitivity classification of the pinned surface."

      purpose:
        type: string
        minLength: 1
        maxLength: 256
        description: "Optional human-readable purpose for this pin (e.g., 'overlay_config')."

      required_pass_ref:
        $ref: "../../../observability_and_governance/cross_cutting_rails/contracts/id_types.schema.yaml#/$defs/target_ref"
        description: "Optional reference to a PASS/verification receipt that must be valid before consuming this pin."
