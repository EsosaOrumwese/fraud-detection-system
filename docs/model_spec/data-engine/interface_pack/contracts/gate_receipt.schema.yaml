$schema: "https://json-schema.org/draft/2020-12/schema"
$id: "docs/model_spec/data-engine/interface_pack/contracts/gate_receipt.schema.yaml"
title: "Data Engine Gate Receipt"
description: >
  Portable receipt format for PASS/FAIL gate verification. This schema
  supports text flags, JSON receipts, and bundle-index receipts without
  exposing segment internals.

type: object
additionalProperties: false

required:
  - schema_ref
  - gate_id
  - status
  - receipt_kind
  - produced_at

properties:
  schema_ref:
    $ref: "docs/model_spec/observability_and_governance/cross_cutting_rails/contracts/id_types.schema.yaml#/$defs/schema_ref"
    description: "Pinned reference to the authoritative schema governing this receipt."

  gate_id:
    type: string
    minLength: 1
    maxLength: 256
    description: "Gate identifier as declared in engine_gates.map.yaml."

  status:
    $ref: "docs/model_spec/observability_and_governance/cross_cutting_rails/contracts/id_types.schema.yaml#/$defs/hashgate_outcome"
    description: "Gate verification outcome."

  receipt_kind:
    type: string
    enum: ["text_flag", "json_receipt", "bundle_flag"]
    description: "Format family of the receipt payload."

  receipt_id:
    $ref: "docs/model_spec/observability_and_governance/cross_cutting_rails/contracts/id_types.schema.yaml#/$defs/receipt_id"
    description: "Optional unique receipt identifier."

  manifest_fingerprint:
    $ref: "docs/model_spec/observability_and_governance/cross_cutting_rails/contracts/id_types.schema.yaml#/$defs/manifest_fingerprint"

  parameter_hash:
    $ref: "docs/model_spec/observability_and_governance/cross_cutting_rails/contracts/id_types.schema.yaml#/$defs/parameter_hash"

  seed:
    $ref: "docs/model_spec/observability_and_governance/cross_cutting_rails/contracts/id_types.schema.yaml#/$defs/seed"

  scenario_id:
    $ref: "docs/model_spec/observability_and_governance/cross_cutting_rails/contracts/id_types.schema.yaml#/$defs/scenario_id"

  run_id:
    $ref: "docs/model_spec/observability_and_governance/cross_cutting_rails/contracts/id_types.schema.yaml#/$defs/run_id"

  produced_at:
    $ref: "docs/model_spec/observability_and_governance/cross_cutting_rails/contracts/id_types.schema.yaml#/$defs/utc_timestamp"
    description: "UTC timestamp when the receipt was produced."

  issuer_id:
    $ref: "docs/model_spec/observability_and_governance/cross_cutting_rails/contracts/id_types.schema.yaml#/$defs/issuer_id"
    description: "Optional receipt issuer identity."

  issuer_version:
    $ref: "docs/model_spec/observability_and_governance/cross_cutting_rails/contracts/id_types.schema.yaml#/$defs/issuer_version"
    description: "Optional issuer build/version identifier."

  digests:
    type: object
    additionalProperties: false
    required: [digest_algorithm, digest_hex]
    properties:
      digest_algorithm:
        type: string
        enum: ["sha256"]
        description: "Digest algorithm for the receipt payload."
      digest_hex:
        type: string
        pattern: "^[a-f0-9]{64}$"
        description: "Hex-encoded digest for the verified bundle/payload."
      what_was_hashed:
        type: string
        minLength: 1
        maxLength: 2048
        description: "Short description of the bytes that were hashed."

  flag_text:
    type: string
    minLength: 1
    maxLength: 4096
    description: "Raw text content of a _passed.flag style receipt."

  receipt_ref:
    $ref: "docs/model_spec/observability_and_governance/cross_cutting_rails/contracts/id_types.schema.yaml#/$defs/target_ref"
    description: "Reference to a JSON receipt or bundle index."

  bundle_root:
    $ref: "docs/model_spec/observability_and_governance/cross_cutting_rails/contracts/id_types.schema.yaml#/$defs/target_ref"
    description: "Reference to the bundle root directory."

  extensions:
    $ref: "docs/model_spec/observability_and_governance/cross_cutting_rails/contracts/id_types.schema.yaml#/$defs/extensions_object"
    description: "Additive metadata map for non-breaking annotations."

allOf:
  - if:
      properties:
        receipt_kind: { const: "text_flag" }
    then:
      required: [flag_text]
  - if:
      properties:
        receipt_kind: { const: "json_receipt" }
    then:
      required: [receipt_ref]
  - if:
      properties:
        receipt_kind: { const: "bundle_flag" }
    then:
      required: [bundle_root]
