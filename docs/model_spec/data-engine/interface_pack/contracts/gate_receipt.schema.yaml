# contracts/gate_receipt.schema.yaml
version: "0.1.0"
$id: gate_receipt.schema.yaml
$schema: https://json-schema.org/draft/2020-12/schema
title: Gate Receipt
description: >
  Portable, black-box representation of a gate outcome (PASS/FAIL) for use in run facts,
  status events, and downstream verification workflows.
  NOTE: On-disk `_passed.flag` / bundle artifacts may be text or JSON per segment; this schema
  standardises the *portable receipt object*, not the raw file bytes.

$defs:
  hex64:
    $ref: "schemas.layer1.yaml#/$defs/hex64"
  hex32:
    $ref: "schemas.layer1.yaml#/$defs/hex32"
  uint64:
    $ref: "schemas.layer1.yaml#/$defs/uint64"
  rfc3339_micros:
    $ref: "schemas.layer1.yaml#/$defs/rfc3339_micros"

  scenario_id:
    anyOf:
      - type: string
        minLength: 1
        maxLength: 256
      - type: integer
        minimum: 0

  digest:
    type: object
    additionalProperties: false
    required: [algo, hex]
    properties:
      algo:
        type: string
        enum: ["sha256"]
      hex:
        description: Lowercase hex digest.
        type: string
        pattern: "^[0-9a-f]{64}$"

  gate_scope:
    description: >
      Identity scope the gate applies to. For segment HashGates this is typically fingerprint-scoped,
      but optional fields allow expressing narrower scopes where applicable.
    type: object
    additionalProperties: false
    required: [manifest_fingerprint]
    properties:
      manifest_fingerprint:
        $ref: "#/$defs/hex64"
      parameter_hash:
        $ref: "#/$defs/hex64"
      seed:
        $ref: "#/$defs/uint64"
      scenario_id:
        $ref: "#/$defs/scenario_id"
      run_id:
        $ref: "#/$defs/hex32"

  gate_artifacts:
    description: Optional pointers to the authoritative on-disk artifacts for this gate instance.
    type: object
    additionalProperties: false
    properties:
      validation_bundle_root:
        type: string
        minLength: 1
        maxLength: 2048
      index_path:
        type: string
        minLength: 1
        maxLength: 2048
      passed_flag_path:
        type: string
        minLength: 1
        maxLength: 2048

type: object
additionalProperties: false
required:
  - gate_id
  - status
  - scope
properties:
  gate_id:
    description: Stable gate identifier (must correspond to engine_gates.map.yaml).
    type: string
    minLength: 1
    maxLength: 128
    pattern: "^[a-z0-9_\\.\\-]+$"

  status:
    description: Gate outcome. Consumers must fail closed on missing/unknown status.
    type: string
    enum: ["PASS", "FAIL"]

  scope:
    $ref: "#/$defs/gate_scope"

  produced_at_utc:
    description: Optional UTC timestamp when the gate outcome was produced/published.
    $ref: "#/$defs/rfc3339_micros"

  receipt_kind:
    description: Informative classification of the underlying gate artifact style.
    type: string
    enum: ["passed_flag", "json_receipt", "bundle_flag"]
    default: "passed_flag"

  digest:
    description: >
      Optional portable digest for the gate instance, when the gate definition yields a single
      canonical digest value (e.g., bundle digest). Exact meaning is gate-specific and defined
      in engine_gates.map.yaml.
    $ref: "#/$defs/digest"

  artifacts:
    $ref: "#/$defs/gate_artifacts"

  notes:
    description: Optional non-semantic notes.
    type: string
    maxLength: 2048
