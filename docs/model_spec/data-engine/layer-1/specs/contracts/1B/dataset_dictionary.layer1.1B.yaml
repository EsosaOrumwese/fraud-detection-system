version: '1.0'

lifecycle:
  phase: alpha
  last_reviewed: 2025-10-18
  approver: "Layer 1 Governance"

ci_policy:
  allow_placeholders: true
  placeholder_markers: [TBD, null]
  block_on_phase: [beta, stable]

layer:
  id: layer1
  name: Merchant Location Realism

# ── External / reference inputs consumed by 1B (relisted for clarity) ────
reference_data:
- id: iso3166_canonical_2024
  status: approved
  owner_subsegment: ingress
  description: Canonical ISO 3166-1 alpha-2 list for FK checks.
  version: '2024-12-31'
  format: parquet
  path: reference/iso/iso3166_canonical/2024-12-31/iso3166.parquet
  partitioning: []
  ordering: []
  schema_ref: schemas.ingress.layer1.yaml#/iso3166_canonical_2024
  lineage:
    produced_by:
    consumed_by: [1B]
    final_in_layer: false
  retention_days: 1095
  pii: false
  licence: CC-BY-4.0

- id: world_countries
  status: approved
  owner_subsegment: ingress
  description: Country polygons (GeoParquet) used by 1B.
  version: '2024'
  format: parquet
  path: reference/spatial/world_countries/2024/world_countries.parquet
  partitioning: []
  ordering: []
  schema_ref: schemas.ingress.layer1.yaml#/world_countries
  lineage:
    produced_by:
    consumed_by: [1B]
    final_in_layer: false
  retention_days: 1095
  pii: false
  licence: Public-Domain

- id: population_raster_2025
  status: approved
  owner_subsegment: ingress
  description: Population raster (COG) used as spatial prior in 1B.
  version: '2025'
  format: cog_geotiff
  path: reference/spatial/population/2025/population.tif
  partitioning: []
  ordering: []
  schema_ref: schemas.ingress.layer1.yaml#/population_raster_2025
  lineage:
    produced_by:
    consumed_by: [1B]
    final_in_layer: false
  retention_days: 1095
  pii: false
  licence: ODbL-1.0

- id: license_map
  status: approved
  owner_subsegment: governance
  description: License mapping for sealed inputs (coverage check).
  version: '2025-12-31'
  format: yaml
  path: licenses/license_map.yaml
  partitioning: []
  ordering: []
  schema_ref: schemas.layer1.yaml#/governance/license_map
  lineage:
    produced_by:
    consumed_by: [1B]
    final_in_layer: false
  retention_days: 365
  pii: false
  licence: Proprietary-Internal

- id: s2_tile_weights_policy
  status: approved
  owner_subsegment: 1B
  description: Governed S2 weights policy (basis + fixed-dp precision).
  version: '2026-01-13'
  format: yaml
  path: config/layer1/1B/policy/policy.s2.tile_weights.yaml
  partitioning: []
  ordering: []
  schema_ref: schemas.1B.yaml#/policy/s2_tile_weights_policy
  lineage:
    produced_by:
    consumed_by: [1B]
    final_in_layer: false
  retention_days: 365
  pii: false
  licence: Proprietary-Internal

- id: tz_world_2025a
  status: approved
  owner_subsegment: ingress
  description: Time-zone polygons; sealed by 1B.S0 and used later by 2A/2B.
  version: '2025a'
  format: parquet
  path: reference/spatial/tz_world/2025a/tz_world.parquet
  partitioning: []
  ordering: []
  schema_ref: schemas.ingress.layer1.yaml#/tz_world_2025a
  lineage:
    produced_by:
    consumed_by: [1B]
    final_in_layer: false
  retention_days: 1095
  pii: false
  licence: ODbL-1.0

# (Optional, read-only discoverability; resolves via Dictionary as well as Registry)
- id: validation_bundle_1A
  status: approved
  owner_subsegment: 1A
  description: 1A validator outputs for the manifest_fingerprint (basis of consumer gate for outlet_catalogue).
  version: '{manifest_fingerprint}'
  format: directory
  path: data/layer1/1A/validation/manifest_fingerprint={manifest_fingerprint}/
  partitioning: [manifest_fingerprint]
  ordering: []
  schema_ref: schemas.1A.yaml#/validation/validation_bundle
  lineage:
    produced_by: 1A.S9
    consumed_by: [1B]
    final_in_layer: false
  retention_days: 365
  pii: false
  licence: Proprietary-Internal

- id: validation_passed_flag_1A
  status: approved
  owner_subsegment: 1A
  description: 1A PASS gate flag (_passed.flag) used by 1B.S0 before any read of outlet_catalogue.
  version: '{manifest_fingerprint}'
  format: text
  path: data/layer1/1A/validation/manifest_fingerprint={manifest_fingerprint}/_passed.flag
  partitioning: [manifest_fingerprint]
  ordering: []
  schema_ref: schemas.1B.yaml#/validation/passed_flag
  lineage:
    produced_by: 1A.S9
    consumed_by: [1B]
    final_in_layer: false
  retention_days: 365
  pii: false
  licence: Proprietary-Internal

- id: outlet_catalogue
  status: approved
  owner_subsegment: 1A
  description: Immutable outlet stubs; order-free (join S3 for inter-country order).
  version: '{manifest_fingerprint}'
  format: parquet
  path: data/layer1/1A/outlet_catalogue/seed={seed}/manifest_fingerprint={manifest_fingerprint}/
  partitioning: [seed, manifest_fingerprint]
  ordering: [merchant_id, legal_country_iso, site_order]
  schema_ref: schemas.1A.yaml#/egress/outlet_catalogue
  lineage:
    produced_by: 1A
    consumed_by: [1B]
    final_in_layer: true
  retention_days: 365
  pii: false
  licence: Proprietary-Internal

- id: s3_candidate_set
  status: approved
  owner_subsegment: 1A
  description: Order authority (candidate_rank; home=0). Not consumed by 1B v1 states; used only by downstream joins when order is required.
  version: '{parameter_hash}'
  format: parquet
  path: data/layer1/1A/s3_candidate_set/parameter_hash={parameter_hash}/
  partitioning: [parameter_hash]
  ordering: []
  schema_ref: schemas.1A.yaml#/s3/candidate_set
  lineage:
    produced_by: 1A
    consumed_by: []
    final_in_layer: false
  retention_days: 365
  pii: false
  licence: Proprietary-Internal

# ── Internally generated datasets (1B) ───────────────────────────────────
datasets:
- id: s0_gate_receipt_1B
  status: approved
  owner_subsegment: 1B
  description: 'Fingerprint-scoped receipt proving 1A PASS verification; enumerates sealed inputs for 1B.'
  version: '{manifest_fingerprint}'
  format: json
  path: data/layer1/1B/s0_gate_receipt/manifest_fingerprint={manifest_fingerprint}/s0_gate_receipt.json
  partitioning: [manifest_fingerprint]
  ordering: []
  schema_ref: schemas.1B.yaml#/validation/s0_gate_receipt
  lineage:
    produced_by: 1B.S0
    consumed_by: [1B]
    final_in_layer: false
  retention_days: 365
  pii: false
  licence: Proprietary-Internal

- id: sealed_inputs_1B
  status: approved
  owner_subsegment: 1B
  description: Authoritative inventory of every asset sealed by 1B.S0 for the manifest.
  version: '{manifest_fingerprint}'
  format: json
  path: data/layer1/1B/sealed_inputs/manifest_fingerprint={manifest_fingerprint}/sealed_inputs_1B.json
  partitioning: [manifest_fingerprint]
  ordering: [asset_id, path]
  schema_ref: schemas.1B.yaml#/validation/sealed_inputs_1B
  lineage:
    produced_by: 1B.S0
    consumed_by: [1B]
    final_in_layer: false
  retention_days: 365
  pii: false
  licence: Proprietary-Internal

# Current 1B datasets (binding once their states are ratified; `tile_index` binds with S1)
- id: tile_index
  status: approved
  owner_subsegment: 1B
  description: Eligible raster cells per country after clip.
  version: '{parameter_hash}'
  format: parquet
  path: data/layer1/1B/tile_index/parameter_hash={parameter_hash}/
  partitioning: [parameter_hash]
  ordering: [country_iso, tile_id]
  schema_ref: schemas.1B.yaml#/prep/tile_index
  lineage:
    produced_by: 1B.S1
    consumed_by: [1B]
    final_in_layer: false
  retention_days: 365
  pii: false
  licence: Proprietary-Internal

- id: s1_run_report
  status: approved
  owner_subsegment: 1B
  description: Control-plane run report for S1 tile index publish.
  version: '{parameter_hash}'
  format: json
  path: reports/layer1/1B/state=S1/parameter_hash={parameter_hash}/s1_run_report.json
  partitioning: [parameter_hash]
  ordering: []
  schema_ref: schemas.1B.yaml#/control/s1_run_report
  lineage:
    produced_by: 1B.S1
    consumed_by: [1B]
    final_in_layer: false
  retention_days: 365
  pii: false
  licence: Proprietary-Internal

- id: tile_weights
  status: approved
  owner_subsegment: 1B
  description: Deterministic fixed-dp weights per tile.
  version: '{parameter_hash}'
  format: parquet
  path: data/layer1/1B/tile_weights/parameter_hash={parameter_hash}/
  partitioning: [parameter_hash]
  ordering: [country_iso, tile_id]
  schema_ref: schemas.1B.yaml#/prep/tile_weights
  lineage:
    produced_by: 1B.S2
    consumed_by: [1B]
    final_in_layer: false
  retention_days: 365
  pii: false
  licence: Proprietary-Internal

- id: s2_run_report
  status: approved
  owner_subsegment: 1B
  description: Control-plane run report for S2 tile weights publish.
  version: '{parameter_hash}'
  format: json
  path: reports/layer1/1B/state=S2/parameter_hash={parameter_hash}/s2_run_report.json
  partitioning: [parameter_hash]
  ordering: []
  schema_ref: schemas.1B.yaml#/control/s2_run_report
  lineage:
    produced_by: 1B.S2
    consumed_by: [1B]
    final_in_layer: false
  retention_days: 365
  pii: false
  licence: Proprietary-Internal

- id: s3_requirements
  status: approved
  owner_subsegment: 1B
  description: Deterministic site counts per (merchant_id, legal_country_iso) for this run.
  version: '{seed}.{manifest_fingerprint}.{parameter_hash}'
  format: parquet
  path: data/layer1/1B/s3_requirements/seed={seed}/parameter_hash={parameter_hash}/manifest_fingerprint={manifest_fingerprint}/
  partitioning: [seed, manifest_fingerprint, parameter_hash]
  ordering: [merchant_id, legal_country_iso]
  schema_ref: schemas.1B.yaml#/plan/s3_requirements
  lineage:
    produced_by: 1B.S3
    consumed_by: [1B]
    final_in_layer: false
  retention_days: 365
  pii: false
  licence: Proprietary-Internal

- id: s3_run_report
  status: approved
  owner_subsegment: 1B
  description: Control-plane counters and receipts for S3 requirements publish.
  version: '{seed}.{manifest_fingerprint}.{parameter_hash}'
  format: json
  path: reports/layer1/1B/state=S3/seed={seed}/parameter_hash={parameter_hash}/manifest_fingerprint={manifest_fingerprint}/s3_run_report.json
  partitioning: [seed, manifest_fingerprint, parameter_hash]
  ordering: []
  schema_ref: schemas.1B.yaml#/control/s3_run_report
  lineage:
    produced_by: 1B.S3
    consumed_by: [1B]
    final_in_layer: false
  retention_days: 365
  pii: false
  licence: Proprietary-Internal

- id: s4_alloc_plan
  status: approved
  owner_subsegment: 1B
  description: Per-tile integer allocations that sum to S3 n_sites (RNG-free; positives only).
  version: '{seed}.{manifest_fingerprint}.{parameter_hash}'
  format: parquet
  path: data/layer1/1B/s4_alloc_plan/seed={seed}/parameter_hash={parameter_hash}/manifest_fingerprint={manifest_fingerprint}/
  partitioning: [seed, manifest_fingerprint, parameter_hash]
  ordering: [merchant_id, legal_country_iso, tile_id]
  schema_ref: schemas.1B.yaml#/plan/s4_alloc_plan
  lineage:
    produced_by: 1B.S4
    consumed_by: [1B]
    final_in_layer: false
  retention_days: 365
  pii: false
  licence: Proprietary-Internal

- id: s4_run_report
  status: approved
  owner_subsegment: 1B
  description: Control-plane counters and receipts for S4 allocation publish.
  version: '{seed}.{manifest_fingerprint}.{parameter_hash}'
  format: json
  path: reports/layer1/1B/state=S4/seed={seed}/parameter_hash={parameter_hash}/manifest_fingerprint={manifest_fingerprint}/s4_run_report.json
  partitioning: [seed, manifest_fingerprint, parameter_hash]
  ordering: []
  schema_ref: schemas.1B.yaml#/control/s4_run_report
  lineage:
    produced_by: 1B.S4
    consumed_by: [1B]
    final_in_layer: false
  retention_days: 365
  pii: false
  licence: Proprietary-Internal

- id: s5_site_tile_assignment
  status: approved
  owner_subsegment: 1B
  description: Site→tile assignment; one row per site; satisfies S4 per-tile quotas.
  version: '{seed}.{manifest_fingerprint}.{parameter_hash}'
  format: parquet
  path: data/layer1/1B/s5_site_tile_assignment/seed={seed}/parameter_hash={parameter_hash}/manifest_fingerprint={manifest_fingerprint}/
  partitioning: [seed, manifest_fingerprint, parameter_hash]
  ordering: [merchant_id, legal_country_iso, site_order]
  schema_ref: schemas.1B.yaml#/plan/s5_site_tile_assignment
  lineage:
    produced_by: 1B.S5
    consumed_by: [1B]
    final_in_layer: false
  retention_days: 365
  pii: false
  licence: Proprietary-Internal

- id: s5_run_report
  status: approved
  owner_subsegment: 1B
  description: Control-plane counters and receipts for S5 site→tile assignment publish.
  version: '{seed}.{manifest_fingerprint}.{parameter_hash}'
  format: json
  path: reports/layer1/1B/state=S5/seed={seed}/parameter_hash={parameter_hash}/manifest_fingerprint={manifest_fingerprint}/s5_run_report.json
  partitioning: [seed, manifest_fingerprint, parameter_hash]
  ordering: []
  schema_ref: schemas.1B.yaml#/control/s5_run_report
  lineage:
    produced_by: 1B.S5
    consumed_by: [1B]
    final_in_layer: false
  retention_days: 365
  pii: false
  licence: Proprietary-Internal

- id: s6_site_jitter
  status: approved
  owner_subsegment: 1B
  description: Per-site in-pixel jitter; effective deltas (projection into country); one row per site.
  version: '{seed}.{manifest_fingerprint}.{parameter_hash}'
  format: parquet
  path: data/layer1/1B/s6_site_jitter/seed={seed}/parameter_hash={parameter_hash}/manifest_fingerprint={manifest_fingerprint}/
  partitioning: [seed, manifest_fingerprint, parameter_hash]
  ordering: [merchant_id, legal_country_iso, site_order]
  schema_ref: schemas.1B.yaml#/plan/s6_site_jitter
  lineage:
    produced_by: 1B.S6
    consumed_by: [1B]
    final_in_layer: false
  retention_days: 365
  pii: false
  licence: Proprietary-Internal

- id: s6_run_report
  status: approved
  owner_subsegment: 1B
  description: Control-plane counters and RNG coverage for S6 jitter publish.
  version: '{seed}.{manifest_fingerprint}.{parameter_hash}'
  format: json
  path: reports/layer1/1B/state=S6/seed={seed}/parameter_hash={parameter_hash}/manifest_fingerprint={manifest_fingerprint}/s6_run_report.json
  partitioning: [seed, manifest_fingerprint, parameter_hash]
  ordering: []
  schema_ref: schemas.1B.yaml#/control/s6_run_report
  lineage:
    produced_by: 1B.S6
    consumed_by: [1B]
    final_in_layer: false
  retention_days: 365
  pii: false
  licence: Proprietary-Internal

- id: tile_bounds
  status: approved
  owner_subsegment: 1B
  description: Rectangle bounds per eligible tile (S1 companion to tile_index).
  version: '{parameter_hash}'
  format: parquet
  path: data/layer1/1B/tile_bounds/parameter_hash={parameter_hash}/
  partitioning: [parameter_hash]
  ordering: [country_iso, tile_id]
  schema_ref: schemas.1B.yaml#/prep/tile_bounds
  lineage:
    produced_by: 1B.S1
    consumed_by: [1B]
    final_in_layer: false
  retention_days: 365
  pii: false
  licence: Proprietary-Internal

- id: s7_site_synthesis
  status: approved
  owner_subsegment: 1B
  description: Deterministic stitch of S5 (tile) + S6 (effective deltas) + S1 geometry into per-site absolutes; RNG-free; 1:1 with outlet_catalogue.
  version: '{seed}.{manifest_fingerprint}.{parameter_hash}'
  format: parquet
  path: data/layer1/1B/s7_site_synthesis/seed={seed}/parameter_hash={parameter_hash}/manifest_fingerprint={manifest_fingerprint}/
  partitioning: [seed, manifest_fingerprint, parameter_hash]
  ordering: [merchant_id, legal_country_iso, site_order]
  schema_ref: schemas.1B.yaml#/plan/s7_site_synthesis
  lineage:
    produced_by: 1B.S7
    consumed_by: [1B]
    final_in_layer: false
  retention_days: 365
  pii: false
  licence: Proprietary-Internal

- id: s7_run_summary
  status: approved
  owner_subsegment: 1B
  description: Control-plane run summary for S7 site synthesis publish.
  version: '{seed}.{manifest_fingerprint}.{parameter_hash}'
  format: json
  path: reports/layer1/1B/state=S7/seed={seed}/parameter_hash={parameter_hash}/manifest_fingerprint={manifest_fingerprint}/s7_run_summary.json
  partitioning: [seed, manifest_fingerprint, parameter_hash]
  ordering: []
  schema_ref: schemas.1B.yaml#/control/s7_run_summary
  lineage:
    produced_by: 1B.S7
    consumed_by: [1B]
    final_in_layer: false
  retention_days: 365
  pii: false
  licence: Proprietary-Internal

- id: site_locations
  status: approved
  owner_subsegment: 1B
  description: Site locations with absolute lat/lon (post jitter + geometry stitch); partitioned by seed/manifest_fingerprint.
  version: '{seed}.{manifest_fingerprint}'
  format: parquet
  path: data/layer1/1B/site_locations/seed={seed}/manifest_fingerprint={manifest_fingerprint}/
  partitioning: [seed, manifest_fingerprint]
  ordering: [merchant_id, legal_country_iso, site_order]
  schema_ref: schemas.1B.yaml#/egress/site_locations
  lineage:
    produced_by: 1B.S8
    consumed_by: [1B, 1A]
    final_in_layer: true
  retention_days: 365
  pii: false
  licence: Proprietary-Internal

- id: s8_run_summary
  status: approved
  owner_subsegment: 1B
  description: Control-plane summary for S8 site_locations publish.
  version: '{seed}.{manifest_fingerprint}'
  format: json
  path: reports/layer1/1B/state=S8/seed={seed}/manifest_fingerprint={manifest_fingerprint}/s8_run_summary.json
  partitioning: [seed, manifest_fingerprint]
  ordering: []
  schema_ref: schemas.1B.yaml#/control/s8_run_summary
  lineage:
    produced_by: 1B.S8
    consumed_by: [1B]
    final_in_layer: false
  retention_days: 365
  pii: false
  licence: Proprietary-Internal

- id: validation_bundle_1B
  status: approved
  owner_subsegment: 1B
  description: Validation bundle for a 1B publish (one per manifest_fingerprint).
  version: '{manifest_fingerprint}'
  format: files
  path: data/layer1/1B/validation/manifest_fingerprint={manifest_fingerprint}/
  partitioning: [manifest_fingerprint]
  ordering: []
  schema_ref: schemas.1B.yaml#/validation/validation_bundle_1B
  lineage:
    produced_by: 1B.S9
    consumed_by: [1B]
    final_in_layer: false
  retention_days: 1095
  pii: false
  licence: Proprietary-Internal

- id: validation_bundle_index_1B
  status: approved
  owner_subsegment: 1B
  description: index.json enumerating validation bundle members with hashes.
  version: '{manifest_fingerprint}'
  format: json
  path: data/layer1/1B/validation/manifest_fingerprint={manifest_fingerprint}/index.json
  partitioning: [manifest_fingerprint]
  ordering: []
  schema_ref: schemas.1B.yaml#/validation/validation_bundle_index_1B
  lineage:
    produced_by: 1B.S9
    consumed_by: [1B]
    final_in_layer: false
  retention_days: 1095
  pii: false
  licence: Proprietary-Internal

- id: validation_passed_flag_1B
  status: approved
  owner_subsegment: 1B
  description: PASS gate flag; equals SHA-256 of the bundle per S9 hashing rule.
  version: '{manifest_fingerprint}'
  format: text
  path: data/layer1/1B/validation/manifest_fingerprint={manifest_fingerprint}/_passed.flag
  partitioning: [manifest_fingerprint]
  ordering: []
  schema_ref: schemas.1B.yaml#/validation/passed_flag
  lineage:
    produced_by: 1B.S9
    consumed_by: [1B]
    final_in_layer: false
  retention_days: 1095
  pii: false
  licence: Proprietary-Internal

policies:
- id: jitter_policy
  status: approved
  owner_subsegment: 1B
  description: RESERVED (VNext). Gaussian jitter σ (deg) policy by latitude band / merchant class. Not consumed by 1B v1 uniform lane.
  version: '{policy_version}'
  format: yaml
  path: config/layer1/1B/policy/1B.jitter.yaml
  partitioning: []
  ordering: []
  schema_ref: schemas.1B.yaml#/policy/jitter_policy
  lineage:
    produced_by: 1B.policy
    consumed_by: []
    final_in_layer: false
  retention_days: 30
  pii: false
  licence: Proprietary-Internal
logs:
- id: rng_event_site_tile_assign
  status: approved
  owner_subsegment: 1B
  description: RNG events for site→tile assignment (one event per assigned site).
  version: '{run_id}'
  format: jsonl
  path: logs/layer1/1B/rng/events/site_tile_assign/seed={seed}/parameter_hash={parameter_hash}/run_id={run_id}/
  partitioning: [seed, parameter_hash, run_id]
  ordering: []
  schema_ref: schemas.layer1.yaml#/rng/events/site_tile_assign
  lineage:
    produced_by: 1B.S5
    consumed_by: [1B]
    final_in_layer: false
  retention_days: 30
  pii: false
  licence: Proprietary-Internal

- id: rng_event_in_cell_jitter
  status: approved
  owner_subsegment: 1B
  description: RNG events for S6 in-cell jitter (≥1 event per site; one per attempt; per-event budget; blocks=1, draws=2).
  version: '{run_id}'
  format: jsonl
  path: logs/layer1/1B/rng/events/in_cell_jitter/seed={seed}/parameter_hash={parameter_hash}/run_id={run_id}/
  partitioning: [seed, parameter_hash, run_id]
  ordering: []
  schema_ref: schemas.layer1.yaml#/rng/events/in_cell_jitter
  lineage:
    produced_by: 1B.S6
    consumed_by: [1B]
    final_in_layer: false
  retention_days: 30
  pii: false
  licence: Proprietary-Internal

- id: rng_audit_log
  status: approved
  owner_subsegment: 1B
  description: RNG run audit (identity/config) — one row at run start.
  version: '{run_id}'
  format: jsonl
  path: logs/layer1/1B/rng/audit/seed={seed}/parameter_hash={parameter_hash}/run_id={run_id}/rng_audit_log.jsonl
  partitioning: [seed, parameter_hash, run_id]
  ordering: []
  schema_ref: schemas.layer1.yaml#/rng/core/rng_audit_log
  lineage:
    produced_by: 1B
    consumed_by: [1B]
    final_in_layer: false
  retention_days: 365
  pii: false
  licence: Proprietary-Internal

- id: rng_trace_log
  status: approved
  owner_subsegment: 1B
  description: RNG cumulative trace — append exactly one row after each event append.
  version: '{run_id}'
  format: jsonl
  path: logs/layer1/1B/rng/trace/seed={seed}/parameter_hash={parameter_hash}/run_id={run_id}/rng_trace_log.jsonl
  partitioning: [seed, parameter_hash, run_id]
  ordering: []
  schema_ref: schemas.layer1.yaml#/rng/core/rng_trace_log
  lineage:
    produced_by: 1B
    consumed_by: [1B]
    final_in_layer: false
  retention_days: 365
  pii: false
  licence: Proprietary-Internal
