subsegments:
  - id: "3B"
    name: "Special Treatment for Purely Virtual Merchants"
    artifacts:

      # 0 UPSTREAM HASHGATE ARTEFACTS (No PASS → No read)
      - name: validation_bundle_1A
        path: data/layer1/1A/validation/fingerprint={manifest_fingerprint}/
        type: bundle
        category: validation
        semver: "{semver}"
        version: "{manifest_fingerprint}"
        digest: "{sha256}"
        manifest_key: mlr.1A.validation.bundle
        license: Proprietary-Internal
        role: Fingerprint-scoped PASS bundle for Segment 1A; S0 recomputes hash before any read.
        dependencies: []
        source: internal
        owner: { qa_team }
        last_updated: "{iso8601_timestamp}"
        environment: [ runtime ]
        schema:
          index_schema_ref: schemas.1A.yaml#/validation/validation_bundle.index_schema
        cross_layer: true
        notes: "Hashing law: ASCII-lex order on index entries; `_passed.flag` excluded."

      - name: passed_flag_1A
        path: data/layer1/1A/validation/fingerprint={manifest_fingerprint}/_passed.flag
        type: file
        category: validation
        semver: "{semver}"
        version: "{manifest_fingerprint}"
        digest: "{sha256}"
        manifest_key: mlr.1A.validation.passed
        license: Proprietary-Internal
        role: Companion flag carrying the validation bundle digest; 3B refuses to read if missing.
        dependencies: [ validation_bundle_1A ]
        source: internal
        owner: { qa_team }
        last_updated: "{iso8601_timestamp}"
        environment: [ runtime ]
        schema: null
        cross_layer: true
        notes: null

      - name: validation_bundle_1B
        path: data/layer1/1B/validation/fingerprint={manifest_fingerprint}/
        type: bundle
        category: validation
        semver: "{semver}"
        version: "{manifest_fingerprint}"
        digest: "{sha256}"
        manifest_key: mlr.1B.validation.bundle
        license: Proprietary-Internal
        role: Segment 1B PASS bundle; S0 enforces No PASS → No read before touching site-level data.
        dependencies: []
        source: internal
        owner: { qa_team }
        last_updated: "{iso8601_timestamp}"
        environment: [ runtime ]
        schema:
          index_schema_ref: schemas.1A.yaml#/validation/validation_bundle.index_schema
        cross_layer: true
        notes: null

      - name: passed_flag_1B
        path: data/layer1/1B/validation/fingerprint={manifest_fingerprint}/_passed.flag
        type: file
        category: validation
        semver: "{semver}"
        version: "{manifest_fingerprint}"
        digest: "{sha256}"
        manifest_key: mlr.1B.validation.passed
        license: Proprietary-Internal
        role: Single-line digest for validation_bundle_1B.
        dependencies: [ validation_bundle_1B ]
        source: internal
        owner: { qa_team }
        last_updated: "{iso8601_timestamp}"
        environment: [ runtime ]
        schema: schemas.1B.yaml#/validation/passed_flag
        cross_layer: true
        notes: null

      - name: validation_bundle_2A
        path: data/layer1/2A/validation/fingerprint={manifest_fingerprint}/
        type: bundle
        category: validation
        semver: "{semver}"
        version: "{manifest_fingerprint}"
        digest: "{sha256}"
        manifest_key: mlr.2A.validation.bundle
        license: Proprietary-Internal
        role: Segment 2A PASS bundle establishing sealed tz assets; referenced for provenance.
        dependencies: []
        source: internal
        owner: { qa_team }
        last_updated: "{iso8601_timestamp}"
        environment: [ runtime ]
        schema: schemas.layer1.yaml#/validation/validation_bundle_index_3A
        cross_layer: true
        notes: null

      - name: passed_flag_2A
        path: data/layer1/2A/validation/fingerprint={manifest_fingerprint}/_passed.flag
        type: file
        category: validation
        semver: "{semver}"
        version: "{manifest_fingerprint}"
        digest: "{sha256}"
        manifest_key: mlr.2A.validation.passed
        license: Proprietary-Internal
        role: Companion flag for validation_bundle_2A.
        dependencies: [ validation_bundle_2A ]
        source: internal
        owner: { qa_team }
        last_updated: "{iso8601_timestamp}"
        environment: [ runtime ]
        schema: null
        cross_layer: true
        notes: null

      - name: validation_bundle_3A
        path: data/layer1/3A/validation/fingerprint={manifest_fingerprint}/
        type: bundle
        category: validation
        semver: "{semver}"
        version: "{manifest_fingerprint}"
        digest: "{sha256}"
        manifest_key: mlr.3A.validation.bundle
        license: Proprietary-Internal
        role: Segment 3A PASS bundle; 3B honours the same HashGate before consuming zone artefacts.
        dependencies: []
        source: internal
        owner: { qa_team }
        last_updated: "{iso8601_timestamp}"
        environment: [ runtime ]
        schema: schemas.layer1.yaml#/validation/validation_bundle_index_3A
        cross_layer: true
        notes: null

      - name: passed_flag_3A
        path: data/layer1/3A/validation/fingerprint={manifest_fingerprint}/_passed.flag
        type: file
        category: validation
        semver: "{semver}"
        version: "{manifest_fingerprint}"
        digest: "{sha256}"
        manifest_key: mlr.3A.validation.passed
        license: Proprietary-Internal
        role: "`_passed.flag` for the 3A bundle; mandatory before any 3B read."
        dependencies: [ validation_bundle_3A ]
        source: internal
        owner: { qa_team }
        last_updated: "{iso8601_timestamp}"
        environment: [ runtime ]
        schema: schemas.layer1.yaml#/validation/passed_flag_3A
        cross_layer: true
        notes: null

      # 1 CROSS‑LAYER INPUT
      - name: site_locations
        path: data/layer1/1B/site_locations/seed={seed}/fingerprint={manifest_fingerprint}/
        type: dataset
        category: input
        semver: "{semver}"
        version: "{manifest_fingerprint}"
        digest: "{sha256}"
        manifest_key: mlr.1B.egress.site_locations
        license: "{spdx_or_internal}"
        role: Immutable site geometry from 1B (3B joins by merchant but MUST NOT mutate 1B rows).
        dependencies: []
        source: internal
        owner: { owner_team }
        last_updated: "{iso8601_timestamp}"
        environment: [ runtime ]
        schema: schemas.1B.yaml#/egress/site_locations
        cross_layer: true
        notes: null

      # 2 VIRTUAL MERCHANT CLASSIFICATION RULES
      - name: mcc_channel_rules
        path: config/virtual/mcc_channel_rules.yaml
        type: config
        category: virtual_classification
        semver: "{semver}"
        version: "{config_version}"
        digest: "{sha256}"
        manifest_key: mlr.3B.config.virtual_rules
        license: "{spdx_or_internal}"
        role: "MCC + channel rules driving `is_virtual` derivation."
        dependencies: []
        source: internal
        owner: { platform_team }
        last_updated: "{iso8601_timestamp}"
        environment: [ runtime ]
        schema: null
        cross_layer: true
        notes: null

      # split external weights vs internal wrapper (licensing clarity)
      - name: cdn_weights_ext_yaml
        path: artefacts/external/cdn_country_weights.yaml
        type: dataset
        category: external_data
        semver: "{semver}"
        version: "{vintage}"
        digest: "{sha256}"
        manifest_key: mlr.3B.external.cdn_country_weights
        license: CC-BY-4.0
        role: Stationary CDN edge weights (Akamai SOTI).
        dependencies: [ ]
        source: external
        owner: { data_governance_team }
        last_updated: "{iso8601_timestamp}"
        environment: [ runtime ]
        schema: null
        cross_layer: true
        notes: null

      - name: cdn_country_weights
        path: config/virtual/cdn_country_weights.yaml
        type: config
        category: virtual_routing
        semver: "{semver}"
        version: "{config_version}"
        digest: "{sha256}"
        manifest_key: mlr.3B.config.cdn_country_weights
        license: "{spdx_or_internal}"
        role: Thin wrapper mapping/selection over external weights; edge_scale=500.
        dependencies: [ cdn_weights_ext_yaml ]
        source: internal
        owner: { data_governance_team }
        last_updated: "{iso8601_timestamp}"
        environment: [ runtime ]
        schema: null
        cross_layer: true
        notes: null

      - name: akamai_to_yaml_sql
        path: etl/akamai_to_yaml.sql
        type: code
        category: virtual_routing
        semver: "{code_semver}"
        version: "{git_commit}"
        digest: "{git_tree_hash}"
        manifest_key: mlr.3B.code.akamai_to_yaml
        license: "{spdx_or_internal}"
        role: Extracts Akamai SOTI volumes and writes YAML weights.
        dependencies: []
        source: internal
        owner: { engineering_team }
        last_updated: "{iso8601_timestamp}"
        environment: [ dev ]
        schema: null
        cross_layer: false
        notes: null

      # 4 SETTLEMENT COORDINATES & GEOCODER BUNDLE
      - name: virtual_settlement_coords
        path: artefacts/virtual/virtual_settlement_coords.csv
        type: dataset
        category: virtual_geocode
        semver: "{semver}"
        version: "{run_id}"
        digest: "{sha256}"
        manifest_key: mlr.3B.dataset.settlement_coords
        license: "{spdx_or_internal}"
        role: "`merchant_id → (lat, lon, evidence_url)` for settlement node."
        dependencies: []
        source: internal
        owner: { data_governance_team }
        last_updated: "{iso8601_timestamp}"
        environment: [ runtime ]
        schema: null
        cross_layer: true
        notes: null

      - name: pelias_cached_sqlite
        path: artefacts/geocode/pelias_cached.sqlite
        type: dataset
        category: geocode_bundle
        semver: "{semver}"
        version: "{vintage}"
        digest: "{sha256}"
        manifest_key: mlr.3B.dataset.pelias_bundle
        license: CC‑BY‑4.0
        role: Offline Pelias bundle for evidence‑URL geocoding.
        dependencies: []
        source: external
        owner: { data_governance_team }
        last_updated: "{iso8601_timestamp}"
        environment: [ runtime ]
        schema: null
        cross_layer: true
        notes: null

      # 5 POPULATION RASTER FOR EDGE SAMPLING
      - name: hrsl_raster
        path: artefacts/rasters/hrsl_100m.tif
        type: reference
        category: population_raster
        semver: "{semver}"
        version: "{vintage}"
        digest: "{sha256}"
        manifest_key: mlr.3B.ref.hrsl_raster
        license: CC‑BY‑4.0
        role: 100 m HRSL raster used for edge coordinate sampling.
        dependencies: []
        source: external
        owner: { data_governance_team }
        last_updated: "{iso8601_timestamp}"
        environment: [ runtime ]
        schema: null
        cross_layer: true
        notes: null

      # 6 GOVERNING VALIDATION & LOGGING POLICIES
      - name: virtual_validation_policy
        path: config/virtual/virtual_validation.yml
        type: config
        category: validation
        semver: "{semver}"
        version: "{config_version}"
        digest: "{sha256}"
        manifest_key: mlr.3B.config.virtual_validation
        license: "{spdx_or_internal}"
        role: Tolerances for country‑share & settlement cut‑off checks.
        dependencies: []
        source: internal
        owner: { qa_team }
        last_updated: "{iso8601_timestamp}"
        environment: [ runtime ]
        schema: null
        cross_layer: false
        notes: null

      - name: virtual_routing_policy_3B
        path: data/layer1/3B/virtual_routing_policy/fingerprint={manifest_fingerprint}/virtual_routing_policy_3B.json
        type: dataset
        category: virtual_routing
        semver: "{semver}"
        version: "{manifest_fingerprint}"
        digest: "{sha256}"
        manifest_key: mlr.3B.virtual.routing_policy
        license: "{spdx_or_internal}"
        role: Dual-TZ routing contract consumed by 2B to replay virtual edge selection deterministically.
        dependencies:
          - edge_catalogue_index
          - merchant_cdn_alias_pattern
          - edge_catalogue_pattern
          - edge_universe_hash_3B
        source: internal
        owner: { platform_team }
        last_updated: "{iso8601_timestamp}"
        environment: [ runtime ]
        schema: schemas.3B.yaml#/egress/virtual_routing_policy_3B
        cross_layer: true
        notes: null

      - name: virtual_validation_contract_3B
        path: data/layer1/3B/virtual_validation_contract/fingerprint={manifest_fingerprint}/virtual_validation_contract_3B.parquet
        type: dataset
        category: validation
        semver: "{semver}"
        version: "{manifest_fingerprint}"
        digest: "{sha256}"
        manifest_key: mlr.3B.virtual.validation_contract
        license: "{spdx_or_internal}"
        role: Declarative manifest-scoped test contract listing IP-country, cut-off, and edge-health checks.
        dependencies: [ virtual_validation_policy, virtual_routing_policy_3B ]
        source: internal
        owner: { qa_team }
        last_updated: "{iso8601_timestamp}"
        environment: [ runtime ]
        schema: schemas.3B.yaml#/egress/virtual_validation_contract_3B
        cross_layer: true
        notes: null

      - name: virtual_logging_policy
        path: config/logging/virtual_logging.yml
        type: config
        category: logging
        semver: "{semver}"
        version: "{config_version}"
        digest: "{sha256}"
        manifest_key: mlr.3B.config.virtual_logging
        license: "{spdx_or_internal}"
        role: "Rotation & retention rules for `edge_progress.log`."
        dependencies: []
        source: internal
        owner: { platform_team }
        last_updated: "{iso8601_timestamp}"
        environment: [ runtime ]
        schema: null
        cross_layer: false
        notes: null

      - name: routing_day_effect
        path: config/routing/routing_day_effect.yml
        type: config
        category: routing
        semver: "{semver}"
        version: "{config_version}"
        digest: "{sha256}"
        manifest_key: mlr.2B.config.routing_day_effect
        license: "{spdx_or_internal}"
        role: σ² for daily γ_d (shared from 2B/3A).
        dependencies: []
        source: internal
        owner: { platform_team }
        last_updated: "{iso8601_timestamp}"
        environment: [ runtime ]
        schema: null
        cross_layer: true
        notes: null

      - name: performance_config
        path: config/routing/performance.yml
        type: config
        category: performance
        semver: "{semver}"
        version: "{config_version}"
        digest: "{sha256}"
        manifest_key: mlr.2B.config.performance
        license: "{spdx_or_internal}"
        role: Throughput & memory SLA thresholds (reused by 3B metrics).
        dependencies: []
        source: internal
        owner: { platform_team }
        last_updated: "{iso8601_timestamp}"
        environment: [ ci ]
        schema: null
        cross_layer: true
        notes: null

      # 7 EDGE‑CATALOGUE DERIVED ARTEFACTS
      - name: edge_catalogue_pattern
        path: artefacts/virtual/edge_catalogue/{merchant_id}_edges.parquet
        type: dataset
        category: virtual_edges
        semver: "{semver}"
        version: "{run_id}"
        digest: "{sha256}"
        manifest_key: mlr.3B.dataset.edge_catalogue_pattern
        license: "{spdx_or_internal}"
        role: Deterministically sampled CDN edge nodes (lat, lon, weight).
        dependencies:
          - cdn_country_weights
          - hrsl_raster
          - virtual_settlement_coords
          - edge_catalogue_schema
        source: internal
        owner: { platform_team }
        last_updated: "{iso8601_timestamp}"
        environment: [ runtime ]
        schema: edge_catalogue_schema
        cross_layer: true
        notes: "Pattern — one parquet per virtual merchant."

      - name: edge_catalogue_index
        path: artefacts/virtual/edge_catalogue_index.csv
        type: mapping
        category: virtual_edges
        semver: "{semver}"
        version: "{run_id}"
        digest: "{sha256}"
        manifest_key: mlr.3B.dataset.edge_catalogue_index
        license: "{spdx_or_internal}"
        role: Merchant -> edge‑parquet path + edge_digest lookup table.
        dependencies: [ edge_catalogue_pattern ]
        source: internal
        owner: { platform_team }
        last_updated: "{iso8601_timestamp}"
        environment: [ runtime ]
        schema: null
        cross_layer: true
        notes: null
        
      # 3B NON-MUTATING OVERLAY FOR is_virtual
      - name: virtual_overlay_schema
        path: schema/virtual_overlay.schema.json
        type: schema
        category: virtual_classification
        semver: "{schema_semver}"
        version: "{schema_version}"
        digest: "{sha256}"
        manifest_key: mlr.3B.schema.virtual_overlay
        license: "{spdx_or_internal}"
        role:
          Columns: merchant_id STRING, is_virtual BOOL, reason STRING.
        dependencies: [ ]
        source: internal
        owner: { engineering_team }
        last_updated: "{iso8601_timestamp}"
        environment: [ ci, runtime ]
        schema: null
        cross_layer: true
        notes: "Enables join-on-overlay; 1B site_locations remains immutable."

      - name: virtual_overlay
        path: artefacts/virtual/virtual_overlay_{run_id}.parquet
        type: dataset
        category: virtual_classification
        semver: "{semver}"
        version: "{run_id}"
        digest: "{sha256}"
        manifest_key: mlr.3B.dataset.virtual_overlay
        license: "{spdx_or_internal}"
        role: Non-mutating overlay that provides is_virtual to downstream joins.
        dependencies: [ mcc_channel_rules, virtual_overlay_schema, site_locations ]
        source: internal
        owner: { engineering_team }
        last_updated: "{iso8601_timestamp}"
        environment: [ runtime ]
        schema: virtual_overlay_schema
        cross_layer: true
        notes: "Downstream consumers must `JOIN site_locations USING (merchant_id)`."

      # 3B RNG / GAMMA DRAW AUDIT
      - name: gamma_draw_schema
        path: schema/gamma_draw.schema.json
        type: schema
        category: rng_audit
        semver: "{schema_semver}"
        version: "{schema_version}"
        digest: "{sha256}"
        manifest_key: mlr.3B.schema.gamma_draw
        license: "{spdx_or_internal}"
        role: JSON Schema for per-draw γ audit events (counter, day_index, gamma).
        dependencies: [ ]
        source: internal
        owner: { qa_team }
        last_updated: "{iso8601_timestamp}"
        environment: [ ci, runtime ]
        schema: null
        cross_layer: false
        notes: null

      - name: gamma_draw_log
        path: logs/virtual/{run_id}/gamma_draw.jsonl
        type: log
        category: rng_audit
        semver: "{semver}"
        version: "{run_id}"
        digest: "{sha256}"
        manifest_key: mlr.3B.log.gamma_draw
        license: "{spdx_or_internal}"
        role: Per-merchant draw record (Philox key/counter, day_index, gamma_value).
        dependencies: [ gamma_draw_schema, routing_day_effect ]
        source: internal
        owner: { qa_team }
        last_updated: "{iso8601_timestamp}"
        environment: [ runtime ]
        schema: gamma_draw_schema
        cross_layer: true
        notes: "Complements 4A global RNG trace by capturing 3B-local draws."

      # 3B SCHEMA FOR CDN ALIAS CONTAINER
      - name: cdn_alias_schema
        path: schema/cdn_alias.schema.json
        type: schema
        category: virtual_alias
        semver: "{schema_semver}"
        version: "{schema_version}"
        digest: "{sha256}"
        manifest_key: mlr.3B.schema.cdn_alias
        license: "{spdx_or_internal}"
        role:
          Validates NPZ contents: arrays {edges:int32, probs:float64}, hash:str.
        dependencies: [ ]
        source: internal
        owner: { platform_team }
        last_updated: "{iso8601_timestamp}"
        environment: [ ci, runtime ]
        schema: null
        cross_layer: false
        notes: "Used to sanity-check merchant_cdn_alias_pattern outputs."

      # 8 CDN ALIAS OUTPUTS
      - name: merchant_cdn_alias_pattern
        path: artefacts/virtual/cdn_alias/{merchant_id}_cdn_alias.npz
        type: dataset
        category: virtual_alias
        semver: "{semver}"
        version: "{run_id}"
        digest: "{sha256}"
        manifest_key: mlr.3B.dataset.cdn_alias_pattern
        license: "{spdx_or_internal}"
        role: Alias table & prob arrays on CDN edge weights; embeds virtual_universe_hash.
        dependencies:
          - cdn_country_weights
          - edge_catalogue_pattern
          - cdn_alias_schema
        source: internal
        owner: { platform_team }
        last_updated: "{iso8601_timestamp}"
        environment: [ runtime ]
        schema: cdn_alias_schema
        cross_layer: true
        notes: "Pattern expands per virtual merchant."

      # 9 MANIFESTS & PROVENANCE
      - name: virtual_manifest
        path: artefacts/manifests/virtual_manifest.json
        type: manifest
        category: provenance
        semver: "{semver}"
        version: "{run_id}"
        digest: "{sha256}"
        manifest_key: mlr.3B.manifest.virtual
        license: "{spdx_or_internal}"
        role: Digests of edge catalogues, CDN aliases, governing configs, and civil-time lineage.
        dependencies:
          - edge_catalogue_index
          - merchant_cdn_alias_pattern
          - virtual_overlay
          - cdn_country_weights
          - mcc_channel_rules
          - hrsl_raster
          - pelias_cached_sqlite
          - virtual_settlement_coords
          - edge_catalogue_schema
          - rng_policy
          - civil_time_manifest
        source: internal
        owner: { platform_team }
        last_updated: "{iso8601_timestamp}"
        environment: [ runtime ]
        schema: null
        cross_layer: false
        notes: null

      - name: build_fingerprint_3B
        path: artefacts/manifests/build_fingerprint_3B.txt
        type: manifest
        category: provenance
        semver: "{semver}"
        version: "{run_id}"
        digest: "{sha256}"
        manifest_key: mlr.3B.manifest.build_fingerprint
        license: "{spdx_or_internal}"
        role: Composite SHA‑256 tying 3B to upstream & governed artefacts.
        dependencies:
          - virtual_manifest
          - rng_policy
        source: internal
        owner: { platform_team }
        last_updated: "{iso8601_timestamp}"
        environment: [ runtime ]
        schema: null
        cross_layer: false
        notes: null

      # 9a HASHGATE OUTPUTS (3B)
      - name: validation_bundle_3B
        path: data/layer1/3B/validation/fingerprint={manifest_fingerprint}/
        type: bundle
        category: validation
        semver: "{semver}"
        version: "{manifest_fingerprint}"
        digest: "{sha256}"
        manifest_key: mlr.3B.validation.bundle
        license: "{spdx_or_internal}"
        role: Fingerprint-scoped evidence bundle for 3B; contains validation reports, digests, and manifests.
        dependencies:
          - virtual_manifest
          - virtual_routing_policy_3B
          - virtual_validation_contract_3B
          - edge_universe_hash_3B
        source: internal
        owner: { qa_team }
        last_updated: "{iso8601_timestamp}"
        environment: [ runtime ]
        schema: schemas.layer1.yaml#/validation/validation_bundle_index_3B
        cross_layer: true
        notes: null

      - name: validation_bundle_index_3B
        path: data/layer1/3B/validation/fingerprint={manifest_fingerprint}/index.json
        type: dataset
        category: validation
        semver: "{semver}"
        version: "{manifest_fingerprint}"
        digest: "{sha256}"
        manifest_key: mlr.3B.validation.bundle_index
        license: "{spdx_or_internal}"
        role: Canonical index.json enumerating bundle evidence and SHA-256 digests.
        dependencies: [ validation_bundle_3B ]
        source: internal
        owner: { qa_team }
        last_updated: "{iso8601_timestamp}"
        environment: [ runtime ]
        schema: schemas.layer1.yaml#/validation/validation_bundle_index_3B
        cross_layer: true
        notes: null

      - name: passed_flag_3B
        path: data/layer1/3B/validation/fingerprint={manifest_fingerprint}/_passed.flag_3B
        type: file
        category: validation
        semver: "{semver}"
        version: "{manifest_fingerprint}"
        digest: "{sha256}"
        manifest_key: mlr.3B.validation.passed
        license: "{spdx_or_internal}"
        role: Single-line digest that downstream segments verify before reading 3B outputs (No PASS → No read).
        dependencies: [ validation_bundle_index_3B ]
        source: internal
        owner: { qa_team }
        last_updated: "{iso8601_timestamp}"
        environment: [ runtime ]
        schema: schemas.layer1.yaml#/validation/passed_flag_3B
        cross_layer: true
        notes: null

      - name: s5_manifest_3B
        path: data/layer1/3B/validation/fingerprint={manifest_fingerprint}/s5_manifest_3B.json
        type: dataset
        category: validation
        semver: "{semver}"
        version: "{manifest_fingerprint}"
        digest: "{sha256}"
        manifest_key: mlr.3B.validation.s5_manifest
        license: "{spdx_or_internal}"
        role: Summary manifest emitted by 3B.S5 (identity, digests, check outcomes); included in the bundle.
        dependencies:
          - validation_bundle_3B
        source: internal
        owner: { qa_team }
        last_updated: "{iso8601_timestamp}"
        environment: [ runtime ]
        schema: schemas.3B.yaml#/validation/s5_manifest_3B
        cross_layer: false
        notes: null

      # 10 PROCESS & RECOVERY LOGS
      - name: edge_progress_log
        path: logs/virtual/{run_id}/edge_progress.log
        type: log
        category: progress_log
        semver: "{semver}"
        version: "{run_id}"
        digest: "{sha256}"
        manifest_key: mlr.3B.log.edge_progress
        license: "{spdx_or_internal}"
        role: Records finished country batches for crash‑safe restarts.
        dependencies: [ virtual_logging_policy ]
        source: internal
        owner: { platform_team }
        last_updated: "{iso8601_timestamp}"
        environment: [ runtime ]
        schema: null
        cross_layer: false
        notes: null

      - name: virtual_audit_log
        path: logs/virtual/{run_id}/virtual_audit.log
        type: log
        category: virtual_audit
        semver: "{semver}"
        version: "{run_id}"
        digest: "{sha256}"
        manifest_key: mlr.3B.log.virtual_audit
        license: "{spdx_or_internal}"
        role: SHA‑256(batch_index ‖ cumulative_country_counts) audit lines.
        dependencies: [ virtual_logging_policy ]
        source: internal
        owner: { qa_team }
        last_updated: "{iso8601_timestamp}"
        environment: [ runtime ]
        schema: null
        cross_layer: false
        notes: null

      # 11 GOVERNED CODE MODULES & SCRIPTS
      - name: derive_is_virtual_py
        path: src/virtual/derive_is_virtual.py
        type: code
        category: virtual_classification
        semver: "{code_semver}"
        version: "{git_commit}"
        digest: "{git_tree_hash}"
        manifest_key: mlr.3B.code.derive_is_virtual
        license: "{spdx_or_internal}"
        role: "Derives non-mutating `virtual_overlay` from MCC rules; does NOT alter 1B."
        dependencies: [ mcc_channel_rules, site_locations, virtual_overlay_schema ]
        source: internal
        owner: { engineering_team }
        last_updated: "{iso8601_timestamp}"
        environment: [ dev, staging, prod ]
        schema: null
        cross_layer: false
        notes: null

      - name: edge_sampler_py
        path: src/virtual/edge_sampler.py
        type: code
        category: virtual_edges
        semver: "{code_semver}"
        version: "{git_commit}"
        digest: "{git_tree_hash}"
        manifest_key: mlr.3B.code.edge_sampler
        license: "{spdx_or_internal}"
        role: Builds edge_catalogue parquet using deterministic weighted routing law.
        dependencies: [ hrsl_raster ]
        source: internal
        owner: { engineering_team }
        last_updated: "{iso8601_timestamp}"
        environment: [ dev, staging, prod ]
        schema: null
        cross_layer: false
        notes: null

      - name: alias_builder_py
        path: src/virtual/alias_builder.py
        type: code
        category: virtual_alias
        semver: "{code_semver}"
        version: "{git_commit}"
        digest: "{git_tree_hash}"
        manifest_key: mlr.3B.code.alias_builder
        license: "{spdx_or_internal}"
        role: Builds NPZ alias tables embedding virtual_universe_hash.
        dependencies: [ cdn_country_weights, edge_catalogue_pattern, universe_hash_policy ]
        source: internal
        owner: { engineering_team }
        last_updated: "{iso8601_timestamp}"
        environment: [ dev, staging, prod ]
        schema: null
        cross_layer: false
        notes: null

      - name: validate_virtual_py
        path: ci/tests/validate_virtual.py
        type: ci_test
        category: virtual_validation
        semver: "{code_semver}"
        version: "{git_commit}"
        digest: "{git_tree_hash}"
        manifest_key: mlr.3B.ci.validate_virtual
        license: "{spdx_or_internal}"
        role: Runs share & cut‑off validation on sample run outputs.
        dependencies:
          - virtual_validation_policy
          - merchant_cdn_alias_pattern
          - virtual_manifest
          - civil_time_manifest
        source: internal
        owner: { qa_team }
        last_updated: "{iso8601_timestamp}"
        environment: [ ci ]
        schema: null
        cross_layer: false
        notes: null

      # 12 CI / UNIT TESTS
      - name: test_virtual_rules_py
        path: ci/tests/test_virtual_rules.py
        type: ci_test
        category: virtual_classification
        semver: "{code_semver}"
        version: "{git_commit}"
        digest: "{git_tree_hash}"
        manifest_key: mlr.3B.ci.virtual_rules
        license: "{spdx_or_internal}"
        role: Ensures derive_is_virtual output matches MCC rules.
        dependencies: [ mcc_channel_rules, site_locations ]
        source: internal
        owner: { qa_team }
        last_updated: "{iso8601_timestamp}"
        environment: [ ci ]
        schema: null
        cross_layer: false
        notes: null

      - name: test_geocoder_bundle_py
        path: ci/tests/test_geocoder_bundle.py
        type: ci_test
        category: virtual_geocode
        semver: "{code_semver}"
        version: "{git_commit}"
        digest: "{git_tree_hash}"
        manifest_key: mlr.3B.ci.geocoder_bundle
        license: "{spdx_or_internal}"
        role: Asserts evidence_url geocodes within 5 km of stored coords.
        dependencies: [ pelias_cached_sqlite, virtual_settlement_coords ]
        source: internal
        owner: { qa_team }
        last_updated: "{iso8601_timestamp}"
        environment: [ ci ]
        schema: null
        cross_layer: false
        notes: null

      - name: test_virtual_validation_py
        path: ci/tests/test_virtual_validation.py
        type: ci_test
        category: validation
        semver: "{code_semver}"
        version: "{git_commit}"
        digest: "{git_tree_hash}"
        manifest_key: mlr.3B.ci.virtual_validation
        license: "{spdx_or_internal}"
        role: Runs end‑to‑end validator and fails CI on drift.
        dependencies: [ virtual_validation_policy, merchant_cdn_alias_pattern ]
        source: internal
        owner: { qa_team }
        last_updated: "{iso8601_timestamp}"
        environment: [ ci ]
        schema: null
        cross_layer: false
        notes: null

      # 13 PERFORMANCE METRICS
      - name: edge_sampler_metrics
        path: artefacts/metrics/edge_sampler_{run_id}.parquet
        type: dataset
        category: metrics
        semver: "{semver}"
        version: "{run_id}"
        digest: "{sha256}"
        manifest_key: mlr.3B.metrics.edge_sampler
        license: "{spdx_or_internal}"
        role: Samples/sec and memory footprint of edge sampler.
        dependencies: [ performance_config ]
        source: internal
        owner: { qa_team }
        last_updated: "{iso8601_timestamp}"
        environment: [ ci ]
        schema: null
        cross_layer: false
        notes: null

      # 14 DOCUMENTATION & LICENCE PROOFS
      - name: licenses_akamai_md
        path: LICENSES/akamai_soti.md
        type: documentation
        category: licensing
        semver: "{semver}"
        version: "{doc_version}"
        digest: "{sha256}"
        manifest_key: mlr.3B.docs.licensing.akamai
        license: CC‑BY‑4.0
        role: License text for Akamai SOTI dataset.
        dependencies: []
        source: external
        owner: { data_governance_team }
        last_updated: "{iso8601_timestamp}"
        environment: [ dev, ci, runtime ]
        schema: null
        cross_layer: false
        notes: null

      - name: licenses_hrsl_md
        path: LICENSES/facebook_hrsl.md
        type: documentation
        category: licensing
        semver: "{semver}"
        version: "{doc_version}"
        digest: "{sha256}"
        manifest_key: mlr.3B.docs.licensing.hrsl
        license: CC‑BY‑4.0
        role: License text for HRSL raster.
        dependencies: []
        source: external
        owner: { data_governance_team }
        last_updated: "{iso8601_timestamp}"
        environment: [ dev, ci, runtime ]
        schema: null
        cross_layer: false
        notes: null

      # 15 EXCEPTION CONTRACTS
      - name: VirtualUniverseMismatchError
        path: null
        type: exception
        category: exception_contract
        semver: null
        version: null
        digest: null
        manifest_key: mlr.3B.exception.universe_mismatch
        license: null
        role: Raised when virtual_universe_hash mismatch in replay.
        dependencies: []
        source: internal
        owner: { platform_team }
        last_updated: "{iso8601_timestamp}"
        environment: [ runtime ]
        schema: null
        cross_layer: false
        notes: null

      - name: VirtualEdgeSamplingError
        path: null
        type: exception
        category: exception_contract
        semver: null
        version: null
        digest: null
        manifest_key: mlr.3B.exception.edge_sampling
        license: null
        role: Raised when edge sampler fails to hit population ≥ threshold.
        dependencies: []
        source: internal
        owner: { platform_team }
        last_updated: "{iso8601_timestamp}"
        environment: [ runtime ]
        schema: null
        cross_layer: false
        notes: null

      # additional artefacts
      - name: rng_policy
        path: config/routing/rng_policy.yml
        type: config
        category: routing
        semver: "{semver}"
        version: "{config_version}"
        digest: "{sha256}"
        manifest_key: mlr.2B.config.rng_policy
        license: "{spdx_or_internal}"
        role: Cross-layer RNG policy (SHA-256 keyed Philox) for CDN alias stream keying.
        dependencies: [ ]
        source: internal
        owner: { platform_team }
        last_updated: "{iso8601_timestamp}"
        environment: [ runtime ]
        schema: null
        cross_layer: true
        notes: null

      - name: edge_catalogue_schema
        path: schema/edge_catalogue.schema.json
        type: schema
        category: virtual_edges
        semver: "{semver}"
        version: "{schema_version}"
        digest: "{sha256}"
        manifest_key: mlr.3B.schema.edge_catalogue
        license: "{spdx_or_internal}"
        role: JSON-Schema used to validate all edge_catalogue parquets.
        dependencies: [ ]
        source: internal
        owner: { qa_team }
        last_updated: "{iso8601_timestamp}"
        environment: [ ci, runtime ]
        schema: null
        cross_layer: false
        notes: null

      - name: universe_hash_policy
        path: docs/universe_hash_policy.md
        type: documentation
        category: governance
        semver: "{semver}"
        version: "{doc_version}"
        digest: "{sha256}"
        manifest_key: mlr.3B.docs.universe_hash_policy
        license: "{spdx_or_internal}"
        role: Canonical concatenation order for virtual_universe_hash embedded in alias files.
        dependencies: [ ]
        source: internal
        owner: { platform_team }
        last_updated: "{iso8601_timestamp}"
        environment: [ dev, ci, runtime ]
        schema: null
        cross_layer: true
        notes: null

      - name: virtual_licenses_manifest
        path: artefacts/manifests/virtual_licenses_manifest.json
        type: manifest
        category: licensing
        semver: "{semver}"
        version: "{run_id}"
        digest: "{sha256}"
        manifest_key: mlr.3B.manifest.licenses
        license: "{spdx_or_internal}"
        role: Roll-up of license digests for virtual subsegment.
        dependencies:
          - licenses_akamai_md
          - licenses_hrsl_md
          - virtual_licenses_dir
        source: internal
        owner: { data_governance_team }
        last_updated: "{iso8601_timestamp}"
        environment: [ ci, runtime ]
        schema: null
        cross_layer: false
        notes: null

      - name: civil_time_manifest
        path: artefacts/manifests/civil_time_manifest.json
        type: manifest
        category: provenance
        semver: "{semver}"
        version: "{run_id}"
        digest: "{sha256}"
        manifest_key: mlr.2A.manifest.civil_time
        license: "{spdx_or_internal}"
        role: Cross-layer digest roll-up from 2A (tz polygons/index/overrides/tzdata/horizon).
        dependencies: [ ]
        source: internal
        owner: { platform_team }
        environment: [ runtime ]
        schema: null
        cross_layer: true
        notes: "Referenced by virtual_manifest for settlement cut-off provenance."

      - name: virtual_licenses_dir
        path: LICENSES/
        type: directory
        category: licensing
        semver: "{semver}"
        version: "{run_id}"
        digest: "{sha256_tree}"
        manifest_key: mlr.3B.licenses
        license: "SEE-FILES"
        role: SPDX texts for HRSL, Akamai SOTI and any other external assets used by 3B.
        dependencies: [ ]
        source: internal
        owner: { legal_team }
        environment: [ ci, runtime ]
        schema: null
        cross_layer: true
        notes: null
