version: '1.0'

lifecycle:
  phase: planning
  last_reviewed:
  approver:

ci_policy:
  allow_placeholders: true
  placeholder_markers: [TBD, null]
  block_on_phase: [beta, stable]

layer:
  id: layer1
  name: Merchant Location Realism

reference_data:
- id: zone_mixture_policy
  status: draft
  owner_subsegment: 3A
  description: Governed escalation policy describing theta thresholds and decision reasons.
  version: '{policy_version}'
  format: yaml
  path: config/layer1/3A/policy/zone_mixture_policy.yaml
  partitioning: []
  ordering: []
  schema_ref: schemas.3A.yaml#/policy/zone_mixture_policy_v1
  lineage:
    produced_by: 3A.governance
    consumed_by: [3A]
    final_in_layer: false
  retention_days: 1825
  pii: false
  licence: Proprietary-Internal

- id: country_zone_alphas
  status: draft
  owner_subsegment: 3A
  description: Dirichlet concentration priors per country×tzid used by S2.
  version: '{prior_pack_version}'
  format: yaml
  path: config/layer1/3A/allocation/country_zone_alphas.yaml
  partitioning: []
  ordering: []
  schema_ref: schemas.3A.yaml#/policy/country_zone_alphas_v1
  lineage:
    produced_by: 3A.governance
    consumed_by: [3A]
    final_in_layer: false
  retention_days: 1825
  pii: false
  licence: Proprietary-Internal

- id: zone_floor_policy
  status: draft
  owner_subsegment: 3A
  description: Global zone floor and bump rules.
  version: '{policy_version}'
  format: yaml
  path: config/layer1/3A/allocation/zone_floor_policy.yaml
  partitioning: []
  ordering: []
  schema_ref: schemas.3A.yaml#/policy/zone_floor_policy_v1
  lineage:
    produced_by: 3A.governance
    consumed_by: [3A]
    final_in_layer: false
  retention_days: 1825
  pii: false
  licence: Proprietary-Internal

- id: day_effect_policy_v1
  status: approved
  owner_subsegment: 2B
  description: Day-effect variance/γ policy consumed when computing routing universe hash.
  version: '{policy_version}'
  format: json
  path: config/layer1/2B/policy/day_effect_policy_v1.json
  partitioning: []
  ordering: []
  schema_ref: schemas.2B.yaml#/policy/day_effect_policy_v1
  lineage:
    produced_by: 2B.governance
    consumed_by: [2B, 3A]
    final_in_layer: false
  retention_days: 1825
  pii: false
  licence: Proprietary-Internal

- id: outlet_catalogue
  status: approved
  owner_subsegment: 1A
  description: Outlet catalogue emitted by Segment 1A (per merchantxcountry site list).
  version: '{manifest_fingerprint}'
  format: parquet
  path: data/layer1/1A/outlet_catalogue/seed={seed}/manifest_fingerprint={manifest_fingerprint}/
  partitioning: [seed, manifest_fingerprint]
  ordering: [merchant_id, legal_country_iso, site_order]
  schema_ref: schemas.1A.yaml#/egress/outlet_catalogue
  lineage:
    produced_by: 1A.S8
    consumed_by: [3A]
    final_in_layer: true
  retention_days: 365
  pii: false
  licence: Proprietary-Internal

- id: site_timezones
  status: approved
  owner_subsegment: 2A
  description: Per-site tzid assignments from Segment 2A (optional pin for routing governance).
  version: '{seed}.{manifest_fingerprint}'
  format: parquet
  path: data/layer1/2A/site_timezones/seed={seed}/manifest_fingerprint={manifest_fingerprint}/
  partitioning: [seed, manifest_fingerprint]
  ordering: [merchant_id, legal_country_iso, site_order]
  schema_ref: schemas.2A.yaml#/egress/site_timezones
  lineage:
    produced_by: 2A.S2
    consumed_by: [3A]
    final_in_layer: true
  retention_days: 365
  pii: false
  licence: Proprietary-Internal

- id: tz_timetable_cache
  status: approved
  owner_subsegment: 2A
  description: Fingerprint-scoped civil-time cache manifest compiled by Segment 2A.
  version: '{manifest_fingerprint}'
  format: files
  path: data/layer1/2A/tz_timetable_cache/manifest_fingerprint={manifest_fingerprint}/
  partitioning: [manifest_fingerprint]
  ordering: []
  schema_ref: schemas.2A.yaml#/cache/tz_timetable_cache
  lineage:
    produced_by: 2A.S3
    consumed_by: [3A]
    final_in_layer: false
  retention_days: 365
  pii: false
  licence: Proprietary-Internal

- id: s4_legality_report
  status: optional
  owner_subsegment: 2A
  description: Optional DST gaps/folds legality report from Segment 2A.
  version: '{seed}.{manifest_fingerprint}'
  format: json
  path: data/layer1/2A/legality_report/seed={seed}/manifest_fingerprint={manifest_fingerprint}/s4_legality_report.json
  partitioning: [seed, manifest_fingerprint]
  ordering: []
  schema_ref: schemas.2A.yaml#/validation/s4_legality_report
  lineage:
    produced_by: 2A.S4
    consumed_by: [3A]
    final_in_layer: false
  retention_days: 365
  pii: false
  licence: Proprietary-Internal

- id: iso3166_canonical_2024
  status: approved
  owner_subsegment: ingress
  description: ISO 3166-1 alpha-2 canonical table (2024-12-31 release).
  version: '2024-12-31'
  format: parquet
  path: reference/iso/iso3166_canonical/2024-12-31/iso3166.parquet
  partitioning: []
  ordering: []
  schema_ref: schemas.ingress.layer1.yaml#/iso3166_canonical_2024
  lineage:
    produced_by:
    consumed_by: [3A]
    final_in_layer: false
  retention_days: 1095
  pii: false
  licence: CC-BY-4.0

- id: tz_world_2025a
  status: approved
  owner_subsegment: ingress
  description: Time-zone polygons (GeoParquet) for the 2025a TZDB release.
  version: '2025a'
  format: parquet
  path: reference/spatial/tz_world/2025a/tz_world.parquet
  partitioning: []
  ordering: []
  schema_ref: schemas.ingress.layer1.yaml#/tz_world_2025a
  lineage:
    produced_by:
    consumed_by: [3A]
    final_in_layer: false
  retention_days: 1095
  pii: false
  licence: ODbL-1.0

datasets:
- id: s0_gate_receipt_3A
  status: draft
  owner_subsegment: 3A
  description: Gate descriptor proving upstream PASS status and sealed policy set.
  version: '{manifest_fingerprint}'
  format: json
  path: data/layer1/3A/s0_gate_receipt/manifest_fingerprint={manifest_fingerprint}/s0_gate_receipt_3A.json
  partitioning: [manifest_fingerprint]
  ordering: []
  schema_ref: schemas.3A.yaml#/validation/s0_gate_receipt_3A
  lineage:
    produced_by: 3A.S0
    consumed_by: [3A.S1, 3A.S2, 3A.S3, 3A.S4, 3A.S5, 3A.S6, 3A.S7]
    final_in_layer: false
  retention_days: 365
  pii: false
  licence: Proprietary-Internal

- id: sealed_inputs_3A
  status: draft
  owner_subsegment: 3A
  description: Sealed inventory of artefacts authorised for Segment 3A.
  version: '{manifest_fingerprint}'
  format: json
  path: data/layer1/3A/sealed_inputs/manifest_fingerprint={manifest_fingerprint}/sealed_inputs_3A.json
  partitioning: [manifest_fingerprint]
  ordering: [owner_segment, artefact_kind, logical_id]
  schema_ref: schemas.3A.yaml#/validation/sealed_inputs_3A
  lineage:
    produced_by: 3A.S0
    consumed_by: [3A.S1, 3A.S2, 3A.S3, 3A.S4, 3A.S5, 3A.S6, 3A.S7]
    final_in_layer: false
  retention_days: 365
  pii: false
  licence: Proprietary-Internal

- id: s1_escalation_queue
  status: draft
  owner_subsegment: 3A
  description: Per-merchant escalation decisions and totals.
  version: '{seed}.{manifest_fingerprint}'
  format: parquet
  path: data/layer1/3A/s1_escalation_queue/seed={seed}/manifest_fingerprint={manifest_fingerprint}/
  partitioning: [seed, manifest_fingerprint]
  ordering: [merchant_id, legal_country_iso]
  schema_ref: schemas.3A.yaml#/plan/s1_escalation_queue
  lineage:
    produced_by: 3A.S1
    consumed_by: [3A.S3, 3A.S4, 3A.S5]
    final_in_layer: false
  retention_days: 365
  pii: false
  licence: Proprietary-Internal

- id: s2_country_zone_priors
  status: draft
  owner_subsegment: 3A
  description: Parameter-scoped Dirichlet α-vectors per country×tzid.
  version: '{parameter_hash}'
  format: parquet
  path: data/layer1/3A/s2_country_zone_priors/parameter_hash={parameter_hash}/
  partitioning: [parameter_hash]
  ordering: [country_iso, tzid]
  schema_ref: schemas.3A.yaml#/plan/s2_country_zone_priors
  lineage:
    produced_by: 3A.S2
    consumed_by: [3A.S3, 3A.S4, 3A.S5]
    final_in_layer: false
  retention_days: 1095
  pii: false
  licence: Proprietary-Internal

- id: s3_zone_shares
  status: draft
  owner_subsegment: 3A
  description: Dirichlet share draws per merchant×country×zone.
  version: '{seed}.{manifest_fingerprint}'
  format: parquet
  path: data/layer1/3A/s3_zone_shares/seed={seed}/manifest_fingerprint={manifest_fingerprint}/
  partitioning: [seed, manifest_fingerprint]
  ordering: [merchant_id, legal_country_iso, tzid]
  schema_ref: schemas.3A.yaml#/plan/s3_zone_shares
  lineage:
    produced_by: 3A.S3
    consumed_by: [3A.S4, 3A.S5]
    final_in_layer: false
  retention_days: 365
  pii: false
  licence: Proprietary-Internal

- id: rng_audit_log
  status: draft
  owner_subsegment: 3A
  description: RNG run audit (identity/config) - one row at run start for 3A routing runs.
  version: '{run_id}'
  format: jsonl
  path: logs/layer1/3A/rng/audit/seed={seed}/parameter_hash={parameter_hash}/run_id={run_id}/rng_audit_log.jsonl
  partitioning: [seed, parameter_hash, run_id]
  ordering: []
  schema_ref: schemas.layer1.yaml#/rng/core/rng_audit_log
  lineage:
    produced_by: 3A.S3
    consumed_by: [3A]
    final_in_layer: false
  retention_days: 365
  pii: false
  licence: Proprietary-Internal

- id: rng_trace_log
  status: draft
  owner_subsegment: 3A
  description: RNG cumulative trace - append exactly one row after each event append for 3A S3 runs.
  version: '{run_id}'
  format: jsonl
  path: logs/layer1/3A/rng/trace/seed={seed}/parameter_hash={parameter_hash}/run_id={run_id}/rng_trace_log.jsonl
  partitioning: [seed, parameter_hash, run_id]
  ordering: []
  schema_ref: schemas.layer1.yaml#/rng/core/rng_trace_log
  lineage:
    produced_by: 3A.S3
    consumed_by: [3A]
    final_in_layer: false
  retention_days: 365
  pii: false
  licence: Proprietary-Internal

- id: rng_event_zone_dirichlet
  status: draft
  owner_subsegment: 3A
  description: RNG events for 3A.S3 Dirichlet draws (one per escalated merchant x country).
  version: '{run_id}'
  format: jsonl
  path: logs/layer1/3A/rng/events/zone_dirichlet/seed={seed}/parameter_hash={parameter_hash}/run_id={run_id}/part-*.jsonl
  partitioning: [seed, parameter_hash, run_id]
  ordering: []
  schema_ref: schemas.layer1.yaml#/rng/events/zone_dirichlet
  lineage:
    produced_by: 3A.S3
    consumed_by: [3A]
    final_in_layer: false
  retention_days: 30
  pii: false
  licence: Proprietary-Internal

- id: s4_zone_counts
  status: draft
  owner_subsegment: 3A
  description: Integer outlet counts per merchant×country×zone after floor/bump.
  version: '{seed}.{manifest_fingerprint}'
  format: parquet
  path: data/layer1/3A/s4_zone_counts/seed={seed}/manifest_fingerprint={manifest_fingerprint}/
  partitioning: [seed, manifest_fingerprint]
  ordering: [merchant_id, legal_country_iso, tzid]
  schema_ref: schemas.3A.yaml#/plan/s4_zone_counts
  lineage:
    produced_by: 3A.S4
    consumed_by: [3A.S5]
    final_in_layer: false
  retention_days: 365
  pii: false
  licence: Proprietary-Internal

- id: zone_alloc
  status: draft
  owner_subsegment: 3A
  description: Cross-layer zone allocation egress for routing segment.
  version: '{seed}.{manifest_fingerprint}'
  format: parquet
  path: data/layer1/3A/zone_alloc/seed={seed}/manifest_fingerprint={manifest_fingerprint}/
  partitioning: [seed, manifest_fingerprint]
  ordering: [merchant_id, legal_country_iso, tzid]
  schema_ref: schemas.3A.yaml#/egress/zone_alloc
  lineage:
    produced_by: 3A.S5
    consumed_by: [2B, validation, cross_segment_validation]
    final_in_layer: true
  retention_days: 1095
  pii: false
  licence: Proprietary-Internal

- id: zone_alloc_universe_hash
  status: draft
  owner_subsegment: 3A
  description: Digest summary tying priors/policies to the published zone allocation.
  version: '{manifest_fingerprint}'
  format: json
  path: data/layer1/3A/zone_universe/manifest_fingerprint={manifest_fingerprint}/zone_alloc_universe_hash.json
  partitioning: [manifest_fingerprint]
  ordering: []
  schema_ref: schemas.3A.yaml#/validation/zone_alloc_universe_hash
  lineage:
    produced_by: 3A.S5
    consumed_by: [2B, validation]
    final_in_layer: false
  retention_days: 1095
  pii: false
  licence: Proprietary-Internal

- id: s6_validation_report_3A
  status: draft
  owner_subsegment: 3A
  description: Structural validation report emitted by 3A.S6.
  version: '{manifest_fingerprint}'
  format: json
  path: data/layer1/3A/s6_validation_report/manifest_fingerprint={manifest_fingerprint}/report.json
  partitioning: [manifest_fingerprint]
  ordering: []
  schema_ref: schemas.3A.yaml#/validation/s6_validation_report_3A
  lineage:
    produced_by: 3A.S6
    consumed_by: [3A.S7, cross_segment_validation]
    final_in_layer: false
  retention_days: 365
  pii: false
  licence: Proprietary-Internal

- id: s6_issue_table_3A
  status: draft
  owner_subsegment: 3A
  description: Per-issue findings emitted by 3A.S6.
  version: '{manifest_fingerprint}'
  format: parquet
  path: data/layer1/3A/s6_issues/manifest_fingerprint={manifest_fingerprint}/issues.parquet
  partitioning: [manifest_fingerprint]
  ordering: [severity, issue_code, merchant_id, legal_country_iso, tzid]
  schema_ref: schemas.3A.yaml#/validation/s6_issue_table_3A
  lineage:
    produced_by: 3A.S6
    consumed_by: [3A.S7, ops_tooling]
    final_in_layer: false
  retention_days: 365
  pii: false
  licence: Proprietary-Internal

- id: s6_receipt_3A
  status: draft
  owner_subsegment: 3A
  description: Compact validation receipt capturing S6 outcomes.
  version: '{manifest_fingerprint}'
  format: json
  path: data/layer1/3A/s6_receipt/manifest_fingerprint={manifest_fingerprint}/s6_receipt.json
  partitioning: [manifest_fingerprint]
  ordering: []
  schema_ref: schemas.3A.yaml#/validation/s6_receipt_3A
  lineage:
    produced_by: 3A.S6
    consumed_by: [3A.S7]
    final_in_layer: false
  retention_days: 365
  pii: false
  licence: Proprietary-Internal

- id: validation_bundle_3A
  status: draft
  owner_subsegment: 3A
  description: Fingerprint-scoped validation bundle for Segment 3A.
  version: '{manifest_fingerprint}'
  format: dir
  path: data/layer1/3A/validation/manifest_fingerprint={manifest_fingerprint}/
  partitioning: [manifest_fingerprint]
  ordering: []
  schema_ref: schemas.layer1.yaml#/validation/validation_bundle_index_3A
  lineage:
    produced_by: 3A.S7
    consumed_by: [orchestrator, cross_segment_validation]
    final_in_layer: true
  retention_days: 1095
  pii: false
  licence: Proprietary-Internal

- id: validation_passed_flag_3A
  status: draft
  owner_subsegment: 3A
  description: HashGate PASS flag accompanying the 3A validation bundle.
  version: '{manifest_fingerprint}'
  format: text
  path: data/layer1/3A/validation/manifest_fingerprint={manifest_fingerprint}/_passed.flag
  partitioning: [manifest_fingerprint]
  ordering: []
  schema_ref: schemas.layer1.yaml#/validation/passed_flag_3A
  lineage:
    produced_by: 3A.S7
    consumed_by: [orchestrator, segment_readers]
    final_in_layer: true
  retention_days: 1095
  pii: false
  licence: Proprietary-Internal

reports:
- id: segment_state_runs
  status: draft
  owner_subsegment: 3A
  description: Layer-1 segment-state run-report (JSONL), one row per state invocation.
  version: latest
  format: jsonl
  path: reports/layer1/segment_state_runs/segment=3A/utc_day={utc_day}/segment_state_runs.jsonl
  partitioning: []
  ordering: []
  schema_ref: schemas.layer1.yaml#/run_report/segment_state_run
  lineage:
    produced_by: 3A.S0|3A.S1|3A.S2|3A.S3|3A.S4|3A.S5|3A.S6|3A.S7
    consumed_by: [orchestrator, ops]
    final_in_layer: false
  retention_days: 365
  pii: false
  licence: Proprietary-Internal

- id: s1_run_report_3A
  status: draft
  owner_subsegment: 3A
  description: Run report for 3A.S1 escalation queue.
  version: '{seed}.{manifest_fingerprint}'
  format: json
  path: reports/layer1/3A/state=S1/seed={seed}/manifest_fingerprint={manifest_fingerprint}/run_report.json
  partitioning: [seed, manifest_fingerprint]
  ordering: []
  schema_ref: schemas.layer1.yaml#/run_report/segment_state_run
  lineage:
    produced_by: 3A.S1
    consumed_by: [ops]
    final_in_layer: false
  retention_days: 365
  pii: false
  licence: Proprietary-Internal

- id: s2_run_report_3A
  status: draft
  owner_subsegment: 3A
  description: Run report for 3A.S2 priors stage.
  version: '{parameter_hash}'
  format: json
  path: reports/layer1/3A/state=S2/parameter_hash={parameter_hash}/run_report.json
  partitioning: [parameter_hash]
  ordering: []
  schema_ref: schemas.layer1.yaml#/run_report/segment_state_run
  lineage:
    produced_by: 3A.S2
    consumed_by: [ops]
    final_in_layer: false
  retention_days: 365
  pii: false
  licence: Proprietary-Internal

- id: s3_run_report_3A
  status: draft
  owner_subsegment: 3A
  description: Run report for 3A.S3 zone share sampling.
  version: '{seed}.{manifest_fingerprint}'
  format: json
  path: reports/layer1/3A/state=S3/seed={seed}/manifest_fingerprint={manifest_fingerprint}/run_report.json
  partitioning: [seed, manifest_fingerprint]
  ordering: []
  schema_ref: schemas.layer1.yaml#/run_report/segment_state_run
  lineage:
    produced_by: 3A.S3
    consumed_by: [ops]
    final_in_layer: false
  retention_days: 365
  pii: false
  licence: Proprietary-Internal

- id: s4_run_report_3A
  status: draft
  owner_subsegment: 3A
  description: Run report for 3A.S4 zone count integerisation.
  version: '{seed}.{manifest_fingerprint}'
  format: json
  path: reports/layer1/3A/state=S4/seed={seed}/manifest_fingerprint={manifest_fingerprint}/run_report.json
  partitioning: [seed, manifest_fingerprint]
  ordering: []
  schema_ref: schemas.layer1.yaml#/run_report/segment_state_run
  lineage:
    produced_by: 3A.S4
    consumed_by: [ops]
    final_in_layer: false
  retention_days: 365
  pii: false
  licence: Proprietary-Internal

- id: s5_run_report_3A
  status: draft
  owner_subsegment: 3A
  description: Run report for 3A.S5 zone allocation egress.
  version: '{seed}.{manifest_fingerprint}'
  format: json
  path: reports/layer1/3A/state=S5/seed={seed}/manifest_fingerprint={manifest_fingerprint}/run_report.json
  partitioning: [seed, manifest_fingerprint]
  ordering: []
  schema_ref: schemas.layer1.yaml#/run_report/segment_state_run
  lineage:
    produced_by: 3A.S5
    consumed_by: [ops]
    final_in_layer: false
  retention_days: 365
  pii: false
  licence: Proprietary-Internal

- id: s6_run_report_3A
  status: draft
  owner_subsegment: 3A
  description: Run report for 3A.S6 validation.
  version: '{seed}.{manifest_fingerprint}'
  format: json
  path: reports/layer1/3A/state=S6/seed={seed}/manifest_fingerprint={manifest_fingerprint}/run_report.json
  partitioning: [seed, manifest_fingerprint]
  ordering: []
  schema_ref: schemas.layer1.yaml#/run_report/segment_state_run
  lineage:
    produced_by: 3A.S6
    consumed_by: [ops]
    final_in_layer: false
  retention_days: 365
  pii: false
  licence: Proprietary-Internal

- id: s7_run_report_3A
  status: draft
  owner_subsegment: 3A
  description: Run report for 3A.S7 validation bundle.
  version: '{seed}.{manifest_fingerprint}'
  format: json
  path: reports/layer1/3A/state=S7/seed={seed}/manifest_fingerprint={manifest_fingerprint}/run_report.json
  partitioning: [seed, manifest_fingerprint]
  ordering: []
  schema_ref: schemas.layer1.yaml#/run_report/segment_state_run
  lineage:
    produced_by: 3A.S7
    consumed_by: [ops]
    final_in_layer: false
  retention_days: 365
  pii: false
  licence: Proprietary-Internal
