version: '1.0'
$id: schemas.2B.yaml
$schema: https://json-schema.org/draft/2020-12/schema
description: "Layer-1 · Segment 2B (Routing) — schema pack."

# Layer-1 · Segment 2B — Schema Pack
title: "Layer-1 · Segment 2B — Schema Pack"

$defs:
  hex64:
    type: string
    pattern: "^[a-f0-9]{64}$"
  partition_kv:
    type: object
    additionalProperties:
      type: string
    minProperties: 0

# Segment 2B currently relies on 2A/1B authorities for modelling inputs. These
# sections are placeholders to keep the schema aligned with the Layer-1 template.
model: {}

prep: {}

egress: {}

validation:
  s0_gate_receipt_v1:
    type: object
    additionalProperties: false
    required:
      - manifest_fingerprint
      - seed
      - parameter_hash
      - verified_at_utc
      - sealed_inputs
      - catalogue_resolution
      - determinism_receipt
    properties:
      manifest_fingerprint:
        $ref: "#/$defs/hex64"
      seed:
        $ref: "schemas.layer1.yaml#/$defs/uint64"
      parameter_hash:
        $ref: "#/$defs/hex64"
      verified_at_utc:
        $ref: "schemas.layer1.yaml#/$defs/rfc3339_micros"
      sealed_inputs:
        type: array
        items:
          type: object
          additionalProperties: false
          required: [id, partition, schema_ref]
          properties:
            id:
              type: string
              minLength: 1
            partition:
              $ref: "#/$defs/partition_kv"
            schema_ref:
              type: string
              minLength: 1
      catalogue_resolution:
        type: object
        additionalProperties: false
        required: [dictionary_version, registry_version]
        properties:
          dictionary_version:
            type: string
            minLength: 1
          registry_version:
            type: string
            minLength: 1
      determinism_receipt:
        type: object
        additionalProperties: false
        properties:
          engine_commit:
            type: string
          python_version:
            type: string
          platform:
            type: string
          policy_ids:
            type: array
            items: { type: string }
          policy_digests:
            type: array
            items: { $ref: "#/$defs/hex64" }

  sealed_inputs_2B:
    type: array
    items:
      type: object
      additionalProperties: false
      required: [asset_id, version_tag, sha256_hex, path, partition]
      properties:
        asset_id:
          type: string
          minLength: 1
        version_tag:
          type: string
          minLength: 1
        sha256_hex:
          $ref: "#/$defs/hex64"
        path:
          type: string
          minLength: 1
        partition:
          $ref: "#/$defs/partition_kv"
        schema_ref:
          type: string

  validation_bundle_index_2B:
    type: array
    minItems: 1
    items:
      type: object
      additionalProperties: false
      required: [path, sha256_hex]
      properties:
        path:
          type: string
          pattern: "^(?!/)(?!.*\\\\)(?!.*\\.\\.).+"
        sha256_hex:
          $ref: "#/$defs/hex64"

  s7_audit_report_v1:
    type: object
    additionalProperties: false
    required:
      - component
      - manifest_fingerprint
      - seed
      - created_utc
      - catalogue_resolution
      - inputs_digest
      - checks
      - metrics
      - summary
    properties:
      component: { const: "2B.S7" }
      manifest_fingerprint: { $ref: 'schemas.layer1.yaml#/$defs/hex64' }
      seed:        { $ref: 'schemas.layer1.yaml#/$defs/uint64' }
      created_utc: { $ref: 'schemas.layer1.yaml#/$defs/rfc3339_micros' }

      catalogue_resolution:
        type: object
        additionalProperties: false
        required: [dictionary_version, registry_version]
        properties:
          dictionary_version: { type: string, minLength: 1 }
          registry_version:   { type: string, minLength: 1 }

      inputs_digest:
        type: object
        additionalProperties: true

      checks:
        type: array
        minItems: 1
        items:
          type: object
          additionalProperties: false
          required: [id, status, codes]
          properties:
            id:     { type: string, minLength: 1 }
            status: { type: string, enum: [PASS, FAIL, WARN] }
            codes:
              type: array
              minItems: 1
              items: { type: string, minLength: 1 }
            context: { type: object }

      metrics:
        type: object
        additionalProperties: false
        properties:
          merchants_total:            { type: integer, minimum: 0 }
          groups_total:               { type: integer, minimum: 0 }
          days_total:                 { type: integer, minimum: 0 }
          selections_checked:         { type: integer, minimum: 0 }
          draws_expected:             { type: integer, minimum: 0 }
          draws_observed:             { type: integer, minimum: 0 }
          alias_decode_max_abs_delta: { type: number }
          max_abs_mass_error_s4:      { type: number }

      summary:
        type: object
        additionalProperties: false
        required: [overall_status, warn_count, fail_count]
        properties:
          overall_status: { type: string, enum: [PASS, FAIL] }
          warn_count:     { type: integer, minimum: 0 }
          fail_count:     { type: integer, minimum: 0 }

# Policy anchors (captured by S0; shapes intentionally permissive)
policy:
  route_rng_policy_v1:
    type: object
    additionalProperties: false
    required: [policy_id, version_tag, policy_version, rng_engine, streams]
    properties:
      policy_id:   { const: route_rng_policy_v1 }
      version_tag: { type: string, minLength: 1 }
      policy_version: { type: string, minLength: 1, pattern: '^[0-9]+\.[0-9]+\.[0-9]+$' }
      rng_engine:  { const: philox2x64-10 }
      streams:
        type: object
        additionalProperties: false
        required: [routing_selection, routing_edge]
        properties:
          routing_selection:
            type: object
            additionalProperties: false
            required: [rng_stream_id, basis, event_families, draws_per_unit]
            properties:
              rng_stream_id: { type: string, minLength: 1, pattern: '^2B\\.[A-Za-z0-9_.-]+$' }
              basis:
                type: object
                additionalProperties: false
                required: [key_basis, counter_start, counter_step_per_event, counter_wrap_policy]
                properties:
                  key_basis: { const: ["seed", "parameter_hash", "run_id"] }
                  counter_start:
                    type: object
                    additionalProperties: false
                    required: [hi, lo]
                    properties:
                      hi: { $ref: "schemas.layer1.yaml#/$defs/uint64" }
                      lo: { $ref: "schemas.layer1.yaml#/$defs/uint64" }
                  counter_step_per_event: { const: 1 }
                  counter_wrap_policy: { const: abort_on_wrap }
              event_families:
                type: object
                additionalProperties: false
                required: [alias_pick_group, alias_pick_site]
                properties:
                  alias_pick_group:
                    type: object
                    additionalProperties: false
                    required: [substream_label, blocks, draws]
                    properties:
                      substream_label: { const: alias_pick_group }
                      blocks: { const: 1 }
                      draws: { const: "1" }
                  alias_pick_site:
                    type: object
                    additionalProperties: false
                    required: [substream_label, blocks, draws]
                    properties:
                      substream_label: { const: alias_pick_site }
                      blocks: { const: 1 }
                      draws: { const: "1" }
              draws_per_unit:
                type: object
                additionalProperties: false
                required: [draws_per_selection]
                properties:
                  draws_per_selection: { const: 2 }
          routing_edge:
            type: object
            additionalProperties: false
            required: [rng_stream_id, basis, event_families, draws_per_unit]
            properties:
              rng_stream_id: { type: string, minLength: 1, pattern: '^2B\\.[A-Za-z0-9_.-]+$' }
              basis:
                type: object
                additionalProperties: false
                required: [key_basis, counter_start, counter_step_per_event, counter_wrap_policy]
                properties:
                  key_basis: { const: ["seed", "parameter_hash", "run_id"] }
                  counter_start:
                    type: object
                    additionalProperties: false
                    required: [hi, lo]
                    properties:
                      hi: { $ref: "schemas.layer1.yaml#/$defs/uint64" }
                      lo: { $ref: "schemas.layer1.yaml#/$defs/uint64" }
                  counter_step_per_event: { const: 1 }
                  counter_wrap_policy: { const: abort_on_wrap }
              event_families:
                type: object
                additionalProperties: false
                required: [cdn_edge_pick]
                properties:
                  cdn_edge_pick:
                    type: object
                    additionalProperties: false
                    required: [substream_label, blocks, draws]
                    properties:
                      substream_label: { const: cdn_edge_pick }
                      blocks: { const: 1 }
                      draws: { const: "1" }
              draws_per_unit:
                type: object
                additionalProperties: false
                required: [draws_per_virtual]
                properties:
                  draws_per_virtual: { const: 1 }
      extensions:
        type: object
        additionalProperties: true

  alias_layout_policy_v1:
    type: object
    additionalProperties: false
    required:
      - policy_id
      - version_tag
      - policy_version
      - layout_version
      - endianness
      - alignment_bytes
      - padding_rule
      - quantised_bits
      - normalisation_epsilon
      - quantisation_epsilon
      - weight_source
      - floor_spec
      - fallback
      - required_s1_provenance
      - encode_spec
      - decode_law
      - record_layout
      - checksum
      - blob_digest
      - required_index_fields
    properties:
      policy_id:   { const: alias_layout_policy_v1 }
      version_tag: { type: string, minLength: 1 }
      policy_version: { type: string, minLength: 1, pattern: '^[0-9]+\.[0-9]+\.[0-9]+$' }
      layout_version: { type: string, minLength: 1 }
      endianness: { type: string, enum: [little, big] }
      alignment_bytes: { type: integer, minimum: 1 }
      padding_rule:
        type: object
        additionalProperties: false
        required: [pad_byte_hex]
        properties:
          pad_byte_hex: { type: string, pattern: "^[A-Fa-f0-9]{2}$" }
          pad_included_in_slice_length: { type: boolean }
      quantised_bits: { type: integer, minimum: 1 }
      normalisation_epsilon: { type: number, exclusiveMinimum: 0.0 }
      quantisation_epsilon: { type: number, exclusiveMinimum: 0.0 }
      weight_source:
        type: object
        additionalProperties: true
      floor_spec:
        type: object
        additionalProperties: true
      cap_spec:
        type: object
        additionalProperties: true
      fallback:
        type: object
        additionalProperties: true
      tiny_negative_epsilon:
        type: number
        minimum: 0.0
      required_s1_provenance:
        type: object
        additionalProperties: true
      encode_spec:
        type: object
        additionalProperties: true
      decode_law: { type: string, minLength: 1 }
      record_layout:
        type: object
        additionalProperties: true
        required: [prob_qbits]
        properties:
          prob_qbits: { type: integer, minimum: 1 }
      checksum:
        type: object
        additionalProperties: false
        required: [algorithm, scope, encoding]
        properties:
          algorithm: { type: string, minLength: 1 }
          scope: { type: string, minLength: 1 }
          encoding: { type: string, minLength: 1 }
      blob_digest:
        type: object
        additionalProperties: false
        required: [algorithm, scope, encoding]
        properties:
          algorithm: { type: string, minLength: 1 }
          scope: { type: string, minLength: 1 }
          encoding: { type: string, minLength: 1 }
      required_index_fields:
        type: object
        additionalProperties: false
        required: [header, merchant_row]
        properties:
          header:
            type: array
            minItems: 1
            items: { type: string, minLength: 1 }
          merchant_row:
            type: array
            minItems: 1
            items: { type: string, minLength: 1 }
      notes:
        type: string
      extensions:
        type: object
        additionalProperties: true

  day_effect_policy_v1:
    type: object
    additionalProperties: false
    required:
      - policy_id
      - version_tag
      - policy_version
      - rng_engine
      - rng_stream_id
      - draws_per_row
      - sigma_gamma
      - day_range
      - rng_derivation
      - record_fields
      - created_utc_policy_echo
      - sha256_hex
    properties:
      policy_id:   { const: day_effect_policy_v1 }
      version_tag: { type: string, minLength: 1 }
      policy_version: { type: string, minLength: 1, pattern: '^[0-9]+\.[0-9]+\.[0-9]+$' }
      rng_engine:  { const: philox2x64-10 }
      rng_stream_id: { type: string, minLength: 1, pattern: '^2B\.[A-Za-z0-9_.-]+$' }
      draws_per_row: { const: 1 }
      sigma_gamma: { type: number, exclusiveMinimum: 0.0 }
      day_range:
        type: object
        additionalProperties: false
        required: [start_day, end_day]
        properties:
          start_day: { type: string, format: date }
          end_day: { type: string, format: date }
      rng_derivation:
        type: object
        additionalProperties: false
        required:
          - domain_master
          - domain_stream
          - low64_rule
          - counter_split_rule
          - key_basis
          - base_counter_basis
        properties:
          domain_master: { type: string, minLength: 1 }
          domain_stream: { type: string, minLength: 1 }
          low64_rule: { const: LE64_tail_bytes_24_31 }
          counter_split_rule: { const: BE64_bytes_16_23_and_24_31 }
          key_basis: { const: ["manifest_fingerprint_bytes", "seed_u64", "rng_stream_id"] }
          base_counter_basis: { const: ["manifest_fingerprint_bytes", "seed_u64", "rng_stream_id"] }
      record_fields:
        type: array
        minItems: 1
        items: { type: string, minLength: 1 }
      created_utc_policy_echo: { type: boolean }
      extensions:
        type: object
        additionalProperties: true
      sha256_hex: { $ref: "#/$defs/hex64" }
  virtual_edge_policy_v1:
    type: object
    additionalProperties: false
    required: [policy_id, version_tag, policy_version, edges]
    properties:
      policy_id:   { const: virtual_edge_policy_v1 }
      version_tag: { type: string, minLength: 1 }
      policy_version: { type: string, minLength: 1, pattern: '^[0-9]+\.[0-9]+\.[0-9]+$' }
      edges:
        type: array
        minItems: 1
        items:
          type: object
          additionalProperties: false
          required: [edge_id, ip_country, edge_lat, edge_lon]
          oneOf:
            - required: [weight]
            - required: [country_weights]
          properties:
            edge_id:     { type: string, minLength: 1 }
            ip_country:  { $ref: 'schemas.layer1.yaml#/$defs/iso2' }
            edge_lat:    { type: number, minimum: -90, maximum: 90 }
            edge_lon:    { type: number, exclusiveMinimum: -180, maximum: 180 }
            weight:      { type: number, exclusiveMinimum: 0 }
            country_weights:
              type: object
              additionalProperties: { type: number, minimum: 0 }
              minProperties: 1
      notes:       { type: string }

# ── Plan (downstream states) ─────────────────────────────────────────────
plan:

  s1_site_weights:
    type: table
    description: "Per-merchant per-site frozen probability law (RNG-free)."
    primary_key: [merchant_id, legal_country_iso, site_order]
    partition_keys: [seed, manifest_fingerprint]
    sort_keys: [merchant_id, legal_country_iso, site_order]
    columns_strict: true
    columns:
      - { name: merchant_id,        $ref: 'schemas.layer1.yaml#/$defs/id64',            nullable: false }
      - { name: legal_country_iso,  $ref: 'schemas.layer1.yaml#/$defs/iso2',            nullable: false }
      - { name: site_order,         type: integer, minimum: 1,                          nullable: false }
      - { name: p_weight,           type: number,  minimum: 0.0, maximum: 1.0,          nullable: false,
          description: "Normalised weight; Σ per-merchant = 1 within policy ε." }
      - { name: weight_source,      type: string,  minLength: 1,                         nullable: false,
          description: "Policy-declared source/transform used for weights." }
      - { name: quantised_bits,     type: integer, minimum: 1,                           nullable: false,
          description: "Bit-depth b used by S2 alias construction." }
      - { name: floor_applied,      type: boolean,                                       nullable: false,
          description: "True if a floor or zero-mass fallback affected this row." }
      - { name: created_utc,        $ref: 'schemas.layer1.yaml#/$defs/rfc3339_micros',   nullable: false,
          description: "Echo of S0 verified_at_utc for this manifest_fingerprint." }


  s2_alias_index:
    type: object
    description: "Directory for alias blob plus per-merchant slices."
    additionalProperties: false
    required:
      - layout_version
      - endianness
      - alignment_bytes
      - quantised_bits
      - created_utc
      - policy_id
      - policy_digest
      - blob_sha256
      - blob_size_bytes
      - merchants_count
      - merchants
    properties:
      layout_version:   { type: string, minLength: 1 }
      endianness:       { type: string, enum: [little, big] }
      alignment_bytes:  { type: integer, minimum: 1 }
      quantised_bits:   { type: integer, minimum: 1 }
      created_utc:      { $ref: 'schemas.layer1.yaml#/$defs/rfc3339_micros' }
      policy_id:        { type: string, const: "alias_layout_policy_v1" }
      policy_digest:    { $ref: "#/$defs/hex64" }
      blob_sha256:      { $ref: "#/$defs/hex64" }
      blob_size_bytes:  { type: integer, minimum: 0 }
      merchants_count:  { type: integer, minimum: 0 }
      merchants:
        type: array
        items:
          type: object
          additionalProperties: false
          required: [merchant_id, offset, length, sites, quantised_bits, checksum]
          properties:
            merchant_id:    { $ref: 'schemas.layer1.yaml#/$defs/id64' }
            offset:         { type: integer, minimum: 0 }
            length:         { type: integer, minimum: 1 }
            sites:          { type: integer, minimum: 1 }
            quantised_bits: { type: integer, minimum: 1 }
            checksum:       { type: string, pattern: '^[A-Fa-f0-9]+$' }

  s3_day_effects:
    type: table
    description: "Per-merchant × per-UTC-day × per-tz-group gamma multipliers (log-normal; Philox provenance)."
    primary_key: [merchant_id, utc_day, tz_group_id]
    partition_keys: [seed, manifest_fingerprint]
    sort_keys: [merchant_id, utc_day, tz_group_id]
    columns_strict: true
    columns:
      - { name: merchant_id,        $ref: 'schemas.layer1.yaml#/$defs/id64',            nullable: false }
      - { name: utc_day,            type: string, format: date,                         nullable: false }
      - { name: tz_group_id,        type: string,  minLength: 1,                        nullable: false }
      - { name: gamma,              type: number,  exclusiveMinimum: 0.0,               nullable: false }
      - { name: log_gamma,          type: number,                                       nullable: false }
      - { name: sigma_gamma,        type: number,  exclusiveMinimum: 0.0,               nullable: false }
      - { name: rng_stream_id,      type: string,  minLength: 1,                        nullable: false }
      - { name: rng_counter_lo,     type: integer, minimum: 0, maximum: 18446744073709551615, nullable: false }
      - { name: rng_counter_hi,     type: integer, minimum: 0, maximum: 18446744073709551615, nullable: false }
      - { name: created_utc,        $ref: 'schemas.layer1.yaml#/$defs/rfc3339_micros',  nullable: false }
  s4_group_weights:
    type: table
    description: "Per-merchant × per-UTC-day × per-tz-group day-specific routing mix (RNG-free)."
    primary_key: [merchant_id, utc_day, tz_group_id]
    partition_keys: [seed, manifest_fingerprint]
    sort_keys: [merchant_id, utc_day, tz_group_id]
    columns_strict: true
    columns:
      - { name: merchant_id,  $ref: 'schemas.layer1.yaml#/$defs/id64',           nullable: false }
      - { name: utc_day,      type: string, format: date,                        nullable: false }
      - { name: tz_group_id,  type: string, minLength: 1,                        nullable: false }
      - { name: p_group,      type: number, minimum: 0.0, maximum: 1.0,          nullable: false }
      - { name: base_share,   type: number, minimum: 0.0, maximum: 1.0,          nullable: false }
      - { name: gamma,        type: number, exclusiveMinimum: 0.0,               nullable: false }
      - { name: created_utc,  $ref: 'schemas.layer1.yaml#/$defs/rfc3339_micros', nullable: false }
      - { name: mass_raw,     type: number, minimum: 0.0,                        nullable: true }
      - { name: denom_raw,    type: number, minimum: 0.0,                        nullable: true }

binary:
  s2_alias_blob:
    type: object
    description: "Binary contract for contiguous alias tables blob."
    additionalProperties: false
    required: [layout_version, endianness, alignment_bytes]
    properties:
      layout_version:  { type: string, minLength: 1 }
      endianness:      { type: string, enum: [little, big] }
      alignment_bytes: { type: integer, minimum: 1 }

trace:
  s5_arrival_roster_row:
    type: object
    additionalProperties: false
    required:
      - merchant_id
      - utc_timestamp
      - utc_day
    properties:
      merchant_id:   { $ref: 'schemas.layer1.yaml#/$defs/id64' }
      utc_timestamp: { $ref: 'schemas.layer1.yaml#/$defs/rfc3339_micros' }
      utc_day:       { type: string, format: date }
  s5_selection_log_row:
    type: object
    additionalProperties: false
    required:
      - merchant_id
      - utc_timestamp
      - utc_day
      - tz_group_id
      - site_id
      - rng_stream_id
      - ctr_group_hi
      - ctr_group_lo
      - ctr_site_hi
      - ctr_site_lo
      - manifest_fingerprint
      - created_utc
    properties:
      merchant_id:          { $ref: 'schemas.layer1.yaml#/$defs/id64' }
      utc_timestamp:        { $ref: 'schemas.layer1.yaml#/$defs/rfc3339_micros' }
      utc_day:              { type: string, format: date }
      tz_group_id:          { $ref: 'schemas.layer1.yaml#/$defs/iana_tzid' }
      site_id:              { $ref: 'schemas.layer1.yaml#/$defs/id64' }
      rng_stream_id:        { type: string, minLength: 1 }
      ctr_group_hi:         { $ref: 'schemas.layer1.yaml#/$defs/uint64' }
      ctr_group_lo:         { $ref: 'schemas.layer1.yaml#/$defs/uint64' }
      ctr_site_hi:          { $ref: 'schemas.layer1.yaml#/$defs/uint64' }
      ctr_site_lo:          { $ref: 'schemas.layer1.yaml#/$defs/uint64' }
      manifest_fingerprint: { $ref: '#/$defs/hex64' }
      created_utc:          { $ref: 'schemas.layer1.yaml#/$defs/rfc3339_micros' }
  s6_edge_log_row:
    type: object
    additionalProperties: false
    required:
      - merchant_id
      - is_virtual
      - utc_timestamp
      - utc_day
      - tz_group_id
      - site_id
      - edge_id
      - ip_country
      - edge_lat
      - edge_lon
      - rng_stream_id
      - ctr_edge_hi
      - ctr_edge_lo
      - manifest_fingerprint
      - created_utc
    properties:
      merchant_id:          { $ref: 'schemas.layer1.yaml#/$defs/id64' }
      is_virtual:           { type: boolean }
      utc_timestamp:        { $ref: 'schemas.layer1.yaml#/$defs/rfc3339_micros' }
      utc_day:              { type: string, format: date }
      tz_group_id:          { $ref: 'schemas.layer1.yaml#/$defs/iana_tzid' }
      site_id:              { $ref: 'schemas.layer1.yaml#/$defs/id64' }
      edge_id:              { type: string, minLength: 1 }
      ip_country:           { $ref: 'schemas.layer1.yaml#/$defs/iso2' }
      edge_lat:             { type: number, minimum: -90, maximum: 90 }
      edge_lon:             { type: number, exclusiveMinimum: -180, maximum: 180 }
      rng_stream_id:        { type: string, minLength: 1 }
      ctr_edge_hi:          { $ref: 'schemas.layer1.yaml#/$defs/uint64' }
      ctr_edge_lo:          { $ref: 'schemas.layer1.yaml#/$defs/uint64' }
      manifest_fingerprint: { $ref: '#/$defs/hex64' }
      created_utc:          { $ref: 'schemas.layer1.yaml#/$defs/rfc3339_micros' }
