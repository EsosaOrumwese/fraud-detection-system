# Layer-1 · Segment 2B — Artefact Registry
version: "v1.0.0"

subsegments:
  - id: "2B"
    name: "Routing: traffic to sites and edges"
    artifacts:
      # === 2B.S0 outputs ===
      - name: s0_gate_receipt_2B
        path: data/layer1/2B/s0_gate_receipt_2B/manifest_fingerprint={manifest_fingerprint}/s0_gate_receipt_2B.json
        type: dataset
        category: validation
        semver: '{semver}'
        version: '{manifest_fingerprint}'
        digest: '{sha256}'
        manifest_key: mlr.2B.validation.s0_gate_receipt
        license: Proprietary-Internal
        role: "Gate receipt attesting upstream verification, identity, and catalogue-only resolution."
        source: internal
        owner: { owner_team: "l1-2b-core" }
        last_updated: '{iso8601_timestamp}'
        environment: [runtime]
        schema: schemas.2B.yaml#/validation/s0_gate_receipt_v1
        dependencies:
          - validation_bundle_1B
          - validation_passed_flag_1B
          - site_locations
          - site_timezones
          - route_rng_policy_v1
          - alias_layout_policy_v1
          - day_effect_policy_v1
          - virtual_edge_policy_v1
        cross_layer: false
        notes: null

      - name: sealed_inputs_v1
        path: data/layer1/2B/sealed_inputs_v1/manifest_fingerprint={manifest_fingerprint}/sealed_inputs_v1.json
        type: dataset
        category: validation
        semver: '{semver}'
        version: '{manifest_fingerprint}'
        digest: '{sha256}'
        manifest_key: mlr.2B.validation.sealed_inputs_v1
        license: Proprietary-Internal
        role: "Authoritative list of all assets sealed by 2B.S0 (IDs, tags, digests, paths, partitions)."
        source: internal
        owner: { owner_team: "l1-2b-core" }
        last_updated: '{iso8601_timestamp}'
        environment: [runtime]
        schema: schemas.2B.yaml#/validation/sealed_inputs_v1
        dependencies:
          - validation_bundle_1B
          - validation_passed_flag_1B
          - site_locations
          - site_timezones
          - route_rng_policy_v1
          - alias_layout_policy_v1
          - day_effect_policy_v1
          - virtual_edge_policy_v1
        cross_layer: false
        notes: null

      # === Upstream gate (1B) ===
      - name: validation_bundle_1B
        path: data/layer1/1B/validation/manifest_fingerprint={manifest_fingerprint}/
        type: bundle
        category: validation
        semver: '{semver}'
        version: '{manifest_fingerprint}'
        digest: '{sha256}'
        manifest_key: mlr.1B.validation.bundle
        license: Proprietary-Internal
        role: "Fingerprint-scoped PASS bundle for 1B; 2B.S0 recomputes hash before any read (No PASS → No read)."
        dependencies: []
        notes: "Hashing law: ASCII-lex order of index.path; hash raw bytes; flag excluded."
        cross_layer: true
        source: internal
        owner: { owner_team: "mlr-1b-validation" }
        last_updated: '{iso8601_timestamp}'
        environment: [runtime]
        schema:
          index_schema_ref: schemas.layer1.yaml#/validation/validation_bundle/index_schema

      - name: validation_passed_flag_1B
        path: data/layer1/1B/validation/manifest_fingerprint={manifest_fingerprint}/_passed.flag
        type: file
        category: validation
        semver: '{semver}'
        version: '{manifest_fingerprint}'
        digest: '{sha256_of_bundle}'
        manifest_key: mlr.1B.validation.passed
        license: Proprietary-Internal
        role: "Companion flag carrying bundle digest (sha256_hex = <hex64>)."
        dependencies: [validation_bundle_1B]
        cross_layer: true
        source: internal
        owner: { owner_team: "mlr-1b-validation" }
        last_updated: '{iso8601_timestamp}'
        environment: [runtime]
        schema: schemas.1B.yaml#/validation/passed_flag
        notes: null

      - name: site_locations
        path: data/layer1/1B/site_locations/seed={seed}/manifest_fingerprint={manifest_fingerprint}/
        type: dataset
        category: output
        semver: '{semver}'
        version: '{seed}.{manifest_fingerprint}'
        digest: '{sha256}'
        manifest_key: mlr.1B.egress.site_locations
        license: Proprietary-Internal
        role: "Per-site lon/lat from 1B; consumed by 2B."
        dependencies: [s7_site_synthesis]
        cross_layer: true
        source: internal
        owner: { owner_team: "mlr-1b-core" }
        last_updated: '{iso8601_timestamp}'
        environment: [runtime]
        schema: schemas.1B.yaml#/egress/site_locations
        notes: null

      # === Required pins from 2A (read-only; required for 2B v1) ===
      - name: site_timezones
        path: data/layer1/2A/site_timezones/seed={seed}/manifest_fingerprint={manifest_fingerprint}/
        type: dataset
        category: output
        semver: '{semver}'
        version: '{seed}.{manifest_fingerprint}'
        digest: '{sha256}'
        manifest_key: mlr.2A.egress.site_timezones
        license: Proprietary-Internal
        role: "Per-site tzid (2A egress); REQUIRED input for 2B v1 tz-grouping + day-effects."
        dependencies: []
        cross_layer: true
        source: internal
        owner: { owner_team: "l1-2a-core" }
        last_updated: '{iso8601_timestamp}'
        environment: [runtime]
        schema: schemas.2A.yaml#/egress/site_timezones
        notes: null

      # === Optional cache from 2A (read-only) ===
      - name: tz_timetable_cache
        path: data/layer1/2A/tz_timetable_cache/manifest_fingerprint={manifest_fingerprint}/
        type: bundle
        category: cache
        semver: '{semver}'
        version: '{manifest_fingerprint}'
        digest: '{sha256}'
        manifest_key: mlr.2A.cache.tz_timetable
        license: Proprietary-Internal
        role: "Pinned IANA tz transitions cache (2A S3); optional coherence pin."
        dependencies: []
        cross_layer: true
        source: internal
        owner: { owner_team: "l1-2a-core" }
        last_updated: '{iso8601_timestamp}'
        environment: [runtime]
        schema: schemas.2A.yaml#/cache/tz_timetable_cache
        notes: null

      # === 2B policy packs captured by S0 ===
      - name: route_rng_policy_v1
        path: config/layer1/2B/policy/route_rng_policy_v1.json
        type: policy
        category: config
        semver: '{semver}'
        version: '{policy_version}'
        digest: '{sha256}'
        manifest_key: mlr.2B.policy.route_rng_v1
        license: Proprietary-Internal
        role: "Philox sub-stream layout & budgets for routing states."
        dependencies: []
        source: internal
        owner: { owner_team: "l1-2b-governance" }
        last_updated: '{iso8601_timestamp}'
        environment: [runtime]
        schema: schemas.2B.yaml#/policy/route_rng_policy_v1
        cross_layer: false
        notes: null

      - name: alias_layout_policy_v1
        path: config/layer1/2B/policy/alias_layout_policy_v1.json
        type: policy
        category: config
        semver: '{semver}'
        version: '{policy_version}'
        digest: '{sha256}'
        manifest_key: mlr.2B.policy.alias_layout_v1
        license: Proprietary-Internal
        role: "Alias table byte layout, endianness & alignment."
        dependencies: []
        source: internal
        owner: { owner_team: "l1-2b-governance" }
        last_updated: '{iso8601_timestamp}'
        environment: [runtime]
        schema: schemas.2B.yaml#/policy/alias_layout_policy_v1
        cross_layer: false
        notes: null

      - name: day_effect_policy_v1
        path: config/layer1/2B/policy/day_effect_policy_v1.json
        type: policy
        category: config
        semver: '{semver}'
        version: '{policy_version}'
        digest: '{sha256}'
        manifest_key: mlr.2B.policy.day_effect_v1
        license: Proprietary-Internal
        role: "Daily modulation cadence/variance/clipping for S3."
        dependencies: []
        source: internal
        owner: { owner_team: "l1-2b-governance" }
        last_updated: '{iso8601_timestamp}'
        environment: [runtime]
        schema: schemas.2B.yaml#/policy/day_effect_policy_v1
        cross_layer: false
        notes: null

      # === 2B policies (token-less; S0-sealed) ===
      - name: virtual_edge_policy_v1
        path: config/layer1/2B/policy/virtual_edge_policy_v1.json
        type: policy
        category: config
        semver: '{semver}'
        version: '{policy_version}'
        digest: '{sha256}'
        manifest_key: mlr.2B.policy.virtual_edge_v1
        license: Proprietary-Internal
        role: "Sealed virtual-edge catalogue: edges, weights/country-weights, attributes."
        dependencies: []
        source: internal
        owner: { owner_team: "l1-2b-governance" }
        last_updated: '{iso8601_timestamp}'
        environment: [runtime]
        schema: schemas.2B.yaml#/policy/virtual_edge_policy_v1
        cross_layer: false
        notes: null

      # === 2B.S1 output ===
      - name: s1_site_weights
        path: data/layer1/2B/s1_site_weights/seed={seed}/manifest_fingerprint={manifest_fingerprint}/
        type: dataset
        category: plan
        semver: '{semver}'
        version: '{seed}.{manifest_fingerprint}'
        digest: '{sha256}'
        manifest_key: mlr.2B.s1.site_weights
        license: Proprietary-Internal
        role: "Frozen per-site probability law used by alias construction and routing."
        source: internal
        owner: { owner_team: "l1-2b-core" }
        last_updated: '{iso8601_timestamp}'
        environment: [runtime]
        schema: schemas.2B.yaml#/plan/s1_site_weights
        dependencies:
          - site_locations
          - alias_layout_policy_v1
        cross_layer: false
        notes: |
          Writer sort: [merchant_id, legal_country_iso, site_order]; write-once; atomic publish.

      # === 2B.S2 outputs ===
      - name: s2_alias_index
        path: data/layer1/2B/s2_alias_index/seed={seed}/manifest_fingerprint={manifest_fingerprint}/index.json
        type: dataset
        category: plan
        semver: '{semver}'
        version: '{seed}.{manifest_fingerprint}'
        digest: '{sha256}'
        manifest_key: mlr.2B.s2.alias_index
        license: Proprietary-Internal
        role: "Alias index: directory for alias blob slices; decode invariants and blob digest."
        source: internal
        owner: { owner_team: "l1-2b-core" }
        last_updated: '{iso8601_timestamp}'
        environment: [runtime]
        schema: schemas.2B.yaml#/plan/s2_alias_index
        dependencies:
          - s1_site_weights
          - alias_layout_policy_v1
          - s2_alias_blob
        cross_layer: false
        notes: null

      - name: s2_alias_blob
        path: data/layer1/2B/s2_alias_blob/seed={seed}/manifest_fingerprint={manifest_fingerprint}/alias.bin
        type: dataset
        category: plan
        semver: '{semver}'
        version: '{seed}.{manifest_fingerprint}'
        digest: '{sha256}'
        manifest_key: mlr.2B.s2.alias_blob
        license: Proprietary-Internal
        role: "Contiguous binary blob containing per-merchant alias tables."
        source: internal
        owner: { owner_team: "l1-2b-core" }
        last_updated: '{iso8601_timestamp}'
        environment: [runtime]
        schema: schemas.2B.yaml#/binary/s2_alias_blob
        dependencies:
          - s1_site_weights
          - alias_layout_policy_v1
        cross_layer: false
        notes: null

      # === 2B.S3 output ===
      - name: s3_day_effects
        path: data/layer1/2B/s3_day_effects/seed={seed}/manifest_fingerprint={manifest_fingerprint}/
        type: dataset
        category: plan
        semver: '{semver}'
        version: '{seed}.{manifest_fingerprint}'
        digest: '{sha256}'
        manifest_key: mlr.2B.s3.day_effects
        license: Proprietary-Internal
        role: "Per-merchant × per-UTC-day × per-tz-group gamma multipliers for day-scale co-movement."
        source: internal
        owner: { owner_team: "l1-2b-core" }
        last_updated: '{iso8601_timestamp}'
        environment: [runtime]
        schema: schemas.2B.yaml#/plan/s3_day_effects
        dependencies:
          - s1_site_weights
          - site_timezones
          - day_effect_policy_v1
        cross_layer: false
        notes: "Writer order: [merchant_id, utc_day, tz_group_id]; write-once; atomic publish."
        
      # === 2B.S4 output ===
      - name: s4_group_weights
        path: data/layer1/2B/s4_group_weights/seed={seed}/manifest_fingerprint={manifest_fingerprint}/
        type: dataset
        category: plan
        semver: '{semver}'
        version: '{seed}.{manifest_fingerprint}'
        digest: '{sha256}'
        manifest_key: mlr.2B.s4.group_weights
        license: Proprietary-Internal
        role: "Per-merchant × per-UTC-day × per-tz-group day mix; used to pick tz-group before static site alias."
        source: internal
        owner: { owner_team: "l1-2b-core" }
        last_updated: '{iso8601_timestamp}'
        environment: [runtime]
        schema: schemas.2B.yaml#/plan/s4_group_weights
        dependencies:
          - s1_site_weights
          - site_timezones
          - s3_day_effects
        cross_layer: false
        notes: "Writer order: [merchant_id, utc_day, tz_group_id]; write-once; atomic publish."

      # === 2B.S6 (optional) edge selection log ===
      - name: s6_edge_log
        path: logs/layer1/2B/edge/seed={seed}/parameter_hash={parameter_hash}/run_id={run_id}/utc_day={utc_day}/s6_edge_log.jsonl
        type: dataset
        category: diagnostic
        semver: '{semver}'
        version: '{seed}.{parameter_hash}.{run_id}'
        digest: '{sha256}'
        manifest_key: mlr.2B.trace.s6_edge_log
        license: Proprietary-Internal
        role: "Per-arrival virtual-edge selections (diagnostic); run-scoped lineage."
        dependencies: [virtual_edge_policy_v1]
        source: internal
        owner: { owner_team: "l1-2b-core" }
        last_updated: '{iso8601_timestamp}'
        environment: [runtime]
        schema: schemas.2B.yaml#/trace/s6_edge_log_row
        cross_layer: false
        notes: "Write-once; atomic publish per run; partitions: [seed, parameter_hash, run_id, utc_day]."

      # === 2B RNG logs (run-scoped) ===
      - name: rng_audit_log
        path: logs/layer1/2B/rng/audit/seed={seed}/parameter_hash={parameter_hash}/run_id={run_id}/rng_audit_log.jsonl
        type: log
        category: rng_core
        semver: '{semver}'
        version: '{run_id}'
        digest: '{sha256}'
        manifest_key: mlr.rng.core.2B.audit
        license: Proprietary-Internal
        role: "Run-scoped audit envelope for Segment 2B RNG usage (seed, parameters, build metadata)."
        dependencies: [route_rng_policy_v1]
        source: internal
        owner: { owner_team: "l1-2b-core" }
        last_updated: '{iso8601_timestamp}'
        environment: [runtime]
        schema: schemas.layer1.yaml#/rng/core/rng_audit_log
        cross_layer: false
        notes: null

      - name: rng_trace_log
        path: logs/layer1/2B/rng/trace/seed={seed}/parameter_hash={parameter_hash}/run_id={run_id}/rng_trace_log.jsonl
        type: log
        category: rng_core
        semver: '{semver}'
        version: '{run_id}'
        digest: '{sha256}'
        manifest_key: mlr.rng.core.2B.trace
        license: Proprietary-Internal
        role: "Cumulative RNG trace for Segment 2B substreams; append exactly one row after each event."
        dependencies: [route_rng_policy_v1, rng_audit_log]
        source: internal
        owner: { owner_team: "l1-2b-core" }
        last_updated: '{iso8601_timestamp}'
        environment: [runtime]
        schema: schemas.layer1.yaml#/rng/core/rng_trace_log
        cross_layer: false
        notes: null

      # === 2B RNG event families (run-scoped) ===
      - name: rng_event_alias_pick_group
        path: logs/layer1/2B/rng/events/alias_pick_group/seed={seed}/parameter_hash={parameter_hash}/run_id={run_id}/part-*.jsonl
        type: log
        category: rng_event
        semver: '{semver}'
        version: '{run_id}'
        digest: '{sha256}'
        manifest_key: mlr.rng.events.2B.alias_pick_group
        license: Proprietary-Internal
        role: "RNG envelope events for S5 alias_pick_group (one per selection; blocks=1, draws=1)."
        dependencies: [route_rng_policy_v1]
        source: internal
        owner: { owner_team: "l1-2b-core" }
        last_updated: '{iso8601_timestamp}'
        environment: [runtime]
        schema: schemas.layer1.yaml#/rng/events/alias_pick_group
        cross_layer: false
        notes: null

      - name: rng_event_alias_pick_site
        path: logs/layer1/2B/rng/events/alias_pick_site/seed={seed}/parameter_hash={parameter_hash}/run_id={run_id}/part-*.jsonl
        type: log
        category: rng_event
        semver: '{semver}'
        version: '{run_id}'
        digest: '{sha256}'
        manifest_key: mlr.rng.events.2B.alias_pick_site
        license: Proprietary-Internal
        role: "RNG envelope events for S5 alias_pick_site (one per selection; blocks=1, draws=1)."
        dependencies: [route_rng_policy_v1]
        source: internal
        owner: { owner_team: "l1-2b-core" }
        last_updated: '{iso8601_timestamp}'
        environment: [runtime]
        schema: schemas.layer1.yaml#/rng/events/alias_pick_site
        cross_layer: false
        notes: null

      - name: rng_event_cdn_edge_pick
        path: logs/layer1/2B/rng/events/cdn_edge_pick/seed={seed}/parameter_hash={parameter_hash}/run_id={run_id}/part-*.jsonl
        type: log
        category: rng_event
        semver: '{semver}'
        version: '{run_id}'
        digest: '{sha256}'
        manifest_key: mlr.rng.events.2B.cdn_edge_pick
        license: Proprietary-Internal
        role: "RNG envelope events for S6 cdn_edge_pick (one per virtual arrival; blocks=1, draws=1)."
        dependencies: [route_rng_policy_v1]
        source: internal
        owner: { owner_team: "l1-2b-core" }
        last_updated: '{iso8601_timestamp}'
        environment: [runtime]
        schema: schemas.layer1.yaml#/rng/events/cdn_edge_pick
        cross_layer: false
        notes: null

      - name: s7_audit_report
        path: data/layer1/2B/s7_audit_report/seed={seed}/manifest_fingerprint={manifest_fingerprint}/s7_audit_report.json
        type: dataset
        category: validation
        semver: '{semver}'
        version: '{seed}.{manifest_fingerprint}'
        digest: '{sha256}'
        manifest_key: mlr.2B.validation.s7_audit_report
        license: Proprietary-Internal
        role: "Authoritative 2B.S7 audit report (RNG-free; fields-strict JSON)."
        dependencies: [s1_site_weights]
        source: internal
        owner: { owner_team: "l1-2b-governance" }
        last_updated: '{iso8601_timestamp}'
        environment: [runtime]
        schema: schemas.2B.yaml#/validation/s7_audit_report_v1
        cross_layer: false
        notes: "Write-once; atomic publish. May reference optional evidence logs (s5_selection_log, s6_edge_log) if present; absence must not prevent S7."

      # === 2B.S5 (optional) selection log ===
      - name: s5_selection_log
        path: data/layer1/2B/s5_selection_log/seed={seed}/parameter_hash={parameter_hash}/run_id={run_id}/utc_day={utc_day}/selection_log.jsonl
        type: dataset
        category: diagnostic
        semver: '{semver}'
        version: '{seed}.{parameter_hash}.{run_id}'
        digest: '{sha256}'
        manifest_key: mlr.2B.trace.s5_selection_log
        license: Proprietary-Internal
        role: "Optional per-arrival trace for routing selections; arrival-ordered."
        source: internal
        owner: { owner_team: "l1-2b-core" }
        last_updated: '{iso8601_timestamp}'
        environment: [runtime]
        schema: schemas.2B.yaml#/trace/s5_selection_log_row
        dependencies:
          - s4_group_weights
          - s2_alias_index
          - s2_alias_blob
          - site_timezones
        cross_layer: false
        notes: "Partitions: [seed, parameter_hash, run_id, utc_day]; writer order = arrival order; write-once; atomic publish."

      # === 2B.S8 — Validation bundle (authoritative) ===
      - name: validation_bundle_2B
        path: data/layer1/2B/validation/manifest_fingerprint={manifest_fingerprint}/index.json
        type: dataset
        category: validation
        semver: '{semver}'
        version: '{manifest_fingerprint}'
        digest: '{sha256}'
        manifest_key: mlr.2B.validation.bundle
        license: Proprietary-Internal
        role: "2B PASS bundle index (fields-strict; relative paths; ASCII-lex)."
        dependencies: [s0_gate_receipt_2B, sealed_inputs_v1, s7_audit_report]
        source: internal
        owner: { owner_team: "l1-2b-governance" }
        last_updated: '{iso8601_timestamp}'
        environment: [runtime]
        schema: schemas.layer1.yaml#/validation/validation_bundle/index_schema
        cross_layer: true
        notes: "Write-once; atomic publish; hashing law matches 1A bundle contract."

      - name: validation_passed_flag_2B
        path: data/layer1/2B/validation/manifest_fingerprint={manifest_fingerprint}/_passed.flag
        type: file
        category: validation
        semver: '{semver}'
        version: '{manifest_fingerprint}'
        digest: '{sha256_of_bundle}'
        manifest_key: mlr.2B.validation.passed
        license: Proprietary-Internal
        role: "PASS gate flag: sha256_hex of concatenated indexed bytes (flag excluded)."
        dependencies: [validation_bundle_2B]
        source: internal
        owner: { owner_team: "l1-2b-governance" }
        last_updated: '{iso8601_timestamp}'
        environment: [runtime]
        schema: schemas.1B.yaml#/validation/passed_flag
        cross_layer: true
        notes: null
