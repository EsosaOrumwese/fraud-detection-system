$schema: "https://json-schema.org/draft/2020-12/schema"
$id: schemas.5A.yaml
$comment: "Layer-2 Â· Segment 5A schema pack. JSON-Schema is the shape authority for 5A datasets."
version: '1.0.0'

$defs:
  hex64:
    $ref: 'schemas.layer1.yaml#/$defs/hex64'
  id64:
    $ref: 'schemas.layer1.yaml#/$defs/id64'
  iso2:
    $ref: 'schemas.layer1.yaml#/$defs/iso2'
  iana_tzid:
    $ref: 'schemas.layer1.yaml#/$defs/iana_tzid'
  rfc3339_micros:
    $ref: 'schemas.layer1.yaml#/$defs/rfc3339_micros'
  overlay_type_aggregation_v1:
    type: object
    additionalProperties: false
    required: [selection, mode]
    properties:
      selection: { enum: [ALL, MOST_SPECIFIC_ONLY] }
      mode: { enum: [PRODUCT, MAX, MIN] }
  channel_modifier_profile_v1:
    type: object
    additionalProperties: false
    required:
      - description
      - dow_multipliers
      - time_window_multipliers
    properties:
      description: { type: string, minLength: 1 }
      dow_multipliers:
        type: array
        minItems: 7
        maxItems: 7
        items: { type: number, exclusiveMinimum: 0 }
      time_window_multipliers:
        type: array
        items:
          type: object
          additionalProperties: false
          required:
            - window_id
            - days
            - start_minute
            - end_minute_exclusive
            - multiplier
          properties:
            window_id: { type: string, minLength: 1 }
            days:
              oneOf:
                - const: "*"
                - type: array
                  minItems: 1
                  items: { type: integer, minimum: 1, maximum: 7 }
            start_minute: { type: integer, minimum: 0, maximum: 1439 }
            end_minute_exclusive: { type: integer, minimum: 1, maximum: 1440 }
            multiplier: { type: number, exclusiveMinimum: 0 }
            flag: { type: string }
      flags:
        type: array
        items: { type: string }

validation:
  s0_gate_receipt_5A:
    type: object
    additionalProperties: true
    required:
      - manifest_fingerprint
      - parameter_hash
      - run_id
      - created_utc
      - verified_upstream_segments
      - scenario_id
      - s0_spec_version
      - sealed_inputs_digest
    properties:
      manifest_fingerprint: { $ref: '#/$defs/hex64' }
      parameter_hash: { $ref: '#/$defs/hex64' }
      run_id: { type: string }
      created_utc: { $ref: '#/$defs/rfc3339_micros' }
      s0_spec_version:
        type: string
        description: >
          Semantic version of the 5A.S0 spec (MAJOR.MINOR.PATCH). Downstream states MUST
          refuse to run if the MAJOR version is unsupported.
      verified_upstream_segments:
        type: object
        additionalProperties:
          type: object
          additionalProperties: false
          required: [status, bundle_id]
          properties:
            status: { enum: [PASS, FAIL, MISSING] }
            bundle_id: { type: string }
            bundle_path: { type: string }
            bundle_sha256_hex: { $ref: '#/$defs/hex64' }
            flag_sha256_hex: { $ref: '#/$defs/hex64' }
      scenario_id:
        oneOf:
          - type: string
          - type: array
            items: { type: string }
      scenario_pack_id: { type: string }
      parameter_pack_id: { type: string }
      sealed_inputs_digest: { $ref: '#/$defs/hex64' }

  sealed_inputs_5A:
    type: array
    items:
      type: object
      additionalProperties: false
      required:
        - manifest_fingerprint
        - parameter_hash
        - owner_layer
        - owner_segment
        - artifact_id
        - manifest_key
        - role
        - schema_ref
        - path_template
        - partition_keys
        - sha256_hex
        - version
        - source_dictionary
        - source_registry
        - status
        - read_scope
      properties:
        manifest_fingerprint: { $ref: '#/$defs/hex64' }
        parameter_hash: { $ref: '#/$defs/hex64' }
        owner_layer: { type: string }
        owner_segment: { type: string }
        artifact_id: { type: string }
        manifest_key: { type: string }
        role: { type: string }
        schema_ref: { type: string }
        path_template: { type: string }
        partition_keys:
          type: array
          items: { type: string }
        sha256_hex: { $ref: '#/$defs/hex64' }
        version: { type: string }
        source_dictionary: { type: string }
        source_registry: { type: string }
        status: { enum: [REQUIRED, OPTIONAL, IGNORED] }
        read_scope: { enum: [ROW_LEVEL, METADATA_ONLY] }
        notes: { type: string }
        license_class: { type: string }
        owner_team: { type: string }

  scenario_manifest_5A:
    type: array
    items:
      type: object
      additionalProperties: false
      required:
        - manifest_fingerprint
        - scenario_id
        - scenario_version
        - horizon_start_utc
        - horizon_end_utc
        - is_baseline
        - is_stress
      properties:
        manifest_fingerprint: { $ref: '#/$defs/hex64' }
        scenario_id: { type: string }
        scenario_version: { type: string }
        horizon_start_utc: { $ref: '#/$defs/rfc3339_micros' }
        horizon_end_utc: { $ref: '#/$defs/rfc3339_micros' }
        is_baseline: { type: boolean }
        is_stress: { type: boolean }
        labels:
          type: array
          items: { type: string }
        scenario_config_ids:
          type: array
          items: { type: string }

  validation_policy_5A:
    type: object
    additionalProperties: false
    required:
      - policy_id
      - version
      - tolerances
      - bounds
      - sampling
      - blocking
    properties:
      policy_id: { const: validation_policy_5A }
      version: { type: string, minLength: 1 }
      tolerances:
        type: object
        additionalProperties: false
        required:
          - s2_shape_sum_abs_warn
          - s2_shape_sum_abs_fail
          - s3_weekly_sum_rel_fail
          - s3_weekly_sum_abs_fail
          - s3_rel_denominator_floor
          - s4_recompose_rel_fail
          - s4_recompose_abs_fail
          - s4_recompose_rel_denominator_floor
        properties:
          s2_shape_sum_abs_warn: { type: number, minimum: 0 }
          s2_shape_sum_abs_fail: { type: number, minimum: 0 }
          s3_weekly_sum_rel_fail: { type: number, minimum: 0 }
          s3_weekly_sum_abs_fail: { type: number, minimum: 0 }
          s3_rel_denominator_floor: { type: number, minimum: 0 }
          s4_recompose_rel_fail: { type: number, minimum: 0 }
          s4_recompose_abs_fail: { type: number, minimum: 0 }
          s4_recompose_rel_denominator_floor: { type: number, minimum: 0 }
          s4_local_vs_utc_total_rel_fail: { type: number, minimum: 0 }
          s4_local_vs_utc_total_abs_fail: { type: number, minimum: 0 }
      bounds:
        type: object
        additionalProperties: false
        required:
          - overlay_factor_min_warn
          - overlay_factor_max_warn
          - overlay_low_warn_exempt_types
          - lambda_scenario_max_per_bucket_warn
          - lambda_scenario_max_per_bucket_fail
        properties:
          overlay_factor_min_warn: { type: number, minimum: 0 }
          overlay_factor_max_warn: { type: number, minimum: 0 }
          overlay_low_warn_exempt_types:
            type: array
            items: { enum: [HOLIDAY, PAYDAY, CAMPAIGN, OUTAGE, STRESS] }
          lambda_scenario_max_per_bucket_warn: { type: number, minimum: 0 }
          lambda_scenario_max_per_bucket_fail: { type: number, minimum: 0 }
      sampling:
        type: object
        additionalProperties: false
        required:
          - recompose_sample_mode
          - recompose_sample_n
          - recompose_hash_law
        properties:
          recompose_sample_mode: { const: minhash_top_n_v1 }
          recompose_sample_n: { type: integer, minimum: 1 }
          recompose_hash_law:
            const: 'hash64 = uint64_be(SHA256("5A.S5.recompose|" + manifest_fingerprint + "|" + parameter_hash + "|" + scenario_id + "|" + merchant_id + "|" + zone_key + "|" + horizon_bucket_key)[0:8])'
      blocking:
        type: object
        additionalProperties: false
        required:
          - blocking_check_ids
          - nonblocking_check_ids
          - warn_is_blocking_check_ids
          - unknown_check_id_posture
        properties:
          blocking_check_ids:
            type: array
            minItems: 1
            items: { type: string }
          nonblocking_check_ids:
            type: array
            items: { type: string }
          warn_is_blocking_check_ids:
            type: array
            items: { type: string }
          unknown_check_id_posture: { const: fail_closed }
      notes: { type: string }

  spec_compatibility_config_5A:
    type: object
    additionalProperties: false
    required:
      - config_id
      - version
      - mode
      - supported_majors
      - allowed_major_tuples
      - enforcement
    properties:
      config_id: { const: spec_compatibility_config_5A }
      version: { type: string, minLength: 1 }
      mode: { const: major_matrix_v1 }
      supported_majors:
        type: object
        additionalProperties: false
        required: [s1, s2, s3, s4]
        properties:
          s1:
            type: array
            minItems: 1
            items: { type: integer, minimum: 0 }
          s2:
            type: array
            minItems: 1
            items: { type: integer, minimum: 0 }
          s3:
            type: array
            minItems: 1
            items: { type: integer, minimum: 0 }
          s4:
            type: array
            minItems: 1
            items: { type: integer, minimum: 0 }
      allowed_major_tuples:
        type: array
        minItems: 1
        items:
          type: object
          additionalProperties: false
          required: [name, s1_major, s2_major, s3_major, s4_major]
          properties:
            name: { type: string, minLength: 1 }
            s1_major: { type: integer, minimum: 0 }
            s2_major: { type: integer, minimum: 0 }
            s3_major: { type: integer, minimum: 0 }
            s4_major: { type: integer, minimum: 0 }
      enforcement:
        type: object
        additionalProperties: false
        required:
          - on_missing_version_field
          - on_unparseable_version
          - on_unsupported_major
          - on_unsupported_tuple
          - failure_check_id
        properties:
          on_missing_version_field: { enum: [FAIL_CLOSED] }
          on_unparseable_version: { enum: [FAIL_CLOSED] }
          on_unsupported_major: { enum: [FAIL_VALIDATION, WARN_AND_CONTINUE] }
          on_unsupported_tuple: { enum: [FAIL_VALIDATION, WARN_AND_CONTINUE] }
          failure_check_id: { type: string, minLength: 1 }
      notes: { type: string }

policy:
  merchant_class_policy_5A:
    type: object
    additionalProperties: false
    required:
      - policy_id
      - version
      - demand_class_catalog
      - mcc_sector_map
      - channel_group_map
      - decision_tree_v1
      - realism_targets
    properties:
      policy_id: { const: merchant_class_policy_5A }
      version: { type: string, minLength: 1 }
      demand_class_catalog:
        type: array
        minItems: 10
        items:
          type: object
          additionalProperties: false
          required: [demand_class, description, intended_shape_family]
          properties:
            demand_class:
              type: string
              pattern: "^[a-z][a-z0-9_]{2,31}$"
            description: { type: string, minLength: 1 }
            intended_shape_family: { type: string, minLength: 1 }
            notes: { type: string }
      mcc_sector_map:
        type: object
        additionalProperties: false
        patternProperties:
          "^[0-9]{4}$":
            type: string
            enum:
              - digital_services
              - general_retail
              - grocery_pharmacy
              - fuel_auto
              - travel_hospitality
              - dining_entertainment
              - cash_fin_services
              - utilities_bills
              - government_education
              - other
      channel_group_map:
        type: object
        minProperties: 1
        additionalProperties:
          type: string
          enum: [card_present, card_not_present, mixed]
      decision_tree_v1:
        type: object
        additionalProperties: false
        required: [virtual_branch, nonvirtual_branch, default_class, subclass_rules]
        properties:
          virtual_branch:
            type: object
            additionalProperties: false
            required: [virtual_only_class, hybrid_class]
            properties:
              virtual_only_class: { type: string, minLength: 1 }
              hybrid_class: { type: string, minLength: 1 }
          nonvirtual_branch:
            type: object
            additionalProperties: false
            required: [by_channel_group]
            properties:
              by_channel_group:
                type: object
                additionalProperties: false
                required: [card_present, card_not_present, mixed]
                properties:
                  card_present:
                    type: object
                    additionalProperties: false
                    required:
                      - digital_services
                      - general_retail
                      - grocery_pharmacy
                      - fuel_auto
                      - travel_hospitality
                      - dining_entertainment
                      - cash_fin_services
                      - utilities_bills
                      - government_education
                      - other
                    properties:
                      digital_services: { type: string, minLength: 1 }
                      general_retail: { type: string, minLength: 1 }
                      grocery_pharmacy: { type: string, minLength: 1 }
                      fuel_auto: { type: string, minLength: 1 }
                      travel_hospitality: { type: string, minLength: 1 }
                      dining_entertainment: { type: string, minLength: 1 }
                      cash_fin_services: { type: string, minLength: 1 }
                      utilities_bills: { type: string, minLength: 1 }
                      government_education: { type: string, minLength: 1 }
                      other: { type: string, minLength: 1 }
                  card_not_present:
                    type: object
                    additionalProperties: false
                    required:
                      - digital_services
                      - general_retail
                      - grocery_pharmacy
                      - fuel_auto
                      - travel_hospitality
                      - dining_entertainment
                      - cash_fin_services
                      - utilities_bills
                      - government_education
                      - other
                    properties:
                      digital_services: { type: string, minLength: 1 }
                      general_retail: { type: string, minLength: 1 }
                      grocery_pharmacy: { type: string, minLength: 1 }
                      fuel_auto: { type: string, minLength: 1 }
                      travel_hospitality: { type: string, minLength: 1 }
                      dining_entertainment: { type: string, minLength: 1 }
                      cash_fin_services: { type: string, minLength: 1 }
                      utilities_bills: { type: string, minLength: 1 }
                      government_education: { type: string, minLength: 1 }
                      other: { type: string, minLength: 1 }
                  mixed:
                    type: object
                    additionalProperties: false
                    required:
                      - digital_services
                      - general_retail
                      - grocery_pharmacy
                      - fuel_auto
                      - travel_hospitality
                      - dining_entertainment
                      - cash_fin_services
                      - utilities_bills
                      - government_education
                      - other
                    properties:
                      digital_services: { type: string, minLength: 1 }
                      general_retail: { type: string, minLength: 1 }
                      grocery_pharmacy: { type: string, minLength: 1 }
                      fuel_auto: { type: string, minLength: 1 }
                      travel_hospitality: { type: string, minLength: 1 }
                      dining_entertainment: { type: string, minLength: 1 }
                      cash_fin_services: { type: string, minLength: 1 }
                      utilities_bills: { type: string, minLength: 1 }
                      government_education: { type: string, minLength: 1 }
                      other: { type: string, minLength: 1 }
          default_class: { type: string, minLength: 1 }
          subclass_rules:
            type: object
            additionalProperties: false
            required: [zone_role]
            properties:
              zone_role:
                type: object
                additionalProperties: false
                required: [primary_share_ge, tail_share_le]
                properties:
                  primary_share_ge: { type: number }
                  tail_share_le: { type: number }
      realism_targets:
        type: object
        additionalProperties: false
        required:
          - max_class_share
          - min_nontrivial_classes
          - min_class_share_for_nontrivial
          - min_virtual_share_if_virtual_present
          - max_single_country_share_within_class
        properties:
          max_class_share: { type: number }
          min_nontrivial_classes: { type: integer, minimum: 1 }
          min_class_share_for_nontrivial: { type: number }
          min_virtual_share_if_virtual_present: { type: number }
          max_single_country_share_within_class: { type: number }

  demand_scale_policy_5A:
    type: object
    additionalProperties: false
    required:
      - policy_id
      - version
      - weekly_volume_unit
      - global_multiplier
      - brand_size_exponent
      - zone_role_multipliers
      - virtual_mode_multipliers
      - channel_group_multipliers
      - class_params
      - thresholds
      - realism_targets
    properties:
      policy_id: { const: demand_scale_policy_5A }
      version: { type: string, minLength: 1 }
      weekly_volume_unit: { const: arrivals_per_local_week }
      global_multiplier: { type: number, exclusiveMinimum: 0 }
      brand_size_exponent: { type: number, minimum: 0.0, maximum: 0.20 }
      zone_role_multipliers:
        type: object
        additionalProperties: false
        required: [primary_zone, secondary_zone, tail_zone]
        properties:
          primary_zone: { type: number, minimum: 0 }
          secondary_zone: { type: number, minimum: 0 }
          tail_zone: { type: number, minimum: 0 }
      virtual_mode_multipliers:
        type: object
        additionalProperties: false
        required: [NON_VIRTUAL, HYBRID, VIRTUAL_ONLY]
        properties:
          NON_VIRTUAL: { type: number, minimum: 0 }
          HYBRID: { type: number, minimum: 0 }
          VIRTUAL_ONLY: { type: number, minimum: 0 }
      channel_group_multipliers:
        type: object
        additionalProperties: false
        required: [card_present, card_not_present, mixed]
        properties:
          card_present: { type: number, minimum: 0 }
          card_not_present: { type: number, minimum: 0 }
          mixed: { type: number, minimum: 0 }
      class_params:
        type: array
        minItems: 10
        items:
          type: object
          additionalProperties: false
          required:
            - demand_class
            - median_per_site_weekly
            - pareto_alpha
            - clip_max_per_site_weekly
            - ref_per_site_weekly
            - high_variability_flag
          properties:
            demand_class: { type: string, minLength: 1 }
            median_per_site_weekly: { type: number, exclusiveMinimum: 0 }
            pareto_alpha: { type: number, minimum: 1.1, maximum: 3.5 }
            clip_max_per_site_weekly: { type: number, exclusiveMinimum: 0 }
            ref_per_site_weekly: { type: number, exclusiveMinimum: 0 }
            high_variability_flag: { type: boolean }
      thresholds:
        type: object
        additionalProperties: false
        required: [low_volume_weekly_lt]
        properties:
          low_volume_weekly_lt: { type: number, minimum: 0 }
          high_volume_weekly_ge: { type: number, minimum: 0 }
      realism_targets:
        type: object
        additionalProperties: false
        required:
          - target_mean_per_site_weekly
          - mean_per_site_bounds
          - p99_p50_ratio_min
          - max_class_volume_share
          - max_weekly_volume_expected
        properties:
          target_mean_per_site_weekly: { type: number, exclusiveMinimum: 0 }
          mean_per_site_bounds:
            type: array
            minItems: 2
            maxItems: 2
            items: { type: number, minimum: 0 }
          p99_p50_ratio_min: { type: number, minimum: 0 }
          max_class_volume_share: { type: number, minimum: 0 }
          max_weekly_volume_expected: { type: number, exclusiveMinimum: 0 }
          soft_cap_ratio: { type: number, minimum: 0, maximum: 1 }
          soft_cap_multiplier: { type: number, minimum: 1 }

  baseline_intensity_policy_5A:
    type: object
    additionalProperties: false
    required:
      - policy_id
      - version
      - scale_source_field
      - scale_units
      - lambda_units_local
      - shape_sum_abs_tol
      - weekly_sum_rel_tol
      - clip_mode
      - hard_limits
      - tail_rescue
      - utc_projection
    properties:
      policy_id: { const: baseline_intensity_policy_5A }
      version: { type: string, minLength: 1 }
      scale_source_field: { const: weekly_volume_expected }
      scale_units: { const: arrivals_per_local_week }
      lambda_units_local: { const: expected_arrivals_per_local_week_bucket }
      shape_sum_abs_tol: { type: number }
      weekly_sum_rel_tol: { type: number }
      clip_mode: { enum: [hard_fail] }
      hard_limits:
        type: object
        additionalProperties: false
        required: [max_lambda_per_bucket, max_weekly_volume_expected]
        properties:
          max_lambda_per_bucket: { type: number, exclusiveMinimum: 0 }
          max_weekly_volume_expected: { type: number, exclusiveMinimum: 0 }
      tail_rescue:
        type: object
        additionalProperties: false
        required:
          - enabled
          - target_subclass
          - tail_floor_epsilon
          - tail_lift_power
          - tail_lift_max_multiplier
        properties:
          enabled: { type: boolean }
          target_subclass: { const: tail_zone }
          tail_floor_epsilon: { type: number, minimum: 0 }
          tail_lift_power: { type: number, exclusiveMinimum: 0 }
          tail_lift_max_multiplier: { type: number, minimum: 1 }
      utc_projection:
        type: object
        additionalProperties: false
        required: [emit_utc_baseline]
        properties:
          emit_utc_baseline: { type: boolean }

  baseline_validation_policy_5A:
    type: object
    additionalProperties: false
    required:
      - policy_id
      - version
      - weekly_sum_contract
    properties:
      policy_id: { const: baseline_validation_policy_5A }
      version: { type: string, minLength: 1 }
      weekly_sum_contract:
        type: object
        additionalProperties: false
        required:
          - applies_to_scale_units
          - abs_epsilon
          - rel_epsilon
          - rel_denominator_floor
          - epsilon_law
          - relative_error_law
        properties:
          applies_to_scale_units: { const: arrivals_per_local_week }
          abs_epsilon: { type: number, minimum: 0 }
          rel_epsilon: { type: number, minimum: 0 }
          rel_denominator_floor: { type: number, exclusiveMinimum: 0 }
          epsilon_law:
            const: "epsilon=max(abs_epsilon, rel_epsilon*max(|base_scale|, rel_denominator_floor))"
          relative_error_law:
            const: "rel_err=|sum_local-base_scale|/max(|base_scale|, rel_denominator_floor)"
      notes: { type: string }

  shape_library_5A:
    type: object
    additionalProperties: false
    required:
      - policy_id
      - version
      - scenario_mode
      - channel_groups
      - zone_group_mode
      - templates
      - template_resolution
      - constraints
      - realism_floors
    properties:
      policy_id: { const: shape_library_5A }
      version: { type: string, minLength: 1 }
      scenario_mode: { const: scenario_agnostic }
      channel_groups:
        type: array
        minItems: 3
        items: { enum: [card_present, card_not_present, mixed] }
      zone_group_mode:
        type: object
        additionalProperties: false
        required: [mode, buckets, zone_group_id_prefix]
        properties:
          mode: { const: tzid_hash_bucket_v1 }
          buckets: { type: integer, minimum: 1 }
          zone_group_id_prefix: { type: string, minLength: 1 }
      templates:
        type: array
        minItems: 40
        items:
          type: object
          additionalProperties: false
          required:
            - template_id
            - demand_class
            - channel_group
            - shape_kind
            - dow_weights
            - daily_components
            - baseline_floor
            - power
            - notes
          properties:
            template_id:
              type: string
              pattern: "^[a-z][a-z0-9_.-]{2,63}$"
            demand_class: { type: string, minLength: 1 }
            channel_group: { enum: [card_present, card_not_present, mixed] }
            shape_kind: { const: daily_gaussian_mixture }
            dow_weights:
              type: array
              minItems: 7
              maxItems: 7
              items: { type: number, exclusiveMinimum: 0 }
            daily_components:
              type: array
              minItems: 1
              items:
                type: object
                additionalProperties: false
                required: [kind, center_min, sigma_min, amplitude]
                properties:
                  kind: { const: gaussian_peak }
                  center_min: { type: integer, minimum: 0, maximum: 1439 }
                  sigma_min: { type: number, minimum: 20, maximum: 240 }
                  amplitude: { type: number, exclusiveMinimum: 0 }
            baseline_floor: { type: number, minimum: 0 }
            power: { type: number, minimum: 0.6, maximum: 2.0 }
            notes: { type: string, minLength: 1 }
      template_resolution:
        type: object
        additionalProperties: false
        required: [mode, default_template_id, rules]
        properties:
          mode: { const: deterministic_choice_by_tzid_v1 }
          default_template_id: { type: string, minLength: 1 }
          rules:
            type: array
            minItems: 1
            items:
              type: object
              additionalProperties: false
              required:
                - demand_class
                - channel_group
                - candidate_template_ids
                - selection_law
              properties:
                demand_class: { type: string, minLength: 1 }
                channel_group: { enum: [card_present, card_not_present, mixed] }
                candidate_template_ids:
                  type: array
                  minItems: 2
                  items: { type: string, minLength: 1 }
                selection_law: { const: u_det_pick_index_v1 }
      constraints:
        type: object
        additionalProperties: false
        required:
          - min_mass_night
          - night_window_minutes
          - min_weekend_mass_for_weekend_classes
          - office_hours_window
          - shape_nonflat_ratio_min
        properties:
          min_mass_night: { type: number, minimum: 0 }
          night_window_minutes:
            type: object
            additionalProperties: false
            required: [start_min, end_min]
            properties:
              start_min: { type: integer, minimum: 0, maximum: 1440 }
              end_min: { type: integer, minimum: 0, maximum: 1440 }
          min_weekend_mass_for_weekend_classes: { type: number, minimum: 0 }
          office_hours_window:
            type: object
            additionalProperties: false
            required: [weekday_start_min, weekday_end_min, min_weekday_office_mass]
            properties:
              weekday_start_min: { type: integer, minimum: 0, maximum: 1440 }
              weekday_end_min: { type: integer, minimum: 0, maximum: 1440 }
              min_weekday_office_mass: { type: number, minimum: 0 }
          shape_nonflat_ratio_min: { type: number, minimum: 0 }
      realism_floors:
        type: object
        additionalProperties: false
        required:
          - min_total_templates
          - min_templates_per_class_per_channel
          - require_all_classes_present
          - require_all_channel_groups_present
          - min_nonflat_templates_fraction
          - min_night_mass_online24h
          - min_weekend_mass_evening_weekend
          - min_weekday_mass_office_hours
        properties:
          min_total_templates: { type: integer, minimum: 1 }
          min_templates_per_class_per_channel: { type: integer, minimum: 1 }
          require_all_classes_present: { type: boolean }
          require_all_channel_groups_present: { type: boolean }
          min_nonflat_templates_fraction: { type: number, minimum: 0 }
          min_night_mass_online24h: { type: number, minimum: 0 }
          min_weekend_mass_evening_weekend: { type: number, minimum: 0 }
          min_weekday_mass_office_hours: { type: number, minimum: 0 }

  class_shape_templates_5A:
    type: object
    additionalProperties: false
    required:
      - table_id
      - version
      - templates
    properties:
      table_id: { const: class_shape_templates_5A }
      version: { type: string, minLength: 1 }
      templates:
        type: array
        minItems: 1
        items:
          type: object
          additionalProperties: false
          required:
            - template_id
            - demand_class
            - channel_group
            - shape_kind
            - dow_weights
            - daily_components
            - baseline_floor
            - power
            - notes
          properties:
            template_id:
              type: string
              pattern: "^[a-z][a-z0-9_.-]{2,63}$"
            demand_class: { type: string, minLength: 1 }
            channel_group: { enum: [card_present, card_not_present, mixed] }
            shape_kind: { const: daily_gaussian_mixture }
            dow_weights:
              type: array
              minItems: 7
              maxItems: 7
              items: { type: number, exclusiveMinimum: 0 }
            daily_components:
              type: array
              minItems: 1
              items:
                type: object
                additionalProperties: false
                required: [kind, center_min, sigma_min, amplitude]
                properties:
                  kind: { const: gaussian_peak }
                  center_min: { type: integer, minimum: 0, maximum: 1439 }
                  sigma_min: { type: number, minimum: 20, maximum: 240 }
                  amplitude: { type: number, exclusiveMinimum: 0 }
            baseline_floor: { type: number, minimum: 0 }
            power: { type: number, minimum: 0.6, maximum: 2.0 }
            notes: { type: string, minLength: 1 }
      notes: { type: string }

  shape_time_grid_policy_5A:
    type: object
    additionalProperties: false
    required: [version, grid]
    properties:
      version: { type: string, minLength: 1 }
      grid:
        type: object
        additionalProperties: false
        required:
          - bucket_duration_minutes
          - week_start
          - day_of_week_encoding
          - minutes_per_day
          - days_per_week
          - buckets_per_day
          - T_week
          - bucket_index_law
          - inverse_mapping_law
        properties:
          bucket_duration_minutes: { type: integer, enum: [15, 30, 60] }
          week_start: { const: monday_00_00_local }
          day_of_week_encoding: { const: "1=Mon,...,7=Sun" }
          minutes_per_day: { const: 1440 }
          days_per_week: { const: 7 }
          buckets_per_day: { type: integer, minimum: 1 }
          T_week: { type: integer, minimum: 1 }
          bucket_index_law: { const: "k=(dow-1)*T_day + floor(minute/bucket_minutes)" }
          inverse_mapping_law: { const: "dow=1+floor(k/T_day); minute=(k%T_day)*bucket_minutes" }
          derived_flags:
            type: object
            additionalProperties: false
            properties:
              weekend_days:
                type: array
                minItems: 2
                maxItems: 2
                items: { type: integer, minimum: 1, maximum: 7 }
              is_weekend_law: { const: "dow in weekend_days" }
              nominal_open_hours:
                type: object
                additionalProperties: false
                required: [days, start_minute, end_minute_exclusive]
                properties:
                  days:
                    type: array
                    minItems: 1
                    items: { type: integer, minimum: 1, maximum: 7 }
                  start_minute: { type: integer, minimum: 0, maximum: 1440 }
                  end_minute_exclusive: { type: integer, minimum: 0, maximum: 1440 }
              is_nominal_open_hours_law:
                const: "dow in days AND start_minute <= minute < end_minute_exclusive"
      notes: { type: string }

  zone_shape_modifiers_5A:
    type: object
    additionalProperties: false
    required:
      - policy_id
      - version
      - mode
      - zone_group_mode
      - overrides
      - profiles
      - defaults
    properties:
      policy_id: { const: zone_shape_modifiers_5A }
      version: { type: string, minLength: 1 }
      mode: { const: bucket_profiles_v1 }
      zone_group_mode:
        type: object
        additionalProperties: false
        required:
          - mode
          - buckets
          - zone_group_id_prefix
          - zone_group_id_law
        properties:
          mode: { const: tzid_hash_bucket_v1 }
          buckets: { type: integer, minimum: 1 }
          zone_group_id_prefix: { type: string, minLength: 1 }
          zone_group_id_law:
            const: 'msg=UTF8("5A.S2.template|" + demand_class + "|" + channel_group + "|" + tzid + "|" + parameter_hash_hex); x=uint64_be(SHA256(msg)[0:8]); zone_group_id=zone_group_id_prefix + str(x % buckets)'
      overrides:
        type: array
        items:
          type: object
          additionalProperties: false
          required: [override_id, match, force_profile_id, notes]
          properties:
            override_id: { type: string, minLength: 1 }
            match:
              type: object
              additionalProperties: false
              minProperties: 1
              properties:
                legal_country_iso_in:
                  type: array
                  minItems: 1
                  items: { $ref: '#/$defs/iso2' }
                tzid_in:
                  type: array
                  minItems: 1
                  items: { $ref: '#/$defs/iana_tzid' }
                tzid_prefix_in:
                  type: array
                  minItems: 1
                  items: { type: string, minLength: 1 }
            force_profile_id: { type: string, minLength: 1 }
            notes: { type: string }
      profiles:
        type: array
        minItems: 1
        items:
          type: object
          additionalProperties: false
          required:
            - profile_id
            - description
            - dow_multipliers
            - time_window_multipliers
          properties:
            profile_id: { type: string, minLength: 1 }
            description: { type: string, minLength: 1 }
            dow_multipliers:
              type: array
              minItems: 7
              maxItems: 7
              items: { type: number, exclusiveMinimum: 0 }
            time_window_multipliers:
              type: array
              items:
                type: object
                additionalProperties: false
                required:
                  - window_id
                  - days
                  - start_minute
                  - end_minute_exclusive
                  - multiplier
                properties:
                  window_id: { type: string, minLength: 1 }
                  days:
                    oneOf:
                      - const: "*"
                      - type: array
                        minItems: 1
                        items: { type: integer, minimum: 1, maximum: 7 }
                  start_minute: { type: integer, minimum: 0, maximum: 1439 }
                  end_minute_exclusive: { type: integer, minimum: 1, maximum: 1440 }
                  multiplier: { type: number, exclusiveMinimum: 0 }
            constraints:
              type: object
              additionalProperties: true
            notes: { type: string }
      defaults:
        type: object
        additionalProperties: false
        required: [neutral_profile_id, on_missing_profile_id, emit_adjustment_flags]
        properties:
          neutral_profile_id: { type: string, minLength: 1 }
          on_missing_profile_id: { const: FAIL_CLOSED }
          emit_adjustment_flags: { type: boolean }
      notes: { type: string }

  channel_shape_modifiers_5A:
    type: object
    additionalProperties: false
    required:
      - policy_id
      - version
      - mode
      - channel_groups
      - by_channel_group
      - limits
      - defaults
    properties:
      policy_id: { const: channel_shape_modifiers_5A }
      version: { type: string, minLength: 1 }
      mode: { const: channel_bucket_profiles_v1 }
      channel_groups:
        type: array
        minItems: 3
        maxItems: 3
        items: { enum: [card_present, card_not_present, mixed] }
      by_channel_group:
        type: object
        additionalProperties: false
        required: [card_present, card_not_present, mixed]
        properties:
          card_present: { $ref: '#/$defs/channel_modifier_profile_v1' }
          card_not_present: { $ref: '#/$defs/channel_modifier_profile_v1' }
          mixed: { $ref: '#/$defs/channel_modifier_profile_v1' }
      limits:
        type: object
        additionalProperties: false
        required: [multiplier_min, multiplier_max, max_windows_per_profile]
        properties:
          multiplier_min: { type: number, exclusiveMinimum: 0 }
          multiplier_max: { type: number, exclusiveMinimum: 0 }
          max_windows_per_profile: { type: integer, minimum: 1 }
      defaults:
        type: object
        additionalProperties: false
        required: [neutral_when_channel_absent, neutral_profile_key, emit_adjustment_flags]
        properties:
          neutral_when_channel_absent: { const: true }
          neutral_profile_key: { const: mixed }
          emit_adjustment_flags: { type: boolean }
      notes: { type: string }

  overlay_ordering_policy_5A:
    type: object
    additionalProperties: false
    required:
      - policy_id
      - version
      - type_priority
      - within_type_aggregation
      - masking_rules
    properties:
      policy_id: { const: overlay_ordering_policy_5A }
      version: { type: string, minLength: 1 }
      type_priority:
        type: object
        additionalProperties: false
        required: [priority, require_all_vocab_types_listed]
        properties:
          require_all_vocab_types_listed: { const: true }
          priority:
            type: object
            additionalProperties: false
            required: [HOLIDAY, PAYDAY, CAMPAIGN, OUTAGE, STRESS]
            properties:
              HOLIDAY: { type: integer }
              PAYDAY: { type: integer }
              CAMPAIGN: { type: integer }
              OUTAGE: { type: integer }
              STRESS: { type: integer }
      within_type_aggregation:
        type: object
        additionalProperties: false
        required: [HOLIDAY, PAYDAY, CAMPAIGN, OUTAGE, STRESS]
        properties:
          HOLIDAY: { $ref: '#/$defs/overlay_type_aggregation_v1' }
          PAYDAY: { $ref: '#/$defs/overlay_type_aggregation_v1' }
          CAMPAIGN: { $ref: '#/$defs/overlay_type_aggregation_v1' }
          OUTAGE: { $ref: '#/$defs/overlay_type_aggregation_v1' }
          STRESS: { $ref: '#/$defs/overlay_type_aggregation_v1' }
      masking_rules:
        type: array
        items:
          type: object
          additionalProperties: false
          required: [name, when_active_types, apply]
          properties:
            name: { type: string, minLength: 1 }
            when_active_types:
              type: array
              minItems: 1
              items: { enum: [HOLIDAY, PAYDAY, CAMPAIGN, OUTAGE, STRESS] }
            apply:
              type: array
              minItems: 1
              items:
                type: object
                additionalProperties: false
                required: [target_types, operator]
                properties:
                  target_types:
                    type: array
                    minItems: 1
                    items: { enum: [HOLIDAY, PAYDAY, CAMPAIGN, OUTAGE, STRESS] }
                  operator: { enum: [NEUTRALIZE, CAP_AT_ONE, FLOOR_AT_ONE] }
      notes: { type: string }

scenario:
  scenario_horizon_config_5A:
    type: object
    additionalProperties: false
    required: [version, scenarios]
    properties:
      version: { type: string, minLength: 1 }
      scenarios:
        type: array
        minItems: 1
        items:
          type: object
          additionalProperties: false
          required:
            - scenario_id
            - scenario_version
            - is_baseline
            - is_stress
            - labels
            - horizon_start_utc
            - horizon_end_utc
            - bucket_duration_minutes
            - emit_utc_intensities
          properties:
            scenario_id:
              type: string
              pattern: "^[A-Za-z0-9][A-Za-z0-9_.-]{0,63}$"
            scenario_version: { type: string, minLength: 1 }
            is_baseline: { type: boolean }
            is_stress: { type: boolean }
            labels:
              type: array
              items: { type: string }
            horizon_start_utc: { $ref: '#/$defs/rfc3339_micros' }
            horizon_end_utc: { $ref: '#/$defs/rfc3339_micros' }
            bucket_duration_minutes: { type: integer, enum: [15, 30, 60] }
            emit_utc_intensities: { type: boolean }
            notes: { type: string }
          allOf:
            - oneOf:
                - properties:
                    is_baseline: { const: true }
                    is_stress: { const: false }
                - properties:
                    is_baseline: { const: false }
                    is_stress: { const: true }

  scenario_metadata:
    type: object
    additionalProperties: true

  scenario_calendar_5A:
    type: array
    items:
      type: object
      additionalProperties: false
      required:
        - manifest_fingerprint
        - scenario_id
        - event_id
        - event_type
        - start_utc
        - end_utc
        - shape_kind
        - scope_global
      properties:
        manifest_fingerprint: { $ref: '#/$defs/hex64' }
        scenario_id: { type: string }
        event_id: { type: string }
        event_type: { enum: [HOLIDAY, PAYDAY, CAMPAIGN, OUTAGE, STRESS] }
        start_utc: { $ref: '#/$defs/rfc3339_micros' }
        end_utc: { $ref: '#/$defs/rfc3339_micros' }
        shape_kind: { enum: [constant, ramp] }
        amplitude:
          type: [number, "null"]
        amplitude_peak:
          type: [number, "null"]
        ramp_in_buckets:
          type: [integer, "null"]
          minimum: 0
        ramp_out_buckets:
          type: [integer, "null"]
          minimum: 0
        scope_global: { type: boolean }
        country_iso:
          oneOf:
            - $ref: '#/$defs/iso2'
            - type: "null"
        tzid:
          oneOf:
            - $ref: '#/$defs/iana_tzid'
            - type: "null"
        demand_class:
          type: [string, "null"]
        merchant_id:
          oneOf:
            - $ref: '#/$defs/id64'
            - type: "null"
        notes:
          type: [string, "null"]

  scenario_overlay_policy_5A:
    type: object
    additionalProperties: false
    required:
      - policy_id
      - version
      - event_types
      - scope_rules
      - combination
      - shape_kinds
      - calendar_validation
    properties:
      policy_id: { const: scenario_overlay_policy_5A }
      version: { type: string, minLength: 1 }
      event_types:
        type: object
        additionalProperties: false
        required: [HOLIDAY, PAYDAY, CAMPAIGN, OUTAGE, STRESS]
        properties:
          HOLIDAY: &event_type_def
            type: object
            additionalProperties: false
            required:
              - default_shape_kind
              - default_amplitude
              - amplitude_bounds
              - allowed_scope_kinds
            properties:
              default_shape_kind: { enum: [constant, ramp] }
              default_amplitude: { type: number }
              amplitude_bounds:
                type: array
                minItems: 2
                maxItems: 2
                items: { type: number }
              allowed_scope_kinds:
                type: array
                minItems: 1
                items: { enum: [global, country, tzid, demand_class, merchant] }
          PAYDAY: *event_type_def
          CAMPAIGN: *event_type_def
          OUTAGE: *event_type_def
          STRESS: *event_type_def
      scope_rules:
        type: object
        additionalProperties: false
        required: [allowed_scope_kinds, predicate_schema, rules]
        properties:
          allowed_scope_kinds:
            type: array
            minItems: 1
            items: { enum: [global, country, tzid, demand_class, merchant] }
          predicate_schema:
            type: object
            additionalProperties: false
            properties:
              global: { type: boolean }
              country_iso: { $ref: '#/$defs/iso2' }
              tzid: { $ref: '#/$defs/iana_tzid' }
              demand_class: { type: string }
              merchant_id: { $ref: '#/$defs/id64' }
          rules:
            type: object
            additionalProperties: false
            required:
              - require_at_least_one_predicate
              - global_cannot_combine
              - merchant_scope_is_exclusive
            properties:
              require_at_least_one_predicate: { type: boolean }
              global_cannot_combine: { type: boolean }
              merchant_scope_is_exclusive: { type: boolean }
      combination:
        type: object
        additionalProperties: false
        required: [mode, min_factor, max_factor, apply_clamp_after_product]
        properties:
          mode: { const: multiplicative_product_v1 }
          min_factor: { type: number, minimum: 0 }
          max_factor: { type: number, exclusiveMinimum: 0 }
          apply_clamp_after_product: { type: boolean }
      shape_kinds:
        type: object
        additionalProperties: false
        required: [constant, ramp]
        properties:
          constant:
            type: object
            additionalProperties: false
            required: [required_params, amplitude_min, amplitude_max]
            properties:
              required_params:
                type: array
                minItems: 1
                items: { const: amplitude }
              amplitude_min: { type: number, minimum: 0 }
              amplitude_max: { type: number, minimum: 0 }
          ramp:
            type: object
            additionalProperties: false
            required:
              - required_params
              - amplitude_peak_min
              - amplitude_peak_max
              - ramp_in_buckets_max
              - ramp_out_buckets_max
            properties:
              required_params:
                type: array
                minItems: 3
                items: { enum: [amplitude_peak, ramp_in_buckets, ramp_out_buckets] }
              amplitude_peak_min: { type: number, minimum: 0 }
              amplitude_peak_max: { type: number, minimum: 0 }
              ramp_in_buckets_max: { type: integer, minimum: 0 }
              ramp_out_buckets_max: { type: integer, minimum: 0 }
      calendar_validation:
        type: object
        additionalProperties: false
        required:
          - require_event_type_in_vocab
          - require_scope_valid
          - require_time_within_horizon
          - disallow_empty_scope
          - disallow_unknown_fields
          - max_events_per_scenario
          - max_overlap_events_per_row_bucket
        properties:
          require_event_type_in_vocab: { type: boolean }
          require_scope_valid: { type: boolean }
          require_time_within_horizon: { type: boolean }
          disallow_empty_scope: { type: boolean }
          disallow_unknown_fields: { type: boolean }
          max_events_per_scenario: { type: integer, minimum: 1 }
          max_overlap_events_per_row_bucket: { type: integer, minimum: 1 }

  overlay_ordering_policy_5A:
    $ref: '#/policy/overlay_ordering_policy_5A'

  scenario_overlay_validation_policy_5A:
    type: object
    additionalProperties: false
    required:
      - policy_id
      - version
      - numeric
      - warnings
      - gating
    properties:
      policy_id: { const: scenario_overlay_validation_policy_5A }
      version: { type: string, minLength: 1 }
      numeric:
        type: object
        additionalProperties: false
        required:
          - finite_required
          - nonnegative_required
          - hard_bounds_source
          - comparison_epsilon
        properties:
          finite_required: { const: true }
          nonnegative_required: { const: true }
          hard_bounds_source: { const: scenario_overlay_policy_5A.combination }
          comparison_epsilon: { type: number, exclusiveMinimum: 0 }
      warnings:
        type: object
        additionalProperties: false
        required: [warn_bounds_total]
        properties:
          warn_bounds_total:
            type: object
            additionalProperties: false
            required: [apply_to, min_warn, max_warn, exceptions]
            properties:
              apply_to: { const: overlay_factor_total }
              min_warn: { type: number, minimum: 0 }
              max_warn: { type: number, minimum: 0 }
              exceptions:
                type: object
                additionalProperties: false
                required: [suppress_low_warn_when_type_active]
                properties:
                  suppress_low_warn_when_type_active:
                    type: array
                    items: { enum: [HOLIDAY, PAYDAY, CAMPAIGN, OUTAGE, STRESS] }
          aggregate_warn_checks:
            type: array
            items:
              type: object
              additionalProperties: false
              required: [name, selector, metric, bounds]
              properties:
                name: { type: string, minLength: 1 }
                selector:
                  type: object
                  additionalProperties: true
                metric: { enum: [mean, p95, max] }
                bounds:
                  type: array
                  minItems: 2
                  maxItems: 2
                  items:
                    anyOf:
                      - type: number
                      - type: "null"
      gating:
        type: object
        additionalProperties: false
        required:
          - warn_violation_is_fatal
          - max_warn_violations_fraction_fail
          - max_warn_violations_fraction_warn
          - fraction_denominator
        properties:
          warn_violation_is_fatal: { type: boolean }
          max_warn_violations_fraction_fail: { type: number, minimum: 0, maximum: 1 }
          max_warn_violations_fraction_warn: { type: number, minimum: 0, maximum: 1 }
          fraction_denominator: { const: domain_horizon_points }
      notes: { type: string }

model:
  merchant_zone_profile_5A:
    type: array
    items:
      type: object
      additionalProperties: true
      required:
        - manifest_fingerprint
        - parameter_hash
        - merchant_id
        - legal_country_iso
        - tzid
        - demand_class
      properties:
        manifest_fingerprint: { $ref: '#/$defs/hex64' }
        parameter_hash: { $ref: '#/$defs/hex64' }
        merchant_id: { $ref: '#/$defs/id64' }
        legal_country_iso: { $ref: '#/$defs/iso2' }
        tzid: { $ref: '#/$defs/iana_tzid' }
        demand_class: { type: string }
        demand_subclass: { type: string }
        profile_id: { type: string }
        weekly_volume_expected:
          type: number
          minimum: 0
        scale_factor:
          type: number
          minimum: 0
        weekly_volume_unit: { type: string }
        high_variability_flag: { type: boolean }
        low_volume_flag: { type: boolean }
        virtual_preferred_flag: { type: boolean }
        class_source: { type: string }

  merchant_class_profile_5A:
    type: array
    items:
      type: object
      additionalProperties: true
      required:
        - manifest_fingerprint
        - parameter_hash
        - merchant_id
        - primary_demand_class
      properties:
        manifest_fingerprint: { $ref: '#/$defs/hex64' }
        parameter_hash: { $ref: '#/$defs/hex64' }
        merchant_id: { $ref: '#/$defs/id64' }
        primary_demand_class: { type: string }
        classes_seen:
          type: array
          items: { type: string }
        weekly_volume_total_expected:
          type: number
          minimum: 0
        scale_factor_total:
          type: number
          minimum: 0

  shape_grid_definition_5A:
    type: array
    items:
      type: object
      additionalProperties: true
      required:
        - parameter_hash
        - scenario_id
        - bucket_index
        - local_day_of_week
        - local_minutes_since_midnight
        - bucket_duration_minutes
      properties:
        parameter_hash: { $ref: '#/$defs/hex64' }
        scenario_id: { type: string }
        bucket_index: { type: integer, minimum: 0 }
        local_day_of_week: { type: integer, minimum: 1, maximum: 7 }
        local_minutes_since_midnight: { type: integer, minimum: 0, maximum: 1439 }
        bucket_duration_minutes: { type: integer, minimum: 1 }
        is_weekend: { type: boolean }
        is_nominal_open_hours: { type: boolean }
        time_grid_version: { type: string }

  class_zone_shape_5A:
    type: array
    items:
      type: object
      additionalProperties: true
      required:
        - parameter_hash
        - scenario_id
        - demand_class
        - bucket_index
        - shape_value
        - s2_spec_version
      properties:
        parameter_hash: { $ref: '#/$defs/hex64' }
        scenario_id: { type: string }
        demand_class: { type: string }
        legal_country_iso: { $ref: '#/$defs/iso2' }
        tzid: { $ref: '#/$defs/iana_tzid' }
        zone_id: { type: string }
        channel_group: { type: string }
        bucket_index: { type: integer, minimum: 0 }
        shape_value:
          type: number
          minimum: 0
        s2_spec_version: { type: string }
        template_id: { type: string }
        adjustment_flags:
          type: array
          items: { type: string }
        notes: { type: string }

  class_shape_catalogue_5A:
    type: array
    items:
      type: object
      additionalProperties: true
      required:
        - parameter_hash
        - scenario_id
        - demand_class
      properties:
        parameter_hash: { $ref: '#/$defs/hex64' }
        scenario_id: { type: string }
        demand_class: { type: string }
        channel_group: { type: string }
        template_id: { type: string }
        template_type: { type: string }
        template_params: { type: object }
        policy_version: { type: string }

  merchant_zone_baseline_local_5A:
    type: array
    items:
      type: object
      additionalProperties: true
      required:
        - manifest_fingerprint
        - parameter_hash
        - scenario_id
        - merchant_id
        - legal_country_iso
        - tzid
        - bucket_index
        - s3_spec_version
        - lambda_local_base
      properties:
        manifest_fingerprint: { $ref: '#/$defs/hex64' }
        parameter_hash: { $ref: '#/$defs/hex64' }
        scenario_id: { type: string }
        merchant_id: { $ref: '#/$defs/id64' }
        legal_country_iso: { $ref: '#/$defs/iso2' }
        tzid: { $ref: '#/$defs/iana_tzid' }
        zone_id: { type: string }
        channel: { type: string }
        channel_group: { type: string }
        bucket_index: { type: integer, minimum: 0 }
        lambda_local_base:
          type: number
          minimum: 0
        s3_spec_version: { type: string }
        scale_source: { type: string }
        weekly_volume_expected:
          type: number
          minimum: 0
        scale_factor:
          type: number
          minimum: 0
        baseline_clip_applied: { type: boolean }

  class_zone_baseline_local_5A:
    type: array
    items:
      type: object
      additionalProperties: true
      required:
        - manifest_fingerprint
        - parameter_hash
        - scenario_id
        - demand_class
        - legal_country_iso
        - tzid
        - bucket_index
        - lambda_local_base_class
        - s3_spec_version
      properties:
        manifest_fingerprint: { $ref: '#/$defs/hex64' }
        parameter_hash: { $ref: '#/$defs/hex64' }
        scenario_id: { type: string }
        demand_class: { type: string }
        legal_country_iso: { $ref: '#/$defs/iso2' }
        tzid: { $ref: '#/$defs/iana_tzid' }
        zone_id: { type: string }
        channel: { type: string }
        channel_group: { type: string }
        bucket_index: { type: integer, minimum: 0 }
        lambda_local_base_class:
          type: number
          minimum: 0
        s3_spec_version: { type: string }

  merchant_zone_baseline_utc_5A:
    type: array
    items:
      type: object
      additionalProperties: true
      required:
        - manifest_fingerprint
        - parameter_hash
        - scenario_id
        - merchant_id
        - legal_country_iso
        - tzid
        - utc_bucket_index
        - s3_spec_version
        - lambda_utc_base
      properties:
        manifest_fingerprint: { $ref: '#/$defs/hex64' }
        parameter_hash: { $ref: '#/$defs/hex64' }
        scenario_id: { type: string }
        merchant_id: { $ref: '#/$defs/id64' }
        legal_country_iso: { $ref: '#/$defs/iso2' }
        tzid: { $ref: '#/$defs/iana_tzid' }
        zone_id: { type: string }
        channel: { type: string }
        channel_group: { type: string }
        utc_bucket_index: { type: integer, minimum: 0 }
        utc_date: { type: string }
        utc_bucket_within_date: { type: integer, minimum: 0 }
        lambda_utc_base:
          type: number
          minimum: 0
        s3_spec_version: { type: string }

  merchant_zone_scenario_local_5A:
    type: array
    items:
      type: object
      additionalProperties: false
      required:
        - manifest_fingerprint
        - scenario_id
        - merchant_id
        - legal_country_iso
        - tzid
        - local_horizon_bucket_index
        - lambda_local_scenario
        - s4_spec_version
      properties:
        manifest_fingerprint: { $ref: '#/$defs/hex64' }
        parameter_hash: { $ref: '#/$defs/hex64' }
        scenario_id: { type: string }
        merchant_id: { $ref: '#/$defs/id64' }
        legal_country_iso: { $ref: '#/$defs/iso2' }
        tzid: { $ref: '#/$defs/iana_tzid' }
        zone_id: { type: string }
        channel: { type: string }
        channel_group: { type: string }
        local_horizon_bucket_index: { type: integer, minimum: 0 }
        lambda_local_scenario:
          type: number
          minimum: 0
        s4_spec_version: { type: string }
        overlay_factor_total:
          type: number
          minimum: 0

  merchant_zone_overlay_factors_5A:
    type: array
    items:
      type: object
      additionalProperties: true
      required:
        - manifest_fingerprint
        - scenario_id
        - merchant_id
        - legal_country_iso
        - tzid
        - local_horizon_bucket_index
        - overlay_factor_total
        - s4_spec_version
      properties:
        manifest_fingerprint: { $ref: '#/$defs/hex64' }
        parameter_hash: { $ref: '#/$defs/hex64' }
        scenario_id: { type: string }
        merchant_id: { $ref: '#/$defs/id64' }
        legal_country_iso: { $ref: '#/$defs/iso2' }
        tzid: { $ref: '#/$defs/iana_tzid' }
        zone_id: { type: string }
        channel: { type: string }
        channel_group: { type: string }
        local_horizon_bucket_index: { type: integer, minimum: 0 }
        overlay_factor_total:
          type: number
          minimum: 0
        s4_spec_version: { type: string }

  merchant_zone_scenario_utc_5A:
    type: array
    items:
      type: object
      additionalProperties: false
      required:
        - manifest_fingerprint
        - scenario_id
        - merchant_id
        - legal_country_iso
        - tzid
        - utc_horizon_bucket_index
        - lambda_utc_scenario
        - s4_spec_version
      properties:
        manifest_fingerprint: { $ref: '#/$defs/hex64' }
        parameter_hash: { $ref: '#/$defs/hex64' }
        scenario_id: { type: string }
        merchant_id: { $ref: '#/$defs/id64' }
        legal_country_iso: { $ref: '#/$defs/iso2' }
        tzid: { $ref: '#/$defs/iana_tzid' }
        zone_id: { type: string }
        channel: { type: string }
        channel_group: { type: string }
        utc_horizon_bucket_index: { type: integer, minimum: 0 }
        lambda_utc_scenario:
          type: number
          minimum: 0
        s4_spec_version: { type: string }
