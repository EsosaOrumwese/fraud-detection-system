subsegments:
- id: 4A
  name: Reproducibility and Configurability
  artifacts:

      # 1 CONTAINER & BUILD PROVENANCE
  - name: Dockerfile_lock
    path: Dockerfile.lock
    type: manifest
    category: reproducibility
    semver: '{semver}'
    version: '{container_version}'
    digest: '{sha256}'
    manifest_key: mlr.4A.manifest.dockerfile_lock
    license: '{spdx_or_internal}'
    role: Locks base-image digest and apt/yum layer hashes.
    dependencies: []
    source: internal
    owner: {platform_team: null}
    last_updated: '{iso8601_timestamp}'
    environment: [ci]
    schema:
    cross_layer: false
    notes:

  - name: pipeline_launcher
    path: ci/pipeline_launcher.sh
    type: script
    category: ci
    semver: '{code_semver}'
    version: '{git_commit}'
    digest: '{git_tree_hash}'
    manifest_key: mlr.4A.ci.pipeline_launcher
    license: '{spdx_or_internal}'
    role: Entrypoint that writes the initial build.manifest and kicks off validation jobs.
    dependencies:
    - Dockerfile_lock
    source: internal
    owner: {platform_team: null}
    last_updated: '{iso8601_timestamp}'
    environment: [ci, runtime]
    schema:
    cross_layer: false
    notes:

  - name: validate_container_hash
    path: configs/ci/validate_container_hash.yml
    type: ci_test
    category: reproducibility
    semver: '{semver}'
    version: '{config_version}'
    digest: '{sha256}'
    manifest_key: mlr.4A.ci.validate_container_hash
    license: '{spdx_or_internal}'
    role: GH-action that asserts built image digest == Dockerfile.lock.
    dependencies:
    - Dockerfile_lock
    source: internal
    owner: {platform_team: null}
    last_updated: '{iso8601_timestamp}'
    environment: [ci]
    schema:
    cross_layer: false
    notes:

  - name: build_manifest
    path: artefacts/manifests/build.manifest
    type: manifest
    category: reproducibility
    semver: '{semver}'
    version: '{run_id}'
    digest: '{sha256}'
    manifest_key: mlr.4A.manifest.build
    license: '{spdx_or_internal}'
    role: Aggregates git tree, container digest, param hash & all artefact digests.
    dependencies:
    - pipeline_launcher
    - validate_container_hash
    - civil_time_manifest
    - routing_manifest
    - allocation_manifest
    - virtual_manifest
    source: internal
    owner: {platform_team: null}
    last_updated: '{iso8601_timestamp}'
    environment: [ci]
    schema:
    cross_layer: false
    notes:

      # 2 REGISTRY SCHEMA & LIVE INSTANCE
  - name: artefact_registry_schema
    path: configs/registry/artefact_registry.schema.json
    type: schema
    category: registry
    semver: '{semver}'
    version: '{schema_version}'
    digest: '{sha256}'
    manifest_key: mlr.4A.schema.registry
    license: '{spdx_or_internal}'
    role: JSON Schema defining shape & required fields of registry YAMLs.
    dependencies: []
    source: internal
    owner: {platform_team: null}
    last_updated: '{iso8601_timestamp}'
    environment: [ci, runtime]
    schema:
    cross_layer: false
    notes:

  - name: artefact_registry
    path: configs/registry/artefact_registry.yaml
    type: config
    category: registry
    semver: '{semver}'
    version: '{registry_version}'
    digest: '{sha256}'
    manifest_key: mlr.4A.config.registry
    license: '{spdx_or_internal}'
    role: Live registry instance enumerated by loader; validated at runtime.
    dependencies:
    - artefact_registry_schema
    source: internal
    owner: {platform_team: null}
    last_updated: '{iso8601_timestamp}'
    environment: [ci, runtime]
    schema: artefact_registry_schema
    cross_layer: false
    notes:

  - name: schemas_directory
    path: schema/
    type: directory
    category: schema_bundle
    semver: '{semver}'
    version: '{schema_bundle_version}'
    digest: '{sha256}'
    manifest_key: mlr.4A.dir.schemas
    license: '{spdx_or_internal}'
    role: Bundle of all domain JSON/Avro schemas (transaction, outlet, etc.).
    dependencies: []
    source: internal
    owner: {platform_team: null}
    last_updated: '{iso8601_timestamp}'
    environment: [ci, runtime]
    schema:
    cross_layer: false
    notes: Contains transaction_schema.avsc, site_catalogue.avsc, ...

      # 3 REGISTRY TOOLING & CONSISTENCY CHECKS
  - name: artefact_loader_py
    path: src/registry/artefact_loader.py
    type: code
    category: registry_tooling
    semver: '{code_semver}'
    version: '{git_commit}'
    digest: '{git_tree_hash}'
    manifest_key: mlr.4A.code.artefact_loader
    license: '{spdx_or_internal}'
    role: Parses registry YAML, validates against schema, loads into memory.
    dependencies:
    - artefact_registry_schema
    source: internal
    owner: {platform_team: null}
    last_updated: '{iso8601_timestamp}'
    environment: [dev, ci, runtime]
    schema:
    cross_layer: false
    notes:

  - name: compare_registry_py
    path: src/registry/compare_registry.py
    type: code
    category: registry_tooling
    semver: '{code_semver}'
    version: '{git_commit}'
    digest: '{git_tree_hash}'
    manifest_key: mlr.4A.code.compare_registry
    license: '{spdx_or_internal}'
    role: Diffs two registry YAMLs -> JSON patch; fails if undeclared change.
    dependencies:
    - artefact_registry
    source: internal
    owner: {platform_team: null}
    last_updated: '{iso8601_timestamp}'
    environment: [ci]
    schema:
    cross_layer: false
    notes:

  - name: register_dataset_sh
    path: scripts/register_dataset.sh
    type: script
    category: registry_tooling
    semver: '{code_semver}'
    version: '{git_commit}'
    digest: '{git_tree_hash}'
    manifest_key: mlr.4A.script.register_dataset
    license: '{spdx_or_internal}'
    role: Bash helper that appends new dataset block + re-hashes registry.
    dependencies:
    - artefact_registry
    source: internal
    owner: {data_ops_team: null}
    last_updated: '{iso8601_timestamp}'
    environment: [dev]
    schema:
    cross_layer: false
    notes:

      # 4 DATASET CATALOG & DDL GOVERNANCE
  - name: dataset_catalog
    path: db/dataset_catalog.ddl.sql
    type: code
    category: catalog_schema
    semver: '{semver}'
    version: '{ddl_version}'
    digest: '{sha256}'
    manifest_key: mlr.4A.ddl.dataset_catalog
    license: '{spdx_or_internal}'
    role: DDL creating Postgres table mapping `manifest_key → storage_uri`.
    dependencies: []
    source: internal
    owner: {data_ops_team: null}
    last_updated: '{iso8601_timestamp}'
    environment: [dev, staging]
    schema:
    cross_layer: false
    notes:

      # 5 RNG LOGGING & REPLAY INFRA
  - name: rng_logging_policy
    path: configs/rng/rng_logging.yml
    type: config
    category: rng_policy
    semver: '{semver}'
    version: '{config_version}'
    digest: '{sha256}'
    manifest_key: mlr.4A.config.rng_logging
    license: '{spdx_or_internal}'
    role: Enables Philox counter dumps for every segment; size budget 10 MiB.
    dependencies: []
    source: internal
    owner: {platform_team: null}
    last_updated: '{iso8601_timestamp}'
    environment: [runtime]
    schema:
    cross_layer: true
    notes:

  - name: global_rng_trace_log
    path: logs/rng/{run_id}/global_rng_trace.log
    type: log
    category: rng_audit
    semver: '{semver}'
    version: '{run_id}'
    digest: '{sha256}'
    manifest_key: mlr.4A.log.global_rng_trace
    license: '{spdx_or_internal}'
    role: Full Philox counter + key stream across all segments.
    dependencies: [rng_logging_policy]
    source: internal
    owner: {platform_team: null}
    last_updated: '{iso8601_timestamp}'
    environment: [runtime]
    schema:
    cross_layer: false
    notes:

  - name: replay_rng_py
    path: tools/replay_rng.py
    type: code
    category: rng_tooling
    semver: '{code_semver}'
    version: '{git_commit}'
    digest: '{git_tree_hash}'
    manifest_key: mlr.4A.code.replay_rng
    license: '{spdx_or_internal}'
    role: Replays RNG trace and asserts exact draw sequence for a given seed.
    dependencies: [global_rng_trace_log]
    source: internal
    owner: {qa_team: null}
    last_updated: '{iso8601_timestamp}'
    environment: [dev, ci]
    schema:
    cross_layer: false
    notes:

  - name: zoneinfo_version_yml
    path: configs/runtime/zoneinfo_version.yml
    type: config
    category: runtime_environment
    semver: '{semver}'
    version: '{config_version}'
    digest: '{sha256}'
    manifest_key: mlr.4A.config.zoneinfo_version
    license: '{spdx_or_internal}'
    role: Pins ICU / tzdata version—referenced by RNG tests that depend on DST.
    dependencies: []
    source: internal
    owner: {platform_team: null}
    last_updated: '{iso8601_timestamp}'
    environment: [runtime]
    schema:
    cross_layer: true
    notes:

      # 6 INFRA-HARDENING & SECURITY POLICIES
  - name: firewall_rules
    path: configs/infra/firewall.yml
    type: config
    category: infra_security
    semver: '{semver}'
    version: '{config_version}'
    digest: '{sha256}'
    manifest_key: mlr.4A.config.firewall
    license: '{spdx_or_internal}'
    role: Ingress CIDR allow-list + egress deny-list for batch workers.
    dependencies: []
    source: internal
    owner: {sre_team: null}
    last_updated: '{iso8601_timestamp}'
    environment: [runtime]
    schema:
    cross_layer: false
    notes:

  - name: nfs_export_policy_md
    path: docs/infra/nfs_export_policy.md
    type: documentation
    category: infra_security
    semver: '{semver}'
    version: '{doc_version}'
    digest: '{sha256}'
    manifest_key: mlr.4A.docs.nfs_export_policy
    license: '{spdx_or_internal}'
    role: Human-readable contract for NFS RW export rules (prod vs CI).
    dependencies: []
    source: internal
    owner: {sre_team: null}
    last_updated: '{iso8601_timestamp}'
    environment: [dev, ci, runtime]
    schema:
    cross_layer: false
    notes:

      # 7 FAILURE REPRODUCTION & AUDIT TOOLS
  - name: failure_reproducer_py
    path: tools/failure_reproducer.py
    type: code
    category: debug_tooling
    semver: '{code_semver}'
    version: '{git_commit}'
    digest: '{git_tree_hash}'
    manifest_key: mlr.4A.tool.failure_reproducer
    license: '{spdx_or_internal}'
    role: Given run_id + seed, replays RNG & data loaders for bug triage.
    dependencies:
    - global_rng_trace_log
    source: internal
    owner: {qa_team: null}
    last_updated: '{iso8601_timestamp}'
    environment: [dev]
    schema:
    cross_layer: false
    notes:

  - name: geo_audit_py
    path: tools/geo_audit.py
    type: code
    category: debug_tooling
    semver: '{code_semver}'
    version: '{git_commit}'
    digest: '{git_tree_hash}'
    manifest_key: mlr.4A.tool.geo_audit
    license: '{spdx_or_internal}'
    role: Scans output for impossible lat/lon combos (e.g. ocean points).
    dependencies:
    - schemas_directory
    source: internal
    owner: {qa_team: null}
    last_updated: '{iso8601_timestamp}'
    environment: [dev]
    schema:
    cross_layer: false
    notes:

      # 8 DATA-SCIENCE HARNESS & MODEL COEFFICIENTS
  - name: hurdle_coefficients_yaml
    path: config/models/hurdle_coefficients.yaml
    type: config
    category: model_params
    semver: '{semver}'
    version: '{coeff_version}'
    digest: '{sha256}'
    manifest_key: mlr.1A.config.hurdle_coefficients
    license: '{spdx_or_internal}'
    role: θ₀, θ₁, dispersion for hurdle NB model (cross-layer reference).
    dependencies: []
    source: internal
    owner: {data_science_team: null}
    last_updated: '{iso8601_timestamp}'
    environment: [runtime]
    schema:
    cross_layer: true
    notes:

  - name: footfall_coefficients_yaml
    path: configs/spatial/footfall_coefficients.yaml
    type: config
    category: model_params
    semver: '{semver}'
    version: '{coeff_version}'
    digest: '{sha256}'
    manifest_key: mlr.1B.footfall.coefficients
    license: '{spdx_or_internal}'
    role: GLM coefficients for footfall scaling (cross-layer reference).
    dependencies: []
    source: internal
    owner: {data_science_team: null}
    last_updated: '{iso8601_timestamp}'
    environment: [runtime]
    schema:
    cross_layer: true
    notes:

  - name: footfall_glm_harness_py
    path: src/ds/footfall_glm_harness.py
    type: code
    category: model_harness
    semver: '{code_semver}'
    version: '{git_commit}'
    digest: '{git_tree_hash}'
    manifest_key: mlr.4A.ds.footfall_glm_harness
    license: '{spdx_or_internal}'
    role: Loads footfall_coefficients + site_catalogue → predicts F_i.
    dependencies:
    - footfall_coefficients_yaml
    - site_catalogue
    source: internal
    owner: {data_science_team: null}
    last_updated: '{iso8601_timestamp}'
    environment: [dev]
    schema:
    cross_layer: false
    notes:

  - name: adversarial_xgb_model
    path: artefacts/models/adversarial_xgb.pkl
    type: model
    category: robustness
    semver: '{semver}'
    version: '{model_version}'
    digest: '{sha256}'
    manifest_key: mlr.4A.model.adversarial_xgb
    license: '{spdx_or_internal}'
    role: XGBoost classifier used for adversarial audit of synthetic data.
    dependencies: []
    source: internal
    owner: {qa_team: null}
    last_updated: '{iso8601_timestamp}'
    environment: [ci]
    schema:
    cross_layer: false
    notes:

      # 9 DST EDGE-CASE PASSER
  - name: dst_edge_passer_py
    path: tests/dst_edge_passer.py
    type: code
    category: time_validation
    semver: '{code_semver}'
    version: '{git_commit}'
    digest: '{git_tree_hash}'
    manifest_key: mlr.4A.test.dst_edge_passer
    license: '{spdx_or_internal}'
    role: Replays DST fold/gap transactions; asserts no TimeZoneLookupError.
    dependencies:
    - zoneinfo_version_yml
    source: internal
    owner: {qa_team: null}
    last_updated: '{iso8601_timestamp}'
    environment: [ci]
    schema:
    cross_layer: false
    notes:

  - name: dst_failures_csv
    path: artefacts/fixtures/dst_failures.csv
    type: dataset
    category: time_validation
    semver: '{semver}'
    version: '{fixture_version}'
    digest: '{sha256}'
    manifest_key: mlr.4A.fixtures.dst_failures
    license: '{spdx_or_internal}'
    role: Historical DST lookup failures for regression testing.
    dependencies: []
    source: internal
    owner: {qa_team: null}
    last_updated: '{iso8601_timestamp}'
    environment: [ci]
    schema:
    cross_layer: false
    notes:

      # 10 LICENSE DIRECTORY & VALIDATOR
  - name: licenses_directory
    path: LICENSES/
    type: directory
    category: licensing
    semver: '{semver}'
    version: '{license_bundle_version}'
    digest: '{sha256}'
    manifest_key: mlr.4A.dir.licenses
    license: Mixed
    role: Folder containing all third-party license texts referenced in registry.
    dependencies: []
    source: internal
    owner: {data_governance_team: null}
    last_updated: '{iso8601_timestamp}'
    environment: [ci, runtime]
    schema:
    cross_layer: false
    notes:

  - name: validate_licenses_py
    path: ci/tests/validate_licenses.py
    type: ci_test
    category: licensing
    semver: '{code_semver}'
    version: '{git_commit}'
    digest: '{git_tree_hash}'
    manifest_key: mlr.4A.ci.validate_licenses
    license: '{spdx_or_internal}'
    role: CI test ensuring every external artefact has license text & digest.
    dependencies:
    - licenses_directory
    - allocation_licenses_manifest
    - virtual_licenses_manifest
    source: internal
    owner: {qa_team: null}
    last_updated: '{iso8601_timestamp}'
    environment: [ci]
    schema:
    cross_layer: false
    notes:

      # 11 RELEASE BLOCKING CONFIGS
  - name: upload_to_hashgate_sh
    path: scripts/deploy/upload_to_hashgate.sh
    type: script
    category: release
    semver: '{code_semver}'
    version: '{git_commit}'
    digest: '{git_tree_hash}'
    manifest_key: mlr.4A.script.upload_to_hashgate
    license: '{spdx_or_internal}'
    role: Uploads build.manifest + registry digest to Hashgate notarization
    dependencies:
    - build_manifest
    source: internal
    owner: {sre_team: null}
    last_updated: '{iso8601_timestamp}'
    environment: [staging, prod]
    schema:
    cross_layer: false
    notes:

  - name: block_merge_yaml
    path: configs/ci/block_merge.yaml
    type: config
    category: release
    semver: '{semver}'
    version: '{config_version}'
    digest: '{sha256}'
    manifest_key: mlr.4A.config.block_merge
    license: '{spdx_or_internal}'
    role: GH Action config that blocks merge unless Hashgate receipt present.
    dependencies:
    - upload_to_hashgate_sh
    source: internal
    owner: {sre_team: null}
    last_updated: '{iso8601_timestamp}'
    environment: [ci]
    schema:
    cross_layer: false
    notes:

      # Cross-layer reference for site catalogue (used by footfall harness)
  - name: site_catalogue
    path: data/outputs/1B/site_catalogue/seed={seed}/fingerprint={manifest_fingerprint}/
    type: dataset
    category: input
    semver: '{semver}'
    version: '{manifest_fingerprint}'
    digest: '{sha256}'
    manifest_key: mlr.1B.output.site_catalogue
    license: '{spdx_or_internal}'
    role: Cross-layer site catalogue consumed by footfall_glm_harness_py.
    dependencies: [site_catalogue_schema]
    source: internal
    owner: {platform_team: null}
    last_updated: '{iso8601_timestamp}'
    environment: [runtime]
    schema: site_catalogue_schema
    cross_layer: true
    notes:

      # Cross-layer roll-up of licenses from allocation subsegment (3A)
  - name: allocation_licenses_manifest
    path: artefacts/manifests/allocation_licenses_manifest.json
    type: manifest
    category: licensing
    semver: '{semver}'
    version: '{run_id}'
    digest: '{sha256}'
    manifest_key: allocation_licenses_digest
    license: {spdx_or_internal: null}
    role: Roll-up manifest of license digests for allocation artefacts.
    dependencies: []
    source: internal
    owner: {data_governance_team: null}
    last_updated: '{iso8601_timestamp}'
    environment: [ci, runtime]
    schema:
    cross_layer: true
    notes:

      # Cross-layer roll-up of licenses from virtual subsegment (3B)
  - name: virtual_licenses_manifest
    path: artefacts/manifests/virtual_licenses_manifest.json
    type: manifest
    category: licensing
    semver: '{semver}'
    version: '{run_id}'
    digest: '{sha256}'
    manifest_key: mlr.3B.manifest.licenses
    license: '{spdx_or_internal}'
    role: Roll-up manifest of license digests for virtual artefacts.
    dependencies: []
    source: internal
    owner: {data_governance_team: null}
    last_updated: '{iso8601_timestamp}'
    environment: [ci]
    schema:
    cross_layer: true
    notes:

  - name: routing_manifest
    path: artefacts/manifests/routing_manifest.json
    type: manifest
    category: provenance
    semver: '{semver}'
    version: '{run_id}'
    digest: '{sha256}'
    manifest_key: mlr.2B.manifest.routing
    license: '{spdx_or_internal}'
    role: Digest roll-up for 2B routing outputs/configs.
    dependencies: []
    source: internal
    owner: {platform_team: null}
    last_updated: '{iso8601_timestamp}'
    environment: [runtime]
    schema:
    cross_layer: true
    notes:

      # 4A — REGISTRY LOCK
  - name: registry_lock_manifest
    path: artefacts/manifests/registry_lock_{date}.json
    type: manifest
    category: reproducibility
    semver: '{semver}'
    version: '{date}'
    digest: '{sha256}'
    manifest_key: mlr.4A.manifest.registry_lock
    license: '{spdx_or_internal}'
    role: Frozen snapshot of all artefact registries (1A–4B) and key cross-layer digests.
    dependencies:
    - artefact_registry                       # the consolidated YAML
    - build_manifest                          # existing 4A roll-up
    - validator_build_manifest                # 4B env+container lock
    - tz_polygon_digest                       # 2A
    - tz_index_digest                         # 2A
    - civil_time_manifest                     # 2A
    - zoneinfo_digest                         # 2A→4B cross-layer
    source: internal
    owner: {platform_team: null}
    last_updated: '{iso8601_timestamp}'
    environment: [ci, runtime]
    cross_layer: true
    notes: Any change to registries or cross-layer digests requires a break-glass.

  - name: tz_polygon_digest
    path: artefacts/manifests/tz_polygon_digest.txt
    type: manifest
    category: spatial_digests
    semver: '{semver}'
    version: '{run_id}'
    digest: '{sha256}'
    manifest_key: mlr.2A.manifest.tz_polygon_digest
    license: '{spdx_or_internal}'
    role: SHA-256 of tz-world polygons.
    source: internal
    owner: {platform_team: null}
    last_updated: '{iso8601_timestamp}'
    environment: [runtime]
    cross_layer: true
    notes:

  - name: tz_index_digest
    path: artefacts/manifests/tz_index_digest.txt
    type: manifest
    category: spatial_digests
    semver: '{semver}'
    version: '{run_id}'
    digest: '{sha256}'
    manifest_key: mlr.2A.manifest.tz_index_digest
    license: '{spdx_or_internal}'
    role: SHA-256 of tz index.
    source: internal
    owner: {platform_team: null}
    last_updated: '{iso8601_timestamp}'
    environment: [runtime]
    cross_layer: true
    notes:

  - name: zoneinfo_digest
    path: artefacts/manifests/zoneinfo_digest.txt
    type: manifest
    category: runtime_environment
    semver: '{semver}'
    version: '{run_id}'
    digest: '{sha256}'
    manifest_key: mlr.2A.manifest.zoneinfo_digest
    license: '{spdx_or_internal}'
    role: Digest of zoneinfo build.
    source: internal
    owner: {platform_team: null}
    last_updated: '{iso8601_timestamp}'
    environment: [runtime]
    cross_layer: true
    notes:

  - name: validator_build_manifest
    path: artefacts/manifests/validator_build.manifest
    type: manifest
    category: reproducibility
    semver: '{semver}'
    version: '{run_id}'
    digest: '{sha256}'
    manifest_key: mlr.4B.manifest.validator_build
    license: '{spdx_or_internal}'
    role: Digest roll-up for validator container & code.
    source: internal
    owner: {platform_team: null}
    last_updated: '{iso8601_timestamp}'
    environment: [ci]
    cross_layer: true
    notes:

      # 3A roll-up
  - name: allocation_manifest
    path: artefacts/manifests/allocation_manifest.json
    type: manifest
    category: provenance
    semver: '{semver}'
    version: '{run_id}'
    digest: '{sha256}'
    manifest_key: mlr.3A.manifest.allocation
    license: '{spdx_or_internal}'
    role: Digest bundle of 3A zone-allocation outputs/configs.
    source: internal
    owner: {platform_team: null}
    last_updated: '{iso8601_timestamp}'
    environment: [runtime]
    schema:
    cross_layer: true
    notes:

      # 3B roll-up
  - name: virtual_manifest
    path: artefacts/manifests/virtual_manifest.json
    type: manifest
    category: provenance
    semver: '{semver}'
    version: '{run_id}'
    digest: '{sha256}'
    manifest_key: mlr.3B.manifest.virtual
    license: '{spdx_or_internal}'
    role: Digest bundle of 3B virtual inputs/outputs/configs.
    source: internal
    owner: {platform_team: null}
    last_updated: '{iso8601_timestamp}'
    environment: [runtime]
    schema:
    cross_layer: true
    notes:

      # 2A roll-up
  - name: civil_time_manifest
    path: artefacts/manifests/civil_time_manifest.json
    type: manifest
    category: provenance
    semver: '{semver}'
    version: '{run_id}'
    digest: '{sha256}'
    manifest_key: mlr.2A.manifest.civil_time
    license: '{spdx_or_internal}'
    role: Cross-layer digest roll-up from 2A.
    source: internal
    owner: {platform_team: null}
    last_updated: '{iso8601_timestamp}'
    environment: [runtime]
    schema:
    cross_layer: true
    notes:
