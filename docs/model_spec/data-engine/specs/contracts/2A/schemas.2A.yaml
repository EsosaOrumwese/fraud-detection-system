version: '1.0'
$id: schemas.2A.yaml
$schema: https://json-schema.org/draft/2020-12/schema
description: "Layer-1 · Segment 2A (Civil Time) — schema pack. JSON-Schema is the sole shape authority."

$defs:
  hex64:
    $ref: 'schemas.layer1.yaml#/$defs/hex64'
  uint64:
    $ref: 'schemas.layer1.yaml#/$defs/uint64'
  iso2:
    $ref: 'schemas.layer1.yaml#/$defs/iso2'
  rfc3339_micros:
    $ref: 'schemas.layer1.yaml#/$defs/rfc3339_micros'
  iana_tzid:
    $ref: 'schemas.layer1.yaml#/$defs/iana_tzid'

# ── Validation / Receipts ─────────────────────────────────────────────────
model: {}

prep: {}

validation:

  s0_gate_receipt_v1:
    type: table
    description: "Fingerprint-scoped receipt proving 1B PASS and freezing the sealed-inputs manifest for 2A."
    primary_key: [manifest_fingerprint]
    partition_keys: [fingerprint]
    sort_keys: []
    columns_strict: true
    columns:
      - { name: manifest_fingerprint, $ref: 'schemas.layer1.yaml#/$defs/hex64', nullable: false,
          description: "MUST byte-equal fingerprint path token (path↔embed equality)." }
      - { name: parameter_hash, $ref: 'schemas.layer1.yaml#/$defs/hex64', nullable: false,
          description: "Run lineage token recorded for S0 (not a partition in S0)." }
      - { name: validation_bundle_path, type: string, nullable: false,
          description: "Dictionary-resolved path to 1B bundle for the same fingerprint." }
      - { name: flag_sha256_hex, $ref: 'schemas.layer1.yaml#/$defs/hex64', nullable: false,
          description: "Value proven from 1B _passed.flag." }
      - { name: verified_at_utc, $ref: 'schemas.layer1.yaml#/$defs/rfc3339_micros', nullable: false }
      - name: sealed_inputs
        type: array
        nullable: false
        description: "Every asset sealed by S0 (id, partitions, schema_ref)."
        items:
          type: object
          additionalProperties: false
          required: [id, partition, schema_ref]
          properties:
            id: { type: string, minLength: 1 }
            partition: { type: array, items: { type: string }, description: 'Partition keys, e.g. ["seed","fingerprint"] or ["parameter_hash"].' }
            schema_ref: { type: string, minLength: 1 }
      - { name: notes, type: string, nullable: true }

  # S4 legality evidence (referenced by Dictionary/Registry)
  s4_legality_report:
    type: object
    additionalProperties: false
    required: [manifest_fingerprint, seed, generated_utc, status, counts]
    properties:
      manifest_fingerprint: { $ref: 'schemas.layer1.yaml#/$defs/hex64' }
      seed:                 { $ref: 'schemas.layer1.yaml#/$defs/uint64' }
      generated_utc:        { $ref: 'schemas.layer1.yaml#/$defs/rfc3339_micros' }
      status:               { type: string, enum: [PASS, FAIL] }
      counts:
        type: object
        additionalProperties: false
        required: [sites_total, tzids_total, gap_windows_total, fold_windows_total]
        properties:
          sites_total:        { $ref: 'schemas.layer1.yaml#/$defs/uint64' }
          tzids_total:        { $ref: 'schemas.layer1.yaml#/$defs/uint32' }
          gap_windows_total:  { $ref: 'schemas.layer1.yaml#/$defs/uint64' }
          fold_windows_total: { $ref: 'schemas.layer1.yaml#/$defs/uint64' }
      missing_tzids:
        type: array
        items: { $ref: 'schemas.layer1.yaml#/$defs/iana_tzid' }
      notes: { type: string }

  # 2A validation bundle (S5) — same index law as 1A/1B; keep structure modest
  validation_bundle_2A:
    description: "Bundle certifying a 2A publish for a given manifest_fingerprint (No PASS → No read for 2A egress)."
    type: object
    additionalProperties: false
    properties:
      index_json:   { $ref: '#/validation/bundle_index_v1' }
      checks_json:  { $ref: '#/validation/checks_v1' }
      metrics_json: { $ref: '#/validation/metrics_v1' }
    required: [index_json]

  bundle_index_v1:
    type: object
    additionalProperties: false
    properties:
      files:
        type: array
        minItems: 1
        items:
          type: object
          additionalProperties: false
          properties:
            path:       { type: string, minLength: 1 }
            sha256_hex: { $ref: 'schemas.layer1.yaml#/$defs/hex64' }
          required: [path, sha256_hex]
    required: [files]

  checks_v1:
    type: object
    additionalProperties: false
    properties:
      fingerprint:      { $ref: 'schemas.layer1.yaml#/$defs/hex64' }
      generated_at_utc: { $ref: 'schemas.layer1.yaml#/$defs/rfc3339_micros' }
      overall_status:   { type: string, enum: [PASS, FAIL] }
      datasets:
        type: array
        items:
          type: object
          additionalProperties: false
          properties:
            id:      { type: string }
            status:  { type: string, enum: [PASS, FAIL] }
            notes:   { type: string }
    required: [fingerprint, generated_at_utc, overall_status]

  metrics_v1:
    type: object
    additionalProperties: true   # intentionally loose; not identity-bearing

  passed_flag:
    type: string
    description: "Single line: 'sha256_hex = <hex64>' per index+ASCII-lex+raw-bytes law."
    pattern: '^sha256_hex = [a-f0-9]{64}$'

# ── Manifests (diagnostics) ───────────────────────────────────────────────
manifests:

  sealed_inputs_v1:
    type: table
    description: "Row-wise inventory of sealed assets for 2A fingerprint."
    primary_key: [manifest_fingerprint, asset_id]
    partition_keys: [fingerprint]
    sort_keys: [asset_kind, basename]
    columns_strict: true
    columns:
      - { name: manifest_fingerprint, $ref: 'schemas.layer1.yaml#/$defs/hex64', nullable: false }
      - { name: asset_id, type: string, nullable: false }
      - { name: asset_kind, type: string, enum: [dataset, bundle, log, manifest, config], nullable: false }
      - { name: basename, type: string, nullable: false }
      - { name: version_tag, type: string, nullable: false }
      - { name: schema_ref, type: string, nullable: false }
      - { name: catalog_path, type: string, nullable: false }
      - { name: sha256_hex, $ref: 'schemas.layer1.yaml#/$defs/hex64', nullable: false }
      - { name: size_bytes, $ref: 'schemas.layer1.yaml#/$defs/uint64', nullable: false }
      - { name: license_class, type: string, nullable: false }
      - { name: created_utc, $ref: 'schemas.layer1.yaml#/$defs/rfc3339_micros', nullable: false }

# ── Ingress / Policy (sealed in S0) ───────────────────────────────────────
ingress:

  tzdb_release_v1:
    type: object
    additionalProperties: false
    required: [release_tag, archive_sha256]
    properties:
      release_tag: { type: string, pattern: '^20[0-9]{2}[a-z]?$' }
      archive_sha256: { $ref: 'schemas.layer1.yaml#/$defs/hex64' }

policy:

  tz_overrides_v1:
    type: array
    description: "Governed override list; precedence declared site » mcc » country."
    items:
      type: object
      additionalProperties: false
      required: [scope, target, tzid]
      properties:
        scope:   { type: string, enum: [site, mcc, country] }
        target:  { type: string, minLength: 1 }      # site_id or MCC or ISO-2
        tzid:    { $ref: 'schemas.layer1.yaml#/$defs/iana_tzid' }
        evidence_url: { type: string, nullable: true }
        expiry_yyyy_mm_dd: { type: string, pattern: '^[0-9]{4}-[0-9]{2}-[0-9]{2}$', nullable: true }
        notes:   { type: string, nullable: true }

  tz_nudge_v1:
    type: object
    additionalProperties: false
    required: [semver, epsilon_degrees, sha256_digest]
    properties:
      semver: { type: string }
      epsilon_degrees: { type: number, exclusiveMinimum: 0.0 }
      sha256_digest: { $ref: 'schemas.layer1.yaml#/$defs/hex64' }

# ── Plan / Egress / Cache (downstream states) ─────────────────────────────
plan:

  s1_tz_lookup:
    type: table
    description: "Per-site provisional tz lookup inputs/outputs for 2A.S1."
    primary_key: [merchant_id, legal_country_iso, site_order]
    partition_keys: [seed, fingerprint]
    sort_keys: [merchant_id, legal_country_iso, site_order]
    columns_strict: true
    columns:
      - { name: seed,               $ref: '#/$defs/uint64',                    nullable: false }
      - { name: fingerprint,        $ref: '#/$defs/hex64',                     nullable: false }
      - { name: merchant_id,        $ref: 'schemas.layer1.yaml#/$defs/id64',   nullable: false }
      - { name: legal_country_iso,  $ref: 'schemas.layer1.yaml#/$defs/iso2',   nullable: false }
      - { name: site_order,         type: integer, minimum: 1,                 nullable: false }
      - { name: lat_deg,            type: number,                              nullable: false }
      - { name: lon_deg,            type: number,                              nullable: false }
      - { name: tzid_provisional,   $ref: '#/$defs/iana_tzid',                 nullable: false }
      - { name: nudge_lat_deg,      type: number,                              nullable: true }
      - { name: nudge_lon_deg,      type: number,                              nullable: true }
      - { name: created_utc,        $ref: '#/$defs/rfc3339_micros',            nullable: false }

egress:

  site_timezones:
    type: table
    description: "Per-site assigned IANA tzid with provenance."
    primary_key: [merchant_id, legal_country_iso, site_order]
    partition_keys: [seed, fingerprint]
    sort_keys: [merchant_id, legal_country_iso, site_order]
    columns_strict: true
    columns:
      - { name: seed,               $ref: '#/$defs/uint64',                    nullable: false }
      - { name: fingerprint,        $ref: '#/$defs/hex64',                     nullable: false }
      - { name: merchant_id,        $ref: 'schemas.layer1.yaml#/$defs/id64',   nullable: false }
      - { name: legal_country_iso,  $ref: 'schemas.layer1.yaml#/$defs/iso2',   nullable: false }
      - { name: site_order,         type: integer, minimum: 1,                 nullable: false }
      - { name: tzid,               $ref: '#/$defs/iana_tzid',                 nullable: false }
      - { name: tzid_source,        type: string, enum: [polygon, override],   nullable: false }
      - { name: override_scope,     type: string, enum: [site, mcc, country],  nullable: true }
      - { name: nudge_lat_deg,      type: number,                              nullable: true }
      - { name: nudge_lon_deg,      type: number,                              nullable: true }
      - { name: created_utc,        $ref: '#/$defs/rfc3339_micros',            nullable: false }

cache:

  tz_timetable_cache:
    type: object
    description: "Fingerprint-scoped manifest for compact tz transition tables."
    additionalProperties: false
    required: [manifest_fingerprint, tzdb_release_tag, tzdb_archive_sha256, tz_index_digest, rle_cache_bytes, created_utc]
    properties:
      manifest_fingerprint: { $ref: 'schemas.layer1.yaml#/$defs/hex64' }
      tzdb_release_tag:     { type: string }
      tzdb_archive_sha256:  { $ref: 'schemas.layer1.yaml#/$defs/hex64' }
      tz_index_digest:      { $ref: 'schemas.layer1.yaml#/$defs/hex64' }
      rle_cache_bytes:      { $ref: 'schemas.layer1.yaml#/$defs/uint64' }
      created_utc:          { $ref: 'schemas.layer1.yaml#/$defs/rfc3339_micros' }
