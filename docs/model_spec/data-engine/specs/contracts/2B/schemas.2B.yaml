# Layer-1 · Segment 2B — Schema Pack
title: "Layer-1 · Segment 2B — Schema Pack"

$defs:
  hex64:
    type: string
    pattern: "^[a-f0-9]{64}$"
  partition_kv:
    type: object
    additionalProperties:
      type: string
    minProperties: 0

validation:
  s0_gate_receipt_v1:
    type: object
    additionalProperties: false
    required:
      - manifest_fingerprint
      - seed
      - parameter_hash
      - verified_at_utc
      - sealed_inputs
      - catalogue_resolution
      - determinism_receipt
    properties:
      manifest_fingerprint:
        $ref: "#/$defs/hex64"
      seed:
        $ref: "schemas.layer1.yaml#/$defs/uint64"
      parameter_hash:
        $ref: "#/$defs/hex64"
      verified_at_utc:
        $ref: "schemas.layer1.yaml#/$defs/rfc3339_micros"
      sealed_inputs:
        type: array
        items:
          type: object
          additionalProperties: false
          required: [id, partition, schema_ref]
          properties:
            id:
              type: string
              minLength: 1
            partition:
              $ref: "#/$defs/partition_kv"
            schema_ref:
              type: string
              minLength: 1
      catalogue_resolution:
        type: object
        additionalProperties: false
        required: [dictionary_version, registry_version]
        properties:
          dictionary_version:
            type: string
            minLength: 1
          registry_version:
            type: string
            minLength: 1
      determinism_receipt:
        type: object
        additionalProperties: false
        properties:
          engine_commit:
            type: string
          python_version:
            type: string
          platform:
            type: string
          policy_ids:
            type: array
            items: { type: string }
          policy_digests:
            type: array
            items: { $ref: "#/$defs/hex64" }

  sealed_inputs_v1:
    type: array
    items:
      type: object
      additionalProperties: false
      required: [asset_id, version_tag, sha256_hex, path, partition]
      properties:
        asset_id:
          type: string
          minLength: 1
        version_tag:
          type: string
          minLength: 1
        sha256_hex:
          $ref: "#/$defs/hex64"
        path:
          type: string
          minLength: 1
        partition:
          $ref: "#/$defs/partition_kv"
        schema_ref:
          type: string

# Policy anchors (captured by S0; shapes intentionally permissive)
policy:
  route_rng_policy_v1:
    type: object
    additionalProperties: true
  alias_layout_policy_v1:
    type: object
    additionalProperties: true
  day_effect_policy_v1:
    type: object
    additionalProperties: true

# ── Plan (downstream states) ─────────────────────────────────────────────
plan:

  s1_site_weights:
    type: table
    description: "Per-merchant per-site frozen probability law (RNG-free)."
    primary_key: [merchant_id, legal_country_iso, site_order]
    partition_keys: [seed, fingerprint]
    sort_keys: [merchant_id, legal_country_iso, site_order]
    columns_strict: true
    columns:
      - { name: merchant_id,        $ref: 'schemas.layer1.yaml#/$defs/id64',            nullable: false }
      - { name: legal_country_iso,  $ref: 'schemas.layer1.yaml#/$defs/iso2',            nullable: false }
      - { name: site_order,         type: integer, minimum: 1,                          nullable: false }
      - { name: p_weight,           type: number,  minimum: 0.0, maximum: 1.0,          nullable: false,
          description: "Normalised weight; Σ per-merchant = 1 within policy ε." }
      - { name: weight_source,      type: string,  minLength: 1,                         nullable: false,
          description: "Policy-declared source/transform used for weights." }
      - { name: quantised_bits,     type: integer, minimum: 1,                           nullable: false,
          description: "Bit-depth b used by S2 alias construction." }
      - { name: floor_applied,      type: boolean,                                       nullable: false,
          description: "True if a floor or zero-mass fallback affected this row." }
      - { name: created_utc,        $ref: 'schemas.layer1.yaml#/$defs/rfc3339_micros',   nullable: false,
          description: "Echo of S0 verified_at_utc for this fingerprint." }


  s2_alias_index:
    type: object
    description: "Directory for alias blob plus per-merchant slices."
    additionalProperties: false
    required:
      - layout_version
      - endianness
      - alignment_bytes
      - quantised_bits
      - created_utc
      - policy_id
      - policy_digest
      - blob_sha256
      - blob_size_bytes
      - merchants_count
      - merchants
    properties:
      layout_version:   { type: string, minLength: 1 }
      endianness:       { type: string, enum: [little, big] }
      alignment_bytes:  { type: integer, minimum: 1 }
      quantised_bits:   { type: integer, minimum: 1 }
      created_utc:      { $ref: 'schemas.layer1.yaml#/$defs/rfc3339_micros' }
      policy_id:        { type: string, const: "alias_layout_policy_v1" }
      policy_digest:    { $ref: "#/$defs/hex64" }
      blob_sha256:      { $ref: "#/$defs/hex64" }
      blob_size_bytes:  { type: integer, minimum: 0 }
      merchants_count:  { type: integer, minimum: 0 }
      merchants:
        type: array
        items:
          type: object
          additionalProperties: false
          required: [merchant_id, offset, length, sites, quantised_bits, checksum]
          properties:
            merchant_id:    { $ref: 'schemas.layer1.yaml#/$defs/id64' }
            offset:         { type: integer, minimum: 0 }
            length:         { type: integer, minimum: 1 }
            sites:          { type: integer, minimum: 1 }
            quantised_bits: { type: integer, minimum: 1 }
            checksum:       { type: string, pattern: '^[A-Fa-f0-9]+$' }

  s3_day_effects:
    type: table
    description: "Per-merchant × per-UTC-day × per-tz-group gamma multipliers (log-normal; Philox provenance)."
    primary_key: [merchant_id, utc_day, tz_group_id]
    partition_keys: [seed, fingerprint]
    sort_keys: [merchant_id, utc_day, tz_group_id]
    columns_strict: true
    columns:
      - { name: merchant_id,        $ref: 'schemas.layer1.yaml#/$defs/id64',            nullable: false }
      - { name: utc_day,            type: string, format: date,                         nullable: false }
      - { name: tz_group_id,        type: string,  minLength: 1,                        nullable: false }
      - { name: gamma,              type: number,  exclusiveMinimum: 0.0,               nullable: false }
      - { name: log_gamma,          type: number,                                       nullable: false }
      - { name: sigma_gamma,        type: number,  exclusiveMinimum: 0.0,               nullable: false }
      - { name: rng_stream_id,      type: string,  minLength: 1,                        nullable: false }
      - { name: rng_counter_lo,     type: integer, minimum: 0, maximum: 18446744073709551615, nullable: false }
      - { name: rng_counter_hi,     type: integer, minimum: 0, maximum: 18446744073709551615, nullable: false }
      - { name: created_utc,        $ref: 'schemas.layer1.yaml#/$defs/rfc3339_micros',  nullable: false }
  s4_group_weights:
    type: table
    description: "Per-merchant × per-UTC-day × per-tz-group day-specific routing mix (RNG-free)."
    primary_key: [merchant_id, utc_day, tz_group_id]
    partition_keys: [seed, fingerprint]
    sort_keys: [merchant_id, utc_day, tz_group_id]
    columns_strict: true
    columns:
      - { name: merchant_id,  $ref: 'schemas.layer1.yaml#/$defs/id64',           nullable: false }
      - { name: utc_day,      type: string, format: date,                        nullable: false }
      - { name: tz_group_id,  type: string, minLength: 1,                        nullable: false }
      - { name: p_group,      type: number, minimum: 0.0, maximum: 1.0,          nullable: false }
      - { name: base_share,   type: number, minimum: 0.0, maximum: 1.0,          nullable: false }
      - { name: gamma,        type: number, exclusiveMinimum: 0.0,               nullable: false }
      - { name: created_utc,  $ref: 'schemas.layer1.yaml#/$defs/rfc3339_micros', nullable: false }
      - { name: mass_raw,     type: number, minimum: 0.0,                        nullable: true }
      - { name: denom_raw,    type: number, minimum: 0.0,                        nullable: true }

  s2_alias_blob:
    type: object
    description: "Binary contract for contiguous alias tables blob."
    additionalProperties: false
    required: [layout_version, endianness, alignment_bytes]
    properties:
      layout_version:  { type: string, minLength: 1 }
      endianness:      { type: string, enum: [little, big] }
      alignment_bytes: { type: integer, minimum: 1 }


