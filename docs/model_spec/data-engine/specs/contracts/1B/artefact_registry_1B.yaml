subsegments:
- id: 1B
  name: Site Geolocation
  artifacts:

  - name: s0_gate_receipt_1B
    path: data/layer1/1B/s0_gate_receipt/fingerprint={manifest_fingerprint}/s0_gate_receipt.json
    type: dataset
    category: validation
    semver: '{semver}'
    version: '{manifest_fingerprint}'
    digest: '{sha256}'
    manifest_key: mlr.1B.validation.s0_gate_receipt
    license: Proprietary-Internal
    role: Receipt proving 1A PASS for fingerprint; enumerates sealed inputs authorised for 1B.
    dependencies: [validation_bundle_1A, validation_passed_flag]
    source: internal
    owner: {owner_team: "mlr-1b-core"}
    last_updated: '{iso8601_timestamp}'
    environment: [runtime]
    schema: schemas.1B.yaml#/validation/s0_gate_receipt
    cross_layer: false
    notes: 'Partition: fingerprint={manifest_fingerprint}; path↔embed equality enforced.'

  # Cross-layer inputs explicitly referenced by 1B.S0 (gating semantics live in 1A bundle/flag)
  - name: validation_bundle_1A
    path: data/layer1/1A/validation/fingerprint={manifest_fingerprint}/
    type: dataset
    category: validation
    semver: '{semver}'
    version: '{manifest_fingerprint}'
    digest: '{sha256}'
    manifest_key: mlr.1A.validation.bundle
    license: Proprietary-Internal
    role: Validator outputs for 1A (basis of consumer gate for outlet_catalogue).
    dependencies: [outlet_catalogue]
    source: internal
    owner: {owner_team: "mlr-1a-validation"}
    last_updated: '{iso8601_timestamp}'
    environment: [ci, runtime]
    schema: schemas.1A.yaml#/validation/validation_bundle
    cross_layer: true
    notes: 'S0 computes SHA-256 over ASCII-lex index (bundle index) to verify _passed.flag. Retention per Dictionary.'

  - name: validation_passed_flag
    path: data/layer1/1A/validation/fingerprint={manifest_fingerprint}/_passed.flag
    type: manifest
    category: validation
    semver: '{semver}'
    version: '{manifest_fingerprint}'
    digest: '{sha256_of_bundle}'
    manifest_key: mlr.1A.validation.passed
    license: Proprietary-Internal
    role: Boolean hash gate for 1A bundle; S0 must verify before any read of outlet_catalogue.
    dependencies: [validation_bundle_1A]
    source: internal
    owner: {owner_team: "mlr-1a-validation"}
    last_updated: '{iso8601_timestamp}'
    environment: [ci, runtime]
    schema:
    cross_layer: true
    notes: 'Content is a single line: "sha256_hex = <hex64>". Digest equals SHA-256 of the bundle = concat(raw bytes of all files listed in index.json in ASCII-lex path order), excluding the flag itself.'

  - name: outlet_catalogue
    path: data/layer1/1A/outlet_catalogue/seed={seed}/fingerprint={manifest_fingerprint}/
    type: dataset
    category: output
    semver: '{semver}'
    version: '{manifest_fingerprint}'
    digest: '{sha256}'
    manifest_key: mlr.1A.output.outlet_catalogue
    license: Proprietary-Internal
    role: Immutable outlet stubs; order-free (join S3 for inter-country order). Read only after verifying _passed.flag.
    dependencies: [s3_candidate_set]
    source: internal
    owner: {owner_team: "mlr-1a-core"}
    last_updated: '{iso8601_timestamp}'
    environment: [runtime]
    schema: schemas.1A.yaml#/egress/outlet_catalogue
    cross_layer: true
    notes:

  - name: s3_candidate_set
    path: data/layer1/1A/s3_candidate_set/parameter_hash={parameter_hash}/
    type: dataset
    category: allocation
    semver: '{semver}'
    version: '{parameter_hash}'
    digest: '{sha256}'
    manifest_key: mlr.1A.s3.candidate_set
    license: 'Proprietary-Internal'
    role: Deterministic ordered candidate set; sole inter-country order authority used by 1B consumers via join.
    dependencies: []
    source: internal
    owner: {owner_team: "mlr-1a-core"}
    last_updated: '{iso8601_timestamp}'
    environment: [runtime]
    schema: schemas.1A.yaml#/s3/candidate_set
    cross_layer: true
    notes:


  # External reference inputs mirrored for license/provenance and single-pane visibility
  - name: iso3166_canonical_2024
    path: reference/iso/iso3166_canonical/2024-12-31/iso3166.parquet
    type: dataset
    category: reference
    semver: '{semver}'
    version: '2024-12-31'
    digest: '{sha256}'
    manifest_key: mlr.ingress.iso3166_canonical_2024
    license: CC-BY-4.0
    role: Canonical ISO-3166-1 alpha-2 list; FK target for country_iso.
    dependencies: []
    source: external
    owner: {owner_team: "mlr-ingress"}
    last_updated: '{iso8601_timestamp}'
    environment: [runtime]
    schema: schemas.ingress.layer1.yaml#/iso3166_canonical_2024
    cross_layer: true
    notes:

  - name: world_countries
    path: reference/spatial/world_countries/2024/world_countries.parquet
    type: dataset
    category: reference
    semver: '{semver}'
    version: '2024'
    digest: '{sha256}'
    manifest_key: mlr.ingress.world_countries
    license: ODbL-1.0
    role: Country boundary polygons used for geo conformance checks.
    dependencies: [iso3166_canonical_2024]
    source: external
    owner: {owner_team: "mlr-ingress"}
    last_updated: '{iso8601_timestamp}'
    environment: [runtime]
    schema: schemas.ingress.layer1.yaml#/world_countries
    cross_layer: true
    notes:

  - name: population_raster_2025
    path: reference/spatial/population/2025/population.tif
    type: dataset
    category: reference
    semver: '{semver}'
    version: '2025'
    digest: '{sha256}'
    manifest_key: mlr.ingress.population_raster_2025
    license: ODbL-1.0
    role: Population raster used as spatial prior in 1B.
    dependencies: []
    source: external
    owner: {owner_team: "mlr-ingress"}
    last_updated: '{iso8601_timestamp}'
    environment: [runtime]
    schema: schemas.ingress.layer1.yaml#/population_raster_2025
    cross_layer: true
    notes:

  - name: tz_world_2025a
    path: reference/spatial/tz_world/2025a/tz_world.parquet
    type: dataset
    category: reference
    semver: '{semver}'
    version: '2025a'
    digest: '{sha256}'
    manifest_key: mlr.ingress.tz_world_2025a
    license: ODbL-1.0
    role: Time-zone polygons used for civil-time legality checks.
    dependencies: [world_countries]
    source: external
    owner: {owner_team: "mlr-ingress"}
    last_updated: '{iso8601_timestamp}'
    environment: [runtime]
    schema: schemas.ingress.layer1.yaml#/tz_world_2025a
    cross_layer: true
    notes:

  - name: tile_index
    path: data/layer1/1B/tile_index/parameter_hash={parameter_hash}/
    type: dataset
    category: prep
    semver: '{semver}'
    version: '{parameter_hash}'
    digest: '{sha256}'
    manifest_key: mlr.1B.s1.tile_index
    license: Proprietary-Internal
    role: Eligible raster cells per country (deterministic, RNG-free).
    dependencies: [iso3166_canonical_2024, world_countries, population_raster_2025]
    source: internal
    owner: {owner_team: "mlr-1b-core"}
    environment: [runtime]
    schema: schemas.1B.yaml#/prep/tile_index
    notes: 'Partition: parameter_hash={parameter_hash}; writer sort: [country_iso,tile_id].'

  # ---- S2 output dataset ----
  - name: tile_weights
    path: data/layer1/1B/tile_weights/parameter_hash={parameter_hash}/
    type: dataset
    category: prep
    semver: '{semver}'
    version: '{parameter_hash}'
    digest: '{sha256}'
    manifest_key: mlr.1B.s2.tile_weights
    license: Proprietary-Internal
    role: "Deterministic fixed-dp weights per eligible tile"
    dependencies: [tile_index]
    source: internal
    owner: {owner_team: "mlr-1b-core"}
    environment: [runtime]
    schema: schemas.1B.yaml#/prep/tile_weights
    notes: |
      S2 output- deterministic fixed-decimal (fixed-dp) weights per eligible tile.
      Depends on S1 `tile_index` for the same {parameter_hash}.
      Writer sort is [country_iso, tile_id]; write-once under parameter_hash.
      When basis="population", the implementation reads ingress `population_raster_2025` (read-only).

  # ---- S3 output dataset ----
  - name: s3_requirements
    path: data/layer1/1B/s3_requirements/seed={seed}/fingerprint={manifest_fingerprint}/parameter_hash={parameter_hash}/
    type: dataset
    category: prep
    semver: '{semver}'
    version: '{seed}.{manifest_fingerprint}.{parameter_hash}'
    digest: '{sha256}'
    manifest_key: mlr.1B.s3.requirements
    license: Proprietary-Internal
    role: Deterministic per-(merchant_id, legal_country_iso) site counts for this run (RNG-free).
    dependencies: [outlet_catalogue, tile_weights, iso3166_canonical_2024, s0_gate_receipt_1B]
    source: internal
    owner: {owner_team: "mlr-1b-core"}
    environment: [runtime]
    schema: schemas.1B.yaml#/plan/s3_requirements
    notes: |
      Partitioning: seed={seed}/fingerprint={manifest_fingerprint}/parameter_hash={parameter_hash}
      Writer sort: [merchant_id, legal_country_iso]
      Write-once; atomic move into live partition; file order non-authoritative.

  - name: s4_alloc_plan
    path: data/layer1/1B/s4_alloc_plan/seed={seed}/fingerprint={manifest_fingerprint}/parameter_hash={parameter_hash}/
    type: dataset
    category: prep
    semver: '{semver}'
    version: '{seed}.{manifest_fingerprint}.{parameter_hash}'
    digest: '{sha256}'
    manifest_key: mlr.1B.s4.alloc_plan
    license: Proprietary-Internal
    role: "Per-tile integer allocation plan (RNG-free). Positives only; sums to S3 n_sites."
    dependencies: [s3_requirements, tile_weights, tile_index, iso3166_canonical_2024, s0_gate_receipt_1B]
    source: internal
    owner: {owner_team: "mlr-1b-core"}
    environment: [runtime]
    schema: schemas.1B.yaml#/plan/s4_alloc_plan
    notes: |
      Partitioning: seed={seed}/fingerprint={manifest_fingerprint}/parameter_hash={parameter_hash}
      Writer sort: [merchant_id, legal_country_iso, tile_id]
      Write-once; atomic move into live partition; file order non-authoritative.

  - name: s5_site_tile_assignment
    path: data/layer1/1B/s5_site_tile_assignment/seed={seed}/fingerprint={manifest_fingerprint}/parameter_hash={parameter_hash}/
    type: dataset
    category: prep
    semver: '{semver}'
    version: '{seed}.{manifest_fingerprint}.{parameter_hash}'
    digest: '{sha256}'
    manifest_key: mlr.1B.s5.site_tile_assignment
    license: Proprietary-Internal
    role: "Site→tile assignment (one row per site; satisfies S4 per-tile quotas)."
    dependencies: [s4_alloc_plan, tile_index, iso3166_canonical_2024, s0_gate_receipt_1B]
    source: internal
    owner: { owner_team: "mlr-1b-core" }
    environment: [runtime]
    schema: schemas.1B.yaml#/plan/s5_site_tile_assignment
    notes: |
      Partitioning: seed={seed}/fingerprint={manifest_fingerprint}/parameter_hash={parameter_hash}
      Writer sort: [merchant_id, legal_country_iso, site_order]
      Write-once; atomic move; file order non-authoritative.

  - name: s6_site_jitter
    path: data/layer1/1B/s6_site_jitter/seed={seed}/fingerprint={manifest_fingerprint}/parameter_hash={parameter_hash}/
    type: dataset
    category: prep
    semver: '{semver}'
    version: '{seed}.{manifest_fingerprint}.{parameter_hash}'
    digest: '{sha256}'
    manifest_key: mlr.1B.s6.site_jitter
    license: Proprietary-Internal
    role: "Per-site in-pixel jitter; effective deltas (projection into country)."
    dependencies: [s5_site_tile_assignment, tile_index, world_countries, iso3166_canonical_2024, s0_gate_receipt_1B]
    source: internal
    owner: { owner_team: "mlr-1b-core" }
    environment: [runtime]
    schema: schemas.1B.yaml#/plan/s6_site_jitter
    notes: |
      Partitioning: seed={seed}/fingerprint={manifest_fingerprint}/parameter_hash={parameter_hash}
      Writer sort: [merchant_id, legal_country_iso, site_order]
      Write-once; atomic move; file order non-authoritative.

  - name: s7_site_synthesis
    path: data/layer1/1B/s7_site_synthesis/seed={seed}/fingerprint={manifest_fingerprint}/parameter_hash={parameter_hash}/
    type: dataset
    category: prep
    semver: '{semver}'
    version: '{seed}.{manifest_fingerprint}.{parameter_hash}'
    digest: '{sha256}'
    manifest_key: mlr.1B.s7.site_synthesis
    license: Proprietary-Internal
    role: "Deterministic stitch of S5+S6 into per-site absolutes (RNG-free); 1:1 coverage with 1A outlet_catalogue; ready for S8."
    dependencies: [s5_site_tile_assignment, s6_site_jitter, tile_index, tile_bounds, iso3166_canonical_2024, s0_gate_receipt_1B]
    source: internal
    owner: { owner_team: "mlr-1b-core" }
    environment: [runtime]
    schema: schemas.1B.yaml#/plan/s7_site_synthesis
    notes: |
      Partitioning: seed={seed}/fingerprint={manifest_fingerprint}/parameter_hash={parameter_hash}
      Writer sort: [merchant_id, legal_country_iso, site_order]
      Write-once; atomic move; file order non-authoritative.

  - name: tile_bounds
    path: data/layer1/1B/tile_bounds/parameter_hash={parameter_hash}/
    type: dataset
    category: prep
    semver: '{semver}'
    version: '{parameter_hash}'
    digest: '{sha256}'
    manifest_key: mlr.1B.s1.tile_bounds
    license: Proprietary-Internal
    role: "Per-tile rectangle bounds (validator/S6 helper)."
    dependencies: [tile_index]
    source: internal
    owner: {owner_team: "mlr-1b-core"}
    environment: [runtime]
    schema: schemas.1B.yaml#/prep/tile_bounds
    notes: 'Partition: parameter_hash={parameter_hash}; writer sort: [country_iso,tile_id].'

  - name: site_locations
    path: data/layer1/1B/site_locations/seed={seed}/fingerprint={manifest_fingerprint}/
    type: dataset
    category: output
    semver: '{semver}'
    version: '{manifest_fingerprint}'
    digest: '{sha256}'
    manifest_key: mlr.1B.egress.site_locations
    license: Proprietary-Internal
    role: 'Concrete per-outlet coordinates (order-free; join 1A S3 for inter-country order).'
    dependencies: [s7_site_synthesis]
    source: internal
    owner: { owner_team: 'mlr-1b-core' }
    environment: [runtime]
    schema: schemas.1B.yaml#/egress/site_locations
    notes: 'Partition: seed={seed}/fingerprint={manifest_fingerprint}; writer sort: [merchant_id, legal_country_iso, site_order]; write-once; atomic move; file order non-authoritative.'

  - name: validation_bundle_1B
    path: data/layer1/1B/validation/fingerprint={manifest_fingerprint}/
    type: bundle
    category: validation
    semver: '{semver}'
    version: '{manifest_fingerprint}'
    manifest_key: mlr.1B.validation.bundle
    license: Proprietary-Internal
    role: "Fingerprint-scoped PASS bundle for 1B; consumers MUST verify _passed.flag before reading site_locations (No PASS → no read)."
    dependencies: [s7_site_synthesis, site_locations, rng_event_site_tile_assign, rng_event_in_cell_jitter, rng_audit_log, rng_trace_log]
    schema:
      index_schema_ref: schemas.1A.yaml#/validation/validation_bundle.index_schema
    source: internal
    owner: { owner_team: "mlr-1b-core" }
    environment: [runtime]
    notes: |
      Partitioning: fingerprint={manifest_fingerprint}
      Publish posture: write-once; stage → fsync → single atomic move; file order non-authoritative.
      Hashing law: _passed.flag = SHA-256 over raw bytes of files listed in index.json, in ASCII-lex order of 'path' (flag excluded).

  - name: rng_event_site_tile_assign
    path: logs/rng/events/site_tile_assign/seed={seed}/parameter_hash={parameter_hash}/run_id={run_id}/part-*.jsonl
    type: log
    category: rng_event
    semver: '{semver}'
    version: '{run_id}'
    digest: '{sha256}'
    manifest_key: mlr.rng.events.1B.site_tile_assign
    license: Proprietary-Internal
    role: "RNG envelope events for S5 (site_tile_assign); exactly one event per assigned site."
    dependencies: [s5_site_tile_assignment]   # budget check ties logs to dataset size
    source: internal
    owner: { owner_team: "mlr-1b-core" }
    environment: [runtime]
    schema: schemas.layer1.yaml#/rng/events/site_tile_assign

  - name: rng_audit_log
    path: logs/rng/audit/seed={seed}/parameter_hash={parameter_hash}/run_id={run_id}/rng_audit_log.jsonl
    type: log
    category: rng_core
    semver: '{semver}'
    version: '{run_id}'
    digest: '{sha256}'
    manifest_key: mlr.rng.core.1B.audit
    license: Proprietary-Internal
    role: "Run-scoped audit envelope for Segment 1B RNG usage (seed, manifest, parameter hash, build metadata)."
    dependencies: [s6_site_jitter]
    source: internal
    owner: { owner_team: "mlr-1b-core" }
    environment: [runtime]
    schema: schemas.layer1.yaml#/rng/core/rng_audit_log

  - name: rng_trace_log
    path: logs/rng/trace/seed={seed}/parameter_hash={parameter_hash}/run_id={run_id}/rng_trace_log.jsonl
    type: log
    category: rng_core
    semver: '{semver}'
    version: '{run_id}'
    digest: '{sha256}'
    manifest_key: mlr.rng.core.1B.trace
    license: Proprietary-Internal
    role: "Cumulative RNG trace for Segment 1B substreams; append exactly one row after each event."
    dependencies: [s6_site_jitter, rng_audit_log]
    source: internal
    owner: { owner_team: "mlr-1b-core" }
    environment: [runtime]
    schema: schemas.layer1.yaml#/rng/core/rng_trace_log

  - name: rng_event_in_cell_jitter
    path: logs/rng/events/in_cell_jitter/seed={seed}/parameter_hash={parameter_hash}/run_id={run_id}/part-*.jsonl
    type: log
    category: rng_event
    semver: '{semver}'
    version: '{run_id}'
    digest: '{sha256}'
    manifest_key: mlr.rng.events.1B.in_cell_jitter
    license: Proprietary-Internal
    role: "RNG envelope events for S6 (in_cell_jitter); ≥1 event per site (one per attempt); per-event budget: blocks=1, draws=2; last event corresponds to the accepted sample."
    dependencies: [s5_site_tile_assignment]   # coverage ties to S5 keyset; budget fixed per event
    source: internal
    owner: { owner_team: "mlr-1b-core" }
    environment: [runtime]
    schema: schemas.layer1.yaml#/rng/events/in_cell_jitter
