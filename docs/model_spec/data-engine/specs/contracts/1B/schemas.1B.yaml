version: '1.0'
$id: schemas.1B.yaml
$schema: https://json-schema.org/draft/2020-12/schema
description: 'Schemas for Layer 1 — Subsegment 1B (Site geolocation: S0 gate + future states).'

# Reusable primitives (kept minimal; prefer layer/ingress $defs where possible)
$defs:
  hex64:
    type: string
    pattern: ^[a-f0-9]{64}$
    description: Lowercase hex SHA-256 digest.
  uint64:
    type: integer
    minimum: 0
    maximum: 18446744073709551615
    description: Unsigned 64-bit integer.
  rfc3339_micros:
    type: string
    pattern: ^[0-9]{4}-[0-9]{2}-[0-9]{2}T[0-9]{2}:[0-9]{2}:[0-9]{2}\.[0-9]{6}Z$
    description: RFC-3339 UTC timestamp with exactly 6 fractional digits.
  lon:
    type: number
    minimum: -180
    maximum: 180
    description: Longitude in degrees (WGS84).
  lat:
    type: number
    minimum: -90
    maximum: 90
    description: Latitude in degrees (WGS84).
  inclusion_rule:
    type: string
    enum: ["center","any_overlap"]
    description: Inclusion predicate used by S1 (see state spec §6.2).

validation:
  s0_gate_receipt:
    type: table
    description: 'Receipt proving 1A PASS for this fingerprint; authorises 1B to read outlet_catalogue. Fingerprint-only identity.'
    primary_key: [manifest_fingerprint]
    partition_keys: [manifest_fingerprint]
    sort_keys: []
    columns:
      - {name: manifest_fingerprint, $ref: '#/$defs/hex64', nullable: false, description: 'Lineage fingerprint (MUST byte-equal the `fingerprint` path token).'}
      - {name: validation_bundle_path, type: string, nullable: false, description: 'Resolved folder of 1A validation bundle for this fingerprint (must include `fingerprint=<hex64>`).', pattern: '^data/layer1/1A/validation/fingerprint=[a-f0-9]{64}/?$'}
      - {name: flag_sha256_hex, $ref: '#/$defs/hex64', nullable: false, description: 'Value read from _passed.flag after recomputation.'}
      - {name: verified_at_utc, $ref: '#/$defs/rfc3339_micros', nullable: false, description: 'Verification timestamp (observational).'}
      - name: sealed_inputs
        type: array
        nullable: false
        description: 'List of sealed inputs S0 authorises for 1B after PASS (dataset id, partition keys, required schema_ref).'
        items:
          type: object
          required: [id, schema_ref]
          properties:
            id: {type: string, description: 'Dataset ID, e.g., outlet_catalogue'}
            partition: {type: array, items: {type: string}, description: 'Partition keys relevant to the input, e.g., ["seed","fingerprint"] or ["parameter_hash"].'}
            schema_ref: {type: string, description: 'Schema anchor for the input, when applicable.'}
          additionalProperties: false
      - {name: notes, type: string, nullable: true, description: 'Optional free-text.'}


# Placeholders for later states (to be filled when we ratify S1+)
prep:
  tile_index:
    type: table
    description: 'Eligible raster cells per country.'
    primary_key: [country_iso, tile_id]
    partition_keys: [parameter_hash]
    sort_keys: [country_iso, tile_id]
    columns:
      - {name: country_iso, type: string, nullable: false, description: 'ISO 3166-1 alpha-2 (UPPERCASE).', pattern: '^[A-Z]{2}$'}
      - {name: tile_id, $ref: '#/$defs/uint64', nullable: false, description: 'Global cell id = raster_row*ncols + raster_col (row-major).'}
      - {name: raster_row, $ref: '#/$defs/uint64', nullable: false, description: 'Zero-based row index in population_raster_2025.'}
      - {name: raster_col, $ref: '#/$defs/uint64', nullable: false, description: 'Zero-based column index in population_raster_2025.'}
      - {name: centroid_lon, $ref: '#/$defs/lon',  nullable: false, description: 'Cell-center longitude (WGS84).'}
      - {name: centroid_lat, $ref: '#/$defs/lat',  nullable: false, description: 'Cell-center latitude (WGS84).'}
      - {name: pixel_area_m2, type: number, nullable: false, description: 'Ellipsoidal cell area (WGS84).', exclusiveMinimum: 0}
      - {name: inclusion_rule, $ref: '#/$defs/inclusion_rule', nullable: false, description: 'Predicate applied to decide eligibility.'}

  tile_weights:
    type: table
    description: 'Fixed-dp weights per tile (placeholder; not ratified here).'
    primary_key: [country_iso, tile_id]
    partition_keys: [parameter_hash]
    sort_keys: [country_iso, tile_id]
    columns: []

egress:
  site_locations:
    type: table
    description: 'Concrete (lat,lon, …) per outlet stub (placeholder; not ratified here).'
    primary_key: [merchant_id, legal_country_iso, site_order]
    partition_keys: [seed, fingerprint]
    sort_keys: [merchant_id, legal_country_iso, site_order]
    columns: []
