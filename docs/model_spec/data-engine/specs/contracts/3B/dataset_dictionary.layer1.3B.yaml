version: '1.0'

lifecycle:
  phase: planning
  last_reviewed:
  approver:

ci_policy:
  allow_placeholders: true
  placeholder_markers: [TBD, null]
  block_on_phase: [beta, stable]

layer:
  id: layer1
  name: Merchant Location Realism

reference_data:
- id: site_catalogue
  status: approved
  owner_subsegment: 1B
  description: Immutable merchant-to-site catalogue consumed for virtual overlays; 3B MUST NOT mutate 1B rows.
  version: '{seed}.{manifest_fingerprint}'
  format: parquet
  path: data/outputs/1B/site_catalogue/seed={seed}/fingerprint={manifest_fingerprint}/
  partitioning: [seed, fingerprint]
  ordering: [merchant_id, site_order]
  schema_ref: schemas.1B.yaml#/egress/site_catalogue
  lineage:
    produced_by: 1B.egress
    consumed_by: [3B]
    final_in_layer: true
  retention_days: 1095
  pii: false
  licence: Proprietary-Internal

- id: mcc_channel_rules
  status: draft
  owner_subsegment: 3B
  description: Governed MCCÃ—channel ladder that decides whether a merchant joins the virtual overlay.
  version: '{policy_version}'
  format: yaml
  path: config/virtual/mcc_channel_rules.yaml
  partitioning: []
  ordering: []
  schema_ref: schemas.3B.yaml#/policy/virtual_rules_policy_v1
  lineage:
    produced_by: 3B.governance
    consumed_by: [3B.S1]
    final_in_layer: false
  retention_days: 1825
  pii: false
  licence: Proprietary-Internal

- id: virtual_settlement_coords
  status: draft
  owner_subsegment: 3B
  description: Evidence-backed settlement coordinates keyed by merchant, used to seed S1 settlement nodes.
  version: '{coordinate_batch}'
  format: csv
  path: artefacts/virtual/virtual_settlement_coords.csv
  partitioning: []
  ordering: []
  schema_ref: schemas.3B.yaml#/reference/virtual_settlement_coords_v1
  lineage:
    produced_by: data_governance
    consumed_by: [3B.S1]
    final_in_layer: false
  retention_days: 365
  pii: false
  licence: Proprietary-Internal

- id: cdn_country_weights
  status: draft
  owner_subsegment: 3B
  description: Normalised CDN country weights plus integer edge scale E for catalogue expansion.
  version: '{config_version}'
  format: yaml
  path: config/virtual/cdn_country_weights.yaml
  partitioning: []
  ordering: []
  schema_ref: schemas.3B.yaml#/policy/cdn_country_weights_v1
  lineage:
    produced_by: 3B.governance
    consumed_by: [3B.S2, 3B.S3]
    final_in_layer: false
  retention_days: 1825
  pii: false
  licence: Proprietary-Internal

- id: virtual_validation_policy
  status: draft
  owner_subsegment: 3B
  description: IP-country mix and settlement cut-off tolerances applied by virtual validation tests.
  version: '{policy_version}'
  format: yaml
  path: config/virtual/virtual_validation.yml
  partitioning: []
  ordering: []
  schema_ref: schemas.3B.yaml#/policy/virtual_validation_policy_v1
  lineage:
    produced_by: QA.governance
    consumed_by: [3B.S4, 3B.S5, 4A]
    final_in_layer: false
  retention_days: 1825
  pii: false
  licence: Proprietary-Internal

- id: hrsl_raster
  status: approved
  owner_subsegment: ingress
  description: HRSL 100 m raster pinned for virtual edge sampling.
  version: '{vintage}'
  format: tif
  path: artefacts/rasters/hrsl_100m.tif
  partitioning: []
  ordering: []
  schema_ref: schemas.ingress.layer1.yaml#/population_raster
  lineage:
    produced_by: ingress
    consumed_by: [3B.S2]
    final_in_layer: false
  retention_days: 1825
  pii: false
  licence: CC-BY-4.0

- id: pelias_cached_bundle
  status: approved
  owner_subsegment: ingress
  description: Offline Pelias SQLite bundle used to validate settlement evidence URLs.
  version: '{pelias_version}'
  format: sqlite
  path: artefacts/geocode/pelias_cached.sqlite
  partitioning: []
  ordering: []
  schema_ref: schemas.3B.yaml#/reference/pelias_cached_bundle_v1
  lineage:
    produced_by: data_governance
    consumed_by: [3B.S1]
    final_in_layer: false
  retention_days: 1095
  pii: false
  licence: CC-BY-4.0


datasets:
- id: s0_gate_receipt_3B
  status: draft
  owner_subsegment: 3B
  description: Gate receipt capturing upstream PASS status, sealed policy set and authoritative digests.
  version: '{manifest_fingerprint}'
  format: json
  path: data/layer1/3B/s0_gate_receipt/fingerprint={manifest_fingerprint}/s0_gate_receipt_3B.json
  partitioning: [fingerprint]
  ordering: []
  schema_ref: schemas.3B.yaml#/validation/s0_gate_receipt_3B
  lineage:
    produced_by: 3B.S0
    consumed_by: [3B.S1, 3B.S2, 3B.S3, 3B.S4, 3B.S5]
    final_in_layer: false
  retention_days: 365
  pii: false
  licence: Proprietary-Internal

- id: sealed_inputs_3B
  status: draft
  owner_subsegment: 3B
  description: Inventory of every artefact authorised for the manifest.
  version: '{manifest_fingerprint}'
  format: parquet
  path: data/layer1/3B/sealed_inputs/fingerprint={manifest_fingerprint}/sealed_inputs_3B.parquet
  partitioning: [fingerprint]
  ordering: [owner_segment, artefact_kind, logical_id, path]
  schema_ref: schemas.3B.yaml#/validation/sealed_inputs_3B
  lineage:
    produced_by: 3B.S0
    consumed_by: [3B.S1, 3B.S2, 3B.S3, 3B.S4, 3B.S5]
    final_in_layer: false
  retention_days: 365
  pii: false
  licence: Proprietary-Internal

- id: virtual_classification_3B
  status: draft
  owner_subsegment: 3B
  description: Merchant-level classification surface with closed vocabulary reason codes.
  version: '{seed}.{manifest_fingerprint}'
  format: parquet
  path: data/layer1/3B/virtual_classification/seed={seed}/fingerprint={manifest_fingerprint}/
  partitioning: [seed, fingerprint]
  ordering: [merchant_id]
  schema_ref: schemas.3B.yaml#/plan/virtual_classification_3B
  lineage:
    produced_by: 3B.S1
    consumed_by: [3B.S2, 3B.S3, 3B.S4, 3B.S5, routing_virtual]
    final_in_layer: false
  retention_days: 365
  pii: false
  licence: Proprietary-Internal

- id: virtual_settlement_3B
  status: draft
  owner_subsegment: 3B
  description: One settlement node per virtual merchant with tzid semantics and evidence URLs.
  version: '{seed}.{manifest_fingerprint}'
  format: parquet
  path: data/layer1/3B/virtual_settlement/seed={seed}/fingerprint={manifest_fingerprint}/
  partitioning: [seed, fingerprint]
  ordering: [merchant_id]
  schema_ref: schemas.3B.yaml#/plan/virtual_settlement_3B
  lineage:
    produced_by: 3B.S1
    consumed_by: [3B.S2, 3B.S4, routing_virtual]
    final_in_layer: false
  retention_days: 365
  pii: false
  licence: Proprietary-Internal

- id: edge_catalogue_3B
  status: draft
  owner_subsegment: 3B
  description: Per-edge geometry, tz semantics and weights for all virtual merchants.
  version: '{seed}.{manifest_fingerprint}'
  format: parquet
  path: data/layer1/3B/edge_catalogue/seed={seed}/fingerprint={manifest_fingerprint}/
  partitioning: [seed, fingerprint]
  ordering: [merchant_id, edge_id]
  schema_ref: schemas.3B.yaml#/plan/edge_catalogue_3B
  lineage:
    produced_by: 3B.S2
    consumed_by: [3B.S3, validation]
    final_in_layer: false
  retention_days: 365
  pii: false
  licence: Proprietary-Internal

- id: edge_catalogue_index_3B
  status: draft
  owner_subsegment: 3B
  description: Digest summary and per-merchant counts for the edge catalogue.
  version: '{seed}.{manifest_fingerprint}'
  format: parquet
  path: data/layer1/3B/edge_catalogue_index/seed={seed}/fingerprint={manifest_fingerprint}/edge_catalogue_index_3B.parquet
  partitioning: [seed, fingerprint]
  ordering: [scope, merchant_id]
  schema_ref: schemas.3B.yaml#/plan/edge_catalogue_index_3B
  lineage:
    produced_by: 3B.S2
    consumed_by: [3B.S3, 3B.S5, routing_virtual]
    final_in_layer: false
  retention_days: 365
  pii: false
  licence: Proprietary-Internal

- id: edge_alias_blob_3B
  status: draft
  owner_subsegment: 3B
  description: Contiguous alias blob covering every virtual merchant edge distribution.
  version: '{seed}.{manifest_fingerprint}'
  format: bin
  path: data/layer1/3B/edge_alias_blob/seed={seed}/fingerprint={manifest_fingerprint}/edge_alias_blob_3B.bin
  partitioning: [seed, fingerprint]
  ordering: []
  schema_ref: schemas.3B.yaml#/binary/edge_alias_blob_header_3B
  lineage:
    produced_by: 3B.S3
    consumed_by: [3B.S4, 2B.routing, validation]
    final_in_layer: false
  retention_days: 365
  pii: false
  licence: Proprietary-Internal

- id: edge_alias_index_3B
  status: draft
  owner_subsegment: 3B
  description: Index and checksum metadata for locating merchant alias segments inside the blob.
  version: '{seed}.{manifest_fingerprint}'
  format: parquet
  path: data/layer1/3B/edge_alias_index/seed={seed}/fingerprint={manifest_fingerprint}/edge_alias_index_3B.parquet
  partitioning: [seed, fingerprint]
  ordering: [scope, merchant_id]
  schema_ref: schemas.3B.yaml#/plan/edge_alias_index_3B
  lineage:
    produced_by: 3B.S3
    consumed_by: [3B.S4, 2B.routing, validation]
    final_in_layer: false
  retention_days: 365
  pii: false
  licence: Proprietary-Internal

- id: edge_universe_hash_3B
  status: draft
  owner_subsegment: 3B
  description: Fingerprint-scoped hash tying cdn weights, edge catalogue/index and alias outputs.
  version: '{manifest_fingerprint}'
  format: json
  path: data/layer1/3B/edge_universe_hash/fingerprint={manifest_fingerprint}/edge_universe_hash_3B.json
  partitioning: [fingerprint]
  ordering: []
  schema_ref: schemas.3B.yaml#/validation/edge_universe_hash_3B
  lineage:
    produced_by: 3B.S3
    consumed_by: [3B.S4, 3B.S5, 2B.routing]
    final_in_layer: false
  retention_days: 365
  pii: false
  licence: Proprietary-Internal

- id: gamma_draw_log_3B
  status: draft
  owner_subsegment: 3B
  description: Structured Philox audit for any gamma draws in the virtual pipeline.
  version: '{seed}.{manifest_fingerprint}'
  format: jsonl
  path: logs/layer1/3B/gamma_draw/seed={seed}/fingerprint={manifest_fingerprint}/gamma_draw_log_3B.jsonl
  partitioning: [seed, fingerprint]
  ordering: [merchant_id, day_index]
  schema_ref: schemas.3B.yaml#/validation/gamma_draw_log_entry_3B
  lineage:
    produced_by: 3B.S3
    consumed_by: [validation]
    final_in_layer: false
  retention_days: 365
  pii: false
  licence: Proprietary-Internal

- id: virtual_routing_policy_3B
  status: draft
  owner_subsegment: 3B
  description: Dual-TZ routing contract that tells 2B how to consume the virtual artefacts.
  version: '{manifest_fingerprint}'
  format: json
  path: data/layer1/3B/virtual_routing_policy/fingerprint={manifest_fingerprint}/virtual_routing_policy_3B.json
  partitioning: [fingerprint]
  ordering: []
  schema_ref: schemas.3B.yaml#/egress/virtual_routing_policy_3B
  lineage:
    produced_by: 3B.S4
    consumed_by: [2B.routing, 3B.validation]
    final_in_layer: false
  retention_days: 365
  pii: false
  licence: Proprietary-Internal

- id: virtual_validation_contract_3B
  status: draft
  owner_subsegment: 3B
  description: Declarative suite of validation tests (IP mix, cut-offs, alias health) scoped to the manifest.
  version: '{manifest_fingerprint}'
  format: parquet
  path: data/layer1/3B/virtual_validation_contract/fingerprint={manifest_fingerprint}/virtual_validation_contract_3B.parquet
  partitioning: [fingerprint]
  ordering: [test_id]
  schema_ref: schemas.3B.yaml#/egress/virtual_validation_contract_3B
  lineage:
    produced_by: 3B.S4
    consumed_by: [3B.S5, 4A]
    final_in_layer: false
  retention_days: 365
  pii: false
  licence: Proprietary-Internal

- id: s4_run_summary_3B
  status: draft
  owner_subsegment: 3B
  description: Optional S4 receipt capturing policy digests and status.
  version: '{manifest_fingerprint}'
  format: json
  path: data/layer1/3B/s4_run_summary/fingerprint={manifest_fingerprint}/s4_run_summary_3B.json
  partitioning: [fingerprint]
  ordering: []
  schema_ref: schemas.3B.yaml#/validation/s4_run_summary_3B
  lineage:
    produced_by: 3B.S4
    consumed_by: [3B.S5]
    final_in_layer: false
  retention_days: 365
  pii: false
  licence: Proprietary-Internal

- id: validation_bundle_3B
  status: draft
  owner_subsegment: 3B
  description: Directory artefact containing manifest, digests and structural or RNG evidence.
  version: '{manifest_fingerprint}'
  format: folder
  path: data/layer1/3B/validation/fingerprint={manifest_fingerprint}/
  partitioning: [fingerprint]
  ordering: []
  schema_ref: schemas.layer1.yaml#/validation/validation_bundle_index_3B
  lineage:
    produced_by: 3B.S5
    consumed_by: [HashGate, downstream segments]
    final_in_layer: false
  retention_days: 1095
  pii: false
  licence: Proprietary-Internal

- id: validation_bundle_index_3B
  status: draft
  owner_subsegment: 3B
  description: index.json enumerating evidence files plus their SHA-256 digests.
  version: '{manifest_fingerprint}'
  format: json
  path: data/layer1/3B/validation/fingerprint={manifest_fingerprint}/index.json
  partitioning: [fingerprint]
  ordering: []
  schema_ref: schemas.layer1.yaml#/validation/validation_bundle_index_3B
  lineage:
    produced_by: 3B.S5
    consumed_by: [HashGate, downstream segments]
    final_in_layer: false
  retention_days: 1095
  pii: false
  licence: Proprietary-Internal

- id: passed_flag_3B
  status: draft
  owner_subsegment: 3B
  description: ASCII _passed.flag_3B storing the hash of the validation bundle.
  version: '{manifest_fingerprint}'
  format: text
  path: data/layer1/3B/validation/fingerprint={manifest_fingerprint}/_passed.flag_3B
  partitioning: [fingerprint]
  ordering: []
  schema_ref: schemas.layer1.yaml#/validation/passed_flag_3B
  lineage:
    produced_by: 3B.S5
    consumed_by: [HashGate, downstream segments]
    final_in_layer: false
  retention_days: 1095
  pii: false
  licence: Proprietary-Internal

- id: s5_manifest_3B
  status: draft
  owner_subsegment: 3B
  description: Optional S5 manifest summarising identity, digests and validator outcomes; lives inside the bundle.
  version: '{manifest_fingerprint}'
  format: json
  path: data/layer1/3B/validation/fingerprint={manifest_fingerprint}/s5_manifest_3B.json
  partitioning: [fingerprint]
  ordering: []
  schema_ref: schemas.3B.yaml#/validation/s5_manifest_3B
  lineage:
    produced_by: 3B.S5
    consumed_by: [HashGate, downstream segments]
    final_in_layer: false
  retention_days: 1095
  pii: false
  licence: Proprietary-Internal
