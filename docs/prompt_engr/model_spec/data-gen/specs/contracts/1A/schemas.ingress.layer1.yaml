# schemas.ingress.layer1.yaml
version: "1.0"
$id: "schemas.ingress.layer1.yaml"
description: "Processed reference datasets used by Layer 1 (Merchant Location Realism), subsegment 1A."

# -- Reusable primitives ---------------------------------------------------
$defs:
  iso2:
    type: string
    pattern: "^[A-Z]{2}$"
    description: "ISO 3166-1 alpha-2 country code (upper-case)."
  iso3:
    type: string
    pattern: "^[A-Z]{3}$"
    description: "ISO 3166-1 alpha-3 country code (upper-case)."
  iso4217:
    type: string
    pattern: "^[A-Z]{3}$"
    description: "ISO 4217 currency code (upper-case)."
  tzid:
    type: string
    minLength: 3
    maxLength: 64
    pattern: "^[A-Za-z0-9_+\\-./]+$"
    description: "IANA time zone ID, e.g. 'Europe/London'."
  pct01:
    type: number
    minimum: 0.0
    maximum: 1.0
    description: "Share or probability in [0,1]."

# -- Seed merchant list (processed from transaction schema) ----------------
merchant_ids:
  type: table
  primary_key: ["merchant_id"]
  partition_keys: ["version"]     # matches path: .../{version}/
  description: "Authoritative seed of merchants used by 1A; derived and normalized from the transaction schema."
  columns:
    - name: merchant_id
      type: int64
      nullable: false
      description: "Synthetic merchant identifier."
      minimum: 1
    - name: mcc
      type: int32
      nullable: false
      description: "Merchant Category Code."
      minimum: 0
      maximum: 9999
    - name: channel
      type: string
      nullable: false
      description: "Acquiring channel."
      enum: ["card_present","card_not_present"]
    - name: home_country_iso
      $ref: "#/$defs/iso2"
      nullable: false
      description: "Home/registration country for tie-breaks & priors."
      fk: { dataset_ref: "#/iso3166_canonical_2024", column: "country_iso" }
  notes:
    - "Processed, column-normalized snapshot (not a raw export)."
    - "Channel standardized to two values used by 1A hurdle modelling."

# -- World Bank GDP-per-capita (constant 2015 USD) -------------------------
world_bank_gdp_per_capita:
  type: table
  primary_key: ["country_iso"]
  description: "Flattened GDP per capita (constant 2015 USD) per ISO2 used for GDP bucketing."
  columns:
    - name: country_iso
      $ref: "#/$defs/iso2"
      nullable: false
      description: "Country code (ISO2)."
      fk: { dataset_ref: "#/iso3166_canonical_2024", column: "country_iso" }
    - name: observation_year
      type: int16
      nullable: false
      description: "Year of the GDP observation (e.g., 2023)."
      minimum: 1950
      maximum: 2100
    - name: gdp_pc_usd_2015
      type: float64
      nullable: false
      description: "GDP per capita (constant 2015 USD)."
      minimum: 0.0
    - name: source_series
      type: string
      nullable: false
      description: "WDI series code."
      const: "NY.GDP.PCAP.KD"
  constraints:
    - type: not_null
      columns: ["gdp_pc_usd_2015"]
    - type: unique
      columns: ["country_iso"]

# -- Canonical ISO-3166 (deterministic tie-breaks, validation) -------------
iso3166_canonical_2024:
  type: table
  primary_key: ["country_iso"]
  description: "Canonical ISO-3166-1 mapping with names and numeric codes."
  columns:
    - { name: country_iso,  $ref: "#/$defs/iso2", nullable: false, description: "ISO 3166-1 alpha-2." }
    - { name: alpha3,       $ref: "#/$defs/iso3", nullable: false, description: "ISO 3166-1 alpha-3." }
    - { name: numeric_code, type: int16,          nullable: false, description: "ISO 3166-1 numeric code." }
    - { name: name,         type: string,         nullable: false, description: "Short English name." }
    - { name: region,       type: string,         nullable: true,  description: "UN M49 region (optional)." }
    - { name: subregion,    type: string,         nullable: true,  description: "UN M49 subregion (optional)." }
    - { name: start_date,   type: date,           nullable: true,  description: "Effective-from (if historical)." }
    - { name: end_date,     type: date,           nullable: true,  description: "Effective-to (if historical)." }
  constraints:
    - type: unique
      columns: ["alpha3","numeric_code"]

# -- Country boundaries (GeoParquet) ---------------------------------------
world_countries:
  type: geotable
  primary_key: ["country_iso"]
  description: "Country polygons for conformance checks and spatial joins."
  geometry:
    column: geom
    type: ["Polygon","MultiPolygon"]
    crs: "EPSG:4326"
  columns:
    - name: country_iso
      $ref: "#/$defs/iso2"
      nullable: false
      description: "ISO 3166-1 alpha-2."
      fk: { dataset_ref: "#/iso3166_canonical_2024", column: "country_iso" }
    - { name: name,  type: string,   nullable: true,  description: "Display name (optional)." }
    - { name: geom,  type: geometry, nullable: false, description: "GeoParquet geometry (WGS84)." }

# -- Time-zone polygons (GeoParquet) ---------------------------------------
tz_world_2025a:
  type: geotable
  primary_key: ["tzid","polygon_id"]
  description: "TZ world polygons for zone lookup in 2A (pinned here for hermeticity)."
  geometry:
    column: geom
    type: ["Polygon","MultiPolygon"]
    crs: "EPSG:4326"
  columns:
    - { name: tzid,       $ref: "#/$defs/tzid",  nullable: false, description: "IANA time zone ID." }
    - { name: polygon_id, type: int32,          nullable: false, description: "Deterministic polygon identifier per tzid." }
    - { name: geom,       type: geometry,       nullable: false, description: "GeoParquet geometry (WGS84)." }

# -- Population raster (COG) -----------------------------------------------
population_raster_2025:
  type: raster
  description: "Population raster used as a spatial prior (HRSL/WorldPop), stored as Cloud-Optimized GeoTIFF."
  raster:
    driver: "COG"
    crs: "EPSG:4326"        # lat/lon
    bands: 1
    dtype: "float32"        # normalized at ingest
    nodata: -1.0
    pixel_unit: "persons"
    overview_levels: [2, 4, 8, 16]

# -- GDP bucket mapping (processed) ----------------------------------------
gdp_bucket_map_2024:
  type: table
  primary_key: ["country_iso"]
  description: "Country→GDP bucket mapping (Jenks, K=5) used as a categorical predictor."
  columns:
    - name: country_iso
      $ref: "#/$defs/iso2"
      nullable: false
      description: "ISO 3166-1 alpha-2."
      fk: { dataset_ref: "#/iso3166_canonical_2024", column: "country_iso" }
    - name: bucket_id
      type: int32
      nullable: false
      description: "Bucket index in [1..5]."
      minimum: 1
      maximum: 5
    - { name: bucket_label, type: string, nullable: true,  description: "Readable label (e.g., Very Low/Low/…)." }
    - { name: method,       type: string, nullable: false, description: "Bucketing method.", const: "jenks" }
    - { name: k,            type: int8,   nullable: false, description: "Number of buckets (K).", const: 5 }
    - { name: source_year,  type: int16,  nullable: false, description: "Year of GDP values used for bucketing." }

# -- Currency-level settlement shares (long form) --------------------------
settlement_shares_2024Q4:
  type: table
  primary_key: ["currency","country_iso"]
  description: "Currency→country settlement share vectors (long form) with observation counts."
  columns:
    - { name: currency,    $ref: "#/$defs/iso4217", nullable: false, description: "ISO 4217 currency code." }
    - name: country_iso
      $ref: "#/$defs/iso2"
      nullable: false
      description: "Settlement country."
      fk: { dataset_ref: "#/iso3166_canonical_2024", column: "country_iso" }
    - { name: share,       $ref: "#/$defs/pct01",   nullable: false, description: "Share for (currency,country)." }
    - { name: obs_count,   type: int64,             nullable: false, description: "Number of observations supporting this share.", minimum: 0 }
  constraints:
    - type: group_sum_equals_one
      group_by: ["currency"]
      value_column: "share"
      tolerance: 1e-6

# -- Intra-currency splits with observation counts (long form) -------------
ccy_country_shares_2024Q4:
  type: table
  primary_key: ["currency","country_iso"]
  description: "Intra-currency proportional splits (priors) with observation counts."
  columns:
    - { name: currency,    $ref: "#/$defs/iso4217", nullable: false, description: "ISO 4217 currency code." }
    - name: country_iso
      $ref: "#/$defs/iso2"
      nullable: false
      description: "Country within the currency area."
      fk: { dataset_ref: "#/iso3166_canonical_2024", column: "country_iso" }
    - { name: share,       $ref: "#/$defs/pct01",   nullable: false, description: "Proportional split." }
    - { name: obs_count,   type: int64,             nullable: false, description: "Observation count.", minimum: 0 }
  constraints:
    - type: group_sum_equals_one
      group_by: ["currency"]
      value_column: "share"
      tolerance: 1e-6

# -- Compatibility aliases (planning → alpha) ------------------------------
# These allow existing dictionary pointers to older anchors; swap to canonical names later.
world_countries_shp:   { $ref: "#/world_countries" }
tz_world_shp:          { $ref: "#/tz_world_2025a" }
population_raster:     { $ref: "#/population_raster_2025" }
world_bank_gdp:        { $ref: "#/world_bank_gdp_per_capita" }
iso3166_1_alpha2:      { $ref: "#/iso3166_canonical_2024" }
gdp_bucket_map:        { $ref: "#/gdp_bucket_map_2024" }
settlement_shares:     { $ref: "#/settlement_shares_2024Q4" }
ccy_country_shares:    { $ref: "#/ccy_country_shares_2024Q4" }
