# schemas.layer1.yaml
version: "1.0"
$id: "schemas.layer1.yaml"
$schema: "https://json-schema.org/draft/2020-12/schema"
description: "Layer-wide schemas used by Layer 1 (shared logs and RNG event streams)."

# -- Reusable primitives ---------------------------------------------------
$defs:
  dec_u128:
    type: string
    pattern: "^(0|[1-9][0-9]{0,38})$"
    maxLength: 39
    description: "Base-10 unsigned 128-bit integer as a string (no sign, no leading zeros except '0'). Validator enforces < 2^128."
  id64:
    type: integer
    minimum: 1
    maximum: 9223372036854775807
    description: "Positive 64-bit identifier."
  iso2:
    type: string
    pattern: "^[A-Z]{2}$"
    description: "ISO 3166-1 alpha-2 country code."
  iso4217:
    type: string
    pattern: "^[A-Z]{3}$"
    description: "ISO 4217 currency code."
  hex64:
    type: string
    pattern: "^[a-f0-9]{64}$"
    description: "Lowercase hex SHA-256 digest."
  hex32:
    type: string
    pattern: "^[a-f0-9]{32}$"
    description: "Lowercase 32-hex run identifier (run_id)."
  u01:
    type: number
    exclusiveMinimum: 0.0
    exclusiveMaximum: 1.0
    description: "Open-interval uniform deviate in (0,1)."
  pct01:
    type: number
    minimum: 0.0
    maximum: 1.0
    description: "Probability or share in [0,1]."
  uint32:
    type: integer
    minimum: 0
    maximum: 4294967295
  uint64:
    type: integer
    minimum: 0
    maximum: 18446744073709551615
  six_digit_seq:
    type: string
    pattern: "^[0-9]{6}$"
    description: "Zero-padded 6-digit sequence string."
  stream_label:
    type: string
    description: "Deterministic Philox sub-stream label (e.g., 'hurdle_bernoulli', 'gumbel_key')."

  # Common envelope for all RNG JSONL events
  rng_envelope:
    type: object
    required: [ts_utc, run_id, seed, parameter_hash, manifest_fingerprint, module, substream_label,
               rng_counter_before_lo, rng_counter_before_hi, rng_counter_after_lo, rng_counter_after_hi,
               draws, blocks]
    properties:
      ts_utc:
        type: string
        format: date-time  # Exactly 6 fractional digits (microseconds) plus trailing 'Z'
        pattern: "^[0-9]{4}-[0-9]{2}-[0-9]{2}T[0-9]{2}:[0-9]{2}:[0-9]{2}\\.[0-9]{6}Z$"
        description: "Event timestamp (UTC). MUST be RFC-3339 with 'Z' and EXACTLY 6 fractional digits (microseconds), e.g., 2025-08-15T10:03:12.345678Z."
      run_id:  { $ref: "#/$defs/hex32" }
      seed:   { $ref: "#/$defs/uint64", description: "Master Philox seed for this run." }
      parameter_hash:       { $ref: "#/$defs/hex64", description: "SHA-256 of combined parameter bundle." }
      manifest_fingerprint: { $ref: "#/$defs/hex64", description: "Run fingerprint used across Layer 1." }
      module:
        type: string
        description: "Emitting module (e.g., '1A.nb_sampler'). For S1 hurdle, MUST be '1A.hurdle_sampler'."
      substream_label: { $ref: "#/$defs/stream_label", description: "Philox sub-stream logical label." }
      rng_counter_before_lo: { $ref: "#/$defs/uint64", description: "Philox 2x64 counter low (before draws)." }
      rng_counter_before_hi: { $ref: "#/$defs/uint64", description: "Philox 2x64 counter high (before draws)." }
      rng_counter_after_lo:  { $ref: "#/$defs/uint64", description: "Philox 2x64 counter low (after draws)." }
      rng_counter_after_hi:  { $ref: "#/$defs/uint64", description: "Philox 2x64 counter high (after draws)." }
      merchant_id: { $ref: "#/$defs/id64", nullable: true, description: "Present when event is merchant-scoped." }
      draws:
        $ref: "#/$defs/dec_u128"
        description: "Uniform variates consumed by THIS event (decimal u128 string). Independent of the counter delta; validators enforce per-family budgets."
      blocks:
        description: "PRNG block increments for THIS event (delta of the 128-bit counters). MUST equal u128(after) − u128(before) and fit in uint64."
        $ref: "#/$defs/uint64"
# -- RNG: Core logs (JSONL) ------------------------------------------------
rng:
  core:

    rng_audit_log:
      type: stream
      description: "Run-scoped RNG audit (master seed, algo, code digests, platform)."
      record:
        type: object
        additionalProperties: false
        required: [ts_utc, run_id, seed, manifest_fingerprint, parameter_hash, algorithm, build_commit]
        properties:
          ts_utc:  { type: string, format: date-time }
          run_id:  { $ref: "#/$defs/hex32" }
          seed:    { $ref: "#/$defs/uint64" }
          manifest_fingerprint: { $ref: "#/$defs/hex64" }
          parameter_hash:       { $ref: "#/$defs/hex64" }
          algorithm: { type: string, enum: ["philox2x64-10"], description: "Counter-based RNG variant." }
          build_commit: { type: string, description: "Git SHA of code at run." }
          code_digest:  { $ref: "#/$defs/hex64", description: "Digest of source bundle opened by runtime.", nullable: true }
          hostname:     { type: string, nullable: true }
          platform:     { type: string, nullable: true }
          notes:        { type: string, nullable: true }

    rng_trace_log:
      type: stream
      description: "Structured per-(module,substream_label) RNG consumption trace with cumulative totals: draws_total = Σ event draws (uniforms); blocks_total = Σ event counter deltas (PRNG blocks). No equality between the two is implied."
      # Final-row selection (validator note): choose the row with the max (after_hi, after_lo) in unsigned lexicographic order;
      # if tied, use latest ts_utc; if still tied, choose the row with the lexicographically largest (events_total, blocks_total, draws_total);
      # if still tied, pick the lexicographically largest part filename. Informational comment; schema unchanged.
      record:
        type: object
        additionalProperties: false
        required: [ts_utc, run_id, seed, module, substream_label,
                   rng_counter_before_lo, rng_counter_before_hi, rng_counter_after_lo, rng_counter_after_hi,
                   draws_total, blocks_total, events_total]
        properties:
          ts_utc: { type: string, format: date-time }
          run_id:  { $ref: "#/$defs/hex32" }
          seed:   { $ref: "#/$defs/uint64" }
          module: { type: string }
          substream_label: { $ref: "#/$defs/stream_label" }
          draws_total:  { $ref: "#/$defs/uint64", description: "Cumulative number of uniforms consumed for this (module, substream_label) in the run (saturating sum)." }
          blocks_total: { $ref: "#/$defs/uint64", description: "Cumulative PRNG block count per (module, substream_label) in the run (saturating sum)." }
          events_total: { $ref: "#/$defs/uint64", description: "Cumulative number of event rows observed for this (module, substream_label) in the run (saturating sum)." }
          rng_counter_before_lo: { $ref: "#/$defs/uint64" }
          rng_counter_before_hi: { $ref: "#/$defs/uint64" }
          rng_counter_after_lo:  { $ref: "#/$defs/uint64" }
          rng_counter_after_hi:  { $ref: "#/$defs/uint64" }
          detail: { type: string, nullable: true }

  # -- RNG: Event schemas (JSONL) ------------------------------------------
  events:

    hurdle_bernoulli:
      allOf:
        - $ref: "#/$defs/rng_envelope"
        - type: object
          required: [merchant_id, pi, u, is_multi, deterministic]   # deterministic flag is authoritative; 'u' becomes conditional
          properties:
            # Envelope literal closure for this stream
            module:          { const: "1A.hurdle_sampler" }
            substream_label: { const: "hurdle_bernoulli" }
            # Budget constraints for this family
            blocks: { type: integer, enum: [0,1], description: "Exactly one or zero Philox blocks consumed." }
            draws:  { type: string,  enum: ["0","1"], description: "Decimal-encoded uint128; exactly 0 or 1 uniform." }
            # Payload
            merchant_id: { $ref: "#/$defs/id64" }
            pi: { $ref: "#/$defs/pct01", description: "Logistic probability of being multi-site." }
            is_multi: { type: boolean, description: "Outcome: true ⇒ multi-site." }
            deterministic: { type: boolean, description: "True iff π ∈ {0,1}. When true, no uniform is consumed and 'u' MUST be null." }
            u:
              oneOf:
                - { type: "null", description: "Only valid when deterministic = true." }
                - { $ref: "#/$defs/u01", description: "Open-interval uniform used only when deterministic = false." }
            # optional diagnostics (non-authoritative)
            eta: { type: number, description: "Linear predictor (binary64).", nullable: true }
            gdp_bucket_id: { type: integer, minimum: 1, maximum: 5, description: "From design matrix.", nullable: true }
            mcc: { type: integer, minimum: 0, maximum: 9999, description: "MCC (from design).", nullable: true }
            channel: { type: string, enum: ["card_present","card_not_present"], description: "Channel (from design).", nullable: true }
          allOf:
            - if: { properties: { deterministic: { const: true } } }
              then:
                properties: { u: { type: "null" } }
            - if: { properties: { deterministic: { const: false } } }
              then:
                required: [u]
        - type: object
          unevaluatedProperties: false

    gamma_component:
      allOf:
        - $ref: "#/$defs/rng_envelope"
        - type: object
          required: [merchant_id, context, index, alpha, gamma_value]
          properties:
            merchant_id: { $ref: "#/$defs/id64" }
            context: { type: string, enum: ["nb","dirichlet"], description: "NB mixture vs Dirichlet sampler." }
            index:   { type: integer, minimum: 0, description: "Component index (Dirichlet i, or NB=0)." }
            country_iso: { $ref: "#/$defs/iso2", nullable: true, description: "Present for Dirichlet components." }
            alpha:   { type: number, exclusiveMinimum: 0.0, description: "Gamma shape parameter." }
            gamma_value: { type: number, exclusiveMinimum: 0.0, description: "Sampled Gamma(α,1) deviate." }
        - type: object
          unevaluatedProperties: false

    poisson_component:
      allOf:
        - $ref: "#/$defs/rng_envelope"
        - type: object
          required: [merchant_id, context, lambda, k]
          properties:
            merchant_id: { $ref: "#/$defs/id64" }
            context: { type: string, enum: ["nb","ztp"], description: "NB composition or ZTP sampler." }
            lambda:  { type: number, exclusiveMinimum: 0.0 }
            k:       { type: integer, minimum: 0, description: "Poisson draw (untruncated)." }
        - type: object
          unevaluatedProperties: false

    nb_final:
      allOf:
        - $ref: "#/$defs/rng_envelope"
        - type: object
          required: [merchant_id, mu, dispersion_k, n_outlets, nb_rejections]
          properties:
            merchant_id:   { $ref: "#/$defs/id64" }
            mu:            { type: number, exclusiveMinimum: 0.0, description: "NB mean parameter." }
            dispersion_k:  { type: number, exclusiveMinimum: 0.0, description: "NB dispersion (size) parameter." }
            n_outlets:     { type: integer, minimum: 2, description: "Accepted NB draw N (rejected if {0,1})." }
            nb_rejections: { type: integer, minimum: 0, description: "Count of rejected {0,1} draws before acceptance." }
            method:        { type: string, enum: ["poisson_gamma_mixture"] }
        - type: object
          unevaluatedProperties: false

    ztp_rejection:
      allOf:
        - $ref: "#/$defs/rng_envelope"
        - type: object
          required: [merchant_id, lambda_extra, k, attempt]
          properties:
            merchant_id:  { $ref: "#/$defs/id64" }
            lambda_extra: { type: number, exclusiveMinimum: 0.0, description: "λ for extra-country count." }
            k:            { type: integer, const: 0, description: "Rejected draw (ZTP zero)." }
            attempt:      { type: integer, minimum: 1, maximum: 64 }
        - type: object
          unevaluatedProperties: false

    ztp_retry_exhausted:
      allOf:
        - $ref: "#/$defs/rng_envelope"
        - type: object
          required: [merchant_id, lambda_extra, attempts, aborted]
          properties:
            merchant_id:  { $ref: "#/$defs/id64" }
            lambda_extra: { type: number, exclusiveMinimum: 0.0 }
            attempts:     { type: integer, const: 64 }
            aborted:      { type: boolean, const: true }
        - type: object
          unevaluatedProperties: false

    ztp_final:
      $id: "/rng/events/ztp_final"
      title: "S4 ZTP finaliser (non-consuming)"
      description: >
        Single acceptance record per resolved merchant in S4. Non-consuming row that fixes
        {K_target, lambda_extra, attempts, regime, exhausted?[, reason?]} and closes the ZTP loop.
        Envelope identities for non-consuming rows MUST hold: before==after, blocks=0, draws="0".
      type: object
      allOf:
        # Reuse the standard RNG envelope for event rows (ts_utc, module, substream_label, context, counters, blocks, draws)
        - $ref: "#/rng/core/envelope_min"
        - type: object
          properties:
            module: { const: "1A.s4.ztp" }
            substream_label: { const: "poisson_component" }
            context: { const: "ztp" }
            merchant_id: { type: integer, minimum: -9223372036854775808, maximum: 9223372036854775807 }
            K_target: { type: integer, minimum: 0 }
            lambda_extra: { type: number }
            attempts: { type: integer, minimum: 0 }
            regime: { type: string, enum: [ "inversion","ptrs" ] }
            exhausted: { type: boolean }
            reason:
              description: "Optional A=0 audit reason; only present in schema versions that include it."
              type: string
              enum: ["no_admissible"]
          required: [ module, substream_label, context, merchant_id, K_target, lambda_extra, attempts, regime ]
          additionalProperties: false

    gumbel_key:
      allOf:
        - $ref: "#/$defs/rng_envelope"
        - type: object
          required: [merchant_id, country_iso, weight, u, key, selected]
          properties:
            merchant_id: { $ref: "#/$defs/id64" }
            country_iso: { $ref: "#/$defs/iso2" }
            weight:      { $ref: "#/$defs/pct01", description: "Renormalised candidate weight." }
            u:           { $ref: "#/$defs/u01" }
            key:         { type: number, description: "log(w) - log(-log u)" }
            selected:    { type: boolean, description: "True if country among the top-K." }
            selection_order: { type: integer, minimum: 1, nullable: true, description: "1..K when selected; null otherwise." }
        - type: object
          unevaluatedProperties: false

    normal_box_muller:
      description: "Standard normal via Box–Muller; two-uniform event; sine mate discarded."
      allOf:
        - $ref: "#/$defs/rng_envelope"
        - type: object
          properties:
            substream_label: { const: "normal_box_muller", description: "Fixed label for Box–Muller helper." }
            blocks: { const: 1, description: "Exactly one Philox block for two uniforms." }
            draws: { type: string, enum: [ "2" ], description: "Decimal-encoded uint128; exactly two uniforms." }
            payload:
              type: object
              additionalProperties: false
              required: [z]
              properties:
                z: { type: number, description: "Standard normal deviate N(0,1) from Box–Muller (cosine branch); no caching." }
          required: [payload]
        - type: object
          unevaluatedProperties: false

    dirichlet_gamma_vector:
      allOf:
        - $ref: "#/$defs/rng_envelope"
        - type: object
          required: [merchant_id, home_country_iso, country_isos, alpha, gamma_raw, weights]
          properties:
            merchant_id:      { $ref: "#/$defs/id64" }
            home_country_iso: { $ref: "#/$defs/iso2" }
            country_isos:
              type: array
              minItems: 1
              items: { $ref: "#/$defs/iso2" }
              description: "Order: home first, then foreigns in Gumbel order."
            alpha:
              type: array
              minItems: 1
              items: { type: number, exclusiveMinimum: 0.0 }
              description: "Dirichlet α-vector, length == len(country_isos)."
            gamma_raw:
              type: array
              minItems: 1
              items: { type: number, exclusiveMinimum: 0.0 }
              description: "Raw Gamma(α_i,1) deviates."
            weights:
              type: array
              minItems: 1
              items: { $ref: "#/$defs/pct01" }
              description: "Normalised w_i; Σ w_i == 1 to 1e-6."
            n_domestic: { type: integer, minimum: 1, nullable: true, description: "Optional diagnostic: domestic outlet count N used to scale." }
          constraints:
            - type: equal_length
              arrays: ["country_isos","alpha","gamma_raw","weights"]
            - type: sum_equals_one
              array: "weights"
              tolerance: 1e-6
        - type: object
          unevaluatedProperties: false

    stream_jump:
      allOf:
        - $ref: "#/$defs/rng_envelope"
        - type: object
          required: [reason, jump_stride_lo, jump_stride_hi]
          properties:
            reason: { type: string, enum: ["init","module_start","reset","advance"], description: "Why jump occurred." }
            jump_stride_lo: { $ref: "#/$defs/uint64", description: "Lower 64 bits of stride (e.g., first 64b of SHA-256(label))." }
            jump_stride_hi: { $ref: "#/$defs/uint64", description: "Upper 64 bits of stride (if used)." }
        - type: object
          unevaluatedProperties: false

    sequence_finalize:
      allOf:
        - $ref: "#/$defs/rng_envelope"
        - type: object
          required: [merchant_id, country_iso, site_count, start_sequence, end_sequence]
          properties:
            merchant_id:    { $ref: "#/$defs/id64" }
            country_iso:    { $ref: "#/$defs/iso2" }
            site_count:     { type: integer, minimum: 0 }
            start_sequence: { $ref: "#/$defs/six_digit_seq" }
            end_sequence:   { $ref: "#/$defs/six_digit_seq" }
        - type: object
          unevaluatedProperties: false

    residual_rank:
      allOf:
        - $ref: "#/$defs/rng_envelope"
        - type: object
          required: [merchant_id, country_iso, residual, residual_rank]
          properties:
            merchant_id:    { $ref: "#/$defs/id64" }
            country_iso:    { $ref: "#/$defs/iso2" }
            # Note: residuals are quantised to 8 dp by the engine; rounding tolerance is validated in invariants, not in schema.
            residual:      { type: number, minimum: 0.0, maximum: 1.0, description: "Largest-remainder residual in [0,1)." }
            residual_rank: { type: integer, minimum: 1 }
        - type: object
          unevaluatedProperties: false

    site_sequence_overflow:
      allOf:
        - $ref: "#/$defs/rng_envelope"
        - type: object
          required: [merchant_id, country_iso, attempted_count, max_seq, overflow_by, severity]
          properties:
            merchant_id:     { $ref: "#/$defs/id64" }
            country_iso:     { $ref: "#/$defs/iso2" }
            attempted_count: { type: integer, minimum: 0, description: "Requested n_i for this country." }
            max_seq:         { type: integer, const: 999999, description: "6-digit ceiling." }
            overflow_by:     { type: integer, minimum: 1 }
            severity:        { type: string, enum: ["ERROR"], description: "Hard guardrail triggers abort." }
        - type: object
          unevaluatedProperties: false


governance:
  numeric_policy_profile:
    type: object
    required: [rounding, fma, ftz_daz, subnormals]
    properties:
      rounding: { type: string, enum: ["RNE"] }
      fma: { type: string, enum: ["off"] }
      ftz_daz: { type: string, enum: ["off"] }
      subnormals: { type: string, enum: ["preserved"] }
      notes: { type: string, nullable: true }
  math_profile_manifest:
    type: object
    required: [math_profile_id, vendor, version, functions]
    properties:
      math_profile_id: { type: string }
      vendor: { type: string }
      version: { type: string }
      functions:
        type: array
        items: { type: string }
      checksum:
        type: string
        pattern: "^[0-9a-f]{64}$"


validation:
  numeric_policy_attest:
    type: object
    required: [passed, rounding_ok, fma_off_ok, subnormals_ok, libm_regression_ok, neumaier_ok, total_order_ok, math_profile_id, profile_functions]
    properties:
      passed: { type: boolean }
      rounding_ok: { type: boolean }
      fma_off_ok: { type: boolean }
      subnormals_ok: { type: boolean }
      libm_regression_ok: { type: boolean }
      neumaier_ok: { type: boolean }
      total_order_ok: { type: boolean }
      math_profile_id: { type: string }
      profile_functions:
        type: array
        items: { type: string }
  parameter_hash_resolved:
    type: object
    required: [parameter_hash, artifact_count]
    properties:
      parameter_hash:
        type: string
        pattern: "^[0-9a-f]{64}$"
      filenames_sorted:
        type: array
        items: { type: string }
      artifact_count:
        type: integer
        minimum: 0
  manifest_fingerprint_resolved:
    type: object
    required: [manifest_fingerprint, artifact_count, git_commit_hex, parameter_hash]
    properties:
      manifest_fingerprint:
        type: string
        pattern: "^[0-9a-f]{64}$"
      artifact_count:
        type: integer
        minimum: 0
      git_commit_hex:
        type: string
        pattern: "^[0-9a-f]{64}$"
      parameter_hash:
        type: string
        pattern: "^[0-9a-f]{64}$"
  fingerprint_artifacts:
    type: object
    required: [path, sha256, size_bytes]
    properties:
      path: { type: string }
      sha256:
        type: string
        pattern: "^[0-9a-f]{64}$"
      size_bytes:
        type: integer
        minimum: 0
  run_environ:
    type: object
    properties:
      hostname: { type: string }
      platform: { type: string }
      build_commit: { type: string }
      code_digest:
        type: string
        pattern: "^[0-9a-f]{64}$"
