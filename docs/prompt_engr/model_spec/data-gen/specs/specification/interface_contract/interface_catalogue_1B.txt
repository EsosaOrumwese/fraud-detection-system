--- IC 1 ---
Stage: LoadSpatialManifest
Anchor: "build opens a manifest called **`spatial_manifest.json`**, concatenates every digest in lexical path order, hashes that concatenation, and embeds the result into every row it writes as the column **`spatial_manifest_digest`**." :contentReference[oaicite:11]{index=11}
Input_artefact: spatial_manifest.json
Input_schema: Yes
Output_artefact: Missing
Output_schema: No
Partitioning_rule: No
Success_metric: No
Error_code_policy: Abort on alternate manifest filename or extra files
Schema_version: Missing
Access_policy: Missing
Consumed_by: BuildSpatialManifestDigest
Test_pathway: Missing
Gap_flags:
  input_missing=N
  input_schema_missing=N
  output_missing=Y
  output_schema_missing=Y
  partition_missing=Y
  metric_missing=Y
  error_policy_missing=Y
  schema_version_missing=Y
  access_policy_missing=Y
  consumed_by_missing=N
  test_pathway_missing=Y
Severity=High
Context: “… The build opens a manifest called **`spatial_manifest.json`**, concatenates every digest in lexical path order, hashes that concatenation …” 
Confidence=HIGH
--- END IC 1 ---

--- IC 2 ---
Stage: BuildSpatialManifestDigest
Anchor: "The overall build fingerprint = SHA-256( upstream `manifest_fingerprint` || `spatial_manifest_digest` || digests of `footfall_coefficients.yaml`, `winsor.yml`, and `fallback_policy.yml` ); CI recomputes `spatial_manifest_digest` after zeroing the timestamp to assert exclusion of wall-clock time." :contentReference[oaicite:12]{index=12}
Input_artefact: spatial_manifest.json
Input_schema: Yes
Output_artefact: Missing
Output_schema: No
Partitioning_rule: No
Success_metric: No
Error_code_policy: Abort on timestamp inclusion in digest
Schema_version: Missing
Access_policy: Missing
Consumed_by: BuildSpatialPriorLibrary
Test_pathway: Missing
Gap_flags:
  input_missing=N
  input_schema_missing=N
  output_missing=Y
  output_schema_missing=Y
  partition_missing=Y
  metric_missing=Y
  error_policy_missing=Y
  schema_version_missing=Y
  access_policy_missing=Y
  consumed_by_missing=N
  test_pathway_missing=Y
Severity=High
Context: “… overall build fingerprint = SHA-256( upstream `manifest_fingerprint` || `spatial_manifest_digest` … ); CI recomputes `spatial_manifest_digest` after zeroing the timestamp …” 
Confidence=MEDIUM
--- END IC 2 ---

--- IC 3 ---
Stage: BuildSpatialPriorLibrary
Anchor: "The first step is to prepare a **library of spatial priors** keyed by `(mcc_code, channel)`." :contentReference[oaicite:13]{index=13}
Input_artefact: spatial_manifest.json
Input_schema: Partial
Output_artefact: Missing
Output_schema: No
Partitioning_rule: No
Success_metric: No
Error_code_policy: Abort on missing or unlisted artefact
Schema_version: Missing
Access_policy: Missing
Consumed_by: BlendRasterPriors
Test_pathway: Missing
Gap_flags:
  input_missing=N
  input_schema_missing=Y
  output_missing=Y
  output_schema_missing=Y
  partition_missing=Y
  metric_missing=Y
  error_policy_missing=Y
  schema_version_missing=Y
  access_policy_missing=Y
  consumed_by_missing=N
  test_pathway_missing=Y
Severity=High
Context: “… prepare a library of spatial priors keyed by `(mcc_code, channel)` … Each file in the prior library is accompanied by a checksum file …” 
Confidence=HIGH
--- END IC 3 ---

--- IC 4 ---
Stage: BlendRasterPriors
Anchor: "The blended raster is written once to a deterministic content-addressed path `cache/blends/{sha256(component_digests+weights)}.tif` via atomic temp-rename and, if already present, reused read-only." :contentReference[oaicite:14]{index=14}
Input_artefact: spatial_blend.yaml, artefacts/priors/*.tif, artefacts/priors/*.gpkg
Input_schema: Partial
Output_artefact: cache/blends/{sha256(component_digests+weights)}.tif
Output_schema: No
Partitioning_rule: No
Success_metric: No
Error_code_policy: Abort on semver/digest mismatch or CI failure
Schema_version: Partial
Access_policy: Missing
Consumed_by: BuildFenwickTree
Test_pathway: Missing
Gap_flags:
  input_missing=N
  input_schema_missing=Y
  output_missing=N
  output_schema_missing=Y
  partition_missing=Y
  metric_missing=Y
  error_policy_missing=Y
  schema_version_missing=Y
  access_policy_missing=Y
  consumed_by_missing=N
  test_pathway_missing=Y
Severity=High
Context: “… blended raster is written once to a deterministic content-addressed path `cache/blends/{sha256…}.tif` via atomic temp-rename …” 
Confidence=MEDIUM
--- END IC 4 ---

--- IC 5 ---
Stage: BuildFenwickTree
Anchor: "A single Fenwick tree is built *eagerly* for every (country, prior_id) pair on first reference with double-checked locking … Weights scaling: compute W_f = Σ w_i … store w_i' = max(1, floor(w_i × S)) … log W_f, S, Σ integer weights." :contentReference[oaicite:15]{index=15}
Input_artefact: cache/blends/{sha256…}.tif
Input_schema: No
Output_artefact: placement_audit.log
Output_schema: Yes
Partitioning_rule: No
Success_metric: No
Error_code_policy: Abort on lock mismatch or overflow
Schema_version: Missing
Access_policy: Missing
Consumed_by: SampleCoordinate
Test_pathway: Missing
Gap_flags:
  input_missing=N
  input_schema_missing=Y
  output_missing=N
  output_schema_missing=N
  partition_missing=Y
  metric_missing=Y
  error_policy_missing=N
  schema_version_missing=Y
  access_policy_missing=Y
  consumed_by_missing=N
  test_pathway_missing=Y
Severity=Medium
Context: “… Fenwick tree is built eagerly … log W_f, S, Σ integer weights.” 
Confidence=HIGH
--- END IC 5 ---

--- IC 6 ---
Stage: SampleCoordinate
Anchor: "The engine samples a pixel index proportional to its weight, then converts the pixel to a single deterministic point at its center … if a polygon it is sampled uniformly … pre-triangulating …" :contentReference[oaicite:16]{index=16}
Input_artefact: cache/blends/{sha256…}.tif, spatial_manifest.json
Input_schema: No
Output_artefact: placement_audit.log
Output_schema: Yes
Partitioning_rule: No
Success_metric: No
Error_code_policy: Abort on infinite loop or missing geometry
Schema_version: Missing
Access_policy: Missing
Consumed_by: LandWaterFilter
Test_pathway: Missing
Gap_flags:
  input_missing=N
  input_schema_missing=Y
  output_missing=N
  output_schema_missing=N
  partition_missing=Y
  metric_missing=Y
  error_policy_missing=N
  schema_version_missing=Y
  access_policy_missing=Y
  consumed_by_missing=N
  test_pathway_missing=Y
Severity=Medium
Context: “… engine samples a pixel index proportional to its weight … if a polygon … pre-triangulating …” 
Confidence=MEDIUM
--- END IC 6 ---

--- IC 7 ---
Stage: LandWaterFilter
Anchor: "A candidate coordinate is rejected if it lies outside the land polygon or, when a road prior is used, if its closest-point distance to the sampled road segment exceeds 50 m." :contentReference[oaicite:17]{index=17}
Input_artefact: natural_earth_land_10m_v5.1.2.geojson
Input_schema: Partial
Output_artefact: placement_audit.log
Output_schema: Yes
Partitioning_rule: No
Success_metric: No
Error_code_policy: Abort on cap exceeded or missing mask
Schema_version: Missing
Access_policy: Missing
Consumed_by: AssignTimeZone
Test_pathway: Missing
Gap_flags:
  input_missing=N
  input_schema_missing=Y
  output_missing=N
  output_schema_missing=N
  partition_missing=Y
  metric_missing=Y
  error_policy_missing=N
  schema_version_missing=Y
  access_policy_missing=Y
  consumed_by_missing=N
  test_pathway_missing=Y
Severity=Medium
Context: “… rejected if it lies outside the land polygon or … exceeds 50 m from road segment.” 
Confidence=HIGH
--- END IC 7 ---

--- IC 8 ---
Stage: AssignTimeZone
Anchor: "Engine calls `tz_world.lookup(lat, lon)` to retrieve the IANA time-zone id and then consults a governed zone→ISO table (`tz_world_metadata.json`) … Non-whitelisted mismatches trigger a resample attempt …" :contentReference[oaicite:18]{index=18}
Input_artefact: tz_world_metadata.json
Input_schema: Partial
Output_artefact: placement_audit.log
Output_schema: Yes
Partitioning_rule: No
Success_metric: No
Error_code_policy: Abort on tz_mismatch_exhausted
Schema_version: Missing
Access_policy: Missing
Consumed_by: ComputeFootfall
Test_pathway: Missing
Gap_flags:
  input_missing=N
  input_schema_missing=Y
  output_missing=N
  output_schema_missing=N
  partition_missing=Y
  metric_missing=Y
  error_policy_missing=N
  schema_version_missing=Y
  access_policy_missing=Y
  consumed_by_missing=N
  test_pathway_missing=Y
Severity=Medium
Context: “… calls `tz_world.lookup(lat, lon)` … consults `tz_world_metadata.json` … Non-whitelisted mismatches trigger a resample attempt …” 
Confidence=MEDIUM
--- END IC 8 ---

--- IC 9 ---
Stage: ComputeFootTraffic
Anchor: "Footfall scalar formula: `footfall = κ_(mcc,channel) × prior_weight_raw × exp(ε)`, ε ~ N(0, σ²) … event `footfall_draw` logs merchant_id, site_id, kappa, sigma, epsilon, footfall_preclip." :contentReference[oaicite:19]{index=19}
Input_artefact: footfall_coefficients.yaml
Input_schema: Yes
Output_artefact: placement_audit.log
Output_schema: Yes
Partitioning_rule: No
Success_metric: No
Error_code_policy: Abort on RNG error
Schema_version: Missing
Access_policy: Missing
Consumed_by: WriteSiteParquet
Test_pathway: Missing
Gap_flags:
  input_missing=N
  input_schema_missing=N
  output_missing=N
  output_schema_missing=N
  partition_missing=Y
  metric_missing=Y
  error_policy_missing=N
  schema_version_missing=Y
  access_policy_missing=Y
  consumed_by_missing=N
  test_pathway_missing=Y
Severity=Medium
Context: “… footfall = κ_(mcc,channel) × prior_weight_raw × exp(ε)… event `footfall_draw` logs …” 
Confidence=HIGH
--- END IC 9 ---

--- IC 10 ---
Stage: WriteSiteParquet
Anchor: "Each completed site row is written immediately to a Parquet partition keyed by `merchant_id` and `site_id` … first to a temp file … then atomically renamed … guaranteeing idempotent reruns." :contentReference[oaicite:20]{index=20}
Input_artefact: placement_temp_files
Input_schema: Partial
Output_artefact: site_catalogue/partition_date=YYYYMMDD/merchant_id={id}/site_id={site_id}.parquet
Output_schema: Partial
Partitioning_rule: Yes
Success_metric: No
Error_code_policy: Abort on protocol violation
Schema_version: Present
Access_policy: Missing
Consumed_by: FinalManifestWriter
Test_pathway: Missing
Gap_flags:
  input_missing=N
  input_schema_missing=Y
  output_missing=N
  output_schema_missing=Y
  partition_missing=N
  metric_missing=Y
  error_policy_missing=N
  schema_version_missing=N
  access_policy_missing=Y
  consumed_by_missing=N
  test_pathway_missing=Y
Severity=High
Context: “… written immediately to a Parquet partition keyed by `merchant_id` and `site_id` … then atomically renamed …” 
Confidence=MEDIUM
--- END IC 10 ---

--- IC 11 ---
Stage: FinalManifestWriter
Anchor: "When all merchants are processed the build writes a **manifest JSON** that records the seed, the composite hash of every spatial artefact, and the wall-clock build time." :contentReference[oaicite:21]{index=21}
Input_artefact: spatial_manifest.json, site_catalogue_schema.json
Input_schema: Partial
Output_artefact: spatial_catalogue_manifest.json
Output_schema: Yes
Partitioning_rule: No
Success_metric: No
Error_code_policy: Abort on write failure
Schema_version: Missing
Access_policy: Missing
Consumed_by: DownstreamSimulation
Test_pathway: Missing
Gap_flags:
  input_missing=N
  input_schema_missing=Y
  output_missing=N
  output_schema_missing=Y
  partition_missing=Y
  metric_missing=Y
  error_policy_missing=Y
  schema_version_missing=Y
  access_policy_missing=Y
  consumed_by_missing=N
  test_pathway_missing=Y
Severity=Medium
Context: “… build writes a manifest JSON that records the seed, the composite hash … and the wall-clock build time.” 
Confidence=MEDIUM
--- END IC 11 ---

<<IC-END>>