<<<IC-FIX id=1>
Stage: ComputeProbabilityVector
INPUT_ARTIFACT:
name: site_catalogue
path_pattern: s3://data-engine/artefacts/catalogue/site_catalogue.parquet  # path reserved by spec.
sha256: <to-be-populated-on-build>  # placeholder
schema: |
{
  "name": "site_catalogue",
  "type": "record",
  "fields": [
    {"name":"merchant_id","type":"string","nullable":false},
    {"name":"site_id","type":"string","nullable":false},
    {"name":"geometry","type":"string","nullable":false},
    {"name":"footfall_weight","type":"double","nullable":false}
  ]
}
INPUT_ARTIFACT:
name: routing_errors_config
path_pattern: s3://data-engine/config/routing/errors.yml  # File not yet created; path is reserved by spec.
sha256: <to-be-populated-on-build>  # placeholder
schema: |
{
  "name": "routing_errors_config",
  "type": "record",
  "fields": [
    {"name":"error_code","type":"int","nullable":false},
    {"name":"description","type":"string","nullable":false},
    {"name":"retry_policy","type":"string","nullable":false}
  ]
}
OUTPUT_ARTIFACT:
name: merchant_pweights
path_pattern: s3://data-engine/{merchant_id}_pweights.bin  # path reserved by spec.
sha256: <to-be-populated-on-build>  # placeholder
schema: |
{
  "type": "binary",
  "endianness":"little",
  "dtype":"float64"
}
PARTITIONING:
keys: []
order_by: []
SUCCESS_METRIC:
metric_name: weight_digest_match                    # SHA-256(pweights.bin)
expected_range: [1, 1]
ERROR_POLICY:
error_code: RoutingZeroWeightError  # defined in errors.yml
retry_max: 3
retry_backoff_sec: 60
idempotent: true
SCHEMA_VERSION:
version: v1.0.0-draft
ACCESS_POLICY:
read_policy: processing-team-read  # placeholder
write_policy: routing-team-write  # placeholder
CONSUMED_BY:
module: BuildAliasTableModule
function: computeProbabilityVector
description: Generates per-merchant probability weights for alias sampling
TEST_PATHWAY:
test_type: integration
tool: pytest
script: tests/test_compute_probability_vector.py  # CI test to be implemented after pipeline is in place
assertion: file exists and weight_digest recorded
Confidence=HIGH
<<<END IC-FIX>>>

<<<IC-FIX id=2>
Stage: BuildAliasTable
INPUT_ARTIFACT:
name: merchant_pweights
path_pattern: s3://data-engine/{merchant_id}_pweights.bin  # path reserved by spec.
sha256: <to-be-populated-on-build>  # placeholder
schema: |
{ "type": "binary" }
OUTPUT_ARTIFACT:
name: merchant_alias
path_pattern: s3://data-engine/{merchant_id}_alias.npz  # path reserved by spec.
sha256: <to-be-populated-on-build>  # placeholder
schema: |
{ "type": "binary" }
PARTITIONING:
keys: []
order_by: []
SUCCESS_METRIC:
metric_name: alias_digest_match
expected_range: [1, 1]
ERROR_POLICY:
error_code: AliasHashMismatchError  # defined in errors.yml
retry_max: 3
retry_backoff_sec: 60
idempotent: true
SCHEMA_VERSION:
version: v1.0.0-draft
ACCESS_POLICY:
read_policy: routing-team-read  # placeholder
write_policy: routing-team-write  # placeholder
CONSUMED_BY:
module: RouteTransactionModule
function: buildAliasTable
description: Constructs alias table for O(1) sampling
TEST_PATHWAY:
test_type: integration
tool: pytest
script: tests/test_build_alias_table.py  # CI test to be implemented after pipeline is in place
assertion: alias file exists and alias_digest recorded
Confidence=HIGH
<<<END IC-FIX>>>

<<<IC-FIX id=3>
Stage: BuildCdnAliasTable
INPUT_ARTIFACT:
name: cdn_weights_config
path_pattern: s3://data-engine/{merchant_id}_cdn_alias.npz  # File not yet created; path is reserved by spec.
sha256: <to-be-populated-on-build>  # placeholder
schema: |
{
  "name": "cdn_weights_config",
  "type": "record",
  "fields": [
    {"name":"country_code","type":"string","nullable":false},
    {"name":"q_c","type":"double","nullable":false}
  ]
}
OUTPUT_ARTIFACT:
name: merchant_cdn_alias
path_pattern: s3://data-engine/processed/routing/{merchant_id}_cdn_alias.npz  # path reserved by spec.
sha256: <to-be-populated-on-build>  # placeholder
schema: |
{ "type": "binary" }
PARTITIONING:
keys: []
order_by: []
SUCCESS_METRIC:
metric_name: file_existence
expected_range: [1, 1]
ERROR_POLICY:
error_code: CdnAliasHashMismatchError
retry_max: 3
retry_backoff_sec: 60
idempotent: true
SCHEMA_VERSION:
version: v1.0.0-draft
ACCESS_POLICY:
read_policy: routing-team-read  # placeholder
write_policy: routing-team-write  # placeholder
CONSUMED_BY:
module: RouteTransactionModule
function: buildCdnAliasTable
description: Constructs CDN alias table for virtual merchants
TEST_PATHWAY:
test_type: integration
tool: pytest
script: tests/test_build_cdn_alias_table.py  # CI test to be implemented after pipeline is in place
assertion: cdn_alias file exists and alias_digest recorded
Confidence=MEDIUM
<<<END IC-FIX>>>

<<<IC-FIX id=4>
Stage: RouteTransaction
INPUT_ARTIFACT:
name: merchant_alias
path_pattern: s3://data-engine/processed/routing/{merchant_id}_alias.npz  # path reserved by spec.
sha256: <to-be-populated-on-build>  # placeholder
schema: |
{ "type": "binary" }
INPUT_ARTIFACT:
name: routing_day_effect
path_pattern: s3://data-engine/config/routing/routing_day_effect.yml  # File not yet created; path is reserved by spec.
sha256: <to-be-populated-on-build>  # placeholder
schema: |
{
  "name": "routing_day_effect",
  "type": "record",
  "fields": [
    {"name":"date","type":"string","nullable":false},
    {"name":"gamma","type":"double","nullable":false}
  ]
}
INPUT_ARTIFACT:
name: rng_policy
path_pattern: s3://data-engine/config/routing/rng_policy.yml  # File not yet created; path is reserved by spec.
sha256: <to-be-populated-on-build>  # placeholder
schema: |
{
  "name": "rng_policy",
  "type": "record",
  "fields": [
    {"name":"max_stride","type":"int","nullable":false},
    {"name":"seed_offset","type":"long","nullable":false}
  ]
}
OUTPUT_ARTIFACT:
name: routing_audit_log
path_pattern: s3://data-engine/logs/routing/routing_audit.log  # path reserved by spec.
sha256: <to-be-populated-on-build>  # placeholder
schema: |
{
  "name": "routing_audit_log",
  "type": "record",
  "fields": [
    {"name":"merchant_id","type":"string","nullable":false},
    {"name":"site_id","type":"string","nullable":false},
    {"name":"tzid","type":"string","nullable":false},
    {"name":"timestamp","type":"long","nullable":false},
    {"name":"batch_index","type":"long","nullable":false},
    {"name":"counter_vector","type":{"type":"array","items":"long"},"nullable":false},
    {"name":"event_type","type":"string","nullable":false},
    {"name":"routing_manifest_digest","type":"string","nullable":false},
    {"name":"ip_country_code","type":"string","nullable":true},
    {"name":"error_type","type":"string","nullable":true},
    {"name":"error_details","type":"string","nullable":true}
  ]
}
PARTITIONING:
keys: []
order_by: []
SUCCESS_METRIC:
metric_name: file_existence
expected_range: [1, 1]
ERROR_POLICY:
error_code: RoutingError  # generic fallback
retry_max: 1
retry_backoff_sec: 60
idempotent: true
SCHEMA_VERSION:
version: v1.0.0-draft
ACCESS_POLICY:
read_policy: routing-team-read  # placeholder
write_policy: audit-team-write  # placeholder
CONSUMED_BY:
module: NightlyRouterTest
function: routeTransaction
description: Routes each transaction to a site using alias lookup
TEST_PATHWAY:
test_type: integration
tool: pytest
script: tests/test_route_transaction.py  # CI test to be implemented after pipeline is in place
assertion: audit log entries equal routed count
Confidence=MEDIUM
<<<END IC-FIX>>>

<<<IC-FIX id=5>
Stage: AuditRouting
INPUT_ARTIFACT:
name: routing_audit_log
path_pattern: s3://data-engine/logs/routing/routing_audit.log  # path reserved by spec.
sha256: <to-be-populated-on-build>  # placeholder
schema: |
{
  "name": "routing_audit_log",
  "type": "record",
  "fields": [
    {"name":"merchant_id","type":"string","nullable":false},
    {"name":"batch_index","type":"long","nullable":false},
    {"name":"checksum","type":"string","nullable":false}
  ]
}
INPUT_ARTIFACT:
name: logging_config
path_pattern: s3://data-engine/config/routing/logging.yml  # File not yet created; path is reserved by spec.
sha256: <to-be-populated-on-build>  # placeholder
schema: |
{
  "name": "logging_config",
  "type": "record",
  "fields": [
    {"name":"rotation","type":"string","nullable":false},
    {"name":"retention_days","type":"int","nullable":false}
  ]
}
INPUT_ARTIFACT:
name: validation_config
path_pattern: s3://data-engine/config/routing/routing_validation.yml  # File not yet created; path is reserved by spec.
sha256: <to-be-populated-on-build>  # placeholder
schema: |
{
  "name": "validation_config",
  "type": "record",
  "fields": [
    {"name":"checksum_interval","type":"int","nullable":false},
    {"name":"auroc_threshold","type":"double","nullable":false}
  ]
}
OUTPUT_ARTIFACT:
name: routing_validation_log
path_pattern: s3://data-engine/logs/routing/validation.log  # path reserved by spec.
sha256: <to-be-populated-on-build>  # placeholder
schema: |
{
  "name": "routing_validation_log",
  "type": "record",
  "fields": [
    {"name":"date","type":"string","nullable":false},
    {"name":"status","type":"string","nullable":false},
    {"name":"details","type":"string","nullable":true}
  ]
}
PARTITIONING:
keys: []
order_by: []
SUCCESS_METRIC:
metric_name: validation_log_exists
expected_range: [1, 1]
ERROR_POLICY:
error_code: ValidationError
retry_max: 0
retry_backoff_sec: 0
idempotent: true
SCHEMA_VERSION:
version: v1.0.0-draft
ACCESS_POLICY:
read_policy: audit-team-read  # placeholder
write_policy: audit-team-write  # placeholder
CONSUMED_BY:
module: CI_CD_Pipeline
function: auditRouting
description: Validates routing audit checksums and retention policies
TEST_PATHWAY:
test_type: integration
tool: pytest
script: tests/test_audit_routing.py  # CI test to be implemented after pipeline is in place
assertion: validation report indicates all checks pass
Confidence=MEDIUM
<<<END IC-FIX>>}

<<<IC-FIX id=6>>
Stage: WriteRoutingManifest
INPUT_ARTIFACT:
  name: pweights_bin
  path_pattern: s3://data-engine/{merchant_id}_pweights.bin
  sha256: <to-be-populated-on-build>
INPUT_ARTIFACT:
  name: alias_npz
  path_pattern: s3://data-engine/{merchant_id}_alias.npz
  sha256: <to-be-populated-on-build>
INPUT_ARTIFACT:
  name: cdn_alias_npz
  path_pattern: s3://data-engine/{merchant_id}_cdn_alias.npz
  sha256: <to-be-populated-on-build>
OUTPUT_ARTIFACT:
  name: routing_manifest
  path_pattern: s3://data-engine/artefacts/routing/routing_manifest.json
  sha256: <to-be-populated-on-build>
SUCCESS_METRIC:
  metric_name: manifest_completeness
  expected_range: [1,1]
<<<END IC-FIX>>

<<<IC-FIX id=7>>
Stage: WriteOutputBuffer
INPUT_ARTIFACT:
  name: merchant_alias
  path_pattern: s3://data-engine/{merchant_id}_alias.npz
  sha256: <to-be-populated-on-build>
OUTPUT_ARTIFACT:
  name: output_buffer
  path_pattern: s3://data-engine/output/buffer/partition_date=*/merchant_id=*/batch_*.parquet
  sha256: <to-be-populated-on-build>
  schema: |
    {
      "name": "output_buffer",
      "type": "record",
      "fields": [
        {"name":"merchant_id","type":"string","nullable":false},
        {"name":"site_id","type":"string","nullable":false},
        {"name":"txn_id","type":"string","nullable":false},
        {"name":"gamma_id","type":"int","nullable":false},
        {"name":"gamma_value","type":"double","nullable":false},
        {"name":"ip_country_code","type":"string","nullable":true},
        {"name":"routing_manifest_digest","type":"string","nullable":false}
      ]
    }
SUCCESS_METRIC:
  metric_name: buffer_rowcount_positive
  expected_range: [1,]
<<<END IC-FIX>>

##### END INTERFACE_CONTRACT_SPEC #####

id=1 | gaps_closed=input|output|schema|metric|error|access | notes=Added error config and defined binary schema  
id=2 | gaps_closed=input|output|schema|metric|error|access | notes=Specified alias npz paths and schema  
id=3 | gaps_closed=input|output|schema|metric|error|access | notes=Defined CDN alias inputs and outputs  
id=4 | gaps_closed=input|output|schema|metric|error|access | notes=Formalized routing audit schema and policy  
id=5 | gaps_closed=input|output|schema|metric|error|access | notes=Added validation report artifact and configs  
<<IS-END>>