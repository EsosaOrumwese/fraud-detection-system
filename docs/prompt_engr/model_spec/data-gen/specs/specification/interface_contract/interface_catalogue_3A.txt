--- IC 1 ---
Stage: FlagEscalationCountries
Anchor: "During the allocation pass the algorithm takes the country-mass vector **v** produced by the hurdle layer, normalised so that its entries sum to one. For each entry $v_c$, the condition $v_c > \theta_{\text{mix}}$ is evaluated; if true the country’s outlets are earmarked for a time-zone mixture." :contentReference[oaicite:14]{index=14}
Input_artefact: Missing
Input_schema: No
Output_artefact: Missing
Output_schema: No
Partitioning_rule: No
Success_metric: No
Error_code_policy: Missing
Schema_version: Missing
Access_policy: Missing
Consumed_by: ComputeDirichletShares
Test_pathway: Missing
Gap_flags:
  input_missing=Y
  input_schema_missing=Y
  output_missing=Y
  output_schema_missing=Y
  partition_missing=Y
  metric_missing=Y
  error_policy_missing=Y
  schema_version_missing=Y
  access_policy_missing=Y
  consumed_by_missing=N
  test_pathway_missing=Y
Severity=Crit
Context: “… takes the country-mass vector **v** … $v_c > \theta_{\text{mix}}$ is evaluated … earmarked for a time-zone mixture …” 
Confidence=MEDIUM
--- END IC 1 ---

--- IC 2 ---
Stage: ComputeDirichletShares
Anchor: "Each queued country now needs an internal split across its legal time-zones. The engine opens the YAML ledger `config/allocation/country_zone_alphas.yaml`, finds the country key, and reads a concise Dirichlet concentration vector **α**." :contentReference[oaicite:15]{index=15}
Input_artefact: config/allocation/country_zone_alphas.yaml :contentReference[oaicite:16]{index=16}
Input_schema: Yes
Output_artefact: Missing
Output_schema: No
Partitioning_rule: No
Success_metric: No
Error_code_policy: Missing
Schema_version: semver
Access_policy: Missing
Consumed_by: ApplyDeterministicRounding
Test_pathway: Missing
Gap_flags:
  input_missing=N
  input_schema_missing=N
  output_missing=Y
  output_schema_missing=Y
  partition_missing=Y
  metric_missing=Y
  error_policy_missing=Y
  schema_version_missing=N
  access_policy_missing=Y
  consumed_by_missing=N
  test_pathway_missing=Y
Severity=High
Context: “… opens the YAML ledger `config/allocation/country_zone_alphas.yaml`, finds the country key, and reads … **α**.” 
Confidence=MEDIUM
--- END IC 2 ---

--- IC 3 ---
Stage: ApplyDeterministicRounding
Anchor: "Multiplying s by Nₙ yields a real-valued expected count per TZID. The engine applies the largest-remainder deterministic rounding so that the integers sum exactly to Nₙ and the relative rounding error is sub-one-outlet." :contentReference[oaicite:17]{index=17}
Input_artefact: Missing
Input_schema: No
Output_artefact: Missing
Output_schema: No
Partitioning_rule: No
Success_metric: No
Error_code_policy: Missing
Schema_version: Missing
Access_policy: Missing
Consumed_by: ApplyBumpRule
Test_pathway: property-based
Gap_flags:
  input_missing=Y
  input_schema_missing=Y
  output_missing=Y
  output_schema_missing=Y
  partition_missing=Y
  metric_missing=Y
  error_policy_missing=Y
  schema_version_missing=Y
  access_policy_missing=Y
  consumed_by_missing=N
  test_pathway_missing=N
Severity=Crit
Context: “… applies the largest-remainder deterministic rounding so that the integers sum exactly to Nₙ …” 
Confidence=HIGH
--- END IC 3 ---

--- IC 4 ---
Stage: ApplyBumpRule
Anchor: "However, corner cases arise when a zone’s expectation is high (say, 0.9) yet rounding would assign it zero outlets … To avoid wiping out such a zone, the code applies a bump rule: after standard rounding, it searches for any zone whose $e_z > 0.8$ and integer allotment is zero …" :contentReference[oaicite:18]{index=18}
Input_artefact: Missing
Input_schema: No
Output_artefact: Missing
Output_schema: No
Partitioning_rule: No
Success_metric: No
Error_code_policy: Missing
Schema_version: Missing
Access_policy: Missing
Consumed_by: ComputeMajorZoneFallback
Test_pathway: property-based
Gap_flags:
  input_missing=Y
  input_schema_missing=Y
  output_missing=Y
  output_schema_missing=Y
  partition_missing=Y
  metric_missing=Y
  error_policy_missing=Y
  schema_version_missing=Y
  access_policy_missing=Y
  consumed_by_missing=N
  test_pathway_missing=N
Severity=Crit
Context: “… code applies a bump rule … searches for any zone whose $e_z > 0.8$ and integer allotment is zero …” 
Confidence=HIGH
--- END IC 4 ---

--- IC 5 ---
Stage: ComputeMajorZoneFallback
Anchor: "Countries whose mass lies at or below θ bypass the Dirichlet logic. The code consults a CSV file called `artefacts/allocation/country_major_zone.csv` … The chosen zone is then assigned all outlets in that country. The CSV’s SHA-256 digest is stored under `major_zone_digest` in the manifest." 
Input_artefact: artefacts/allocation/country_major_zone.csv :contentReference[oaicite:19]{index=19}
Input_schema: Partial
Output_artefact: Missing
Output_schema: No
Partitioning_rule: No
Success_metric: No
Error_code_policy: Missing
Schema_version: Missing
Access_policy: Missing
Consumed_by: WriteZoneAllocParquet
Test_pathway: Missing
Gap_flags:
  input_missing=N
  input_schema_missing=Y
  output_missing=Y
  output_schema_missing=Y
  partition_missing=Y
  metric_missing=Y
  error_policy_missing=Y
  schema_version_missing=Y
  access_policy_missing=Y
  consumed_by_missing=N
  test_pathway_missing=Y
Severity=High
Context: “… bypass the Dirichlet logic. The code consults … `country_major_zone.csv` … The chosen zone is then assigned …” 
Confidence=MEDIUM
--- END IC 5 ---

--- IC 6 ---
Stage: EnforceZoneFloors
Anchor: "After the bump rule completes, the allocator scans every floor. If a zone’s integer count is below its floor, the deficit is stolen from the largest zone in the same country … The floor YAML’s digest, `zone_floor_digest`, is recorded; CI test `ci/test_zone_floor.py` regenerates the allocation and verifies the floors hold." 
Input_artefact: config/allocation/zone_floor.yml :contentReference[oaicite:20]{index=20}
Input_schema: Yes
Output_artefact: Missing
Output_schema: No
Partitioning_rule: No
Success_metric: No
Error_code_policy: Missing
Schema_version: semver
Access_policy: Missing
Consumed_by: WriteZoneAllocParquet
Test_pathway: integration
Gap_flags:
  input_missing=N
  input_schema_missing=N
  output_missing=Y
  output_schema_missing=Y
  partition_missing=Y
  metric_missing=Y
  error_policy_missing=Y
  schema_version_missing=N
  access_policy_missing=Y
  consumed_by_missing=N
  test_pathway_missing=Y
Severity=High
Context: “… allocator scans every floor … CI test `ci/test_zone_floor.py` regenerates …” 
Confidence=HIGH
--- END IC 6 ---

--- IC 7 ---
Stage: WriteZoneAllocParquet
Anchor: "The allocator emits `artefacts/allocation/<merchant_id>_zone_alloc.parquet`, schema `(country_iso STRING, tzid STRING, N_outlets UINT16)` sorted by `country_iso`, then `tzid`." :contentReference[oaicite:21]{index=21}
Input_artefact: Missing
Input_schema: No
Output_artefact: artefacts/allocation/<merchant_id>_zone_alloc.parquet :contentReference[oaicite:22]{index=22}
Output_schema: Yes
Partitioning_rule: Yes
Success_metric: No
Error_code_policy: Missing
Schema_version: schema_version
Access_policy: Missing
Consumed_by: AppendZoneAllocIndex
Test_pathway: Missing
Gap_flags:
  input_missing=Y
  input_schema_missing=Y
  output_missing=N
  output_schema_missing=N
  partition_missing=N
  metric_missing=Y
  error_policy_missing=Y
  schema_version_missing=Y
  access_policy_missing=Y
  consumed_by_missing=N
  test_pathway_missing=Y
Severity=High
Context: “… emits `artefacts/allocation/<merchant_id>_zone_alloc.parquet`, schema … sorted by …” 
Confidence=MEDIUM
--- END IC 7 ---

--- IC 8 ---
Stage: AppendZoneAllocIndex
Anchor: "Immediately after writing, it hashes the Parquet byte-for-byte and appends the line `<merchant_id>,<sha256>` to `artefacts/allocation/zone_alloc_index.csv`." :contentReference[oaicite:23]{index=23}
Input_artefact: artefacts/allocation/<merchant_id>_zone_alloc.parquet :contentReference[oaicite:24]{index=24}
Input_schema: Partial
Output_artefact: artefacts/allocation/zone_alloc_index.csv :contentReference[oaicite:25]{index=25}
Output_schema: Partial
Partitioning_rule: No
Success_metric: No
Error_code_policy: Missing
Schema_version: Missing
Access_policy: Missing
Consumed_by: Missing
Test_pathway: Missing
Gap_flags:
  input_missing=N
  input_schema_missing=Y
  output_missing=N
  output_schema_missing=Y
  partition_missing=Y
  metric_missing=Y
  error_policy_missing=Y
  schema_version_missing=Y
  access_policy_missing=Y
  consumed_by_missing=Y
  test_pathway_missing=Y
Severity=High
Context: “… hashes the Parquet … and appends … to `zone_alloc_index.csv`.” 
Confidence=MEDIUM
--- END IC 8 ---

<<IC-END>>