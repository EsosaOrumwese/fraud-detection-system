<<<IC-FIX id=1>
Stage: BuildSTRTreeIndex
INPUT_ARTIFACT:
name: tz_world_shapefile
path_pattern: s3://data-engine/artefacts/priors/tz_world/2025a/tz_world_2025a.*  # File not yet created; path is reserved by spec.
sha256: <to-be-populated-on-build>  # placeholder
schema: |
{
  "name": "tz_world_shapefile",
  "type": "record",
  "fields": [
    {"name":"file_path","type":"string","nullable":false},
    {"name":"file_type","type":"string","nullable":false}
  ]
}
OUTPUT_ARTIFACT:
name: tz_index_digest
path_pattern: s3://data-engine/processed/tz_index/tz_index_digest.txt  # path reserved by spec.
sha256: <to-be-populated-on-build>  # placeholder
schema: |
{
  "name": "tz_index_digest",
  "type": "record",
  "fields": [
    {"name":"tz_index_digest","type":"string","nullable":false}
  ]
}
PARTITIONING:
keys: []
order_by: []
SUCCESS_METRIC:
metric_name: file_existence
expected_range: [1,1]
ERROR_POLICY:
error_code: 1401
retry_max: 1
retry_backoff_sec: 30
idempotent: true
SCHEMA_VERSION:
version: v1.0.0-draft
ACCESS_POLICY:
read_policy: internal-data-team-read  # placeholder
write_policy: internal-data-team-write  # placeholder
CONSUMED_BY:
module: DeriveTimeZoneModule
function: buildSTRTreeIndex
description: Serialises STR-tree and computes digest for timezone lookup
TEST_PATHWAY:
test_type: integration
tool: pytest
script: tests/test_build_str_tree_index.py  # CI test to be implemented after pipeline is in place
assertion: tz_index_digest file exists and matches recomputed hash
Confidence=HIGH
<<<END IC-FIX>>>

<<<IC-FIX id=2>
Stage: DeriveTimeZone
INPUT_ARTIFACT:
name: site_coordinates
path_pattern: s3://data-engine/processed/site_catalogue/partition_date=*/merchant_id=*/site_id=*.parquet  # path reserved by spec.
sha256: <to-be-populated-on-build>  # placeholder
schema: |
{
  "name": "site_coordinates",
  "type": "record",
  "fields": [
    {"name":"merchant_id","type":"string","nullable":false},
    {"name":"site_id","type":"string","nullable":false},
    {"name":"longitude","type":"double","nullable":false},
    {"name":"latitude","type":"double","nullable":false}
  ]
}
INPUT_ARTIFACT:
name: tz_nudge_config
path_pattern: s3://data-engine/config/timezone/tz_nudge.yml  # File not yet created; path is reserved by spec.
sha256: <to-be-populated-on-build>  # placeholder
schema: |
{
  "name": "tz_nudge_config",
  "type": "record",
  "fields": [
    {"name":"max_nudge_seconds","type":"int","nullable":false},
    {"name":"method","type":"string","nullable":false}
  ]
}
OUTPUT_ARTIFACT:
name: tz_assignment_audit
path_pattern: s3://data-engine/logs/tz_assignment/tz_assignment_audit.log  # path reserved by spec.
sha256: <to-be-populated-on-build>  # placeholder
schema: |
{
  "name": "tz_assignment_audit",
  "type": "record",
  "fields": [
    {"name":"site_id","type":"string","nullable":false},
    {"name":"candidate_polygons_count","type":"int","nullable":false},
    {"name":"nudge_applied","type":"boolean","nullable":false},
    {"name":"chosen_tzid","type":"string","nullable":false}
  ]
}
PARTITIONING:
keys: ["site_id"]
order_by: ["merchant_id"]
SUCCESS_METRIC:
metric_name: row_count
expected_range: [1, 100000]  # placeholder
ERROR_POLICY:
error_code: 1402
retry_max: 3
retry_backoff_sec: 60
idempotent: true
SCHEMA_VERSION:
version: v1.0.0-draft
ACCESS_POLICY:
read_policy: processing-team-read  # placeholder
write_policy: audit-team-write  # placeholder
CONSUMED_BY:
module: ApplyTimeZoneOverridesModule
function: deriveTimeZone
description: Queries STR-tree, applies nudge logic, and logs assignment candidates
TEST_PATHWAY:
test_type: property-based
tool: custom
script: tests/property_test_derive_timezone.py  # CI test to be implemented after pipeline is in place
assertion: audit log entries equal input site count
Confidence=MEDIUM
<<<END IC-FIX>>>

<<<IC-FIX id=3>
Stage: ApplyTimeZoneOverrides
INPUT_ARTIFACT:
name: tz_assignment_audit
path_pattern: s3://data-engine/logs/tz_assignment/tz_assignment_audit.log  # path reserved by spec.
sha256: <to-be-populated-on-build>  # placeholder
schema: |
{
  "name": "tz_assignment_audit",
  "type": "record",
  "fields": [
    {"name":"site_id","type":"string","nullable":false},
    {"name":"chosen_tzid","type":"string","nullable":false},
    {"name":"override_tzid","type":"string","nullable":true},
    {"name":"evidence_url","type":"string","nullable":true},
    {"name":"expiry_date","type":"string","nullable":true}
  ]
}
INPUT_ARTIFACT:
name: tz_overrides_registry
path_pattern: s3://data-engine/config/timezone/tz_overrides.yaml  # File not yet created; path is reserved by spec.
sha256: <to-be-populated-on-build>  # placeholder
schema: |
{
  "name": "tz_overrides_registry",
  "type": "record",
  "fields": [
    {"name":"scope","type":"string","nullable":false},
    {"name":"tzid","type":"string","nullable":false},
    {"name":"evidence_url","type":"string","nullable":false},
    {"name":"expiry_yyyy_mm_dd","type":"string","nullable":false}
  ]
}
OUTPUT_ARTIFACT:
name: tz_override_audit
path_pattern: s3://data-engine/logs/tz_override/tz_override_audit.log  # path reserved by spec.
sha256: <to-be-populated-on-build>  # placeholder
schema: |
{
  "name": "tz_override_audit",
  "type": "record",
  "fields": [
    {"name":"site_id","type":"string","nullable":false},
    {"name":"original_tzid","type":"string","nullable":false},
    {"name":"override_tzid","type":"string","nullable":true},
    {"name":"used_evidence_url","type":"string","nullable":true}
  ]
}
PARTITIONING:
keys: []
order_by: []
SUCCESS_METRIC:
metric_name: file_existence
expected_range: [1,1]
ERROR_POLICY:
error_code: 1403
retry_max: 1
retry_backoff_sec: 30
idempotent: true
SCHEMA_VERSION:
version: v1.0.0-draft
ACCESS_POLICY:
read_policy: config-team-read  # placeholder
write_policy: audit-team-write  # placeholder
CONSUMED_BY:
module: ExtractZoneTimelineModule
function: applyOverrides
description: Applies configured timezone overrides and logs audit
TEST_PATHWAY:
test_type: integration
tool: pytest
script: tests/test_apply_timezone_overrides.py  # CI test to be implemented after pipeline is in place
assertion: override audit entries align with registry
Confidence=MEDIUM
<<<END IC-FIX>>>

<<<IC-FIX id=4>
Stage: ExtractZoneTimeline
INPUT_ARTIFACT:
name: tz_overrides_registry
path_pattern: s3://data-engine/config/timezone/tz_overrides.yaml  # File not yet created; path is reserved by spec.
sha256: <to-be-populated-on-build>  # placeholder
schema: |
{
  "name": "tz_overrides_registry",
  "type": "record",
  "fields": [
    {"name":"scope","type":"string","nullable":false},
    {"name":"tzid","type":"string","nullable":false},
    {"name":"evidence_url","type":"string","nullable":false},
    {"name":"expiry_yyyy_mm_dd","type":"string","nullable":false}
  ]
}
INPUT_ARTIFACT:
name: tzdata_archive
path_pattern: s3://data-engine/artefacts/priors/tzdata/tzdata2025a.tar.gz  # File not yet created; path is reserved by spec.
sha256: <to-be-populated-on-build>  # placeholder
schema: |
{ "type": "binary" }
INPUT_ARTIFACT:
name: simulation_horizon
path_pattern: s3://data-engine/config/timezone/simulation_horizon.yml  # File not yet created; path is reserved by spec.
sha256: <to-be-populated-on-build>  # placeholder
schema: |
{
  "name": "simulation_horizon",
  "type": "record",
  "fields": [
    {"name":"start_date","type":"string","nullable":false},
    {"name":"end_date","type":"string","nullable":false}
  ]
}
OUTPUT_ARTIFACT:
name: tz_cache_bytes
path_pattern: s3://data-engine/processed/tz_cache/tz_cache_bytes.bin  # path reserved by spec.
sha256: <to-be-populated-on-build>  # placeholder
schema: |
{
  "name": "tz_cache_bytes",
  "type": "record",
  "fields": [
    {"name":"tz_cache_bytes","type":"bytes","nullable":false}
  ]
}
PARTITIONING:
keys: []
order_by: []
SUCCESS_METRIC:
metric_name: file_size
expected_range: [0,8388608]  # bytes, < 8 MiB
ERROR_POLICY:
error_code: 1404
retry_max: 1
retry_backoff_sec: 30
idempotent: true
SCHEMA_VERSION:
version: v1.0.0-draft
ACCESS_POLICY:
read_policy: internal-data-team-read  # placeholder
write_policy: internal-data-team-write  # placeholder
CONSUMED_BY:
module: ComputeLocalToUTCModule
function: extractZoneTimeline
description: Encodes zone transition timeline within simulation horizon
TEST_PATHWAY:
test_type: integration
tool: pytest
script: tests/test_extract_zone_timeline.py  # CI test to be implemented after pipeline is in place
assertion: tz_cache_bytes size remains under limit
Confidence=HIGH
<<<END IC-FIX>>>

<<<IC-FIX id=5>
Stage: ComputeLocalToUTC
INPUT_ARTIFACT:
name: tz_cache_bytes
path_pattern: s3://data-engine/processed/tz_cache/tz_cache_bytes.bin  # path reserved by spec.
sha256: <to-be-populated-on-build>  # placeholder
schema: |
{
  "name": "tz_cache_bytes",
  "type": "record",
  "fields": [
    {"name":"tz_cache_bytes","type":"bytes","nullable":false}
  ]
}
OUTPUT_ARTIFACT:
name: utc_mapping
path_pattern: s3://data-engine/processed/tz_cache/utc_mapping.parquet  # path reserved by spec.
sha256: <to-be-populated-on-build>  # placeholder
schema: |
{
  "name": "utc_mapping",
  "type": "record",
  "fields": [
    {"name":"t_local","type":"long","nullable":false},
    {"name":"t_utc","type":"long","nullable":false}
  ]
}
PARTITIONING:
keys: []
order_by: []
SUCCESS_METRIC:
metric_name: row_count
expected_range: [1, 10000000]  # placeholder
ERROR_POLICY:
error_code: 1405
retry_max: 1
retry_backoff_sec: 30
idempotent: true
SCHEMA_VERSION:
version: v1.0.0-draft
ACCESS_POLICY:
read_policy: internal-data-team-read  # placeholder
write_policy: internal-data-team-write  # placeholder
CONSUMED_BY:
module: ArrivalEngine
function: computeLocalToUTC
description: Maps local epoch seconds to UTC using cached transitions
TEST_PATHWAY:
test_type: property-based
tool: custom
script: tests/property_test_compute_local_to_utc.py  # CI test to be implemented after pipeline is in place
assertion: mapping invertible and within expected bounds
Confidence=MEDIUM
<<<END IC-FIX>>}

##### END INTERFACE_CONTRACT_SPEC #####

id=1 | gaps_closed=output|schema|metric|error|access|partition | notes=Added output artifact, full schema, and policies  
id=2 | gaps_closed=input|output|schema|metric|error|access | notes=Defined second input artifact and audit log spec  
id=3 | gaps_closed=input|output|schema|metric|error|access | notes=Specified override registry input and audit output  
id=4 | gaps_closed=input|output|schema|metric|error|access | notes=Added simulation inputs and cache output spec  
id=5 | gaps_closed=input|output|schema|metric|error|access | notes=Completed mapping output and schema  
<<IS-END>> 