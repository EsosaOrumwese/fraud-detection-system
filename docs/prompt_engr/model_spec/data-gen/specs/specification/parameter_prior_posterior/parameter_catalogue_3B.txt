--- PP 1 ---
Name: Virtual‐merchant classification flag  
Symbol: `is_virtual`  
Scope: merchant_location  
Prior_type: Deterministic boolean  
Prior_specified: Yes  
Calibration_recipe: No  
Posterior_validation: Yes  
Provenance_tag: Yes  
Units: boolean  
Default_policy: abort on missing config  
Interface_consumer: derive_is_virtual.py → merchant_master.parquet loader  
Description: Boolean flag classifying a merchant as virtual per MCC rules.  
Anchor: “The branch that labels a merchant ‘virtual’ is taken when the boolean column `is_virtual` … is pre‐populated by the script `derive_is_virtual.py`, which reads … `mcc_channel_rules.yaml`.” :contentReference[oaicite:16]{index=16}  
Context: “The branch that labels a merchant ‘virtual’ is taken when the boolean column `is_virtual` of the `merchant_master` table is true. That column … reads a ledger called `config/virtual/mcc_channel_rules.yaml`. For example, MCC 5815 … flips the flag.”  
Gap_flags:
  prior_missing=N
  hyperparams_missing=N
  calibration_missing=N
  posterior_missing=N
  provenance_missing=N
  units_missing=N
  default_policy_missing=N
  interface_consumer_missing=N
  description_missing=N
Confidence=HIGH
--- END PP 1 ---

--- PP 2 ---
Name: Settlement‐node SHA1 key derivation  
Symbol: `site_id = SHA1(UTF8(merchant_id) ∥ "SETTLEMENT")`  
Scope: merchant_location  
Prior_type: Deterministic function  
Prior_specified: Yes  
Calibration_recipe: No  
Posterior_validation: Yes  
Provenance_tag: Yes  
Units: hex string (40 chars)  
Default_policy: abort on RNG/config error  
Interface_consumer: derive_virtual.py:create_settlement_node  
Description: Produces unique 40‑char hex `site_id` for a virtual merchant’s settlement node.  
Anchor: “generator creates one settlement node whose `site_id` is the hexadecimal SHA‑1 digest of … `(merchant_id,"SETTLEMENT")`.” :contentReference[oaicite:17]{index=17}  
Context: “Once `is_virtual` is true … the generator creates one settlement node whose `site_id` is ….”  
Gap_flags:
  prior_missing=N
  hyperparams_missing=N
  calibration_missing=N
  posterior_missing=N
  provenance_missing=N
  units_missing=N
  default_policy_missing=N
  interface_consumer_missing=N
  description_missing=N
Confidence=HIGH
--- END PP 2 ---

--- PP 3 ---
Name: Geocode evidence validation sample size  
Symbol: `n_geo = 10`  
Scope: merchant_location  
Prior_type: Fixed constant  
Prior_specified: Yes  
Calibration_recipe: No  
Posterior_validation: Yes  
Provenance_tag: Yes  
Units: count  
Default_policy: abort on missing log  
Interface_consumer: ci/verify_coords_evidence.py  
Description: Number of random rows pulled nightly for coordinate‐evidence checks.  
Anchor: “CI job `verify_coords_evidence.py` pulls ten random rows nightly … and asserts that the distance … below 5 km.” :contentReference[oaicite:18]{index=18}  
Context: “CI job `verify_coords_evidence.py` pulls ten random rows nightly, fetches the evidence_url … scrapes … asserts … below 5 km.”  
Gap_flags:
  prior_missing=N
  hyperparams_missing=N
  calibration_missing=N
  posterior_missing=N
  provenance_missing=N
  units_missing=N
  default_policy_missing=N
  interface_consumer_missing=N
  description_missing=N
Confidence=HIGH
--- END PP 3 ---

--- PP 4 ---
Name: Geocode distance threshold  
Symbol: `d_max = 5 000 m`  
Scope: merchant_location  
Prior_type: Fixed constant  
Prior_specified: Yes  
Calibration_recipe: No  
Posterior_validation: Yes  
Provenance_tag: Yes  
Units: meters  
Default_policy: abort on violation  
Interface_consumer: ci/verify_coords_evidence.py  
Description: Maximum allowed Haversine distance between recorded and geocoded coordinates.  
Anchor: “asserts that the distance to the recorded coordinate is below 5 km.” :contentReference[oaicite:19]{index=19}  
Context: “verifies the bundle’s checksum … and asserts that the distance … below 5 km, thereby catching stale filings.”  
Gap_flags:
  prior_missing=N
  hyperparams_missing=N
  calibration_missing=N
  posterior_missing=N
  provenance_missing=N
  units_missing=N
  default_policy_missing=N
  interface_consumer_missing=N
  description_missing=N
Confidence=HIGH
--- END PP 4 ---

--- PP 5 ---
Name: Earth radius for Haversine  
Symbol: `R = 6 371 000 m`  
Scope: merchant_location  
Prior_type: Fixed constant  
Prior_specified: Yes  
Calibration_recipe: No  
Posterior_validation: Yes  
Provenance_tag: Yes  
Units: meters  
Default_policy: abort on mis‐compute  
Interface_consumer: ci/verify_coords_evidence.py  
Description: Earth radius used in Haversine distance calculation.  
Anchor: “$d = 2\,R\,\arcsin(\sqrt{a}),\;R=6\,371\,000\text{ m}$.” :contentReference[oaicite:20]{index=20}  
Context: “Given … then $d = 2\,R\,\arcsin(\sqrt{a})\;(R=6\,371,000\text{ m})$.”  
Gap_flags:
  prior_missing=N
  hyperparams_missing=N
  calibration_missing=N
  posterior_missing=N
  provenance_missing=N
  units_missing=N
  default_policy_missing=N
  interface_consumer_missing=N
  description_missing=N
Confidence=HIGH
--- END PP 5 ---

--- PP 6 ---
Name: CDN‐edge scale factor  
Symbol: `E = 500`  
Scope: merchant_location  
Prior_type: Fixed constant  
Prior_specified: Yes  
Calibration_recipe: No  
Posterior_validation: Yes  
Provenance_tag: Yes  
Units: count  
Default_policy: abort on missing config  
Interface_consumer: build_edge_catalogue.py  
Description: Global integer scaling each country weight before rounding to counts.  
Anchor: “A global integer **E = 500**—stored in the same YAML as `edge_scale`—multiplies each weight before rounding …” :contentReference[oaicite:21]{index=21}  
Context: “The script imports … writes the YAML. A global integer **E = 500**—stored … multiplies each weight … so the smallest weight yields at least one edge node.”  
Gap_flags:
  prior_missing=N
  hyperparams_missing=N
  calibration_missing=N
  posterior_missing=N
  provenance_missing=N
  units_missing=N
  default_policy_missing=N
  interface_consumer_missing=N
  description_missing=N
Confidence=HIGH
--- END PP 6 ---

--- PP 7 ---
Name: Edge‐catalogue size bounds  
Symbol: `k_min=50`, `k_max=800`  
Scope: merchant_location  
Prior_type: Fixed constants  
Prior_specified: Yes  
Calibration_recipe: No  
Posterior_validation: No  
Provenance_tag: Yes  
Units: count  
Default_policy: abort on out‐of‐range  
Interface_consumer: build_edge_catalogue.py  
Description: Minimum and maximum edge‐node counts per merchant enforced by scale choice.  
Anchor: “E = 500 … chosen so that no edge catalogue is smaller than 50 nodes or larger than 800 …” :contentReference[oaicite:22]{index=22}  
Context: “each country weight × E, chosen so that no edge catalogue is smaller than 50 nodes or larger than 800, and rounded …”  
Gap_flags:
  prior_missing=N
  hyperparams_missing=N
  calibration_missing=N
  posterior_missing=Y
  provenance_missing=N
  units_missing=N
  default_policy_missing=N
  interface_consumer_missing=N
  description_missing=N
Confidence=MEDIUM
--- END PP 7 ---

--- PP 8 ---
Name: Discrete uniform integer draw  
Symbol: $u \sim \mathrm{Uniform}\{0,\dots,P_N-1\}$  
Scope: merchant_location  
Prior_type: Uniform discrete  
Prior_specified: Yes  
Calibration_recipe: No  
Posterior_validation: Yes  
Provenance_tag: Yes  
Units: dimensionless (integer)  
Default_policy: abort on RNG error  
Interface_consumer: sampling/fenwick.py:sample_pixel  
Description: Uniform integer for Fenwick‐tree binary search over raster pixel weights.  
Anchor: “$u \sim \mathrm{Uniform}\{0,\dots,P_N-1\}$, using Philox to generate a 64‑bit integer.” :contentReference[oaicite:23]{index=23}  
Context: “Flatten weights … prefix sums … then $u \sim \mathrm{Uniform}\{0,\dots,P_N-1\}$, using Philox …”  
Gap_flags:
  prior_missing=N
  hyperparams_missing=N
  calibration_missing=N
  posterior_missing=N
  provenance_missing=N
  units_missing=N
  default_policy_missing=N
  interface_consumer_missing=N
  description_missing=N
Confidence=HIGH
--- END PP 8 ---

--- PP 9 ---
Name: Uniform real deviate for alias  
Symbol: $f \sim \mathrm{Uniform}[0,1)$  
Scope: merchant_location  
Prior_type: Uniform continuous  
Prior_specified: Yes  
Calibration_recipe: No  
Posterior_validation: Yes  
Provenance_tag: Yes  
Units: dimensionless  
Default_policy: abort on RNG error  
Interface_consumer: alias/voce.py:sample_alias  
Description: Uniform real used to choose between `prob[m]` and `alias[m]` in Vose sampling.  
Anchor: “Draw uniform real $f\in[0,1)$. If $f < \mathrm{prob}[m]$, output $m$; else output `alias[m]`.” :contentReference[oaicite:24]{index=24}  
Context: “Sampling: draw uniform integer $m$ … draw uniform real $f\in[0,1)$. If $f<\mathrm{prob}[m]$, output $m$; else …”  
Gap_flags:
  prior_missing=N
  hyperparams_missing=N
  calibration_missing=N
  posterior_missing=N
  provenance_missing=N
  units_missing=N
  default_policy_missing=N
  interface_consumer_missing=N
  description_missing=N
Confidence=HIGH
--- END PP 9 ---

--- PP 10 ---
Name: CDN alias‐key SHA256 policy  
Symbol: `key = SHA256(global_seed ∥ "CDN" ∥ merchant_id)`  
Scope: merchant_location  
Prior_type: Deterministic hash  
Prior_specified: Yes  
Calibration_recipe: No  
Posterior_validation: Yes  
Provenance_tag: Yes  
Units: hex (256‑bit)  
Default_policy: abort on mismatch  
Interface_consumer: config/routing/rng_policy.yml  
Description: Derives Philox key for per‑merchant CDN RNG stream.  
Anchor: “Philox sub‑stream key is defined as the SHA‑256 of … `(global_seed,"CDN",merchant_id)`; policy resides in `config/routing/rng_policy.yml`.” :contentReference[oaicite:25]{index=25}  
Context: “The Philox sub‑stream key is defined as the SHA‑256 … policy resides in `config/routing/rng_policy.yml` …”  
Gap_flags:
  prior_missing=N
  hyperparams_missing=N
  calibration_missing=N
  posterior_missing=N
  provenance_missing=N
  units_missing=N
  default_policy_missing=N
  interface_consumer_missing=N
  description_missing=N
Confidence=HIGH
--- END PP 10 ---

--- PP 11 ---
Name: Virtual‐universe hash  
Symbol: `h = SHA256(cdn_weights_digest ∥ edge_digest ∥ virtual_rules_digest)`  
Scope: merchant_location  
Prior_type: Deterministic function  
Prior_specified: Yes  
Calibration_recipe: No  
Posterior_validation: Yes  
Provenance_tag: Yes  
Units: hex (256‑bit)  
Default_policy: abort on mismatch  
Interface_consumer: routing/virtual_universe_hash.py  
Description: Aggregate digest binding CDN‑weights, edge‑catalogue and virtual rules for drift detection.  
Anchor: “These three digests … concatenated … and hashed into `virtual_universe_hash` …” :contentReference[oaicite:26]{index=26}  
Context: “Alias routing … embeds metadata fields: `edge_digest`, `cdn_weights_digest`, `virtual_rules_digest`. These are concatenated … and hashed into `virtual_universe_hash` …”  
Gap_flags:
  prior_missing=N
  hyperparams_missing=N
  calibration_missing=N
  posterior_missing=N
  provenance_missing=N
  units_missing=N
  default_policy_missing=N
  interface_consumer_missing=N
  description_missing=N
Confidence=HIGH
--- END PP 11 ---

--- PP 12 ---
Name: Country‐share tolerance  
Symbol: `τ_country`  
Scope: merchant_location  
Prior_type: Fixed constant  
Prior_specified: Yes  
Calibration_recipe: No  
Posterior_validation: Yes  
Provenance_tag: Yes  
Units: proportion  
Default_policy: abort on breach  
Interface_consumer: config/virtual/virtual_validation.yml  
Description: Maximum absolute error allowed in empirical `ip_country` shares.  
Anchor: “fails if any $|\hat{\pi}_c - \pi_c| > 0.02$.” :contentReference[oaicite:27]{index=27}  
Context: “it loads 30 synthetic days … calculates empirical `ip_country` proportions … fails if any $|\hat{\pi}_c - \pi_c| > 0.02$. Thresholds reside in `config/virtual/virtual_validation.yml`, key `country_tolerance`.”  
Gap_flags:
  prior_missing=N
  hyperparams_missing=N
  calibration_missing=N
  posterior_missing=N
  provenance_missing=N
  units_missing=N
  default_policy_missing=N
  interface_consumer_missing=N
  description_missing=N
Confidence=HIGH
--- END PP 12 ---

--- PP 13 ---
Name: Cut‑off time tolerance  
Symbol: `τ_time = 5 s`  
Scope: merchant_location  
Prior_type: Fixed constant  
Prior_specified: Yes  
Calibration_recipe: No  
Posterior_validation: Yes  
Provenance_tag: Yes  
Units: seconds  
Default_policy: abort on misalignment  
Interface_consumer: config/virtual/virtual_validation.yml  
Description: Allowed ±5 s deviation for final daily event settlement cut‑off.  
Anchor: “checks that the civil time lies in the closed interval [23:59:54, 23:59:59].” :contentReference[oaicite:28]{index=28}  
Context: “and checks that … lies in the closed interval [23:59:54, 23:59:59]. Failure prints …”  
Gap_flags:
  prior_missing=N
  hyperparams_missing=N
  calibration_missing=N
  posterior_missing=N
  provenance_missing=N
  units_missing=N
  default_policy_missing=N
  interface_consumer_missing=N
  description_missing=N
Confidence=HIGH
--- END PP 13 ---

--- PP 14 ---
Name: Virtual‐merchant log retention  
Symbol: `retention_days = 90`  
Scope: merchant_location  
Prior_type: Fixed constant  
Prior_specified: Yes  
Calibration_recipe: No  
Posterior_validation: No  
Provenance_tag: Yes  
Units: days  
Default_policy: delete older logs  
Interface_consumer: config/logging/virtual_logging.yml  
Description: Number of days to retain `logs/edge_progress.log`.  
Anchor: “rotated daily and retained 90 days per `config/logging/virtual_logging.yml`.” :contentReference[oaicite:29]{index=29}  
Context: “After licence governance, the builder ensures crash recovery by logging progress … rotated daily and retained 90 days …”  
Gap_flags:
  prior_missing=N
  hyperparams_missing=N
  calibration_missing=N
  posterior_missing=Y
  provenance_missing=N
  units_missing=N
  default_policy_missing=N
  interface_consumer_missing=N
  description_missing=N
Confidence=MEDIUM
--- END PP 14 ---

--- PP 15 ---
Name: Edge‐catalogue schema enforcement  
Symbol: schema fields non‑nullable  
Scope: merchant_location  
Prior_type: Fixed contract  
Prior_specified: Yes  
Calibration_recipe: No  
Posterior_validation: Yes  
Provenance_tag: Yes  
Units: N/A  
Default_policy: abort on schema drift  
Interface_consumer: edge_catalogue_schema.json  
Description: Enforces output Parquet schema for `edge_catalogue/<merchant_id>.parquet`.  
Anchor: “All outputs … must conform to this schema: … all columns non‑nullable … enforced by `edge_catalogue_schema.json`.” :contentReference[oaicite:30]{index=30}  
Context: “All outputs to `edge_catalogue/<merchant_id>.parquet` must conform … Schema enforced by `edge_catalogue_schema.json`.”  
Gap_flags:
  prior_missing=N
  hyperparams_missing=N
  calibration_missing=N
  posterior_missing=N
  provenance_missing=N
  units_missing=N
  default_policy_missing=N
  interface_consumer_missing=N
  description_missing=N
Confidence=HIGH
--- END PP 15 ---

--- PP 16 ---
Name: Crash‐recovery progress log policy  
Symbol: `edge_progress.log` entry idempotency  
Scope: merchant_location  
Prior_type: Fixed contract  
Prior_specified: Yes  
Calibration_recipe: No  
Posterior_validation: Yes  
Provenance_tag: Yes  
Units: N/A  
Default_policy: abort on missing entry  
Interface_consumer: logs/edge_progress.log reader  
Description: Ensures idempotent resumption via batch keys in progress log.  
Anchor: “after writing each … it appends the batch key to `logs/edge_progress.log`. A crash restarts … skips completed batches …” :contentReference[oaicite:31]{index=31}  
Context: “Finally, crash recovery … builder reads this log, skips completed batches and continues.”  
Gap_flags:
  prior_missing=N
  hyperparams_missing=N
  calibration_missing=N
  posterior_missing=N
  provenance_missing=N
  units_missing=N
  default_policy_missing=N
  interface_consumer_missing=N
  description_missing=N
Confidence=HIGH
--- END PP 16 ---

<<PP‑END>>