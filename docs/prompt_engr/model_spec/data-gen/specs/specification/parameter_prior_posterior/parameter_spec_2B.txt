<<<PP‑FIX id=1>>
Name: Routing site weight normalization (probabilities per outlet)
Symbol: $p_i = F_i / \sum_j F_j$
Scope: merchant_location
---------------------------------

PRIOR:
type: Deterministic function
hyperparameters: {}
units: dimensionless
default_policy: abort on zero total
justification: Normalizes raw foot‑traffic scalars into a probability distribution.

CALIBRATION_RECIPE:
input_path: N/A
objective: Not applicable
algorithm: Not applicable
random_seed: N/A
convergence_tol: N/A
script_digest: N/A

INTERFACE_CONSUMER:
artefact_name: router/engine.py
function: normalize_site_weights
description: Converts raw weights $F_i$ into probabilities $p_i$.

POSTERIOR_VALIDATION:
metric: sum of probabilities
acceptance_range: [1.0, 1.0]
sample_size: all merchants

PROVENANCE_TAG:
artefact_name: site_catalogue.parquet
sha256: <to‑be‑populated>

SHORT_DESCRIPTION:
Deterministic normalization of routing weights per outlet.

TEST_PATHWAY:
test: CI normalization test
input: site_catalogue.parquet
assert: ∑ p_i = 1 for each merchant

Confidence=HIGH
<<<END PP‑FIX>>>

<<<PP‑FIX id=2>>
Name: Alias table O(1) sampling arrays
Symbol: prob, alias
Scope: merchant_location
---------------------------------

PRIOR:
type: Deterministic function
hyperparameters: {}
units: dimensionless
default_policy: abort on reconstruction failure
justification: Builds alias table arrays for constant‑time sampling.

CALIBRATION_RECIPE:
input_path: N/A
objective: Not applicable
algorithm: Not applicable
random_seed: N/A
convergence_tol: N/A
script_digest: N/A

INTERFACE_CONSUMER:
artefact_name: router/alias.py
function: build_alias_table
description: Constructs `prob` and `alias` arrays from normalized $p_i$.

POSTERIOR_VALIDATION:
metric: table reconstruction hash
acceptance_range: [0, 0]
sample_size: all merchants

PROVENANCE_TAG:
artefact_name: alias_table.npz
sha256: <to‑be‑populated>

SHORT_DESCRIPTION:
Vose alias method arrays for outlet sampling.

TEST_PATHWAY:
test: CI alias-table test
input: alias_table.npz
assert: hash of reconstructed arrays matches

Confidence=HIGH
<<<END PP‑FIX>>>

<<<PP‑FIX id=3>>
Name: Corporate‑day random effect variance
Symbol: $\sigma_\gamma^2$
Scope: merchant_location
---------------------------------

PRIOR:
type: Loaded constant
hyperparameters:
  coefficients_file: config/routing_day_effect.yml
units: dimensionless (variance)
default_policy: abort on missing file
justification: Variance for log‑normal corporate‑day effect.

CALIBRATION_RECIPE:
input_path: s3://data/routing/hourly_counts_by_day.csv
objective: Maximum Likelihood Estimation
algorithm: Method of Moments
random_seed: 42
convergence_tol: 1e-6
script_digest: sha256:<to‑be‑populated>  # build/scripts/calibrate_gamma.ipynb

INTERFACE_CONSUMER:
artefact_name: config/routing_day_effect.yml
function: load_day_effect_variance
description: Loads $\sigma_\gamma^2$ for daily effect sampler.

POSTERIOR_VALIDATION:
metric: empirical day‑effect variance match
acceptance_range: [σ_γ², σ_γ²]
sample_size: daily build

PROVENANCE_TAG:
artefact_name: config/routing_day_effect.yml
sha256: <to‑be‑populated>

SHORT_DESCRIPTION:
Variance parameter for corporate‑day LogNormal effect.

TEST_PATHWAY:
test: CI day-effect variance test
input: day_effect_stats.log
assert: loaded σ_γ² matches manifest

Confidence=HIGH
<<<END PP‑FIX>>>

<<<PP‑FIX id=4>>
Name: Virtual merchant CDN edge country weights
Symbol: $Q = [q_1,\dots,q_K]$
Scope: merchant_location
---------------------------------

PRIOR:
type: Loaded constant
hyperparameters:
  source_report: Akamai_State_of_the_Internet_2024.csv
units: dimensionless (probabilities)
default_policy: use equal weights
justification: Empirical probabilities for CDN edge‑node country assignment.

CALIBRATION_RECIPE:
input_path: s3://data/cdn/akamai_country_weights.csv
objective: Method of Moments
algorithm: Method of Moments
random_seed: 42
convergence_tol: 1e-6
script_digest: sha256:<to‑be‑populated>  # build/scripts/calibrate_cdn_weights.py

INTERFACE_CONSUMER:
artefact_name: config/cdn_country_weights.yaml
function: load_cdn_weights
description: Supplies $q_k$ vector for virtual‑merchant sampler.

POSTERIOR_VALIDATION:
metric: sum of $q_k$
acceptance_range: [1.0, 1.0]
sample_size: all virtual merchants

PROVENANCE_TAG:
artefact_name: config/cdn_country_weights.yaml
sha256: <to‑be‑populated>

SHORT_DESCRIPTION:
Probability vector for CDN country sampling.

TEST_PATHWAY:
test: CI CDN‑weights test
input: cdn_country_weights.yaml
assert: ∑ q_k = 1

Confidence=HIGH
<<<END PP‑FIX>>>

<<<PP‑FIX id=5>>
Name: Routing validation thresholds
Symbol: $\epsilon_p$, $\epsilon_\rho$
Scope: merchant_location
---------------------------------

PRIOR:
type: Loaded constants
hyperparameters:
  threshold_file: config/routing_validation.yml
units: dimensionless
default_policy: abort on breach
justification: Tolerances for probability and correlation validation.

CALIBRATION_RECIPE:
input_path: s3://data/routing/validation_metrics.csv
objective: Minimize share & correlation error
algorithm: Nelder‑Mead
random_seed: 42
convergence_tol: 1e-6
script_digest: sha256:<to‑be‑populated>  # build/scripts/calibrate_routing_validation.py

INTERFACE_CONSUMER:
artefact_name: config/routing_validation.yml
function: load_validation_thresholds
description: Loads $\epsilon_p$ and $\epsilon_\rho$ for CI checks.

POSTERIOR_VALIDATION:
metric: max $|\hat p_i - p_i|$, $|\rho_{\mathrm{emp}} - \rho^*|$
acceptance_range: [$\epsilon_p$, $\epsilon_\rho$]
sample_size: daily build

PROVENANCE_TAG:
artefact_name: config/routing_validation.yml
sha256: <to‑be‑populated>

SHORT_DESCRIPTION:
CI tolerances for routing share and correlation.

TEST_PATHWAY:
test: CI routing‑validation test
input: routing_validation.yml
assert: share & correlation within thresholds

Confidence=HIGH
<<<END PP‑FIX>>>

<<<PP‑FIX id=6>>
Name: Audit batch size and checksum
Symbol: $B = 10^6$, checksum = SHA256(...)
Scope: merchant_location
---------------------------------

PRIOR:
type: Fixed constants
hyperparameters:
  batch_size: 1000000
units: count, hex string
default_policy: abort on drift
justification: Controls audit batching and reproducibility hash.

CALIBRATION_RECIPE:
input_path: N/A
objective: Not applicable
algorithm: Not applicable
random_seed: N/A
convergence_tol: N/A
script_digest: N/A

INTERFACE_CONSUMER:
artefact_name: router/audit.py
function: write_audit_event
description: Logs each batch and its checksum.

POSTERIOR_VALIDATION:
metric: checksum match across runs
acceptance_range: [true, true]
sample_size: two independent runs

PROVENANCE_TAG:
artefact_name: routing_audit.log
sha256: <to‑be‑populated>

SHORT_DESCRIPTION:
Batch size and SHA256 checksum for routing audit.

TEST_PATHWAY:
test: CI audit reproducibility
input: routing_audit.log
assert: checksums identical in two runs

Confidence=HIGH
<<<END PP‑FIX>>>

<<<PP‑FIX id=7>>
Name: Routing RNG policy (seed derivation)
Symbol: SHA1(global_seed ∥ "router" ∥ merchant_id)
Scope: merchant_location
---------------------------------

PRIOR:
type: Deterministic hash
hyperparameters:
  policy_file: rng_policy.yml
units: hex (160-bit)
default_policy: abort on mismatch
justification: Derives merchant-specific Philox key for RNG.

CALIBRATION_RECIPE:
input_path: N/A
objective: Not applicable
algorithm: Not applicable
random_seed: N/A
convergence_tol: N/A
script_digest: N/A

INTERFACE_CONSUMER:
artefact_name: rng_policy.yml
function: derive_router_seed
description: Computes Philox key using SHA1 hash.

POSTERIOR_VALIDATION:
metric: seed digest match
acceptance_range: [true, true]
sample_size: one

PROVENANCE_TAG:
artefact_name: rng_policy.yml
sha256: <to‑be‑populated>

SHORT_DESCRIPTION:
Deterministic RNG key derivation policy.

TEST_PATHWAY:
test: CI RNG-seed reproducibility
input: rng_policy.yml
assert: seed digest matches

Confidence=HIGH
<<<END PP‑FIX>>>

<<<PP‑FIX id=8>>
Name: Routing performance thresholds (throughput, memory)
Symbol: TP ≥ 200 MB/s, Mem ≤ 2 GB
Scope: merchant_location
---------------------------------

PRIOR:
type: Loaded constants
hyperparameters:
  performance_file: config/routing/performance.yml
units: MB/s, GB
default_policy: abort on SLA breach
justification: Defines throughput and memory SLAs for routing.

CALIBRATION_RECIPE:
input_path: config/routing/performance.yml
objective: Not applicable
algorithm: Not applicable
random_seed: N/A
convergence_tol: N/A
script_digest: sha256:<to‑be‑populated>

INTERFACE_CONSUMER:
artefact_name: config/routing/performance.yml
function: load_performance_thresholds
description: Provides TP and Mem thresholds for CI.

POSTERIOR_VALIDATION:
metric: throughput, memory usage
acceptance_range: [>=200, <=2]
sample_size: each routing run

PROVENANCE_TAG:
artefact_name: config/routing/performance.yml
sha256: <to‑be‑populated>

SHORT_DESCRIPTION:
Throughput and memory SLA thresholds.

TEST_PATHWAY:
test: CI performance test
input: performance.log
assert: TP ≥ 200 MB/s and Mem ≤ 2 GB

Confidence=HIGH
<<<END PP‑FIX>>>

<<<PP‑FIX id=9>>
Name: Corporate‑day random effect log‑normal mean
Symbol: μ_γ
Scope: merchant_location
---------------------------------

PRIOR:
type: Deterministic derived constant
hyperparameters:
  formula: μ_γ = -½ σ_γ²
units: dimensionless
default_policy: use prior
justification: Centers log‑normal so E[γ_d] = 1.

CALIBRATION_RECIPE:
input_path: N/A
objective: Not applicable
algorithm: Not applicable
random_seed: N/A
convergence_tol: N/A
script_digest: N/A

INTERFACE_CONSUMER:
artefact_name: config/routing_day_effect.yml
function: compute_log_normal_mean
description: Computes μ_γ from σ_γ² for day effect.

POSTERIOR_VALIDATION:
metric: expectation test
acceptance_range: [1.0, 1.0]
sample_size: 10000

PROVENANCE_TAG:
artefact_name: config/routing_day_effect.yml
sha256: <to‑be‑populated>

SHORT_DESCRIPTION:
Mean for corporate‑day LogNormal effect.

TEST_PATHWAY:
test: CI lognormal mean test
input: day_effect_stats.log
assert: E[γ_d] ≈ 1

Confidence=HIGH
<<<END PP‑FIX>>>

<<<PP‑FIX id=10>>
Name: Uniform deviate for alias and day‑effect sampling
Symbol: u ∼ U(0,1)
Scope: merchant_location
---------------------------------

PRIOR:
type: Uniform
hyperparameters:
  min: 0
  max: 1
units: dimensionless
default_policy: abort on RNG error
justification: Generates uniform deviate for alias lookup and day‑effect sampling.

CALIBRATION_RECIPE:
input_path: N/A
objective: Not applicable
algorithm: Not applicable
random_seed: N/A
convergence_tol: N/A
script_digest: N/A

INTERFACE_CONSUMER:
artefact_name: router/prng.py
function: uniform_sampler
description: Produces Uniform(0,1) deviates via Philox.

POSTERIOR_VALIDATION:
metric: Kolmogorov–Smirnov statistic
acceptance_range: [0.0, 0.05]
sample_size: 10000

PROVENANCE_TAG:
artefact_name: rng_policy.yml
sha256: <to‑be‑populated>

SHORT_DESCRIPTION:
Uniform random threshold for sampling routines.

TEST_PATHWAY:
test: CI uniform deviate test
input: uniform_samples.log
assert: KS statistic < 0.05

Confidence=HIGH
<<<END PP‑FIX>>>

##### END PARAMETER_SPEC #####

id=1  | gaps_closed=none             | notes=Deterministic normalization already fully specified  
id=2  | gaps_closed=none             | notes=Alias arrays require no calibration  
id=3  | gaps_closed=none             | notes=Variance loaded and validated  
id=4  | gaps_closed=none             | notes=CDN weights calibrated and checked  
id=5  | gaps_closed=none             | notes=Validation thresholds loaded and enforced  
id=6  | gaps_closed=none             | notes=Audit batch and checksum test defined  
id=7  | gaps_closed=none             | notes=RNG policy spec and CI proof in place  
id=8  | gaps_closed=none             | notes=Performance SLAs loaded and tested  
id=9  | gaps_closed=none             | notes=Derived mean added for log-normal effect  
id=10 | gaps_closed=calibration|posterior | notes=Added uniform deviate test and KS validation  
<<PS‑END>>  