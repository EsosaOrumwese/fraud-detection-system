subsegments:
  - id: "4A"
    name: "Reproducibility and Configurability"
    artifacts:

      # 1 CONTAINER & BUILD PROVENANCE
      - name: Dockerfile.lock
        path: Dockerfile.lock
        type: manifest
        category: reproducibility
        semver: "{semver}"
        version: "{container_version}"
        digest: "{sha256}"
        manifest_key: mlr.4A.manifest.dockerfile_lock
        license: "{spdx_or_internal}"
        role: Locks base-image digest and apt/yum layer hashes.
        dependencies: []
        source: internal
        owner: { platform_team }
        last_updated: "{iso8601_timestamp}"
        environment: [ ci ]
        schema: null
        cross_layer: false
        notes: null

      - name: pipeline_launcher.sh
        path: ci/pipeline_launcher.sh
        type: script
        category: ci
        semver: "{code_semver}"
        version: "{git_commit}"
        digest: "{git_tree_hash}"
        manifest_key: mlr.4A.ci.pipeline_launcher
        license: "{spdx_or_internal}"
        role: Entrypoint that writes the initial build.manifest and kicks off validation jobs.
        dependencies:
          - Dockerfile.lock
        source: internal
        owner: { platform_team }
        last_updated: "{iso8601_timestamp}"
        environment: [ ci, runtime ]
        schema: null
        cross_layer: false
        notes: null

      - name: validate_container_hash.yml
        path: configs/ci/validate_container_hash.yml
        type: ci_test
        category: reproducibility
        semver: "{semver}"
        version: "{config_version}"
        digest: "{sha256}"
        manifest_key: mlr.4A.ci.validate_container_hash
        license: "{spdx_or_internal}"
        role: GH-action that asserts built image digest == Dockerfile.lock.
        dependencies:
          - Dockerfile.lock
        source: internal
        owner: { platform_team }
        last_updated: "{iso8601_timestamp}"
        environment: [ ci ]
        schema: null
        cross_layer: false
        notes: null

      - name: build.manifest
        path: artefacts/manifests/build.manifest
        type: manifest
        category: reproducibility
        semver: "{semver}"
        version: "{run_id}"
        digest: "{sha256}"
        manifest_key: mlr.4A.manifest.build
        license: "{spdx_or_internal}"
        role: Aggregates git tree, container digest, param hash & all artefact digests.
        dependencies:
          - pipeline_launcher.sh
          - validate_container_hash.yml
        source: internal
        owner: { platform_team }
        last_updated: "{iso8601_timestamp}"
        environment: [ ci ]
        schema: null
        cross_layer: false
        notes: null

      # 2 REGISTRY SCHEMA & LIVE INSTANCE
      - name: artefact_registry.schema.json
        path: configs/registry/artefact_registry.schema.json
        type: schema
        category: registry
        semver: "{semver}"
        version: "{schema_version}"
        digest: "{sha256}"
        manifest_key: mlr.4A.schema.registry
        license: "{spdx_or_internal}"
        role: JSON Schema defining shape & required fields of registry YAMLs.
        dependencies: []
        source: internal
        owner: { platform_team }
        last_updated: "{iso8601_timestamp}"
        environment: [ ci, runtime ]
        schema: null
        cross_layer: false
        notes: null

      - name: artefact_registry.yaml
        path: configs/registry/artefact_registry.yaml
        type: config
        category: registry
        semver: "{semver}"
        version: "{registry_version}"
        digest: "{sha256}"
        manifest_key: mlr.4A.config.registry
        license: "{spdx_or_internal}"
        role: Live registry instance enumerated by loader; validated at runtime.
        dependencies:
          - artefact_registry.schema.json
        source: internal
        owner: { platform_team }
        last_updated: "{iso8601_timestamp}"
        environment: [ ci, runtime ]
        schema: artefact_registry.schema.json
        cross_layer: false
        notes: null

      - name: schemas_directory
        path: schemas/
        type: directory
        category: schema_bundle
        semver: "{semver}"
        version: "{schema_bundle_version}"
        digest: "{sha256}"
        manifest_key: mlr.4A.dir.schemas
        license: "{spdx_or_internal}"
        role: Bundle of all domain JSON/Avro schemas (transaction, outlet, etc.).
        dependencies: []
        source: internal
        owner: { platform_team }
        last_updated: "{iso8601_timestamp}"
        environment: [ ci, runtime ]
        schema: null
        cross_layer: false
        notes: "Contains transaction_schema.avsc, site_catalogue.avsc, …"

      # 3 REGISTRY TOOLING & CONSISTENCY CHECKS
      - name: artefact_loader_py
        path: src/registry/artefact_loader.py
        type: code
        category: registry_tooling
        semver: "{code_semver}"
        version: "{git_commit}"
        digest: "{git_tree_hash}"
        manifest_key: mlr.4A.code.artefact_loader
        license: "{spdx_or_internal}"
        role: Parses registry YAML, validates against schema, loads into memory.
        dependencies:
          - artefact_registry.schema.json
        source: internal
        owner: { platform_team }
        last_updated: "{iso8601_timestamp}"
        environment: [ dev, ci, runtime ]
        schema: null
        cross_layer: false
        notes: null

      - name: compare_registry_py
        path: src/registry/compare_registry.py
        type: code
        category: registry_tooling
        semver: "{code_semver}"
        version: "{git_commit}"
        digest: "{git_tree_hash}"
        manifest_key: mlr.4A.code.compare_registry
        license: "{spdx_or_internal}"
        role: Diffs two registry YAMLs → JSON patch; fails if undeclared change.
        dependencies:
          - artefact_registry.yaml
        source: internal
        owner: { platform_team }
        last_updated: "{iso8601_timestamp}"
        environment: [ ci ]
        schema: null
        cross_layer: false
        notes: null

      - name: register_dataset_sh
        path: scripts/register_dataset.sh
        type: script
        category: registry_tooling
        semver: "{code_semver}"
        version: "{git_commit}"
        digest: "{git_tree_hash}"
        manifest_key: mlr.4A.script.register_dataset
        license: "{spdx_or_internal}"
        role: Bash helper that appends new dataset block + re-hashes registry.
        dependencies:
          - artefact_registry.yaml
        source: internal
        owner: { data_ops_team }
        last_updated: "{iso8601_timestamp}"
        environment: [ dev ]
        schema: null
        cross_layer: false
        notes: null

      # 4 DATASET CATALOG & DDL GOVERNANCE
      - name: dataset_catalog.ddl.sql
        path: db/dataset_catalog.ddl.sql
        type: code
        category: catalog_schema
        semver: "{semver}"
        version: "{ddl_version}"
        digest: "{sha256}"
        manifest_key: mlr.4A.ddl.dataset_catalog
        license: "{spdx_or_internal}"
        role: DDL creating Postgres table mapping `manifest_key → storage_uri`.
        dependencies: []
        source: internal
        owner: { data_ops_team }
        last_updated: "{iso8601_timestamp}"
        environment: [ dev, staging ]
        schema: null
        cross_layer: false
        notes: null

      # 5 RNG LOGGING & REPLAY INFRA
      - name: rng_logging_policy
        path: configs/rng/rng_logging.yml
        type: config
        category: rng_policy
        semver: "{semver}"
        version: "{config_version}"
        digest: "{sha256}"
        manifest_key: mlr.4A.config.rng_logging
        license: "{spdx_or_internal}"
        role: Enables Philox counter dumps for every segment; size budget 10 MiB.
        dependencies: []
        source: internal
        owner: { platform_team }
        last_updated: "{iso8601_timestamp}"
        environment: [ runtime ]
        schema: null
        cross_layer: true
        notes: null

      - name: global_rng_trace_log
        path: logs/rng/{run_id}/global_rng_trace.log
        type: log
        category: rng_audit
        semver: "{semver}"
        version: "{run_id}"
        digest: "{sha256}"
        manifest_key: mlr.4A.log.global_rng_trace
        license: "{spdx_or_internal}"
        role: Full Philox counter + key stream across all segments.
        dependencies: [ rng_logging_policy ]
        source: internal
        owner: { platform_team }
        last_updated: "{iso8601_timestamp}"
        environment: [ runtime ]
        schema: null
        cross_layer: false
        notes: null

      - name: replay_rng_py
        path: tools/replay_rng.py
        type: code
        category: rng_tooling
        semver: "{code_semver}"
        version: "{git_commit}"
        digest: "{git_tree_hash}"
        manifest_key: mlr.4A.code.replay_rng
        license: "{spdx_or_internal}"
        role: Replays RNG trace and asserts exact draw sequence for a given seed.
        dependencies: [ global_rng_trace_log ]
        source: internal
        owner: { qa_team }
        last_updated: "{iso8601_timestamp}"
        environment: [ dev, ci ]
        schema: null
        cross_layer: false
        notes: null

      - name: zoneinfo_version_yml
        path: configs/runtime/zoneinfo_version.yml
        type: config
        category: runtime_environment
        semver: "{semver}"
        version: "{config_version}"
        digest: "{sha256}"
        manifest_key: mlr.2A.config.zoneinfo_version
        license: "{spdx_or_internal}"
        role: Pins ICU / tzdata version—referenced by RNG tests that depend on DST.
        dependencies: []
        source: internal
        owner: { platform_team }
        last_updated: "{iso8601_timestamp}"
        environment: [ runtime ]
        schema: null
        cross_layer: true
        notes: null

      # 6 INFRA-HARDENING & SECURITY POLICIES
      - name: firewall_rules
        path: configs/infra/firewall.yml
        type: config
        category: infra_security
        semver: "{semver}"
        version: "{config_version}"
        digest: "{sha256}"
        manifest_key: mlr.4A.config.firewall
        license: "{spdx_or_internal}"
        role: Ingress CIDR allow-list + egress deny-list for batch workers.
        dependencies: []
        source: internal
        owner: { sre_team }
        last_updated: "{iso8601_timestamp}"
        environment: [ runtime ]
        schema: null
        cross_layer: false
        notes: null

      - name: nfs_export_policy_md
        path: docs/infra/nfs_export_policy.md
        type: documentation
        category: infra_security
        semver: "{semver}"
        version: "{doc_version}"
        digest: "{sha256}"
        manifest_key: mlr.4A.docs.nfs_export_policy
        license: "{spdx_or_internal}"
        role: Human-readable contract for NFS RW export rules (prod vs CI).
        dependencies: []
        source: internal
        owner: { sre_team }
        last_updated: "{iso8601_timestamp}"
        environment: [ dev, ci, runtime ]
        schema: null
        cross_layer: false
        notes: null

      # 7 FAILURE REPRODUCTION & AUDIT TOOLS
      - name: failure_reproducer_py
        path: tools/failure_reproducer.py
        type: code
        category: debug_tooling
        semver: "{code_semver}"
        version: "{git_commit}"
        digest: "{git_tree_hash}"
        manifest_key: mlr.4A.tool.failure_reproducer
        license: "{spdx_or_internal}"
        role: Given run_id + seed, replays RNG & data loaders for bug triage.
        dependencies:
          - global_rng_trace_log
        source: internal
        owner: { qa_team }
        last_updated: "{iso8601_timestamp}"
        environment: [ dev ]
        schema: null
        cross_layer: false
        notes: null

      - name: geo_audit_py
        path: tools/geo_audit.py
        type: code
        category: debug_tooling
        semver: "{code_semver}"
        version: "{git_commit}"
        digest: "{git_tree_hash}"
        manifest_key: mlr.4A.tool.geo_audit
        license: "{spdx_or_internal}"
        role: Scans output for impossible lat/lon combos (e.g. ocean points).
        dependencies:
          - schemas_directory
        source: internal
        owner: { qa_team }
        last_updated: "{iso8601_timestamp}"
        environment: [ dev ]
        schema: null
        cross_layer: false
        notes: null

      # 8 DATA-SCIENCE HARNESS & MODEL COEFFICIENTS
      - name: hurdle_coefficients_yaml
        path: config/models/hurdle_coefficients.yaml
        type: config
        category: model_params
        semver: "{semver}"
        version: "{coeff_version}"
        digest: "{sha256}"
        manifest_key: mlr.1A.config.hurdle_coefficients
        license: "{spdx_or_internal}"
        role: θ₀, θ₁, dispersion for hurdle NB model (cross-layer reference).
        dependencies: []
        source: internal
        owner: { data_science_team }
        last_updated: "{iso8601_timestamp}"
        environment: [ runtime ]
        schema: null
        cross_layer: true
        notes: null

      - name: footfall_coefficients_yaml
        path: config/models/footfall_coefficients.yaml
        type: config
        category: model_params
        semver: "{semver}"
        version: "{coeff_version}"
        digest: "{sha256}"
        manifest_key: mlr.1B.config.footfall_coefficients
        license: "{spdx_or_internal}"
        role: GLM coefficients for footfall scaling (cross-layer reference).
        dependencies: []
        source: internal
        owner: { data_science_team }
        last_updated: "{iso8601_timestamp}"
        environment: [ runtime ]
        schema: null
        cross_layer: true
        notes: null

      - name: footfall_glm_harness_py
        path: src/ds/footfall_glm_harness.py
        type: code
        category: model_harness
        semver: "{code_semver}"
        version: "{git_commit}"
        digest: "{git_tree_hash}"
        manifest_key: mlr.4A.ds.footfall_glm_harness
        license: "{spdx_or_internal}"
        role: Loads footfall_coefficients + site_catalogue → predicts F_i.
        dependencies:
          - footfall_coefficients_yaml
          - site_catalogue
        source: internal
        owner: { data_science_team }
        last_updated: "{iso8601_timestamp}"
        environment: [ dev ]
        schema: null
        cross_layer: false
        notes: null

      - name: adversarial_xgb_model
        path: artefacts/models/adversarial_xgb.pkl
        type: model
        category: robustness
        semver: "{semver}"
        version: "{model_version}"
        digest: "{sha256}"
        manifest_key: mlr.4A.model.adversarial_xgb
        license: "{spdx_or_internal}"
        role: XGBoost classifier used for adversarial audit of synthetic data.
        dependencies: []
        source: internal
        owner: { qa_team }
        last_updated: "{iso8601_timestamp}"
        environment: [ ci ]
        schema: null
        cross_layer: false
        notes: null

      # 9 DST EDGE-CASE PASSER
      - name: dst_edge_passer_py
        path: tests/dst_edge_passer.py
        type: code
        category: time_validation
        semver: "{code_semver}"
        version: "{git_commit}"
        digest: "{git_tree_hash}"
        manifest_key: mlr.4A.test.dst_edge_passer
        license: "{spdx_or_internal}"
        role: Replays DST fold/gap transactions; asserts no TimeZoneLookupError.
        dependencies:
          - zoneinfo_version_yml
        source: internal
        owner: { qa_team }
        last_updated: "{iso8601_timestamp}"
        environment: [ ci ]
        schema: null
        cross_layer: false
        notes: null

      - name: dst_failures_csv
        path: artefacts/fixtures/dst_failures.csv
        type: dataset
        category: time_validation
        semver: "{semver}"
        version: "{fixture_version}"
        digest: "{sha256}"
        manifest_key: mlr.4A.fixtures.dst_failures
        license: "{spdx_or_internal}"
        role: Historical DST lookup failures for regression testing.
        dependencies: []
        source: internal
        owner: { qa_team }
        last_updated: "{iso8601_timestamp}"
        environment: [ ci ]
        schema: null
        cross_layer: false
        notes: null

      # 10 LICENCE DIRECTORY & VALIDATOR
      - name: licences_directory
        path: LICENSES/
        type: directory
        category: licence
        semver: "{semver}"
        version: "{licence_bundle_version}"
        digest: "{sha256}"
        manifest_key: mlr.4A.dir.licences
        license: Mixed
        role: Folder containing all third-party licence texts referenced in registry.
        dependencies: []
        source: internal
        owner: { data_governance_team }
        last_updated: "{iso8601_timestamp}"
        environment: [ ci, runtime ]
        schema: null
        cross_layer: false
        notes: null

      - name: validate_licences_py
        path: ci/tests/validate_licences.py
        type: ci_test
        category: licence
        semver: "{code_semver}"
        version: "{git_commit}"
        digest: "{git_tree_hash}"
        manifest_key: mlr.4A.ci.validate_licences
        license: "{spdx_or_internal}"
        role: CI test ensuring every external artefact has licence text & digest.
        dependencies:
          - licences_directory
          - allocation_licences_manifest
        source: internal
        owner: { qa_team }
        last_updated: "{iso8601_timestamp}"
        environment: [ ci ]
        schema: null
        cross_layer: false
        notes: null

      # 11 RELEASE BLOCKING CONFIGS
      - name: upload_to_hashgate_sh
        path: scripts/deploy/upload_to_hashgate.sh
        type: script
        category: release
        semver: "{code_semver}"
        version: "{git_commit}"
        digest: "{git_tree_hash}"
        manifest_key: mlr.4A.script.upload_to_hashgate
        license: "{spdx_or_internal}"
        role: Uploads build.manifest + registry digest to Hashgate notarisation.
        dependencies:
          - build.manifest
        source: internal
        owner: { sre_team }
        last_updated: "{iso8601_timestamp}"
        environment: [ staging, prod ]
        schema: null
        cross_layer: false
        notes: null

      - name: block_merge_yaml
        path: configs/ci/block_merge.yaml
        type: config
        category: release
        semver: "{semver}"
        version: "{config_version}"
        digest: "{sha256}"
        manifest_key: mlr.4A.config.block_merge
        license: "{spdx_or_internal}"
        role: GH Action config that blocks merge unless Hashgate receipt present.
        dependencies:
          - upload_to_hashgate_sh
        source: internal
        owner: { sre_team }
        last_updated: "{iso8601_timestamp}"
        environment: [ ci ]
        schema: null
        cross_layer: false
        notes: null
        
      # Cross-layer reference for site catalogue (used by footfall harness)
      - name: site_catalogue
        path: artefacts/catalogue/site_catalogue.parquet
        type: dataset
        category: catalogue
        semver: { semver }
        version: { vintage }
        digest: { sha256 }
        manifest_key: mlr.1B.data.site_catalogue
        license: { spdx_or_internal }
        role: Cross-layer site catalogue consumed by footfall_glm_harness_py.
        dependencies: [ ]
        source: internal
        owner: { platform_team }
        last_updated: { iso8601_timestamp }
        environment: [ runtime ]
        schema: null
        cross_layer: true
        notes: null

      # Cross-layer roll-up of licences from allocation subsegment (3A)
      - name: allocation_licences_manifest
        path: artefacts/manifests/allocation_licences_manifest.json
        type: manifest
        category: licence
        semver: { semver }
        version: { run_id }
        digest: { sha256 }
        manifest_key: allocation_licences_digest
        license: { spdx_or_internal }
        role: Roll-up manifest of licence digests for allocation artefacts.
        dependencies: [ ]
        source: internal
        owner: { data_governance_team }
        last_updated: { iso8601_timestamp }
        environment: [ ci ]
        schema: null
        cross_layer: true
        notes: null
