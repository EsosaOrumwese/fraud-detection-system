subsegments:
  - id: "1B"
    name: "Placing outlets on the planet"
    artifacts:

    # ----------- Core egress (dataset + schema) -----------
    - name: site_catalogue
      path: data/outputs/1B/site_catalogue/seed={seed}/fingerprint={manifest_fingerprint}/
      type: dataset
      category: output
      semver: "{semver}"
      version: "{manifest_fingerprint}"
      digest: "{sha256}"
      manifest_key: mlr.1B.output.site_catalogue
      license: null
      role: "Final per‑site rows (coords, tz, remoteness, footfall, provenance); committed atomically via rename."
      dependencies:
        - candidate_pool_index
        - fenwick_snapshot
        - acceptance_policy
        - fallback_policy
        - tz_polygons_ref
        - footfall_coefficients
        - winsor_policy
      source: internal
      owner: "{owner_team}"
      last_updated: "{iso8601_timestamp}"
      environment: [ runtime ]
      schema: site_catalogue.avsc
      cross_layer: true
      notes: "Crash‑safe writes; validated by spatial_write_manifest."

    - name: site_catalogue_schema
      path: schema/site_catalogue.avsc
      type: schema
      category: output
      semver: "{schema_semver}"
      version: "{schema_version}"
      digest: "{schema_digest}"
      manifest_key: mlr.1B.schema.site_catalogue
      license: null
      role: "Single authoritative schema for site catalogue (columns, types, constraints)."
      dependencies: [ ]
      source: internal
      owner: "{owner_team}"
      last_updated: "{iso8601_timestamp}"
      environment: [ dev, staging, prod ]
      schema: null
      cross_layer: false
      notes: null

    # ----------- Spatial references, CRS, grid, boundaries -----------
    - name: crs_policy
      path: configs/spatial/crs_policy.yaml
      type: config
      category: spatial
      semver: "{semver}"
      version: "{config_version}"
      digest: "{sha256}"
      manifest_key: mlr.spatial.crs_policy
      license: null
      role: "Canonical CRS (e.g., EPSG:4326) and allowed temporary transforms; rounding/precision rules."
      dependencies: [ ]
      source: internal
      owner: "{platform_team}"
      last_updated: "{iso8601_timestamp}"
      environment: [ runtime ]
      schema: null
      cross_layer: true
      notes: null

    - name: global_grid_spec
      path: configs/spatial/global_grid_spec.yaml
      type: config
      category: spatial
      semver: "{semver}"
      version: "{config_version}"
      digest: "{sha256}"
      manifest_key: mlr.spatial.global_grid_spec
      license: null
      role: "Grid origin, resolution (e.g., 1/1200°), and indexing; shared by priors and samplers."
      dependencies:
        - crs_policy
      source: internal
      owner: "{platform_team}"
      last_updated: "{iso8601_timestamp}"
      environment: [ runtime ]
      schema: null
      cross_layer: true
      notes: null

    - name: country_boundary_ref
      path: data/reference/boundaries/admin0/{vintage}/
      type: reference
      category: spatial_reference
      semver: "{semver}"
      version: "{vintage}"
      digest: "{reference_digest}"
      manifest_key: mlr.ref.country_boundaries_admin0
      license: "{spdx_or_internal}"
      role: "Country polygons for clipping priors and validating site ISO."
      dependencies: [ ]
      source: external
      owner: "{data_governance_team}"
      last_updated: "{iso8601_timestamp}"
      environment: [ dev, staging, prod ]
      schema: null
      cross_layer: true
      notes: null

    - name: land_water_mask_ref
      path: data/reference/masks/land_water/{vintage}/
      type: reference
      category: spatial_reference
      semver: "{semver}"
      version: "{vintage}"
      digest: "{reference_digest}"
      manifest_key: mlr.ref.land_water_mask
      license: "{spdx_or_internal}"
      role: "Land/sea mask used in acceptance tests and candidate filtering."
      dependencies: [ ]
      source: external
      owner: "{data_governance_team}"
      last_updated: "{iso8601_timestamp}"
      environment: [ dev, staging, prod ]
      schema: null
      cross_layer: true
      notes: null

    - name: boundary_topology_fix_policy
      path: configs/spatial/boundary_topology_fix_policy.yaml
      type: config
      category: spatial
      semver: "{semver}"
      version: "{policy_version}"
      digest: "{sha256}"
      manifest_key: mlr.spatial.boundary_topology_fix_policy
      license: null
      role: "Rules/tolerances for repairing boundary topology before clipping."
      dependencies:
        - country_boundary_ref
      source: internal
      owner: "{platform_team}"
      last_updated: "{iso8601_timestamp}"
      environment: [ runtime ]
      schema: null
      cross_layer: true
      notes: null

    # ----------- Spatial priors & blending -----------
    - name: spatial_manifest
      path: configs/manifests/spatial_manifest.json
      type: manifest
      category: spatial_prior
      semver: "{manifest_key}"
      version: "{manifest_key}"
      digest: "{sha256}"
      manifest_key: "{manifest_key}"
      license: "{spdx_or_internal}"
      role: "Aggregated manifest of all spatial prior assets with their digests."
      dependencies:
        - sibling_sha256s
      source: internal
      owner: "{owner_team}"
      last_updated: "{iso8601_timestamp}"
      environment: [ ci, runtime ]
      schema: null
      cross_layer: true
      notes: "Reuses prior bundle registered under 1A."

    - name: sibling_sha256s
      path: configs/manifests/spatial/sibling_sha256s/
      type: directory
      category: versioning
      semver: null
      version: null
      digest: null
      manifest_key: null
      license: "{spdx_or_internal}"
      role: "Individual .sha256 digest files for spatial prior siblings."
      dependencies: [ ]
      source: internal
      owner: "{owner_team}"
      last_updated: "{iso8601_timestamp}"
      environment: [ ci ]
      schema: null
      cross_layer: true
      notes: null

    - name: hrsl_pop_100m_raster
      path: data/spatial_priors/hrsl_pop_100m_v1.2/hrsl_pop_100m.tif
      type: reference
      category: spatial_prior
      semver: "{semver}"
      version: "2020_v1.2"
      digest: "{sha256}"
      manifest_key: mlr.ref.hrsl_pop_100m_v1_2
      license: "{spdx_or_internal}"
      role: "High‑Resolution Settlement Layer raster for population density."
      dependencies: [ ]
      source: "Facebook HRSL"
      owner: "{owner_team}"
      last_updated: "{iso8601_timestamp}"
      environment: [ runtime ]
      schema: null
      cross_layer: true
      notes: null

    - name: worldpop_raster
      path: data/spatial_priors/worldpop/worldpop_2023Q4.tif
      type: reference
      category: spatial_prior
      semver: "{semver}"
      version: "2023Q4"
      digest: "{sha256}"
      manifest_key: mlr.ref.worldpop_2023Q4
      license: "{spdx_or_internal}"
      role: "WorldPop raster for population fallback in spatial placement."
      dependencies: [ ]
      source: WorldPop
      owner: "{owner_team}"
      last_updated: "{iso8601_timestamp}"
      environment: [ runtime ]
      schema: null
      cross_layer: true
      notes: null

    - name: osm_primary_roads
      path: data/spatial_priors/osm/osm_primary_roads.shp
      type: reference
      category: spatial_prior
      semver: "{semver}"
      version: "{vintage}"
      digest: "{sha256}"
      manifest_key: mlr.ref.osm_primary_roads_{vintage}
      license: "ODbL-1.0"
      role: "OpenStreetMap primary roads for road‑proximity prior."
      dependencies: [ ]
      source: OpenStreetMap
      owner: "{owner_team}"
      last_updated: "{iso8601_timestamp}"
      environment: [ runtime ]
      schema: null
      cross_layer: true
      notes: "Includes .shp, .shx, .dbf, .prj."

    - name: iata_airport_polygons
      path: data/spatial_priors/iata/airports.geojson
      type: reference
      category: spatial_prior
      semver: "{semver}"
      version: "2025"
      digest: "{sha256}"
      manifest_key: mlr.ref.iata_airport_polygons_2025
      license: "{spdx_or_internal}"
      role: "IATA airport service‑area polygons."
      dependencies: [ ]
      source: IATA
      owner: "{owner_team}"
      last_updated: "{iso8601_timestamp}"
      environment: [ runtime ]
      schema: null
      cross_layer: true
      notes: null

    - name: spatial_blend
      path: configs/spatial/spatial_blend.yaml
      type: config
      category: spatial_prior
      semver: "{semver}"
      version: "{config_version}"
      digest: "{sha256}"
      manifest_key: mlr.1B.priors.spatial_blend
      license: "{spdx_or_internal}"
      role: "Blend definition for category‑specific priors into combined weights."
      dependencies:
        - hrsl_pop_100m_raster
        - worldpop_raster
        - osm_primary_roads
        - iata_airport_polygons
      source: internal
      owner: "{owner_team}"
      last_updated: "{iso8601_timestamp}"
      environment: [ runtime ]
      schema: null
      cross_layer: false
      notes: null

    - name: prior_blend_recipe
      path: configs/spatial/priors/prior_blend_recipe.yaml
      type: config
      category: spatial_prior
      semver: "{semver}"
      version: "{config_version}"
      digest: "{sha256}"
      manifest_key: mlr.1B.priors.blend_recipe
      license: null
      role: "Per‑category blend weights and normalization mode."
      dependencies: [ ]
      source: internal
      owner: "{owner_team}"
      last_updated: "{iso8601_timestamp}"
      environment: [ runtime ]
      schema: null
      cross_layer: false
      notes: null

    - name: prior_blend_manifest
      path: data/manifests/1B/prior_blend/{manifest_key}.json
      type: manifest
      category: spatial_prior
      semver: "{semver}"
      version: "{manifest_key}"
      digest: "{sha256}"
      manifest_key: mlr.1B.priors.blend_manifest
      license: null
      role: "Records component prior digests and recipe used for each blend."
      dependencies:
        - prior_blend_recipe
      source: internal
      owner: "{owner_team}"
      last_updated: "{iso8601_timestamp}"
      environment: [ ci, runtime ]
      schema: null
      cross_layer: false
      notes: "Lists country→recipe→source prior digests."

    - name: prior_provenance_map
      path: data/derived/1B/prior_provenance_map/{manifest_key}/
      type: mapping
      category: spatial_prior
      semver: "{semver}"
      version: "{manifest_key}"
      digest: "{sha256}"
      manifest_key: mlr.1B.priors.provenance_map
      license: null
      role: "Country/category → component prior vintage actually used."
      dependencies:
        - prior_blend_manifest
      source: internal
      owner: "{owner_team}"
      last_updated: "{iso8601_timestamp}"
      environment: [ runtime ]
      schema: null
      cross_layer: false
      notes: null

    - name: blended_raster_cache
      path: data/spatial_priors/blended/cache_v1/
      type: directory
      category: spatial_prior
      semver: "{semver}"
      version: "v1"
      digest: "{sha256}"
      manifest_key: mlr.1B.cache.blended_raster
      license: "{spdx_or_internal}"
      role: "Cached blended rasters for repeatable sampling without recompute."
      dependencies:
        - spatial_blend
      source: internal
      owner: "{owner_team}"
      last_updated: "{iso8601_timestamp}"
      environment: [ runtime ]
      schema: null
      cross_layer: false
      notes: null

    # ----------- Indices & candidate pools -----------
    - name: country_cell_index
      path: data/indices/1B/country_cell_index/{grid_version}/
      type: dataset
      category: spatial_index
      semver: "{semver}"
      version: "{grid_version}"
      digest: "{sha256}"
      manifest_key: mlr.1B.index.country_cell_index
      license: null
      role: "Grid‑cell membership per country (post boundary clip)."
      dependencies:
        - global_grid_spec
        - country_boundary_ref
      source: internal
      owner: "{engineering_team}"
      last_updated: "{iso8601_timestamp}"
      environment: [ runtime ]
      schema: null
      cross_layer: false
      notes: null

    - name: candidate_pool_index
      path: data/indices/1B/candidate_pool_index/{manifest_key}/
      type: dataset
      category: spatial_index
      semver: "{semver}"
      version: "{manifest_key}"
      digest: "{sha256}"
      manifest_key: mlr.1B.index.candidate_pool
      license: null
      role: "Eligible cells/points with weights after masks, clips, and blends."
      dependencies:
        - country_cell_index
        - land_water_mask_ref
        - prior_blend_recipe
        - prior_blend_manifest
        - sample_blacklist_areas
      source: internal
      owner: "{engineering_team}"
      last_updated: "{iso8601_timestamp}"
      environment: [ runtime ]
      schema: null
      cross_layer: false
      notes: null

    - name: fenwick_snapshot
      path: data/cache/1B/fenwick/{manifest_key}/
      type: dataset
      category: spatial_index
      semver: "{semver}"
      version: "{manifest_key}"
      digest: "{sha256}"
      manifest_key: mlr.1B.cache.fenwick_snapshot
      license: null
      role: "Serialized Fenwick trees / alias tables for RNG‑free sampling."
      dependencies:
        - candidate_pool_index
      source: internal
      owner: "{engineering_team}"
      last_updated: "{iso8601_timestamp}"
      environment: [ runtime ]
      schema: null
      cross_layer: false
      notes: "File names follow fenwick_tree_cache_{country}_{prior}.bin."

    - name: sampling_method_manifest
      path: data/manifests/1B/sampling_method/{manifest_key}.json
      type: manifest
      category: sampling
      semver: "{semver}"
      version: "{manifest_key}"
      digest: "{sha256}"
      manifest_key: mlr.1B.sampling.method_manifest
      license: null
      role: "Sampler choice (Fenwick vs alias) plus numeric tolerances & seeds."
      dependencies:
        - fenwick_snapshot
      source: internal
      owner: "{owner_team}"
      last_updated: "{iso8601_timestamp}"
      environment: [ ci, runtime ]
      schema: null
      cross_layer: false
      notes: null

    - name: fenwick_build_event
      path: logs/spatial/fenwick_build_event.jsonl
      type: log
      category: sampling
      semver: "{semver}"
      version: "{manifest_key}"
      digest: "{sha256}"
      manifest_key: mlr.1B.events.fenwick_build
      license: "{spdx_or_internal}"
      role: "Event log for Fenwick CDF construction."
      dependencies:
        - blended_raster_cache
      source: internal
      owner: "{owner_team}"
      last_updated: "{iso8601_timestamp}"
      environment: [ runtime ]
      schema: null
      cross_layer: false
      notes: null

    # ----------- Acceptance / fallback governance & metrics -----------
    - name: acceptance_policy
      path: configs/spatial/acceptance_policy.yaml
      type: config
      category: acceptance
      semver: "{semver}"
      version: "{policy_version}"
      digest: "{sha256}"
      manifest_key: mlr.1B.acceptance.policy
      license: null
      role: "Thresholds: land/water, road proximity, TZ‑country consistency."
      dependencies:
        - crs_policy
        - road_proximity_config
      source: internal
      owner: "{owner_team}"
      last_updated: "{iso8601_timestamp}"
      environment: [ runtime ]
      schema: null
      cross_layer: false
      notes: null

    - name: acceptance_metrics
      path: ci/metrics/1B/acceptance/{run_id}.parquet
      type: dataset
      category: monitoring
      semver: "{semver}"
      version: "{run_id}"
      digest: "{sha256}"
      manifest_key: mlr.1B.metrics.acceptance
      license: null
      role: "Nightly acceptance rates with Wilson intervals."
      dependencies:
        - site_catalogue
        - acceptance_policy
      source: internal
      owner: "{qa_team}"
      last_updated: "{iso8601_timestamp}"
      environment: [ ci ]
      schema: null
      cross_layer: true
      notes: null

    - name: fallback_policy
      path: configs/spatial/fallback_policy.yml
      type: config
      category: fallback
      semver: "{semver}"
      version: "{policy_version}"
      digest: "{sha256}"
      manifest_key: mlr.1B.fallback.policy
      license: "{spdx_or_internal}"
      role: "Rules when priors fail; global fallback rate cap < 1 %."
      dependencies:
        - spatial_manifest
      source: internal
      owner: "{owner_team}"
      last_updated: "{iso8601_timestamp}"
      environment: [ runtime ]
      schema: null
      cross_layer: false
      notes: null

    - name: fallback_metrics
      path: ci/metrics/1B/fallback/{run_id}.parquet
      type: dataset
      category: monitoring
      semver: "{semver}"
      version: "{run_id}"
      digest: "{sha256}"
      manifest_key: mlr.1B.metrics.fallback
      license: null
      role: "Realized fallback rates per country/category with reason codes."
      dependencies:
        - site_catalogue
        - fallback_policy
      source: internal
      owner: "{qa_team}"
      last_updated: "{iso8601_timestamp}"
      environment: [ ci ]
      schema: null
      cross_layer: true
      notes: null

    - name: sample_blacklist_areas
      path: data/reference/exclusions/sample_blacklist_areas/{vintage}/
      type: dataset
      category: spatial_reference
      semver: "{semver}"
      version: "{vintage}"
      digest: "{sha256}"
      manifest_key: mlr.ref.sample_blacklist_areas
      license: null
      role: "Polygons to exclude (military zones, glaciers, etc.)."
      dependencies:
        - country_boundary_ref
      source: external
      owner: "{data_governance_team}"
      last_updated: "{iso8601_timestamp}"
      environment: [ dev, staging, prod ]
      schema: null
      cross_layer: true
      notes: null

    # ----------- Roads, proximity & network distance -----------
    - name: roads_ref
      path: data/reference/roads/{vintage}/
      type: reference
      category: spatial_reference
      semver: "{semver}"
      version: "{vintage}"
      digest: "{reference_digest}"
      manifest_key: mlr.ref.roads
      license: "{spdx_or_internal}"
      role: "Road network vintage used for proximity checks."
      dependencies: [ ]
      source: external
      owner: "{data_governance_team}"
      last_updated: "{iso8601_timestamp}"
      environment: [ dev, staging, prod ]
      schema: null
      cross_layer: true
      notes: "May share vintage with osm_primary_roads."

    - name: road_spatial_index
      path: data/cache/1B/road_index/{vintage}/
      type: dataset
      category: spatial_index
      semver: "{semver}"
      version: "{vintage}"
      digest: "{sha256}"
      manifest_key: mlr.1B.cache.road_spatial_index
      license: null
      role: "Tiled spatial index for fast road proximity queries."
      dependencies:
        - roads_ref
      source: internal
      owner: "{engineering_team}"
      last_updated: "{iso8601_timestamp}"
      environment: [ runtime ]
      schema: null
      cross_layer: false
      notes: null

    - name: road_proximity_config
      path: configs/spatial/road_proximity_config.yaml
      type: config
      category: acceptance
      semver: "{semver}"
      version: "{policy_version}"
      digest: "{sha256}"
      manifest_key: mlr.1B.acceptance.road_proximity
      license: null
      role: "Proximity thresholds per merchant category (default 50 m)."
      dependencies: [ ]
      source: internal
      owner: "{owner_team}"
      last_updated: "{iso8601_timestamp}"
      environment: [ runtime ]
      schema: null
      cross_layer: false
      notes: null

    - name: network_distance_graph
      path: data/reference/road_graph/{vintage}/
      type: reference
      category: spatial_reference
      semver: "{semver}"
      version: "{vintage}"
      digest: "{reference_digest}"
      manifest_key: mlr.ref.road_graph
      license: "{spdx_or_internal}"
      role: "Contraction‑hierarchies graph for true network distances."
      dependencies:
        - roads_ref
      source: external
      owner: "{data_governance_team}"
      last_updated: "{iso8601_timestamp}"
      environment: [ dev, staging, prod ]
      schema: null
      cross_layer: true
      notes: null

    - name: road_distance_method
      path: configs/spatial/road_distance_method.yaml
      type: config
      category: acceptance
      semver: "{semver}"
      version: "{policy_version}"
      digest: "{sha256}"
      manifest_key: mlr.1B.acceptance.road_distance_method
      license: null
      role: "Method for road distance (nearest segment vs shortest path)."
      dependencies:
        - network_distance_graph
      source: internal
      owner: "{platform_team}"
      last_updated: "{iso8601_timestamp}"
      environment: [ runtime ]
      schema: null
      cross_layer: true
      notes: null

    # ----------- Remoteness (capital GC + optional network) -----------
    - name: capital_points_ref
      path: data/reference/capitals/{vintage}/capitals.csv
      type: reference
      category: spatial_reference
      semver: "{semver}"
      version: "{vintage}"
      digest: "{reference_digest}"
      manifest_key: mlr.ref.capital_points
      license: "{spdx_or_internal}"
      role: "Authoritative capital coordinates."
      dependencies: [ ]
      source: external
      owner: "{data_governance_team}"
      last_updated: "{iso8601_timestamp}"
      environment: [ dev, staging, prod ]
      schema: null
      cross_layer: true
      notes: null

    - name: remoteness_method
      path: configs/spatial/remoteness_method.yaml
      type: config
      category: acceptance
      semver: "{semver}"
      version: "{policy_version}"
      digest: "{sha256}"
      manifest_key: mlr.1B.acceptance.remoteness_method
      license: null
      role: "Great‑circle method, ellipsoid constants, rounding policy."
      dependencies:
        - crs_policy
      source: internal
      owner: "{platform_team}"
      last_updated: "{iso8601_timestamp}"
      environment: [ runtime ]
      schema: null
      cross_layer: true
      notes: null

    - name: remoteness_metrics
      path: ci/metrics/1B/remoteness/{run_id}.parquet
      type: dataset
      category: monitoring
      semver: "{semver}"
      version: "{run_id}"
      digest: "{sha256}"
      manifest_key: mlr.1B.metrics.remoteness
      license: null
      role: "Distribution summaries of GC and/or network distances."
      dependencies:
        - site_catalogue
        - remoteness_method
        - capital_points_ref
      source: internal
      owner: "{qa_team}"
      last_updated: "{iso8601_timestamp}"
      environment: [ ci ]
      schema: null
      cross_layer: true
      notes: null

    # ----------- Timezone consistency -----------
    - name: tz_polygons_ref
      path: data/reference/timezones/{vintage}/
      type: reference
      category: spatial_reference
      semver: "{semver}"
      version: "{vintage}"
      digest: "{reference_digest}"
      manifest_key: mlr.ref.tz_polygons
      license: "{spdx_or_internal}"
      role: "Timezone polygons."
      dependencies: [ ]
      source: external
      owner: "{data_governance_team}"
      last_updated: "{iso8601_timestamp}"
      environment: [ dev, staging, prod ]
      schema: null
      cross_layer: true
      notes: null

    - name: tz_override_table
      path: configs/spatial/tz_override_table.yaml
      type: config
      category: spatial
      semver: "{semver}"
      version: "{policy_version}"
      digest: "{sha256}"
      manifest_key: mlr.spatial.tz_override_table
      license: null
      role: "Manual corrections for TZ assignment."
      dependencies:
        - tz_polygons_ref
      source: internal
      owner: "{owner_team}"
      last_updated: "{iso8601_timestamp}"
      environment: [ runtime ]
      schema: null
      cross_layer: true
      notes: null

    - name: tz_mismatch_events
      path: logs/spatial/tz_mismatch.jsonl
      type: dataset
      category: timezone
      semver: "{semver}"
      version: "{run_id}"
      digest: "{sha256}"
      manifest_key: mlr.1B.events.tz_mismatch
      license: null
      role: "Event when site TZ country ≠ site ISO country."
      dependencies:
        - site_catalogue
        - tz_polygons_ref
      source: internal
      owner: "{qa_team}"
      last_updated: "{iso8601_timestamp}"
      environment: [ runtime ]
      schema: null
      cross_layer: true
      notes: null

    # ----------- Footfall & winsorisation -----------
    - name: footfall_coefficients
      path: configs/spatial/footfall_coefficients.yaml
      type: config
      category: footfall
      semver: "{semver}"
      version: "{config_version}"
      digest: "{sha256}"
      manifest_key: mlr.1B.footfall.coefficients
      license: null
      role: "κ_(mcc,channel) coefficients for log‑normal footfall."
      dependencies: [ ]
      source: internal
      owner: "{owner_team}"
      last_updated: "{iso8601_timestamp}"
      environment: [ runtime ]
      schema: null
      cross_layer: false
      notes: null

    - name: winsor_policy
      path: configs/spatial/winsor_policy.yaml
      type: config
      category: footfall
      semver: "{semver}"
      version: "{policy_version}"
      digest: "{sha256}"
      manifest_key: mlr.1B.footfall.winsor_policy
      license: null
      role: "Caps for footfall/remoteness (μ+3σ) when stratum ≥ 30."
      dependencies:
        - footfall_coefficients
      source: internal
      owner: "{owner_team}"
      last_updated: "{iso8601_timestamp}"
      environment: [ runtime ]
      schema: null
      cross_layer: false
      notes: null

    - name: footfall_scalar_table
      path: data/derived/1B/footfall_scalars/{manifest_key}/
      type: dataset
      category: footfall
      semver: "{semver}"
      version: "{manifest_key}"
      digest: "{sha256}"
      manifest_key: mlr.1B.footfall.scalars
      license: null
      role: "Per‑site footfall scalar with provenance tag."
      dependencies:
        - site_catalogue
        - footfall_coefficients
        - winsor_policy
      source: internal
      owner: "{engineering_team}"
      last_updated: "{iso8601_timestamp}"
      environment: [ runtime ]
      schema: null
      cross_layer: false
      notes: null

    # ----------- RNG audit streams -----------
    - name: sample_candidate_events
      path: logs/rng/events/sample_candidate.jsonl
      type: log
      category: rng_event
      semver: "{semver}"
      version: "{run_id}"
      digest: "{sha256}"
      manifest_key: mlr.1B.rng.sample_candidate
      license: null
      role: "Event per candidate sampled (pre‑acceptance)."
      dependencies:
        - rng_event_schema_catalog     # defined in 1A, cross_layer=true
        - fenwick_snapshot
      source: internal
      owner: "{qa_team}"
      last_updated: "{iso8601_timestamp}"
      environment: [ runtime ]
      schema: null
      cross_layer: true
      notes: null

    - name: accept_reject_events
      path: logs/rng/events/accept_reject.jsonl
      type: log
      category: rng_event
      semver: "{semver}"
      version: "{run_id}"
      digest: "{sha256}"
      manifest_key: mlr.1B.rng.accept_reject
      license: null
      role: "Acceptance decision events (land/water, road proximity, TZ)."
      dependencies:
        - rng_event_schema_catalog
        - acceptance_policy
      source: internal
      owner: "{qa_team}"
      last_updated: "{iso8601_timestamp}"
      environment: [ runtime ]
      schema: null
      cross_layer: true
      notes: null

    - name: fallback_invoked_events
      path: logs/rng/events/fallback_invoked.jsonl
      type: log
      category: rng_event
      semver: "{semver}"
      version: "{run_id}"
      digest: "{sha256}"
      manifest_key: mlr.1B.rng.fallback_invoked
      license: null
      role: "Records each fallback invocation & rule triggered."
      dependencies:
        - rng_event_schema_catalog
        - fallback_policy
      source: internal
      owner: "{qa_team}"
      last_updated: "{iso8601_timestamp}"
      environment: [ runtime ]
      schema: null
      cross_layer: true
      notes: null

    - name: fenwick_tie_break
      path: logs/rng/events/fenwick_tie_break.jsonl
      type: log
      category: rng_event
      semver: "{semver}"
      version: "{run_id}"
      digest: "{sha256}"
      manifest_key: mlr.1B.rng.fenwick_tie_break
      license: null
      role: "Tie‑break ordering when cumulative weights collide."
      dependencies:
        - rng_event_schema_catalog
        - fenwick_snapshot
      source: internal
      owner: "{platform_team}"
      last_updated: "{iso8601_timestamp}"
      environment: [ runtime ]
      schema: null
      cross_layer: true
      notes: null

    - name: tz_resample
      path: logs/rng/events/tz_resample.jsonl
      type: log
      category: rng_event
      semver: "{semver}"
      version: "{run_id}"
      digest: "{sha256}"
      manifest_key: mlr.1B.rng.tz_resample
      license: null
      role: "Coordinate re‑sampling events after TZ‑ISO mismatch."
      dependencies:
        - rng_event_schema_catalog
        - tz_polygons_ref
      source: internal
      owner: "{platform_team}"
      last_updated: "{iso8601_timestamp}"
      environment: [ runtime ]
      schema: null
      cross_layer: true
      notes: null

    # ----------- Master seed & end‑of‑run manifest -----------
    - name: master_seed
      path: configs/spatial/master_seed.yaml
      type: config
      category: rng
      semver: "{semver}"
      version: "{config_version}"
      digest: "{sha256}"
      manifest_key: mlr.1B.rng.master_seed
      license: null
      role: "Philox master seed for spatial sampling sub‑streams."
      dependencies:
        - manifest_fingerprint          # from 1A, cross_layer=true
      source: internal
      owner: "{owner_team}"
      last_updated: "{iso8601_timestamp}"
      environment: [ runtime ]
      schema: null
      cross_layer: true
      notes: null

    - name: final_parquet_file_pattern
      path: configs/storage/final_parquet_file_pattern.yaml
      type: config
      category: storage
      semver: "{semver}"
      version: "{config_version}"
      digest: "{sha256}"
      manifest_key: mlr.storage.final_parquet_pattern
      license: null
      role: "Naming template for final Parquet shard outputs."
      dependencies:
        - storage_path_pattern          # from 1A
      source: internal
      owner: "{owner_team}"
      last_updated: "{iso8601_timestamp}"
      environment: [ runtime ]
      schema: null
      cross_layer: true
      notes: "Pattern: 'catalogue/seed={seed}/fingerprint={fingerprint}/part-*.parquet'"

    - name: end_of_run_manifest
      path: ci/manifests/end_of_run_manifest.json
      type: manifest
      category: storage
      semver: "{semver}"
      version: "{manifest_key}"
      digest: "{sha256}"
      manifest_key: mlr.1B.storage.end_of_run_manifest
      license: null
      role: "Aggregated summary of all output files and digests."
      dependencies:
        - final_parquet_file_pattern
        - manifest_fingerprint
      source: internal
      owner: "{owner_team}"
      last_updated: "{iso8601_timestamp}"
      environment: [ ci ]
      schema: null
      cross_layer: true
      notes: null

    # ----------- Reproducibility: library versions -----------
    - name: geospatial_lib_versions
      path: ci/manifests/geospatial_lib_versions.txt
      type: manifest
      category: reproducibility
      semver: "{semver}"
      version: "{manifest_version}"
      digest: "{sha256}"
      manifest_key: mlr.ci.geospatial_lib_versions
      license: null
      role: "Exact GDAL/GEOS/PROJ (and bindings) used for spatial ops."
      dependencies: [ ]
      source: internal
      owner: "{platform_team}"
      last_updated: "{iso8601_timestamp}"
      environment: [ ci, runtime ]
      schema: null
      cross_layer: true
      notes: null

    # ----------- Documentation / codebook -----------
    - name: site_provenance_codebook
      path: docs/codebooks/site_provenance_codebook.yaml
      type: mapping
      category: documentation
      semver: "{semver}"
      version: "{doc_version}"
      digest: "{sha256}"
      manifest_key: mlr.1B.docs.site_provenance_codebook
      license: null
      role: "Code->meaning map for per‑site provenance tags."
      dependencies:
        - prior_blend_recipe
      source: internal
      owner: "{owner_team}"
      last_updated: "{iso8601_timestamp}"
      environment: [ dev, staging, prod ]
      schema: null
      cross_layer: false
      notes: null

      # Licensing (governed)
    - name: licence_files
      path: LICENSES/
      type: directory
      category: licensing
      semver: "{semver}"
      version: "{run_id}"
      digest: "{sha256_tree}"
      manifest_key: mlr.1B.licenses
      license: CC-BY-4.0-and-PublicDomain
      role: SPDX texts for HRSL/WorldPop/other spatial priors; referenced by spatial_manifest.
      dependencies: [ ]
      source: internal
      owner: "{legal_team}"
      environment: [ ci, runtime ]
      schema: null
      cross_layer: true
      notes: null

    # ----------- Output governance & write safety -----------
    - name: spatial_write_manifest
      path: ci/manifests/spatial_write_manifest.json
      type: manifest
      category: storage
      semver: "{semver}"
      version: "{run_id}"
      digest: "{sha256}"
      manifest_key: mlr.1B.storage.spatial_write_manifest
      license: "{spdx_or_internal}"
      role: Per-run list of written parts (bbox, CRS, digests) for the site catalogue.
      dependencies: [ site_catalogue_schema, crs_policy ]
      source: internal
      owner: "{owner_team}"
      environment: [ ci, runtime ]
      cross_layer: true

    - name: temp_write_policy
      path: configs/storage/temp_write_policy.yaml
      type: config
      category: storage
      semver: "{semver}"
      version: "{config_version}"
      digest: "{sha256}"
      manifest_key: mlr.storage.temp_write_policy
      license: "{spdx_or_internal}"
      role: Atomic rename-only commit rules; governs *.tmp -> final shard.
      dependencies: [ final_parquet_file_pattern ]
      source: internal
      owner: "{owner_team}"
      environment: [ runtime ]
      cross_layer: true

    - name: write_ahead_log
      path: logs/storage/write_ahead.log
      type: log
      category: storage
      semver: "{semver}"
      version: "{run_id}"
      digest: "{sha256}"
      manifest_key: mlr.storage.write_ahead_log
      license: "{spdx_or_internal}"
      role: Idempotent WAL for crash recovery during site-catalogue writes.
      dependencies: [ temp_write_policy ]
      source: internal
      owner: "{qa_team}"
      environment: [ runtime ]
      cross_layer: true