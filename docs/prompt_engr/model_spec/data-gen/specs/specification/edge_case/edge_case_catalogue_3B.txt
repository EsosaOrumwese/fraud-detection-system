--- EC 1 | Stage=DeriveIsVirtual | Severity=High ---
Failure_event: Missing `config/virtual/mcc_channel_rules.yaml`
Anchor: "derive_is_virtual.py, which reads a ledger called config/virtual/mcc_channel_rules.yaml."
Current_handled: No
Detection_gap: Yes
Recovery_gap: Yes
Idempotence_gap: Yes
Metrics_gap: Yes
Expected_format: YAML at `config/virtual/mcc_channel_rules.yaml` with keys `mcc_channel`, `online_only`, optional overrides
Interfaces_affected: DeriveIsVirtualModule/deriveIsVirtual
Test_type: CI
Test_injection: remove `mcc_channel_rules.yaml` and run deriveIsVirtual()
Context: “… script derive_is_virtual.py, which reads a ledger called config/virtual/mcc_channel_rules.yaml …”
Confidence=HIGH
--- END EC 1 ---

--- EC 2 | Stage=DeriveIsVirtual | Severity=Med ---
Failure_event: Invalid `online_only` or override logic in MCC rules
Anchor: "The YAML maps each MCC to an `online_only` flag and, optionally, an override conditioned on the merchant’s declared transaction `channel` or on the field `requires_ship_address`."
Current_handled: Partial
Detection_gap: Yes
Recovery_gap: Yes
Idempotence_gap: Yes
Metrics_gap: Yes
Expected_format: boolean `online_only` and valid override expressions in YAML
Interfaces_affected: DeriveIsVirtualModule/deriveIsVirtual
Test_type: unit
Test_injection: inject invalid flag or override and run test_virtual_rules.py
Context: “… maps each MCC to an `online_only` flag and, optionally, an override conditioned on …”
Confidence=MEDIUM
--- END EC 2 ---

--- EC 3 | Stage=CreateSettlementNode | Severity=High ---
Failure_event: Missing `artefacts/virtual/virtual_settlement_coords.csv`
Anchor: "a two-column table keyed by `merchant_id`: `lat`, `lon`, plus an `evidence_url` column, drawn from artefacts/virtual/virtual_settlement_coords.csv."
Current_handled: No
Detection_gap: Yes
Recovery_gap: Yes
Idempotence_gap: Yes
Metrics_gap: Yes
Expected_format: CSV at `artefacts/virtual/virtual_settlement_coords.csv` with columns `merchant_id,lat,lon,evidence_url`
Interfaces_affected: CreateSettlementNodeModule/createSettlementNode
Test_type: CI
Test_injection: remove CSV and run createSettlementNode()
Context: “… drawn from artefacts/virtual/virtual_settlement_coords.csv, a two-column table keyed by …”
Confidence=HIGH
--- END EC 3 ---

--- EC 4 | Stage=CreateSettlementNode | Severity=Med ---
Failure_event: Missing or malformed columns in settlement coords CSV
Anchor: "a two-column table keyed by `merchant_id`: `lat`, `lon`, plus an `evidence_url` column."
Current_handled: Partial
Detection_gap: Yes
Recovery_gap: Yes
Idempotence_gap: Yes
Metrics_gap: Yes
Expected_format: columns `merchant_id`, `lat`, `lon`, `evidence_url` present and typed correctly
Interfaces_affected: CreateSettlementNodeModule/createSettlementNode
Test_type: unit
Test_injection: drop or rename a column and run createSettlementNode()
Context: “… keyed by `merchant_id`: `lat`, `lon`, plus an `evidence_url` column.”
Confidence=MEDIUM
--- END EC 4 ---

--- EC 5 | Stage=CreateSettlementNode | Severity=High ---
Failure_event: Missing `artefacts/geocode/pelias_cached.sqlite`
Anchor: "scrapes … scrapes the address … via the offline artefacts/geocode/pelias_cached.sqlite bundle."
Current_handled: No
Detection_gap: Yes
Recovery_gap: Yes
Idempotence_gap: Yes
Metrics_gap: Yes
Expected_format: SQLite bundle at `artefacts/geocode/pelias_cached.sqlite`
Interfaces_affected: CreateSettlementNodeModule/verifyGeocodeEvidence
Test_type: CI
Test_injection: delete geocoder bundle and run verify_coords_evidence.py
Context: “… offline artefacts/geocode/pelias_cached.sqlite bundle …”
Confidence=HIGH
--- END EC 5 ---

--- EC 6 | Stage=CreateSettlementNode | Severity=Med ---
Failure_event: Digest mismatch for geocoder bundle
Anchor: "the geocoder bundle artefacts/geocode/pelias_cached.sqlite carries an inline semver and its SHA-256 is registered as pelias_digest in the manifest."
Current_handled: Partial
Detection_gap: Yes
Recovery_gap: Yes
Idempotence_gap: Yes
Metrics_gap: Yes
Expected_format: `pelias_digest` matches SHA-256 of the SQLite file
Interfaces_affected: CreateSettlementNodeModule/verifyGeocodeEvidence
Test_type: CI
Test_injection: corrupt the bundle and run ci/test_geocoder_bundle.py
Context: “carries an inline semver and its SHA-256 is registered as pelias_digest in the manifest.”
Confidence=MEDIUM
--- END EC 6 ---

--- EC 7 | Stage=BuildEdgeCatalogue | Severity=High ---
Failure_event: Missing `config/virtual/cdn_country_weights.yaml`
Anchor: "Customer-facing geography is captured by … config/virtual/cdn_country_weights.yaml."
Current_handled: No
Detection_gap: Yes
Recovery_gap: Yes
Idempotence_gap: Yes
Metrics_gap: Yes
Expected_format: YAML at `config/virtual/cdn_country_weights.yaml` with `country_iso→weight`, `edge_scale`, `semver`, `sha256_digest`
Interfaces_affected: BuildEdgeCatalogueModule/buildEdgeCatalogue
Test_type: CI
Test_injection: remove YAML and run buildEdgeCatalogue()
Context: “captured by a second artefact, config/virtual/cdn_country_weights.yaml.”
Confidence=HIGH
--- END EC 7 ---

--- EC 8 | Stage=BuildEdgeCatalogue | Severity=Med ---
Failure_event: Missing or invalid `edge_scale` in CDN weights
Anchor: "A global integer E = 500—stored in the same YAML as edge_scale—multiplies each weight before rounding."
Current_handled: Partial
Detection_gap: Yes
Recovery_gap: Yes
Idempotence_gap: Yes
Metrics_gap: Yes
Expected_format: integer `edge_scale` in YAML
Interfaces_affected: BuildEdgeCatalogueModule/applyEdgeScale
Test_type: unit
Test_injection: remove or set edge_scale to non-integer and run buildEdgeCatalogue()
Context: “E = 500—stored in the same YAML as edge_scale—multiplies each weight before rounding.”
Confidence=MEDIUM
--- END EC 8 ---

--- EC 9 | Stage=BuildEdgeCatalogue | Severity=High ---
Failure_event: Missing raster artefact `artefacts/rasters/hrsl_100m.tif`
Anchor: "sampling is performed via the same Fenwick-tree … from Facebook HRSL GeoTIFF raster (artefacts/rasters/hrsl_100m.tif)."
Current_handled: No
Detection_gap: Yes
Recovery_gap: Yes
Idempotence_gap: Yes
Metrics_gap: Yes
Expected_format: GeoTIFF at `artefacts/rasters/hrsl_100m.tif`
Interfaces_affected: BuildEdgeCatalogueModule/buildEdgeCatalogue
Test_type: CI
Test_injection: delete raster and run buildEdgeCatalogue()
Context: “… from Facebook HRSL GeoTIFF raster (artefacts/rasters/hrsl_100m.tif).”
Confidence=HIGH
--- END EC 9 ---

--- EC 10 | Stage=BuildCdnAliasTable | Severity=High ---
Failure_event: Missing `config/routing/rng_policy.yml`
Anchor: "Philox sub-stream key is defined as … this policy resides in config/routing/rng_policy.yml."
Current_handled: No
Detection_gap: Yes
Recovery_gap: Yes
Idempotence_gap: Yes
Metrics_gap: Yes
Expected_format: YAML at `config/routing/rng_policy.yml` with key derivation fields
Interfaces_affected: BuildCdnAliasTableModule/buildCdnAliasTable
Test_type: CI
Test_injection: remove YAML and run buildCdnAliasTable()
Context: “this policy resides in config/routing/rng_policy.yml …”
Confidence=HIGH
--- END EC 10 ---

--- EC 11 | Stage=BuildEdgeCatalogue | Severity=High ---
Failure_event: Missing per-merchant Parquet `edge_catalogue/<merchant_id>.parquet`
Anchor: "writes a row to edge_catalogue/<merchant_id>.parquet containing (edge_id, country_iso, lat, lon, tzid, edge_weight)."
Current_handled: No
Detection_gap: Yes
Recovery_gap: Yes
Idempotence_gap: Yes
Metrics_gap: Yes
Expected_format: Parquet at `edge_catalogue/<merchant_id>.parquet` with required schema
Interfaces_affected: BuildEdgeCatalogueModule/buildEdgeCatalogue
Test_type: CI
Test_injection: skip Parquet write and run buildEdgeCatalogue()
Context: “… writes a row to edge_catalogue/<merchant_id>.parquet …”
Confidence=HIGH
--- END EC 11 ---

--- EC 12 | Stage=BuildEdgeCatalogue | Severity=High ---
Failure_event: Missing index entry in `edge_catalogue_index.csv`
Anchor: "appends a line `<merchant_id>,<sha256>` to edge_catalogue_index.csv."
Current_handled: No
Detection_gap: Yes
Recovery_gap: Yes
Idempotence_gap: Yes
Metrics_gap: Yes
Expected_format: CSV line `<merchant_id>,<sha256>` per merchant
Interfaces_affected: BuildEdgeCatalogueModule/buildEdgeCatalogue
Test_type: CI
Test_injection: omit append and run buildEdgeCatalogue()
Context: “appends a line `<merchant_id>,<sha256>` to edge_catalogue_index.csv.”  
Confidence=HIGH
--- END EC 12 ---

--- EC 13 | Stage=ValidateVirtual | Severity=High ---
Failure_event: Missing `config/virtual/virtual_validation.yml`
Anchor: "Thresholds reside in config/virtual/virtual_validation.yml, key `country_tolerance`."
Current_handled: No
Detection_gap: Yes
Recovery_gap: Yes
Idempotence_gap: Yes
Metrics_gap: Yes
Expected_format: YAML at `config/virtual/virtual_validation.yml` with `country_tolerance`, `time_cutoff_tolerance`, `semver`, `sha256_digest`
Interfaces_affected: ValidateVirtualModule/validateVirtual
Test_type: CI
Test_injection: delete YAML and run validate_virtual.py
Context: “… declared in config/virtual/virtual_validation.yml (fields: country_tolerance, time_cutoff_tolerance).”
Confidence=HIGH
--- END EC 13 ---

--- EC 14 | Stage=ValidateVirtual | Severity=Med ---
Failure_event: Validation thresholds out of range
Anchor: "fails if any |ĥπ_c − π_c| > 0.02."
Current_handled: Partial
Detection_gap: Yes
Recovery_gap: Yes
Idempotence_gap: Yes
Metrics_gap: Yes
Expected_format: 0 ≤ |ĥπ_c − π_c| ≤ 0.02 and 0 ≤ time deviation ≤ 5s
Interfaces_affected: ValidateVirtualModule/validateVirtual
Test_type: unit
Test_injection: set tolerance beyond limits and run ci/test_virtual_validation.py
Context: “… fails if any |ĥπ_c − π_c| > 0.02 …”  
Confidence=MEDIUM
--- END EC 14 ---

--- EC 15 | Stage=ValidateVirtual | Severity=High ---
Failure_event: Missing licence files in `LICENSES/`
Anchor: "Licensing obligations flow into LICENSES/akamai_soti.md and LICENSES/facebook_hrsl.md."
Current_handled: No
Detection_gap: Yes
Recovery_gap: Yes
Idempotence_gap: Yes
Metrics_gap: Yes
Expected_format: licence Markdown files under `LICENSES/`
Interfaces_affected: ValidateVirtualModule/validateVirtual
Test_type: CI
Test_injection: remove a licence file and run validate_virtual.py
Context: “flow into LICENSES/akamai_soti.md and LICENSES/facebook_hrsl.md.”  
Confidence=HIGH
--- END EC 15 ---

--- EC 16 | Stage=CrashRecovery | Severity=High ---
Failure_event: Missing or corrupt `logs/edge_progress.log` for recovery
Anchor: "appends the batch key to logs/edge_progress.log … a crash restarts the builder, reads the log, skips completed batches."
Current_handled: No
Detection_gap: Yes
Recovery_gap: Yes
Idempotence_gap: Yes
Metrics_gap: Yes
Expected_format: log file at `logs/edge_progress.log` with one entry per completed batch
Interfaces_affected: BuildEdgeCatalogueModule/crashRecovery
Test_type: CI
Test_injection: delete or corrupt log and restart build
Context: “… appends the batch key to logs/edge_progress.log … a crash restarts the builder …”
Confidence=HIGH
--- END EC 16 ---

<<EC-END>>