%%{init: {
  "theme": "base",
  "themeVariables": {
    "fontFamily": "Inter, Segoe UI, Arial",
    "primaryTextColor": "#0F172A",
    "lineColor": "#334155",
    "tertiaryColor": "#F8FAFC",
    "background": "#FFFFFF"
  }
}}%%
flowchart LR
  subgraph Core["Core Terraform Root"]
    CS3Obj@{ icon: "simple-icons:amazons3", form: "rounded", label: "S3 object-store", pos: "b", h: 52 }
    CS3Ev@{ icon: "simple-icons:amazons3", form: "rounded", label: "S3 evidence", pos: "b", h: 52 }
    CS3Qu@{ icon: "simple-icons:amazons3", form: "rounded", label: "S3 quarantine", pos: "b", h: 52 }
    CS3Ar@{ icon: "simple-icons:amazons3", form: "rounded", label: "S3 archive", pos: "b", h: 52 }
    CRun@{ icon: "simple-icons:amazondynamodb", form: "rounded", label: "DynamoDB control-runs", pos: "b", h: 52 }
    CAdm@{ icon: "simple-icons:amazondynamodb", form: "rounded", label: "DynamoDB admission", pos: "b", h: 52 }
    CPub@{ icon: "simple-icons:amazondynamodb", form: "rounded", label: "DynamoDB publish", pos: "b", h: 52 }
    CLock@{ icon: "simple-icons:amazondynamodb", form: "rounded", label: "DynamoDB tf-lock", pos: "b", h: 52 }
    CBudget@{ icon: "mdi:cash-multiple", form: "rounded", label: "AWS budget", pos: "b", h: 52 }
  end

  subgraph Confluent["Confluent Terraform Root"]
    CEnv@{ icon: "simple-icons:amazonwebservices", form: "rounded", label: "Confluent environment", pos: "b", h: 52 }
    CClu@{ icon: "simple-icons:apachekafka", form: "rounded", label: "Confluent kafka cluster", pos: "b", h: 52 }
    CTop@{ icon: "simple-icons:apachekafka", form: "rounded", label: "Confluent topics", pos: "b", h: 52 }
    CApi@{ icon: "mdi:key", form: "rounded", label: "Runtime kafka api key/secret", pos: "b", h: 52 }
    CSSM@{ icon: "mdi:key", form: "rounded", label: "SSM confluent runtime params", pos: "b", h: 52 }
    CCat@{ icon: "mdi:file-document-check", form: "rounded", label: "topic_catalog.json", pos: "b", h: 52 }
  end

  subgraph Demo["Demo Terraform Root"]
    DRS["terraform_remote_state.confluent"]
    DVpc@{ icon: "simple-icons:amazonwebservices", form: "rounded", label: "VPC + subnets + routing", pos: "b", h: 52 }
    DEcs@{ icon: "simple-icons:amazonecs", form: "rounded", label: "ECS cluster", pos: "b", h: 52 }
    DServices["Daemon services<br/>ig, rtdl-core, decision-lane,<br/>case-trigger, case-mgmt,<br/>label-store, env-conformance"]
    DJobs["One-shot jobs<br/>scenario-runner, world-stream-producer,<br/>oracle-stream-sort, oracle-checker, reporter,<br/>db-migrations"]
    DKin@{ icon: "mdi:waves", form: "rounded", label: "Kinesis ig_event_bus", pos: "b", h: 52 }
    DRds@{ icon: "simple-icons:postgresql", form: "rounded", label: "RDS runtime postgres", pos: "b", h: 52 }
    DSSM@{ icon: "mdi:key", form: "rounded", label: "SSM runtime credentials", pos: "b", h: 52 }
    DManifest@{ icon: "mdi:file-document-check", form: "rounded", label: "demo manifest + topic catalog", pos: "b", h: 52 }
    DLogs@{ icon: "mdi:chart-line", form: "rounded", label: "CloudWatch log group", pos: "b", h: 52 }
  end

  CEnv --> CClu --> CTop
  CApi --> CSSM
  CTop --> CCat --> CS3Ev
  CClu --> DRS
  CTop --> DRS
  DRS --> DSSM

  DVpc --> DEcs
  DVpc --> DRds
  DEcs --> DServices
  DEcs --> DJobs
  DServices --> DLogs
  DJobs --> DLogs
  DSSM --> DServices
  DSSM --> DJobs
  DServices --> DKin
  DJobs --> DKin
  DServices --> DRds
  DJobs --> DRds
  DServices --> CClu
  DJobs --> CClu
  DServices --> CS3Obj
  DServices --> CS3Ar
  DServices --> CS3Qu
  DJobs --> CS3Obj
  DJobs --> CS3Ev
  DManifest --> CS3Ev
  DServices --> CAdm
  DServices --> CPub
  DJobs --> CRun
  CLock --- CRun
  CBudget -.-> DEcs
  CBudget -.-> CClu

  style Core fill:#EFF6FF,stroke:#2563EB,stroke-width:2px
  style Confluent fill:#FDF4FF,stroke:#9333EA,stroke-width:2px
  style Demo fill:#ECFDF5,stroke:#10B981,stroke-width:2px

  class CS3Obj,CS3Ev,CS3Qu,CS3Ar awsdata
  class CRun,CAdm,CPub,CLock awsdynamo
  class CBudget budget
  class CClu,CTop stream
  class CApi,CSSM,DSSM security
  class CEnv,DVpc infra
  class CCat,DManifest artifact
  class DEcs,DServices,DJobs runtime
  class DKin bus
  class DRds datastore
  class DLogs observability
  class DRS statewire

  classDef awsdata fill:#DBEAFE,stroke:#2563EB,stroke-width:1.4px,color:#0F172A;
  classDef awsdynamo fill:#E0E7FF,stroke:#4F46E5,stroke-width:1.4px,color:#1E1B4B;
  classDef budget fill:#FEF3C7,stroke:#D97706,stroke-width:1.8px,color:#7C2D12;
  classDef stream fill:#F3E8FF,stroke:#7E22CE,stroke-width:1.6px,color:#3B0764;
  classDef security fill:#E0F2FE,stroke:#0284C7,stroke-width:1.4px,color:#0C4A6E;
  classDef infra fill:#F8FAFC,stroke:#64748B,stroke-width:1.3px,color:#0F172A;
  classDef artifact fill:#F1F5F9,stroke:#475569,stroke-width:1.3px,color:#0F172A;
  classDef runtime fill:#DCFCE7,stroke:#16A34A,stroke-width:1.6px,color:#14532D;
  classDef bus fill:#CCFBF1,stroke:#0F766E,stroke-width:1.4px,color:#134E4A;
  classDef datastore fill:#FFE4E6,stroke:#E11D48,stroke-width:1.5px,color:#881337;
  classDef observability fill:#FFEDD5,stroke:#EA580C,stroke-width:1.4px,color:#7C2D12;
  classDef statewire fill:#E2E8F0,stroke:#475569,stroke-width:1.2px,color:#0F172A,stroke-dasharray: 3 3;

