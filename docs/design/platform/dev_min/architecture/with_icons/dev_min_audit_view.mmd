%%{init: {
  "theme": "base",
  "themeVariables": {
    "fontFamily": "Inter, Segoe UI, Arial",
    "primaryTextColor": "#0F172A",
    "lineColor": "#334155",
    "tertiaryColor": "#F8FAFC",
    "background": "#FFFFFF"
  }
}}%%
flowchart LR
  subgraph Authority["Authority Surfaces"]
    AConfig@{ icon: "simple-icons:terraform", form: "rounded", label: "Terraform roots", pos: "b", h: 54 }
    AState@{ icon: "simple-icons:amazons3", form: "rounded", label: "Terraform state bucket", pos: "b", h: 54 }
    ALock@{ icon: "simple-icons:amazondynamodb", form: "rounded", label: "Terraform lock table", pos: "b", h: 54 }
  end

  subgraph Truth["Runtime Truth Surfaces"]
    TRds@{ icon: "simple-icons:postgresql", form: "rounded", label: "RDS runtime state", pos: "b", h: 54 }
    TAdm@{ icon: "simple-icons:amazondynamodb", form: "rounded", label: "DynamoDB admission", pos: "b", h: 54 }
    TPub@{ icon: "simple-icons:amazondynamodb", form: "rounded", label: "DynamoDB publish", pos: "b", h: 54 }
    TRun@{ icon: "simple-icons:amazondynamodb", form: "rounded", label: "DynamoDB run control", pos: "b", h: 54 }
    TEv@{ icon: "simple-icons:amazons3", form: "rounded", label: "S3 evidence bundle", pos: "b", h: 54 }
    TObject@{ icon: "simple-icons:amazons3", form: "rounded", label: "S3 object-store outputs", pos: "b", h: 54 }
    TQu@{ icon: "simple-icons:amazons3", form: "rounded", label: "S3 quarantine artifacts", pos: "b", h: 54 }
    TAr@{ icon: "simple-icons:amazons3", form: "rounded", label: "S3 archive artifacts", pos: "b", h: 54 }
  end

  subgraph Transport["Transport Surfaces (Not Source of Truth)"]
    Tkafka@{ icon: "simple-icons:apachekafka", form: "rounded", label: "Confluent Kafka topics", pos: "b", h: 54 }
    Tkin@{ icon: "mdi:waves", form: "rounded", label: "Kinesis control bus", pos: "b", h: 54 }
    Tssm@{ icon: "mdi:key", form: "rounded", label: "SSM runtime credentials", pos: "b", h: 54 }
  end

  subgraph Gates["Fail-Closed Certification Gates"]
    GReady@{ icon: "mdi:shield-check", form: "rounded", label: "Readiness gate", pos: "b", h: 54 }
    GIntegrity@{ icon: "mdi:scale-balance", form: "rounded", label: "Closure integrity gate", pos: "b", h: 54 }
    GCert@{ icon: "mdi:clipboard-check", form: "rounded", label: "Certification matrix gate", pos: "b", h: 54 }
    GOutcome@{ icon: "mdi:flag-checkered", form: "rounded", label: "Outcome (advance if blockers empty)", pos: "b", h: 54 }
  end

  AConfig --> AState --> ALock
  Tssm -.-> Tkafka
  Tssm -.-> TRds
  Tkafka --> GReady
  Tkin --> GReady
  TEv --> GIntegrity
  TObject --> GIntegrity
  TQu --> GIntegrity
  TRun --> GIntegrity
  TRds --> GCert
  TAdm --> GCert
  TPub --> GCert
  TEv --> GCert
  GReady --> GCert
  GIntegrity --> GCert
  GCert --> GOutcome
  GOutcome -.-> TEv

  style Authority fill:#EFF6FF,stroke:#2563EB,stroke-width:2px
  style Truth fill:#ECFDF5,stroke:#10B981,stroke-width:2px
  style Transport fill:#F5F3FF,stroke:#7C3AED,stroke-width:2px
  style Gates fill:#FFF7ED,stroke:#EA580C,stroke-width:2px

  class AConfig,AState,ALock authority
  class TRds,TAdm,TPub,TRun,TEv,TObject,TQu,TAr truth
  class Tkafka,Tkin,Tssm transport
  class GReady,GIntegrity,GCert gate
  class GOutcome outcome

  classDef authority fill:#DBEAFE,stroke:#2563EB,stroke-width:1.4px,color:#1E3A8A;
  classDef truth fill:#DCFCE7,stroke:#16A34A,stroke-width:1.4px,color:#14532D;
  classDef transport fill:#EDE9FE,stroke:#7C3AED,stroke-width:1.4px,color:#4C1D95;
  classDef gate fill:#FFEDD5,stroke:#EA580C,stroke-width:1.8px,color:#7C2D12;
  classDef outcome fill:#FEE2E2,stroke:#DC2626,stroke-width:2px,color:#7F1D1D;
