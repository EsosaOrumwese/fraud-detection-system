digraph DevFullTerraformInfraV0 {
  graph [
    label="Dev Full Terraform Infrastructure (Stack Topology + Key Resources)",
    labelloc=t,
    fontsize=18,
    fontname="Helvetica",
    rankdir=LR,
    splines=true,
    pad=0.2,
    nodesep=0.35,
    ranksep=0.75
  ];

  node [
    shape=box,
    style="rounded,filled",
    fillcolor="#F8FAFC",
    color="#334155",
    fontname="Helvetica",
    fontsize=10,
    margin="0.08,0.06"
  ];

  edge [
    color="#334155",
    fontname="Helvetica",
    fontsize=9,
    arrowsize=0.8
  ];

  gha [label="GitHub Actions / Operator CLI\nterraform init/plan/apply by stack", fillcolor="#EEF2FF"];

  subgraph cluster_core {
    label="Stack: dev_full/core";
    color="#C7D2FE";
    style="rounded";

    core_net [label="Network baseline\nVPC, public/private subnets,\nroute tables + associations, IGW", shape=cylinder, fillcolor="#ECFEFF"];
    core_sg [label="MSK client security group", fillcolor="#E0E7FF"];
    core_kms [label="KMS key + alias\nplatform encryption root", fillcolor="#E0E7FF"];
    core_s3 [label="S3 buckets\nobject_store, evidence, artifacts", shape=cylinder, fillcolor="#ECFEFF"];
    core_iam [label="IAM baseline\nEKS nodegroup + runtime base roles", fillcolor="#E0E7FF"];
    core_state [label="state key\ndev_full/core/terraform.tfstate", shape=folder, fillcolor="#F1F5F9"];
  }

  subgraph cluster_streaming {
    label="Stack: dev_full/streaming";
    color="#A7F3D0";
    style="rounded";

    stream_msk [label="MSK Serverless cluster\nSASL IAM posture", shape=cylinder, fillcolor="#D1FAE5"];
    stream_glue [label="Glue registry + anchor schema\ncompatibility mode", shape=cylinder, fillcolor="#D1FAE5"];
    stream_ssm [label="SSM parameter\nMSK bootstrap brokers", shape=cylinder, fillcolor="#ECFEFF"];
    stream_state [label="state key\ndev_full/streaming/terraform.tfstate", shape=folder, fillcolor="#F1F5F9"];
  }

  subgraph cluster_runtime {
    label="Stack: dev_full/runtime";
    color="#FDE68A";
    style="rounded";

    rt_edge [label="IG edge plane\nAPI Gateway v2 + Lambda +\nDynamoDB idempotency + SQS DLQ", shape=cylinder, fillcolor="#FEF9C3"];
    rt_sfn [label="Step Functions\nplatform_run_orchestrator", fillcolor="#FEF3C7"];
    rt_eks [label="EKS runtime plane\ncluster + m6f node group\nOIDC + IRSA roles", shape=cylinder, fillcolor="#FEF9C3"];
    rt_ep [label="Private subnet endpoints\nec2, ecr.api, ecr.dkr, sts + s3 gateway", fillcolor="#FEF3C7"];
    rt_iam [label="Runtime IAM roles\nflink, lambda_ig, apigw_invoke,\nddb_rw, step_functions", fillcolor="#FEF3C7"];
    rt_ssm [label="SSM parameter\nig_api_key", shape=cylinder, fillcolor="#ECFEFF"];
    rt_state [label="state key\ndev_full/runtime/terraform.tfstate", shape=folder, fillcolor="#F1F5F9"];
  }

  subgraph cluster_data_ml {
    label="Stack: dev_full/data_ml";
    color="#C4B5FD";
    style="rounded";

    dml_roles [label="IAM roles\nsagemaker_execution,\ndatabricks_cross_account_access", fillcolor="#EDE9FE"];
    dml_ssm [label="SSM parameters\ndatabricks URL/token,\nmlflow URI, sagemaker role arn", shape=cylinder, fillcolor="#ECFEFF"];
    dml_state [label="state key\ndev_full/data_ml/terraform.tfstate", shape=folder, fillcolor="#F1F5F9"];
  }

  subgraph cluster_ops {
    label="Stack: dev_full/ops";
    color="#93C5FD";
    style="rounded";

    ops_role [label="IAM role\nmwaa_execution", fillcolor="#DBEAFE"];
    ops_ssm [label="SSM parameters\nmwaa webserver, aurora endpoints/creds,\nredis endpoint", shape=cylinder, fillcolor="#ECFEFF"];
    ops_cw [label="CloudWatch log group\nruntime_bootstrap", shape=cylinder, fillcolor="#ECFEFF"];
    ops_gha [label="GitHub Actions remote policy\ngithub_actions_m6f_remote", fillcolor="#DBEAFE"];
    ops_state [label="state key\ndev_full/ops/terraform.tfstate", shape=folder, fillcolor="#F1F5F9"];
  }

  gha -> core_net [label="apply core"];
  gha -> stream_msk [label="apply streaming"];
  gha -> rt_edge [label="apply runtime"];
  gha -> dml_roles [label="apply data_ml"];
  gha -> ops_role [label="apply ops"];

  core_net -> core_sg;
  core_net -> core_kms;
  core_net -> core_s3;
  core_net -> core_iam;
  core_net -> core_state [style=dashed, label="writes state"];

  stream_msk -> stream_glue;
  stream_msk -> stream_ssm [label="bootstrap output"];
  stream_msk -> stream_state [style=dashed, label="writes state"];

  rt_edge -> rt_sfn;
  rt_edge -> rt_eks;
  rt_edge -> rt_ep;
  rt_edge -> rt_iam;
  rt_edge -> rt_ssm;
  rt_edge -> rt_state [style=dashed, label="writes state"];

  dml_roles -> dml_ssm;
  dml_roles -> dml_state [style=dashed, label="writes state"];

  ops_role -> ops_ssm;
  ops_role -> ops_cw;
  ops_role -> ops_gha;
  ops_role -> ops_state [style=dashed, label="writes state"];

  core_state -> stream_msk [style=dashed, label="remote_state input\nsubnets + msk SG"];
  core_state -> rt_edge [style=dashed, label="remote_state input\nvpc/subnets/s3/iam base"];
  stream_state -> rt_edge [style=dashed, label="remote_state input\nMSK handles + bootstrap"];

  core_s3 -> stream_ssm [style=dashed, label="handle distribution plane"];
  core_s3 -> rt_edge [style=dashed, label="object/evidence surfaces"];
  core_kms -> rt_edge [style=dashed, label="encryption context"];
  core_iam -> rt_eks [style=dashed, label="node/runtime role baseline"];

  stream_msk -> rt_eks [style=dashed, label="runtime stream substrate"];
  stream_glue -> rt_sfn [style=dashed, label="schema authority context"];

  ops_ssm -> rt_edge [style=dashed, label="ops/runtime handle consumers"];
  dml_ssm -> rt_sfn [style=dashed, label="learning handle surfaces"];
}
