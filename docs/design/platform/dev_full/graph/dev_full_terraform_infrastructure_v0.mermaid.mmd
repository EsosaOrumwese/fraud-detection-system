%%{init: {'securityLevel':'loose','flowchart':{'htmlLabels':true,'curve':'basis'}}}%%
%% Dev Full Terraform Infrastructure (Icon Label Variant)
flowchart LR

  GHA["<img src='../../assets/icons/tools/github_actions.svg' width='20'/><br/><b>GitHub Actions / Operator CLI</b><br/>terraform init, plan, apply by stack"]

  subgraph CORE[Stack: dev_full/core]
    CORE_NET["<img src='../../assets/icons/aws/vpc.svg' width='20'/><br/><b>Network Baseline</b><br/>VPC, public/private subnets, route tables, IGW"]
    CORE_SG["<img src='../../assets/icons/aws/iam.svg' width='20'/><br/><b>MSK Client Security Group</b>"]
    CORE_KMS["<img src='../../assets/icons/aws/kms.svg' width='20'/><br/><b>KMS Key + Alias</b><br/>platform encryption root"]
    CORE_S3["<img src='../../assets/icons/aws/s3.svg' width='20'/><br/><b>S3 Buckets</b><br/>object_store, evidence, artifacts"]
    CORE_IAM["<img src='../../assets/icons/aws/iam.svg' width='20'/><br/><b>IAM Baseline</b><br/>EKS nodegroup + runtime base roles"]
    CORE_STATE["<img src='../../assets/icons/tools/tfstate.svg' width='20'/><br/><b>State Key</b><br/>dev_full/core/terraform.tfstate"]
  end

  subgraph STREAMING[Stack: dev_full/streaming]
    STREAM_MSK["<img src='../../assets/icons/aws/msk.svg' width='20'/><br/><b>MSK Serverless</b><br/>SASL IAM posture"]
    STREAM_GLUE["<img src='../../assets/icons/aws/glue.svg' width='20'/><br/><b>Glue Registry</b><br/>anchor schema + compatibility mode"]
    STREAM_SSM["<img src='../../assets/icons/aws/ssm.svg' width='20'/><br/><b>SSM Parameter</b><br/>MSK bootstrap brokers"]
    STREAM_STATE["<img src='../../assets/icons/tools/tfstate.svg' width='20'/><br/><b>State Key</b><br/>dev_full/streaming/terraform.tfstate"]
  end

  subgraph RUNTIME[Stack: dev_full/runtime]
    RT_EDGE["<img src='../../assets/icons/aws/apigateway.svg' width='20'/><br/><b>IG Edge Plane</b><br/>API Gateway + Lambda + DynamoDB idempotency + SQS DLQ"]
    RT_SFN["<img src='../../assets/icons/aws/stepfunctions.svg' width='20'/><br/><b>Step Functions</b><br/>platform_run_orchestrator"]
    RT_EKS["<img src='../../assets/icons/aws/eks.svg' width='20'/><br/><b>EKS Runtime Plane</b><br/>cluster + m6f node group + OIDC/IRSA"]
    RT_EP["<img src='../../assets/icons/aws/vpc.svg' width='20'/><br/><b>Private Endpoints</b><br/>ec2, ecr.api, ecr.dkr, sts, s3 gateway"]
    RT_IAM["<img src='../../assets/icons/aws/iam.svg' width='20'/><br/><b>Runtime IAM Roles</b><br/>flink, lambda_ig, apigw_invoke, ddb_rw, step_functions"]
    RT_SSM["<img src='../../assets/icons/aws/ssm.svg' width='20'/><br/><b>SSM Parameter</b><br/>ig_api_key"]
    RT_STATE["<img src='../../assets/icons/tools/tfstate.svg' width='20'/><br/><b>State Key</b><br/>dev_full/runtime/terraform.tfstate"]
  end

  subgraph DATAML[Stack: dev_full/data_ml]
    DML_ROLES["<img src='../../assets/icons/aws/sagemaker.svg' width='20'/><br/><b>Data/ML IAM Roles</b><br/>sagemaker_execution + databricks_cross_account_access"]
    DML_SSM["<img src='../../assets/icons/aws/ssm.svg' width='20'/><br/><b>SSM Parameters</b><br/>databricks URL/token, mlflow URI, sagemaker role arn"]
    DML_STATE["<img src='../../assets/icons/tools/tfstate.svg' width='20'/><br/><b>State Key</b><br/>dev_full/data_ml/terraform.tfstate"]
  end

  subgraph OPS[Stack: dev_full/ops]
    OPS_ROLE["<img src='../../assets/icons/aws/mwaa.svg' width='20'/><br/><b>IAM Role</b><br/>mwaa_execution"]
    OPS_SSM["<img src='../../assets/icons/aws/ssm.svg' width='20'/><br/><b>SSM Parameters</b><br/>mwaa webserver, aurora endpoints/creds, redis endpoint"]
    OPS_CW["<img src='../../assets/icons/aws/cloudwatch.svg' width='20'/><br/><b>CloudWatch Log Group</b><br/>runtime_bootstrap"]
    OPS_GHA["<img src='../../assets/icons/tools/github_actions.svg' width='20'/><br/><b>GitHub Actions Remote Policy</b><br/>github_actions_m6f_remote"]
    OPS_STATE["<img src='../../assets/icons/tools/tfstate.svg' width='20'/><br/><b>State Key</b><br/>dev_full/ops/terraform.tfstate"]
  end

  GHA -->|apply core| CORE_NET
  GHA -->|apply streaming| STREAM_MSK
  GHA -->|apply runtime| RT_EDGE
  GHA -->|apply data_ml| DML_ROLES
  GHA -->|apply ops| OPS_ROLE

  CORE_NET --> CORE_SG
  CORE_NET --> CORE_KMS
  CORE_NET --> CORE_S3
  CORE_NET --> CORE_IAM
  CORE_NET -. writes state .-> CORE_STATE

  STREAM_MSK --> STREAM_GLUE
  STREAM_MSK -->|bootstrap output| STREAM_SSM
  STREAM_MSK -. writes state .-> STREAM_STATE

  RT_EDGE --> RT_SFN
  RT_EDGE --> RT_EKS
  RT_EDGE --> RT_EP
  RT_EDGE --> RT_IAM
  RT_EDGE --> RT_SSM
  RT_EDGE -. writes state .-> RT_STATE

  DML_ROLES --> DML_SSM
  DML_ROLES -. writes state .-> DML_STATE

  OPS_ROLE --> OPS_SSM
  OPS_ROLE --> OPS_CW
  OPS_ROLE --> OPS_GHA
  OPS_ROLE -. writes state .-> OPS_STATE

  CORE_STATE -. remote_state input<br/>subnets + msk SG .-> STREAM_MSK
  CORE_STATE -. remote_state input<br/>vpc/subnets/s3/iam base .-> RT_EDGE
  STREAM_STATE -. remote_state input<br/>MSK handles + bootstrap .-> RT_EDGE

  CORE_S3 -. object/evidence surfaces .-> RT_EDGE
  CORE_KMS -. encryption context .-> RT_EDGE
  CORE_IAM -. node/runtime role baseline .-> RT_EKS
  STREAM_MSK -. runtime stream substrate .-> RT_EKS
  STREAM_GLUE -. schema authority context .-> RT_SFN

  OPS_SSM -. ops/runtime handle consumers .-> RT_EDGE
  DML_SSM -. learning handle surfaces .-> RT_SFN
