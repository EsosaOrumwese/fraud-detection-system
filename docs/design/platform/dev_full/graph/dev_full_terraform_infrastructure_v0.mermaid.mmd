%% Dev Full Terraform Infrastructure (Stack Topology + Key Resources + Handle Surfaces)
flowchart LR

  GHA[GitHub Actions / Operator CLI<br/>terraform init plan apply by stack]

  subgraph CORE[Stack dev_full/core]
    CORE_NET[(Network baseline<br/>VPC public/private subnets route tables IGW)]
    CORE_SG[MSK client security group]
    CORE_KMS[KMS key + alias<br/>platform encryption root]
    CORE_S3[(S3 buckets<br/>object_store evidence artifacts)]
    CORE_IAM[IAM baseline<br/>EKS nodegroup + runtime base roles]
    CORE_STATE[[state key<br/>dev_full/core/terraform.tfstate]]
  end

  subgraph STREAMING[Stack dev_full/streaming]
    STREAM_MSK[(MSK Serverless cluster<br/>SASL IAM posture)]
    STREAM_GLUE[(Glue registry + anchor schema<br/>compatibility mode)]
    STREAM_SSM[(SSM parameter<br/>MSK bootstrap brokers)]
    STREAM_STATE[[state key<br/>dev_full/streaming/terraform.tfstate]]
  end

  subgraph RUNTIME[Stack dev_full/runtime]
    RT_EDGE[(IG edge plane<br/>API Gateway v2 + Lambda +<br/>DynamoDB idempotency + SQS DLQ)]
    RT_SFN[Step Functions<br/>platform_run_orchestrator]
    RT_EKS[(EKS runtime plane<br/>cluster + m6f node group<br/>OIDC + IRSA roles)]
    RT_EP[Private subnet endpoints<br/>ec2 ecr.api ecr.dkr sts + s3 gateway]
    RT_IAM[Runtime IAM roles<br/>flink lambda_ig apigw_invoke ddb_rw step_functions]
    RT_SSM[(SSM parameter<br/>ig_api_key)]
    RT_STATE[[state key<br/>dev_full/runtime/terraform.tfstate]]
  end

  subgraph DATAML[Stack dev_full/data_ml]
    DML_ROLES[IAM roles<br/>sagemaker_execution<br/>databricks_cross_account_access]
    DML_SSM[(SSM parameters<br/>databricks URL/token<br/>mlflow URI sagemaker role arn)]
    DML_NOTE[[Handle surface only<br/>no direct Databricks jobs/workspace<br/>or SageMaker pipeline/endpoint provisioning]]
    DML_STATE[[state key<br/>dev_full/data_ml/terraform.tfstate]]
  end

  subgraph OPS[Stack dev_full/ops]
    OPS_ROLE[IAM role<br/>mwaa_execution]
    OPS_SSM[(SSM parameters<br/>mwaa webserver aurora endpoints/creds redis endpoint)]
    OPS_CW[(CloudWatch log group<br/>runtime_bootstrap)]
    OPS_GHA[GitHub Actions remote policy bridge<br/>github_actions_m6f_remote<br/>covers M6 + M10 + M11 + M12 lanes]
    OPS_NOTE[[Handle surface only<br/>no direct MWAA env, Aurora cluster,<br/>or Redis cluster provisioning]]
    OPS_STATE[[state key<br/>dev_full/ops/terraform.tfstate]]
  end

  GHA -->|apply core| CORE_NET
  GHA -->|apply streaming| STREAM_MSK
  GHA -->|apply runtime| RT_EDGE
  GHA -->|apply data_ml| DML_ROLES
  GHA -->|apply ops| OPS_ROLE

  CORE_NET --> CORE_SG
  CORE_NET --> CORE_KMS
  CORE_NET --> CORE_S3
  CORE_NET --> CORE_IAM
  CORE_NET -. writes state .-> CORE_STATE

  STREAM_MSK --> STREAM_GLUE
  STREAM_MSK -->|bootstrap output| STREAM_SSM
  STREAM_MSK -. writes state .-> STREAM_STATE

  RT_EDGE --> RT_SFN
  RT_EDGE --> RT_EKS
  RT_EDGE --> RT_EP
  RT_EDGE --> RT_IAM
  RT_EDGE --> RT_SSM
  RT_EDGE -. writes state .-> RT_STATE

  DML_ROLES --> DML_SSM
  DML_ROLES --> DML_NOTE
  DML_ROLES -. writes state .-> DML_STATE

  OPS_ROLE --> OPS_SSM
  OPS_ROLE --> OPS_CW
  OPS_ROLE --> OPS_GHA
  OPS_ROLE --> OPS_NOTE
  OPS_ROLE -. writes state .-> OPS_STATE

  CORE_STATE -. remote_state input<br/>subnets + msk SG .-> STREAM_MSK
  CORE_STATE -. remote_state input<br/>vpc/subnets/s3/iam base .-> RT_EDGE
  STREAM_STATE -. remote_state input<br/>MSK handles + bootstrap .-> RT_EDGE

  CORE_S3 -. object/evidence surfaces .-> RT_EDGE
  CORE_KMS -. encryption context .-> RT_EDGE
  CORE_IAM -. node/runtime role baseline .-> RT_EKS
  STREAM_MSK -. runtime stream substrate .-> RT_EKS
  STREAM_GLUE -. logical schema-contract context<br/>(not direct terraform reference) .-> RT_SFN

  OPS_SSM -. ops/runtime handle consumers .-> RT_EDGE
  DML_SSM -. logical learning-handle context<br/>(not direct terraform reference) .-> RT_SFN
