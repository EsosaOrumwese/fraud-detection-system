# Logbook
### Date: 14th August 2025
### Project: Fraud Detection System
### Issues Resolved: [SD-02](https://github.com/EsosaOrumwese/fraud-detection-system/issues/25) `in-progress`
### Reference commits: Check commits on this date (if any)

* 7:20am
  * Add an explicit derivation step for merchant currency
  * Clarified two friction points regarding policy on retry-exhaustion and K vs. candidate size M 
    * (i) what happens after 64 rejections in ZTP, and 
    * (ii) what if $K$ exceeds the number of available foreign candidates $M$. 

* 8:01am
  * Make currency->country expansion pipeline fully explicit
    - Replaced S5.2–S5.3 with tightened definitions of α=0.5, T=30, destination-level vs. global sparsity.
    - Explicit guard: require w_i > 0; abort on violation.
    - Detailed renormalisation policy: binary64 serial summation over ISO-sorted indices; tolerance 1e-12.
    - Clarified smoothing vs. raw vs. equal-split fallback conditions; preserved schema compatibility.
    - Added note in S5.4 that no schema changes are required; persistence maps to existing ccy_country_weights_cache and sparse_flag tables.

* 8:21am
  * Make Gumbel-top-k selection numerically explicit

* 10:15am
  * Dirichlet allocation overhaul: α-lookup ladder, symmetric fallback, Gumbel-order tie-break
    - Implemented governed α-vector lookup with fallback ladder:
      (home, MCC, channel, m) → (home, channel, m) → (home, m) → symmetric α=τ/m.
    - Enforced min α ≥ 1e−6; record resolved key and fallback usage in validation bundle.
    - Dirichlet sampling via Marsaglia–Tsang gamma (Batch-1 spec); single dirichlet_gamma_vector event per merchant when |C|>1.
    - Integerisation via largest-remainder rounding with residual quantisation to 8 dp.
    - Tie-break sequence updated: residual↓ → country_set.rank↑ → ISO↑.
    - Persist quantised residuals and ranks to ranking_residual_cache_1A; verified |n_i−a_i| ≤ 1 and Σ n_i = N.

* 12:17pm
  * Eliminate any ambiguity about per-site vs per-(m,c) emission. Make it **normative** that there is exactly **one** `sequence_finalize` event for each $(m,c)$ with $n_{m,c}>0$. Current S8 describes the concept but add a hard cardinality line + a validator equality.

* 2:10pm
  * tighten egress constraints for final_country_outlet_count and site_order
    - schemas.1A.yaml#/egress/outlet_catalogue:
      * Change final_country_outlet_count domain from ≥0 to [1..999999]
        to reflect only materialized (n>0) blocks and 6-digit site_id space.
    - S8 “Inputs → Outputs” and “Selected columns” prose:
      * Update constraint for final_country_outlet_count to [1..999999].
    - S8.3 Constraints & keys:
      * Amend domain constraints: final_country_outlet_count ∈ {1,…,999999};
        site_order ≥ 1; raw_nb_outlet_draw ≥ 1; regex for site_id unchanged.
      * Add cross-field constraint: for every (m,c), all rows satisfy
        1 ≤ site_order ≤ final_country_outlet_count.
    - Verified consistency with overflow guard (U=999,999) and S9 permutation check.
    - No schema authority violations; no impact on historical valid egress.

* 2:39:
  * Align residuals cache dataset path with dataset id
    - Artefact registry: `ranking_residual_cache_1A`
      * path -> `data/layer1/1A/ranking_residual_cache_1A/seed={seed}/parameter_hash={parameter_hash}/`
      * schema_ref remains `schemas.1A.yaml#/alloc/ranking_residual_cache` (canonical node)
    - Data dictionary: `ranking_residual_cache_1A`
      * path updated to match id; partitioning unchanged (seed, parameter_hash)
    No schema changes; doc references already consistent.
  * Add sparse-lineage linkage validation for equal-split `gumbel_key` weights
    - Introduced explicit validator in S9.4(7) enforcing that when `sparse_flag(κ_m)=true`,
      all `gumbel_key.weight` values for merchant m’s foreign candidates are equal to $1/M_m$
      within 1e-12, where M_m is the count of foreign candidates in S6’s Gumbel-Top-K.
    - Bound check is absolute; violation results in hard validation failure.
    - No schema or dataset dictionary changes; uses existing `sparse_flag` and `gumbel_key` streams.

