# Logbook
### Date: 14th August 2025
### Project: Fraud Detection System
### Issues Resolved: [SD-02](https://github.com/EsosaOrumwese/fraud-detection-system/issues/25) `in-progress`
### Reference commits: Check commits on this date (if any)

* 7:20am
  * Add an explicit derivation step for merchant currency
  * Clarified two friction points regarding policy on retry-exhaustion and K vs. candidate size M 
    * (i) what happens after 64 rejections in ZTP, and 
    * (ii) what if $K$ exceeds the number of available foreign candidates $M$. 

* 8:01am
  * Make currency->country expansion pipeline fully explicit
    - Replaced S5.2–S5.3 with tightened definitions of α=0.5, T=30, destination-level vs. global sparsity.
    - Explicit guard: require w_i > 0; abort on violation.
    - Detailed renormalisation policy: binary64 serial summation over ISO-sorted indices; tolerance 1e-12.
    - Clarified smoothing vs. raw vs. equal-split fallback conditions; preserved schema compatibility.
    - Added note in S5.4 that no schema changes are required; persistence maps to existing ccy_country_weights_cache and sparse_flag tables.

* 8:21am
  * Make Gumbel-top-k selection numerically explicit

* 10:15am
  * Dirichlet allocation overhaul: α-lookup ladder, symmetric fallback, Gumbel-order tie-break
    - Implemented governed α-vector lookup with fallback ladder:
      (home, MCC, channel, m) → (home, channel, m) → (home, m) → symmetric α=τ/m.
    - Enforced min α ≥ 1e−6; record resolved key and fallback usage in validation bundle.
    - Dirichlet sampling via Marsaglia–Tsang gamma (Batch-1 spec); single dirichlet_gamma_vector event per merchant when |C|>1.
    - Integerisation via largest-remainder rounding with residual quantisation to 8 dp.
    - Tie-break sequence updated: residual↓ → country_set.rank↑ → ISO↑.
    - Persist quantised residuals and ranks to ranking_residual_cache_1A; verified |n_i−a_i| ≤ 1 and Σ n_i = N.

* 12:17pm
  * Eliminate any ambiguity about per-site vs per-(m,c) emission. Make it **normative** that there is exactly **one** `sequence_finalize` event for each $(m,c)$ with $n_{m,c}>0$. Current S8 describes the concept but add a hard cardinality line + a validator equality.

* 2:10pm
  * tighten egress constraints for final_country_outlet_count and site_order
    - schemas.1A.yaml#/egress/outlet_catalogue:
      * Change final_country_outlet_count domain from ≥0 to [1..999999]
        to reflect only materialized (n>0) blocks and 6-digit site_id space.
    - S8 “Inputs → Outputs” and “Selected columns” prose:
      * Update constraint for final_country_outlet_count to [1..999999].
    - S8.3 Constraints & keys:
      * Amend domain constraints: final_country_outlet_count ∈ {1,…,999999};
        site_order ≥ 1; raw_nb_outlet_draw ≥ 1; regex for site_id unchanged.
      * Add cross-field constraint: for every (m,c), all rows satisfy
        1 ≤ site_order ≤ final_country_outlet_count.
    - Verified consistency with overflow guard (U=999,999) and S9 permutation check.
    - No schema authority violations; no impact on historical valid egress.

* 2:39:
  * Align residuals cache dataset path with dataset id
    - Artefact registry: `ranking_residual_cache_1A`
      * path -> `data/layer1/1A/ranking_residual_cache_1A/seed={seed}/parameter_hash={parameter_hash}/`
      * schema_ref remains `schemas.1A.yaml#/alloc/ranking_residual_cache` (canonical node)
    - Data dictionary: `ranking_residual_cache_1A`
      * path updated to match id; partitioning unchanged (seed, parameter_hash)
    No schema changes; doc references already consistent.
  * Add sparse-lineage linkage validation for equal-split `gumbel_key` weights
    - Introduced explicit validator in S9.4(7) enforcing that when `sparse_flag(κ_m)=true`,
      all `gumbel_key.weight` values for merchant m’s foreign candidates are equal to $1/M_m$
      within 1e-12, where M_m is the count of foreign candidates in S6’s Gumbel-Top-K.
    - Bound check is absolute; violation results in hard validation failure.
    - No schema or dataset dictionary changes; uses existing `sparse_flag` and `gumbel_key` streams.

* 3:00pm
  * Strengthen country-set coverage check with explicit home, contiguous foreign ranks, and Gumbel-order match
    - Replaced tautological “coverage” check with explicit three-part invariant:
      1. Exactly one home row (`is_home=true`, `rank=0`) matching `home_country_iso` in all egress rows.
      2. Foreign ranks contiguous 1..K with no gaps/duplicates.
      3. Foreign countries match Top-K by `gumbel_key.key` (ISO tie-break) and appear in rank order.
    - No schema or registry changes; doc update only.
    - Closes N14 by enforcing full coverage/order contract in validation phase.
  * Batch 4.1 — Enforce cryptographic hand-off gate from 1A to 1B
    * S9.9 (state-flow doc): Expanded “Hand-off to 1B” into a mandatory preflight procedure:
      – Verify `manifest_fingerprint` in any `outlet_catalogue` row matches the partition fingerprint.
      – Assert both `validation_bundle_1A` and `_passed.flag` exist for that fingerprint.
      – Confirm `_passed.flag` content hash == SHA256(`validation_bundle_1A`).
      – Only proceed to read egress if checks pass; join `country_set.rank` for inter-country order.
    * Artefact registry: Added consumption-gate note to `outlet_catalogue` and `validation_bundle_1A` entries:
      “1B MUST verify `_passed.flag` digest == SHA256(`validation_bundle_1A`) for same fingerprint before reading.”
    * Data dictionary (`outlet_catalogue`): Retained existing schema; appended gate requirement to description instead of introducing new keys, preserving dictionary field consistency.
    Outcome: 1B consumers are now explicitly and cryptographically gated, preventing reads of unvalidated egress.   

* 3:42pm
  * 1A S9 validator — enforce full RNG event coverage & bundle accounting (close 4.2)
    - Extended S9.4 with explicit per-merchant RNG stream presence/uniqueness
      requirements for S1–S8, covering hurdle, NB, eligibility gate, ZTP,
      Gumbel-top-K, largest-remainder, and sequence finalisation events.
    - Specified that violations are hard fails: bundle still written but
      `_passed.flag` withheld.
    - Clarified in S9.7 that `rng_accounting.json` inside validation_bundle_1A
      is authoritative for event coverage and replay spot-checks.
    - Added artefact registry note for validation_bundle_1A declaring that the
      bundle includes `rng_accounting.json` coverage table.
    - No schema or dictionary changes; coverage data is generated from existing
      RNG audit/event logs.



