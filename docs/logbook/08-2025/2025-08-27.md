# Logbook
### Date: 27th August 2025
### Project: Fraud Detection System
### Issues Resolved: [SD-02](https://github.com/EsosaOrumwese/fraud-detection-system/issues/25) `in-progress`
### Reference commits: Check commits on this date (if any)

* 3:06am
  * S1: align envelope budget with S0; finalize B11–B15
    - Restore S0-required envelope fields `blocks` (int) and `draws` (JSON base-10 uint128).
    - State and enforce equalities: `u128(after)-u128(before) == blocks == parse_u128(draws) == trace_draws == draws_expected`.
    - Keep single-budget primitive `d_m` for math; for hurdle, `blocks = d_m ∈ {0,1}`.
    - Validator V5 updated to check `delta==blocks` and reconcile envelope/trace.
    - Error payloads: rename `draws_observed` → `trace_draws`.
    - No change to downstream semantics; no optional stream_jump in normative text.

* 3:51am
  * S1: finalize C16–C19 — logistic math and numeric policy
    * C16 (codomain/emission): Keep logistic map sigma\:R->(0,1) in math; add Emission contract for binary64 two-branch evaluation with emitted pi in \[0,1]. Define deterministic := (pi == 0.0 || pi == 1.0) using exact binary64 comparison. When deterministic, emit u\:null; otherwise require 0\<u<1.
    * C17 (precision/serialization): Pin pi (and eta if present) to JSON numbers that round-trip to binary64 (shortest round-trippable decimal, <=17 significant digits; scientific notation allowed). Enforce 0.0 <= pi <= 1.0 and annotate the payload pi field accordingly.
    * C18 (no clipping in compute/emit): Explicitly forbid clamping or clipping of eta or pi during compute or emission; move any display-only clipping to a non-normative UI note (must not alter emitted values).
    * C19 (shape and encoders, self-contained): Add “Feature vector construction (logistic, normative)”: fixed order \[intercept] + onehot(MCC) + onehot(channel) + onehot(GDP\_bucket); channel labels/order \[CP, CNP]; GDP buckets/order \[1,2,3,4,5]; MCC column order equals the order of mcc: coefficients in hurdle\_coefficients.yaml. Enforce |x| = |beta| = 1 + C\_mcc + 2 + 5 and one-hot sum == 1. Update V4 to reference this subsection and re-assert bounds.

* 6:29am
  * Currently on issue set D out of A to M. Plan to finish all today

* 6:02pm
  * Still working on ironing out errors in `state.1A.s1.expanded.md` and aligning it to the flow from state-0
    * Decided to change my approach of fixing the whole doc issue by issue (I have 66 issues!)
    * Instead, I have now outlined all the issues, gotten their proposed resolutions and will pass the doc section by section for an error free rewrite.

* 6:39pm
  * Rewrote S1.1 of state.1A.s1.expanded.md with S0-anchored contracts; fix RNG envelope & inputs
    * Rewrote **S1.1 — Inputs, Preconditions, and Write Targets** to remove ambiguity
      and align strictly with **State-0** by **explicitly citing S0-owned rules**
      (timestamp policy, keyed-substream PRNG, id64 mapping, numeric profile).
    * Clarified **design vector**: column order frozen by S0.5; S1 no longer derives
      MCC order from YAML map iteration; reiterated shape invariant |x| = 1+Cmcc+2+5.
    * Clarified **β loading**: atomic load; enforced exact shape alignment to x.
    * Locked **order-invariant RNG model**: **no cross-label counter chaining**;
      each label derives its base counter solely via S0’s keyed-substream mapping.
    * Made the **envelope contract** explicit and complete:
      * Required fields: `ts_utc` (per S0), `module`/`substream_label` (registry),
        `seed`, `parameter_hash`, `manifest_fingerprint`, `run_id`,
        `rng_counter_before_hi/lo`, `rng_counter_after_hi/lo`, `blocks` (int),
        `draws` (u128 as decimal string).
      * Budget law: `after − before = parse_u128(draws) = blocks` (unit = one 64-bit uniform);
        for hurdle specifically: `blocks ∈ {0,1}`, `draws ∈ {"0","1"}`.
      * Clarified `(hi,lo)` semantics; JSON key order is non-semantic.
    * Set **preconditions** minimal and S0-consistent: shape/alignment, numeric
      environment, and presence of the **rng\_audit\_log** before first emission.
    * Bound **event stream target**: dataset id via registry; partitions are
      `{seed, parameter_hash, run_id, module, substream_label}` (no fingerprint in path);
      schema via layer anchor for `rng/events/hurdle_bernoulli`.
    * Defined **uniqueness & completeness**: exactly one hurdle event per merchant
      in a run; count equals S0 merchant universe for the partition.
    * Clarified **trace model**: cumulative per `(module, substream_label, merchant)`,
      totals equal sum of event budgets (no per-event echo).
    * Stated **forward contracts** only (logistic with fixed saturation threshold,
      RNG usage, payload discipline) and deferred downstream math/CI to their docs.

* 7:04pm
  * Finalize S1.2 probability map; pin saturation T; align math & RNG contracts with S0
    * Rewrote **S1.2 — Probability map (η → π)** in two chunks for clarity and rigor.
    * **Pinned math**:
      * Fixed-order **Neumaier** dot product for η over frozen columns.
      * Overflow-safe **two-branch logistic** with explicit binary64 **saturation threshold T=37.5** ⇒ π ∈ {0.0,1.0} only via this rule.
      * Defined **deterministic** ⇔ (π==0.0 ∨ π==1.0) (binary64 equality).
    * **RNG coupling**:
      * Handoff to S1.3 now states **uniform budget** precisely: `draws=1` iff 0<π<1, else `draws=0`.
      * Kept substreaming/order-invariance as S0-owned; S1.2 references, does not redefine.
    * **I/O rules**:
      * `pi` must **round-trip** to identical binary64 (shortest or 17-digit acceptable); consumers parse as binary64.
      * Clarified `eta` is **diagnostic-only** (non-authoritative), not a normative payload field.
    * **Validator hooks** (single source):
      * Recompute η, π bit-exact under S0 numeric profile.
      * Assert determinism equivalences and budget prediction; reconcile with hurdle trace totals.
    * **Failure semantics (operational only)**:
      * Abort on non-finite η/π or π∉\[0,1]; shape/order mismatches are S1.1 preconditions.
    * **De-scoped** CI/monitoring and downstream algorithm restatements (NB/ZTP/Dirichlet) per scope rules.
    * **Process note**: Verified against **State-0** by opening the S0 spec directly (no memory reliance).

* 8:17pm
  * Finalize S1.3 RNG substream & Bernoulli; complete envelope; align with S0 primitives
    * **Substream & keying**
      * Locked label to registry literal `"hurdle_bernoulli"`.
      * Removed ad-hoc hash/key formulas; S1 now **references S0 keyed-substream primitive** exclusively (order-invariant; no cross-label chaining).
    * **Uniforms & lane policy**
      * Clarified **single-uniform** usage: low lane only; **one counter increment ⇒ one uniform**.
      * Mapped to $U(0,1)$ via S0’s **open-interval `u01`** (never 0 or 1).
    * **Envelope & budgeting**
      * Envelope now **complete** and **normative**: `{ts_utc, run_id, seed, parameter_hash, manifest_fingerprint, module, substream_label, rng_counter_before_hi/lo, rng_counter_after_hi/lo, blocks, draws}`.
      * Pinned budgeting law: `after − before = parse_u128(draws) = blocks`; for hurdle `{blocks∈{0,1}, draws∈{"0","1"}}`.
    * **Payload semantics (S1.4 contract)**
      * `is_multi` is **boolean** only.
      * `u` is **required & nullable** (`null` iff `π∈{0,1}`); `deterministic` **derived** from `π` (not independent).
    * **Trace model**
      * Replaced per-event trace rows with a **cumulative** trace per `(module, substream_label, merchant)`; totals reconcile to event budgets.
    * **Validator hooks (single checklist)**
      * Base-counter reconstruction via S0 primitive.
      * Branch checks: `draws=0` ⇔ `π∈{0,1}` with `u=null`; `draws=1` ⇔ `0<π<1` with `u∈(0,1)` and `(u<π)==is_multi`.
      * Budget identity and partition/embedding equality.
      * Trace totals = Σ event blocks = counter delta.
    * **Failure semantics**
      * Envelope/label violations, budget identity failures, u01 range breaches, and determinism inconsistencies → abort (S0.9 classes referenced elsewhere).
    * **Style**
      * Restored the **“Bottom line”** recap to match S1.x section style.

* 8:39pm
  * Finalize S1.4 hurdle event emission; complete envelope/payload; stable partitions; cumulative trace
    - Bound hurdle RNG dataset to registry id and schema anchor; partitions are
      {seed, parameter_hash, run_id, module, substream_label} (no fingerprint in path).
    - Envelope is now complete and normative:
      ts_utc (per S0), module/substream_label (registry literals),
      rng_counter_before_hi/lo, rng_counter_after_hi/lo,
      blocks (int), draws (u128 as decimal string);
      enforced budget identity: after−before = parse_u128(draws) = blocks; hurdle {0,1}.
    - Payload is minimal & authoritative:
      merchant_id (decimal string → u64), pi (binary64 round-trip, 0≤pi≤1),
      is_multi (boolean), deterministic (derived: pi∈{0,1}),
      u (required number|null; null iff deterministic; else 0<u<1).
    - Examples: canonical, parseable JSON; include full envelope and valid dummy hex/u64.
    - Write discipline: exactly one hurdle row per merchant per run; append-only shards.
    - Trace model: cumulative per (module, substream_label, merchant); totals reconcile to
      Σ(event blocks) and counter deltas; no per-event trace rows.
    - Validator hooks: schema conformance; budget identity & replay; decision predicate;
      trace reconciliation; gating via registry filter; cardinality & uniqueness checks.
    - Failure classes (operational): schema violations, budget mismatches, gating violations,
      partition/embedding mismatches; numeric/shape faults owned by S1.1–S1.2.

* 8:49pm
  * Finalize S1.5 determinism & correctness invariants; lock validator surface
    - I-H0: Pinned S0 numeric profile & schema authority (single envelope anchor + hurdle schema).
    - I-H1: Bit-replay—order-invariant keyed substreams; counters and decisions are deterministic.
    - I-H2: Single-uniform budgeting—after−before = parse_u128(draws) = blocks; hurdle {0,1};
            trace is cumulative per (module, substream_label, merchant); no per-event trace rows.
    - I-H3: Payload discipline—minimal & authoritative; is_multi boolean; u required number|null;
            deterministic ⇔ (pi ∈ {0,1}); stochastic ⇒ 0<u<1 and (u<pi)==is_multi.
    - I-H4: Branch purity (gating)—downstream 1A RNG streams appear iff is_multi=true;
            stream set obtained via registry filter (no inline enumeration).
    - I-H5–I-H7: Uniqueness & cardinality per run; envelope completeness; partition/embedding equality;
            full order-invariance & shard safety.
    - I-H8: Cross-merchant/label independence—disjoint base counters per (label, merchant).
    - I-H9: Diagnostics non-authoritative—events prevail; caches are sanity checks only.
    - I-H10: Replay equations—exact steps for validator: recompute η,π; base counter; budget identity;
             regenerate u when draws="1"; reconcile cumulative trace.
    - Failure mappings to S0.9: envelope/accounting (F4), partition mismatch (F5),
      schema breach (F4), gating violation (coverage class, e.g., F8).

* 9:03pm
  * Finalize S1.6 failure modes; predicates, detectors, forensics, validator checklist
    - Scoped S1 failures and formalized abort predicates across Families A–F:
      - A) Design/β misuse: length/order/category guards → hard aborts.
      - B) Numeric invalids: non-finite η/π or π∉[0,1] under thresholded two-branch logistic.
      - C) Envelope/accounting: complete envelope required; budget identity
        after−before = parse_u128(draws) = blocks; hurdle {blocks∈{0,1}, draws∈{"0","1"}}.
        Trace is **cumulative** per (module, substream_label, merchant); totals must equal Σ(event blocks) and counter delta.
      - D) Payload/schema: minimal authoritative payload; is_multi **boolean**; u **number|null**;
        deterministic derived from π; branch rules enforced.
      - E) Partition/lineage: path/embed equality on {seed, parameter_hash, run_id, module, substream_label};
        path must **not** include manifest_fingerprint; wrong dataset path → abort.
      - F) Gating/coverage: downstream **1A RNG** streams appear **iff** hurdle is_multi=true
        (stream set from registry filter); duplicates and cardinality mismatches → aborts.
    - Error object (forensics): added exact JSON shape with
      {failure_code, state, module, substream_label, dataset_id, path, merchant_id,
       detail{before/after hi/lo, blocks, draws, expected_delta, trace_totals_draws},
       seed, parameter_hash, manifest_fingerprint, run_id, ts_utc}; ids serialized as decimal strings.
    - Detector table: clarified first-line detection vs validator roles; presence-based gating;
      partition lint includes module/label and “no fingerprint in path”.
    - Validator checklist: schema validation; budget identity; recompute η,π; regenerate u for stochastic rows;
      deterministic regime checks; partition lint; registry-filtered gating; uniqueness & cardinality.

* 9:37pm
  * Finalize S1.7 outputs & boundary; authoritative stream + typed handoff; no counter chaining
    - Bound the hurdle RNG dataset:
      - Dataset id: rng_event_hurdle_bernoulli; schema: #/rng/events/hurdle_bernoulli.
      - Partitions: {seed, parameter_hash, run_id, module, substream_label} (no fingerprint in path).
      - Envelope complete: ts_utc, module/substream_label, rng_counter_before/after_hi/lo, blocks, draws.
      - Budget law: after−before = parse_u128(draws) = blocks; hurdle {0,1}.
    - Payload (authoritative, minimal):
      merchant_id (decimal string → u64), pi (binary64 round-trip, 0≤pi≤1),
      is_multi (boolean), deterministic (derived: pi∈{0,1}), u (required number|null; null iff deterministic).
    - Trace model: **cumulative** per (module, substream_label, merchant); totals = Σ(event blocks) and counter delta.
    - Typed in-memory handoff tuple Xi_m:
      (is_multi:boolean, N:int, K:int, C:set[ISO-3166-1 alpha-2], C★:u128[after]).
      Crucial rule: **no cross-label counter chaining**; downstream states derive their own base
      counters via S0 keyed-substream for their labels; C★ kept for audit only.
    - Gating & visibility:
      Downstream 1A RNG streams are present **iff** is_multi=true (stream set from registry filter).
      S1 does not enumerate stream names inline.
    - Boundary invariants:
      single emit per merchant per run; cross-label RNG independence; lineage coherence
      (path keys = embedded keys); numeric consistency (pi equals S1.2 recompute).
