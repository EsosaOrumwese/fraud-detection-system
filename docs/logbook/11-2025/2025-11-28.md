# Logbook
### Date: 28th November 2025
### Project: Fraud Detection System
### Reference commits: Check commits on this date (if any)

* 4:37am
   - Cloned the governed baseline scenario calendar into a manifest-scoped path (`config/layer2/5A/scenario/calendar/fingerprint=7a09f0d8e8695beead7077abc7a1e7478586ae1396fe7be2f5c2b0f7cdd53f69/scenario=baseline/`) so S0 no longer falls back to the repo-wide placeholder when sealing scenario artefacts for the current build. Future manifests now just need their own copy (real data once available) and the fallback remains a contingency.
   - TODO: Most of the arrangements of the items in folders in my repo and during run time, just don't make sense and also appear to be all over the place. We need to fix that

* 4:52am
   - Rewired 5A scenario calendars to be staged at runtime instead of committing manifest-specific Parquet files: the dictionary/registry now point at `data/layer2/5A/scenario/calendar/...` under the run tree, S0 auto-generates the missing files by copying from the governed templates in `config/layer2/5A/scenario/calendar/fingerprint=baseline/...`, and sealing now prefers the run base path for any dataset that lives under `data/`. 
   - Added `shared/scenario_assets.py` with `ensure_scenario_calendar` and removed the previously committed fingerprint directory so the repo stays clean between manifests.

* 4:57am
   - Implemented 5A.S3 per spec (scale×shape composer): added BaselineRunner to compose S1 profiles with S2 unit-mass shapes, enforce weekly-sum invariants, and emit schema-valid `merchant_zone_baseline_local_5A` plus class-level aggregates. Orchestrator/CLI now run S3 by default (with resumability/conflict guards) and surface baseline paths in the summary. Re-ran `make segment5a` (manifest 7a09…, parameter hash e038…) end-to-end through S0–S3; outputs and reports regenerated without spec gaps.
   
* 5:58am
   - Expanded S3 to meet the state-expanded spec: gate now enforces all upstream segments are PASS via the S0 receipt, validates S1/S2 inputs against the contract paths, asserts shape-grid contiguity, and checks domain×bucket coverage (fail-fast with `S3_*` error codes on missing shapes or bad grids).
   - Baseline join uses defaulted channel fields where absent and keeps weekly-sum invariants (scale×shape); class aggregates include channel/channel_group to match the schema anchors.
   - Idempotency/conflict guard applied to baseline writes; reran `make segment5a` (S0–S3) successfully (manifest 7a09…, parameter hash e038…) after clearing stale baselines and regenerated all reports without spec gaps.
* 6:42am
   - Added governed `baseline_intensity_policy_5A` (contracts + YAML) and wired S3 to load it for scale-source and tolerance semantics; enforced upstream PASS gating, grid contiguity, and domain×bucket coverage. S3 now resolves required inputs through the sealed inventory, auto-sealing S1/S2 outputs if missing and updating the receipt digest accordingly.
   - Reran `make segment5a` (S0–S3) cleanly after clearing stale sealed_inputs/baselines; regenerated sealed digest, baseline outputs, and reports for manifest 7a09… / parameter hash e038… under the new governance.

* 7:18pm
   - Added optional UTC baseline projection in S3 (`merchant_zone_baseline_utc_5A`), introduced governed `baseline_intensity_policy_5A` (contract + YAML) and wired S3 to consume it for scale source/tolerances, enforced sealed-inventory resolution (auto-sealing S1/S2 artefacts when missing), and reran `make segment5a` (S0–S3) cleanly for manifest 7a09… / parameter hash e038…. Baseline outputs (local + UTC) and reports regenerated under the new governance.

* 7:29pm
   - Upstreamed post-S2 sealing into S0: added `sealed_outputs_5A` snapshot generation (S0 and orchestrator refresh) so `sealed_inputs_5A` stays immutable while S1/S2 outputs stay governed for S3.
   - S3 now consumes the sealed_outputs overlay instead of mutating sealed_inputs; merged inventory only, no receipt churn. Orchestrator seals outputs before S3; manual runs can rerun S0 refresh if the snapshot is missing.
   - Quick smoke: module imports succeed with `PYTHONPATH=packages/engine/src` to catch wiring regressions.

* 9:39pm
   - Fixed 5A.S1 merchant ingest against legacy L1 parquet encodings (int128/fixed_len) by adding a CSV fallback for `transaction_schema_merchant_ids`; S1 now logs a warning and reads the sibling CSV when parquet cannot be parsed.

* 9:44pm
   - Resolved 5A.S2 crash (`_render_shape` missing self) by correcting the static helper signature in the shapes runner so S2 can render templates without runtime errors.


* 9:50pm
   - Re-emitted reference/layer1/transaction_schema_merchant_ids/v2025-10-08/transaction_schema_merchant_ids.parquet using the governed CSV source with safe types (merchant_id as UInt64, others as string) to drop the legacy int128 encoding that Arrow/Polars couldn't read. Future S1 runs can now consume parquet without falling back to CSV (hash/digest changes; rerun S0 to refresh seals).

* 9:59pm
   - Updated merchant builder (scripts/build_transaction_schema_merchant_ids.py) to enforce a schema at DataFrame creation (merchant_id as UInt64, mcc as Int32, strings for channel/country) before writing parquet, preventing the int128/FixedLenByteArray encoding when regenerating the dataset.

* 10:03pm
   - Added a Makefile target `merchant_ids` with version knobs (MERCHANT_VERSION, MERCHANT_ISO_VERSION, MERCHANT_GDP_VERSION, MERCHANT_BUCKET_VERSION) to regenerate the governed merchant reference via the builder script. Use this to publish a new versioned snapshot before resealing S0 inputs.

* 10:55pm
   - Updated L1 dictionaries to point merchant references at `v2025-11-28` (seg_1A/seg_3B) so sealing will pick up the regenerated UInt64 parquet on the next S0 run; sealed_inputs still reference the older v2025-10-08 snapshot until S0 is rerun.

* 11:12pm
   - Implemented 5A.S4 overlays runner: loads S0/S3/S2/scenario configs, builds deterministic horizon mapping, applies governed overlay policy (currently default factor=1), and emits `merchant_zone_scenario_local_5A` plus optional overlay factors and UTC projection. Added S4 run reports/segment-state logging and wired orchestrator to run S4 after S3.
   - Added package exports and Makefile remains unchanged for runtime; S4 output paths align with the dataset dictionary.

* 11:37pm
   - Tracked remaining S4 spec gaps: overlay engine still ignores event precedence/combination/bounds and lacks structured event surfaces; calendar parsing is minimal (per-bucket factors only); horizon↔baseline mapping improved but UTC projection is disabled pending civil-time mapping; validation/error codes for missing overlays/events are not implemented. Need to implement full event surface + policy evaluation and governed UTC mapping to close these.

* 11:45pm
   - Progressed S4 overlays toward spec: map horizon buckets to baseline by local day/time (via S2 grid), ingest calendar + overlay policy to build per-bucket factors with precedence and bounds, and apply factors when composing scenario intensities. UTC projection remains deferred until civil-time mapping is governed, and full event-surface richness still pending.

* 12:00am
   - TODO: To fully align S4, we need (a) governed civil-time inputs (e.g., tz_timetable_cache/site_timezones + horizon start/end) so UTC projection can map local horizon buckets correctly, and (b) structured scenario_calendar/overlay_policy with real event semantics (types, scopes, precedence, bounds) to build proper event surfaces. Current calendar/policy are placeholders; any richer overlay/UTC mapping would be synthetic. We should wire S4 to consume those governed sources once available rather than inventing data now.
   - Detail of gaps to resume later:
       * Civil time: S4 currently uses simple offsets; needs 2A timetable/zone joins and horizon start/end timestamps to map local horizon buckets → UTC grid per tzid/zone; error if mapping missing.
       * Event surface: calendar needs well-typed events (holidays, paydays, campaigns, outages/stress) with scope (zone/merchant), start/end, and overlay precedence; overlay policy must define combination rules, bounds, shutdown semantics. Today we only honor per-bucket factors and default factor=1.
       * Validation: add S4-specific error codes for missing calendar/policy, invalid overlays, out-of-bounds factors, and missing horizon→baseline coverage.
       * Outputs: factors table should carry event provenance (event_type, applied_factor, overlap resolution), not just total factor; UTC output should be enabled once civil-time mapping is wired.

* 12:10am
   - Added dev-only samples for S4 overlay prototyping: `config/layer2/5A/scenario/dev_samples/scenario_calendar_dev_baseline.parquet` (24 hourly buckets with outage/promo/night factors) and `config/layer2/5A/scenario/dev_samples/scenario_overlay_policy_dev.yaml` (precedence/bounds and factors). These are NOT sealed or governed; use only for local testing until real civil-time + calendar governance is in place.
