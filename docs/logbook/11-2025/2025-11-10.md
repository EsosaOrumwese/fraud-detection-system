# Logbook
### Date: 10th November 2025
### Project: Fraud Detection System
### Reference commits: Check commits on this date (if any)

* 12:24am
   - Brought Segment 2B state‑6 online: the new S6VirtualEdgeRunner derives Philox substreams, validates sealed route_rng_policy_v1/virtual_edge_policy_v1, samples edges for each virtual arrival, writes RNG evidence/logs, and produces a run report/optional s6_edge_log (packages/engine/src/engine/layers/l1/seg_2B/s6_virtual_edge/l2/runner.py (line 148), 321). The package now exports the runner + configs (packages/engine/src/engine/layers/l1/seg_2B/s6_virtual_edge/__init__.py (line 1)) and seats S6 wiring in the orchestrator with proper CLI/makefile flags and result plumbing (packages/engine/src/engine/scenario_runner/l1_seg_2B.py (line 228), 265, 303; packages/engine/src/engine/cli/segment2b.py (line 128), 203; makefile (line 108), 157).
   - Captured S5 virtual evidence so S6 has something deterministic to consume: RouterArrival accepts an is_virtual flag, S5RouterResult now carries virtual_arrivals, and the routing loop records metadata only for virtual picks (packages/engine/src/engine/layers/l1/seg_2B/s5_router/l2/runner.py (line 49), 132, 296, 403, 549). Policy loading was deduplicated via the new shared helper (packages/engine/src/engine/layers/l1/seg_2B/shared/policies.py (line 1)), and the runtime dataclass shared with S6 sits in packages/engine/src/engine/layers/l1/seg_2B/shared/runtime.py (line 1).
   - Contract + schema updates expose the new artefacts: optional s6_edge_log, rng_event_cdn_edge_pick, and s6_edge_log_row are registered so governance knows where S6 writes (contracts/dataset_dictionary/l1/seg_2B/layer1.2B.yaml (line 303), 321, 394; contracts/schemas/layer1/schemas.layer1.yaml (line 357); contracts/schemas/layer1/schemas.2B.yaml (line 506), 551).
   - Coverage: existing router tests now assert the new virtual_arrivals behaviour and the new S6 runner has three happy/edge‑case fixtures (tests/engine/test_seg_2b_s5_router.py (line 180), 200; tests/engine/test_seg_2b_s6_virtual_edge.py (line 182), 218). I ran pytest tests/engine/test_seg_2b_s5_router.py tests/engine/test_seg_2b_s6_virtual_edge.py.

* 4:31am
   - Virtual-ledger + policy plumbing – Added the governed MCC map and new virtual_rules_policy_v1 to the 2B dictionary so S5/S6 can resolve them deterministically (contracts/dataset_dictionary/l1/seg_2B/layer1.2B.yaml (lines 25-158)). Created the actual policy file plus richer edge policy overrides (contracts/policies/l1/seg_2B/virtual_rules_policy_v1.json, contracts/policies/l1/seg_2B/virtual_edge_policy_v1.json). Schema pack now exposes anchors for both the MCC rules and the expanded edge policy (contracts/schemas/layer1/schemas.2B.yaml (lines 103-160)). S0 seals the new asset so run receipts stay authoritative (packages/engine/src/engine/layers/l1/seg_2B/s0_gate/l2/runner.py (lines 24-44)).
   - S5 learns which merchants are virtual – Introduced VirtualRules/VirtualMerchantClassifier (packages/engine/src/engine/layers/l1/seg_2B/shared/virtual.py (lines 1-105)) and use it inside the router to hydrate every arrival with an authoritative is_virtual flag and a manifest entry for the ledger (packages/engine/src/engine/layers/l1/seg_2B/s5_router/l2/runner.py (lines 200-340), 493-556). The run-report now records the classifier lineage and virtual counts, and the virtual_arrivals tuple truly reflects the governed set. Tests cover both the default flow and custom-arrival overrides using the new policy/dataset fixtures (tests/engine/test_seg_2b_s5_router.py).
   - S6 now matches the state-6 spec – Edge selection builds canonical alias tables per merchant from the policy (default + overrides) and caches them independently (packages/engine/src/engine/layers/l1/seg_2B/s6_virtual_edge/l2/runner.py (lines 174-333), 486-520). Optional diagnostics respect dictionary registration instead of erroring, and RNG enforcement validates that route_rng_policy_v1 exposes the virtual_edge/cdn_edge_pick stream before any draws. Run reports capture the new lineage, and the RNG/edge log writers remain write-once. Extended tests cover the override behavior, dictionary-disabled logs, and the new stream validator

* 4:44am
   - S5 blew up because the MCC ledger wasn’t sitting under the expected seed=…/fingerprint=<seg2a> partition. I’ve taught the router to fall back to the gate (2B) fingerprint whenever the Seg‑2A partition isn’t there, so it now finds your seed=2025110601/fingerprint=c282… copy without you having to reshuffle the data. This is purely a lookup change—no datasets moved.

* 4:59am
   - Added s7_audit_report to the Segment 2B dictionary with the exact path/partition/spec reference so the runner can resolve and publish it deterministically (contracts/dataset_dictionary/l1/seg_2B/layer1.2B.yaml).
   - Defined the authoritative shape schemas.2B.yaml#/validation/s7_audit_report_v1, covering the required provenance fields (seed, manifest_fingerprint, parameter_hash, created_utc, catalogue_resolution), the inputs_digest array, validator entries (id/status/codes + optional metrics), metrics block (alias/day/s RNG tallies), optional router evidence summaries, and notes (contracts/schemas/layer1/schemas.2B.yaml).

* 5:30am
   - packages/engine/src/engine/layers/l1/seg_2B/s7_audit/l2/runner.py (lines 125-356) now loads the sealed route/virtual policies plus 2A site_timezones, feeds them into the run report, and threads the new router evidence plumbing through the S7 report/metrics.
   - packages/engine/src/engine/layers/l1/seg_2B/s7_audit/l2/runner.py (lines 552-879) fully implements S5/S6 evidence checks: schema validation of selection/edge logs, RNG event decoding, policy stream assertions, site→tz and edge‑metadata coherence, and per-run RNG trace reconciliation before emitting V12‑V16 results.
   - packages/engine/src/engine/layers/l1/seg_2B/s7_audit/l2/runner.py (lines 863-1143) adds the helper stack for partition-token parsing, timezone lookup, RNG event loading, trace summarisation, and metadata verifiers so the audit gate can enforce the catalogue/identity rules described in the spec.

* 5:53am
   - Wired the audit state into the orchestration layer: Segment2BConfig/Result now expose run_s7 + report metadata, the orchestrator mints RouterEvidence plumbing, and CLI/Makefile flags let operators toggle the gate (`packages/engine/src/engine/scenario_runner/l1_seg_2B.py` lines 24-205, 314-358; `packages/engine/src/engine/cli/segment2b.py` lines 89-203; `makefile` lines 103-159).
   - Hardened schema + RNG handling so the audit can validate real event payloads: schema loader now falls back to the Layer‑1 bundle for `#/rng/...` pointers, and RNG validation strips `unevaluatedProperties` so envelope fields remain legal (`packages/engine/src/engine/layers/l1/seg_2B/shared/schema.py` lines 12-118; `packages/engine/src/engine/layers/l1/seg_2B/s7_audit/l2/runner.py` lines 480-520, 910-998).
   - Added focused fixtures for the S7 gate that stage sealed policies, alias artefacts, router logs, and S6 edge evidence; the suite covers the happy path, tz mismatches, and S6 log validation. Ran `pytest tests/engine/test_seg_2b_s7_audit.py` (tests/engine/test_seg_2b_s7_audit.py lines 1-420).

* 7:15am
   - Updated the production S7 loader to read the live `site_timezones` layout (merchant_id/site_order/tzid), tolerate RNG event payloads that omit run_id, and skip JSON-schema enforcement for the massive Philox logs; `packages/engine/src/engine/layers/l1/seg_2B/s7_audit/l2/runner.py` can now stream the parquet slices without ColumnNotFound failures and still enforces module/label/draw counters.
   - Replayed the audit directly against the latest S5/S6 artefacts (run_id `eb602d66…` / `b43f74ea…`) so we could finish the gate under the CLI timeout. The ad-hoc driver produced `runs/local_layer1_regen0/data/layer1/2B/s7_audit_report/seed=2025110601/fingerprint=c282…/s7_audit_report.json`, proving the fix on real data.
