# Logbook
### Date: 24th January 2026
### Project: Fraud Detection System
### Reference commits: Check commits on this date (if any)

* 4:41am
  - SR: ran sanity check of ScenarioRunner submit flow with local wiring/policy. Found schema validation mismatch when validating Pydantic model_dump against JSON Schema (datetime + None fields cause failures). Logged in component_scenario_runner.impl_actual.md entry 2026-01-24 04:41:45. Proposed fix: validate model_dump(mode="json", exclude_none=True) before ingress validation.

* 4:44am
  - SR: fixed ingress schema validation to use request.model_dump(mode="json", exclude_none=True) in ScenarioRunner.submit_run. Logged in component_scenario_runner.impl_actual.md entry 2026-01-24 04:44:09.

* 4:45am
  - SR: fixed ledger schema validation to use JSON-safe dumps for RunStatus/RunPlan; re-ran local submit sanity check (passed schema validation; got lease-held response due to stale local lease). Logged in component_scenario_runner.impl_actual.md entry 2026-01-24 04:45:48.

* 4:49am
  - Read updated root AGENTS.md and noted new requirement for a living build-plan doc at docs/model_spec/platform/implementation_maps/component_{COMP}.build_plan.md before further platform implementation planning.

* 4:59am
  - Updated AGENTS.md to explicitly define "living plan" as progressive elaboration: phase list first, then phase-specific sections with definition-of-done checklists, expanding only when entering the phase.

* 5:07am
  - SR: added living build-plan doc at docs/model_spec/platform/implementation_maps/component_scenario_runner.build_plan.md with phased roadmap and Phase 2 sections + DoD checklists. Logged in component_scenario_runner.impl_actual.md entry 2026-01-24 05:07:44.

* 5:13am
  - Added proposed end-state platform repo layout to scratch_files/scratch.md for component-focused structure review.

* 5:17am
  - Updated README.md repository layout section to reflect the proposed end-state platform component layout.

* 5:23am
  - SR: drafted Phase 2 implementation plan (durable storage + idempotency) in component_scenario_runner.impl_actual.md (Entry: 2026-01-24 05:20:30).

* 5:30am
  - SR: implemented Phase 2 storage + authority store changes (ObjectStore + S3 backend, DB-backed equivalence/leases, wiring updates, psycopg dependency, tests). Logged in component_scenario_runner.impl_actual.md entry 2026-01-24 05:28:30. Ran pytest for authority store (2 passed).

* 5:35am
  - SR: recorded Phase 2 hardening gap and updated build plan with Phase 2.5 hardening DoD checklist (component_scenario_runner.build_plan.md). Logged in component_scenario_runner.impl_actual.md entry 2026-01-24 05:35:58.

* 5:42am
  - SR: locked target platform stack to AWS (S3 + RDS Postgres + ECS Fargate + Kinesis). Updated SR build plan and impl_actual; added config/platform/sr/wiring_aws.yaml.

* 5:47am
  - SR: wrote Phase 2.5 hardening plan in component_scenario_runner.impl_actual.md (Entry: 2026-01-24 05:47:18).

* 5:50am
  - SR: implemented Phase 2.5 hardening (immutability guards, S3 CAS append, lease validation/renew). Updated impl_actual (Entry: 2026-01-24 05:50:29). Ran pytest for authority store (2 passed).

* 5:58am
  - SR: added Phase 2.5 tests (Postgres smoke, concurrency, S3 CAS/unit + integration) and fixed plan_hash JSON serialization in runner. Ran pytest for new tests: 2 passed, 2 skipped (env‑gated). Logged in component_scenario_runner.impl_actual.md entry 2026-01-24 05:58:14.

* 7:09am
  - Renamed platform implementation map/build plan files to drop `component_` prefix (scenario_runner.impl_actual.md and scenario_runner.build_plan.md). Updated AGENTS.md and implementation_maps README accordingly; logged in scenario_runner.impl_actual.md entry 2026-01-24 07:09:54.

* 9:58am
  - SR: clarified local dev stack guidance (MinIO + Postgres recommended; FS + SQLite allowed) in scenario_runner.build_plan.md. Logged in scenario_runner.impl_actual.md entry 2026-01-24 09:58:16.

* 9:59am
  - SR: corrected local dev guidance to state FS + SQLite are not recommended (smoke only) and Phase 2.5 hardening must run on MinIO + Postgres. Logged in scenario_runner.impl_actual.md entry 2026-01-24 09:59:41.

* 10:40am
  - SR: planned local parity profiles (MinIO + Postgres) and wiring changes; logged in scenario_runner.impl_actual.md entry 2026-01-24 10:40:41.

* 10:41am
  - SR: implemented local parity profile and S3 endpoint overrides; updated SR service README. Logged in scenario_runner.impl_actual.md entry 2026-01-24 10:41:47.

* 11:08am
  - SR: added local parity docker compose stack (infra/local/docker-compose.sr-parity.yaml). Attempted to bring up stack; Docker engine not available (desktop-linux pipe missing; default pipe requires elevated/Docker Desktop running). Awaiting user to start Docker Desktop or provide running Docker daemon.

* 11:24am
  - SR: documented Phase 2.5 local-parity decision trail (MinIO/Postgres setup, docker context, image tag choice, S3 creds/bucket, Postgres port conflict) in scenario_runner.impl_actual.md entry 2026-01-24 11:24:39. Updated wiring_local_parity to port 5433 and README to reflect Postgres port.

* 11:26am
  - SR: finalized local parity stack (MinIO + Postgres) with updated compose (minio/mc latest, MC_HOST_local init, Postgres port 5433). Installed psycopg in venv. Ran S3 + Postgres integration tests with MinIO creds; all 3 tests passed. Logged in scenario_runner.impl_actual.md entry 2026-01-24 11:26:44 and marked Phase 2.5 complete in build plan.

* 11:36am
  - Added SR local parity test env vars to .env and documented how to run Phase 2.5 integration tests in services/scenario_runner/README.md.

* 11:37am
  - Corrected README test instructions to use a PowerShell-safe .env loader command.

* 11:39am
  - Fixed the PowerShell .env loader in services/scenario_runner/README.md after verifying the prior command failed; confirmed new command sets env vars correctly.

* 11:59am
  - Stopped the local parity stack (docker compose down) after successful Phase 2.5 tests.

* 12:01pm
  - Confirmed Phase 1 and Phase 2 completion in scenario_runner.impl_actual.md (Entry: 2026-01-24 12:01:45) and marked Phase 2 complete in scenario_runner.build_plan.md.

* 12:04pm
  - Phase 3 planning: added decision trail in scenario_runner.impl_actual.md (Entry: 2026-01-24 12:04:07) and expanded Phase 3 sections + DoD in scenario_runner.build_plan.md.

* 12:13pm
  - Adjusted impl_actual process to live decision notes (append small notes as decisions happen). Logged in scenario_runner.impl_actual.md entry 2026-01-24 12:13:18.

* 12:14pm
  - Re-read root AGENTS.md to refresh decision-trail + append-only requirements.

* 12:18pm
  - Impl_actual corrective expansion
  - Appended detailed Phase 3 planning expansion (decision trail + mechanics + invariants) to docs/model_spec/platform/implementation_maps/scenario_runner.impl_actual.md to replace the earlier summary-style entry.

* 12:29pm
  - Phase 3 implementation start
  - Appended live decision trail for Phase 3 strict evidence + schema alignment in docs/model_spec/platform/implementation_maps/scenario_runner.impl_actual.md before code changes.

* 12:38pm
  - Phase 3 implementation decisions
  - Logged mid-implementation decisions: evidence schema alignment, engine contract validation, gate scope tokens, locator pins logic, instance-proof bridge handling, and policy digest recompute.

* 12:39pm
  - Tests
  - pytest tests/services/scenario_runner/test_scenario_runner_concurrency.py
    - Result: 1 passed (RefResolver deprecation warnings from jsonschema).

* 12:42pm
  - Tests
  - pytest tests/services/scenario_runner/test_instance_proof_bridge.py
    - Result: 2 passed (RefResolver deprecation warnings from jsonschema).

* 12:43pm
  - Engine schema ref resolution shim
  - Added fallback in SchemaRegistry to resolve interface_pack refs that point at non-existent interface_pack/layer-1 paths (strip interface_pack/ when missing).

* 12:43pm
  - Build plan update
  - Marked Phase 3 status as in progress in docs/model_spec/platform/implementation_maps/scenario_runner.build_plan.md with note about instance-proof receipt gap + pending integration tests.

* 12:44pm
  - Output availability handling
  - Added availability to SR OutputCatalogue and treat optional outputs as non-blocking.

* 12:54pm
  - Impl_actual errata
  - Appended an errata entry correcting control characters/missing letters in recent Phase 3 notes (kept originals intact per AGENTS.md).

* 12:56pm
  - Impl_actual rewrite cleanup
  - Rewrote corrupted entries (12:29:03–12:44:12) in docs/model_spec/platform/implementation_maps/scenario_runner.impl_actual.md with clean text; removed the errata block as requested.

* 1:01pm
  - Phase 3 extension start
  - Logged decisions for instance-proof receipts + SR consumption + downstream compatibility in impl_actual.

* 1:07pm
  - Tests
  - pytest tests/services/scenario_runner/test_gate_verification_integration.py
    - Result: 1 passed (RefResolver deprecation warnings from jsonschema).

* 1:08pm
  - Instance-proof receipts + SR updates
  - Added instance-proof receipt schema + example to engine interface pack; documented path convention.
  - SR now loads/validates instance receipts and emits instance_receipts in run_facts_view.
  - Added gate verification integration test with real gate map artifacts.
  - Updated run_facts_view contract README and platform blueprint compatibility note.

* 1:59pm
  - Normalized 2026-01-24 logbook timing entries and restored details for the 12:18pm–1:08pm block.

* 2:01pm
  - Cleaned control characters/tabs and repaired corrupted words in docs/model_spec/platform/implementation_maps/scenario_runner.impl_actual.md (tests/target_* tokens).

* 2:05pm
  - Cleaned lingering text corruption in docs/model_spec/platform/implementation_maps/scenario_runner.impl_actual.md (fixed double-t prefixes; verified no standalone misspellings or control chars).

* 2:08pm
  - Fixed missing letters in scenario_runner.impl_actual.md (allow_instance_proof_bridge, test_gate_verification_integration, run_facts_view line).

* 2:36pm
  - SR: appended detailed black-box instance-proof implementation plan (SR-verifier receipts) in docs/model_spec/platform/implementation_maps/scenario_runner.impl_actual.md (Entry: 2026-01-24 14:36:13) before code changes.
  - SR: fixed missing-letter typos in earlier impl_actual entries for readability (no semantic changes).

* 2:43pm
  - SR: implemented black-box instance-proof receipts (SR verifier receipts stored under fraud-platform/sr/instance_receipts) and removed engine-receipt lookup in scenario_runner runner logic.
  - SR: updated instance-proof test to assert receipt emission and READY; ran pytest tests/services/scenario_runner/test_instance_proof_bridge.py (1 passed; RefResolver deprecation warnings).
  - SR: fixed YAML regex escaping in docs/model_spec/data-engine/interface_pack/contracts/instance_proof_receipt.schema.yaml.
  - Docs: clarified SR verifier receipt path in data_engine_interface.md, storage_layout_v1.md, interface_pack README, SR contract README, and services/scenario_runner/README.md.

* 2:48pm
  - SR: appended pre-change decision entry for Phase 3 follow-ups (remove bridge flag, add receipt-drift test, update build plan) in docs/model_spec/platform/implementation_maps/scenario_runner.impl_actual.md.

* 2:50pm
  - SR: removed allow_instance_proof_bridge from PolicyProfile, policy_v0.yaml, and related tests; recomputed policy content_digest.
  - SR: added receipt-drift test (pre-seeded mismatching receipt -> FAIL with INSTANCE_RECEIPT_DRIFT).
  - SR: updated Phase 3 build plan status/DoD to reflect black-box verifier receipts and drift test.
  - Tests: pytest tests/services/scenario_runner/test_instance_proof_bridge.py (2 passed; RefResolver deprecation warnings).

* 2:51pm
  - SR: appended implementation-map entry documenting bridge removal, drift test, and build plan update (Entry: 2026-01-24 14:50:32).

* 3:05pm
  - SR: added a decision entry to align interface_pack gate map with engine policy for 6B hashing law before making code changes (scenario_runner.impl_actual.md Entry: 2026-01-24 15:05:10).

* 3:20pm
  - SR: updated interface_pack gate map for 6B to use index_json_ascii_lex_raw_bytes hashing law; implemented GateVerifier support for index-driven raw-bytes hashing.
  - Tests: pytest tests/services/scenario_runner/test_gate_verifier.py (2 passed; RefResolver deprecation warnings).

* 3:24pm
  - SR: began migration off jsonschema.RefResolver to referencing registry (decision entry added in scenario_runner.impl_actual.md).

* 3:25pm
  - SR: migrated SchemaRegistry from jsonschema.RefResolver to referencing.Registry with custom file:// retriever + interface_pack shim.
  - Tests: pytest tests/services/scenario_runner/test_gate_verifier.py (2 passed; warnings cleared).

* 3:32pm
  - SR: added Phase 3 hardening plan entry (parity integration + negative evidence cases) to scenario_runner.impl_actual.md before coding.

* 3:33pm
  - SR: began Phase 3 parity integration test work; appended detailed notes in scenario_runner.impl_actual.md before coding.

* 3:37pm
  - SR: added negative evidence integration test (missing 6B gate flag → FAIL with EVIDENCE_MISSING_DEADLINE) using temp-copied engine artefacts.

* 3:42pm
  - SR: adjusted parity reuse integration test to use sealed_inputs_1A after diagnosing upstream gate conflicts in local_full_run-5 for deep 6B outputs.

* 3:40pm
  - Tests: pytest tests/services/scenario_runner/test_gate_verification_integration.py tests/services/scenario_runner/test_evidence_negative_integration.py (3 passed).

* 3:41pm
  - SR: updated Phase 3 build plan status/notes to reflect parity + negative tests and remaining upstream gate hashing alignment.

* 3:41pm
  - SR: fixed referencing resolution for relative $id by overriding to file URI in SchemaRegistry (in-memory only).

* 3:48pm
  - SR: added narrative logging plan to scenario_runner.impl_actual.md before implementing INFO-level runtime narration.

* 3:55pm
  - SR: added narrative INFO logs across submit/plan/evidence/commit flow and wired default logging in CLI/service.

[2026-01-24 15:57:42] SR: added a detailed impl_actual entry for aligning HashGate digest laws (2A/2B/3B/5A/5B/6A), including plan to update interface_pack + GateVerifier index parsing and path-base handling.

[2026-01-24 16:00:45] SR: updated engine_gates interface_pack to index-based digest laws for 2A/2B/3B/5A/5B/6A (2B uses run_root base). Extended GateVerifier index parsing + path-base handling in evidence.py.

[2026-01-24 16:08:08] SR: fixed interface_pack gate map (restore 1A/1B, set 2B/3B index-based, 6A ordering=index_order). Added gate-verifier tests for 2A/2B/3B/5A/5B/6A and ran `python -m pytest tests/services/scenario_runner/test_gate_verifier.py -q` via venv → 8 passed.

[2026-01-24 16:08:54] SR: updated build plan Phase 3 status + Section 3.5 to reflect gate hashing law alignment for 2A/2B/3B/5A/5B/6A and gate-verifier test coverage.

[2026-01-24 16:36:55] SR: planned interface-pack compatibility note documenting 6A index-order mismatch (engine is black box). Added impl_actual entry before editing.

[2026-01-24 16:37:11] SR: added compatibility_notes to interface_pack gate map documenting 6A index-order mismatch and SR verification choice.

[2026-01-24 16:45:06] SR: planning parity reuse integration update to deep gate (5A/5B/6A) and full SR test run; added impl_actual plan entry.

[2026-01-24 16:46:03] SR: updated parity reuse integration test to target deep gate output `s5_validation_report_6A` and parameterized policy output_ids.

[2026-01-24 16:46:42] SR: ran `python -m pytest tests/services/scenario_runner -q` via venv → 19 passed, 2 skipped.

[2026-01-24 16:59:52] SR: planned explicit UNKNOWN_GATE_ID handling (compile + evidence) and new unit test; appended impl_actual entry.

[2026-01-24 17:03:35] SR: implemented explicit UNKNOWN_GATE_ID/UNKNOWN_OUTPUT_ID handling in plan + evidence; added unit test; ran `python -m pytest tests/services/scenario_runner -q` → 20 passed, 2 skipped.

[2026-01-24 17:06:38] SR: marked Phase 3 COMPLETE in impl_actual; moving to Phase 4.

[2026-01-24 17:06:57] SR: build plan updated to mark Phase 3 COMPLETE; Phase 4 next.

[2026-01-24 17:10:56] SR: added Phase 4 planning entry in impl_actual (engine invocation integration).

[2026-01-24 17:11:22] SR: expanded Phase 4 in build plan with sections + DoD (invoker interface, attempt lifecycle, receipt gating, failure taxonomy, tests).

[2026-01-24 17:22:09] SR: Phase 4 implementation started; added pre‑coding entry to impl_actual outlining inspection + invoker contract reasoning.

[2026-01-24 17:26:13] SR: logged Phase 4 decisions (attempt counting via run_record, new attempt schema, invocation validation, run_receipt gating, attempt_limit enforcement).

[2026-01-24 17:32:45] SR: implemented Phase 4 invoker + attempt lifecycle + run_receipt gating; added schemas and tests; ran full SR suite → 24 passed, 2 skipped.

[2026-01-24 17:33:35] SR: updated Phase 4 status in build plan (invocation validation + attempt lifecycle done; local subprocess adapter still stubbed).

[2026-01-24 17:38:41] SR: starting Phase 4.1 real local subprocess invoker implementation; added plan entry to impl_actual.

[2026-01-24 17:41:04] SR: logged subprocess invoker design decisions (engine_command wiring, placeholder substitution, env payload, logs_ref capture).

[2026-01-24 17:45:46] SR: implemented LocalSubprocessInvoker + logs capture; added wiring fields + schema update; added subprocess tests (2 passed).

[2026-01-24 17:46:45] SR: ran full SR tests after subprocess invoker → 26 passed, 2 skipped.

[2026-01-24 17:47:16] SR: Phase 4 build plan status updated (all sections implemented; awaiting sign‑off).

[2026-01-24 17:55:42] SR: planned Phase 4 hardening fixes (invocation validation handling, empty command guard, unresolved placeholders).

* 6:02pm
  - Phase 4 hardening: appended pre-change decision entry to scenario_runner.impl_actual.md capturing the three findings and the concrete fix plan.

* 6:03pm
  - Fixed missing RunHandle import in tests/services/scenario_runner/test_engine_invocation.py.

* 6:04pm
  - Tests: ran `python -m pytest tests/services/scenario_runner -q` with system Python; collection failed due to missing `pydantic` (venv not active).

* 6:05pm
  - Tests: ran `./.venv/Scripts/python -m pytest tests/services/scenario_runner -q` → 29 passed, 2 skipped.

* 6:06pm
  - Phase 4 hardening: appended implementation + validation entry to scenario_runner.impl_actual.md.

* 6:13pm
  - Phase 4: appended completion sign‑off entry to scenario_runner.impl_actual.md and marked Phase 4 COMPLETE in scenario_runner.build_plan.md (Phase 3 summary line now marked COMPLETE as well).

* 6:19pm
  - Phase 5 planning: appended detailed control bus + re‑emit (N7) plan to scenario_runner.impl_actual.md and expanded Phase 5 sections + DoD in scenario_runner.build_plan.md.

* 6:23pm
  - Phase 5 implementation start: added control bus wiring fields, control bus adapter selection, and began re-emit implementation (ops micro-lease + idempotency keys).

* 6:27pm
  - Added re-emit request + terminal signal schemas under SR contracts and documented them in SR contracts README.

* 6:29pm
  - Added CLI subcommand + service endpoint for re-emit; updated runner READY publish to be failure-tolerant with READY_PUBLISHED / READY_PUBLISH_FAILED events.

* 6:31pm
  - Tests: ran `python -m pytest tests/services/scenario_runner/test_reemit.py -q` → 2 passed.

* 6:32pm
  - Tests: ran `python -m pytest tests/services/scenario_runner -q` → 31 passed, 2 skipped.

* 6:33pm
  - Phase 5 implementation: appended detailed decision trail to scenario_runner.impl_actual.md.

* 6:34pm
  - Phase 5 build plan status updated to "IN PROGRESS (implementation started)" in scenario_runner.build_plan.md.

* 6:37pm
  - Re-emit failure handling fix: distinguish attempted publish failures vs not applicable; updated runner response logic.

* 6:38pm
  - Tests: re-ran `python -m pytest tests/services/scenario_runner/test_reemit.py -q` → 2 passed.

* 6:39pm
  - Tests: re-ran `python -m pytest tests/services/scenario_runner -q` → 31 passed, 2 skipped.

* 6:46pm
  - Concurrency regression: Windows PermissionError during run_status read in concurrent test; decided to add bounded retry in LocalObjectStore reads.

* 6:48pm
  - Implemented LocalObjectStore read retry on PermissionError/FileNotFound and re-ran SR tests.

* 6:49pm
  - Tests: ran `python -m pytest tests/services/scenario_runner -q` → 35 passed, 3 skipped.

* 7:00pm
  - Added `config/platform/sr/wiring_local_kinesis.yaml` and documented LocalStack Kinesis test steps in services/scenario_runner/README.md.

* 7:05pm
  - Added `.env.localstack.example` with LocalStack Kinesis env placeholders (no secrets).

* 7:07pm
  - Added README note showing how to load `.env.localstack.example` for LocalStack Kinesis test.

* 7:13pm
  - Added `scripts/localstack.ps1` helper to start/stop/status/logs for LocalStack Kinesis.

* 7:34pm
  - Added narrative LocalStack log view to `scripts/localstack.ps1` (default) with a raw fallback; updated SR README note.

* 7:44pm
  - LocalStack Kinesis test: loaded `.env.localstack.example` and ran `python -m pytest tests/services/scenario_runner/test_control_bus_kinesis.py -q` → 1 passed (botocore datetime.utcnow deprecation warnings).

* 7:51pm
  - Marked Phase 5 COMPLETE in scenario_runner.build_plan.md and recorded Phase 5 sign-off in scenario_runner.impl_actual.md.

* 7:55pm
  - Phase 6 planning: added detailed Phase 6 plan entry in scenario_runner.impl_actual.md and expanded Phase 6 sections + DoD in scenario_runner.build_plan.md.

* 8:11pm
  - Phase 6: implemented structured obs scaffolding (obs.py + event emission) and ran SR test suite → 35 passed, 3 skipped.

* 8:22pm
  - Phase 6.2: added governance fact events (policy_rev/plan_hash/bundle_hash/reemit_key) and updated tests; SR suite green.

* 8:32pm
  - Phase 6.3/6.4: added metrics sink, composite sinks, OTLP scaffold, debug drop; added obs failure test; SR suite green.

* 8:33pm
  - Updated Phase 6 status note in scenario_runner.build_plan.md (6.1–6.4 implemented; 6.5 tests in progress).

* 8:41pm
  - Phase 6.5: added metrics sink test; SR suite green (37 passed, 3 skipped).

* 8:42pm
  - Marked Phase 6 COMPLETE in scenario_runner.build_plan.md after tests passed.

* 8:14pm
  - Expanded Phase 6 impl_actual notes with detailed reasoning, alternatives, mechanics, and validation (corrective entry added, no history rewritten).

* 8:21pm
  - Phase 7 planning: added detailed Phase 7 plan entry in scenario_runner.impl_actual.md and expanded Phase 7 sections + DoD in scenario_runner.build_plan.md.

* 8:54pm
  - Phase 7 implementation: auth allowlists, redaction helper, quarantine artifacts + CLI tooling, re-emit rate limits and dry-run, updated schemas/models, tests added.

* 8:55pm
  - Tests: `python -m pytest tests/services/scenario_runner/test_security_ops.py -q` → 7 passed; full SR suite → 44 passed, 3 skipped.

* 8:56pm
  - Marked Phase 7 COMPLETE in scenario_runner.build_plan.md after implementation + tests.
