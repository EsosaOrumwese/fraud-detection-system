# Logbook
### Date: 4th January 2026
### Project: Fraud Detection System
### Reference commits: Check commits on this date (if any)

* 12:33am
   - Fixed 5B.S4 site lookup join failure by normalizing join key dtypes (cast merchant_id to UInt64, site_order to UInt32, and ISO/tzid to Utf8) for both `s1_site_weights` and `site_timezones`, matching schema expectations and preventing u64↔str join mismatches (`packages/engine/src/engine/layers/l2/seg_5B/s4_arrivals/runner.py`).

* 12:43am
   - Added 5B per-state resume support (S1-S4): new CLI flags (`--s1-resume`..`--s4-resume`), Makefile passthrough variables (`SEG5B_S1_RESUME`..`SEG5B_S4_RESUME`), and orchestrator logic to reuse existing outputs when present while preserving state dependency checks (`packages/engine/src/engine/cli/segment5b.py`, `packages/engine/src/engine/scenario_runner/l2_seg_5B.py`, `makefile`).

* 04:38am
   - Enforced 5B.S0 upstream bundle fingerprint matching and removed `source_manifest` overrides for sealed upstream datasets so Layer-2 uses the same manifest as Layer-1/5A, preventing mixed-manifest routing inputs such as `s4_group_weights` (`packages/engine/src/engine/layers/l2/seg_5B/s0_gate/runner.py`).

* 05:16am
   - Reviewed fingerprint divergence evidence from run receipts/manifests to answer the 5273d/707ef/d840a mapping request (no code changes).
   - Inspected `runs/local_full_run-3/data/layer1/1A/validation/fingerprint=5273d50c75db17b79a221cbff6b8cf50c6a1bb72dd2a1b7f287fd4bb3f307174/parameter_hash_resolved.json` for 1A policy bundle and parameter hash.
   - Inspected `runs/local_full_run-3/data/layer1/1A/validation/fingerprint=5273d50c75db17b79a221cbff6b8cf50c6a1bb72dd2a1b7f287fd4bb3f307174/MANIFEST.json` for 1A commit/seed/run_id details.
   - Inspected `runs/local_full_run-3/data/layer1/3A/s0_gate_receipt/fingerprint=707ef17ae102def525749d0aabf1c10b5c44cd349e15f4a9ef6e04bb03d75b72/s0_gate_receipt_3A.json` and `runs/local_full_run-3/data/layer1/3A/validation/fingerprint=707ef17ae102def525749d0aabf1c10b5c44cd349e15f4a9ef6e04bb03d75b72/index.json` for 3A manifest/parameter hash and sealed policy set.
   - Inspected `runs/local_full_run-3/data/layer1/3B/s0_gate_receipt/fingerprint=d840a1bea1ee7279d4b253b1442f3e1893fe768a5bbbd9fc3e0cf6766d2dd4b1/s0_gate_receipt_3B.json` and `runs/local_full_run-3/data/layer1/3B/validation/fingerprint=d840a1bea1ee7279d4b253b1442f3e1893fe768a5bbbd9fc3e0cf6766d2dd4b1/s5_manifest_3B.json` for 3B manifest/parameter hash and sealed policy set.
   - Inspected `runs/local_full_run-3/data/layer2/5A/s0_gate_receipt/fingerprint=d840a1bea1ee7279d4b253b1442f3e1893fe768a5bbbd9fc3e0cf6766d2dd4b1/s0_gate_receipt_5A.json` and `runs/local_full_run-3/data/layer2/5B/s0_gate_receipt/fingerprint=d840a1bea1ee7279d4b253b1442f3e1893fe768a5bbbd9fc3e0cf6766d2dd4b1/s0_gate_receipt_5B.json` for downstream manifest alignment.

* 06:02am
   - Inspected tail of `runs/local_full_run-3/run_log_run-3.log` to locate 5B.S0 failure cause (upstream bundle fingerprint mismatch for 1A).

* 06:34am
   - Audited S0 state-expanded specs for segments 1A-6B to confirm fingerprint semantics: only 1A computes `parameter_hash`/`manifest_fingerprint`; all other segments are required to accept the caller-provided identity and only verify upstream gates (state-flow docs: `docs/model_spec/data-engine/layer-1/specs/state-flow/1A/state.1A.s0.expanded.md`, `docs/model_spec/data-engine/layer-1/specs/state-flow/1B/state.1B.s0.expanded.md`, `docs/model_spec/data-engine/layer-1/specs/state-flow/2A/state.2A.s0.expanded.md`, `docs/model_spec/data-engine/layer-1/specs/state-flow/2B/state.2B.s0.expanded.md`, `docs/model_spec/data-engine/layer-1/specs/state-flow/3A/state.3A.s0.expanded.md`, `docs/model_spec/data-engine/layer-1/specs/state-flow/3B/state.3B.s0.expanded.md`, `docs/model_spec/data-engine/layer-2/specs/state-flow/5A/state.5A.s0.expanded.md`, `docs/model_spec/data-engine/layer-2/specs/state-flow/5B/state.5B.s0.expanded.md`, `docs/model_spec/data-engine/layer-3/specs/state-flow/6A/state.6A.s0.expanded.md`, `docs/model_spec/data-engine/layer-3/specs/state-flow/6B/state.6B.s0.expanded.md`).
   - Searched S0 implementations for fingerprint computation; `compute_manifest_fingerprint(...)` appears in 1A S0 (expected) but also in 3A/3B S0 gate runners (unexpected vs spec), which can recompute the manifest and diverge from the caller-provided fingerprint (`packages/engine/src/engine/layers/l1/seg_1A/s0_foundations/l2/runner.py`, `packages/engine/src/engine/layers/l1/seg_3A/s0_gate/l2/runner.py`, `packages/engine/src/engine/layers/l1/seg_3B/s0_gate/l2/runner.py`).
   - Verified what ran in `runs/local_full_run-3` by listing validation bundles: 1A/1B/2A/2B share `fingerprint=8e4aa16116b4365834ea6b81046ccfa06b11a3160e8388af813df3b50ffb071f`, 3A uses `fingerprint=3ebf381338a8a3ac82e1ebbba748a04b6c8672294a6d85ccf6dd1b6db7b9fc6c`, 3B and 5A use `fingerprint=168233adb8d6f441df8336b3bd6a1397575bb72fb77fd5031b191d6baa053de6`, and 5B has no validation bundle yet (missing `runs/local_full_run-3/data/layer2/5B/validation`).

* 2:53pm
   - Expanded 1A.S0 parameter bundle requirements to include all 3A-6B policy/config inputs so downstream segments share the same `parameter_hash`/manifest and stop tripping `E_PARAMETER_HASH_MISMATCH` (`packages/engine/src/engine/layers/l1/seg_1A/s0_foundations/l2/runner.py`).
   - Added the corresponding `--param` entries to `SEG1A_ARGS` so 1A supplies the full policy set (2B, 3A, 3B, 5A, 5B, 6A, 6B) when computing the parameter hash (`makefile`).

* 3:27pm
   - Reworked 3A.S0 parameter hash verification to trust `parameter_hash_resolved.json` from the 1A validation bundle (spec binding), instead of recomputing from only 3A policy assets; added a guard that required 3A policy basenames appear in the resolved parameter list to ensure they are included in the governed parameter set (`packages/engine/src/engine/layers/l1/seg_3A/s0_gate/l2/runner.py`).

* 7:29pm
   - Aligned 2A.S0 to use the caller-supplied `parameter_hash` and verify it against 1A’s `parameter_hash_resolved.json`, instead of recomputing a new parameter hash from 2A’s local configs; this matches the 2A state-expanded spec and prevents downstream `E_PARAMETER_HASH_MISMATCH` (`packages/engine/src/engine/layers/l1/seg_2A/s0_gate/l2/runner.py`).
   - Passed `parameter_hash` through the Segment2A orchestrator into the S0 gate inputs so the identity is consistent across segments (`packages/engine/src/engine/scenario_runner/l1_seg_2A.py`).

* 8:02pm
   - Read docs/references/closed-world-fraud-enterprise-conceptual-design.md and docs/references/closed-world-synthetic-data-engine-with-realism-conceptual-design.md as conceptual design context per root router (closest matches to the referenced naming).
   - Read narratives for Layer-1 (1A-3B), Layer-2 (5A-5B), and Layer-3 (6A-6B) to align with the current engine scope (docs/model_spec/data-engine/layer-1/narrative/narrative_1A-to-3B.md, docs/model_spec/data-engine/layer-2/narrative/narrative_5A-and-5B.md, docs/model_spec/data-engine/layer-3/narrative/narrative_6A-and-6B.md).
   - Read packages/engine/AGENTS.md for engine-specific routing and guardrails.
   - Attempted to open docs/model_spec/data-engine/specs/data-intake/AGENTS.md (not found); followed the available data-intake routers for layers 1-3 (docs/model_spec/data-engine/layer-1/specs/data-intake/AGENTS.md, docs/model_spec/data-engine/layer-2/specs/data-intake/AGENTS.md, docs/model_spec/data-engine/layer-3/specs/data-intake/AGENTS.md) plus the data-engine router (docs/model_spec/data-engine/AGENTS.md).

* 8:11pm
   - Read Layer-1 Segment 1A state-flow expanded specs (S0-S9) plus contracts (artefact registry, dataset dictionary, schema anchors, ingress and layer-1 schemas) to align with the layer-1 engine spec order.
   - Read Layer-1 Segment 1B state-flow expanded specs (S0-S9) plus contracts (artefact registry, dataset dictionary, schema anchors) to complete the layer-1 state-flow + contracts reading order.


* 8:16pm
   - Continued Layer-1 state-flow reading for segments 2A, 2B, 3A, 3B in order; extracted and reviewed Purpose/Inputs/Outputs/Acceptance sections from each expanded state spec to keep context compact while covering the binding contracts.
   - Reviewed Layer-1 contracts for segments 2A, 2B, 3A, 3B (artefact registries, dataset dictionaries, schema anchors), summarizing IDs and top-level schema sections for each segment.


* 8:22pm
   - Followed packages/engine AGENTS router for Layer-2 (5A/5B) and Layer-3 (6A/6B): read all expanded state-flow specs in order and reviewed contracts (artefact registries, dataset dictionaries, schema anchors including layer/ingress packs where present).


* 8:34pm
   - Inspected runs/local_full_run-3/run_log_run-3.log to locate the failure point (Segment2A S0 crash) and captured the traceback context.
   - Reviewed Segment 2A S0 implementation and helpers (runner.py, exceptions.py, shared/dictionary.py) plus the runtime dictionary at contracts/dataset_dictionary/l1/seg_2A/layer1.2A.yaml to trace the missing validation bundle ID and exception handling behavior.
   - Noted 1A validation bundle path usage in code vs dictionary entries for possible non-conformance, based on run-log warnings.

* 8:37pm
   - Scanned `runs/local_full_run-3/run_log_run-3.log` warnings to confirm the non-runtime warning set (S2/S4 validation bundle publish paths, iso_legal_tender coverage gaps, S6/S8 downstream allocation warnings, rasterio PROJ DB warning).
   - Updated 1A S2 validation bundle publishing to resolve `validation_bundle_1A` first, fall back to `validation_bundle`, then fall back to `data/layer1/1A/validation/fingerprint=...` with explicit logging (`packages/engine/src/engine/layers/l1/seg_1A/s2_nb_outlets/l3/bundle.py`).
   - Updated 1A S4 validation bundle publishing with the same resolution fallback so publish paths align with the 1A dataset dictionary (`packages/engine/src/engine/layers/l1/seg_1A/s4_ztp_target/l3/bundle.py`).
   - Noted that the iso_legal_tender warning requires regenerating `reference/iso/iso_legal_tender/2024/iso_legal_tender.parquet` via `scripts/build_currency_reference_surfaces.py` (no run executed here).

* 8:47pm
   - Replaced deprecated `datetime.utcnow()` with timezone-aware `datetime.now(datetime.timezone.utc)` in `scripts/build_currency_reference_surfaces.py` to silence the DeprecationWarning while preserving the same RFC3339 `Z` timestamp format.


* 8:36pm
   - Created audit document skeleton at docs/reviews/engine_audit_2026-01-04.md to record segment-by-segment review findings (1A-6B).


* 8:43pm
   - Began audit content in docs/reviews/engine_audit_2026-01-04.md, documenting 1A/1B/2A/2B/3A/3B/5A/5B/6A/6B expected inputs, observed implementation, handoff notes, and initial findings (including 2A dictionary mismatch and 1B run-summary path issues).


* 8:49pm
   - Expanded engine audit document with additional implementation details for segments 1B, 2B, 3A, 3B, 5A, 5B, 6A, and 6B, focusing on gate verification and sealed upstream assets.

* 9:14pm
   - Reviewed Segment 2A S5 validation implementation and dictionary contract alignment (packages/engine/src/engine/layers/l1/seg_2A/s5_validation/l2/runner.py; contracts/dataset_dictionary/l1/seg_2A/layer1.2A.yaml).
   - Audited Segment 2B S1-S8 runners plus S0 gate for contract handoffs, policy usage, and logging surfaces (packages/engine/src/engine/layers/l1/seg_2B/*).
   - Audited Segment 3A S1-S7 runners for gate preconditions, RNG logging, and validation outputs (packages/engine/src/engine/layers/l1/seg_3A/*).
   - Audited Segment 3B S0 gate and S1-S5 runners for placeholder behavior and validation bundle assembly (packages/engine/src/engine/layers/l1/seg_3B/*; contracts/dataset_dictionary/l1/seg_3B/layer1.3B.yaml).
   - Updated docs/reviews/engine_audit_2026-01-04.md with new implementation notes and blockers (2B S7 site_id mismatch, 3A S3 empty-escalation crash, 2B optional civil-time gating, 2B merchant_mcc_map fallback, 3A routing_universe_hash determinism risk).

* 9:23pm
   - Reviewed Layer-2 Segment 5B S1-S5 runner implementations (time grid, intensity, counts, arrivals, validation) plus dictionary entries to trace expected inputs/outputs and handoffs (packages/engine/src/engine/layers/l2/seg_5B/*; contracts/dataset_dictionary/l2/seg_5B/layer2.5B.yaml).
   - Reviewed Layer-3 Segment 6A S0-S5 runner implementations and dictionary to map priors/taxonomies, party/account/instrument/device/IP outputs, and validation bundle behaviour (packages/engine/src/engine/layers/l3/seg_6A/*; contracts/dataset_dictionary/l3/seg_6A/layer3.6A.yaml).
   - Reviewed Layer-3 Segment 6B S0-S5 runner implementations and dictionary to map arrival attachments, baseline flows, fraud overlays, labelling, and validation bundle behaviour (packages/engine/src/engine/layers/l3/seg_6B/*; contracts/dataset_dictionary/l3/seg_6B/layer3.6B.yaml).
   - Updated docs/reviews/engine_audit_2026-01-04.md with expanded 5A/5B/6A/6B implementation notes and new blockers (5B S4 indentation bug, 5B S2 latent_model_id=none hard fail, 6B S5 glob path validation failure, 6B missing case-timeline outputs, and policy-usage gaps).

* 9:46pm
   - Began planning discussion for segment-by-segment fixes starting with 1A (no code changes yet).

* 9:54pm
   - Consulted 1A S5 expanded spec to confirm merchant_currency optionality, iso_legal_tender dependency, precedence rules, and hard-fail conditions for missing settlement currency coverage (docs/model_spec/data-engine/layer-1/specs/state-flow/1A/state.1A.s5.expanded.md).

* 10:03pm
   - Drafted the Segment 1A fix plan to enforce strict validation bundle resolution and always-on merchant_currency with hard-fail coverage checks, including planned touch points in S2/S3/S4 bundle publishers, S5 currency runner, S6 loader fallback removal, and Makefile preflight checks for iso_legal_tender/settlement share references.

* 10:12pm
   - Added the detailed Segment 1A fix plan to the 1A subsection in docs/reviews/engine_audit_2026-01-04.md (strict validation bundle resolution, always-on merchant_currency, S6 fallback removal, and Makefile preflight wiring).

* 10:18pm
   - Reviewed Segment 1B dataset dictionary entries for s7_site_synthesis, s7_run_summary, and s8_run_summary to confirm partitioned paths.
   - Reviewed Segment 1B S7/S8 materialisers and validators to confirm run summary paths were derived from dataset_path.parent, dropping parameter_hash/fingerprint.
   - Added the Segment 1B fix plan to docs/reviews/engine_audit_2026-01-04.md to align run summary paths with dictionary entries.

* 10:24pm
   - Confirmed Segment 1B fix plan is documented; no implementation changes yet.

* 10:26pm
   - Drafted the Segment 2A fix plan in docs/reviews/engine_audit_2026-01-04.md, covering validation_bundle_1A dictionary alignment, S0GateError traceback handling, transaction_schema_merchant_ids resolution/preflight, and strict MCC overrides behavior.

* 10:28pm
   - Committed to making fix plans fail-fast and contract-driven (dictionary-only resolution, strict gate checks, and Makefile preflight for missing reference assets) to avoid repeated back-and-forth runs.

