# Logbook
### Date: 4th January 2026
### Project: Fraud Detection System
### Reference commits: Check commits on this date (if any)

* 12:33am
   - Fixed 5B.S4 site lookup join failure by normalizing join key dtypes (cast merchant_id to UInt64, site_order to UInt32, and ISO/tzid to Utf8) for both `s1_site_weights` and `site_timezones`, matching schema expectations and preventing u64â†”str join mismatches (`packages/engine/src/engine/layers/l2/seg_5B/s4_arrivals/runner.py`).

* 12:43am
   - Added 5B per-state resume support (S1-S4): new CLI flags (`--s1-resume`..`--s4-resume`), Makefile passthrough variables (`SEG5B_S1_RESUME`..`SEG5B_S4_RESUME`), and orchestrator logic to reuse existing outputs when present while preserving state dependency checks (`packages/engine/src/engine/cli/segment5b.py`, `packages/engine/src/engine/scenario_runner/l2_seg_5B.py`, `makefile`).

* 04:38am
   - Enforced 5B.S0 upstream bundle fingerprint matching and removed `source_manifest` overrides for sealed upstream datasets so Layer-2 uses the same manifest as Layer-1/5A, preventing mixed-manifest routing inputs such as `s4_group_weights` (`packages/engine/src/engine/layers/l2/seg_5B/s0_gate/runner.py`).

* 05:16am
   - Reviewed fingerprint divergence evidence from run receipts/manifests to answer the 5273d/707ef/d840a mapping request (no code changes).
   - Inspected `runs/local_full_run-3/data/layer1/1A/validation/fingerprint=5273d50c75db17b79a221cbff6b8cf50c6a1bb72dd2a1b7f287fd4bb3f307174/parameter_hash_resolved.json` for 1A policy bundle and parameter hash.
   - Inspected `runs/local_full_run-3/data/layer1/1A/validation/fingerprint=5273d50c75db17b79a221cbff6b8cf50c6a1bb72dd2a1b7f287fd4bb3f307174/MANIFEST.json` for 1A commit/seed/run_id details.
   - Inspected `runs/local_full_run-3/data/layer1/3A/s0_gate_receipt/fingerprint=707ef17ae102def525749d0aabf1c10b5c44cd349e15f4a9ef6e04bb03d75b72/s0_gate_receipt_3A.json` and `runs/local_full_run-3/data/layer1/3A/validation/fingerprint=707ef17ae102def525749d0aabf1c10b5c44cd349e15f4a9ef6e04bb03d75b72/index.json` for 3A manifest/parameter hash and sealed policy set.
   - Inspected `runs/local_full_run-3/data/layer1/3B/s0_gate_receipt/fingerprint=d840a1bea1ee7279d4b253b1442f3e1893fe768a5bbbd9fc3e0cf6766d2dd4b1/s0_gate_receipt_3B.json` and `runs/local_full_run-3/data/layer1/3B/validation/fingerprint=d840a1bea1ee7279d4b253b1442f3e1893fe768a5bbbd9fc3e0cf6766d2dd4b1/s5_manifest_3B.json` for 3B manifest/parameter hash and sealed policy set.
   - Inspected `runs/local_full_run-3/data/layer2/5A/s0_gate_receipt/fingerprint=d840a1bea1ee7279d4b253b1442f3e1893fe768a5bbbd9fc3e0cf6766d2dd4b1/s0_gate_receipt_5A.json` and `runs/local_full_run-3/data/layer2/5B/s0_gate_receipt/fingerprint=d840a1bea1ee7279d4b253b1442f3e1893fe768a5bbbd9fc3e0cf6766d2dd4b1/s0_gate_receipt_5B.json` for downstream manifest alignment.

* 06:02am
   - Inspected tail of `runs/local_full_run-3/run_log_run-3.log` to locate 5B.S0 failure cause (upstream bundle fingerprint mismatch for 1A).

* 06:34am
   - Audited S0 state-expanded specs for segments 1A-6B to confirm fingerprint semantics: only 1A computes `parameter_hash`/`manifest_fingerprint`; all other segments are required to accept the caller-provided identity and only verify upstream gates (state-flow docs: `docs/model_spec/data-engine/layer-1/specs/state-flow/1A/state.1A.s0.expanded.md`, `docs/model_spec/data-engine/layer-1/specs/state-flow/1B/state.1B.s0.expanded.md`, `docs/model_spec/data-engine/layer-1/specs/state-flow/2A/state.2A.s0.expanded.md`, `docs/model_spec/data-engine/layer-1/specs/state-flow/2B/state.2B.s0.expanded.md`, `docs/model_spec/data-engine/layer-1/specs/state-flow/3A/state.3A.s0.expanded.md`, `docs/model_spec/data-engine/layer-1/specs/state-flow/3B/state.3B.s0.expanded.md`, `docs/model_spec/data-engine/layer-2/specs/state-flow/5A/state.5A.s0.expanded.md`, `docs/model_spec/data-engine/layer-2/specs/state-flow/5B/state.5B.s0.expanded.md`, `docs/model_spec/data-engine/layer-3/specs/state-flow/6A/state.6A.s0.expanded.md`, `docs/model_spec/data-engine/layer-3/specs/state-flow/6B/state.6B.s0.expanded.md`).
   - Searched S0 implementations for fingerprint computation; `compute_manifest_fingerprint(...)` appears in 1A S0 (expected) but also in 3A/3B S0 gate runners (unexpected vs spec), which can recompute the manifest and diverge from the caller-provided fingerprint (`packages/engine/src/engine/layers/l1/seg_1A/s0_foundations/l2/runner.py`, `packages/engine/src/engine/layers/l1/seg_3A/s0_gate/l2/runner.py`, `packages/engine/src/engine/layers/l1/seg_3B/s0_gate/l2/runner.py`).
   - Verified what ran in `runs/local_full_run-3` by listing validation bundles: 1A/1B/2A/2B share `fingerprint=8e4aa16116b4365834ea6b81046ccfa06b11a3160e8388af813df3b50ffb071f`, 3A uses `fingerprint=3ebf381338a8a3ac82e1ebbba748a04b6c8672294a6d85ccf6dd1b6db7b9fc6c`, 3B and 5A use `fingerprint=168233adb8d6f441df8336b3bd6a1397575bb72fb77fd5031b191d6baa053de6`, and 5B has no validation bundle yet (missing `runs/local_full_run-3/data/layer2/5B/validation`).
