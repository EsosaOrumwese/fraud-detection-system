# Logbook
### Date: 1st January 2026
### Project: Fraud Detection System
### Reference commits: Check commits on this date (if any)

* 12:07am
   - Began 1A audit per the new audit-and-fix workflow (read the 1A guide order, artefact registry, and expanded S0 spec to establish authoritative inputs and invariants).
   - Inspected 1A S0 foundations runner to understand current parameter hash + manifest fingerprint inputs, run_id derivation, and output bundling paths.

* 12:14am
   - Audited 1A S0/S5/S6/S7 runtime paths and governance usage against specs and registries; noted mismatches in parameter_hash composition, output/validation bundle paths, RNG log paths, residual quantisation policy usage, S2 validation policy usage, and share-surface vintages (details reported to user).

* 12:29am
   - Audited 1A.S0 by reading `docs/model_spec/data-engine/layer-1/specs/state-flow/1A/state.1A.s0.expanded.md`, `packages/engine/src/engine/layers/l1/seg_1A/s0_foundations/l2/runner.py`, `packages/engine/src/engine/layers/l1/seg_1A/s0_foundations/l2/output.py`, `packages/engine/src/engine/layers/l1/seg_1A/s0_foundations/l2/rng_logging.py`, and `packages/engine/src/engine/layers/l1/seg_1A/s0_foundations/l1/hashing.py`.
   - [TODO] Parameter hash excludes `ccy_smoothing_params.yaml` and `s6_selection_policy.yaml` (spec S0.2.2 requires both); `_REQUIRED_PARAMETER_FILES` only includes hurdle/dispersion/crossborder files, so `parameter_hash_resolved.json` is incomplete (`packages/engine/src/engine/layers/l1/seg_1A/s0_foundations/l2/runner.py`).
   - [TODO] `numeric_policy.json` and `math_profile_manifest.json` are optional inputs; spec makes them mandatory and requires `numeric_policy_attest.json` to be emitted and fingerprinted (S0.8/0.2). Engine only writes attestation when both optional inputs are provided (`packages/engine/src/engine/layers/l1/seg_1A/s0_foundations/l2/runner.py`, `packages/engine/src/engine/layers/l1/seg_1A/s0_foundations/l2/output.py`).
   - [TODO] Manifest fingerprint enumeration is manual (`manifest_artifacts` from `run_from_paths`) instead of registry closure; missing inputs can slip through (spec expects full artefact closure for S0.2.3) (`packages/engine/src/engine/layers/l1/seg_1A/s0_foundations/l2/runner.py`).
   - [TODO] Parameter-scoped outputs are written under `parameter_scoped/parameter_hash=...` instead of registry paths like `data/layer1/1A/<dataset>/parameter_hash=...` (`packages/engine/src/engine/layers/l1/seg_1A/s0_foundations/l2/output.py`).
   - [TODO] Validation bundle is emitted under `validation_bundle/` (no fingerprint partition) instead of `data/layer1/1A/validation/fingerprint={manifest_fingerprint}` (`packages/engine/src/engine/layers/l1/seg_1A/s0_foundations/l2/output.py`).
   - [TODO] Validation failures are written under `validation_failures/` rather than `data/layer1/1A/validation/failures/...` (spec path) (`packages/engine/src/engine/layers/l1/seg_1A/s0_foundations/l2/failure.py`).
   - [TODO] RNG audit/trace/event logs are rooted at `rng_logs/` (spec requires `logs/rng/...`) and audit payload omits required schema fields (`ts_utc`, `build_commit`) while adding non-schema fields (`rng_key`, nested counters) (`packages/engine/src/engine/layers/l1/seg_1A/s0_foundations/l2/output.py`, `packages/engine/src/engine/layers/l1/seg_1A/s0_foundations/l2/rng_logging.py`).
   - [TODO] RNG trace records embed `parameter_hash` and `manifest_fingerprint` and serialize `draws_total` as string; schema forbids extra properties and expects uint64 totals (spec S0.2.6) (`packages/engine/src/engine/layers/l1/seg_1A/s0_foundations/l2/rng_logging.py`).
   - [TODO] `run_id` uniqueness guard is not enforced because `existing_ids` is never passed to `compute_run_id` (spec requires bounded collision loop) (`packages/engine/src/engine/layers/l1/seg_1A/s0_foundations/l2/runner.py`).

* 12:36am
   - Audited 1A.S1 by reading `packages/engine/src/engine/layers/l1/seg_1A/s1_hurdle/l2/runner.py` and `packages/engine/src/engine/layers/l1/seg_1A/s1_hurdle/l2/output.py` against `schemas.layer1.yaml#/rng/core/rng_trace_log`.
   - [TODO] `_ensure_audit_exists` accepts legacy `rng_logs/.../rng_audit_log.json` path; spec wants `logs/rng/audit/.../rng_audit_log.jsonl` only (`packages/engine/src/engine/layers/l1/seg_1A/s1_hurdle/l2/runner.py`).
   - [TODO] `rng_trace_log` rows include `parameter_hash` and `manifest_fingerprint`, which are not permitted by schema (parameter_hash is path-only per spec) (`packages/engine/src/engine/layers/l1/seg_1A/s1_hurdle/l2/output.py`).

* 12:42am
   - Audited 1A.S2 by reading `packages/engine/src/engine/layers/l1/seg_1A/s2_nb_outlets/l2/output.py` and schema `schemas.layer1.yaml#/rng/core/rng_trace_log`.
   - [TODO] `rng_trace_log` rows embed `parameter_hash` and `manifest_fingerprint` (schema forbids extras; parameter_hash should be path-only) (`packages/engine/src/engine/layers/l1/seg_1A/s2_nb_outlets/l2/output.py`).

* 12:49am
   - Audited 1A.S3 by reading `packages/engine/src/engine/layers/l1/seg_1A/s3_crossborder_universe/l0/policy.py`, `.../l1/kernels.py`, and the 1A authoring guides for rule ladder/base-weight/thresholds.
   - [TODO] Rule ladder loader expects `named_sets` with `countries` and string predicates plus `admit_named_sets`/`deny_named_sets`; authoring guide specifies `country_sets`, structured predicate `op` objects, `admit_sets`/`deny_sets`, and `reason_code_to_rule_id`, so current parser will reject spec-compliant policies (`packages/engine/src/engine/layers/l1/seg_1A/s3_crossborder_universe/l0/policy.py`).
   - [TODO] Base-weight policy parser expects `constants` + `selection_rules` (+ optional `normalisation`), which conflicts with spec v1 log-linear `model`/`coeffs` shape (`packages/engine/src/engine/layers/l1/seg_1A/s3_crossborder_universe/l0/policy.py`).
   - [TODO] Thresholds policy parser expects `dp_resid`/`floors`/`ceilings` (or legacy `integerisation`), not the authoring-guide `policy.s3.thresholds.yaml` shape, so current policies will fail to load (`packages/engine/src/engine/layers/l1/seg_1A/s3_crossborder_universe/l0/policy.py`).
   - [TODO] `crossborder_features` external (1A guide) is not referenced anywhere in engine code (rg found no usage), so the derived artefact is currently unused by 1A (`packages/engine/src/engine`).

* 12:56am
   - Audited 1A.S4 by reading `packages/engine/src/engine/layers/l1/seg_1A/s4_ztp_target/l0/writer.py`, `.../l2/runner.py`, and `schemas.layer1.yaml#/rng/events/ztp_*`.
   - [TODO] ZTP events use `substream_label="poisson_component"` for all streams; schema requires `ztp_final` to use `substream_label=ztp_final` (spec/schema mismatch to resolve) (`packages/engine/src/engine/layers/l1/seg_1A/s4_ztp_target/l0/constants.py`, `.../l0/writer.py`).
   - [TODO] `ztp_rejection` and `ztp_retry_exhausted` payloads include `context`, but schemas for those events disallow it (additionalProperties=false) (`packages/engine/src/engine/layers/l1/seg_1A/s4_ztp_target/l0/writer.py`).
   - [TODO] `ztp_retry_exhausted` uses variable `attempts` and `aborted` values; schema requires `attempts=64` and `aborted=true` (const) (`packages/engine/src/engine/layers/l1/seg_1A/s4_ztp_target/l0/writer.py`).
   - [TODO] `rng_trace_log` rows embed `parameter_hash` and `manifest_fingerprint` (schema forbids extras; parameter_hash should be path-only) (`packages/engine/src/engine/layers/l1/seg_1A/s4_ztp_target/l0/writer.py`).

* 1:04am
   - Audited 1A.S5 by reading `packages/engine/src/engine/layers/l1/seg_1A/s5_currency_weights/runner.py` and `.../loader.py` against 1A S5 intake specs.
   - [TODO] RNG-free check reads `rng_logs/.../trace` instead of `logs/rng/...`, so RNG interaction checks can miss/false-negative (`packages/engine/src/engine/layers/l1/seg_1A/s5_currency_weights/runner.py`).
   - [TODO] Default share-surface paths are pinned to `2025-10-26` rather than `2024Q4` vintages required by the intake guides (`packages/engine/src/engine/layers/l1/seg_1A/s5_currency_weights/loader.py`).

* 1:11am
   - Audited 1A.S6 by reading `packages/engine/src/engine/layers/l1/seg_1A/s6_foreign_selection/policy.py`, `.../writer.py`, and `schemas.layer1.yaml#/rng/events/gumbel_key`.
   - [TODO] S6 policy loader expects `policy_semver`/`policy_version` and requires `per_currency`, while authoring guide uses `semver`/`version` and allows optional `per_currency` (shape mismatch) (`packages/engine/src/engine/layers/l1/seg_1A/s6_foreign_selection/policy.py`).
   - [TODO] `gumbel_key` events omit required `u`/`key` when values are `None` and do not enforce blocks/draws=1; schema requires `u` and `key` (key=null allowed when weight=0) and fixed budgets (`packages/engine/src/engine/layers/l1/seg_1A/s6_foreign_selection/writer.py`).
   - [TODO] Extra per-module trace log under `logs/rng/trace/gumbel_key/...` is not defined in the registry (`packages/engine/src/engine/layers/l1/seg_1A/s6_foreign_selection/writer.py`).
   - [TODO] `rng_trace_log` rows embed `parameter_hash` and `manifest_fingerprint` (schema forbids extras; parameter_hash should be path-only) (`packages/engine/src/engine/layers/l1/seg_1A/s6_foreign_selection/writer.py`).

* 1:18am
   - Audited 1A.S7 by reading `packages/engine/src/engine/layers/l1/seg_1A/s7_integer_allocation/kernel.py`, `.../policy.py`, and `.../writer.py`.
   - [TODO] Residual quantisation ignores `config/numeric/residual_quantisation.yaml` and hard-codes `DP_RESID=8`; no reference to the authored policy exists (spec requires policy-driven quantisation) (`packages/engine/src/engine/layers/l1/seg_1A/s7_integer_allocation/kernel.py`).
   - [TODO] Integerisation policy loader expects `policy_semver`/`policy_version` + `dirichlet_lane`/`bounds_lane` (with separate bounds policy), which does not match the authoring guides for `policy.s3.thresholds.yaml` and `dirichlet_alpha_policy` (`packages/engine/src/engine/layers/l1/seg_1A/s7_integer_allocation/policy.py`).
   - [TODO] `rng_trace_log` rows include `parameter_hash` and `manifest_fingerprint`, and serialize `draws_total`/`blocks_total` as strings (schema expects uint64 numbers and no extra properties) (`packages/engine/src/engine/layers/l1/seg_1A/s7_integer_allocation/writer.py`).

* 1:25am
   - Audited 1A.S8 by reading `packages/engine/src/engine/layers/l1/seg_1A/s8_outlet_catalogue/persist.py`, `.../types.py`, `.../runner.py`, and schemas for `sequence_finalize`/`site_sequence_overflow`.
   - [TODO] `sequence_finalize` payload uses `legal_country_iso` and `site_order_start/site_order_end` (ints) instead of schema-required `country_iso` and `start_sequence/end_sequence` (six-digit strings) (`packages/engine/src/engine/layers/l1/seg_1A/s8_outlet_catalogue/types.py`, `.../persist.py`).
   - [TODO] `site_sequence_overflow` payload uses `legal_country_iso` and includes `manifest_fingerprint` extra field; schema requires `country_iso` and forbids extra properties (`packages/engine/src/engine/layers/l1/seg_1A/s8_outlet_catalogue/persist.py`).
   - [TODO] `rng_trace_log` rows embed `parameter_hash`/`manifest_fingerprint` and set `draws_total`/`blocks_total` as strings (`schemas.layer1.yaml#/rng/core/rng_trace_log` expects uint64 and no extra properties) (`packages/engine/src/engine/layers/l1/seg_1A/s8_outlet_catalogue/persist.py`).
   - [TODO] Validation bundle path is resolved via dataset id `validation_bundle` (not `validation_bundle_1A` in the dictionary), risking wrong or missing output location (`packages/engine/src/engine/layers/l1/seg_1A/s8_outlet_catalogue/runner.py`).
   - [TODO] `_passed.flag` uses `sha256_hex = ...` (with spaces) via shared helper, inconsistent with S5/S6 receipts and likely schema expectations (`packages/engine/src/engine/layers/l1/seg_1A/s0_foundations/l2/output.py`, `packages/engine/src/engine/layers/l1/seg_1A/s8_outlet_catalogue/persist.py`).

* 1:32am
   - Audited 1A.S9 by reading `packages/engine/src/engine/layers/l1/seg_1A/s9_validation/loader.py`, `.../persist.py`, and `.../runner.py`.
   - [TODO] Upstream manifest lookup uses `validation_bundle/manifest_fingerprint=...` but S0 writes `validation_bundle/` without fingerprint and S9 outputs go to `data/layer1/1A/validation/fingerprint=...` (path mismatch will hide upstream lineage) (`packages/engine/src/engine/layers/l1/seg_1A/s9_validation/loader.py`).
   - [TODO] `_passed.flag` format uses `sha256_hex = {digest}` (spaces), while S6/S5 receipts and loaders expect `sha256_hex=`; align format for validation gating (`packages/engine/src/engine/layers/l1/seg_1A/s9_validation/persist.py`).
   - [TODO] S9 expects RNG audit/trace logs under `logs/rng/...`; S0 currently writes `rng_logs/...`, so S9 will not find audit/trace inputs unless paths are aligned (`packages/engine/src/engine/layers/l1/seg_1A/s9_validation/loader.py`, `packages/engine/src/engine/layers/l1/seg_1A/s0_foundations/l2/rng_logging.py`).
