# Logbook
### Date: 1st January 2026
### Project: Fraud Detection System
### Reference commits: Check commits on this date (if any)

* 12:07am
   - Began 1A audit per the new audit-and-fix workflow (read the 1A guide order, artefact registry, and expanded S0 spec to establish authoritative inputs and invariants).
   - Inspected 1A S0 foundations runner to understand current parameter hash + manifest fingerprint inputs, run_id derivation, and output bundling paths.

* 12:14am
   - Audited 1A S0/S5/S6/S7 runtime paths and governance usage against specs and registries; noted mismatches in parameter_hash composition, output/validation bundle paths, RNG log paths, residual quantisation policy usage, S2 validation policy usage, and share-surface vintages (details reported to user).

* 12:29am
   - Audited 1A.S0 by reading `docs/model_spec/data-engine/layer-1/specs/state-flow/1A/state.1A.s0.expanded.md`, `packages/engine/src/engine/layers/l1/seg_1A/s0_foundations/l2/runner.py`, `packages/engine/src/engine/layers/l1/seg_1A/s0_foundations/l2/output.py`, `packages/engine/src/engine/layers/l1/seg_1A/s0_foundations/l2/rng_logging.py`, and `packages/engine/src/engine/layers/l1/seg_1A/s0_foundations/l1/hashing.py`.
   - [TODO] Parameter hash excludes `ccy_smoothing_params.yaml` and `s6_selection_policy.yaml` (spec S0.2.2 requires both); `_REQUIRED_PARAMETER_FILES` only includes hurdle/dispersion/crossborder files, so `parameter_hash_resolved.json` is incomplete (`packages/engine/src/engine/layers/l1/seg_1A/s0_foundations/l2/runner.py`).
   - [TODO] `numeric_policy.json` and `math_profile_manifest.json` are optional inputs; spec makes them mandatory and requires `numeric_policy_attest.json` to be emitted and fingerprinted (S0.8/0.2). Engine only writes attestation when both optional inputs are provided (`packages/engine/src/engine/layers/l1/seg_1A/s0_foundations/l2/runner.py`, `packages/engine/src/engine/layers/l1/seg_1A/s0_foundations/l2/output.py`).
   - [TODO] Manifest fingerprint enumeration is manual (`manifest_artifacts` from `run_from_paths`) instead of registry closure; missing inputs can slip through (spec expects full artefact closure for S0.2.3) (`packages/engine/src/engine/layers/l1/seg_1A/s0_foundations/l2/runner.py`).
   - [TODO] Parameter-scoped outputs are written under `parameter_scoped/parameter_hash=...` instead of registry paths like `data/layer1/1A/<dataset>/parameter_hash=...` (`packages/engine/src/engine/layers/l1/seg_1A/s0_foundations/l2/output.py`).
   - [TODO] Validation bundle is emitted under `validation_bundle/` (no fingerprint partition) instead of `data/layer1/1A/validation/fingerprint={manifest_fingerprint}` (`packages/engine/src/engine/layers/l1/seg_1A/s0_foundations/l2/output.py`).
   - [TODO] Validation failures are written under `validation_failures/` rather than `data/layer1/1A/validation/failures/...` (spec path) (`packages/engine/src/engine/layers/l1/seg_1A/s0_foundations/l2/failure.py`).
   - [TODO] RNG audit/trace/event logs are rooted at `rng_logs/` (spec requires `logs/rng/...`) and audit payload omits required schema fields (`ts_utc`, `build_commit`) while adding non-schema fields (`rng_key`, nested counters) (`packages/engine/src/engine/layers/l1/seg_1A/s0_foundations/l2/output.py`, `packages/engine/src/engine/layers/l1/seg_1A/s0_foundations/l2/rng_logging.py`).
   - [TODO] RNG trace records embed `parameter_hash` and `manifest_fingerprint` and serialize `draws_total` as string; schema forbids extra properties and expects uint64 totals (spec S0.2.6) (`packages/engine/src/engine/layers/l1/seg_1A/s0_foundations/l2/rng_logging.py`).
   - [TODO] `run_id` uniqueness guard is not enforced because `existing_ids` is never passed to `compute_run_id` (spec requires bounded collision loop) (`packages/engine/src/engine/layers/l1/seg_1A/s0_foundations/l2/runner.py`).

* 12:36am
   - Audited 1A.S1 by reading `packages/engine/src/engine/layers/l1/seg_1A/s1_hurdle/l2/runner.py` and `packages/engine/src/engine/layers/l1/seg_1A/s1_hurdle/l2/output.py` against `schemas.layer1.yaml#/rng/core/rng_trace_log`.
   - [TODO] `_ensure_audit_exists` accepts legacy `rng_logs/.../rng_audit_log.json` path; spec wants `logs/rng/audit/.../rng_audit_log.jsonl` only (`packages/engine/src/engine/layers/l1/seg_1A/s1_hurdle/l2/runner.py`).
   - [TODO] `rng_trace_log` rows include `parameter_hash` and `manifest_fingerprint`, which are not permitted by schema (parameter_hash is path-only per spec) (`packages/engine/src/engine/layers/l1/seg_1A/s1_hurdle/l2/output.py`).

* 12:42am
   - Audited 1A.S2 by reading `packages/engine/src/engine/layers/l1/seg_1A/s2_nb_outlets/l2/output.py` and schema `schemas.layer1.yaml#/rng/core/rng_trace_log`.
   - [TODO] `rng_trace_log` rows embed `parameter_hash` and `manifest_fingerprint` (schema forbids extras; parameter_hash should be path-only) (`packages/engine/src/engine/layers/l1/seg_1A/s2_nb_outlets/l2/output.py`).

* 12:49am
   - Audited 1A.S3 by reading `packages/engine/src/engine/layers/l1/seg_1A/s3_crossborder_universe/l0/policy.py`, `.../l1/kernels.py`, and the 1A authoring guides for rule ladder/base-weight/thresholds.
   - [TODO] Rule ladder loader expects `named_sets` with `countries` and string predicates plus `admit_named_sets`/`deny_named_sets`; authoring guide specifies `country_sets`, structured predicate `op` objects, `admit_sets`/`deny_sets`, and `reason_code_to_rule_id`, so current parser will reject spec-compliant policies (`packages/engine/src/engine/layers/l1/seg_1A/s3_crossborder_universe/l0/policy.py`).
   - [TODO] Base-weight policy parser expects `constants` + `selection_rules` (+ optional `normalisation`), which conflicts with spec v1 log-linear `model`/`coeffs` shape (`packages/engine/src/engine/layers/l1/seg_1A/s3_crossborder_universe/l0/policy.py`).
   - [TODO] Thresholds policy parser expects `dp_resid`/`floors`/`ceilings` (or legacy `integerisation`), not the authoring-guide `policy.s3.thresholds.yaml` shape, so current policies will fail to load (`packages/engine/src/engine/layers/l1/seg_1A/s3_crossborder_universe/l0/policy.py`).
   - [TODO] `crossborder_features` external (1A guide) is not referenced anywhere in engine code (rg found no usage), so the derived artefact is currently unused by 1A (`packages/engine/src/engine`).

* 12:56am
   - Audited 1A.S4 by reading `packages/engine/src/engine/layers/l1/seg_1A/s4_ztp_target/l0/writer.py`, `.../l2/runner.py`, and `schemas.layer1.yaml#/rng/events/ztp_*`.
   - [TODO] ZTP events use `substream_label="poisson_component"` for all streams; schema requires `ztp_final` to use `substream_label=ztp_final` (spec/schema mismatch to resolve) (`packages/engine/src/engine/layers/l1/seg_1A/s4_ztp_target/l0/constants.py`, `.../l0/writer.py`).
   - [TODO] `ztp_rejection` and `ztp_retry_exhausted` payloads include `context`, but schemas for those events disallow it (additionalProperties=false) (`packages/engine/src/engine/layers/l1/seg_1A/s4_ztp_target/l0/writer.py`).
   - [TODO] `ztp_retry_exhausted` uses variable `attempts` and `aborted` values; schema requires `attempts=64` and `aborted=true` (const) (`packages/engine/src/engine/layers/l1/seg_1A/s4_ztp_target/l0/writer.py`).
   - [TODO] `rng_trace_log` rows embed `parameter_hash` and `manifest_fingerprint` (schema forbids extras; parameter_hash should be path-only) (`packages/engine/src/engine/layers/l1/seg_1A/s4_ztp_target/l0/writer.py`).

* 1:04am
   - Audited 1A.S5 by reading `packages/engine/src/engine/layers/l1/seg_1A/s5_currency_weights/runner.py` and `.../loader.py` against 1A S5 intake specs.
   - [TODO] RNG-free check reads `rng_logs/.../trace` instead of `logs/rng/...`, so RNG interaction checks can miss/false-negative (`packages/engine/src/engine/layers/l1/seg_1A/s5_currency_weights/runner.py`).
   - [TODO] Default share-surface paths are pinned to `2025-10-26` rather than `2024Q4` vintages required by the intake guides (`packages/engine/src/engine/layers/l1/seg_1A/s5_currency_weights/loader.py`).

* 1:11am
   - Audited 1A.S6 by reading `packages/engine/src/engine/layers/l1/seg_1A/s6_foreign_selection/policy.py`, `.../writer.py`, and `schemas.layer1.yaml#/rng/events/gumbel_key`.
   - [TODO] S6 policy loader expects `policy_semver`/`policy_version` and requires `per_currency`, while authoring guide uses `semver`/`version` and allows optional `per_currency` (shape mismatch) (`packages/engine/src/engine/layers/l1/seg_1A/s6_foreign_selection/policy.py`).
   - [TODO] `gumbel_key` events omit required `u`/`key` when values are `None` and do not enforce blocks/draws=1; schema requires `u` and `key` (key=null allowed when weight=0) and fixed budgets (`packages/engine/src/engine/layers/l1/seg_1A/s6_foreign_selection/writer.py`).
   - [TODO] Extra per-module trace log under `logs/rng/trace/gumbel_key/...` is not defined in the registry (`packages/engine/src/engine/layers/l1/seg_1A/s6_foreign_selection/writer.py`).
   - [TODO] `rng_trace_log` rows embed `parameter_hash` and `manifest_fingerprint` (schema forbids extras; parameter_hash should be path-only) (`packages/engine/src/engine/layers/l1/seg_1A/s6_foreign_selection/writer.py`).

* 1:18am
   - Audited 1A.S7 by reading `packages/engine/src/engine/layers/l1/seg_1A/s7_integer_allocation/kernel.py`, `.../policy.py`, and `.../writer.py`.
   - [TODO] Residual quantisation ignores `config/numeric/residual_quantisation.yaml` and hard-codes `DP_RESID=8`; no reference to the authored policy exists (spec requires policy-driven quantisation) (`packages/engine/src/engine/layers/l1/seg_1A/s7_integer_allocation/kernel.py`).
   - [TODO] Integerisation policy loader expects `policy_semver`/`policy_version` + `dirichlet_lane`/`bounds_lane` (with separate bounds policy), which does not match the authoring guides for `policy.s3.thresholds.yaml` and `dirichlet_alpha_policy` (`packages/engine/src/engine/layers/l1/seg_1A/s7_integer_allocation/policy.py`).
   - [TODO] `rng_trace_log` rows include `parameter_hash` and `manifest_fingerprint`, and serialize `draws_total`/`blocks_total` as strings (schema expects uint64 numbers and no extra properties) (`packages/engine/src/engine/layers/l1/seg_1A/s7_integer_allocation/writer.py`).

* 1:25am
   - Audited 1A.S8 by reading `packages/engine/src/engine/layers/l1/seg_1A/s8_outlet_catalogue/persist.py`, `.../types.py`, `.../runner.py`, and schemas for `sequence_finalize`/`site_sequence_overflow`.
   - [TODO] `sequence_finalize` payload uses `legal_country_iso` and `site_order_start/site_order_end` (ints) instead of schema-required `country_iso` and `start_sequence/end_sequence` (six-digit strings) (`packages/engine/src/engine/layers/l1/seg_1A/s8_outlet_catalogue/types.py`, `.../persist.py`).
   - [TODO] `site_sequence_overflow` payload uses `legal_country_iso` and includes `manifest_fingerprint` extra field; schema requires `country_iso` and forbids extra properties (`packages/engine/src/engine/layers/l1/seg_1A/s8_outlet_catalogue/persist.py`).
   - [TODO] `rng_trace_log` rows embed `parameter_hash`/`manifest_fingerprint` and set `draws_total`/`blocks_total` as strings (`schemas.layer1.yaml#/rng/core/rng_trace_log` expects uint64 and no extra properties) (`packages/engine/src/engine/layers/l1/seg_1A/s8_outlet_catalogue/persist.py`).
   - [TODO] Validation bundle path is resolved via dataset id `validation_bundle` (not `validation_bundle_1A` in the dictionary), risking wrong or missing output location (`packages/engine/src/engine/layers/l1/seg_1A/s8_outlet_catalogue/runner.py`).
   - [TODO] `_passed.flag` uses `sha256_hex = ...` (with spaces) via shared helper, inconsistent with S5/S6 receipts and likely schema expectations (`packages/engine/src/engine/layers/l1/seg_1A/s0_foundations/l2/output.py`, `packages/engine/src/engine/layers/l1/seg_1A/s8_outlet_catalogue/persist.py`).

* 1:32am
   - Audited 1A.S9 by reading `packages/engine/src/engine/layers/l1/seg_1A/s9_validation/loader.py`, `.../persist.py`, and `.../runner.py`.
   - [TODO] Upstream manifest lookup uses `validation_bundle/manifest_fingerprint=...` but S0 writes `validation_bundle/` without fingerprint and S9 outputs go to `data/layer1/1A/validation/fingerprint=...` (path mismatch will hide upstream lineage) (`packages/engine/src/engine/layers/l1/seg_1A/s9_validation/loader.py`).
   - [TODO] `_passed.flag` format uses `sha256_hex = {digest}` (spaces), while S6/S5 receipts and loaders expect `sha256_hex=`; align format for validation gating (`packages/engine/src/engine/layers/l1/seg_1A/s9_validation/persist.py`).
   - [TODO] S9 expects RNG audit/trace logs under `logs/rng/...`; S0 currently writes `rng_logs/...`, so S9 will not find audit/trace inputs unless paths are aligned (`packages/engine/src/engine/layers/l1/seg_1A/s9_validation/loader.py`, `packages/engine/src/engine/layers/l1/seg_1A/s0_foundations/l2/rng_logging.py`).

* 12:58am
   - Reviewed Cross-cutting Rails + the pinned contracts set under `docs/model_spec/observability_and_governance/cross_cutting_rails/` and marked the package "green for now" (cleanup deferred).
   - [TODO] Cross-cutting Rails - path canonicalisation
      - Update the “Canonical path” + “Companion contracts” declarations inside `cross_cutting_rails.md` to the actual repo roots:
         - `docs/model_spec/observability_and_governance/cross_cutting_rails/cross_cutting_rails.md`
         - `docs/model_spec/observability_and_governance/cross_cutting_rails/contracts/`
      - Update any anchor-link examples in the doc that still reference the old root (`docs/model_spec/cross_cutting_rails/...`).
   - [TODO] Schemas — `$id` / `$ref` root alignment (ALL contracts)
      - For every contract in `contracts/` (`id_types`, `canonical_event_envelope`, `run_record`, `hashgate_receipt`, `ingestion_receipt`):
         - Rewrite `$id` to the actual repo path under `docs/model_spec/observability_and_governance/cross_cutting_rails/contracts/...`.
         - Rewrite all `$ref` targets that still point at `docs/model_spec/cross_cutting_rails/contracts/...` to the new root.
   - [TODO] Rails text vs schema — degrade mode wording (verify)
      - Verify `platform.degrade_mode` wording in `cross_cutting_rails.md` matches the envelope schema restriction (canonical enum only).
      - If components need extra detail, require it under a namespaced key (e.g., `component.<name>.degrade_detail`) instead of loosening `platform.degrade_mode`.
   - [TODO] Informative examples — `schema_ref` strings (cleanup for consistency)
      - In Appendix B ingestion receipt examples, update any remaining `schema_ref` strings that still point at `docs/model_spec/control_and_ingress/ingestion_gate/contracts/...` so they point at the Rails contract path under `observability_and_governance/cross_cutting_rails/contracts/...` (or explicitly document ingestion_gate as a strict re-export, and keep only one authoritative source).
   - [TODO] Receipt example vs schema - idempotency conflict field alignment
      - Appendix B uses `conflict.existing_receipt_id`, but the binding `ingestion_receipt` schema currently only permits `existing_receipt_ref`.
      - Align by either (A) adding optional `existing_receipt_id` to the schema conflict object, or (B) changing the example to `existing_receipt_ref`.

* 1:05am
   - Began 1B audit: reviewed `docs/model_spec/data-engine/layer-1/specs/contracts/1B/artefact_registry_1B.yaml`, `contracts/dataset_dictionary/l1/seg_1B/layer1.1B.yaml`, and `docs/model_spec/data-engine/layer-1/specs/state-flow/1B/state.1B.s0.expanded.md`; inspected S0 gate code in `packages/engine/src/engine/layers/l1/seg_1B/s0_gate/`.
   - [TODO] S0 spec requires verifying sealed-input coverage against the license map; S0 gate does not check `licenses/license_map.yaml` or `LICENSES/` coverage before issuing the receipt (`packages/engine/src/engine/layers/l1/seg_1B/s0_gate/l1/verification.py`).

* 1:05am
   - Audited 1B.S1 by reading `docs/model_spec/data-engine/layer-1/specs/state-flow/1B/state.1B.s1.expanded.md` and `packages/engine/src/engine/layers/l1/seg_1B/s1_tile_index/l2/runner.py`.
   - [TODO] S1 run report emits PAT baselines as `None` and omits required `io_baseline_*`, `max_worker_rss_bytes`, `open_files_peak` measurements; spec requires these counters for acceptance (S1 §9.5) (`packages/engine/src/engine/layers/l1/seg_1B/s1_tile_index/l2/runner.py`).
   - [TODO] `bytes_read_raster_total` / `bytes_read_vectors_total` are derived from file sizes, not actual bytes read during streaming; spec requires true I/O counters for PAT amplification checks (S1 §9.5) (`packages/engine/src/engine/layers/l1/seg_1B/s1_tile_index/l2/runner.py`).
   - [TODO] Failure event emission (`S1_ERROR` schema) is not implemented; spec requires a structured failure event on any error (S1 §9.6).
   - [TODO] Per-country summaries are skipped when `cells_visited == 0`, so countries with zero-coverage are omitted and `countries_total` becomes `len(summaries)` instead of ISO entries visited (S1 §9.2/§9.3) (`packages/engine/src/engine/layers/l1/seg_1B/s1_tile_index/l2/runner.py`).
   - [TODO] Observability artefacts are written to a literal `reports/l1/s1_tile_index/...` path rather than resolved via a dictionary entry; spec says evidence I/O must follow Dictionary resolution (S1 §10.1) (`packages/engine/src/engine/layers/l1/seg_1B/s1_tile_index/l2/runner.py`).

* 1:05am
   - Audited 1B.S2 by reading `docs/model_spec/data-engine/layer-1/specs/state-flow/1B/state.1B.s2.expanded.md` and `packages/engine/src/engine/layers/l1/seg_1B/s2_tile_weights/l2/runner.py`.
   - [TODO] `tile_weights` schema mismatch: output includes `zero_mass_fallback` (extra) and omits required `basis` column while `columns_strict: true` expects only `{country_iso,tile_id,weight_fp,dp,basis}` (`packages/engine/src/engine/layers/l1/seg_1B/s2_tile_weights/l2/runner.py`).
   - [TODO] Run report `ingress_versions` omits required `world_countries` key (spec requires `{iso3166, world_countries, population_raster}`) (`packages/engine/src/engine/layers/l1/seg_1B/s2_tile_weights/l3/observability.py`).
   - [TODO] PAT baselines are not measured unless `measure_baselines()` is called; default run path leaves `io_baseline_*` unset, violating required counters (S2 §9.5) (`packages/engine/src/engine/layers/l1/seg_1B/s2_tile_weights/l2/runner.py`).
   - [TODO] Evidence paths for run report/summaries are hard-coded under `control/s2_tile_weights/...` rather than resolved via dictionary (spec requires dictionary-backed evidence paths or a documented dictionary entry) (`packages/engine/src/engine/layers/l1/seg_1B/s2_tile_weights/l2/runner.py`).
   - [TODO] Failure event emission (`S2_ERROR`) is not implemented; spec requires structured failure event output on errors (S2 §9.6).

* 1:05am
   - Audited 1B.S3 by reading `docs/model_spec/data-engine/layer-1/specs/state-flow/1B/state.1B.s3.expanded.md` and `packages/engine/src/engine/layers/l1/seg_1B/s3_requirements/`.
   - [TODO] Failure event emission (`S3_ERROR`) is not implemented; spec requires a structured failure event on any validation failure (S3 §10.6).
   - [TODO] Run report path is assembled literally under `control/s3_requirements/...` instead of using the dictionary entry for `s3_run_report`; spec mandates dictionary-based resolution for evidence paths (S3 §10.5) (`packages/engine/src/engine/layers/l1/seg_1B/s3_requirements/l2/materialise.py`).

* 1:05am
   - Audited 1B.S4 by reading `docs/model_spec/data-engine/layer-1/specs/state-flow/1B/state.1B.s4.expanded.md` and `packages/engine/src/engine/layers/l1/seg_1B/s4_alloc_plan/`.
   - [TODO] Residue tie-break is not fully deterministic: `np.argpartition` may pick arbitrary equal residues before lexsort, violating the spec’s strict tie-break by ascending `tile_id` (S4 §8.6) (`packages/engine/src/engine/layers/l1/seg_1B/s4_alloc_plan/l1/allocation.py`).

* 1:05am
   - Audited 1B.S5 by reading `docs/model_spec/data-engine/layer-1/specs/state-flow/1B/state.1B.s5.expanded.md` and `packages/engine/src/engine/layers/l1/seg_1B/s5_site_tile_assignment/`.
   - [TODO] RNG event module value is `"1B.s5_site_tile_assignment"` but schema requires `"1B.S5.assigner"`; this breaks `schemas.layer1.yaml#/rng/events/site_tile_assign` and downstream validation (`packages/engine/src/engine/layers/l1/seg_1B/s5_site_tile_assignment/l1/rng.py`, `.../l1/assignment.py`).
   - [TODO] Failure event emission (`S5_ERROR`) is not implemented; spec requires structured failure events (S5 §10.6).

* 1:05am
   - Audited 1B.S6 by reading `docs/model_spec/data-engine/layer-1/specs/state-flow/1B/state.1B.s6.expanded.md` and `packages/engine/src/engine/layers/l1/seg_1B/s6_site_jitter/`.
   - [TODO] RNG events include `attempt_index` and `accepted` fields not permitted by `schemas.layer1.yaml#/rng/events/in_cell_jitter` (unevaluatedProperties false) (`packages/engine/src/engine/layers/l1/seg_1B/s6_site_jitter/l1/jitter.py`).
   - [TODO] Failure event emission (`S6_ERROR`) is not implemented; spec requires structured failure events on errors (S6 §10.6).

* 1:05am
   - Audited 1B.S7 by reading `docs/model_spec/data-engine/layer-1/specs/state-flow/1B/state.1B.s7.expanded.md` and `packages/engine/src/engine/layers/l1/seg_1B/s7_site_synthesis/`.
   - No blocking TODOs found in S7 output schema/path usage; gate verification and dataset materialisation align with dictionary paths.

* 1:05am
   - Audited 1B.S8 by reading `docs/model_spec/data-engine/layer-1/specs/state-flow/1B/state.1B.s8.expanded.md` and `packages/engine/src/engine/layers/l1/seg_1B/s8_site_locations/`.
   - No blocking TODOs found in S8 output schema/path usage; site_locations path uses dictionary resolution and outputs are schema-aligned.

* 1:05am
   - Audited 1B.S9 by reading `docs/model_spec/data-engine/layer-1/specs/state-flow/1B/state.1B.s9.expanded.md` and `packages/engine/src/engine/layers/l1/seg_1B/s9_validation/`.
   - [TODO] Validation bundle `index.json` format does not match `schemas.1B.yaml#/validation/validation_bundle_1B.index_schema` (schema expects a table-like array with `artifact_id/kind/path/mime/notes`; code writes `{artifacts:[...], sha256_hex}` object) (`packages/engine/src/engine/layers/l1/seg_1B/s9_validation/runner.py`).
   - [TODO] `INDEX_SCHEMA_REF` points to `schemas.1A.yaml#/validation/validation_bundle.index_schema`; should reference 1B’s bundle index schema (or update spec to re-export) (`packages/engine/src/engine/layers/l1/seg_1B/s9_validation/constants.py`).
   - [TODO] RNG validator expects module `"1B.s5_site_tile_assignment"` which aligns with current code but conflicts with schema-required `"1B.S5.assigner"`; align S5 module or update validator/spec (`packages/engine/src/engine/layers/l1/seg_1B/s9_validation/validator.py`).
   - [TODO] Dictionary vs registry mismatch for 1B validation bundle path (`data/layer1/1B/validation/fingerprint=.../bundle/` in dictionary vs `.../validation/fingerprint=.../` in registry); reconcile authority docs to prevent downstream path drift (`docs/model_spec/data-engine/layer-1/specs/contracts/1B/artefact_registry_1B.yaml`, `contracts/dataset_dictionary/l1/seg_1B/layer1.1B.yaml`).

* 1:18am
   - Resolved the 12:58am Cross-cutting Rails TODO set by retargeting the canonical path/companion-contract declarations and anchor references to `docs/model_spec/observability_and_governance/cross_cutting_rails/...` and aligning all schema `$id`/`$ref` values in the Rails contracts to that root.
   - Updated Appendix B ingestion receipt examples to use the Rails contract path and to emit `existing_receipt_ref` (instead of `existing_receipt_id`) so the example matches the schema; clarified that `platform.degrade_mode` MUST use only the canonical enum tokens, with finer detail carried via namespaced extension keys.

* 1:50am
   - Audited 2A.S0 (gate + sealed inputs) against `schemas.2A.yaml` and `dataset_dictionary.layer1.2A.yaml`.
   - [TODO] `sealed_inputs_v1` row shape mismatch: emits `partition_keys` + `notes`, omits `created_utc`, and uses `asset_kind` values (`validation/reference/policy/artefact`) outside the schema enum (`packages/engine/src/engine/layers/l1/seg_2A/s0_gate/l1/sealed_inputs.py`, `packages/engine/src/engine/layers/l1/seg_2A/s0_gate/l2/runner.py`).
   - [TODO] S0 run report + determinism receipt are written under `reports/l1/s0_gate/...` instead of a catalogue/evidence path (spec expects dictionary-resolved evidence locations) (`packages/engine/src/engine/layers/l1/seg_2A/s0_gate/l2/runner.py`).

* 1:51am
   - Audited 2A.S1 (provisional tz lookup) outputs and policy parsing.
   - [TODO] `s1_tz_lookup` output omits `seed` + `fingerprint` columns required by `schemas.2A.yaml#/plan/s1_tz_lookup` (`packages/engine/src/engine/layers/l1/seg_2A/s1_provisional/l2/runner.py`).
   - [TODO] `tz_nudge` policy expects `nudge_distance_degrees`, but schema requires `epsilon_degrees` + `sha256_digest` (`packages/engine/src/engine/layers/l1/seg_2A/s1_provisional/l2/runner.py`).
   - [TODO] Run report path is hardcoded under `reports/l1/s1_provisional/...` (not dictionary-resolved) (`packages/engine/src/engine/layers/l1/seg_2A/s1_provisional/l2/runner.py`).

* 1:52am
   - Audited 2A.S2 (overrides + site_timezones).
   - [TODO] `tz_overrides` parsing expects wrapper object with `overrides/semver/sha256_digest`, but schema defines `tz_overrides_v1` as a list of overrides only (`packages/engine/src/engine/layers/l1/seg_2A/s2_overrides/l2/runner.py`).
   - [TODO] `site_timezones` output omits `seed` + `fingerprint` columns required by schema (`packages/engine/src/engine/layers/l1/seg_2A/s2_overrides/l2/runner.py`).
   - [TODO] Run report path hardcoded under `reports/l1/s2_overrides/...` (not dictionary-resolved) (`packages/engine/src/engine/layers/l1/seg_2A/s2_overrides/l2/runner.py`).

* 1:53am
   - Audited 2A.S3 (tz timetable cache + adjustments).
   - [TODO] tzdb digest verification hashes the full directory; spec defines `archive_sha256` as the hash of `tzdata{release_tag}.tar.gz` bytes only, and `_resolve_archive_path` picks the first `*.tar.gz` instead of the pinned release file (`packages/engine/src/engine/layers/l1/seg_2A/s3_timetable/l2/runner.py`).
   - [TODO] `tz_offset_adjustments` is defined in the dictionary but missing from `schemas.2A.yaml` (anchor `#/cache/tz_offset_adjustments` absent), so schema authority is undefined (spec gap) (`contracts/dataset_dictionary/l1/seg_2A/layer1.2A.yaml`, `docs/model_spec/data-engine/layer-1/specs/contracts/2A/schemas.2A.yaml`).
   - [TODO] Run report path hardcoded under `reports/l1/s3_timetable/...` and payload hardcodes `seed: 0` even though S3 is fingerprint-scoped (confirm spec expectation) (`packages/engine/src/engine/layers/l1/seg_2A/s3_timetable/l2/runner.py`).

* 1:54am
   - Audited 2A.S4 (legality report).
   - [TODO] `s4_legality_report` payload includes extra `segment`/`state` fields; schema forbids additional properties (`packages/engine/src/engine/layers/l1/seg_2A/s4_legality/l2/runner.py`).
   - [TODO] Run report path hardcoded under `reports/l1/s4_legality/...` (not dictionary-resolved) (`packages/engine/src/engine/layers/l1/seg_2A/s4_legality/l2/runner.py`).

* 1:55am
   - Audited 2A.S5 (validation bundle).
   - [TODO] S5 validates `s4_legality_report` against schema; current S4 output fails validation due to extra fields, so S5 will fail until S4 output is aligned (`packages/engine/src/engine/layers/l1/seg_2A/s5_validation/l2/runner.py`).
   - [TODO] Run report path hardcoded under `reports/l1/s5_validation/...` (not dictionary-resolved) (`packages/engine/src/engine/layers/l1/seg_2A/s5_validation/l2/runner.py`).

* 1:56am
   - Audited 2B.S0 (gate + sealed inputs).
   - [TODO] `s0_gate_receipt_2B` includes extra fields (`segment`, `state`, `validation_bundle_path`, `flag_sha256_hex`) and writes `seed` as string; schema forbids extras and expects uint64 seed (`packages/engine/src/engine/layers/l1/seg_2B/s0_gate/l2/runner.py`).
   - [TODO] `sealed_inputs_v1` uses `partition` as a list of keys (no values) in both receipt + inventory; schema expects a key-value partition map (`packages/engine/src/engine/layers/l1/seg_2B/s0_gate/l1/sealed_inputs.py`, `packages/engine/src/engine/layers/l1/seg_2B/s0_gate/l2/runner.py`).
   - [TODO] `site_timezones` required by spec but only sealed when `pin_civil_time=True`, and uses `seg2a_manifest_fingerprint` for civil-time assets instead of the 2B manifest (`packages/engine/src/engine/layers/l1/seg_2B/s0_gate/l2/runner.py`).
   - [TODO] Run report path hardcoded under `reports/l1/s0_gate/...` (not dictionary-resolved) (`packages/engine/src/engine/layers/l1/seg_2B/s0_gate/l2/runner.py`).

* 1:57am
   - Audited 2B.S1 (weights).
   - No TODOs found; outputs align with `schemas.2B.yaml#/plan/s1_site_weights`.

* 7:53am
   - [DONE] Added dataset dictionary entry `s0_run_report_2B` so S0 gate run reports resolve via the dictionary (`contracts/dataset_dictionary/l1/seg_2B/layer1.2B.yaml`).

* 7:56am
   - [DONE] S0 gate now seals `site_timezones`/`tz_timetable_cache` using the 2A manifest fingerprint and treats them as required inputs; run-report samples now preserve partition maps instead of key-only lists (`packages/engine/src/engine/layers/l1/seg_2B/s0_gate/l2/runner.py`).

* 7:57am
   - [DONE] Updated 2B.S5 run-report inputs summary to record `site_timezones` under the 2A manifest fingerprint rather than the 2B manifest (`packages/engine/src/engine/layers/l1/seg_2B/s5_router/l2/runner.py`).

* 8:19am
   - [DONE] Reworked 2B.S6 virtual edge parsing to consume `virtual_edge_policy_v1.edges` (incl. `country_weights`), removed merchant overrides, tightened weight validation, and aligned event/audit/log payloads to the layer1 RNG/trace schemas (`packages/engine/src/engine/layers/l1/seg_2B/s6_virtual_edge/l2/runner.py`).
   - [DONE] Aligned 2B.S7 audit report payload with `schemas.2B.yaml#/validation/s7_audit_report_v1` (checks/summary, allowed metrics only) and updated router evidence aggregation + selection log validation to accept missing seed/run_id fields (`packages/engine/src/engine/layers/l1/seg_2B/s7_audit/l2/runner.py`).
   - [DONE] Updated Layer-1 RNG event schemas for 2B routing (alias pick + CDN edge pick) to match the new envelopes and module names in both contracts + specs (`contracts/schemas/layer1/schemas.layer1.yaml`, `docs/model_spec/data-engine/layer-1/specs/contracts/1A/schemas.layer1.yaml`).
   - [DONE] Normalised 2B validation-bundle schema references to `schemas.layer1.yaml#/validation/validation_bundle/index_schema` and made S8 status fallback read `checks` when summary is missing (`contracts/dataset_dictionary/l1/seg_2B/layer1.2B.yaml`, `docs/model_spec/data-engine/layer-1/specs/contracts/2B/dataset_dictionary.layer1.2B.yaml`, `docs/model_spec/data-engine/layer-1/specs/contracts/2B/artefact_registry_2B.yaml`, `packages/engine/src/engine/layers/l1/seg_2B/s8_validation/l2/runner.py`).
   - [DONE] Relaxed edge-attribute type hints to allow string metadata after switching to `edges`-based policies (`packages/engine/src/engine/layers/l1/seg_2B/s7_audit/l2/runner.py`).
   - [DONE] Updated 2B state-flow specs to reference the layer1 bundle index schema anchor used by the contracts (`docs/model_spec/data-engine/layer-1/specs/state-flow/2B/state.2B.s0.expanded.md`, `docs/model_spec/data-engine/layer-1/specs/state-flow/2B/state.2B.s8.expanded.md`).
   - [DONE] Updated 2B design docs to reference the canonical layer1 bundle index schema anchor (`docs/design/data-engine/layer-1/2B/2B-S8-dag.md`, `docs/design/data-engine/layer-1/2B/2B-overview-dag.md`).

* 1:58am
   - Audited 2B.S2 (alias tables).
   - No TODOs found; outputs align with `schemas.2B.yaml#/plan/s2_alias_index`.

* 1:59am
   - Audited 2B.S3 (day effects).
   - [TODO] `site_timezones`/`tz_timetable_cache` resolve using `seg2a_manifest_fingerprint` instead of the 2B manifest fingerprint (breaks manifest coherence) (`packages/engine/src/engine/layers/l1/seg_2B/s3_day_effects/l2/runner.py`).

* 2:00am
   - Audited 2B.S4 (group weights).
   - [TODO] `site_timezones`/`tz_timetable_cache` resolve using `seg2a_manifest_fingerprint` instead of the 2B manifest fingerprint (breaks manifest coherence) (`packages/engine/src/engine/layers/l1/seg_2B/s4_group_weights/l2/runner.py`).

* 2:01am
   - Audited 2B.S5 (router).
   - [TODO] RNG events omit required `run_id` and include extra fields; alias-pick event schemas are missing in `schemas.layer1.yaml`, so validation will fail (`packages/engine/src/engine/layers/l1/seg_2B/s5_router/l2/runner.py`).
   - [TODO] Selection logs include extra fields (`seed`, `parameter_hash`, `run_id`, `selection_seq`) not allowed by `schemas.2B.yaml#/trace/s5_selection_log_row` (`packages/engine/src/engine/layers/l1/seg_2B/s5_router/l2/runner.py`).
   - [TODO] RNG audit log emits non-schema `module` field (schema forbids additional properties) (`packages/engine/src/engine/layers/l1/seg_2B/s5_router/l2/runner.py`).

* 2:02am
   - Audited 2B.S6 (virtual edge).
   - [TODO] `virtual_edge_policy_v1` parser expects `default_edges`/`merchant_overrides` layout, but schema defines `edges` list with `ip_country/edge_lat/edge_lon` (policy shape mismatch) (`packages/engine/src/engine/layers/l1/seg_2B/s6_virtual_edge/l2/runner.py`).
   - [TODO] RNG events/logs include extra fields not allowed by schemas; selection logs include `seed`/`parameter_hash`/`run_id`/`selection_seq`, audit logs include `module` (`packages/engine/src/engine/layers/l1/seg_2B/s6_virtual_edge/l2/runner.py`).

* 2:03am
   - Audited 2B.S7 (audit).
   - [TODO] `s7_audit_report_v1` payload mismatches schema: emits `validators`/`router_evidence` and extra fields instead of required `checks`/`summary` (`packages/engine/src/engine/layers/l1/seg_2B/s7_audit/l2/runner.py`).
   - [TODO] S7 validates S5/S6 logs against schema; current logs include extra fields and will fail (`packages/engine/src/engine/layers/l1/seg_2B/s7_audit/l2/runner.py`).
   - [TODO] Alias-pick RNG event schemas are missing in `schemas.layer1.yaml`, so S7 cannot validate routing RNG events (spec gap).

* 2:04am
   - Audited 2B.S8 (validation bundle).
   - [TODO] `#/validation/validation_bundle/index_schema` anchor is missing; dictionary points to a non-existent schema ref, so bundle index validation fails (`packages/engine/src/engine/layers/l1/seg_2B/s8_validation/l2/runner.py`).
   - [TODO] S8 index entries are `{path, sha256_hex}` only, which does not match the required bundle index schema shape for 2B (`packages/engine/src/engine/layers/l1/seg_2B/s8_validation/l2/runner.py`).

* 2:05am
   - Audited 3A.S0 (gate + sealed inputs).
   - [TODO] Upstream validation bundles resolved via literal `data/layer1/...` paths instead of dictionary-resolved locations (`packages/engine/src/engine/layers/l1/seg_3A/s0_gate/l2/runner.py`).
   - [TODO] Sealed upstream bundle `schema_ref` uses `schemas.{segment}.yaml#/validation/validation_bundle` even for segments with different anchors (1B/2A), causing schema mismatch (`packages/engine/src/engine/layers/l1/seg_3A/s0_gate/l2/runner.py`).
   - [TODO] Determinism receipt written to uncatalogued path `data/layer1/3A/s0_gate_receipt/determinism_receipt.json` (no dictionary entry) (`packages/engine/src/engine/layers/l1/seg_3A/s0_gate/l2/runner.py`).

* 2:06am
   - Audited 3A.S1 (escalation queue).
   - [TODO] `s1_escalation_queue` uses `manifest_fingerprint` column name instead of schema-required `fingerprint` (`packages/engine/src/engine/layers/l1/seg_3A/s1_escalation/l2/runner.py`).
   - [TODO] Run report path hardcoded under `reports/l1/3A/s1_escalation/...` (not dictionary-resolved) (`packages/engine/src/engine/layers/l1/seg_3A/s1_escalation/l2/runner.py`).

* 2:07am
   - Audited 3A.S2 (country-zone priors).
   - No TODOs found; outputs align with `schemas.3A.yaml#/plan/s2_country_zone_priors`.

* 2:08am
   - Audited 3A.S3 (zone shares + RNG events).
   - [TODO] RNG event envelope mismatch: module/substream labels and payload fields (`legal_country_iso` vs `country_iso`, extra fields) do not match schema; draws/blocks types are wrong and trace rows include extra fields (`packages/engine/src/engine/layers/l1/seg_3A/s3_zone_shares/l2/runner.py`).
   - [TODO] RNG event/log paths (`logs/rng/events/dirichlet_zone_share`) are not defined in the registry, and `run_id` defaults to `run-0` (not hex32) (`packages/engine/src/engine/layers/l1/seg_3A/s3_zone_shares/l2/runner.py`).
   - [TODO] Run report path hardcoded under `reports/l1/3A/s3_zone_shares/...` (not dictionary-resolved) (`packages/engine/src/engine/layers/l1/seg_3A/s3_zone_shares/l2/runner.py`).

* 2:09am
   - Audited 3A.S4 (zone counts).
   - No TODOs found; outputs align with `schemas.3A.yaml#/plan/s4_zone_counts`.

* 2:10am
   - Audited 3A.S5 (zone alloc + universe hash).
   - No TODOs found; outputs align with `schemas.3A.yaml#/egress/zone_alloc`.

* 2:11am
   - Audited 3A.S6 (structural validation).
   - [TODO] S6 only checks `zone_alloc` schema + count conservation; spec requires comprehensive checks across S0-S5 + RNG accounting (missing checks) (`packages/engine/src/engine/layers/l1/seg_3A/s6_validation/l2/runner.py`).
   - [TODO] S6 writes `validation_bundle_3A` and `_passed.flag_3A`; spec says S6 must NOT emit bundle or pass flag (S7 owns these) (`packages/engine/src/engine/layers/l1/seg_3A/s6_validation/l2/runner.py`).
   - [TODO] `_passed.flag_3A` content is literal `PASS`, not hashgate format (`packages/engine/src/engine/layers/l1/seg_3A/s6_validation/l2/runner.py`).

* 2:12am
   - Audited 3A.S7 (bundle + pass flag).
   - [TODO] Bundle index does not match `schemas.layer1.yaml#/validation/validation_bundle_index_3A` (missing manifest/parameter/s6_receipt_digest, uses `dataset_id` instead of `logical_id`) (`packages/engine/src/engine/layers/l1/seg_3A/s7_bundle/l2/runner.py`).
   - [TODO] PASS flag filename `_passed.flag_3A` and digest computation (hash of concatenated member digests) do not follow hashgate law; dictionary expects `_passed.flag` (`packages/engine/src/engine/layers/l1/seg_3A/s7_bundle/l2/runner.py`).
   - [TODO] Run report path hardcoded under `reports/l1/3A/s7_bundle/...` (not dictionary-resolved) (`packages/engine/src/engine/layers/l1/seg_3A/s7_bundle/l2/runner.py`).

* 2:13am
   - Audited 3B.S0 (gate + sealed inputs).
   - [TODO] Upstream bundles resolved via literal `data/layer1/...` paths instead of dictionary-resolved locations (`packages/engine/src/engine/layers/l1/seg_3B/s0_gate/l2/runner.py`).
   - [TODO] Sealed upstream bundle `schema_ref` uses `schemas.{segment}.yaml#/validation/validation_bundle` even for segments with different schema anchors (2A/3A) (`packages/engine/src/engine/layers/l1/seg_3B/s0_gate/l2/runner.py`).
   - [TODO] `s0_gate_receipt_3B` includes extra `bundle_path` in upstream gates; schema forbids additional properties (`packages/engine/src/engine/layers/l1/seg_3B/s0_gate/l2/runner.py`).
   - [TODO] `_verify_upstream_bundles` allows `_passed.flag_3A`; spec expects `_passed.flag` only (`packages/engine/src/engine/layers/l1/seg_3B/s0_gate/l2/runner.py`).

* 2:14am
   - Audited 3B.S1 (virtual classification + settlement).
   - No TODOs found; outputs align with `schemas.3B.yaml#/plan/virtual_classification_3B` and `virtual_settlement_3B`.

* 2:15am
   - Audited 3B.S2 (edge catalogue).
   - No TODOs found; outputs align with `schemas.3B.yaml#/plan/edge_catalogue_3B` and `edge_catalogue_index_3B`.

* 2:16am
   - Audited 3B.S3 (alias + edge universe hash).
   - [TODO] `edge_universe_hash_3B` payload missing required fields (parameter_hash, digests, created_at_utc); schema expects full digest set (`packages/engine/src/engine/layers/l1/seg_3B/s3_alias/l2/runner.py`).
   - [TODO] Alias blob format is JSON concatenation and does not follow `edge_alias_blob_header_3B` binary/layout spec (`packages/engine/src/engine/layers/l1/seg_3B/s3_alias/l2/runner.py`).
   - [TODO] Run report path hardcoded under `reports/l1/3B/s3_alias/...` (not dictionary-resolved) (`packages/engine/src/engine/layers/l1/seg_3B/s3_alias/l2/runner.py`).

* 2:17am
   - Audited 3B.S4 (virtual routing policy).
   - No TODOs found; outputs align with `schemas.3B.yaml#/egress/virtual_routing_policy_3B` and `virtual_validation_contract_3B`.

* 2:18am
   - Audited 3B.S5 (validation bundle).
   - [TODO] Bundle index does not match `validation_bundle_index_3B` schema (missing manifest/parameter/s5_manifest_digest, uses `dataset_id` instead of `logical_id`) (`packages/engine/src/engine/layers/l1/seg_3B/s5_validation/l2/runner.py`).
   - [TODO] PASS flag filename `_passed.flag_3B` and digest computation (hash of concatenated member digests) do not follow hashgate law; dictionary expects `_passed.flag` (`packages/engine/src/engine/layers/l1/seg_3B/s5_validation/l2/runner.py`).
   - [TODO] `s5_manifest_3B` is defined in the dictionary but never emitted (`contracts/dataset_dictionary/l1/seg_3B/layer1.3B.yaml`, `packages/engine/src/engine/layers/l1/seg_3B/s5_validation/l2/runner.py`).
   - [TODO] Run report path hardcoded under `reports/l1/3B/s5_validation/...` (not dictionary-resolved) (`packages/engine/src/engine/layers/l1/seg_3B/s5_validation/l2/runner.py`).

* 2:19am
   - Audited 5A.S0 (gate + sealed inputs).
   - [TODO] Upstream bundles resolved via literal `data/layer1/{segment}/validation/...` paths; spec mandates dictionary-resolved locations (`packages/engine/src/engine/layers/l2/seg_5A/s0_gate/runner.py`).
   - [TODO] Sealed upstream bundle `schema_ref` uses generic `schemas.layer1.yaml#/validation/validation_bundle` + `passed_flag` for all segments, ignoring segment-specific bundle/index schemas (1B/2A/3A/3B) (`packages/engine/src/engine/layers/l2/seg_5A/s0_gate/runner.py`).
   - [TODO] 3B bundle digest falls back to concatenated member hashes when index uses `items`; verify against the per-segment hashing law (spec likely requires index hash) (`packages/engine/src/engine/layers/l2/seg_5A/s0_gate/runner.py`).
   - [TODO] 5A run-report path is hardcoded to `reports/l2/segment_states/segment_state_runs.jsonl` (no dictionary entry); confirm governance expectations (`packages/engine/src/engine/layers/l2/seg_5A/s0_gate/runner.py`).

* 2:20am
   - Audited 5A.S1 (profiles).
   - No TODOs found; outputs align with `schemas.5A.yaml#/model/merchant_zone_profile_5A` and `merchant_class_profile_5A`.

* 2:21am
   - Audited 5A.S2 (shapes).
   - No TODOs found; outputs align with `schemas.5A.yaml#/model/shape_grid_definition_5A` and class-shape outputs.

* 2:22am
   - Audited 5A.S3 (baselines).
   - No TODOs found; outputs align with `schemas.5A.yaml#/model/merchant_zone_baseline_local_5A` (and class/UTC derivatives).

* 2:23am
   - Audited 5A.S4 (scenario overlays).
   - No TODOs found; outputs align with `schemas.5A.yaml#/model/merchant_zone_scenario_*_5A`.

* 2:24am
   - Audited 5A.S5 coverage.
   - [TODO] 5A.S5 state is defined in the 5A state-flow specs, but there is no `s5_*` implementation under `packages/engine/src/engine/layers/l2/seg_5A/` (missing validation/publish stage).

* 6:06am
   - Began fix pass for 1A; re-reviewed S0 runner/output/rng logging, S1/S2 RNG writers, S4 deterministic+writer, and S6 policy+writer to confirm spec alignment before edits.
   - Decision: keep RNG event draws as dec_u128 strings per rng_envelope schema; focus on trace logs/extra fields only where mismatched.

* 6:10am
   - [DONE] 1A.S0: parameter_hash now includes ccy_smoothing_params.yaml + s6_selection_policy.yaml; numeric_policy + math_profile are required and always attested; manifest fingerprint uses registry dependency closure; outputs + validation bundle + validation failures resolve via dictionary paths; RNG audit/log paths are logs/rng/... with required schema fields; run_id collision guard uses existing audit directories.
   - [DONE] 1A.S1/S2: RNG trace rows stripped of parameter_hash/manifest_fingerprint and counts are numeric; audit lookup uses logs/rng/audit/... only.
   - [DONE] 1A.S3: rule ladder parser now accepts country_sets, structured predicates, dmit_sets/deny_sets, and eason_code_to_rule_id; base-weight/thresholds policies aligned to guides; crossborder_features wired via S4 deterministic context.
   - [DONE] 1A.S4: ZTP events aligned to schema (substream labels, context use, attempts/abort constraints) and RNG trace rows are schema-clean.
   - [DONE] 1A.S5: share-surface vintages pinned to 2024Q4 and RNG-free check reads logs/rng/trace.
   - [DONE] 1A.S6: selection policy parsing matches guide; gumbel_key event validation enforces u/key presence and draws/blocks=1; RNG trace is schema-clean.
   - [DONE] 1A.S7: residual quantisation + dirichlet alpha are policy-driven; trace logs schema-aligned.
   - [DONE] 1A.S8: sequence events use schema fields (country_iso + 6-digit sequences) and trace logs are numeric; validation bundle uses alidation_bundle_1A path; pass flags align with hashgate format.
   - [DONE] 1A.S9: validation loader resolves upstream bundle + RNG logs via dictionary; pass-flag parsing accepts normalized format; upstream manifest is loaded from the bundle path.

* 9:54am
   - [DONE] 3B.S3 alias packaging now emits a self-describing blob header, offsets include header length, and `edge_universe_hash_3B` now matches schema (`manifest_fingerprint`, `parameter_hash`, required digests, `universe_hash`) with S0 digests wired in (`packages/engine/src/engine/layers/l1/seg_3B/s3_alias/l2/runner.py`).
   - [DONE] 3B.S3 run report now records `parameter_hash`, uses dictionary-run-report path, and `SegmentStateKey` uses the S0 parameter hash (`packages/engine/src/engine/layers/l1/seg_3B/s3_alias/l2/runner.py`).
   - [DONE] 3B.S4 routing reads `universe_hash` from `edge_universe_hash_3B` and run-report path now resolves via dictionary; added `seed` to run report (`packages/engine/src/engine/layers/l1/seg_3B/s4_routing/l2/runner.py`).
   - [DONE] 3B.S5 validation bundle now uses `_passed.flag`, `s5_manifest_3B`, and bundle index `members` with digest law aligned to 3A; added alias blob header validation + checksum checks + `edge_universe_hash_3B` digest consistency (`packages/engine/src/engine/layers/l1/seg_3B/s5_validation/l2/runner.py`).
   - [DONE] 3B run reports (S1-S5) now use dictionary entries and include `parameter_hash`; added dictionary entries for s1/s2/s3/s4/s5 run reports in both contracts + docs (`contracts/dataset_dictionary/l1/seg_3B/layer1.3B.yaml`, `docs/model_spec/data-engine/layer-1/specs/contracts/3B/dataset_dictionary.layer1.3B.yaml`, `packages/engine/src/engine/layers/l1/seg_3B/s1_virtuals/l2/runner.py`, `.../s2_edges/l2/runner.py`).
   - [DONE] Implemented 5A.S5 validation bundle (report, issue table, bundle index, `_passed.flag`) with deterministic hashing and integrated it into the 5A orchestrator + CLI (`packages/engine/src/engine/layers/l2/seg_5A/s5_validation/runner.py`, `packages/engine/src/engine/scenario_runner/l2_seg_5A.py`, `packages/engine/src/engine/cli/segment5a.py`).
   - [NOTE] 3B alias header digest is defined as SHA-256 over payload bytes (post-header) to avoid recursive header hashing; `universe_hash` excludes alias-index digest to avoid recursion and is documented in notes.
   - [NOTE] 5A.S5 currently resolves expected output paths via dictionary templates with repo-root fallback rather than sealed inventory for S3/S4 outputs (deviation to revisit when sealed_outputs/registry coverage is expanded).

* 10:19am
   - [DONE] 1B fixes landed: license-map coverage enforced in S0; S1/S2 run reports now dictionary-resolved with PAT baselines and true I/O counters; per-country summaries include zero-coverage rows; S1/S2/S3/S5/S6 failure events emitted; S2 tile_weights schema aligned with `basis` column; S4 residue tie-break made deterministic; S5 RNG module values aligned to schema; S6 RNG payloads trimmed to schema; S9 bundle index + schema refs aligned to 1B contracts and bundle/pass-flag paths reconciled (`packages/engine/src/engine/layers/l1/seg_1B/...`, `contracts/dataset_dictionary/l1/seg_1B/layer1.1B.yaml`).
   - [DONE] 2A fixes landed: sealed_inputs_v1 rows + receipt now match schema; S1/S2 outputs include seed+fingerprint columns; tz_nudge + tz_overrides parsing aligned to schemas; tzdb digest verification pins the archive hash; tz_offset_adjustments schema added; run-report paths now dictionary-resolved; S4 legality payload stripped of extra fields so S5 validation passes (`packages/engine/src/engine/layers/l1/seg_2A/...`, `contracts/dataset_dictionary/l1/seg_2A/layer1.2A.yaml`, `docs/model_spec/data-engine/layer-1/specs/contracts/2A/schemas.2A.yaml`).
   - [DONE] 3A fixes landed: upstream bundle resolution + schema refs now dictionary-driven; S1 uses `fingerprint` column; S3 RNG envelope/logs aligned to schema + registry paths; S6 no longer emits bundle/flag and enforces expanded checks; S7 bundle index + `_passed.flag` follow hashgate law; run reports now dictionary-resolved (`packages/engine/src/engine/layers/l1/seg_3A/...`, `contracts/dataset_dictionary/l1/seg_3A/layer1.3A.yaml`).
   - [DONE] 5A.S0 upstream bundle checks now use per-segment dictionaries for bundle + pass-flag schema refs/paths; sealed upstream validation assets now inherit dictionary schema refs + registry manifest keys and record `source_manifest` in notes; 3B bundle digest uses members-based hash before fallback.
   - [DONE] 5A run-report outputs now resolve via dictionary entries (`segment_state_runs`, `s1_run_report_5A`...`s5_run_report_5A`); added layer2 `run_report/segment_state_run` schema and dictionary entries in contracts + specs to keep paths authoritative (`contracts/schemas/layer2/schemas.layer2.yaml`, `contracts/dataset_dictionary/l2/seg_5A/layer2.5A.yaml`, `docs/model_spec/data-engine/layer-2/specs/contracts/5A/*.yaml`).
   - [NOTE] Upstream bundle overrides are accepted when manifest fingerprints differ; sealed assets retain the 5A manifest while recording `source_manifest` for each upstream bundle to preserve traceability.

* 4:37pm
   - Starting implementation pass for 5B → 6A → 6B per USER request; will follow expanded state-flow specs and contracts, log decisions/actions per segment, and keep outputs aligned to dictionary/registry paths.

* 5:47pm
   - Began 5B implementation hardening against the authoring guides (time grid, grouping, LGCP, counts, routing, RNG, validation).
   - Decision: update the 5B dataset dictionary to include 5B config artefacts (mirroring the 5A contract style) so S0 sealing can resolve policy paths/digests cleanly.
   - Decision: add `segment_state_runs` to the 5B dictionary to match existing run-report emissions (avoid uncatalogued outputs).
   - Decision: implement arrival RNG with Philox2x64-10 + spec-derived key/counter (per `arrival_rng_policy_5B`) instead of hash-based RNG.
   - Decision: when `virtual_classification_3B` lacks explicit `virtual_mode`, treat `is_virtual=true` as `VIRTUAL_ONLY` and `false` as `NON_VIRTUAL` (HYBRID unreachable unless upstream adds it).
   - Decision: for physical routing, use 2B `s4_group_weights` (tz_group_id == tzid) + `site_timezones` for tz-group selection and uniform site selection within tzid; aligns with `alias_layout_policy_v1` weight_source=uniform_by_site and avoids alias blob decode complexity.

* 6:42pm
   - Updated 5B.S0 sealed upstream inventory to include `s1_site_weights`, `s2_alias_index`, `s2_alias_blob`, `route_rng_policy_v1`, and `alias_layout_policy_v1`; S0 run-report path now resolves via `segment_state_runs`.
   - Updated 5B.S4 physical routing to use alias-table sampling for tz-group + site selection with deterministic ordering; added alias blob + policy digest verification before routing.
   - Rewrote 5B.S5 validation to build a bundle index with ordered raw-bytes digest, enforce required outputs, and validate count conservation + time windows; `_passed.flag` only written on PASS.
   - [TODO] 5B.S5 still skips RNG accounting, civil-time verification, and routing-universe checks against 2B/3A/3B surfaces.
   - [TODO] 5B.S5 report currently omits `bundle_sha256` to avoid self-referential hashing; decide on a spec-compliant echo strategy.
