# Logbook
### Date: 30th January 2026
### Project: Fraud Detection System
### Reference commits: Check commits on this date (if any)

* 12:24am
  - Updated run-first layout: EB file-bus now uses `.../<run_id>/eb`, WSP checkpoints under `.../<run_id>/wsp/checkpoints`, control-bus/run logs scoped to the platform run. Updated IG health path default, EB CLI default root, WSP config defaults, and local profile/README to match.

* 12:27am
  - Updated SR local wiring to omit `authority_store_dsn` so SR uses run-scoped `sr/index/sr_authority.db` by default.
  - Updated SR/WSP/IG tests to use explicit run prefixes and new run-scoped paths.

* 12:31am
  - Migrated existing artifacts from `runs/fraud-platform/{sr,ig,wsp,event_bus,control_bus,wsp_checkpoints}` into `runs/fraud-platform/platform_20260129T201145Z/{sr,ig,wsp,eb,control_bus}`.
  - Moved legacy `platform_runs/<run_id>` logs into the run root; moved `ACTIVE_RUN_ID` to `runs/fraud-platform/ACTIVE_RUN_ID`.
  - Global platform log moved under the run root as `platform.log.global` (per-run log preserved).
  - NOTE: `runs/fraud-platform/platform_runs` remains as an empty directory; remove manually if desired.

* 12:37am
  - Removed `config/platform/profiles/dev_local.yaml` to eliminate mixed local filesystem + Kinesis semantics.
  - Promoted `local_parity.yaml` as the parity gate in README/profile docs; removed `IG_PROFILE_DEV` alias and updated EB build plan reference.

* 12:39am
  - Appended corrective notes across component impl_actuals (WSP/IG/Oracle/EB) to mark `dev_local` references as historical and to confirm `local_parity` is the parity gate profile.

* 12:41am
  - Added parity runbook `docs/runbooks/platform_parity_walkthrough_v0.md` with a 500k event walkthrough (Oracle → SR → WSP → IG → EB) and verification steps; linked it from `docs/README.md`.

* 12:56am
  - Updated `docs/runbooks/platform_parity_walkthrough_v0.md` to explain what `platform-parity-bootstrap` does and added `platform-parity-stack-status` as a verification step.

* 01:03am
  - Updated `docs/runbooks/platform_parity_walkthrough_v0.md` to document `MANIFEST_MISMATCH` handling (fresh ORACLE_PACK_ROOT or strict‑seal check).

* 01:23am
  - Updated `.env.platform.local` to include MinIO `OBJECT_STORE_ENDPOINT/REGION` + `AWS_ACCESS_KEY_ID/SECRET` defaults for oracle packing.
  - Updated parity runbook with required MinIO S3 envs (`OBJECT_STORE_*`, `AWS_*`) and `ORACLE_PACK_ROOT`, plus a note about boto credential fallbacks.

* 01:28am
  - Patched Makefile to export MinIO S3 env vars for oracle pack/check; updated parity runbook with endpoint export note.

* 01:29am
  - Updated parity runbook to add an explicit MinIO sync step for engine outputs and to set ORACLE_ROOT/ENGINE_RUN_ROOT to S3 paths for true parity.

* 01:33am
  - Rewrote the Oracle Store section of the parity runbook to a clear 4.1 sync + 4.2 seal flow; fixed section numbering after rewrite.

* 01:36am
  - Updated parity runbook: AWS CLI sync now prefixes MinIO credentials inline because `aws` does not read `.env.platform.local`.

* 02:19am
  - Updated `.env.platform.local` to use MinIO S3 Oracle Store paths (`ORACLE_ROOT`, `ORACLE_ENGINE_RUN_ROOT`, `ORACLE_PACK_ROOT=pack_current`) so parity runs don’t require manual overrides.

* 02:23am
  - Added `platform-oracle-sync` Make target + `ORACLE_SYNC_SOURCE` so engine outputs can be synced into MinIO without manual AWS CLI env injection.
  - Updated parity Make targets to export MinIO creds for S3 access (LocalStack Kinesis still works), preventing 403s during IG parity startup.
  - Aligned `PARITY_ORACLE_ROOT` default to `ORACLE_ROOT` to keep the oracle root at bucket scope.
  - Updated parity runbook to use the new sync target and to document the MinIO‑backed Oracle flow.

* 02:33am
  - Updated parity runbook section 5 to clarify IG health endpoint, expected AMBER state before traffic, and the root 404 behavior.

* 02:35am
  - Added a short explanation in the parity runbook of what starting the IG service does (HTTP ingress + validation + receipts, must stay running).

* 02:36am
  - Updated `platform-sr-run-reuse` to export MinIO S3 creds/endpoint so SR doesn’t fall back to shared AWS credentials and 403.
  - Added a short SR note in the parity runbook for troubleshooting 403 on READY publish.

* 02:37am
  - Added `AWS_EC2_METADATA_DISABLED=true` to `.env.platform.local` and documented it in the parity runbook to avoid boto metadata probes.

* 02:38am
  - Updated parity runbook SR step to document `LEASE_BUSY` handling by rotating `SR_RUN_EQUIVALENCE_KEY`.

* 02:48am
  - Expanded the parity runbook `LEASE_BUSY` note with TTL wait and manual lease‑clear options.

* 02:49am
  - Added a sample “result logs” section to the parity runbook with line‑by‑line explanations for SR/WSP/IG/EB.

* 02:52am
  - Removed sample log section from the parity runbook and replaced it with a concise summary of what `platform-sr-run-reuse` does.

* 02:54am
  - Updated WSP step in parity runbook to use PowerShell‑correct inline env syntax.

* 02:55am
  - Updated WSP ready-consumer Make targets to export MinIO S3 endpoint/creds, preventing `Invalid endpoint` errors.
  - Added a short WSP troubleshooting note to the parity runbook.

* 02:58am
  - Exported `CONTROL_BUS_*` into WSP ready-consumer Make targets and defaulted them to parity control bus values.
  - Added a `CONTROL_BUS_STREAM_MISSING` troubleshooting note to the parity runbook.

* 03:00am
  - Exported `WSP_CHECKPOINT_DSN` into WSP ready-consumer Make targets to prevent `CHECKPOINT_DSN_MISSING`.
  - Added a WSP checkpoint troubleshooting note to the parity runbook.

* 03:03am
  - Exported `IG_INGEST_URL` into WSP ready-consumer Make targets and documented the `/v1/ingest/push` invalid URL error in the runbook.

* 03:11am
  - Added WSP live progress logging (configurable by `WSP_PROGRESS_EVERY` / `WSP_PROGRESS_SECONDS`) and documented it in the parity runbook.

* 03:15am
  - Fixed missing `import os` in WSP runner (progress logging uses env vars).

* 03:18am
  - Increased `local_parity` stream speedup from 60x to 600x to accelerate parity runs.

* 10:07am
  - Recorded ordering findings for arrival_events_5B/6B and drafted an Option C plan for a global time‑sorted stream view (Oracle Store build plan + impl_actual).

* 10:24am
  - Locked Option C design: DuckDB external sort, stream view under engine run root (`stream_view/ts_utc/<stream_view_id>`), partition by `stream_date`, receipt with row_count + hash sums + source locator digest; idempotent build.
  - Began implementation scaffolding for the stream view helper (Oracle Store) and queued WSP integration to consume the sorted view.

* 10:38am
  - Implemented Oracle stream view builder (DuckDB sort + receipt/manifest) and added CLI + Make target.
  - Added `stream_mode` + `oracle_stream_view_root` to WSP profiles, wired WSP to stream from the view in parity/dev/prod.
  - Updated parity runbook section 4 to include stream view build step; added env entry for `ORACLE_STREAM_VIEW_ROOT`.

* 10:40am
  - Ran WSP unit tests after stream_view wiring updates: `pytest tests/services/world_streamer_producer/test_runner.py tests/services/world_streamer_producer/test_ready_consumer.py -q` (pass).

* 10:58am
  - Added stream view build progress logs and enabled DuckDB progress bar (with `STREAM_SORT_PROGRESS_SECONDS` refresh knob).

* 10:59am
  - Added ETA‑style logs for stream sort completion using `STREAM_SORT_SORT_MULTIPLIER` (default 2.0) and UTC ETA stamp.

* 11:06am
  - Fixed DuckDB receipt hash overflow by using DOUBLE sums + modular sum in stream view stats.

* 11:12am
  - Corrected stream view design: per‑output sorted datasets (no union); updated builder + WSP to match.

* 11:24am
  - Added stream sort performance knobs (`STREAM_SORT_MEMORY_LIMIT`, `STREAM_SORT_TEMP_DIR`, `STREAM_SORT_THREADS`).

* 12:39pm
  - Updated stream view builder + WSP to per‑output views (no union); reran WSP tests (pass).

* 02:00pm
  - Began data-engine doc review; inventoried 73 expanded state-flow specs (Segments 1A–6B) to map required datasets for platform data analysis.

* 02:06pm
  - Corrected Oracle stream view builder to sort **per output** by bucket_index (no global union) and to write under `stream_view/ts_utc/output_id=<output_id>/bucket_index=<bucket>/` with deterministic tie‑breakers.
  - Added a guard to fail closed when partial stream‑view parquet files exist without a receipt (`STREAM_VIEW_PARTIAL_EXISTS`).
  - Updated stream‑sort CLI + parity runbook + profile docs to remove stream_view_id path segments and to describe bucket‑partitioned views.
  - Appended correction notes in `oracle_store.impl_actual`, `world_streamer_producer.impl_actual`, and `platform.impl_actual` to capture the path/partitioning change.

* 02:07pm
  - Completed reading all 73 expanded data-engine state-flow specs (Segments 1A–6B) for design context.

* 02:09pm
  - Suppressed stream-sort ETA logs when DuckDB progress bar is enabled (ETA now only logs if STREAM_SORT_PROGRESS_SECONDS is unset). Updated parity runbook note.

* 02:21pm
  - Reviewed data-engine interface pack (data_engine_interface.md + engine_outputs.catalogue.yaml) to identify platform-facing datasets and gate semantics for the dataset feed question.

* 02:29pm
  - Disabled DuckDB progress bar unless STREAM_SORT_PROGRESS_SECONDS is set (progress bar no longer forced on by default).

* 02:58pm
  - Began inventory of run datasets under runs\local_full_run-5\c25a2675fbfbacd952b13bb594880e92 for black-box data analysis planning.

* 02:58pm
  - Added stream-sort startup log for DuckDB config (threads, progress bar on/off, memory limit, temp dir) to make worker count visible.

* 04:12pm
  - Switched stream sort to single‑pass DuckDB `COPY ... PARTITION_BY (bucket_index)` to avoid per‑bucket full scans; ordering now `bucket_index, ts_utc, filename, file_row_number` for deterministic per‑bucket output.

* 04:24pm
  - Added DuckDB temp spill and order knobs for stream sort (`STREAM_SORT_MAX_TEMP_SIZE`, `STREAM_SORT_PRESERVE_ORDER`) and logged them at startup; updated parity runbook.

* 04:36pm
  - Ensured DuckDB connection is closed after each output stream view build so temp spill files release between outputs.

* 04:28pm
  - Fixed syntax error in stream_sorter ETA log formatting (bad escaped f-string) so stream sort CLI runs again.

* 05:01pm
  - Switched stream‑view validation hash to DuckDB `hash(col1, col2, ...)` with sorted column list (more stable than JSON struct) and added explicit raw vs sorted stats logging on mismatch.

* 05:54pm
  - Added post‑write renaming of stream‑view parquet files to `part-000000.parquet` (per bucket) for clearer naming; S3 uses copy+delete and fails closed on rename collisions.

* 06:05pm
  - Switched Oracle stream view to flat per‑output layout (no bucket_index directories); COPY no longer partitions and files are renamed to part-*.parquet at the output_id root. Updated impl_actuals and runbook notes.

* 06:10pm
  - Fixed indentation error in stream_sorter (single-pass write was outside try block) so CLI runs again.

* 06:15pm
  - Fixed stream‑view stats glob for flat layout (use `*.parquet` instead of `**/*.parquet` to avoid empty match on S3).

* 06:40pm
  - Switched stream-view stats read to use explicit S3 file list (read_parquet([files])) for flat layout; removed bucket_index partitioning and cleaned unused bucket scan helper.

* 07:10pm
  - Read all 1A state-expanded specs (S0–S9) and 1A contract files (artefact registry, dataset dictionary, schemas).

* 07:12pm
  - Read segment_1A.impl_actual.md to capture implementation interpretation of 1A design before dataset assessment.

* 07:18pm
  - Fixed stream-view output path to include trailing slash so DuckDB writes parquet files under the output_id directory (not as a single key). Added debug log when output is empty.

* 07:19pm
  - Wrote 1A design vs implementation observation report to reports\\eda\\segment_1A_design_vs_impl_observations.md.

* 07:36pm
  - Adjusted stream view write path to avoid MinIO multipart 400 (write to key without trailing slash), and updated S3 rename to handle a single file key (prefix) and convert it to `part-000000.parquet`.

* 07:39pm
  - Wrote human-readable published report for segment 1A assessment in reports/eda/segment_1A/segment_1A_published_report.md.

* 07:46pm
  - Ran deeper outlet_catalogue checks for segment 1A (schema + outlet counts, concentration, home vs legal mismatch, duplicate merchant-site pairs, declared vs actual outlet counts) to answer user focus on outlet_catalogue realism.

* 07:52pm
  - Appended outlet_catalogue deep-dive integrity findings to reports/eda/segment_1A/segment_1A_published_report.md.

* 07:54pm
  - Added outlet_catalogue realism grade with reasons to reports/eda/segment_1A/segment_1A_published_report.md.

* 08:11pm
  - Generated 14 outlet_catalogue EDA plots and metrics under reports/eda/segment_1A/plots using reports/eda/segment_1A/plot_outlet_catalogue_eda.py; added a new visuals section with interpretations to segment_1A_published_report.md.

* 08:15pm
  - Embedded outlet_catalogue plot images into reports/eda/segment_1A/segment_1A_published_report.md with markdown image links.

* 08:18pm
  - Resized embedded plot images in reports/eda/segment_1A/segment_1A_published_report.md using HTML width=520.

* 08:23pm
  - Reworked candidate vs membership plots to use foreign-only candidate counts; regenerated plots and updated report interpretation with foreign candidate median and membership share.

* 08:18pm
  - Added retry loop for stream-view sorted stats (new DuckDB connection per attempt) to handle transient MinIO HTTP read failures; configurable via STREAM_SORT_STATS_RETRIES/STREAM_SORT_STATS_RETRY_DELAY.

* 08:27pm
  - Added short per-plot interpretation lines under each embedded image in reports/eda/segment_1A/segment_1A_published_report.md.

* 08:27pm
  - Added configurable S3 client timeouts/retries (OBJECT_STORE_READ_TIMEOUT/CONNECT_TIMEOUT/MAX_ATTEMPTS) for Oracle Store + SR object store to avoid MinIO read timeouts during stream-view build.

* 08:33pm
  - Rewrote the outlet_catalogue visuals section with longer, plot-driven interpretations and removed short inline plot captions.

* 08:38pm
  - Updated sections 6–8 of segment_1A_published_report.md with outlet_catalogue grade, rationale, and prioritized fixes tied to realism gaps.

* 09:07pm
  - Fixed stream-view validation hash to use integer sum (HUGEINT) instead of DOUBLE to avoid order-dependent float drift; keeps deterministic equality for raw vs sorted stats.

* 09:25pm
  - Removed hard requirement for `bucket_index` in stream-view build so 6B outputs (which lack bucket_index) can be sorted by ts_utc without failing.

* 09:46pm
  - Added chunked stream-sort mode (STREAM_SORT_CHUNK_DAYS) to avoid OOM on large outputs; chunks sort by ts_utc and emit sequential part files to the output root.

* 09:50pm
  - Hardened chunked sort temp handling to remove any existing chunk directory before writing (prevents AccessDenied on Windows).

* 09:53pm
  - Adjusted chunked COPY target to include trailing slash so DuckDB treats chunk path as a directory on Windows (avoids AccessDenied).

* 09:57pm
  - Updated chunked COPY to use absolute path for local temp directory to avoid Windows access errors.

* 10:02pm
  - Added Windows short-path fallback for chunk temp paths to avoid DuckDB COPY failures when repo path contains spaces.

* 10:07pm
  - Simplified chunked mode to write a single `part-XXXXXX.parquet` per day directly to the output root (no local temp directory), avoiding Windows access errors.

* 08:42pm
  - Read all 1B state-expanded specs (S0–S9) under docs/model_spec/data-engine/layer-1/specs/state-flow/1B.

* 08:46pm
  - Reviewed segment_1B.impl_actual.md to assess implementation decisions, fixes, and open gaps before moving to 1B data assessment.

* 08:54pm
  - Wrote 1B design vs implementation observations report (realism-focused) to reports/eda/segment_1B_design_vs_impl_observations.md.

* 09:28pm
  - Wrote detailed 1B realism assessment (site_locations focus) to reports/eda/segment_1B_assessment.md.

* 09:33pm
  - Created reports/eda/segment_1B/ and moved segment_1B_assessment.md into that folder.

* 09:41pm
  - Merged 1B design/implementation observations and data assessment into reports/eda/segment_1B/segment_1B_published_report.md.

* 10:10pm
  - Generated 1B site_locations realism plots and embedded them with interpretation in reports/eda/segment_1B/segment_1B_published_report.md. Added plot QC metadata under reports/eda/segment_1B/plots.

* 10:34pm
  - Removed tile-weight/policy-focused visuals from the 1B published report to comply with site_locations-only focus; retained only site_locations-derived plots.

* 10:55pm
  - Replaced reports/eda/segment_1B/plots with plots_focus (renamed) per user request.

* 10:33pm
  - Expanded plot-driven interpretations in `reports/eda/segment_1B/segment_1B_published_report.md` (lat/lon, choropleth, top-20, Lorenz, NN) with more detailed realism rationale and explicit skew cues.

* 10:45PM
  - Read all 2A state-expanded specs (S0–S5) under docs/model_spec/data-engine/layer-1/specs/state-flow/2A and contracts (dataset_dictionary.layer1.2A.yaml, artefact_registry_2A.yaml, schemas.2A.yaml).

* 10:46PM
  - Read segment 2A implementation notes in docs/model_spec/data-engine/implementation_maps/segment_2A.impl_actual.md.

* 10:54PM
  - Started 2A report and documented design-vs-implementation observations in eports/eda/segment_2A/segment_2A_published_report.md.
