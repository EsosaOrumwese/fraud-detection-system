# Logbook
### Date: 10th January 2026
### Project: Fraud Detection System
### Reference commits: Check commits on this date (if any)

* 12:09am
   - Added validation_bundle_index_{1A,1B} to the S9 Contract Card outputs in the 1A and 1B state-expanded specs.
   - Updated 2A.S5 cross-references and Contract Card outputs to include validation_bundle_index_2A and clarified catalogue/registry coverage.

* 12:13am
   - Ran a Contract Card + Cross-Layer Inputs consistency sweep against contract dictionary/registry IDs (filtered to bullet-listed IDs in those sections).
   - Result: no mismatches found after accounting for dotted IDs (e.g., policy and static file identifiers).
* 12:18am
   - Updated interface_pack path tokens to use manifest_fingerprint={manifest_fingerprint} for fingerprint-scoped paths to align with contracts.
   - Added s0_gate_receipt_1A and validation_bundle_index_{1A,1B,2A} to engine_outputs.catalogue.yaml and dataset_outputs.json; synced partitioning keys to manifest_fingerprint.
   - Updated engine_gates.map.yaml to emit s0_gate_receipt_1A.
* 12:33am
   - Regenerated interface_pack harvest output dataset list from all dataset dictionaries (skipping reports/ paths) into interface_pack/_harvest/dataset_outputs.json.
* 12:42am
   - Regenerated interface_pack engine_outputs.catalogue.yaml and engine_gates.map.yaml from the refreshed harvest to keep outputs and gates in lockstep.
* 12:44am
   - Ran a harvest-vs-interface_pack integrity check (outputs + gates).
   - Findings: no missing/extra output IDs, but RNG log paths/schemas differ across segments and validation_bundle_1B shows a duplicate schema_ref mismatch from cross-layer definitions.
* 1:02am
   - Noted user directive to discard the attempted spec-side normalization; keep contracts as source of truth and avoid interface_pack-led changes.
* 1:13am
   - Regenerated interface_pack harvest from contract dictionaries (datasets/logs/reports/policies/artefacts) without filtering produced_by; duplicates preserved.
   - Regenerated engine_outputs.catalogue.yaml and engine_gates.map.yaml from that harvest baseline.
   - Added tools/interface_pack_integrity_check.py and verified the interface pack matches the harvest baseline with zero mismatches.

* 6:59am
   - Removed the S0.10.8 pseudocode block from `docs/model_spec/data-engine/layer-1/specs/state-flow/1A/state.1A.s0.expanded.md` per user request.
   - Updated S0.2.2 governed set to include policy.s3.* basenames (required/optional) and generalized n=|ð“Ÿ|; added crossborder_features to S0.10.2/10.3; aligned bundle contents with index.json and revised bundle integrity text.
   - Added `crossborder_eligibility_flags` to S6 explicit input lists/contract card/preflight checks and ASCII preflight diagram in `state.1A.s6.expanded.md`.
   - Normalized manifest_fingerprint path tokens and wording across 1A state-flow docs (S5/S8/S9), fixing accidental manifest_manifest_fingerprint references.

* 7:05am
   - Removed the remaining pseudocode section from `docs/model_spec/data-engine/layer-1/specs/state-flow/1A/state.1A.s2.expanded.md` to eliminate all pseudocode blocks in 1A state-flow docs.

* 7:07am
   - Created `docs/model_spec/data-engine/implementation_maps/` and empty placeholders for `segment_1A.impl_map.yaml` and `segment_1A.impl_map.md`.

* 7:30am
   - Read AGENTS.md and the required conceptual + narrative specs for layers 1-3 to align with segment 1A planning.
   - Reviewed `docs/model_spec/data-engine/implementation_maps/segment_1A.impl_map.yaml` and `docs/model_spec/data-engine/implementation_maps/segment_1A.impl_map.md` to map state IDs and gate semantics.
   - Decided to capture execution planning in a dedicated markdown plan aligned to impl_map state keys with inputs, outputs, steps, invariants, and a decision log.
   - Created `docs/model_spec/data-engine/implementation_maps/segment_1A.exec_plan.md` with the initial plan structure, state-by-state steps, and open questions.

* 7:40am
   - Refactored `docs/model_spec/data-engine/implementation_maps/segment_1A.exec_plan.md` into a decision + code map that records implementation deltas only, instead of restating spec content.
   - Added a state-by-state scaffold for code locations, decisions, determinism risks, and test evidence to be filled during implementation.

* 7:31am
   - Aligned `docs/model_spec/data-engine/implementation_maps/segment_1A.impl_map.yaml` with current contracts/specs: updated sources to .md, refreshed source_fingerprints, added policy.s3.* governed basenames (optional list), added policy.s3.* to S0 reads, added policy.s3.thresholds.yaml to S3 reads, fixed s0_gate_receipt_1A path, normalized RNG event/trace paths to logs/, and marked crossborder_features as planning/optional with ordering.
   - Updated `docs/model_spec/data-engine/implementation_maps/segment_1A.impl_map.md` to flag crossborder_features as planning/optional and cleared resolved review flags.

* 7:56am
   - Read closed-world enterprise and data-engine conceptual design references per root AGENTS order.
   - Read layer-1/2/3 narrative specs (narrative_1A-to-3B, narrative_5A-and-5B, narrative_6A-and-6B) before implementation review.
   - Read packages/engine/AGENTS.md and docs/model_spec/data-engine/AGENTS.md for routing and binding spec guidance.
   - Attempted to open docs/model_spec/data-engine/specs/data-intake/AGENTS.md; path missing, will follow layer-specific data-intake routers instead.

* 7:57am
   - Listed repo root to orient artefact/config/policy locations before comparing to spec contracts.

* 7:58am
   - Searched contract/dictionary/registry references with rg across docs/contracts; noted top-level interface_pack path does not exist (only docs/model_spec/data-engine/interface_pack).

* 8:00am
   - Decided to structure the artefact/config/policy arrangement review as a four-step plan (collect contract paths, inventory repo layout, compare, summarize findings).

* 8:02am
   - Attempted to parse Layer-1 contract YAML via PyYAML to extract path values; parser error in a registry file, so switched to regex-based extraction instead.

* 8:04am
   - Enumerated current config/ tree to compare against contract-specified Layer-1 config paths.

* 8:03am
   - Extracted Layer-1 contract path entries via regex from dataset dictionaries and artefact registries; generated prefix summary and static path list for existence checks.

* 8:04am
   - Checked contract-derived static paths against repo; most Layer-1 config/artefacts/reference files are missing under contract paths (indicating layout divergence to investigate).

* 8:05am
   - Enumerated artefacts/ tree to capture current external/data-intake/training layout for comparison to Layer-1 contract paths.

* 8:06am
   - Enumerated reference/ tree to compare to contract-defined reference paths and versions.

* 8:07am
   - Enumerated runs/ tree (large) to understand run-scoped output layout relative to contract path templates.

* 8:06am
   - Enumerated data/ tree; found only a single Layer-1 crossborder_features parquet outside runs.

* 8:08am
   - Computed which contract static paths exist; only a small subset (mostly reference data + a few artefacts) match exact contract locations.

* 8:09am
   - Read config/AGENTS.md to confirm repo treats config/ as canonical path, which may conflict with contract path templates.

* 8:09am
   - Read artefacts/README.md; noted intent (manifests/licenses only) conflicts with current artefacts/ contents (data-intake, training, run artefacts).

* 8:10am
   - Updated review plan status after collecting contract paths and inventorying repo layout.

* 8:11am
   - Inspected runs/local_layer1_regen4/parameter_scoped to confirm 1A outputs are emitted outside the contract data/layer1/1A path template.

* 8:10am
   - Read interface_pack/engine_outputs.catalogue.yaml to verify contract path templates for outputs across segments (data/ and logs/ relative paths).

* 8:11am
   - Grouped missing static contract paths by prefix to identify layout mismatches (config/, artefacts/, ci/, schema/ etc.).

* 8:12am
   - Read config/README.md; confirms config/ consolidation and suggests contracts may not yet reflect the flattened layout.

* 8:12am
   - Looked for reference/README.md to confirm intended layout; file not found.

* 8:13am
   - Checked contracts/dataset_dictionary/l1/seg_1A/layer1.1A.yaml; it references config/ allocation paths (flattened), diverging from model_spec contract paths (config/layer1/1A/...).

* 8:13am
   - Looked for contracts/artefact_registry_1A.yaml; file not present (contracts/artefact_registry currently only has 5A/5B/6A/6B).

* 8:12am
   - Sampled runs/local_layer1_regen4/logs layout; RNG logs live under runs/.../logs/rng/... rather than contract path logs/layer1/1A/...

* 8:13am
   - Updated review plan status after completing the expected-vs-actual layout comparison.

* 8:05am
   - Normalized 1B schema text to remove the stray `manifest_manifest_fingerprint` path token reference in `schemas.1B.yaml`.
   - Standardized 1B state-flow gate language to rely on `s0_gate_receipt_1B` (no downstream bundle re-hash): updated S3 gate triggers and gate-law notes; replaced `{fingerprint}` placeholders with `{manifest_fingerprint}` in S0/S3.
   - Updated S1/S2 gate-coherence guidance to validate `s0_gate_receipt_1B` instead of recomputing `_passed.flag`, including new receipt-based recipes.

* 8:08am
   - Normalized remaining 1B state-flow identity text from `{seed, fingerprint, parameter_hash}` to `{seed, manifest_fingerprint, parameter_hash}` in S5/S7/S8 and updated the S8 partition sizing note to match.
   - Replaced the remaining `{fingerprint, sha256_hex}` placeholder in 1B.S0 with `{manifest_fingerprint, sha256_hex}` for consistent token naming.

* 8:09am
   - Updated 1B.S0 registry/gate section to explicitly require `index.json` in the 1A validation bundle description.

* 8:20am
   - Reviewed `segment_1B.impl_map.md` for alignment/clarity: noted lingering â€œfingerprintâ€ wording that should be `manifest_fingerprint`, missing mention of fingerprint-only partitioned artefacts (S0 receipt/sealed inputs), and visible encoding artifacts (e.g., `ÃƒÃ„`, ``) that should be cleaned.
   - Flagged that the RNG budget statement for S6 (blocks/draws) should be verified against the state-expanded docs for consistency.

* 8:27am
   - Rewrote `docs/model_spec/data-engine/implementation_maps/segment_1B.impl_map.md` to remove encoding artifacts, normalize manifest_fingerprint terminology, add fingerprint-only partition family, and mark resolved review flags.

* 8:33am
   - Verified 1B.S6 RNG budget in `state.1B.s6.expanded.md`: per-attempt events with `blocks=1` and `draws="2"` (two-uniform family), resamples represented as multiple events.

* 8:14am
   - Completed the artefact/config/policy arrangement review summary and next-step recommendations.

* 8:17am
   - Received user directive to ignore runs/ outputs and treat docs/model_spec as the sole authority for contracts/path templates; will base future alignment checks on model_spec only.

* 8:20am
   - Planned config path realignment: inventory flattened layer1 config files, move to model_spec paths, update references/docs, summarize remaining gaps + contract mirroring recommendation.

* 8:22am
   - Moved 59 flattened config files into model_spec-aligned layer1 paths (config/layer1/1A|2A|3A|3B/...).

* 8:24am
   - Updated repo references to moved config paths (bulk string replacements across docs/scripts/tests/engine code).

* 8:25am
   - Updated config/README.md and config/AGENTS.md to describe the new layer-scoped config layout aligned to model_spec contract paths.

* 8:27am
   - Rechecked model_spec Layer-1 static paths after moves; remaining missing items are mostly config files (1A registry/rng/storage/versioning, 1B policy, 2B policies, 3B validation, shared rng logging) plus artefacts/manifests and schema/LICENSE/ci stubs.

* 8:31am
   - Added tools/build_contracts_pack.py to generate consolidated contract packs under contracts/model_spec and created contracts/model_spec/README.md with regeneration instructions.
   - Added make target contracts-pack and CONTRACTS_PACK_TAG variable to run the generator.

* 8:33am
   - Noted user question about reference/ layout being unsorted; starting audit against model_spec reference path contracts.

* 8:34am
   - Audited reference/ against model_spec contract paths: all contract static reference paths exist; found extra reference files not referenced by current contracts (multiple vintage copies, QA/manifest/source artifacts, and unrelated domains like ip_geo/web_traffic).

* 8:36am
   - Moved 58 non-contract reference files into reference/_untracked (preserved original structure) and cleaned empty reference directories.

* 8:41am
   - User requested a detailed implementation review document for segment 1A; preparing to propose storage location under docs/model_spec/data-engine/implementation_maps/ pending confirmation.


* 8:57am
   - Normalized 2A schema partition keys and field names to manifest_fingerprint (s0_gate_receipt_v1, sealed_inputs_2A, checks_v1, s1_tz_lookup, site_timezones).
   - Updated 2A state-flow docs to replace fingerprint token/partition labels with manifest_fingerprint and corrected manifest_manifest_fingerprint path typos.
   - Updated 2A design DAG docs to use manifest_fingerprint path tokens and partitions; fixed sealed_inputs path token typo.
* 8:46am
   - Starting code-first implementation review for Segment 1A from packages/engine; will document S0-S9 without using impl maps.

* 9:06am
   - Reviewed S5 currency weights implementation (runner/builder/policy/loader/persist/merchant_currency/validate) for inputs, outputs, receipts, and staging behavior.
   - Reviewed S6 foreign selection implementation (runner/builder/loader/policy/writer/persist/validate/types/constants) including gumbel RNG logging, membership output, receipt enforcement, and metrics logging.
   - Reviewed S7 integer allocation implementation (runner/loader/kernel/policy/writer/validate/types/constants) including residual_rank events, optional dirichlet gamma vector lane, and policy defaults.
   - Reviewed S8 outlet catalogue pipeline (runner/loader/kernel/persist/validate/contexts/types/constants) including stage logs, sequence events, validation bundle, and partition token handling.
   - Reviewed S9 validation pipeline (runner/loader/validator_core/persist/contexts/constants) including schema validation, RNG budget accounting, and bundle construction paths.
* 9:10am
   - Authored `docs/model_spec/data-engine/implementation_maps/segment_1A.impl_review.md` with a code-derived, state-by-state implementation review for Segment 1A (S0-S9), including entrypoints, inputs/outputs, logs, validation, and observed contract alignment notes.

* 9:16am
   - Normalized manifest_fingerprint path tokens/partition labels across state-flow docs for 2B, 3A, 3B, 5A, 5B, 6A, and 6B.
   - Removed remaining manifest_manifest_fingerprint typos and fingerprint token shorthands (e.g., fingerprint={mf}, fingerprint={F}) in those state specs.

* 9:20am
   - Normalized manifest_fingerprint partition keys and column names in 2B/3A/3B schema packs (schemas.2B.yaml, schemas.3A.yaml, schemas.3B.yaml).
   - Updated 2B s7_audit_report_v1 schema to use manifest_fingerprint in required/properties; aligned plan table partition_keys to manifest_fingerprint.

* 9:29am
   - Updated dictionary/registry descriptions to use manifest_fingerprint terminology across 1A, 1B, 2A, 5A, 5B, 6A, and 6B contract packs.

* 10:20am
   - Normalized manifest_fingerprint wording across 2B state-flow docs (S0â€“S8), including path tokens, partition labels, JSON examples, and identity prose.
   - Corrected 2B state-flow references to Layer-1 Â· 2A (removed Layer-2 mislabeling).
   - Updated 2B schema description text to use manifest_fingerprint wording.

* 11:16am
   - Normalized manifest_fingerprint wording across 3A state-flow docs (S0â€“S7), including path tokens, partition labels, JSON examples, and identity prose; fixed manifest_manifest_fingerprint typos.

* 11:26am
   - Clarified 3A governed parameter set inclusion for `country_zone_alphas` and `zone_floor_policy` in 3A.S0; removed a duplicated manifest_fingerprint wording glitch.

* 12:02pm
   - Normalized manifest_fingerprint token/partition wording across 3B state-flow docs (S0-S5), including removal of manifest manifest_fingerprint typos.
   - Clarified 3B.S0 parameter_hash governance to include sealed policy/config artefacts listed in Cross-Layer Inputs.

* 12:09pm
   - Swept 3B contract packs (dictionary/registry/schema) for non-manifest_fingerprint token wording; no remaining mismatches found.

* 12:51pm
   - Ran a full drift check of segment_1B implementation map against current 1B contracts/state specs; recorded mismatches for sources list, run-report paths, sealed_inputs ordering, and governance input coverage.

* 1:00pm
   - Updated segment_1B implementation map sources to .md and refreshed state doc hashes.
   - Aligned 1B impl map run-report address templates with dictionary paths and fixed sealed_inputs_1B ordering.

* 1:10pm
   - Aligned 1B.S0 wording to use dictionary governance IDs (`numeric_policy_profile`, `math_profile_manifest`) for sealed inputs.

* 2:17pm
   - Standardized 5A state-flow docs to use manifest_fingerprint token naming throughout (partition keys and examples) and clarified S0 PASS gating language.

* 3:13pm
   - Updated segment_2A implementation map sources to .md with refreshed state hashes and added schemas.layer1.yaml to the source list.
   - Aligned sealed_inputs_2A ordering in the 2A impl map with the dataset dictionary.
* 12:03pm
   - Reviewed segment 1A implementation against `segment_1A.impl_map.md/.yaml`, noting mismatches in parameter_hash inputs, S0 outputs/gates, RNG log paths, S8/S9 validation bundle paths, and in-memory vs on-disk state boundaries.
* 12:10pm
   - Rewrote `docs/model_spec/data-engine/implementation_maps/segment_1A.impl_review.md` to document impl-vs-impl_map drift findings and open questions, replacing the prior code-only narrative.
* 12:19pm
   - Reduced Segment 1A S0 `_REQUIRED_PARAMETER_FILES` to the impl_map-governed basenames and added optional policy basenames into the parameter_hash only when provided.
* 12:21pm
   - Updated `docs/model_spec/data-engine/implementation_maps/segment_1A.impl_review.md` to mark the parameter_hash drift as resolved and added a status summary noting remaining open items.

* 12:33pm
   - Decided to emit S0 sealed_inputs_1A by matching manifest artefacts against the 1A artefact registry (path-template match); fall back to basename asset_id, basename version_tag, empty partition map, and `"unknown"` schema_ref when no registry match is found.
   - Implemented S0 outputs/gates: write `sealed_inputs_1A.json`, `s0_gate_receipt.json`, and an empty `merchant_abort_log` partition from `packages/engine/.../s0_foundations/l2/output.py` using dataset dictionary paths.
   - Updated S0 failure records to use `validation/failures/manifest_fingerprint=...` paths and aligned the runner call signature.
   - Normalized validation bundle path tokens to `manifest_fingerprint` (S2/S4 bundle fallbacks, S8 partition token check, S9 bundle path resolution via dictionary, S9 partition token validation).
   - Aligned Segment 1A RNG log roots to `logs/layer1/1A/rng/...` across S0-S7 writers/validators and the S5 RNG snapshot helper; updated the 1A dataset dictionary RNG paths to match.
   - Updated `contracts/dataset_dictionary/l1/seg_1A/layer1.1A.yaml` to add `merchant_abort_log`, `sealed_inputs_1A`, `s0_gate_receipt_1A`, switch validation/outlet paths to manifest_fingerprint tokens, and move RNG logs to the layer-scoped root.

* 12:51pm
   - Updated makefile validation bundle paths to use `validation/manifest_fingerprint=...` and broadened segment1b receipt parsing to accept `manifest_fingerprint=` tokens.
   - Adjusted scenario calendar build to read 3A zone_alloc under `manifest_fingerprint=...` directories.

* 1:03pm
   - Added run-path macros (data/logs/artefacts/config) and validation bundle helpers to the makefile for consistent path construction.
   - Re-grouped Segment 1A argument construction into parameter-pair lists and shared param args, plus a dedicated preflight target to check reference/config files before running.
   - Switched validation bundle assignments to the shared bundle macros and updated 2A run artefact paths to use the new run-root macros.

* 1:28pm
   - Updated Segment 1A 2B policy paths in the makefile to point at the newer governed files under `contracts/policy/2B` (alias_layout/day_effect/route_rng/virtual_edge).
   - Verified Segment 1A required refs and param inputs resolve with no missing files.

* 1:38pm
   - Confirmed model_spec contract paths for 2B policies point to `config/layer1/2B/policy/*.json`.
   - Moved the 2B policy files (alias_layout/day_effect/route_rng/virtual_edge) into `config/layer1/2B/policy` and removed the duplicate copies from `contracts/policies/l1/seg_2B`.
   - Updated references to the old contracts policy paths in tests, scripts, design docs, and layer-1 dictionaries/registries to use the contractual config path.

* 1:53pm
   - Confirmed model_spec only references `virtual_rules_policy_v1` under 3B contracts/data-intake, not Segment 2B.
   - Removed `virtual_rules_policy_v1` from the 2B dataset dictionary and 2B schema pack; dropped it from 2B S0 required policy IDs and Makefile preflight params.
   - Updated 2B S5 router to stop loading `virtual_rules_policy_v1`/merchant_mcc_map, default auto-arrivals to non-virtual, and remove the virtual_routing run-report section.
   - Updated 2B S5 router tests to remove virtual_rules fixtures/merchant_mcc_map dependencies and adjust virtual-arrival expectations.
   - Deleted `contracts/policies/l1/seg_2B/virtual_rules_policy_v1.json` (no 2B contract path per model_spec).
   - Removed the unused 2B virtual-classifier helper module and dropped it from the shared exports list.

* 2:01pm
   - Ran a literal-path scan of `makefile` assignments to confirm all hard-coded directories/files currently exist; no missing literal paths detected.

* 2:11pm
   - Fixed Segment 1A CLI staging to use the contract path for `world_countries` (`reference/spatial/world_countries/2024/world_countries.parquet`) after `make all` failed on the old 2025-10-08 source.

* 2:20pm
   - Updated 1A S7 policy defaults to the model_spec contract paths for `s3.thresholds.yaml`, `residual_quantisation.yaml`, and `dirichlet_alpha_policy.yaml` to resolve the residual policy lookup failure during `make all`.

* 2:27pm
   - Fixed 1A S1 hurdle validation to read RNG logs from `logs/layer1/1A/rng/...`, matching the updated writer path and resolving the missing JSONL error.

* 2:52pm
   - Updated the 1A dataset dictionary reference paths to align with model_spec: `world_countries` -> `reference/spatial/world_countries/2024/...`, `tz_world_2025a` -> `reference/spatial/tz_world/2025a/tz_world.parquet`, and `population_raster_2025` -> `reference/spatial/population/2025/population.tif`.
   - Reworked Segment 1A CLI Segment1B reference staging to resolve source/destination paths via the 1A dataset dictionary (removing hard-coded reference paths) so staging follows contract updates.

* 2:54pm
   - Corrected Segment 1A S6 selection policy default to `config/layer1/1A/policy.s6.selection.yaml` to match contract paths when no CLI override is supplied.

* 3:21pm
   - Normalized `segment_2A.impl_map.yaml` and `segment_2A.impl_map.md` to ASCII-only wording (no arrows/epsilon/box-drawing characters).
   - Clarified manifest_fingerprint-scoped phrasing and tightened the S3/S5 text to reference manifest_fingerprint consistently.
   - Rewrote the 2A relationship diagram in the impl map to a clean ASCII version.

* 3:26pm
   - Standardized 2A state-expanded docs to use `manifest_fingerprint` tokens/labels and updated token examples to match dictionary paths.
   - Corrected accidental `manifest_manifest_fingerprint` token duplication introduced during the token sweep.

* 4:06pm
   - Updated `segment_2B.impl_map.yaml` sources to reference `.md` state docs and refreshed the source hashes.
   - Normalized 2B implementation maps to ASCII-only text and fixed `manifest_fingerprint` wording/notes.
   - Removed over-specific RNG stream key templates in S3/S5/S6 to align with policy-defined stream/counter rules.

* 3:21pm
   - Verified `docs/model_spec/data-engine/implementation_maps/segment_1B.impl_review.md` already contains the code-derived Segment 1B implementation review with hardcoded-path flags; no edits required before reporting.

* 3:31pm
   - Compared Segment 1B implementation review against the 1B impl map and model_spec contracts; identified drift items (sealed_inputs_1B missing, run-report/run-summary paths vs reports/..., manifest_fingerprint token mismatches, RNG log root path mismatch, extra uncontracted summaries/failure logs, and contract-input discrepancies like tz_world_2025a + s3_candidate_set consumption).
   - Updated Segment 1B S7/S8 materialise + validators to resolve run-summary paths via the dataset dictionary instead of hardcoded dataset_path.parent.

* 3:40pm
   - Added `tools/sync_contracts_from_model_spec.py` to generate a clean contracts/ mirror from model_spec layer contracts with filename mapping.
   - Updated makefile to add `contracts-sync` and make `contracts-pack` depend on it.
   - Ran the sync script to refresh contracts/ from model_spec and generated `contracts/_mirror_manifest.json` for audit.
   - Audited contracts/ for files not produced by the mirror for deletion candidates.

* 3:52pm
   - Moved duplicate `contracts/artefact_registry_3B.yaml` into `contracts/_stale/` after confirming the mirrored `contracts/artefact_registry/artefact_registry_3B.yaml` is authoritative.
   - Rewrote `contracts/AGENTS.md` to reflect the model_spec mirror process and correct source paths.
   - Noted that `contracts/schemas/l1/seg_1A/*.schema.json` and `contracts/policies/l1/seg_1A/*.yaml` remain because they are still referenced by code/tests/docs.

* 4:17pm
   - Added a shared 1A schema loader to resolve schema-pack refs (YAML/JSON) and normalize table definitions into JSON Schema payloads.
   - Updated 1A SchemaAuthority refs, S0 validators, and tests/scripts to use schema-pack refs under `contracts/schemas/layer1` instead of `*.schema.json`.
   - Reworked S3 and S6 validators to load schemas from `schemas.1A.yaml`/`schemas.layer1.yaml` packs via the shared loader (removed legacy JSON schema file usage).
   - Updated S9 schema file resolution to use the contracts mirror for schema packs (removed model_spec hard-coded path).
   - Adjusted CLI help text to point validation policy examples at `config/layer1/1A/policy/validation_policy.yaml`.

* 4:18pm
   - Reviewed `segment_3A.impl_map.yaml` and `segment_3A.impl_map.md` against 3A state-expanded docs and the 3A dictionary/registry.
   - Added `utc_day` to impl-map path tokens and wired `segment_state_runs` outputs for S0-S7.
   - Added per-state run-report outputs (`s1_run_report_3A`..`s7_run_report_3A`, plus `s2_run_report_3A`) to the corresponding state write lists.
   - Aligned S6 output paths and ordering with the dictionary (`s6_validation_report_3A` -> `report.json`, `s6_issue_table_3A` -> `s6_issues/.../issues.parquet`, ordering by `severity/issue_code/merchant_id/legal_country_iso/tzid`).
   - Corrected `zone_alloc_universe_hash` schema_ref to `schemas.3A.yaml#/validation/zone_alloc_universe_hash` to match the dictionary.
   - Standardized `_passed.flag` wording to the single-line ASCII format (`sha256_hex = <hex64>`) in gate rules and S7 notes.
   - Cleaned remaining typos in the 3A impl-map narrative (alpha wording, country x tzid).

* 4:19pm
   - Normalized `segment_state_runs` partitioning to `[utc_day]` in the layer-1 (1A, 3A) and layer-2 (5A, 5B) dataset dictionaries to match the path templates.

* 4:23pm
   - Moved legacy 1A schema/policy artifacts into `contracts/_stale/` and removed empty `contracts/policy/` + `contracts/model_spec/`.
   - Updated Makefile and runbook/README references from `contracts/policies/...` to the config paths (keeping bounds policy as legacy under `contracts/_stale/`).
   - Aligned `contracts/AGENTS.md` to point legacy policy references at `contracts/_stale/policies/`.

* 4:24pm
   - Flattened `contracts/_stale/policies/` after the move produced a nested `policies/policies` path so Makefile preflight resolves `policy.s3.bounds.yaml` under `contracts/_stale/policies/l1/seg_1A/`.

* 4:58pm
   - Updated 1A dataset dictionary resolution to support list-based sections (model_spec format) so `settlement_shares_2024Q4` and similar IDs resolve correctly from `contracts/dataset_dictionary/l1/seg_1A/layer1.1A.yaml`.

* 5:03pm
   - Fixed indentation in `schemas.3A.yaml` policy block under model_spec and re-synced contracts with `--force` so Segment 3A schema parsing no longer fails at import time.

* 5:20pm
   - Added the 1A S0 RNG anchor event to the model_spec dataset dictionary (rng_event_anchor) with logs/layer1/1A/rng/events/anchor path and schema_ref.
   - Added the corresponding schema entry under schemas.layer1.yaml#/rng/events/anchor (module=1A.s0, substream_label=s0.anchor, non-consuming budgets).
   - Re-synced contracts from model_spec with tools/sync_contracts_from_model_spec.py --force so the contracts mirror includes the new rng_event_anchor definitions.

* 5:27pm
   - Added tools/preflight_seg1a_contracts.py to validate Segment 1A dictionary schema_ref pointers and ensure code-referenced dataset IDs exist in the dictionary.
   - Wired the new contracts preflight into makefile preflight-seg1a so contract drift is caught before running Segment 1A.

* 5:28pm
   - Ran tools/preflight_seg1a_contracts.py; it failed because code references rng_event.nb_final, rng_event.sequence_finalize, and rng_event.site_sequence_overflow which are missing from the 1A dataset dictionary (underscore variants exist).

* 5:37pm
   - Normalized Segment 1A RNG dataset IDs in code to match dictionary IDs (rng_event_nb_final, rng_event_sequence_finalize, rng_event_site_sequence_overflow) and updated the RNG mapping for event path resolution.
   - Updated the S6 gumbel writer docstring to reference the underscore-form dataset ID for consistency.
   - Re-ran tools/preflight_seg1a_contracts.py to confirm the contract checks pass.

* 5:42pm
   - Reviewed artefact registry and dataset dictionary entries to confirm hurdle_design_matrix format/path; verified format is specified in the dataset dictionary (parquet) and parameter_hash partitioning is expected in output paths.

* 5:48pm
   - Updated S0 parquet writer to append part-00000.parquet when the dictionary path resolves to a directory (no .parquet suffix), ensuring outputs like hurdle_design_matrix land under the parameter_hash partition with proper parquet filenames.

* 7:12pm
   - Updated 6B contract packs: set `sealed_inputs_6B` to `format: json` in the 6B dataset dictionary and fixed the mis-indented `sealed_inputs_6B` entry in the 6B artefact registry.
   - Standardized 6B state-flow docs to use `manifest_fingerprint` token naming, removed stray `manifest_manifest_fingerprint` typos, and aligned S1â€“S4 partitioning + path templates to include `parameter_hash` alongside `seed`, `manifest_fingerprint`, and `scenario_id` where the dictionary requires it.
   - Updated 6B S3/S4 campaign + case-timeline scope references to the `(manifest_fingerprint, parameter_hash, seed, scenario_id)` axes and fixed identity/partitioning bullets to match dictionary scopes.
   - Replaced sealed_inputs_6B parquet wording with JSON and added RNG family mapping notes in S2/S3/S4 to tie conceptual families to the registered RNG datasets.

## 2026-01-10 19:22:47
- Continued 6B normalization pass: standardized token naming to `manifest_fingerprint` in 6B state-flow docs, including replacing fingerprint-only/scoped/partitioned phrases and fixing remaining list/examples using `fingerprint` as a token label.
- Updated 6B state docs to remove remaining token mismatches and corrected a stray `manifest_manifest_fingerprint` typo in S5.
- Confirmed `sealed_inputs_6B` is `format: json` in `docs/model_spec/data-engine/layer-3/specs/contracts/6B/dataset_dictionary.layer3.6B.yaml` and verified registry entry indentation in `docs/model_spec/data-engine/layer-3/specs/contracts/6B/artefact_registry_6B.yaml`.

## 2026-01-10 19:41:21
- Normalized 6A state-flow docs to align with dictionary partitioning: added `parameter_hash` to S1â€“S5 partition keys, scope tuples, and path templates where required.
- Standardized 6A token naming to `manifest_fingerprint` and removed residual fingerprint shorthand in examples and binding rules.
