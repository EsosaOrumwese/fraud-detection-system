# Logbook
### Date: 29th January 2026
### Project: Fraud Detection System
### Reference commits: Check commits on this date (if any)

* 12:32am
  - Pruned legacy IG pull/READY Make targets per request (streaming‑only entrypoints remain).

* 12:36am
  - Normalized today’s logbook header to match the standard format used in prior days.

* 12:40am
  - Planned IG Phase 9 validation (push‑only): defined acceptance criteria, local smoke steps, and config enforcement checks in `docs/model_spec/platform/implementation_maps/ingestion_gate.impl_actual.md`.

* 12:45am
  - Ran IG Phase 9 push‑only tests: `.\\.venv\\Scripts\\python.exe -m pytest tests/services/ingestion_gate -q` → 16 passed, 1 skipped (Werkzeug deprecation warnings).

* 1:08am
  - Planned WSP READY consumer runner so SR can drive WSP automatically; documented design intent, idempotency strategy, and test plan in `docs/model_spec/platform/implementation_maps/world_streamer_producer.impl_actual.md`.

* 1:11am
  - Implemented WSP READY consumer runner (file‑bus): reads READY + run_facts_view, resolves scenario_id + engine_run_root, streams via WSP, and appends READY run records.
  - Added Make targets for READY consumer and unit tests for READY handling + duplicate skip.

* 1:12am
  - Fixed READY consumer tests (created temp object-store root before writing allowlist).
  - Re‑ran WSP tests: `.\\.venv\\Scripts\\python.exe -m pytest tests/services/world_streamer_producer/test_ready_consumer.py tests/services/world_streamer_producer/test_runner.py -q` → 6 passed.

* 1:39am
  - Diagnosed IG `SCHEMA_FAIL` quarantines during SR→WSP→IG run; found arrival_events_5B policy referenced array schema while payloads are single-row objects.
  - Updated `config/platform/ig/schema_policy_v0.yaml` to validate `#/egress/s4_arrival_events_5B/items` and documented the reasoning trail in `docs/model_spec/platform/implementation_maps/ingestion_gate.impl_actual.md`.

* 1:43am
  - Increased local WSP stream pacing (`policy.stream_speedup`) from 60 → 600 in `config/platform/profiles/local.yaml` to keep smoke runs fast while preserving ordering; documented in WSP impl_actual.

* 1:47am
  - Fixed IG schema fragment resolution: `_load_schema_ref` now grafts root `$defs`/`$id`/`$schema` onto fragment schemas so item validation can resolve `$ref` entries.

* 1:52am
  - Updated IG payload schema validation to use a registry‑backed Draft202012Validator with fragment `$ref` wrappers, so external schema refs like `schemas.layer1.yaml#/$defs/hex64` resolve correctly.

* 1:55am
  - Fixed relative schema refs by assigning `$id` to the base schema URI when missing; this gives the registry a proper base for `schemas.layer1.yaml#/$defs/…`.

* 2:00am
  - Added fallback schema resolution: if a referenced schema filename is missing under `schema_root`, search `docs/model_spec/data-engine/**/<name>` to resolve shared defs like `schemas.layer1.yaml`.

* 2:04am
  - Adjusted IG payload schema loading: refs starting with `docs/` now resolve from repo root instead of `schema_root`, matching how the schema_policy paths are written.

* 2:08am
  - Added nullable normalization for IG payload schemas: `nullable: true` now expands to `null` in JSON Schema so engine rows with nulls validate.

* 2:11am
  - Re‑ran SR→WSP (cap 20) and confirmed IG now validates + admits `arrival_events_5B` (no new schema failures).

* 2:16am
  - Added `platform-smoke` Make target to run SR→WSP→IG smoke with a generated equivalence key and capped events (requires IG service in another terminal).

* 2:23am
  - Drafted EB v0 build plan (streaming‑only) and created `docs/model_spec/platform/implementation_maps/event_bus.build_plan.md`; logged initial decision trail in `event_bus.impl_actual.md`.

* 2:28am
  - Locked EB v0 decisions (partitioning, offset shape, checkpoint store) and updated `event_bus.build_plan.md`; logged decision trail in `event_bus.impl_actual.md`.

* 2:37am
  - Drafted EB Phase 1 detailed plan (contracts + interface), including receipt shape updates and EB module placement; logged in `event_bus.impl_actual.md`.

* 5:13am
  - Correction: earlier logbook entries marked ~2:23–2:37am were written with incorrect timestamps. Actual local time now is 5:13am (verified via Get-Date). Future entries will use system time.

* 5:23am
  - Implemented EB Phase 1 (contracts + interface), updated IG receipt shape, added EB contract, moved EB interface to shared module, and migrated IG indices; tests: 8 passed.

* 5:34am
  - Drafted EB Phase 2 plan (local file‑bus durability + stable offsets), logged in `event_bus.impl_actual.md` with decision point on offset source.

* 5:37am
  - Implemented EB Phase 2 local file‑bus durability (head.json offsets, fsync, published_at_utc) and recovery rules; added event_bus tests; tests now 3/3 passing after head/log precedence fix.

* 6:07am
  - Planned EB Phase 3 (local replay/tail utilities) in `event_bus.impl_actual.md`.

* 6:09am
  - Implemented EB Phase 3 local replay/tail utilities (EventBusReader + CLI) and added tests; 2/2 passed.

* 6:13am
  - Implemented EB Phase 4 hardening (IG→EB publish failure accounting + published_at persistence for duplicate receipts); tests green.

* 6:15am
  - Planned EB Phase 5 (dev adapter parity via Kinesis/LocalStack) in `event_bus.impl_actual.md` with publish‑only scope.

* 6:18am
  - Implemented EB Phase 5 Kinesis publish adapter + dev profile wiring; added env‑gated LocalStack smoke test (skipped without endpoint).

* 6:21am
  - Locked decision: v0 dev EB uses Kinesis; Kafka deferred to v1+. Documented in EB impl_actual and build plan.

* 6:27am
  - Aligned local file‑bus root to `runs/fraud-platform/<platform_run_id>/event_bus` for EB smoke runs (updated local profile).

* 6:33am
  - Ran local platform smoke chain (SR → WSP → IG → EB) for `platform_20260129T062946Z`; EB head advanced to `next_offset=20`, IG admitted offsets 1–19, and no fresh ERROR/SCHEMA_FAIL entries appeared in the 06:29–06:31 window. Logged details in `docs/model_spec/platform/implementation_maps/event_bus.impl_actual.md`.

* 6:48pm
  - Drafted a maximum‑parity local stack plan (compose + configs + stepwise migration) in `docs/model_spec/platform/implementation_maps/platform.build_plan.md`; logged the decision trail in `docs/model_spec/platform/implementation_maps/platform.impl_actual.md`.

* 6:59pm
  - Began implementing maximum‑parity local stack (MinIO + LocalStack + Postgres; Kinesis control/event buses; Postgres IG indices + WSP checkpoints). Detailed plan recorded in `docs/model_spec/platform/implementation_maps/platform.impl_actual.md`.

* 7:12pm
  - Implemented parity stack: added `infra/local/docker-compose.platform-parity.yaml`, `config/platform/profiles/local_parity.yaml`, Kinesis control‑bus reader for WSP, Postgres IG indices, and parity make targets/env defaults. Updated profile docs and dev/prod profile wiring.

* 7:13pm
  - Aligned SR local parity wiring to use `s3://fraud-platform` (single MinIO bucket) to remove extra bucket friction.

* 7:20pm
  - Fixed parity run friction: moved parity Postgres to port 5434 and defaulted parity AWS creds to MinIO credentials for S3 access. Logged details in `docs/model_spec/platform/implementation_maps/platform.impl_actual.md`.

* 7:32pm
  - Aligned SR parity wiring authority store DSN to `postgresql://platform:platform@localhost:5434/platform` to match parity Postgres.

* 7:34pm
  - Fixed SR parity S3 root to `s3://fraud-platform` so run_facts_view refs resolve in WSP (removed extra `sr/` prefix).

* 7:38pm
  - Logged parity smoke failure cause (IG service importing stale module). Planned makefile fix to force `PYTHONPATH=src` for platform targets before re‑running parity smoke and validating offsets/receipts.

* 7:46pm
  - Found IG runtime error was caused by a class indentation regression in `ingestion_gate/admission.py` (methods nested under `_build_indices`). Restored class structure and prepared to re‑run parity smoke.

* 7:47pm
  - Updated makefile platform targets to use `PY_PLATFORM` (`PYTHONPATH=src`) to ensure local runs use repo code.

* 7:54pm
  - Diagnosed parity publish failure: IG wiring left `${EVENT_BUS_STREAM}` and `${IG_ADMISSION_DSN}` unresolved. Patched `ingestion_gate/config.py` to resolve env placeholders for event bus path + admission DB path.

* 7:58pm
  - IG parity publish still failed due to missing LocalStack endpoint env. Updated `platform-ig-service-parity` to export `AWS_ENDPOINT_URL` + `AWS_DEFAULT_REGION`.

* 8:05pm
  - Hardened IG parity wiring by adding explicit event‑bus endpoint/region in profile + config loader; updated makefile defaults accordingly.

* 8:15pm
  - Parity smoke run succeeded with `PLATFORM_SMOKE_MAX_EVENTS=5`: SR READY published, WSP streamed 5 events, IG admitted all with kinesis offsets; receipts verified in Postgres.

* 11:36pm
  - Stopped IG parity service and marked parity alignment complete in `platform.impl_actual.md`.

* 11:51pm
  - Switched to run‑centric log layout: removed `platform_runs/` layer and global platform log; per‑run logs now live at `runs/fraud-platform/<platform_run_id>/platform.log`. Updated platform_runtime, services, makefile, and docs accordingly.
