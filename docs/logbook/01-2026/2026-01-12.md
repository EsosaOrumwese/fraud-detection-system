# Logbook
### Date: 12th January 2026
### Project: Fraud Detection System
### Reference commits: Check commits on this date (if any)

* 2:40am
   - Logged a detailed pre-implementation plan in `docs/model_spec/data-engine/implementation_maps/segment_1A.impl_actual.md` to close S6 spec gaps: rng_audit_log guard/append and counter-replay validation when log_all_candidates=false.

* 2:45am
   - Added S6 preflight audit-log guard: checks rng_audit_log for the run entry, appends one if missing (with git commit resolution), and fails in validate-only mode when missing.
   - Added counter-replay validation for existing gumbel_key logs: load existing events, enforce coverage rules for log_all_candidates vs selected-only, and fail on mismatches.
   - Added sanity checks for unexpected merchants or event-count mismatches when validating existing S6 outputs.

* 2:52am
   - Read S7 expanded spec and related contracts/policy files; logged a detailed pre-implementation plan + contract-gap list in `docs/model_spec/data-engine/implementation_maps/segment_1A.impl_actual.md`.

* 2:59am
   - Reorganized `docs/model_spec/data-engine/implementation_maps/segment_1A.impl_actual.md` headers: removed placeholder sections, normalized state headers, and inserted S5/S7 headers so entries sit under the correct state.

* 3:18am
   - Logged S7 implementation kickoff decisions in `docs/model_spec/data-engine/implementation_maps/segment_1A.impl_actual.md`, covering policy registration/sealing, deterministic-only lane enforcement, membership/currency gating, and resumability behavior.

* 3:22am
   - Planned IEG conceptual doc updates per review: enforce envelope field MUSTs (no payload parsing), align watermark_basis keys to EB partition_id, define watermark offset meaning, pin deterministic update_semantics_id in update_key, clarify resolve_identity conflict posture, define deterministic ordering for list outputs, and fix event_time format.

* 3:28am
   - Updated IEG conceptual doc to enforce envelope MUSTs (no payload parsing; reject/quarantine on missing IG/Canonical Envelope fields), align graph_version watermark_basis keys to EB partition_id strings, and define watermark offsets as next_offset_to_apply (exclusive).
   - Pinned update_key to update_semantics_id constant (ieg_update_semantics_v0), added deterministic ordering rules for list outputs, and specified RFC3339/ISO8601 event_time format (including edge timestamps).
   - Clarified resolve_identity conflict posture (return all candidates with resolution_status) and updated examples/acceptance text accordingly.

* 4:14am
   - Logged an in-process S7 plan to finish runner logic, fix the policy schema placement in `schemas.layer1.yaml`, add CLI/Makefile wiring, and run S0-S7 after code updates.

* 4:32am
   - Implemented the S7 runner (deterministic integerisation, membership/gumbel fallback, gating, residual_rank + trace emission, resumability checks) and added the S7 CLI + Makefile target.
   - Fixed policy schema placement so `dp_score_print`/`per_currency` live under `policy/s6_selection` and S7 policy stays minimal.
   - Added `S7_INTEGERISATION_POLICY` to `SEG1A_PARAM_PAIRS` for preflight coverage and removed the temporary `test.tmp` file.

* 4:40am
   - Updated S0 hashing to treat `s7_integerisation_policy.yaml` as required so parameter_hash includes the new policy.
   - Adjusted S7 to scope merchants by `ztp_final` presence (eligible subset), aligned membership validation with the `membership` table schema, and fixed merchant_currency parsing.
   - Ran S0-S7 through the new run_id `42c3411f6b2e9b0a5d94c32f382ad2a3`; S7 completed and emitted residual_rank + trace rows.

* 4:41am
   - Corrected logbook placement by moving the 3:22am and 3:28am IEG entries from `docs/logbook/01-2026/2026-01-11.md` into this file.
## 2026-01-12 04:44:03
- Proceeding with IEG spec patch: add IEG4_query_surface_and_versioning.md, propagate conflict-resolution semantics and watermark basis rules, and append a ResolveIdentityResponse CONFLICT example to the conceptual doc; update logbook accordingly.
## 2026-01-12 04:44:40
- Added IEG4 spec stub (specs/IEG4_query_surface_and_versioning.md) with query invariants, deterministic ordering, conflict posture, and graph_version watermark basis semantics.
- Added a ResolveIdentityResponse conflict example to spec-design/spec-design.identity_entity_graph.md.

* 4:55am
   - Updated S7 logging to clarify that missing `ztp_final` rows are expected for single-site or ineligible merchants per S4 gates; wording change only, no behavior change.

* 5:05am
   - Logged the pre-implementation plan for full S7 compliance: add bounds + dirichlet policy inputs, implement bounded Hamilton allocation, and emit dirichlet_gamma_vector with Philox-based gamma draws; noted parameter_hash impact and re-run requirement.

* 5:18am
   - Implemented S7 bounds + dirichlet lanes: extended the S7 policy schema/config with alpha0 and bounds multipliers, added bounded Hamilton logic, added dirichlet_gamma_vector emission with RNG counters + trace accounting, and updated validation/resume handling for the new event family.

* 5:21am
   - Ran `make segment1a-s0 segment1a-s1 segment1a-s2 segment1a-s3 segment1a-s4 segment1a-s5 segment1a-s6 segment1a-s7` to regenerate outputs after the S7 policy update; new run_id `f9464da476b321a568f15bdd68ae8357` (parameter_hash `628b15b9ad98a28eb45f89c8acf0cb4c99a4d3554b9f3b072cf1ec9636f7a5a0`).

* 5:40am
   - Enabled S7 bounds + dirichlet lanes in `config/layer1/1A/allocation/s7_integerisation_policy.yaml` to run the full spec paths on the next S0-S7 execution.

* 5:50am
   - Diagnosed S7 `F4:E_SCHEMA_AUTHORITY` in dirichlet_gamma_vector: schema rejects `gamma_raw=0.0` (exclusiveMinimum), observed on merchant `9736050671347577435` during a controlled re-run.
   - Decision: update `_gamma_mt1998` to resample when the computed gamma value is non-finite or `<= 0.0` (underflow in `alpha < 1` branch), preserving deterministic RNG accounting while guaranteeing schema compliance.

* 5:52am
   - Implemented the `_gamma_mt1998` resampling guard for the `alpha < 1` branch to prevent `gamma_raw=0.0` underflow.
   - Re-ran `make segment1a-s7` on run_id `85038e45e2b61e3ae4bb5a5185411555`; S7 completed with residual_rank + dirichlet outputs and trace rows (no schema failures).

* 5:59am
   - Completed S8 contract review (expanded spec + dictionary + schemas + registry) and logged a detailed pre-implementation plan in `docs/model_spec/data-engine/implementation_maps/segment_1A.impl_actual.md`.
   - Flagged the counts-handoff gap (S7→S8 in-process) and the `outlet_catalogue` partition key mismatch (`fingerprint` vs `manifest_fingerprint`) for resolution before coding.

* 6:08am
   - Recorded S8 implementation decisions after user approval: add S7→S8 counts handoff file in run tmp, align outlet_catalogue partition key to `manifest_fingerprint` in `schemas.1A.yaml`, merchant-scoped overflow handling, and `single_vs_multi_flag=true` for all rows.

* 6:25am
   - Started S8 implementation work: created the runner scaffold (constants, StepTimer/TraceAccumulator, append helper) and logged the in-process plan for remaining S8 helpers, event emission, CLI/Makefile wiring, and S0-S8 rerun.

* 7:12am
   - Triaged S8 failure `F4:E_COUNTS_SOURCE_MISSING` (counts_missing_merchant) after fallback to S7 counts handoff.
   - Inspected `_load_counts_handoff` in `packages/engine/src/engine/layers/l1/seg_1A/s8_outlet_catalogue/runner.py` and found a de-indentation bug: validation + accumulation logic sat outside the per-line loop, so only the final JSONL row populated `counts_map`.
   - Decision (pre-code): fix indentation so each JSONL line is validated/inserted; then rerun S8 on the same run_id to confirm counts coverage and unblock S8.

* 7:22am
   - After the handoff fix, S8 failed with `F4:E_SEQUENCE_DIVERGENCE` because `s3_site_sequence` exists but does not match S7’s domain/counts (S3 always emits sequencing, which is invalid under Variant B).
   - Decision (pre-code): add an explicit S3 integerisation/sequencing ownership policy (emit_counts/site_sequence flags), include it in `parameter_hash`, gate S3 outputs accordingly, and update S8 to read S3 counts/sequence only when the policy says they are emitted (no fallback from invalid S3 counts).

* 7:31am
   - Added `config/layer1/1A/policy/s3.integerisation.yaml` (emit flags), registered it in the artefact registry and schema pack, and included it in the S0 parameter hash.
   - First S0 rerun failed with `Unexpected parameter files: policy.s3.integerisation.yaml`; fixed by adding the new basename to `REQUIRED_PARAM_BASENAMES` in `s0_foundations/hashing.py`.

* 7:33am
   - Fixed S3/S8 timer logging errors (`_StepTimer.info()` only accepts a single string); converted new log calls to f-strings.
   - Re-ran S3–S7 on run_id `3172f8fefe676c4880b9b7c24ebba815` to generate outputs under the new parameter_hash.

* 7:35am
   - Ran S8 successfully on run_id `3172f8fefe676c4880b9b7c24ebba815` (counts source S7 handoff; sequencing disabled by policy).
   - S8 emitted `sequence_finalize` + trace rows and wrote `outlet_catalogue` with no overflow events.

* 5:01pm
   - Reviewed S9 expanded spec plus contract authorities (`schemas.layer1.yaml`, `schemas.1A.yaml`, `dataset_dictionary.layer1.1A.yaml`, `artefact_registry_1A.yaml`).
   - Logged the S9 pre-implementation plan in `docs/model_spec/data-engine/implementation_maps/segment_1A.impl_actual.md` covering bundle/index/passed-flag hashing, RNG envelope accounting, S1-S8 replay checks, path-embed equality, and gate/publish flow.
   - Open questions to resolve before coding: handling unexpected `s3_integerised_counts` when the S3 policy says emit=false, which bundle index schema to treat as authoritative (recommend 1A schema; keep hashes in `egress_checksums.json`), and whether to emit optional attestation artifacts (`param_digest_log.jsonl`, `fingerprint_artifacts.jsonl`, `numeric_policy_attest.json`).

* 5:12pm
   - Recorded user-approved S9 implementation decisions in `docs/model_spec/data-engine/implementation_maps/segment_1A.impl_actual.md`: fail-closed on counts-authority mismatch, index schema follows `schemas.1A.yaml#/validation/validation_bundle_index_1A`, and skip optional bundle artefacts for now.
   - Logged the counts-reconstruction ambiguity (residual_rank vs no S5 weights) and the chosen resolution path (derive counts from egress row counts when `s3_integerised_counts` absent, then enforce Σ-law + residual-order + sequence parity) for later review.

* 5:48pm
   - Logged an in-process S9 implementation entry in `docs/model_spec/data-engine/implementation_maps/segment_1A.impl_actual.md` covering lineage recomputation, RNG accounting, replay checks, and bundle hashing flow before coding.

* 6:31pm
   - Logged S9 runner alignment decisions in `docs/model_spec/data-engine/implementation_maps/segment_1A.impl_actual.md`: spec-compliant trace final-row selection, broader non-consuming family checks, egress vs hurdle/NB consistency checks, crossborder eligibility gating, and explicit failure on unexpected `s3_site_sequence` under Variant B.

* 6:58pm
   - Logged S9 schema-fix plan in `docs/model_spec/data-engine/implementation_maps/segment_1A.impl_actual.md`: switch nested table validation to `_table_pack` + `validate_dataframe`, validate stream tables via row-level schema adapter (avoid Draft202012Validator on `type: stream`), and add required `notes` column to bundle index entries.

* 7:00pm
   - Implemented the S9 schema validation fixes: added a row-level validator helper, switched nested table validations to `_table_pack` + `validate_dataframe`, updated RNG audit/trace + event validation to use row schemas, and added `notes: None` to bundle index entries with schema validation via `validation/validation_bundle_index_1A`.

* 7:02pm
   - Diagnosed S9 rerun failure: RNG event schema refs point to direct JSON Schema objects and rng core logs use `record` (not `columns`), so the row validator must support both schema styles; updated the plan accordingly and patched the validator logic.

* 7:08pm
   - Logged S9 fixes to apply next: recompute manifest fingerprint using `build_commit` from rng_audit_log (not current HEAD), drop trace parameter_hash checks (not in schema), and adapt nullable fields in stream-record schemas to accept nulls.

* 7:10pm
   - Implemented the S9 recompute + RNG log fixes: read build_commit from rng_audit_log for manifest recompute, added nullable-handling for record schemas, and removed trace parameter_hash validation.

* 7:27pm
   - Logged the next S9 fixes: remove the foreign-candidate eligibility override, scope S7 parity checks to ztp_final-in-scope merchants, drop S1/S2 finalize trace rows to satisfy the one-row-per-event rule, and compute trace keys from module/substream fields during reconciliation.

* 7:31pm
   - Logged the S9 rerun plan: regenerate S0-S8 outputs after removing S1/S2 trace-finalize rows so trace coverage matches spec, then run S9 on the new run_id and inspect `s9_summary.json` for any remaining spec gaps before further code changes.

* 7:36pm
   - S1 failed after rerun: `rng_trace_missing_or_totals_mismatch` because the trace validation still selects the row with max RNG counter, which is no longer the final cumulative row now that the finalize entry is removed. Plan: update S1 (and S2 if needed) to select the trace row by max `events_total` (then ts_utc/path as tie-breakers) so cumulative totals match the per-event trace log; re-run S0-S8 afterward.

* 7:38pm
   - Implemented the trace-row selection fix in S1 + S2 validators to select the row with the highest cumulative totals instead of max counter, preserving the one-row-per-event trace rule. Next step: re-run S0-S8 and S9 to validate.

* 7:50pm
   - Re-ran S0-S8 (new run_id `7a8beec89b568b684947bc564e9cb7c7`) and S9; S9 still FAIL with `E_FINALISER_CARDINALITY` (missing ztp_final for ineligible merchants), `E_S7_PARITY` (counts_missing_domain), and `E_TRACE_COVERAGE_MISSING` (trace_rows_total=0 due to trace parsing bug).
   - Plan: load eligibility flags using the correct schema path (`prep/crossborder_eligibility_flags`) so ineligible merchants are excluded; fix trace parsing indentation + update trace-row selection to spec ordering; relax missing-domain failures when counts are sourced from egress (treat missing countries as zero counts).

* 7:53pm
   - Implemented S9 fixes: corrected eligibility schema anchor to `prep/crossborder_eligibility_flags`, fixed trace-log parsing indentation so rows are counted, updated trace final-row ordering to match spec (events_total → ts_utc → counters), and suppressed counts_missing_domain when counts are inferred from egress. Next: rerun S9 on the same run_id.

* 7:57pm
   - S9 rerun still FAIL due to trace coverage/totals on S4 families sharing a single trace key (`module=1A.ztp_sampler`, `substream_label=poisson_component`). Plan: aggregate trace expectations per trace key (sum events/draws/blocks across families sharing the key) and use that for coverage/totals; record failures once per key. Implemented this aggregation and will rerun S9.

* 7:58pm
   - Re-ran S9 on run_id `7a8beec89b568b684947bc564e9cb7c7`; decision PASS with zero failures in `s9_summary.json` and all `rng_accounting.json` families showing `coverage_ok=true`. `_passed.flag` written under `data/layer1/1A/validation/manifest_fingerprint=48a1ede3915fd634888afcaf143f85216f574d287237fb6c11f78eb25837a746/`.
