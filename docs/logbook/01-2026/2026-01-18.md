# Logbook
### Date: 18th January 2026
### Project: Fraud Detection System
### Reference commits: Check commits on this date (if any)

* 12:20am
   - Read required context for Segment 3A (current focus: 3A.S2), including:
     - Conceptual design: `docs/references/closed-world-fraud-enterprise-conceptual-design.md`
       (router referenced `closed-world-enterprise-conceptual-design*.md`, which is not present).
     - Layer narratives: `docs/model_spec/data-engine/layer-1/narrative/narrative_1A-to-3B.md`,
       `docs/model_spec/data-engine/layer-2/narrative/narrative_5A-and-5B.md`,
       `docs/model_spec/data-engine/layer-3/narrative/narrative_6A-and-6B.md`.
     - Segment 3A expanded specs: `docs/model_spec/data-engine/layer-1/specs/state-flow/3A/state.3A.s0.expanded.md`,
       `docs/model_spec/data-engine/layer-1/specs/state-flow/3A/state.3A.s1.expanded.md`,
       `docs/model_spec/data-engine/layer-1/specs/state-flow/3A/state.3A.s2.expanded.md`,
       `docs/model_spec/data-engine/layer-1/specs/state-flow/3A/state.3A.s3.expanded.md`,
       `docs/model_spec/data-engine/layer-1/specs/state-flow/3A/state.3A.s4.expanded.md`,
       `docs/model_spec/data-engine/layer-1/specs/state-flow/3A/state.3A.s5.expanded.md`,
       `docs/model_spec/data-engine/layer-1/specs/state-flow/3A/state.3A.s6.expanded.md`,
       `docs/model_spec/data-engine/layer-1/specs/state-flow/3A/state.3A.s7.expanded.md`.
     - Segment 3A contracts: `docs/model_spec/data-engine/layer-1/specs/contracts/3A/schemas.3A.yaml`,
       `docs/model_spec/data-engine/layer-1/specs/contracts/3A/dataset_dictionary.layer1.3A.yaml`,
       `docs/model_spec/data-engine/layer-1/specs/contracts/3A/artefact_registry_3A.yaml`,
       and ingress schema `docs/model_spec/data-engine/layer-1/specs/contracts/1A/schemas.ingress.layer1.yaml`.
     - Segment 3A data-intake guides (dependency order):
       `docs/model_spec/data-engine/layer-1/specs/data-intake/3A/zone_mixture_policy_3A.md`,
       `docs/model_spec/data-engine/layer-1/specs/data-intake/3A/zone_floor_policy_3A.md`,
       `docs/model_spec/data-engine/layer-1/specs/data-intake/3A/country_zone_alphas_3A.md`.
     - Governed policy/prior payloads:
       `config/layer1/3A/allocation/zone_floor_policy.yaml`,
       `config/layer1/3A/allocation/country_zone_alphas.yaml`.
     - Current 3A implementation for alignment: `packages/engine/src/engine/layers/l1/seg_3A/s0_gate/runner.py`
       and `packages/engine/src/engine/layers/l1/seg_3A/s1_escalation/runner.py`.
     - Reviewed available run folders under `runs/` to confirm current test harness context.
   - No implementation-map entry added yet (context-only read). Will add a 3A.S2 plan entry before coding.

* 12:26am
   - Reviewed implementation-map history to align with prior engineer decisions:
     `docs/model_spec/data-engine/implementation_maps/segment_1A.impl_actual.md`,
     `docs/model_spec/data-engine/implementation_maps/segment_1B.impl_actual.md`,
     `docs/model_spec/data-engine/implementation_maps/segment_2A.impl_actual.md`,
     `docs/model_spec/data-engine/implementation_maps/segment_2B.impl_actual.md`,
     `docs/model_spec/data-engine/implementation_maps/segment_3A.impl_actual.md`.
   - Read engine orchestration tooling and contract routing:
     `makefile`, `packages/engine/AGENTS.md`, `packages/engine/README.md`,
     `packages/engine/src/engine/core/config.py`,
     `packages/engine/src/engine/core/paths.py`,
     `packages/engine/src/engine/core/logging.py`,
     `packages/engine/src/engine/core/errors.py`,
     `packages/engine/src/engine/core/hashing.py`,
     `packages/engine/src/engine/core/time.py`,
     `packages/engine/src/engine/contracts/source.py`,
     `packages/engine/src/engine/contracts/loader.py`,
     `packages/engine/src/engine/contracts/jsonschema_adapter.py`,
     `packages/engine/src/engine/cli/s0_gate_3a.py`,
     `packages/engine/src/engine/cli/s1_escalation_3a.py`.
   - Reviewed contract mirror guidance and layout: `contracts/AGENTS.md`, `contracts/README.md`.
   - Skimmed existing heavy-state runners for logging/progress conventions and tz handling:
     `packages/engine/src/engine/layers/l1/seg_2A/s2_overrides/runner.py`,
     `packages/engine/src/engine/layers/l1/seg_2A/s3_timetable/runner.py`.

* 12:53am
   - Re-read 3A.S2 expanded spec for implementation planning:
     `docs/model_spec/data-engine/layer-1/specs/state-flow/3A/state.3A.s2.expanded.md`.
   - Re-checked 3A contracts relevant to S2:
     `docs/model_spec/data-engine/layer-1/specs/contracts/3A/dataset_dictionary.layer1.3A.yaml`,
     `docs/model_spec/data-engine/layer-1/specs/contracts/3A/artefact_registry_3A.yaml`,
     `docs/model_spec/data-engine/layer-1/specs/contracts/3A/schemas.3A.yaml`.

* 12:55am
   - Reviewed policy authoring semantics for S2:
     `docs/model_spec/data-engine/layer-1/specs/data-intake/3A/zone_floor_policy_3A.md`,
     `docs/model_spec/data-engine/layer-1/specs/data-intake/3A/country_zone_alphas_3A.md`.
   - Re-opened governed prior/policy payloads for grounding:
     `config/layer1/3A/allocation/country_zone_alphas.yaml`,
     `config/layer1/3A/allocation/zone_floor_policy.yaml`.
   - Re-checked existing zone-universe derivation logic in S1 for alignment:
     `packages/engine/src/engine/layers/l1/seg_3A/s1_escalation/runner.py`.

* 1:12am
   - Appended detailed S2 decision + plan entry to the implementation map,
     capturing strict prior/universe alignment, lineage IDs, Z(c) derivation,
     tolerance, optional tz cache checks, and run-report posture:
     `docs/model_spec/data-engine/implementation_maps/segment_3A.impl_actual.md`.

* 1:21am
   - Added an S2 implementation-start entry to the implementation map, covering
     sealed_inputs format fallback, immutability comparison, output layout, and
     error-code mapping decisions:
     `docs/model_spec/data-engine/implementation_maps/segment_3A.impl_actual.md`.

* 1:26am
   - Reviewed the latest run log for logging cadence and narrative style:
     `runs/local_full_run-5/970b0bd6833be3a0f08df8e8abf0364c/run_log_970b0bd6833be3a0f08df8e8abf0364c.log`.
   - Re-opened S2 contracts + schema anchors for output columns and policy inputs:
     `docs/model_spec/data-engine/layer-1/specs/contracts/3A/dataset_dictionary.layer1.3A.yaml`,
     `docs/model_spec/data-engine/layer-1/specs/contracts/3A/schemas.3A.yaml`.
   - Re-checked S2 error-code definitions for mapping in the runner:
     `docs/model_spec/data-engine/layer-1/specs/state-flow/3A/state.3A.s2.expanded.md`.
   - Scoped Makefile wiring for new 3A.S2 CLI target.

* 1:45am
   - Implemented Segment 3A S2 runner + CLI + module export and wired Makefile:
     `packages/engine/src/engine/layers/l1/seg_3A/s2_priors/runner.py`,
     `packages/engine/src/engine/layers/l1/seg_3A/s2_priors/__init__.py`,
     `packages/engine/src/engine/cli/s2_priors_3a.py`,
     `makefile`.
   - Runner includes sealed input verification, Z(c) derivation, floor/bump
     application, output schema validation, immutability checks, and run-report
     emission per S2 spec with narrative logging.

* 1:47am
   - Fixed zone-count bucket aggregation to count every country (Counter update
     now uses the full list of counts instead of a set):
     `packages/engine/src/engine/layers/l1/seg_3A/s2_priors/runner.py`.

* 1:48am
   - Ran `make segment2b-s2` to validate the current run context; target
     completed successfully with existing outputs marked identical.

* 2:09am
   - Reviewed 3A.S3 expanded spec and contracts to prepare the S3 implementation
     plan and RNG design:
     - `docs/model_spec/data-engine/layer-1/specs/state-flow/3A/state.3A.s3.expanded.md`
     - `docs/model_spec/data-engine/layer-1/specs/contracts/3A/schemas.3A.yaml`
     - `docs/model_spec/data-engine/layer-1/specs/contracts/3A/dataset_dictionary.layer1.3A.yaml`
     - `docs/model_spec/data-engine/layer-1/specs/contracts/3A/artefact_registry_3A.yaml`
     - `docs/model_spec/data-engine/layer-1/specs/contracts/1A/schemas.layer1.yaml`
     - `docs/model_spec/data-engine/rdv_rails_constitution_v1.md` (RNG law)
   - Reviewed existing RNG implementations for reuse in S3 (Philox + Gamma +
     trace log patterns):
     - `packages/engine/src/engine/layers/l1/seg_1A/s1_hurdle/rng.py`
     - `packages/engine/src/engine/layers/l1/seg_1A/s2_nb_outlets/runner.py`
     - `packages/engine/src/engine/layers/l1/seg_1A/s7_integerisation/runner.py`
     - `packages/engine/src/engine/layers/l1/seg_2B/s5_router/runner.py`

* 2:26am
   - Confirmed S3 RNG decisions to implement:
     - `rng_stream_id` will be a SHA-256 hex digest of
       `3A.S3|zone_dirichlet|{merchant_id}|{country_iso}`.
     - Stream derivation will use `{manifest_fingerprint_bytes, seed}` as
       master material (no `run_id` in the key), consistent with 1A RNG
       patterns; `run_id` remains partition identity.
     - `rng_event_id` will remain null in `s3_zone_shares`.
     - Existing RNG logs: validate-and-skip if events+trace exist; fail closed
       on partial logs.
   - Began S3 implementation (runner + RNG helper + CLI + Makefile wiring).

* 2:46am
   - Implemented Segment 3A S3 (Dirichlet zone shares), including:
     - RNG helper (`mlr:3A.master`/`mlr:3A.zone_dirichlet` stream derivation).
     - S3 runner with S0/S1/S2 validation, deterministic sampling, RNG events,
       trace logging, immutability checks, and run-report emission.
     - CLI entrypoint + Makefile target wiring.
   - Files added/updated:
     - `packages/engine/src/engine/layers/l1/seg_3A/s3_zone_shares/rng.py`
     - `packages/engine/src/engine/layers/l1/seg_3A/s3_zone_shares/runner.py`
     - `packages/engine/src/engine/layers/l1/seg_3A/s3_zone_shares/__init__.py`
     - `packages/engine/src/engine/cli/s3_zone_shares_3a.py`
     - `makefile`

* 2:49am
   - Observed `make segment3a-s3` failure: run-report flagged
     `E3A_S3_012_INFRASTRUCTURE_IO_ERROR` with `'DataFrame' object has no
     attribute 'groupby'` during the S2 prior validation phase.
   - Appended a fix plan entry to
     `docs/model_spec/data-engine/implementation_maps/segment_3A.impl_actual.md`
     to replace pandas-style `groupby` with Polars `group_by`, then re-run
     `make segment3a-s3` to confirm green.

* 2:53am
   - Re-ran `make segment3a-s3`; S3 failed with
     `E3A_S3_003_PRIOR_SURFACE_INCOMPLETE` (`missing_countries_count=63`,
     `sample_country_iso=AD`).
   - Investigated S1/S2 outputs and found escalated countries are present in
     S2; identified a tuple-key mismatch from `partition_by(..., as_dict=True)`.
   - Logged a fix plan to unwrap `country_iso` tuple keys in
     `docs/model_spec/data-engine/implementation_maps/segment_3A.impl_actual.md`
     before re-running `make segment3a-s3`.

* 2:54am
   - Applied the tuple-key normalization fix in
     `packages/engine/src/engine/layers/l1/seg_3A/s3_zone_shares/runner.py`.
   - Re-ran `make segment3a-s3`; S3 completed successfully and published
     `s3_zone_shares` plus RNG logs for the run.
   - Recorded the outcome in
     `docs/model_spec/data-engine/implementation_maps/segment_3A.impl_actual.md`.

* 2:57am
   - Verified S3 run-report status is PASS for run_id
     `970b0bd6833be3a0f08df8e8abf0364c`.
   - Validated output integrity on `s3_zone_shares`: row count matches
     expected escalated-pairs × country zone counts (14800), no duplicate
     `(merchant_id, legal_country_iso, tzid)` keys, and per-pair
     `share_drawn` sums are ~1.0 (min/max within floating tolerance).
   - Adjusted the verification query to use `share_drawn` (output column) after
     initially checking for a non-existent `share` column.

* 3:04am
   - Reviewed 3A.S4 expanded spec to prepare implementation planning:
     `docs/model_spec/data-engine/layer-1/specs/state-flow/3A/state.3A.s4.expanded.md`.
   - Re-checked S4 schema/dictionary/registry anchors:
     `docs/model_spec/data-engine/layer-1/specs/contracts/3A/schemas.3A.yaml`,
     `docs/model_spec/data-engine/layer-1/specs/contracts/3A/dataset_dictionary.layer1.3A.yaml`,
     `docs/model_spec/data-engine/layer-1/specs/contracts/3A/artefact_registry_3A.yaml`.
   - Examined 1A integerisation logic for tie-break and rounding alignment:
     `packages/engine/src/engine/layers/l1/seg_1A/s7_integerisation/runner.py`.

* 3:18am
   - Confirmed S4 implementation decisions with the user:
     - Populate optional `fractional_target`, `residual_rank`, and
       `alpha_sum_country` in `s4_zone_counts`.
     - Reuse S3’s `TOLERANCE = 1e-12` for `share_sum_country` checks.
     - Enforce strict presence of S1/S2/S3 run-report rows with `status="PASS"`.
   - Appended these decisions to
     `docs/model_spec/data-engine/implementation_maps/segment_3A.impl_actual.md`
     before starting S4 code changes.

* 3:36am
   - Implemented 3A.S4 runner with deterministic floor+residual integerisation,
     strict upstream validations, narrative logging, and run-report emission:
     `packages/engine/src/engine/layers/l1/seg_3A/s4_zone_counts/runner.py`.
   - Added S4 module export and CLI:
     `packages/engine/src/engine/layers/l1/seg_3A/s4_zone_counts/__init__.py`,
     `packages/engine/src/engine/cli/s4_zone_counts_3a.py`.
   - Updated `makefile` with S4 args/cmd wiring, `segment3a-s4` target, and
     included S4 in the `segment3a` chain + `.PHONY` list.
   - Logged implementation details in
     `docs/model_spec/data-engine/implementation_maps/segment_3A.impl_actual.md`.

* 3:37am
   - Ran `make segment3a-s4`; S4 completed successfully for run_id
     `970b0bd6833be3a0f08df8e8abf0364c` and published `s4_zone_counts`.
   - Run-report written to
     `runs/local_full_run-5/970b0bd6833be3a0f08df8e8abf0364c/reports/layer1/3A/state=S4/seed=42/manifest_fingerprint=35c89fb31f5d034652df74c69ffbec7641b2128375ba5dd3582fb2e5a4ed2e08/run_report.json`
     with `status="PASS"`.

* 3:39am
   - Updated S4 runner to map missing S0/S1/S2/S3 artefacts to
     `E3A_S4_001_PRECONDITION_FAILED` instead of infrastructure errors.
   - Logged the correction in
     `docs/model_spec/data-engine/implementation_maps/segment_3A.impl_actual.md`.

* 3:39am
   - Re-ran `make segment3a-s4` after the precondition mapping change; S4
     completed successfully and detected an identical existing output (no
     overwrite).

* 4:05am
   - Reviewed 3A.S5 expanded spec for zone allocation egress + routing universe
     hash; focused on Steps 7-19 (domain checks, digest procedure, idempotence),
     and noted the routing-hash vs `zone_alloc_parquet_digest` recursion for
     clarification before coding.
   - Re-checked S5 contracts and policy artefacts:
     `docs/model_spec/data-engine/layer-1/specs/contracts/3A/schemas.3A.yaml`,
     `docs/model_spec/data-engine/layer-1/specs/contracts/3A/dataset_dictionary.layer1.3A.yaml`,
     `docs/model_spec/data-engine/layer-1/specs/contracts/3A/artefact_registry_3A.yaml`,
     `docs/model_spec/data-engine/layer-1/specs/contracts/2B/schemas.2B.yaml`,
     `config/layer1/2B/policy/day_effect_policy_v1.json`,
     `config/layer1/3A/policy/zone_mixture_policy.yaml`,
     `config/layer1/3A/allocation/zone_floor_policy.yaml`.
   - Reviewed hashing utilities and S4 runner patterns to mirror in S5:
     `packages/engine/src/engine/core/hashing.py`,
     `packages/engine/src/engine/layers/l1/seg_3A/s0_gate/runner.py`,
     `packages/engine/src/engine/layers/l1/seg_3A/s4_zone_counts/runner.py`.

* 4:12am
   - Confirmed S5 implementation decisions with the user:
     - Use a canonicalized `zone_alloc_parquet_digest` that masks
       `routing_universe_hash` (fixed hex-zero string) to avoid recursion;
       document this as an approved deviation from the literal digest text.
     - Emit escalated pairs only (S4 domain); do not project monolithic pairs.
     - Populate optional `alpha_sum_country` in `zone_alloc` for auditability.
   - Will append a detailed S5 plan + deviation entry to the implementation map
     before coding.

* 4:34am
   - Implemented Segment 3A S5 (zone allocation egress + routing universe hash)
     with masked digest rule, strict gating, domain checks, and idempotent
     publish:
     - `packages/engine/src/engine/layers/l1/seg_3A/s5_zone_alloc/runner.py`
     - `packages/engine/src/engine/layers/l1/seg_3A/s5_zone_alloc/__init__.py`
     - `packages/engine/src/engine/cli/s5_zone_alloc_3a.py`
     - `makefile`
   - Ran `make segment3a-s5` for run_id `970b0bd6833be3a0f08df8e8abf0364c`:
     PASS, outputs written and on re-run detected as identical (idempotent).
   - Recorded the implementation + run outcome in
     `docs/model_spec/data-engine/implementation_maps/segment_3A.impl_actual.md`.

* 6:51am
   - Began S6 contract review:
     - `docs/model_spec/data-engine/layer-1/specs/state-flow/3A/state.3A.s6.expanded.md`
     - `docs/model_spec/data-engine/layer-1/specs/contracts/3A/schemas.3A.yaml`
     - `docs/model_spec/data-engine/layer-1/specs/contracts/3A/dataset_dictionary.layer1.3A.yaml`
     - `docs/model_spec/data-engine/layer-1/specs/contracts/3A/artefact_registry_3A.yaml`
   - Noted required S6 check registry (CHK_S0..CHK_STATE_STATUS_CONSISTENCY),
     RNG log inputs for S3, and S6 outputs (report, issue table, receipt).

* 6:53am
   - User approved S6 implementation recommendations:
     - Use 1e-12 tolerance for `CHK_S3_SHARE_SUM` (align with S3/S4).
     - Treat `CHK_STATE_STATUS_CONSISTENCY` as WARN-level (not FAIL).
     - Recompute S5 `zone_alloc_parquet_digest` using masked routing hash rule.
   - Proceeding to add the S6 plan entry to the implementation map before coding.

* 6:55am
   - Locked S6 pre-coding decisions:
     - Always emit `s6_issue_table_3A` (empty if no issues) to avoid missing
       dataset ambiguity for S7 and ops tooling.
     - Compare report/receipt immutability using canonical JSON bytes (sorted
       keys, no whitespace), matching S5 output discipline.
     - Apply a single share-sum tolerance (1e-12) with FAIL on breach (no WARN
       band beyond the dedicated WARN check).
     - Reuse approved S5 masked digest rule for `zone_alloc_parquet_digest`.
   - Appended the corresponding implementation-map entry in
     `docs/model_spec/data-engine/implementation_maps/segment_3A.impl_actual.md`.

* 7:39am
   - Resumed S6 implementation after a stub runner was created; documented the
     resume plan and additional decisions in the implementation map.
   - Immediate plan: complete the full S6 runner (checks + outputs +
     immutability), add CLI + Makefile wiring, remove the temporary `test.txt`,
     then run `make segment3a-s6` and iterate to green.
   - Added a new entry to
     `docs/model_spec/data-engine/implementation_maps/segment_3A.impl_actual.md`
     capturing the resumed design decisions and stepwise plan.

* 8:02am
   - Implemented the full 3A.S6 runner, added CLI + Makefile wiring, and
     removed the temporary `test.txt`.
   - Fixed S6 runtime issues discovered during `make segment3a-s6`:
     - Polars overflow on `merchant_id` in RNG event pairs by switching to
       `UInt64` schema + `orient="row"`.
     - Issue-table schema validation conflict by treating `None` optional
       fields as "absent" during JSON-schema validation (documented as a
       pragmatic spec interpretation).
   - Re-ran `make segment3a-s6`; S6 completed and published report, issue
     table, and receipt. `overall_status` is FAIL due to
     `CHK_S3_RNG_ACCOUNTING` trace mismatch (issue table captured details).
   - Appended a detailed fix + run outcome entry to
     `docs/model_spec/data-engine/implementation_maps/segment_3A.impl_actual.md`.

* 8:12am
   - Diagnosed `CHK_S3_RNG_ACCOUNTING` failure: `rng_trace_log` has 1471
     cumulative rows, but `rng_counter_after_{hi,lo}` is not monotonic, so
     max-counter selection yields totals (events_total=74) that do not match
     RNG event sums (events_total=1471).
   - Decision: select the trace aggregate row by max totals
     (events_total, blocks_total, draws_total), with counters/ts/source as
     deterministic tie-breakers; filter trace rows to run_id+seed before
     selection and log when max-counter differs.
   - Appended the detailed decision + plan to
     `docs/model_spec/data-engine/implementation_maps/segment_3A.impl_actual.md`
     before coding.

* 8:14am
   - Ran `make segment3a-s6` after trace-selection change; run failed with
     `E3A_S6_006_IMMUTABILITY_VIOLATION` because the existing
     `s6_validation_report_3A` differs from the new output.
   - Decided to delete the prior S6 outputs (report/issue/receipt) for this
     run_id so the corrected report can be regenerated.
   - Logged the decision in
     `docs/model_spec/data-engine/implementation_maps/segment_3A.impl_actual.md`.

* 8:15am
   - Deleted the prior S6 outputs (report/issue/receipt) for run_id
     `970b0bd6833be3a0f08df8e8abf0364c` to clear the immutability barrier.

* 8:15am
   - Re-ran `make segment3a-s6`; run completed successfully with
     `overall_status="PASS"` and zero failed/warn checks.
   - S6 outputs regenerated at:
     `runs/local_full_run-5/970b0bd6833be3a0f08df8e8abf0364c/data/layer1/3A/s6_validation_report/.../report.json`,
     `runs/local_full_run-5/970b0bd6833be3a0f08df8e8abf0364c/data/layer1/3A/s6_issues/.../issues.parquet`,
     `runs/local_full_run-5/970b0bd6833be3a0f08df8e8abf0364c/data/layer1/3A/s6_receipt/.../s6_receipt.json`.

* 8:20am
   - Reviewed 3A.S7 expanded spec + contracts for validation bundle and PASS
     flag, and checked Layer-1 schemas for `validation_bundle_index_3A` and
     `passed_flag_3A`.
   - Cross-checked bundle implementation style in
     `packages/engine/src/engine/layers/l1/seg_2B/s8_validation_bundle/runner.py`
     for alignment.
   - Logged S7 review notes and open questions in
     `docs/model_spec/data-engine/implementation_maps/segment_3A.impl_actual.md`.

* 8:34am
   - Logged approved S7 implementation plan (index-only bundle, run-root paths,
     recompute digests, include S3 RNG logs as members) in
     `docs/model_spec/data-engine/implementation_maps/segment_3A.impl_actual.md`.
   - Logged 2B.S8 refactor plan to index-only (no copying) and the resulting
     spec deviation in `docs/model_spec/data-engine/implementation_maps/segment_2B.impl_actual.md`.

* 8:56am
   - Implemented 3A.S7 validation bundle (index-only) with gating, digesting,
     immutability, run-report + CLI + Makefile wiring.
   - Refactored 2B.S8 to index-only (no copied artefacts) and updated bundle
     digest logic to hash source bytes from run-root paths (logged deviation).
   - Recorded the implementation details in
     `docs/model_spec/data-engine/implementation_maps/segment_3A.impl_actual.md`
     and `docs/model_spec/data-engine/implementation_maps/segment_2B.impl_actual.md`.

* 8:57am
   - Ran `make segment2b-s8` after the index-only refactor; run failed with
     immutability error `2B-S8-080` because the existing bundle contains copied
     evidence files.
   - Decided to remove the existing 2B validation bundle directory for this
     manifest and re-run S8.

* 8:57am
   - Deleted the existing 2B validation bundle directory for
     manifest_fingerprint `35c89fb31f5d034652df74c69ffbec7641b2128375ba5dd3582fb2e5a4ed2e08`
     to allow regeneration.

* 8:58am
   - Re-ran `make segment2b-s8`; S8 completed successfully and published the
     new index-only validation bundle + `_passed.flag`.

* 8:59am
   - `make segment3a-s7` failed at the sealed-inputs gate because S7 validated
     `sealed_inputs_3A` (a list) against the row object schema; the validator
     expected `type=object`.
   - Decided to align S7 with the established 3A pattern (S2/S6) by validating
     each sealed-input row against the object schema and explicitly enforcing
     list payloads.
   - Appended the decision + plan to
     `docs/model_spec/data-engine/implementation_maps/segment_3A.impl_actual.md`
     before code changes.

* 9:00am
   - Implemented the S7 sealed-inputs fix: list guard + per-row schema
     validation with row-indexed error context.
   - Logged the implementation details in
     `docs/model_spec/data-engine/implementation_maps/segment_3A.impl_actual.md`.

* 9:01am
   - Re-ran `make segment3a-s7`; run advanced into member digesting but failed
     validating `sealed_inputs_3A` as a JSON member (still using the object
     schema against the list payload).
   - Decided to special-case the `sealed_inputs_3A` member validation to
     iterate rows against the object schema while retaining list-based digest.
   - Appended the decision + plan to
     `docs/model_spec/data-engine/implementation_maps/segment_3A.impl_actual.md`.

* 9:02am
   - Implemented the `sealed_inputs_3A` member validation fix in S7 (row-wise
     validation + list guard while keeping list-based digest).
   - Logged the implementation details in
     `docs/model_spec/data-engine/implementation_maps/segment_3A.impl_actual.md`.

* 9:03am
   - Re-ran `make segment3a-s7`; run failed on `rng_event_zone_dirichlet`
     because `Path.exists()` was called on the `part-*.jsonl` glob before
     expanding log paths.
   - Decided to bypass the pre-branch `path.exists()` check for log members
     and to rely on `_resolve_event_paths` for glob expansion + missing checks.
   - Logged the decision + plan in
     `docs/model_spec/data-engine/implementation_maps/segment_3A.impl_actual.md`.

* 9:04am
   - Implemented the log-member glob fix (skip `path.exists()` for logs; handle
     missing log paths via `_resolve_event_paths` + abort context).
   - Logged the implementation details in
     `docs/model_spec/data-engine/implementation_maps/segment_3A.impl_actual.md`.

* 9:05am
   - Re-ran `make segment3a-s7`; run failed while validating the RNG event log
     because jsonschema does not accept `type: stream` schemas.
   - Planned to adapt stream log validation to use the schema `record` with
     inherited `$defs`/`$id` so each JSONL row validates correctly.
   - Logged the decision + plan in
     `docs/model_spec/data-engine/implementation_maps/segment_3A.impl_actual.md`.

* 9:06am
   - Implemented the stream-schema adapter for JSONL validation in S7.
   - Logged the implementation details in
     `docs/model_spec/data-engine/implementation_maps/segment_3A.impl_actual.md`.

* 9:07am
   - Re-ran `make segment3a-s7`; run failed on `s6_issue_table_3A` because the
     schema is an object (row schema) and `_table_pack` expects a table schema.
   - Planned to validate parquet rows against the object schema when
     `type == "object"`, keeping the table-schema path for normal tables.
   - Logged the decision + plan in
     `docs/model_spec/data-engine/implementation_maps/segment_3A.impl_actual.md`.

* 9:08am
   - Implemented object-schema validation for parquet members in S7.
   - Logged the implementation details in
     `docs/model_spec/data-engine/implementation_maps/segment_3A.impl_actual.md`.

* 9:08am
   - Re-ran `make segment3a-s7`; S7 completed successfully and published the
     index-only validation bundle + `_passed.flag`.
   - Logged the successful run outputs in
     `docs/model_spec/data-engine/implementation_maps/segment_3A.impl_actual.md`.

* 9:08am
   - Ran `make segment2b-s8`; S8 completed successfully (index-only bundle
     already existed and matched).

* 9:09am
   - Ran `make segment3a-s7` after S8; S7 completed successfully with bundle
     immutability confirmed (already exists and identical).

* 1:16pm
   - Read 3B expanded specs (S0-S5) and contracts (dictionary, registry,
     schemas) plus the Layer-1 narrative to scope 3B.S0 requirements.
   - Logged the files read and the scope notes in
     `docs/model_spec/data-engine/implementation_maps/segment_3B.impl_actual.md`.

* 1:17pm
   - Recorded S0 decisions for 3B (tz_timetable_cache optional, upstream bundle
     laws including 3A index-only digest, Pelias digest cross-check, digests
     object behavior, hrsl_raster streaming hash).
   - Appended the detailed reasoning to
     `docs/model_spec/data-engine/implementation_maps/segment_3B.impl_actual.md`.

* 1:18pm
   - Wrote the pre-implementation plan for 3B.S0 (gates, sealing strategy,
     digest policies, outputs, logging, and tests) in
     `docs/model_spec/data-engine/implementation_maps/segment_3B.impl_actual.md`.

* 1:43pm
   - Began 3B.S0 implementation by cloning 3A.S0 scaffolding into
     `packages/engine/src/engine/layers/l1/seg_3B/s0_gate/runner.py` and
     `packages/engine/src/engine/layers/l1/seg_3B/s0_gate/__init__.py`.
   - Added 3B S0 CLI entrypoint:
     `packages/engine/src/engine/cli/s0_gate_3b.py`.
   - Updated Makefile to wire Segment 3B S0 runner and CLI args, plus target:
     `makefile` (new `SEG3B_S0_RUN_ID`, `SEG3B_S0_CMD`, `segment3b-s0`).
   - Implemented 3B-specific S0 logic:
     - 1A/1B/2A gate checks keep index+bytes HashGate.
     - 3A gate uses index-only digest from 3A.S7 (`members[].sha256_hex`).
     - Policy sealing for 3B/2B policies and external refs; digest map for
       `s0_gate_receipt_3B.digests`.
     - Optional `tz_timetable_cache` parsing for `tzdb_archive_sha256` and
       `tz_index_digest`.
     - Pelias bundle digest verification (bundle JSON vs sqlite hash).
     - Streaming hash with progress logs for `hrsl_raster`.
     - Resolve `transaction_schema_merchant_ids` version from 1A sealed inputs.
   - Logged the additional decisions in
     `docs/model_spec/data-engine/implementation_maps/segment_3B.impl_actual.md`.

* 1:45pm
   - Ran `make segment3b-s0`; run failed parsing
     `docs/model_spec/data-engine/layer-1/specs/contracts/3B/artefact_registry_3B.yaml`
     due to incorrect indentation under the `pelias_cached_bundle` block.
   - Fixed the YAML indentation for the `hrsl_raster` entry so the registry
     parses correctly.

* 1:46pm
   - Re-ran `make segment3b-s0`; YAML parse failed again in the same registry
     due to a mis-indented `sealed_inputs_3B` block.
   - Re-indented the `sealed_inputs_3B` entry to align with other artifact
     list items.

* 1:48pm
   - Re-ran `make segment3b-s0`; run failed because `artefacts/rasters/hrsl_100m.tif`
     does not exist (required for `hrsl_raster` sealing).
   - Attempted `make hrsl_raster`; build failed due to a temp VRT path being
     deleted before `rasterio.open` and a default local-root pointing at a
     non-existent `artefacts/rasters/source/hrsl_general` directory.
   - Fixed `scripts/build_hrsl_raster_3b.py` to:
     - Use `artefacts/rasters/source/hrsl` as the default local root.
     - Accept `hrsl_general.vrt` as a fallback name.
     - Keep the temporary VRT directory alive until raster processing completes.

* 1:54pm
   - Re-ran `make hrsl_raster`; remote VRT streaming began but the build is
     extremely long-running (ETA hours) and timed out in the CLI session.
   - Current status: `artefacts/rasters/hrsl_100m.tif` is still missing; only a
     partial `hrsl_100m.tmp.tif` exists (auto-deleted on next run).
   - Next decision needed: provide a prebuilt `hrsl_100m.tif` via an external
     root, or allow a long-running build outside the CLI timeout.

* 2:26pm
   - Updated `make hrsl_raster` to sync HRSL tiles from S3 via AWS CLI before
     running the build, and to pass `--require-local` to avoid remote fallback.
   - Adjusted `scripts/build_hrsl_raster_3b.py` to resolve local VRTs under
     `artefacts/rasters/source/hrsl/hrsl_general` (or the root), and to fail
     closed when local tiles are missing.
   - Logged the detailed decision trail in
     `docs/model_spec/data-engine/implementation_maps/segment_3B.impl_actual.md`.

* 4:27pm
   - Fixed HRSL local VRT selection to avoid path mismatches (root VRT pointed
     at a non-existent `v1/` path after AWS sync).
   - Updated `makefile` to default `HRSL_LOCAL_ROOT` to
     `artefacts/rasters/source/hrsl/hrsl_general` and to sync directly into it.
   - Updated `scripts/build_hrsl_raster_3b.py` to require `v1/` tiles adjacent
     to the VRT before accepting it.
   - Logged the detailed decision trail in
     `docs/model_spec/data-engine/implementation_maps/segment_3B.impl_actual.md`.

* 6:37pm
   - Verified `artefacts/rasters/hrsl_100m.tif` exists and its byte size matches
     `hrsl_100m.provenance.json` (1540757963 bytes), indicating the HRSL build
     completed successfully.

* 6:40pm
   - Noted `make segment3b-s0` failure due to `pelias_cached_bundle` digest
     mismatch versus `pelias_cached.sqlite`.
   - Decided to rebuild the pelias cached bundle via `make pelias_cached` to
     regenerate sqlite + bundle/provenance in a consistent set.
   - Logged the decision path in
     `docs/model_spec/data-engine/implementation_maps/segment_3B.impl_actual.md`.

* 6:41pm
   - `make segment3b-s0` then failed on receipt schema validation because
     `sealed_policy_set` included a `notes` field not allowed by schema.
   - Planned to remove `notes` from the receipt payload and re-run S0.
   - Logged the decision path in
     `docs/model_spec/data-engine/implementation_maps/segment_3B.impl_actual.md`.

* 6:42pm
   - Ran `make pelias_cached`; bundle/provenance now match sqlite digest
     `c81dd6418a1e4d0f464c13955d4bd36bd5fe5467147c9c6c460384dbb3d54e5c`.
   - Removed `notes` from `sealed_policy_set` items in 3B.S0 receipt.
   - Re-ran `make segment3b-s0`; S0 completed successfully.
   - Logged the outcome in
     `docs/model_spec/data-engine/implementation_maps/segment_3B.impl_actual.md`.

* 7:47pm
   - Read 3B.S1 expanded spec and S1-relevant contracts/guides:
     `docs/model_spec/data-engine/layer-1/specs/state-flow/3B/state.3B.s1.expanded.md`,
     `docs/model_spec/data-engine/layer-1/specs/contracts/3B/dataset_dictionary.layer1.3B.yaml`,
     `docs/model_spec/data-engine/layer-1/specs/contracts/3B/schemas.3B.yaml`,
     `docs/model_spec/data-engine/layer-1/specs/data-intake/3B/virtual_settlement_coords_derivation-guide.md`,
     `docs/model_spec/data-engine/layer-1/specs/data-intake/3B/mcc_channel_rules_authoring-guide.md`.
   - Reviewed current `artefacts/virtual/virtual_settlement_coords.csv` and
     its provenance sidecar to understand fields available for S1.

* 7:59pm
   - Confirmed S1 implementation decisions with user
     (decision_reason mapping, virtual_mode mapping, tz_source enum, tz_policy_digest source).
   - Logged the detailed plan and decision confirmations in
     `docs/model_spec/data-engine/implementation_maps/segment_3B.impl_actual.md`.

* 8:22pm
   - Implemented 3B.S1 runner + CLI and wired Makefile target `segment3b-s1`.
   - Added paired output publish logic to prevent partial S1 outputs.
   - Implemented `coord_source_version` from the virtual_settlement_coords provenance sidecar.
   - Logged the detailed implementation notes in
     `docs/model_spec/data-engine/implementation_maps/segment_3B.impl_actual.md`.

* 8:23pm
   - First `make segment3b-s1` failed because the S0 receipt schema does not
     include `segment_id/state_id` and due to `EngineFailure` using
     `failure_code` not `error_code`.
   - Removed the receipt identity check and fixed the error_code assignment.
   - Logged the decisions in
     `docs/model_spec/data-engine/implementation_maps/segment_3B.impl_actual.md`.

* 8:26pm
   - `make segment3b-s1` failed on merchant_id cast (u64 -> i64 conversion error).
   - Planned to switch S1 merchant_id handling to `pl.UInt64` and align coords join keys.
   - Logged the detailed plan in `docs/model_spec/data-engine/implementation_maps/segment_3B.impl_actual.md`.

* 8:27pm
   - Updated 3B.S1 to cast merchant_id as `pl.UInt64` and aligned coords merchant_id to `pl.UInt64` before joins.
   - Prepared to re-run `make segment3b-s1`.

* 8:30pm
   - `make segment3b-s1` failed due to `_StepTimer.info()` being called with format args.
   - Planned to format those log messages before passing to `_StepTimer.info`.
   - Logged the decision in `docs/model_spec/data-engine/implementation_maps/segment_3B.impl_actual.md`.

* 8:31pm
   - Updated S1 StepTimer usage to pass formatted strings rather than format args.
   - Ready to re-run `make segment3b-s1`.

* 8:32pm
   - `make segment3b-s1` failed in classification with error detail "DEFAULT_GUARD".
   - Planned to wrap decision/virtual_mode string constants with `pl.lit` to avoid Polars column-name interpretation.
   - Logged the decision in `docs/model_spec/data-engine/implementation_maps/segment_3B.impl_actual.md`.

* 8:33pm
   - Updated S1 classification expressions to wrap decision/virtual_mode constants with `pl.lit`.
   - Ready to re-run `make segment3b-s1`.

* 8:34pm
   - `make segment3b-s1` failed parsing `virtual_settlement_coords.csv` as i64 for merchant_id.
   - Planned to pass `schema_overrides={"merchant_id": pl.UInt64}` to `pl.read_csv`.
   - Logged the decision in `docs/model_spec/data-engine/implementation_maps/segment_3B.impl_actual.md`.

* 8:35pm
   - Updated S1 coords CSV read to override merchant_id dtype to `pl.UInt64`.
   - Ready to re-run `make segment3b-s1`.

* 8:35pm
   - `make segment3b-s1` failed with unresolved ref `schemas.layer1.yaml#/$defs/id64` during coords validation.
   - Planned to inline layer1 defs for coords/output table packs before `validate_dataframe`.
   - Logged the decision in `docs/model_spec/data-engine/implementation_maps/segment_3B.impl_actual.md`.

* 8:36pm
   - Inlined `schemas.layer1.yaml` defs into 3B.S1 coords/output table schemas before validation.
   - Ready to re-run `make segment3b-s1`.

* 8:37pm
   - Validation still failed because `$defs.id64` in the pack kept an external ref.
   - Planned to inline external refs on the entire table pack (including `$defs`).
   - Logged the decision in `docs/model_spec/data-engine/implementation_maps/segment_3B.impl_actual.md`.

* 8:38pm
   - Updated S1 to inline external layer1 refs on the full coords/output schema packs.
   - Ready to re-run `make segment3b-s1`.

* 8:38pm
   - `make segment3b-s1` failed in settlement_join with detail `virtual_settlement_coords`.
   - Planned to wrap the coord_source default string with `pl.lit` to avoid column-name lookup.
   - Logged the decision in `docs/model_spec/data-engine/implementation_maps/segment_3B.impl_actual.md`.

* 8:39pm
   - Updated `coord_source_id` default in S1 settlement to use `pl.lit("virtual_settlement_coords")`.
   - Ready to re-run `make segment3b-s1`.

* 8:38pm
   - `make segment3b-s1` completed successfully (S1 outputs + run report published).
