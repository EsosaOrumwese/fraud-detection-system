# Logbook
### Date: 18th January 2026
### Project: Fraud Detection System
### Reference commits: Check commits on this date (if any)

* 12:20am
   - Read required context for Segment 3A (current focus: 3A.S2), including:
     - Conceptual design: `docs/references/closed-world-fraud-enterprise-conceptual-design.md`
       (router referenced `closed-world-enterprise-conceptual-design*.md`, which is not present).
     - Layer narratives: `docs/model_spec/data-engine/layer-1/narrative/narrative_1A-to-3B.md`,
       `docs/model_spec/data-engine/layer-2/narrative/narrative_5A-and-5B.md`,
       `docs/model_spec/data-engine/layer-3/narrative/narrative_6A-and-6B.md`.
     - Segment 3A expanded specs: `docs/model_spec/data-engine/layer-1/specs/state-flow/3A/state.3A.s0.expanded.md`,
       `docs/model_spec/data-engine/layer-1/specs/state-flow/3A/state.3A.s1.expanded.md`,
       `docs/model_spec/data-engine/layer-1/specs/state-flow/3A/state.3A.s2.expanded.md`,
       `docs/model_spec/data-engine/layer-1/specs/state-flow/3A/state.3A.s3.expanded.md`,
       `docs/model_spec/data-engine/layer-1/specs/state-flow/3A/state.3A.s4.expanded.md`,
       `docs/model_spec/data-engine/layer-1/specs/state-flow/3A/state.3A.s5.expanded.md`,
       `docs/model_spec/data-engine/layer-1/specs/state-flow/3A/state.3A.s6.expanded.md`,
       `docs/model_spec/data-engine/layer-1/specs/state-flow/3A/state.3A.s7.expanded.md`.
     - Segment 3A contracts: `docs/model_spec/data-engine/layer-1/specs/contracts/3A/schemas.3A.yaml`,
       `docs/model_spec/data-engine/layer-1/specs/contracts/3A/dataset_dictionary.layer1.3A.yaml`,
       `docs/model_spec/data-engine/layer-1/specs/contracts/3A/artefact_registry_3A.yaml`,
       and ingress schema `docs/model_spec/data-engine/layer-1/specs/contracts/1A/schemas.ingress.layer1.yaml`.
     - Segment 3A data-intake guides (dependency order):
       `docs/model_spec/data-engine/layer-1/specs/data-intake/3A/zone_mixture_policy_3A.md`,
       `docs/model_spec/data-engine/layer-1/specs/data-intake/3A/zone_floor_policy_3A.md`,
       `docs/model_spec/data-engine/layer-1/specs/data-intake/3A/country_zone_alphas_3A.md`.
     - Governed policy/prior payloads:
       `config/layer1/3A/allocation/zone_floor_policy.yaml`,
       `config/layer1/3A/allocation/country_zone_alphas.yaml`.
     - Current 3A implementation for alignment: `packages/engine/src/engine/layers/l1/seg_3A/s0_gate/runner.py`
       and `packages/engine/src/engine/layers/l1/seg_3A/s1_escalation/runner.py`.
     - Reviewed available run folders under `runs/` to confirm current test harness context.
   - No implementation-map entry added yet (context-only read). Will add a 3A.S2 plan entry before coding.

* 12:26am
   - Reviewed implementation-map history to align with prior engineer decisions:
     `docs/model_spec/data-engine/implementation_maps/segment_1A.impl_actual.md`,
     `docs/model_spec/data-engine/implementation_maps/segment_1B.impl_actual.md`,
     `docs/model_spec/data-engine/implementation_maps/segment_2A.impl_actual.md`,
     `docs/model_spec/data-engine/implementation_maps/segment_2B.impl_actual.md`,
     `docs/model_spec/data-engine/implementation_maps/segment_3A.impl_actual.md`.
   - Read engine orchestration tooling and contract routing:
     `makefile`, `packages/engine/AGENTS.md`, `packages/engine/README.md`,
     `packages/engine/src/engine/core/config.py`,
     `packages/engine/src/engine/core/paths.py`,
     `packages/engine/src/engine/core/logging.py`,
     `packages/engine/src/engine/core/errors.py`,
     `packages/engine/src/engine/core/hashing.py`,
     `packages/engine/src/engine/core/time.py`,
     `packages/engine/src/engine/contracts/source.py`,
     `packages/engine/src/engine/contracts/loader.py`,
     `packages/engine/src/engine/contracts/jsonschema_adapter.py`,
     `packages/engine/src/engine/cli/s0_gate_3a.py`,
     `packages/engine/src/engine/cli/s1_escalation_3a.py`.
   - Reviewed contract mirror guidance and layout: `contracts/AGENTS.md`, `contracts/README.md`.
   - Skimmed existing heavy-state runners for logging/progress conventions and tz handling:
     `packages/engine/src/engine/layers/l1/seg_2A/s2_overrides/runner.py`,
     `packages/engine/src/engine/layers/l1/seg_2A/s3_timetable/runner.py`.

* 12:53am
   - Re-read 3A.S2 expanded spec for implementation planning:
     `docs/model_spec/data-engine/layer-1/specs/state-flow/3A/state.3A.s2.expanded.md`.
   - Re-checked 3A contracts relevant to S2:
     `docs/model_spec/data-engine/layer-1/specs/contracts/3A/dataset_dictionary.layer1.3A.yaml`,
     `docs/model_spec/data-engine/layer-1/specs/contracts/3A/artefact_registry_3A.yaml`,
     `docs/model_spec/data-engine/layer-1/specs/contracts/3A/schemas.3A.yaml`.

* 12:55am
   - Reviewed policy authoring semantics for S2:
     `docs/model_spec/data-engine/layer-1/specs/data-intake/3A/zone_floor_policy_3A.md`,
     `docs/model_spec/data-engine/layer-1/specs/data-intake/3A/country_zone_alphas_3A.md`.
   - Re-opened governed prior/policy payloads for grounding:
     `config/layer1/3A/allocation/country_zone_alphas.yaml`,
     `config/layer1/3A/allocation/zone_floor_policy.yaml`.
   - Re-checked existing zone-universe derivation logic in S1 for alignment:
     `packages/engine/src/engine/layers/l1/seg_3A/s1_escalation/runner.py`.

* 1:12am
   - Appended detailed S2 decision + plan entry to the implementation map,
     capturing strict prior/universe alignment, lineage IDs, Z(c) derivation,
     tolerance, optional tz cache checks, and run-report posture:
     `docs/model_spec/data-engine/implementation_maps/segment_3A.impl_actual.md`.

* 1:21am
   - Added an S2 implementation-start entry to the implementation map, covering
     sealed_inputs format fallback, immutability comparison, output layout, and
     error-code mapping decisions:
     `docs/model_spec/data-engine/implementation_maps/segment_3A.impl_actual.md`.

* 1:26am
   - Reviewed the latest run log for logging cadence and narrative style:
     `runs/local_full_run-5/970b0bd6833be3a0f08df8e8abf0364c/run_log_970b0bd6833be3a0f08df8e8abf0364c.log`.
   - Re-opened S2 contracts + schema anchors for output columns and policy inputs:
     `docs/model_spec/data-engine/layer-1/specs/contracts/3A/dataset_dictionary.layer1.3A.yaml`,
     `docs/model_spec/data-engine/layer-1/specs/contracts/3A/schemas.3A.yaml`.
   - Re-checked S2 error-code definitions for mapping in the runner:
     `docs/model_spec/data-engine/layer-1/specs/state-flow/3A/state.3A.s2.expanded.md`.
   - Scoped Makefile wiring for new 3A.S2 CLI target.

* 1:45am
   - Implemented Segment 3A S2 runner + CLI + module export and wired Makefile:
     `packages/engine/src/engine/layers/l1/seg_3A/s2_priors/runner.py`,
     `packages/engine/src/engine/layers/l1/seg_3A/s2_priors/__init__.py`,
     `packages/engine/src/engine/cli/s2_priors_3a.py`,
     `makefile`.
   - Runner includes sealed input verification, Z(c) derivation, floor/bump
     application, output schema validation, immutability checks, and run-report
     emission per S2 spec with narrative logging.

* 1:47am
   - Fixed zone-count bucket aggregation to count every country (Counter update
     now uses the full list of counts instead of a set):
     `packages/engine/src/engine/layers/l1/seg_3A/s2_priors/runner.py`.

* 1:48am
   - Ran `make segment2b-s2` to validate the current run context; target
     completed successfully with existing outputs marked identical.

* 2:09am
   - Reviewed 3A.S3 expanded spec and contracts to prepare the S3 implementation
     plan and RNG design:
     - `docs/model_spec/data-engine/layer-1/specs/state-flow/3A/state.3A.s3.expanded.md`
     - `docs/model_spec/data-engine/layer-1/specs/contracts/3A/schemas.3A.yaml`
     - `docs/model_spec/data-engine/layer-1/specs/contracts/3A/dataset_dictionary.layer1.3A.yaml`
     - `docs/model_spec/data-engine/layer-1/specs/contracts/3A/artefact_registry_3A.yaml`
     - `docs/model_spec/data-engine/layer-1/specs/contracts/1A/schemas.layer1.yaml`
     - `docs/model_spec/data-engine/rdv_rails_constitution_v1.md` (RNG law)
   - Reviewed existing RNG implementations for reuse in S3 (Philox + Gamma +
     trace log patterns):
     - `packages/engine/src/engine/layers/l1/seg_1A/s1_hurdle/rng.py`
     - `packages/engine/src/engine/layers/l1/seg_1A/s2_nb_outlets/runner.py`
     - `packages/engine/src/engine/layers/l1/seg_1A/s7_integerisation/runner.py`
     - `packages/engine/src/engine/layers/l1/seg_2B/s5_router/runner.py`

* 2:26am
   - Confirmed S3 RNG decisions to implement:
     - `rng_stream_id` will be a SHA-256 hex digest of
       `3A.S3|zone_dirichlet|{merchant_id}|{country_iso}`.
     - Stream derivation will use `{manifest_fingerprint_bytes, seed}` as
       master material (no `run_id` in the key), consistent with 1A RNG
       patterns; `run_id` remains partition identity.
     - `rng_event_id` will remain null in `s3_zone_shares`.
     - Existing RNG logs: validate-and-skip if events+trace exist; fail closed
       on partial logs.
   - Began S3 implementation (runner + RNG helper + CLI + Makefile wiring).

* 2:46am
   - Implemented Segment 3A S3 (Dirichlet zone shares), including:
     - RNG helper (`mlr:3A.master`/`mlr:3A.zone_dirichlet` stream derivation).
     - S3 runner with S0/S1/S2 validation, deterministic sampling, RNG events,
       trace logging, immutability checks, and run-report emission.
     - CLI entrypoint + Makefile target wiring.
   - Files added/updated:
     - `packages/engine/src/engine/layers/l1/seg_3A/s3_zone_shares/rng.py`
     - `packages/engine/src/engine/layers/l1/seg_3A/s3_zone_shares/runner.py`
     - `packages/engine/src/engine/layers/l1/seg_3A/s3_zone_shares/__init__.py`
     - `packages/engine/src/engine/cli/s3_zone_shares_3a.py`
     - `makefile`

* 2:49am
   - Observed `make segment3a-s3` failure: run-report flagged
     `E3A_S3_012_INFRASTRUCTURE_IO_ERROR` with `'DataFrame' object has no
     attribute 'groupby'` during the S2 prior validation phase.
   - Appended a fix plan entry to
     `docs/model_spec/data-engine/implementation_maps/segment_3A.impl_actual.md`
     to replace pandas-style `groupby` with Polars `group_by`, then re-run
     `make segment3a-s3` to confirm green.

* 2:53am
   - Re-ran `make segment3a-s3`; S3 failed with
     `E3A_S3_003_PRIOR_SURFACE_INCOMPLETE` (`missing_countries_count=63`,
     `sample_country_iso=AD`).
   - Investigated S1/S2 outputs and found escalated countries are present in
     S2; identified a tuple-key mismatch from `partition_by(..., as_dict=True)`.
   - Logged a fix plan to unwrap `country_iso` tuple keys in
     `docs/model_spec/data-engine/implementation_maps/segment_3A.impl_actual.md`
     before re-running `make segment3a-s3`.

* 2:54am
   - Applied the tuple-key normalization fix in
     `packages/engine/src/engine/layers/l1/seg_3A/s3_zone_shares/runner.py`.
   - Re-ran `make segment3a-s3`; S3 completed successfully and published
     `s3_zone_shares` plus RNG logs for the run.
   - Recorded the outcome in
     `docs/model_spec/data-engine/implementation_maps/segment_3A.impl_actual.md`.

* 2:57am
   - Verified S3 run-report status is PASS for run_id
     `970b0bd6833be3a0f08df8e8abf0364c`.
   - Validated output integrity on `s3_zone_shares`: row count matches
     expected escalated-pairs Ã— country zone counts (14800), no duplicate
     `(merchant_id, legal_country_iso, tzid)` keys, and per-pair
     `share_drawn` sums are ~1.0 (min/max within floating tolerance).
   - Adjusted the verification query to use `share_drawn` (output column) after
     initially checking for a non-existent `share` column.
