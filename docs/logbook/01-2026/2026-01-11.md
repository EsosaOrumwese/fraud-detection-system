# Logbook
### Date: 11th January 2026
### Project: Fraud Detection System
### Reference commits: Check commits on this date (if any)

* 12:10am
   - Confirmed dev-mode contract source is docs/model_spec and committed to keep a switchable contract source for production.
   - Verified packages/engine is effectively empty and began bootstrapping the engine package from scratch.
   - Added core engine scaffolding (errors, logging, hashing, config, run-path resolution) to support run isolation and contract loading.
   - Added contract source + loader utilities for dictionary/registry/schema resolution.
   - Began Segment 1A S0 foundations: context structs, input resolution, hashing logic, RNG helpers, and S0 output writers.
   - Noted missing config file `config/layer1/1A/rng/run_seed.yaml` during S0 input checks (to be addressed in S0 implementation).

* 12:30am
   - Added contract-switching CLI/env support and implemented the first pass of Segment 1A S0 foundations (runner, path resolution, hashing, RNG anchor/audit/trace).
   - Created `config/layer1/1A/rng/run_seed.yaml` and wired seed loading with CLI override.
   - Implemented input resolution for S0 references, parameter file selection from registry templates, and manual schema checks for merchant_ids.
   - Added contract-derived output path resolution and run_id collision handling under runs/<run_id>.
   - Logged decisions in `segment_1A.impl_actual.md` per the implementation doctrine.
   - Chose manifest-fingerprint naming based on file basenames and documented the run-local staging limitation for S0.

* 12:40am
   - Added a JSON Schema adapter for schema-pack tables and wired S0 merchant_ids validation to use schemas.ingress.layer1.yaml.
   - Added Makefile targets `segment1a-s0` and `engine-s0` plus contract-switching args for the new CLI entrypoint.
   - Updated the Segment 1A implementation log with the new validation + Makefile decisions.
   - Started an S0 spec crosscheck, added an authority audit for non-JSON schema refs, and recorded remaining gaps for follow-up (run_id collision scope).

* 12:52am
   - Aligned S0 run_id collision checks with RNG log directories (audit/trace/anchor) while keeping a run-root guard.
   - Updated pre-run input resolution to skip run-local staging until run_id exists (external roots only).
   - Logged the S0 collision/staging decisions in the Segment 1A implementation map.

* 1:01am
   - Added a mandatory "Implementation map discipline" section to `AGENTS.md` to enforce detailed, append-only plans and logbook linking.

* 1:07am
   - Added a run-scoped file handler so S0 writes `runs/<run_id>/run_log_<run_id>.log` alongside STDOUT logging.
   - Fixed indentation in `schemas.layer1.yaml` to restore valid YAML parsing for 5B RNG event schemas.
   - Captured the run-log design decision in the Segment 1A implementation map.

* 1:12am
   - Fixed JSON Schema adapter to validate row objects (not arrays) for ingress tables, resolving S0 merchant_ids validation failure.
   - Logged the ingress validation change in the Segment 1A implementation map.

* 1:16am
   - Added a configurable runs root (ENGINE_RUNS_ROOT/--runs-root) so S0 run folders can be placed under Makefile RUN_ROOT.
   - Updated RunPaths and EngineConfig accordingly, and wired RUN_ROOT into SEG1A_S0 in the Makefile.

* 1:21am
   - Ran `make segment1a-s0` to reproduce the missing run folder; S0 aborted before run_id creation with `Invalid home_country_iso values: ['NA']`.

* 1:31am
   - Reviewed `iso3166_canonical_2024_acquisition-guide.md` and identified GeoNames `countryInfo.txt` as the required source.
   - Updated `scripts/build_iso_canonical.py` to parse GeoNames, write the contracted iso3166.parquet path, and emit provenance/manifest.
   - Added the ISO canonical intake plan to the Segment 1A implementation map.

* 1:32am
   - Fixed `build_iso_canonical.py` to strip comment lines manually after Polars lacked `comment_char`.
   - Rebuilt `reference/iso/iso3166_canonical/2024-12-31/iso3166.parquet`; verified `NA` (Namibia) is present.

* 1:37am
   - Updated S0 registry path resolution to handle directory templates and select the artifact file deterministically.
   - Ran `make segment1a-s0`; S0 completed successfully and created run_id `a2fe943bae1f493dcb06985f90867337` under `runs/local_full_run-5/`.

* 1:40am
   - Replaced Polars map_elements channel mapping with replace_strict to remove the performance warning.

* 1:45am
   - Added run_receipt.json creation to S0 for resume ergonomics.
   - Updated Makefile defaults to derive RUN_ROOT from RUNS_ROOT + RUN_ID and pass RUNS_ROOT to S0.

* 1:47am
   - Added `make latest-run-id` helper to auto-pick the newest run_receipt.json under RUNS_ROOT.

* 1:54am
   - Switched logging format to the legacy timestamp/level/logger style and added S0 elapsed/delta timing logs.

* 2:07am
   - Re-read the 1A.S1 expanded spec and identified the required inputs, RNG substream rules, and output paths.
   - Added a detailed S1 implementation plan to `segment_1A.impl_actual.md`, covering run preconditions, coefficient alignment, Philox substreams, and hurdle event/trace emission.

* 2:17am
   - Implemented S1 hurdle RNG primitives (UER encoding, keyed substream derivation, Philox2x64-10, u01 mapping).
   - Added the S1 hurdle runner to load the run receipt, gate receipt, design matrix, and coefficients, then emit hurdle events and trace rows.
   - Added the S1 CLI entrypoint with run-id selection and contract/runs-root overrides.

* 2:18am
   - Added Makefile wiring for `segment1a-s1`/`engine-s1`, including contract switch flags, runs-root, and optional run-id.

* 2:19am
   - Added a run_receipt seed range guard to enforce uint64 bounds before S1 starts.

* 2:33am
   - Audited S0.4-S0.10 requirements and appended a detailed implementation plan covering GDP buckets, design matrices, crossborder eligibility, numeric policy attestation, failure records, and validation bundle outputs.

* 2:46am
   - Re-read root `AGENTS.md`, `packages/engine/AGENTS.md`, and `docs/model_spec/data-engine/layer-1/specs/AGENTS.md` before touching S0 implementation.
   - Re-read the conceptual and layer narratives to refresh layer intent: `docs/references/closed-world-fraud-enterprise-conceptual-design.md`, `docs/model_spec/data-engine/layer-1/narrative/narrative_1A-to-3B.md`, `docs/model_spec/data-engine/layer-2/narrative/narrative_5A-and-5B.md`, `docs/model_spec/data-engine/layer-3/narrative/narrative_6A-and-6B.md`.
   - Read the full expanded spec for 1A S0 (`docs/model_spec/data-engine/layer-1/specs/state-flow/1A/state.1A.s0.expanded.md`) and extracted S0.4-S0.10 requirements for implementation.
   - Reviewed contract sources for S0 outputs/inputs: `docs/model_spec/data-engine/layer-1/specs/contracts/1A/dataset_dictionary.layer1.1A.yaml`, `docs/model_spec/data-engine/layer-1/specs/contracts/1A/schemas.1A.yaml`, and `docs/model_spec/data-engine/layer-1/specs/contracts/1A/artefact_registry_1A.yaml`.
   - Loaded numeric policy artefacts to align S0.8 tests and manifest enumeration (`reference/governance/numeric_policy/2025-12-31/numeric_policy.json`, `reference/governance/math_profile/2025-10-08/math_profile_manifest.json`).

* 3:16am
   - Implemented spec-compliant hashing for `parameter_hash`/`manifest_fingerprint` and removed the prior double-hash behavior.
   - Added numeric policy self-tests + attestation (`numeric_policy.py`) and wired `numeric_policy_attest.json` into the manifest enumeration with deterministic JSON bytes.
   - Added GDP attachment + validation (S0.4) with `observation_year=2024`, bucket-range checks, and ISO coverage validation.
   - Implemented S0.5 hurdle design matrix output, S0.6 crossborder eligibility rules, and optional S0.7 hurdle_pi_probs diagnostics with atomic parquet writes.
   - Added S0.9 failure record writer and S0.10 validation bundle emitter (MANIFEST, index, _passed.flag, run_environ.json) plus segment_state_runs telemetry.
   - Updated S0 CLI to allow toggling `hurdle_pi_probs` emission via `--emit-hurdle-pi-probs`/`--no-emit-hurdle-pi-probs`.
   - Noted two deviations in the implementation map: numeric attestation computed before `manifest_fingerprint` to include its digest; libm regression test uses version/function checks in lieu of absent reference vectors.
   - Ran `python -m py_compile` over updated S0 modules to sanity-check syntax (passed).
