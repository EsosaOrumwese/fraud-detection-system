# Logbook
### Date: 3rd January 2026
### Project: Fraud Detection System
### Reference commits: Check commits on this date (if any)

* 12:05am
   - Reviewed scenario_runner spec folder (README, scenario_runner.md) and contracts (run_facts_view, scenario_run_request, scenario_definition, run_status_event) for alignment with rails and engine interface pack.
   - Noted potential spec issues: contracts duplicate rails ID/timestamp/digest types instead of referencing rails contracts, README references a missing contracts/README.md, and several non-ASCII characters appear in README/scenario_runner.md section headings.

* 12:07am
   - Aligned `s7_audit_report_v1` schema in `contracts/schemas/layer1/schemas.2B.yaml` with the authoritative 2B spec (checks/summary/fingerprint fields) to fix S8 validation rejecting the current S7 report shape.

* 12:45am
   - Added auto-select of the newest S5/S6 run_report (by created_utc, then mtime) when multiple run_ids exist, logging the chosen run_id instead of failing with resume ambiguity (`packages/engine/src/engine/layers/l1/seg_2B/s5_router/l2/runner.py`, `packages/engine/src/engine/layers/l1/seg_2B/s6_virtual_edge/l2/runner.py`).

* 12:07am
   - Fixed 2A S0 merchant_mcc_map sourcing to prefer date-stamped parquet snapshots (e.g., 2025-12-31) over lexicographic "v" folders/CSV, so merchant_id space aligns with 1A/1B outputs.
   - Enforced Int64/Int32 typing when materialising merchant_mcc_map to match schema and avoid string IDs that caused zero virtual arrivals in 2B S6.
* 12:12am
   - Normalized non-ASCII characters in scenario_runner README and scenario_runner.md (quotes, dashes, arrows, section references) to ASCII-safe equivalents.
   - Added missing contracts/README.md listing scenario runner contract schemas.
* 12:22am
   - Reviewed scratch.md proposed Rails-referencing diffs for Scenario Runner contracts; identified adjustments needed for $ref path resolution and remaining seed type mismatch with Rails.
* 12:27am
   - Applied scratch.md Rails-reference fixes to Scenario Runner contracts with corrected relative $ref paths, bumped contract versions to 0.1.1, and aligned engine digest objects for run facts pins.
* 12:28am
   - Normalized non-ASCII punctuation in scenario_runner contract YAMLs to ASCII (quotes, dashes, arrows).
* 12:42am
   - Added a clarification in scenario_runner.md allowing stricter lexical constraints (e.g., numeric seed) to satisfy engine interface requirements while still referencing Rails types.
* 12:44am
   - Updated Rails id_types.schema.yaml to define uint64 and bind seed to uint64 (no longer opaque string) to align with engine interface expectations.
* 12:48am
   - Updated Scenario Runner contracts to reference Rails seed type (uint64) via $ref + local uint64 in scenario_run_request and run_facts_view.
   - Adjusted Scenario Runner spec note to remove numeric-seed example now that Rails seed is uint64.

* 12:58am
   - Added stage-level progress logging to 2B.S7 audit (load inputs, policy assets, alias/day/router validation timings, report write timing, total elapsed) so long S7 runs show live progress in the console (`packages/engine/src/engine/layers/l1/seg_2B/s7_audit/l2/runner.py`).

* 1:30am
   - Raised S2 CUSUM threshold in `config/policy/validation_policy.yaml` to `threshold_h=250.0` (semver 1.3.2, version 2026-01-03) to allow debugging the observed cusum_max (~201.85) without failing early.

* 1:46am
   - Added `cusum.alpha_cap=0.999` to the validation policy (semver 1.3.3) after tracing the 201.85 spike to a single merchant with alpha≈0.999976 and one rejection (z≈202). The cap is applied only inside the CUSUM corridor calculation to stop extreme alpha->1 cases from dominating while preserving the underlying sampler outputs.
   - Logged `cusum_alpha_cap` and `cusum_alpha_capped_count` in S2 metrics to surface when the cap is active.

* 1:50am
   - Reduced `cusum.threshold_h` back to 90.0 (semver 1.3.4) now that alpha_cap=0.999 is in place, restoring the tighter corridor while keeping the spike from single near-1 alpha cases in check.
* 2:47am
   - Documented implementer gap analysis for Scenario Runner reproducibility and interoperability in scratch_files/scratch.md.

* 3:04am
   - Fixed Segment 2A S0 to keep the upstream manifest fingerprint instead of recomputing a new one, so 2A/3A stay aligned with 1A/1B bundles and we avoid clean-run manifest drift (updated `packages/engine/src/engine/layers/l1/seg_2A/s0_gate/l2/runner.py`).

* 3:38am
   - Fixed Segment 2A S5 bundle hashing to use the shared index digest (hash-of-hashes from `index.json`) so `_passed.flag` matches 3A's verification; removed the raw-bytes digest that caused `E_FLAG_HASH_MISMATCH` on clean runs (`packages/engine/src/engine/layers/l1/seg_2A/s5_validation/l2/runner.py`).
