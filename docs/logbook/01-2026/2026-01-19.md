# Logbook
### Date: 19th January 2026
### Project: Fraud Detection System
### Reference commits: Check commits on this date (if any)

* 05:56am
   - Began 3B.S3 review and planning; read:
     - `docs/model_spec/data-engine/layer-1/specs/state-flow/3B/state.3B.s3.expanded.md`.
     - `docs/model_spec/data-engine/layer-1/specs/contracts/3B/dataset_dictionary.layer1.3B.yaml`.
     - `docs/model_spec/data-engine/layer-1/specs/contracts/3B/artefact_registry_3B.yaml`.
     - `docs/model_spec/data-engine/layer-1/specs/contracts/3B/schemas.3B.yaml`.
     - `docs/model_spec/data-engine/layer-1/specs/contracts/2B/schemas.2B.yaml`.
     - `config/layer1/2B/policy/alias_layout_policy_v1.json`.

* 06:06am
   - Continued 3B.S3 review and planning; also read:
     - `config/layer1/3B/virtual/cdn_country_weights.yaml`.
     - `config/layer1/3B/virtual/cdn_key_digest.yaml`.
   - Appended the 3B.S3 planning entry in
     `docs/model_spec/data-engine/implementation_maps/segment_3B.impl_actual.md`
     (Entry: 2026-01-19 06:00) with open questions and stepwise plan.

* 06:17am
   - Documented approved S3 decisions in
     `docs/model_spec/data-engine/implementation_maps/segment_3B.impl_actual.md`
     (Entry: 2026-01-19 06:10) before implementation.

* 06:18am
   - Updated `docs/model_spec/data-engine/layer-1/specs/contracts/3B/artefact_registry_3B.yaml`
     to point `edge_alias_blob_3B` at `schemas.3B.yaml#/binary/edge_alias_blob_header_3B`.

* 06:27am
   - Appended a pre-implementation decision update in
     `docs/model_spec/data-engine/implementation_maps/segment_3B.impl_actual.md`
     (Entry: 2026-01-19 06:27) to hash `edge_catalogue_index_3B` and
     `edge_alias_index_3B` from parquet bytes (not canonical row JSON).

* 06:45am
   - Implemented 3B.S3 runner and package in
     `packages/engine/src/engine/layers/l1/seg_3B/s3_alias_tables/`.
   - Added CLI entrypoint `packages/engine/src/engine/cli/s3_alias_tables_3b.py`.
   - Updated makefile with `SEG3B_S3_CMD`, `segment3b-s3`, and aggregate target.
   - Verified syntax via `python -m py_compile` for new S3 modules.

* 06:47am
   - Fixed S3 timer formatting, alias blob padding alignment, and alias index
     merchant_id overflow (UInt64) in
     `packages/engine/src/engine/layers/l1/seg_3B/s3_alias_tables/runner.py`.
   - Appended the implementation-map entry documenting these fixes
     (Entry: 2026-01-19 06:47).
   - Re-ran `make segment3b-s3` and achieved a clean PASS for the current run.

* 07:01am
  - Began 3B.S4 spec review and planning; read:
    - `docs/model_spec/data-engine/layer-1/specs/state-flow/3B/state.3B.s4.expanded.md`.
    - `docs/design/data-engine/layer-1/3B/3B-S4-dag.md`.
    - `docs/design/data-engine/layer-1/3B/3B-overview-dag.md`.
    - `docs/model_spec/data-engine/layer-1/specs/contracts/3B/schemas.3B.yaml`.
    - `docs/model_spec/data-engine/layer-1/specs/contracts/3B/dataset_dictionary.layer1.3B.yaml`.
    - `docs/model_spec/data-engine/layer-1/specs/contracts/3B/artefact_registry_3B.yaml`.
    - `config/layer1/3B/virtual/virtual_validation.yml`.
    - `config/layer1/3B/virtual/cdn_key_digest.yaml`.
    - `config/layer1/2B/policy/alias_layout_policy_v1.json`.
    - `config/layer1/2B/policy/route_rng_policy_v1.json`.
    - `docs/model_spec/data-engine/layer-1/specs/contracts/2B/schemas.2B.yaml`.
  - Appended S4 planning entry to
    `docs/model_spec/data-engine/implementation_maps/segment_3B.impl_actual.md`
    (Entry: 2026-01-19 07:01).

* 07:58am
  - Logged approved 3B.S4 decisions and implementation plan updates in
    `docs/model_spec/data-engine/implementation_maps/segment_3B.impl_actual.md`
    (Entry: 2026-01-19 07:58).

* 08:04am
  - Added routing-field policy file `config/layer1/3B/virtual/virtual_routing_fields_v1.yaml`.
  - Updated contracts to register and validate the new policy:
    - `docs/model_spec/data-engine/layer-1/specs/contracts/3B/schemas.3B.yaml`
    - `docs/model_spec/data-engine/layer-1/specs/contracts/3B/dataset_dictionary.layer1.3B.yaml`
    - `docs/model_spec/data-engine/layer-1/specs/contracts/3B/artefact_registry_3B.yaml`
  - Updated 3B.S0 sealing list in
    `packages/engine/src/engine/layers/l1/seg_3B/s0_gate/runner.py` to require
    `virtual_routing_fields_v1`.
  - Logged implementation details in
    `docs/model_spec/data-engine/implementation_maps/segment_3B.impl_actual.md`
    (Entry: 2026-01-19 08:04).

* 08:26am
  - Appended an S4 follow-up planning entry in
    `docs/model_spec/data-engine/implementation_maps/segment_3B.impl_actual.md`
    (Entry: 2026-01-19 08:26) to preserve EngineFailure error codes and finish
    Makefile wiring for `segment3b-s4`.

* 08:27am
  - Updated S4 runner error handling in
    `packages/engine/src/engine/layers/l1/seg_3B/s4_virtual_contracts/runner.py`
    to preserve `EngineFailure` codes and align with S3 patterns.
  - Added `segment3b-s4` target wiring in `makefile` (PHONY + target + aggregate).

* 08:29am
  - Logged the S4 failure analysis and remediation plan (missing sealed
    `virtual_routing_fields_v1`, EngineFailure attribute mismatch, and
    run-report variable initialization) in
    `docs/model_spec/data-engine/implementation_maps/segment_3B.impl_actual.md`
    (Entry: 2026-01-19 08:29).

* 08:30am
  - Fixed S4 EngineFailure handling and run-report initialization in
    `packages/engine/src/engine/layers/l1/seg_3B/s4_virtual_contracts/runner.py`.
  - Logged the applied fixes in
    `docs/model_spec/data-engine/implementation_maps/segment_3B.impl_actual.md`
    (Entry: 2026-01-19 08:30).

* 08:31am
  - Moved `sealed_inputs_3B.json` and `s0_gate_receipt_3B.json` into
    `runs/local_full_run-5/970b0bd6833be3a0f08df8e8abf0364c/dev_overrides/3B_S0_reseal_2026-01-19_0831/`
    to unblock resealing with the new `virtual_routing_fields_v1` policy.
  - Logged the reseal action in
    `docs/model_spec/data-engine/implementation_maps/segment_3B.impl_actual.md`
    (Entry: 2026-01-19 08:31).

* 08:32am
  - Logged the S4 retry failure (polars LazyFrame `.groupby` vs `.group_by`)
    and planned fix in
    `docs/model_spec/data-engine/implementation_maps/segment_3B.impl_actual.md`
    (Entry: 2026-01-19 08:32).

* 08:33am
  - Updated S4 edge catalogue aggregation to use Polars `.group_by` in
    `packages/engine/src/engine/layers/l1/seg_3B/s4_virtual_contracts/runner.py`.
  - Logged the change in
    `docs/model_spec/data-engine/implementation_maps/segment_3B.impl_actual.md`
    (Entry: 2026-01-19 08:33).

* 08:34am
  - Logged the S4 `_StepTimer.info` formatting failure and planned f-string
    fix in `docs/model_spec/data-engine/implementation_maps/segment_3B.impl_actual.md`
    (Entry: 2026-01-19 08:34).

* 08:35am
  - Updated S4 `_StepTimer.info` calls to f-strings in
    `packages/engine/src/engine/layers/l1/seg_3B/s4_virtual_contracts/runner.py`.
  - Logged the applied fix in
    `docs/model_spec/data-engine/implementation_maps/segment_3B.impl_actual.md`
    (Entry: 2026-01-19 08:35).

* 08:36am
  - Logged the S4 validation-contract failure caused by object columns and
    the plan to extend `jsonschema_adapter` in
    `docs/model_spec/data-engine/implementation_maps/segment_3B.impl_actual.md`
    (Entry: 2026-01-19 08:36).

* 08:37am
  - Added object-column/item support to
    `packages/engine/src/engine/contracts/jsonschema_adapter.py`.
  - Logged the adapter changes in
    `docs/model_spec/data-engine/implementation_maps/segment_3B.impl_actual.md`
    (Entry: 2026-01-19 08:37).

* 08:39am
  - Logged the S4 run-summary schema mismatch (extra `digests` field) and
    planned contract-compliant fix in
    `docs/model_spec/data-engine/implementation_maps/segment_3B.impl_actual.md`
    (Entry: 2026-01-19 08:39).

* 08:40am
  - Removed the `digests` field from the S4 run-summary payload in
    `packages/engine/src/engine/layers/l1/seg_3B/s4_virtual_contracts/runner.py`.
  - Logged the applied fix in
    `docs/model_spec/data-engine/implementation_maps/segment_3B.impl_actual.md`
    (Entry: 2026-01-19 08:40).

* 08:41am
  - Re-ran `make segment3b-s4`; S4 completed with `status=PASS` and wrote
    `s4_run_summary_3B` + `s4_run_report_3B` for the current manifest.
  - Logged the successful run in
    `docs/model_spec/data-engine/implementation_maps/segment_3B.impl_actual.md`
    (Entry: 2026-01-19 08:41).

* 09:04am
  - Completed S5 spec + contract review (expanded spec, DAG, 3B contracts,
    layer1 bundle/flag schema, and 3A.S7 reference implementation).
  - Logged the S5 planning entry with open questions in
    `docs/model_spec/data-engine/implementation_maps/segment_3B.impl_actual.md`
    (Entry: 2026-01-19 09:04).

* 09:18am
  - Logged approved 3B.S5 decisions (bundle hash law, s5_manifest requirement,
    RNG logs posture, and lightweight evidence scope) in
    `docs/model_spec/data-engine/implementation_maps/segment_3B.impl_actual.md`
    (Entry: 2026-01-19 09:18).

* 09:20am
  - Added S5 evidence schemas and registered new bundle files in the 3B
    contracts:
    - `docs/model_spec/data-engine/layer-1/specs/contracts/3B/schemas.3B.yaml`
    - `docs/model_spec/data-engine/layer-1/specs/contracts/3B/dataset_dictionary.layer1.3B.yaml`
    - `docs/model_spec/data-engine/layer-1/specs/contracts/3B/artefact_registry_3B.yaml`
  - Logged the contract updates in
    `docs/model_spec/data-engine/implementation_maps/segment_3B.impl_actual.md`
    (Entry: 2026-01-19 09:20).

* 09:37am
  - Implemented the 3B.S5 runner in
    `packages/engine/src/engine/layers/l1/seg_3B/s5_validation_bundle/runner.py`.
  - Added CLI entrypoint `packages/engine/src/engine/cli/s5_validation_bundle_3b.py`.
  - Wired `segment3b-s5` into the Makefile targets.
  - Logged implementation progress in
    `docs/model_spec/data-engine/implementation_maps/segment_3B.impl_actual.md`
    (Entry: 2026-01-19 09:37).

* 09:38am
  - Fixed S5 run-report guardrails by initializing `tokens`/`run_paths` and
    gating run-report writing in
    `packages/engine/src/engine/layers/l1/seg_3B/s5_validation_bundle/runner.py`.
  - Logged the fix in
    `docs/model_spec/data-engine/implementation_maps/segment_3B.impl_actual.md`
    (Entry: 2026-01-19 09:38).

* 09:39am
  - Fixed YAML spacing in `s5_rng_summary_3B` schema
    (`docs/model_spec/data-engine/layer-1/specs/contracts/3B/schemas.3B.yaml`).
  - Logged the schema hotfix in
    `docs/model_spec/data-engine/implementation_maps/segment_3B.impl_actual.md`
    (Entry: 2026-01-19 09:39).

* 09:40am
  - Fixed `expected_blocks` spacing in `s5_rng_summary_3B` schema.
  - Logged the correction in
    `docs/model_spec/data-engine/implementation_maps/segment_3B.impl_actual.md`
    (Entry: 2026-01-19 09:40).

* 09:42am
  - Adjusted S5 validation-contract checking to drop null keys in nested
    structs before schema validation.
  - Logged the change in
    `docs/model_spec/data-engine/implementation_maps/segment_3B.impl_actual.md`
    (Entry: 2026-01-19 09:42).

* 09:53am
  - Investigated the S5 schema failure (null thresholds in
    `virtual_validation_contract_3B`) via a quick parquet inspection and
    confirmed `_drop_none` cleans the struct before validation.
  - Re-ran `make segment3b-s5`; S5 completed with `status=PASS` and wrote the
    validation bundle index + `_passed.flag` for the current manifest
    (tile-assign RNG log still optional/missing).
  - Logged the decision trail in
    `docs/model_spec/data-engine/implementation_maps/segment_3B.impl_actual.md`
    (Entry: 2026-01-19 09:53).

* 11:15am
  - Began Layer-2 Segment 5A review; read S0-S5 expanded state docs:
    - `docs/model_spec/data-engine/layer-2/specs/state-flow/5A/state.5A.s0.expanded.md`
    - `docs/model_spec/data-engine/layer-2/specs/state-flow/5A/state.5A.s1.expanded.md`
    - `docs/model_spec/data-engine/layer-2/specs/state-flow/5A/state.5A.s2.expanded.md`
    - `docs/model_spec/data-engine/layer-2/specs/state-flow/5A/state.5A.s3.expanded.md`
    - `docs/model_spec/data-engine/layer-2/specs/state-flow/5A/state.5A.s4.expanded.md`
    - `docs/model_spec/data-engine/layer-2/specs/state-flow/5A/state.5A.s5.expanded.md`
  - Reviewed 5A contracts for S0 planning:
    - `docs/model_spec/data-engine/layer-2/specs/contracts/5A/dataset_dictionary.layer2.5A.yaml`
    - `docs/model_spec/data-engine/layer-2/specs/contracts/5A/artefact_registry_5A.yaml`
    - `docs/model_spec/data-engine/layer-2/specs/contracts/5A/schemas.5A.yaml`
    - `docs/model_spec/data-engine/layer-2/specs/contracts/5A/schemas.layer2.yaml`

* 11:23am
  - Drafted the 5A.S0 implementation plan and design decisions in
    `docs/model_spec/data-engine/implementation_maps/segment_5A.impl_actual.md`
    (Entry: 2026-01-19 11:23).

* 11:59am
  - Reviewed conceptual/narrative context for Layer-2 work:
    - `docs/references/closed-world-fraud-enterprise-conceptual-design.md`
    - `docs/references/closed-world-synthetic-data-engine-with-realism-conceptual-design.md`
    - `docs/model_spec/data-engine/layer-1/narrative/narrative_1A-to-3B.md`
    - `docs/model_spec/data-engine/layer-2/narrative/narrative_5A-and-5B.md`
    - `docs/model_spec/data-engine/layer-3/narrative/narrative_6A-and-6B.md`
  - Re-checked 5A.S0 expanded spec and 5A contracts for implementation details.
  - Logged the updated decisions and execution plan in
    `docs/model_spec/data-engine/implementation_maps/segment_5A.impl_actual.md`
    (Entry: 2026-01-19 11:58).

* 12:33pm
  - Implemented 5A.S0 wiring and code:
    - Extended `packages/engine/src/engine/contracts/source.py` for layer-2 path resolution.
    - Built `packages/engine/src/engine/layers/l2/seg_5A/s0_gate/runner.py`.
    - Added CLI `packages/engine/src/engine/cli/s0_gate_5a.py`.
    - Added Makefile target `segment5a-s0` + args wiring.
  - Logged implementation-time decisions in
    `docs/model_spec/data-engine/implementation_maps/segment_5A.impl_actual.md`
    (Entry: 2026-01-19 12:30).

* 13:11pm
  - Planned fixes for 5A required configs and scenario calendar output paths.
  - Logged the detailed plan in
    `docs/model_spec/data-engine/implementation_maps/segment_5A.impl_actual.md`
    (Entry: 2026-01-19 13:10).

* 13:13pm
  - Added missing 5A configs:
    - `config/layer2/5A/scenario/scenario_metadata.v1.yaml`
    - `config/layer2/5A/policy/shape_time_grid_policy_5A.v1.yaml`
  - Updated scenario calendar generator to write to the contract path and accept
    `--output-root` (also wired in `make scenario_calendar_5a`).
  - Logged the implementation details in
    `docs/model_spec/data-engine/implementation_maps/segment_5A.impl_actual.md`
    (Entry: 2026-01-19 13:11).

* 13:28pm
  - Updated `scripts/build_scenario_calendar_5a.py` to deterministically
    augment PAYDAY/HOLIDAY events across extra demand classes when the non-toy
    floor (>=2000 events) is not met.
  - Logged the decision trail and mechanics in
    `docs/model_spec/data-engine/implementation_maps/segment_5A.impl_actual.md`
    (Entry: 2026-01-19 13:27).

* 13:31pm
  - Planned the 5A.S0 fix for 3B validation bundle index handling (members-based
    schema + digest by member file bytes) and recorded the plan in
    `docs/model_spec/data-engine/implementation_maps/segment_5A.impl_actual.md`
    (Entry: 2026-01-19 13:31).

* 13:34pm
  - Implemented the 3B-specific bundle index validation + digest flow in
    `packages/engine/src/engine/layers/l2/seg_5A/s0_gate/runner.py` and removed
    3B from the generic gate loop.
  - Logged the implementation details in
    `docs/model_spec/data-engine/implementation_maps/segment_5A.impl_actual.md`
    (Entry: 2026-01-19 13:34).

* 13:37pm
  - Fixed `merchant_class_policy_5A` schema mismatch by removing the nested
    `by_sector` layer under the channel-group mappings.
  - Logged the corrective decision trail in
    `docs/model_spec/data-engine/implementation_maps/segment_5A.impl_actual.md`
    (Entry: 2026-01-19 13:37).

* 13:39pm
  - Normalized 5A policy config versions to `v1` to match the dataset
    dictionary (avoids `S0_REQUIRED_POLICY_MISSING` on version checks).
  - Logged the corrective update in
    `docs/model_spec/data-engine/implementation_maps/segment_5A.impl_actual.md`
    (Entry: 2026-01-19 13:39).

* 13:40pm
  - Removed the unsupported `grid` block from `shape_library_5A` to satisfy the
    schemaâ€™s `additionalProperties: false` constraint.
  - Logged the corrective update in
    `docs/model_spec/data-engine/implementation_maps/segment_5A.impl_actual.md`
    (Entry: 2026-01-19 13:40).

* 13:41pm
  - Normalized scenario config versions (`scenario_horizon_config_5A`,
    `scenario_overlay_policy_5A`) to `v1` to match the dataset dictionary.
  - Logged the corrective update in
    `docs/model_spec/data-engine/implementation_maps/segment_5A.impl_actual.md`
    (Entry: 2026-01-19 13:41).

* 13:43pm
  - Replaced placeholder `predicate_schema` values in
    `scenario_overlay_policy_5A` with concrete examples that satisfy the schema
    (`global: true`, ISO2, tzid, etc.).
  - Logged the corrective update in
    `docs/model_spec/data-engine/implementation_maps/segment_5A.impl_actual.md`
    (Entry: 2026-01-19 13:43).

* 13:44pm
  - Planned a fix to allow optional 5A inputs to be missing without raising
    `InputResolutionError` in S0 (log entry recorded before code change).
  - Logged the plan in
    `docs/model_spec/data-engine/implementation_maps/segment_5A.impl_actual.md`
    (Entry: 2026-01-19 13:44).

* 13:45pm
  - Implemented the optional-input handling in 5A.S0 by catching
    `InputResolutionError` and skipping missing optional artefacts.
  - Logged the implementation in
    `docs/model_spec/data-engine/implementation_maps/segment_5A.impl_actual.md`
    (Entry: 2026-01-19 13:45).

* 13:46pm
  - Planned the fix for sealed_inputs_5A schema validation by inlining Layer-1
    refs (pre-change log entry).
  - Logged the plan in
    `docs/model_spec/data-engine/implementation_maps/segment_5A.impl_actual.md`
    (Entry: 2026-01-19 13:46).

* 13:46pm
  - Implemented Layer-1 + ingress ref inlining for sealed_inputs_5A validation.
  - Logged the implementation in
    `docs/model_spec/data-engine/implementation_maps/segment_5A.impl_actual.md`
    (Entry: 2026-01-19 13:46).

* 13:47pm
  - Planned a fix to default sealed_inputs_5A `notes` to an empty string so the
    schema accepts it.
  - Logged the plan in
    `docs/model_spec/data-engine/implementation_maps/segment_5A.impl_actual.md`
    (Entry: 2026-01-19 13:47).

* 13:47pm
  - Implemented the sealed_inputs_5A `notes` default to empty string.
  - Logged the implementation in
    `docs/model_spec/data-engine/implementation_maps/segment_5A.impl_actual.md`
    (Entry: 2026-01-19 13:47).

* 13:48pm
  - Planned to inline Layer-1 refs for `s0_gate_receipt_5A` and
    `scenario_manifest_5A` schema validation.
  - Logged the plan in
    `docs/model_spec/data-engine/implementation_maps/segment_5A.impl_actual.md`
    (Entry: 2026-01-19 13:48).

* 13:49pm
  - Implemented Layer-1 + ingress ref inlining for receipt and scenario
    manifest schema validation.
  - Logged the implementation in
    `docs/model_spec/data-engine/implementation_maps/segment_5A.impl_actual.md`
    (Entry: 2026-01-19 13:49).

* 13:49pm
  - Ran `make segment5a-s0 SEG5A_S0_RUN_ID=d61f08e2e45ef1bc28884034de4c1b68`;
    S0 completed successfully with optional inputs skipped.
  - Logged the run outcome in
    `docs/model_spec/data-engine/implementation_maps/segment_5A.impl_actual.md`
    (Entry: 2026-01-19 13:49).

* 13:58pm
  - Planned authoring of optional 5A configs so S0 can seal them
    (zone_shape_modifiers, overlay ordering/validation, validation policy,
    spec compatibility).
  - Logged the plan in
    `docs/model_spec/data-engine/implementation_maps/segment_5A.impl_actual.md`
    (Entry: 2026-01-19 13:58).

* 14:00pm
  - Authored optional 5A configs in `config/layer2/5A` for zone modifiers,
    overlay ordering/validation, validation policy, and spec compatibility.
  - Logged the implementation details in
    `docs/model_spec/data-engine/implementation_maps/segment_5A.impl_actual.md`
    (Entry: 2026-01-19 14:00).

* 14:01pm
  - Ran `make segment5a-s0` after adding optional configs; S0 failed with
    `S0_OUTPUT_CONFLICT` due to existing sealed outputs from the prior run.
  - Logged the remediation plan in
    `docs/model_spec/data-engine/implementation_maps/segment_5A.impl_actual.md`
    (Entry: 2026-01-19 14:01).

* 14:07pm
  - Deleted prior 5A S0 outputs for the manifest and re-ran
    `make segment5a-s0 SEG5A_S0_RUN_ID=d61f08e2e45ef1bc28884034de4c1b68`.
  - S0 completed successfully and sealed the optional configs.
  - Logged the outcome in
    `docs/model_spec/data-engine/implementation_maps/segment_5A.impl_actual.md`
    (Entry: 2026-01-19 14:07).

* 14:13pm
  - Read 5A.S1 expanded spec in `docs/model_spec/data-engine/layer-2/specs/state-flow/5A/state.5A.s1.expanded.md`.
  - Read 5A contracts in `docs/model_spec/data-engine/layer-2/specs/contracts/5A/dataset_dictionary.layer2.5A.yaml`,
    `docs/model_spec/data-engine/layer-2/specs/contracts/5A/schemas.5A.yaml`, and
    `docs/model_spec/data-engine/layer-2/specs/contracts/5A/artefact_registry_5A.yaml`.
  - Read policy authoring guides in
    `docs/model_spec/data-engine/layer-2/specs/data-intake/5A/merchant_class_policy_5A_authoring-guide.md` and
    `docs/model_spec/data-engine/layer-2/specs/data-intake/5A/demand_scale_policy_5A_authoring-guide.md`.

* 14:19pm
  - Drafted a detailed 5A.S1 implementation plan and open questions (merchant attributes source,
    optional merchant_class_profile_5A) in
    `docs/model_spec/data-engine/implementation_maps/segment_5A.impl_actual.md`
    (Entry: 2026-01-19 14:13).

* 15:21pm
  - Added the 5A.S1 merchant-attributes sealing decision to
    `docs/model_spec/data-engine/implementation_maps/segment_5A.impl_actual.md`
    (Entry: 2026-01-19 15:21), covering dictionary/registry updates and
    5A.S0 version resolution for `transaction_schema_merchant_ids`.

* 15:34pm
  - Implemented 5A.S1 demand classification (runner + CLI) and updated the makefile target.
  - Logged the detailed implementation decisions in
    `docs/model_spec/data-engine/implementation_maps/segment_5A.impl_actual.md`
    (Entry: 2026-01-19 15:34).

* 15:35pm
  - Updated 5A.S1 classification to fail-closed when a policy branch is missing, instead of using default_class.
  - Logged the decision in `docs/model_spec/data-engine/implementation_maps/segment_5A.impl_actual.md`
    (Entry: 2026-01-19 15:35).

* 15:43pm
  - Ran `make segment5a-s0 SEG5A_S0_RUN_ID=d61f08e2e45ef1bc28884034de4c1b68` after
    adding `transaction_schema_merchant_ids` to the sealed inputs.
  - S0 failed with `S0_OUTPUT_CONFLICT` because the new sealed_inputs_digest differs from
    the existing sealed outputs.
  - Logged the remediation plan and target paths in
    `docs/model_spec/data-engine/implementation_maps/segment_5A.impl_actual.md`
    (Entry: 2026-01-19 15:43).

* 15:47pm
  - `make segment5a` failed at 5A.S0 with `S0_REQUIRED_SCENARIO_MISSING`.
  - Root cause: `scenario_calendar_5A` missing under the run-local data path; make target writes to
    `RUN_ROOT` unless `RUN_ID`/`SCENARIO_CAL_RUN_ROOT` is set.
  - Logged remediation plan in `docs/model_spec/data-engine/implementation_maps/segment_5A.impl_actual.md`
    (Entry: 2026-01-19 15:47).

* 15:56pm
  - Investigated the 5A.S1 failure after `make segment5a` and traced it to schema validation
    (`Unresolvable: schemas.layer1.yaml#/$defs/id64` during `domain_build`).
  - Logged the fix plan (inline Layer-1 refs for table-pack validation in S1) in
    `docs/model_spec/data-engine/implementation_maps/segment_5A.impl_actual.md`
    (Entry: 2026-01-19 15:56).

* 15:58pm
  - Inlined Layer-1 schema refs for all 5A.S1 table-pack validations in
    `packages/engine/src/engine/layers/l2/seg_5A/s1_demand_classification/runner.py`.
  - Logged the implementation details in
    `docs/model_spec/data-engine/implementation_maps/segment_5A.impl_actual.md`
    (Entry: 2026-01-19 15:58).

* 16:00pm
  - Ran `make segment5a SEG5A_S0_RUN_ID=d61f08e2e45ef1bc28884034de4c1b68 SEG5A_S1_RUN_ID=d61f08e2e45ef1bc28884034de4c1b68`.
  - S0 completed (outputs identical; skipped publish).
  - S1 failed during `domain_build` schema validation with missing required fields
    (`seed`, `manifest_fingerprint`, `site_count`, `prior_pack_id`, `prior_pack_version`)
    because `zone_alloc` was validated after column trimming.
  - Logged the remediation plan in
    `docs/model_spec/data-engine/implementation_maps/segment_5A.impl_actual.md`
    (Entry: 2026-01-19 16:00).

* 16:02pm
  - Updated 5A.S1 to validate full `zone_alloc` and `virtual_classification_3B`
    tables before projecting columns.
  - Logged the implementation details in
    `docs/model_spec/data-engine/implementation_maps/segment_5A.impl_actual.md`
    (Entry: 2026-01-19 16:02).

* 16:06pm
  - Re-ran `make segment5a` and saw S1 fail in `merchant_attributes` because
    `transaction_schema_merchant_ids` resolved to `{semver}` instead of the
    concrete version.
  - Logged the plan to fix `_render_version` in 5A.S0 (token substitution before
    semver fallback) in `docs/model_spec/data-engine/implementation_maps/segment_5A.impl_actual.md`
    (Entry: 2026-01-19 16:06).

* 16:08pm
  - Updated `_render_version` in 5A.S0 to substitute tokens before falling back
    to registry semver.
  - Logged the implementation details in
    `docs/model_spec/data-engine/implementation_maps/segment_5A.impl_actual.md`
    (Entry: 2026-01-19 16:08).

* 16:10pm
  - Prepared to reseal 5A.S0 by removing prior outputs for the manifest after
    the version-rendering fix.
  - Logged the deletion rationale and target paths in
    `docs/model_spec/data-engine/implementation_maps/segment_5A.impl_actual.md`
    (Entry: 2026-01-19 16:10).

* 16:11pm
  - Deleted the prior 5A.S0 output directories for the current manifest to
    allow resealing with the corrected version rendering.
  - Logged the completed action in
    `docs/model_spec/data-engine/implementation_maps/segment_5A.impl_actual.md`
    (Entry: 2026-01-19 16:11).

* 16:13pm
  - Observed S1 failing when reading `transaction_schema_merchant_ids` because
    the directory mixes parquet and CSV files.
  - Logged the plan to read only `.parquet` files via a helper in
    `docs/model_spec/data-engine/implementation_maps/segment_5A.impl_actual.md`
    (Entry: 2026-01-19 16:13).

* 16:15pm
  - Added `_resolve_parquet_files` and switched S1 to read only parquet files
    for `transaction_schema_merchant_ids`.
  - Logged the implementation details in
    `docs/model_spec/data-engine/implementation_maps/segment_5A.impl_actual.md`
    (Entry: 2026-01-19 16:15).

* 16:18pm
  - Observed S1 fail during output validation because
    `merchant_zone_profile_5A` uses an array schema.
  - Logged the plan to add an array-row validator in
    `docs/model_spec/data-engine/implementation_maps/segment_5A.impl_actual.md`
    (Entry: 2026-01-19 16:18).

* 16:20pm
  - Added `_validate_array_rows` and switched S1 output validation to use it
    for `merchant_zone_profile_5A` and `merchant_class_profile_5A`.
  - Logged the implementation details in
    `docs/model_spec/data-engine/implementation_maps/segment_5A.impl_actual.md`
    (Entry: 2026-01-19 16:20).

* 16:23pm
  - Observed S1 fail because array-item validation lacked parent `$defs`
    (`PointerToNowhere: '/$defs/hex64'`).
  - Logged the plan to merge parent `$defs` into the item schema in
    `docs/model_spec/data-engine/implementation_maps/segment_5A.impl_actual.md`
    (Entry: 2026-01-19 16:23).

* 16:25pm
  - Merged parent `$defs` into the array item schema during S1 output validation.
  - Logged the implementation details in
    `docs/model_spec/data-engine/implementation_maps/segment_5A.impl_actual.md`
    (Entry: 2026-01-19 16:25).

* 16:28pm
  - Observed S1 fail while building `merchant_class_profile_5A` due to
    merchant_id overflow (values > int64).
  - Logged the plan to enforce `UInt64` via `schema_overrides` in
    `docs/model_spec/data-engine/implementation_maps/segment_5A.impl_actual.md`
    (Entry: 2026-01-19 16:28).

* 16:30pm
  - Applied `schema_overrides={"merchant_id": pl.UInt64}` when building
    `merchant_class_profile_5A` to avoid overflow.
  - Logged the implementation details in
    `docs/model_spec/data-engine/implementation_maps/segment_5A.impl_actual.md`
    (Entry: 2026-01-19 16:30).

* 16:33pm
  - `make segment5a SEG5A_S0_RUN_ID=d61f08e2e45ef1bc28884034de4c1b68 SEG5A_S1_RUN_ID=d61f08e2e45ef1bc28884034de4c1b68`
    completed successfully; S1 published merchant profiles and run-report.
  - Logged the successful run in
    `docs/model_spec/data-engine/implementation_maps/segment_5A.impl_actual.md`
    (Entry: 2026-01-19 16:33).

* 16:18pm
  - Began 5A.S2 review and planning; read:
    - `docs/model_spec/data-engine/layer-2/specs/state-flow/5A/state.5A.s2.expanded.md`
    - `docs/model_spec/data-engine/layer-2/specs/contracts/5A/dataset_dictionary.layer2.5A.yaml`
    - `docs/model_spec/data-engine/layer-2/specs/contracts/5A/artefact_registry_5A.yaml`
    - `docs/model_spec/data-engine/layer-2/specs/contracts/5A/schemas.5A.yaml`
    - `config/layer2/5A/policy/shape_library_5A.v1.yaml`
    - `config/layer2/5A/policy/shape_time_grid_policy_5A.v1.yaml`
    - `config/layer2/5A/policy/zone_shape_modifiers_5A.v1.yaml`
    - `config/layer2/5A/scenario/scenario_metadata.v1.yaml`
  - Drafted the 5A.S2 implementation plan and open questions in
    `docs/model_spec/data-engine/implementation_maps/segment_5A.impl_actual.md`
    (Entry: 2026-01-19 16:18).

* 16:21pm
  - Logged approved 5A.S2 decisions (scenario handling, channel dimension, template selection,
    normalisation tolerance, degenerate totals, catalogue emission, constraints enforcement) in
    `docs/model_spec/data-engine/implementation_maps/segment_5A.impl_actual.md`
    (Entry: 2026-01-19 16:21).

* 16:52pm
  - Revisited 5A.S2 implementation decisions to align with the authoring guide and catalogue invariants.
  - Logged the adjustments (bucket-start minute evaluation, scenario_id list handling, catalogue/template_id strategy,
    adjustment_flags emission) in `docs/model_spec/data-engine/implementation_maps/segment_5A.impl_actual.md`
    (Entry: 2026-01-19 16:52).

* 17:39pm
  - Re-scanned 5A.S2 references and authoring guides to align error codes, grid math, and modifier rules:
    `docs/model_spec/data-engine/layer-2/specs/state-flow/5A/state.5A.s2.expanded.md`,
    `docs/model_spec/data-engine/layer-2/specs/data-intake/5A/shape_library_5A_authoring-guide.md`,
    `docs/model_spec/data-engine/layer-2/specs/data-intake/5A/zone_shape_modifiers_5A-_authoring-guide.md`,
    `docs/model_spec/data-engine/layer-2/specs/data-intake/5A/baseline_intensity_policy_5A_authoring-guide.md`,
    `config/layer2/5A/policy/baseline_intensity_policy_5A.v1.yaml`,
    `config/layer2/5A/validation/validation_policy_5A.v1.yaml`.
  - Logged the updated S2 implementation plan and decisions in
    `docs/model_spec/data-engine/implementation_maps/segment_5A.impl_actual.md`
    (Entry: 2026-01-19 17:39).

* 17:55pm
  - Implemented 5A.S2 runner logic, added CLI entrypoint, and wired `make segment5a-s2`
    in `makefile`.
  - Logged the implementation details in
    `docs/model_spec/data-engine/implementation_maps/segment_5A.impl_actual.md`
    (Entry: 2026-01-19 17:55).

* 17:59pm
  - Observed S2 failing because `merchant_zone_profile_5A` was incorrectly treated as a
    sealed input and because a trailing newline in a multiline path template caused an
    invalid Windows path during output staging.
  - Logged the fix plan in
    `docs/model_spec/data-engine/implementation_maps/segment_5A.impl_actual.md`
    (Entry: 2026-01-19 17:59).

* 18:00pm
  - Removed the sealed-input dependency on `merchant_zone_profile_5A`, added a direct
    existence check for the S1 output, and stripped path-template whitespace in
    `_resolve_dataset_path`/`_render_catalog_path` to eliminate newline path errors.
  - Re-ran `make segment5a-s2`; S2 published shape grid, class-zone shapes, and the
    optional catalogue successfully.
  - Logged the completed fix in
    `docs/model_spec/data-engine/implementation_maps/segment_5A.impl_actual.md`
    (Entry: 2026-01-19 18:00).
