# Logbook
### Date: 22nd January 2026
### Project: Fraud Detection System
### Reference commits: Check commits on this date (if any)

* 1:09am
  - Noted date rollover: the 1:08am entry about the S4 optimization plan was appended to `docs/logbook/01-2026/2026-01-21.md` before the date check. Correcting the record here while leaving the original entry intact.
  - Re-stated the S4 optimization plan entry (region-parallel + vectorized emission + deterministic hash) to align with the current date.

* 1:21am
  - Implemented the S4 region-parallel + vectorized emission path with deterministic hash sampling and region part merges; updated Makefile with `ENGINE_6A_S4_WORKERS` and S4 command wiring.
  - Logged the implementation update in `docs/model_spec/data-engine/implementation_maps/segment_6A.impl_actual.md` (Entry: 2026-01-22 01:20).

* 1:26am
  - `make segment6a-s4` failed in worker due to polars `read_parquet(filters=...)`; updated `_emit_region_parts` to use `scan_parquet().filter().collect()` and logged the fix in `docs/model_spec/data-engine/implementation_maps/segment_6A.impl_actual.md` (Entry: 2026-01-22 01:25).

* 1:29am
  - `make segment6a-s4` failed in workers because `scan_parquet(columns=...)` is unsupported; updated to `scan_parquet().select(...).filter(...).collect()` and logged in `docs/model_spec/data-engine/implementation_maps/segment_6A.impl_actual.md` (Entry: 2026-01-22 01:28).

* 1:33am
  - `make segment6a-s4` crashed due to Arrow schema mismatch (large_string vs string); added schema casts before ParquetWriter writes for device/ip link parts and logged the fix in `docs/model_spec/data-engine/implementation_maps/segment_6A.impl_actual.md` (Entry: 2026-01-22 01:32).

* 1:36am
  - Added `add_file_handler` inside S4 region workers so progress/ETA logs are written to the run log; logged the adjustment in `docs/model_spec/data-engine/implementation_maps/segment_6A.impl_actual.md` (Entry: 2026-01-22 01:36).

* 1:41am
  - Ran `make segment6a-s4`; region-parallel emission completed (~82s) and merges finished, but publish failed with `6A.S4.IO_WRITE_CONFLICT` because `s4_device_base_6A` already existed.
  - Logged the performance + conflict in `docs/model_spec/data-engine/implementation_maps/segment_6A.impl_actual.md` (Entry: 2026-01-22 01:40).

* 1:44am
  - Fixed S4 allocation progress totals to match per-device_type updates (prevents counts like 21/15) and logged it in `docs/model_spec/data-engine/implementation_maps/segment_6A.impl_actual.md` (Entry: 2026-01-22 01:44).

* 1:35am
  - Deleted existing 6A.S4 outputs for seed=42/parameter_hash=56d45126eaabedd083a1d8428a763e0278c89efec5023cfd6cf3cab7fc8dd2d7/manifest_fingerprint=1cb60481d69b836ee24505ec9a6ec231c8f18523ee9b7dabbd38c0a33bf15765 (s4_device_base_6A, s4_device_links_6A, s4_ip_base_6A, s4_ip_links_6A) to clear publish conflicts.

* 1:40am
  - Reran `make segment6a-s4`; completed successfully in ~98s with outputs + RNG event logs published for run_id `d61f08e2e45ef1bc28884034de4c1b68`.
  - Noted WARNs for missing sealed inputs (device/ip priors + linkage rules) and fallback to repo config paths; logged the outcome in `docs/model_spec/data-engine/implementation_maps/segment_6A.impl_actual.md` (Entry: 2026-01-22 01:40).

* 1:46am
  - Read binding context docs before touching 6A.S0: `docs/references/closed-world-fraud-enterprise-conceptual-design.md`, `docs/references/closed-world-synthetic-data-engine-with-realism-conceptual-design.md`, `docs/model_spec/data-engine/layer-1/narrative/narrative_1A-to-3B.md`, `docs/model_spec/data-engine/layer-2/narrative/narrative_5A-and-5B.md`, `docs/model_spec/data-engine/layer-3/narrative/narrative_6A-and-6B.md`, and `packages/engine/AGENTS.md`.
  - Reviewed 6A.S0 expanded spec + contracts: `docs/model_spec/data-engine/layer-3/specs/state-flow/6A/state.6A.s0.expanded.md`, `docs/model_spec/data-engine/layer-3/specs/contracts/6A/artefact_registry_6A.yaml`, `docs/model_spec/data-engine/layer-3/specs/contracts/6A/dataset_dictionary.layer3.6A.yaml`, `docs/model_spec/data-engine/layer-3/specs/contracts/6A/schemas.6A.yaml`, `docs/model_spec/data-engine/layer-3/specs/contracts/6A/schemas.layer3.yaml`.
  - Noted the sealed_inputs rows already include the missing keys, but with role values that do not match 6A.S4 expectations; plan is to adjust 6A.S0 role mapping and re-run S0 after clearing outputs or in a fresh run.

* 1:48am
  - Updated 6A.S0 role mapping to emit `DEVICE_PRIOR` / `IP_PRIOR` for device/ip count priors and `DEVICE_LINKAGE_RULES` / `GRAPH_LINKAGE_RULES` for linkage rules so S4 can resolve sealed inputs without fallback.
  - Logged the implementation change in `docs/model_spec/data-engine/implementation_maps/segment_6A.impl_actual.md` (Entry: 2026-01-22 01:48).

* 1:49am
  - Ran `python -m py_compile packages/engine/src/engine/layers/l3/seg_6A/s0_gate/runner.py`.
  - Held off on rerunning `make segment6a-s0` because existing S0 outputs for the run would require deletion or a fresh run_id; awaiting approval.

* 1:54am
  - Ran `make segment6a`; S0 completed PASS with new sealed_inputs roles, then S1 failed on `6A.S1.IO_WRITE_CONFLICT` because RNG event file already exists under `runs/local_full_run-5/d61f08e2e45ef1bc28884034de4c1b68/logs/layer3/6A/rng/events/party_count_realisation/...`.
  - Need to clear the RNG events for this run or use a fresh run_id before rerunning Segment 6A.

* 1:55am
  - Deleted `runs/local_full_run-5/d61f08e2e45ef1bc28884034de4c1b68/logs/layer3/6A/rng/events/` and reran `make segment6a`.
  - S0 passed (outputs identical; publish skipped), S1 failed on `6A.S1.IO_WRITE_CONFLICT` because `s1_party_base_6A` already exists under `runs/local_full_run-5/d61f08e2e45ef1bc28884034de4c1b68/data/layer3/6A/...`.
  - Need to remove the existing S1 outputs (or use a fresh run_id) before rerunning Segment 6A.

* 2:01am
  - Deleted `runs/local_full_run-5/d61f08e2e45ef1bc28884034de4c1b68/data/layer3/6A/s1_party_base_6A/` and `runs/local_full_run-5/d61f08e2e45ef1bc28884034de4c1b68/data/layer3/6A/s1_party_summary_6A/`.
  - Reran `make segment6a`; S0/S1/S2 completed and S3 started. The CLI call timed out on our side while the run continued in the background; monitoring via the run log.

* 2:11am
  - Observed S3 completion in the run log, then ran `make segment6a-s4` to finish Segment 6A; S4 completed successfully (~106s) and published device/IP outputs + RNG events.
  - Segment 6A is green through S4 for run_id `d61f08e2e45ef1bc28884034de4c1b68`.
