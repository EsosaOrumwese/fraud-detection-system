# Logbook
### Date: 1st September 2025
### Project: Fraud Detection System
### Issues Resolved: [SD-02](https://github.com/EsosaOrumwese/fraud-detection-system/issues/25) `in-progress`
### Reference commits: Check commits on this date (if any)


* 5:14am
  * spec(schema,s0): close critical issues C1–C7 for State-0
    - Summary of closures
      - C1 — Envelope semantics (draws vs counters; blocks meaning)
        - Schema: redefine `blocks` as the 128-bit PRNG counter delta and keep
          `draws` as the count of uniforms used (dec u128 string). Remove any
          implication that `blocks == draws`.
        - S0: invariants now explicitly state `blocks = after − before (u128)`
          and `draws` is checked by per-family budgets.
      - C2 — Event timestamp precision (`ts_utc`)
          - S0: unify examples and wording to **exactly six fractional digits**
            (microseconds) for RFC-3339 `ts_utc`. Failure records remain epoch-ns.
      - C3 — `draws` typing on the wire
          - S0: correct serialization note—counters and `blocks` are numbers;
            `draws` is a **decimal u128 string** per schema.
      - C4 — Invariants made explicit
          - S0: tighten normative bullets to separate counter equality check
            (`blocks`) from per-family budget (`draws`), with single-uniform,
            Box–Muller, and non-consuming examples.
      - C5 — Box–Muller envelope requirement
          - S0: normative MUST for `(blocks=1, draws="2")` and “no caching”.
      - C6 — Audit schema anchor & separation
          - S0: reference the correct anchor `schemas.layer1.yaml#/rng/core/rng_audit_log`
            and reiterate “audit is not an event” (no event envelope).
      - C7 — Trace totals semantics
          - Schema: clarify `rng_trace_log` description —
            `draws_total = Σ event draws (uniforms)` and
            `blocks_total = Σ event counter deltas (PRNG blocks)`; no equality implied.
    - Files changed
      - `schemas.layer1.yaml.txt`
        - Update #/$defs/rng_envelope: description for `draws` and `blocks`.
        - Update rng_trace_log.description: define totals semantics explicitly.
      - `state.1A.s0.expanded.txt`
        - §S0.3.1: enforce µs precision for `ts_utc`; fix examples.
        - Serialization note: `draws` is decimal string; counters/`blocks` are numbers.
        - Invariants: make counter delta vs draws budget explicit.
        - §S0.3.5 (Box–Muller): elevate envelope budget to MUST.
        - §S0.3.2/§S0.3.9: correct audit anchor and restate audit ≠ event.
  * s1-l1: finalize and align L1 with S0/S1 specs (green)
    * Summary
      - Brings state-1 L1 kernels and docs into full alignment with the frozen S0/S1 specs and S1-L0.
      - Resolves all previously flagged blockers and consistency gaps; L1 is now green.
    * Key changes
      - RNG derivation: switch to master-based flow
        - Use `derive_master_material(seed, manifest_fingerprint_bytes)` → `derive_substream(master, …)`.
        - Thread `manifest_fingerprint_bytes: bytes[32]` through `Context`; promote this field in the top-level `Context` type.
      - Internal vs emitted names:
        - Use `before_*` / `after_*` internally in `Decision` and sanity checks; reserve `rng_counter_*` for emitted envelope only.
        - Sanity check now compares `ev_ctx.before_*` to `decision.before_*`.
      - Trace & envelope:
        - Remove `detail` arg from `update_rng_trace_totals(...)`.
        - Ensure `ts_utc` is microsecond and counters/draws identity checks are explicit.
        - `end_event_emit` comment label normalized to `/*dataset_id*/`.
      - Substream budgeting clarity:
        - Make `u128_to_decimal_string` call explicit via `(dhi, dlo)` computed by `u128_delta(after, before)`; no change to `uniform1` signature.
      - Handoff routing:
        - Replace brittle numeric IDs with symbolic names:
          - `SingleHomePlacement` (formerly S7)
          - `NegativeBinomialS2` (formerly S2)
        - Update S1.5 prose and the `next_state` enum accordingly.
      - L0 dependencies table completed:
        - Add `derive_master_material`, `u128_to_decimal_string`, `u128_to_uint64_or_abort`.
    * Rationale
      - Restores a single source of truth for fingerprint material (bytes) per S0; avoids ad-hoc hex decoding in L1.
      - Removes naming ambiguity between internal ctx/decision fields and emitted envelope fields.
      - Keeps L1 as pure kernels; no orchestration/path resolution logic leaks in.

* 4:39pm
  * spec(schema,s0): close high issues H1–H8 for State-0
    * Summary of closures
      - H1 — Event envelope scope and wording
        - S0: Heading now reads “mandatory on every RNG **event** row”.
        - Added explicit note that audit/trace live under
          `schemas.layer1.yaml#/rng/core/*` and **do not** embed the event envelope.
        - Updated the envelope example’s `module` comment.
      - H2 — Module naming convention
        - S0: Added a normative rule: `module` MUST equal a **registered
          producer** in the dataset dictionary (e.g., `1A.hurdle_sampler`,
          `1A.nb_sampler`, `1A.gumbel_sampler`).
        -  Updated the failure-schema example to use `1A.gumbel_sampler`.
      - H3 — `substream_label` governance
        - S0: Added a normative rule that `substream_label` MUST be a member of
          the `rng_event_schema_catalog` artefact
          (manifest_key `mlr.rng.events.schema_catalog`);
          validators MUST enforce membership.
      - H4 — Trace totals policy
        - S0: Added run policy: producers MUST fail fast with
          `F4d:rng_budget_violation` **before** any saturation of totals; wire
          counters remain saturating.
      - H5 — Remove undocumented `payload.uniforms` duplication
        - S0: Removed the “optional duplication” promise; the authoritative
          uniform count is the envelope field `draws` (decimal u128).
      - H6 — `run_id` format enforcement
        - Schema: Introduced `$defs.hex32` and updated `run_id` to
          `$ref: "#/$defs/hex32"` in:
          – rng_envelope.properties.run_id
          – rng.core/rng_audit_log.record.properties.run_id
          – rng.core/rng_trace_log.record.properties.run_id
      - H7 — Gumbel logging granularity
        - S0: Made it explicit: **one `gumbel_key` event per candidate** and
          **event-level `draws="1"`**.
      - H8 — MCC domain alignment
        - S0: Replaced “MCC subset enum” language with the actual ingress typing:
          **int32 in [0,9999]** (4-digit code), with a forward hook to adopt an
          ISO-18245 catalogue artefact later if desired.
    * Files changed
      - state.1A.s0.expanded.v2-yellow.txt
        - Envelope heading text + audit/trace note.
        - Module/label governance bullets.
        - Fail-fast policy under §S0.3.9.
        - Removal of `payload.uniforms` duplication line.
        - Gumbel budget line updated (explicit `draws="1"`).
        - MCC domain rewritten to numeric range.
      - schemas.layer1.yaml.v2.txt
        - Added `$defs.hex32`.
        - `run_id` now `$ref: "#/$defs/hex32"` in envelope, audit, and trace.
    * Rationale
      These edits eliminate ambiguity around event vs core logs, enforce a
      single source of truth for labels and module names, harden the run_id
      contract, and make Gumbel/event budgeting unambiguous, while keeping the
      wire format and dataset shapes stable.

* 5:24pm
  * s1-l2: finalize L2 orchestrator; align with frozen S0/S1 + L0/L1 (green)
    * Summary
      - Brings state-1 L2 (orchestrator/wiring) into full alignment with the frozen S0/S1 specs and the finalized S1-L0/L1 kernels.
      - Removes ambiguity between hex vs bytes for RNG derivation, replaces numeric routing with symbolic names, and consolidates the orchestrator into a single canonical flow.
    * Key changes
      - RNG derivation & replayability:
        - Adopt master-based derivation everywhere: `master = derive_master_material(seed, manifest_fingerprint_bytes)` → `derive_substream(master, "hurdle_bernoulli", (merchant_id))`.
        - Rewrite replayability/determinism prose to reference **bytes** (not hex); hex retained only for lineage/partition IDs.
      - API & threading:
        - `run_S1(...)` now accepts and threads `manifest_fingerprint_bytes: bytes[32]` from S0 into S1.1 and onward.
        - Orchestrator calls to `S1_1_load_and_guard(...)` updated to include `manifest_fingerprint_bytes`.
      - Routing / handoff:
        - Replace brittle numeric IDs `{S2,S7}` with symbolic names: `SingleHomePlacement` and `NegativeBinomialS2`.
        - Rename internal variable `route` → `next_state`; update enum/prose, diagrams, and edge lists (e.g., `append (m, Xi_m, next_state)`).
      - Mini call-map & diagrams:
        - S1.1 row now lists `manifest_fingerprint_bytes` and enumerates guards (block-order check, path-partition lint, RNG audit presence).
        - Remove stray guard text from S1.2 row; guards stay scoped to S1.1.
        - Update run-level DAG and explicit edge list (E6) to use `next_state`.
      - DTO clarity & serialization:
        - Mark `EmittedHurdle` in L2 as a **minimal projection for routing** (S1.4 remains authoritative).
        - Add reminder: `pi` and `u` serialize as **shortest binary64 round-trip JSON numbers**.
      - Naming coherence:
        - Standardize on `logistic_branch_stable` (two-branch stable logistic) in narrative.
      - Hygiene:
        - Remove duplicate `run_S1` skeleton; keep a single canonical orchestrator.
        - Tighten wording for order-invariant substreams and “no cross-label chaining.”
    * Compatibility / expected ripples (outside L2)
      - Upstream must provide `manifest_fingerprint_bytes` alongside hex (S0 already produces both).
      - Any downstream consumer of the routing value must accept symbolic `next_state` (`SingleHomePlacement`, `NegativeBinomialS2`) or define trivial aliases.
    * Validation
      - No remaining `{S2,S7}` routing references or `route` variable in public contracts.
      - All master-based derivation paths and replayability text reference **bytes**.
      - S1.1 inputs/guards are consistent across the mini call-map, narrative, and orchestrator.
      - Only S1.4 performs serialized emission; counters/draws identity and 0/1 block budget preserved.
    * Notes
      - Changes are wiring + documentation coherence only; no new math or policy added at L2.

* 