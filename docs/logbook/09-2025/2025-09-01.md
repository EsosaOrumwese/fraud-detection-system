# Logbook
### Date: 1st September 2025
### Project: Fraud Detection System
### Issues Resolved: [SD-02](https://github.com/EsosaOrumwese/fraud-detection-system/issues/25) `in-progress`
### Reference commits: Check commits on this date (if any)


* 5:14am
  * spec(schema,s0): close critical issues C1–C7 for State-0
    - Summary of closures
      - C1 — Envelope semantics (draws vs counters; blocks meaning)
        - Schema: redefine `blocks` as the 128-bit PRNG counter delta and keep
          `draws` as the count of uniforms used (dec u128 string). Remove any
          implication that `blocks == draws`.
        - S0: invariants now explicitly state `blocks = after − before (u128)`
          and `draws` is checked by per-family budgets.
      - C2 — Event timestamp precision (`ts_utc`)
          - S0: unify examples and wording to **exactly six fractional digits**
            (microseconds) for RFC-3339 `ts_utc`. Failure records remain epoch-ns.
      - C3 — `draws` typing on the wire
          - S0: correct serialization note—counters and `blocks` are numbers;
            `draws` is a **decimal u128 string** per schema.
      - C4 — Invariants made explicit
          - S0: tighten normative bullets to separate counter equality check
            (`blocks`) from per-family budget (`draws`), with single-uniform,
            Box–Muller, and non-consuming examples.
      - C5 — Box–Muller envelope requirement
          - S0: normative MUST for `(blocks=1, draws="2")` and “no caching”.
      - C6 — Audit schema anchor & separation
          - S0: reference the correct anchor `schemas.layer1.yaml#/rng/core/rng_audit_log`
            and reiterate “audit is not an event” (no event envelope).
      - C7 — Trace totals semantics
          - Schema: clarify `rng_trace_log` description —
            `draws_total = Σ event draws (uniforms)` and
            `blocks_total = Σ event counter deltas (PRNG blocks)`; no equality implied.
    - Files changed
      - `schemas.layer1.yaml.txt`
        - Update #/$defs/rng_envelope: description for `draws` and `blocks`.
        - Update rng_trace_log.description: define totals semantics explicitly.
      - `state.1A.s0.expanded.txt`
        - §S0.3.1: enforce µs precision for `ts_utc`; fix examples.
        - Serialization note: `draws` is decimal string; counters/`blocks` are numbers.
        - Invariants: make counter delta vs draws budget explicit.
        - §S0.3.5 (Box–Muller): elevate envelope budget to MUST.
        - §S0.3.2/§S0.3.9: correct audit anchor and restate audit ≠ event.
  * s1-l1: finalize and align L1 with S0/S1 specs (green)
    * Summary
      - Brings state-1 L1 kernels and docs into full alignment with the frozen S0/S1 specs and S1-L0.
      - Resolves all previously flagged blockers and consistency gaps; L1 is now green.
    * Key changes
      - RNG derivation: switch to master-based flow
        - Use `derive_master_material(seed, manifest_fingerprint_bytes)` → `derive_substream(master, …)`.
        - Thread `manifest_fingerprint_bytes: bytes[32]` through `Context`; promote this field in the top-level `Context` type.
      - Internal vs emitted names:
        - Use `before_*` / `after_*` internally in `Decision` and sanity checks; reserve `rng_counter_*` for emitted envelope only.
        - Sanity check now compares `ev_ctx.before_*` to `decision.before_*`.
      - Trace & envelope:
        - Remove `detail` arg from `update_rng_trace_totals(...)`.
        - Ensure `ts_utc` is microsecond and counters/draws identity checks are explicit.
        - `end_event_emit` comment label normalized to `/*dataset_id*/`.
      - Substream budgeting clarity:
        - Make `u128_to_decimal_string` call explicit via `(dhi, dlo)` computed by `u128_delta(after, before)`; no change to `uniform1` signature.
      - Handoff routing:
        - Replace brittle numeric IDs with symbolic names:
          - `SingleHomePlacement` (formerly S7)
          - `NegativeBinomialS2` (formerly S2)
        - Update S1.5 prose and the `next_state` enum accordingly.
      - L0 dependencies table completed:
        - Add `derive_master_material`, `u128_to_decimal_string`, `u128_to_uint64_or_abort`.
    * Rationale
      - Restores a single source of truth for fingerprint material (bytes) per S0; avoids ad-hoc hex decoding in L1.
      - Removes naming ambiguity between internal ctx/decision fields and emitted envelope fields.
      - Keeps L1 as pure kernels; no orchestration/path resolution logic leaks in.


    