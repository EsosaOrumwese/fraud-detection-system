# Logbook
### Date: 28th October 2025
### Project: Fraud Detection System
### Reference commits: Check commits on this date (if any)

* 4:29am:
   - Pulled a high-resolution profiling trace for S1 using the new harness in scratch_files/run_s1_profile.py. Two runs on the 12-country heavy subset landed at docs/perf/segment1b_s1/s1_subset_workers12.pstats (12 workers, ~2 441 s wall clock, 57 k tiles/sec) and docs/perf/segment1b_s1/s1_subset_single.pstats (single process, ~12 137 s, 11.5 k tiles/sec). PowerShell enforced timeouts after completion, so you’ll see “command timed out” in the transcript even though both pstats files were written.
   - Inspecting the single-process trace shows _enumerate_tiles (packages/engine/src/engine/layers/l1/seg_1B/s1_tile_index/l2/runner.py:585) dominating runtime. Its hot spots are the per-tile coordinate/bounds work:
      - rasterio.transform.xy (lines 215/427) and its _transform helper account for ~7.8 ks + 3.9 ks.
      - PopulationRaster.tile_bounds (.../l0/loaders.py:122) adds another ~10 ks of cumulative time via repeated affine calls.
      - Frequent list appends plus _ParquetBatchWriter.append_row (…/runner.py:832) and flushes show the write path is also busy, with Polars frame construction (polars/_utils/construction/dataframe.py:76) taking ~90 s.
   - The multi-worker pstats mainly record time in concurrent.futures locks because the real work happens out-of-process; use the single-worker stats for function-level tuning. The scripts scratch_files/show_profile_stats.py and scratch_files/top_countries.py are in place to reproduce rankings or adjust the subset.
   - Next actions I'll take:
      1. Vectorise the centroid/bounds generation so we call transform.xy (and tile_bounds) once per chunk instead of per tile—this directly attacks the 7–10 ks hotspots.
      2. Replace the row-by-row append logic with batch writes (NumPy → Polars/Arrow) to shrink the 90 s spent constructing dataframes and the 73 s lost to repetitive min/max.
      3. Re-run the harness to confirm the same subset drops from 40 min toward the single-digit target before widening back to the full 249-country workload.