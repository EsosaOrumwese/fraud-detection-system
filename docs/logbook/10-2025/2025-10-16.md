# Logbook
### Date: 16th October 2025
### Project: Fraud Detection System
### Reference commits: Check commits on this date (if any)

* 2:55am:
   - Done with fleshing out and reviewing until green state-5 to state-9 docs. That is the state files for 1A is now complete. Time for implementation.

* 3:44am:
   - Created config/allocation/ccy_smoothing_params.yaml with the spec-compliant structure (semver, version, dp, defaults, per-currency overrides, ISO overrides). Values are conservative placeholders so the pipeline can move forward; any change will flip parameter_hash per spec.
   - Opened docs/engineering-decisions/state5_ccy_smoothing_params.md to capture the rationale, assumptions, and TODOs for this configuration so future calibrations are easy to track.

* 4:20am:
   - Added the missing iso_legal_tender_2024 artefact end‑to‑end: created its directory under reference/iso/iso_legal_tender/2024/, derived a deterministic ISO→currency mapping (max-share fallback from ccy_country_shares) into iso_legal_tender.parquet, and dropped lightweight manifest/qa companions for quick QA checks. Coverage currently matches the currencies present in the smoothing shares; I noted that limitation in docs/engineering-decisions/state5_iso_legal_tender.md so we can expand it when richer data arrives.
   - Wired the dataset into our contracts: new schema anchor contracts/schemas/l1/seg_1A/iso_legal_tender.schema.json, contracts/dataset_dictionary/l1/seg_1A/layer1.1A.yaml now lists the dataset (and states includes S5), and the public artefact registry doc records the reference entry.
   - Captured the ingestion decision in docs/engineering-decisions/state5_iso_legal_tender.md so the provenance of the mapping and its assumptions remain easy to find.
   - contracts/dataset_dictionary/l1/seg_1A/layer1.1A.yaml:5 now includes state S5 and lists ccy_country_weights_cache, merchant_currency, sparse_flag, the governed ccy_smoothing_params policy, and the new iso_legal_tender_2024 reference dataset.
   - contracts/schemas/l1/seg_1A/iso_legal_tender.schema.json provides the schema anchor for the legal-tender map.
   - docs/model_spec/data-engine/specs/contracts/1A/artefact_registry_1A.yaml:373 gained a iso_legal_tender_2024 registry entry.
   - docs/engineering-decisions/state5_iso_legal_tender.md records how the dataset was derived.
   - Built reference/iso/iso_legal_tender/2024/ with iso_legal_tender.parquet plus manifest/QA metadata for deterministic ingestion.

* 4:34am:
   - Added packages/engine/src/engine/layers/l1/seg_1A/s5_currency_weights/ with placeholder modules (__init__, loader, policy, builder, persist, validate) outlining the responsibilities pulled from the S5 spec.
   - Each file defines the core data structures and function signatures we’ll flesh out next (policy loader, share readers, smoothing algorithm, persistence, validators).
   - Added PolicyValidationError, richer dataclasses (Defaults, CurrencyOverrides, SmoothingPolicy) and strict key/structure checks per spec (packages/engine/src/engine/layers/l1/seg_1A/s5_currency_weights/policy.py).
   - Enforce semver/date formats, dp range, default domains, ISO-4217 / ISO2 code syntax, override key whitelists, and min_share_iso sum ≤ 1.0.
   - Normalised optional sections to empty mappings so later stages can consume the policy safely.
   - Expanded loader.py with ShareDataPaths defaults and concrete helpers to read the sealed share surfaces (settlement_shares, ccy_country_shares) plus the new iso_legal_tender lookup, returning strongly-typed dataclasses.
   - Added tests/engine/layers/l1/seg_1A/s5_currency_weights/test_policy.py covering the happy path plus key validation failures (unknown keys, bad semver, out-of-range defaults, min-share sum overflow) for load_policy.

* 5:02am:
   - Replaced the placeholder builder with the full §6 workflow:
     - union coverage, blend of share surfaces, effective-mass computation, Dirichlet smoothing, floor application, residual redistribution, and deterministic fixed-dp quantisation (with tie-breaks per spec).
     - Introduced ZeroMassError, QuantisationError, CurrencyResult metadata, and degrade-mode detection.
   - Added load_settlement_shares, load_ccy_country_shares, load_iso_legal_tender helpers with default paths and dataclasses.
   - Created unit tests for both policy parsing and builder scenarios (normal blend, degrade when a surface is missing, min-share floor behaviour).
   - Implemented S5 persistence and validation:
     - Builder now records rounded evidence mass (obs_count) per currency.
     - Added full parquet writer + validation receipt in persist.py (includes _passed.flag JSON).
     - Added validation helpers to enforce parameter hash, duplicates, and Σ=1 tolerance.
     - New tests covering persistence/validation along with builder/policy suites.

* 5:25am:
   - CurrencyResult now tracks probabilities, quantised weights, obs mass, blend weight, and sparsity status per currency.
   - PersistConfig gains emit_sparse_flag; write_ccy_country_weights now emits the optional sparse_flag parquet (with is_sparse, obs_count, threshold).
   - Validation receipt (S5_VALIDATION.json) captures probability sum, quantised sum, blend weight, and sparsity metadata for each currency.
   - Added validate_weights_df for downstream checks (hash, PK uniqueness, Σ=1 tolerance).
   - new test_persist_validate.py exercises parquet emission, sparse flag writing, receipt fields, and validation failures.

* 5:34am:
   - Exported the S5 package surface so downstream modules (including the CLI) can cleanly import all needed pieces.
   - Enhanced the smoothing builder to carry per-currency metadata: original probabilities, quantised sums, blend weight, and optional sparse-flag info. This metadata flows into persistence/receipts and is essential for CLI reporting and validators.
   - Extended persistence: optional sparse_flag parquet, richer S5_VALIDATION.json metrics, and the validation helper now enforce embed equality, PK uniqueness, and Σ=1 tolerances.
   - Added targeted tests for persistence + validation alongside existing builder/policy tests; suite passes.