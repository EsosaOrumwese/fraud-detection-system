# Logbook
### Date: 16th October 2025
### Project: Fraud Detection System
### Reference commits: Check commits on this date (if any)

* 2:55am:
   - Done with fleshing out and reviewing until green state-5 to state-9 docs. That is the state files for 1A is now complete. Time for implementation.

* 3:44am:
   - Created config/allocation/ccy_smoothing_params.yaml with the spec-compliant structure (semver, version, dp, defaults, per-currency overrides, ISO overrides). Values are conservative placeholders so the pipeline can move forward; any change will flip parameter_hash per spec.
   - Opened docs/engineering-decisions/state5_ccy_smoothing_params.md to capture the rationale, assumptions, and TODOs for this configuration so future calibrations are easy to track.

* 4:20am:
   - Added the missing iso_legal_tender_2024 artefact end‑to‑end: created its directory under reference/iso/iso_legal_tender/2024/, derived a deterministic ISO→currency mapping (max-share fallback from ccy_country_shares) into iso_legal_tender.parquet, and dropped lightweight manifest/qa companions for quick QA checks. Coverage currently matches the currencies present in the smoothing shares; I noted that limitation in docs/engineering-decisions/state5_iso_legal_tender.md so we can expand it when richer data arrives.
   - Wired the dataset into our contracts: new schema anchor contracts/schemas/l1/seg_1A/iso_legal_tender.schema.json, contracts/dataset_dictionary/l1/seg_1A/layer1.1A.yaml now lists the dataset (and states includes S5), and the public artefact registry doc records the reference entry.
   - Captured the ingestion decision in docs/engineering-decisions/state5_iso_legal_tender.md so the provenance of the mapping and its assumptions remain easy to find.
   - contracts/dataset_dictionary/l1/seg_1A/layer1.1A.yaml:5 now includes state S5 and lists ccy_country_weights_cache, merchant_currency, sparse_flag, the governed ccy_smoothing_params policy, and the new iso_legal_tender_2024 reference dataset.
   - contracts/schemas/l1/seg_1A/iso_legal_tender.schema.json provides the schema anchor for the legal-tender map.
   - docs/model_spec/data-engine/specs/contracts/1A/artefact_registry_1A.yaml:373 gained a iso_legal_tender_2024 registry entry.
   - docs/engineering-decisions/state5_iso_legal_tender.md records how the dataset was derived.
   - Built reference/iso/iso_legal_tender/2024/ with iso_legal_tender.parquet plus manifest/QA metadata for deterministic ingestion.

* 4:34am:
   - Added packages/engine/src/engine/layers/l1/seg_1A/s5_currency_weights/ with placeholder modules (__init__, loader, policy, builder, persist, validate) outlining the responsibilities pulled from the S5 spec.
   - Each file defines the core data structures and function signatures we’ll flesh out next (policy loader, share readers, smoothing algorithm, persistence, validators).
   - Added PolicyValidationError, richer dataclasses (Defaults, CurrencyOverrides, SmoothingPolicy) and strict key/structure checks per spec (packages/engine/src/engine/layers/l1/seg_1A/s5_currency_weights/policy.py).
   - Enforce semver/date formats, dp range, default domains, ISO-4217 / ISO2 code syntax, override key whitelists, and min_share_iso sum ≤ 1.0.
   - Normalised optional sections to empty mappings so later stages can consume the policy safely.
   - Expanded loader.py with ShareDataPaths defaults and concrete helpers to read the sealed share surfaces (settlement_shares, ccy_country_shares) plus the new iso_legal_tender lookup, returning strongly-typed dataclasses.
   - Added tests/engine/layers/l1/seg_1A/s5_currency_weights/test_policy.py covering the happy path plus key validation failures (unknown keys, bad semver, out-of-range defaults, min-share sum overflow) for load_policy.

* 5:02am:
   - Replaced the placeholder builder with the full §6 workflow:
     - union coverage, blend of share surfaces, effective-mass computation, Dirichlet smoothing, floor application, residual redistribution, and deterministic fixed-dp quantisation (with tie-breaks per spec).
     - Introduced ZeroMassError, QuantisationError, CurrencyResult metadata, and degrade-mode detection.
   - Added load_settlement_shares, load_ccy_country_shares, load_iso_legal_tender helpers with default paths and dataclasses.
   - Created unit tests for both policy parsing and builder scenarios (normal blend, degrade when a surface is missing, min-share floor behaviour).
   - Implemented S5 persistence and validation:
     - Builder now records rounded evidence mass (obs_count) per currency.
     - Added full parquet writer + validation receipt in persist.py (includes _passed.flag JSON).
     - Added validation helpers to enforce parameter hash, duplicates, and Σ=1 tolerance.
     - New tests covering persistence/validation along with builder/policy suites.

* 5:25am:
   - CurrencyResult now tracks probabilities, quantised weights, obs mass, blend weight, and sparsity status per currency.
   - PersistConfig gains emit_sparse_flag; write_ccy_country_weights now emits the optional sparse_flag parquet (with is_sparse, obs_count, threshold).
   - Validation receipt (S5_VALIDATION.json) captures probability sum, quantised sum, blend weight, and sparsity metadata for each currency.
   - Added validate_weights_df for downstream checks (hash, PK uniqueness, Σ=1 tolerance).
   - new test_persist_validate.py exercises parquet emission, sparse flag writing, receipt fields, and validation failures.

* 5:34am:
   - Exported the S5 package surface so downstream modules (including the CLI) can cleanly import all needed pieces.
   - Enhanced the smoothing builder to carry per-currency metadata: original probabilities, quantised sums, blend weight, and optional sparse-flag info. This metadata flows into persistence/receipts and is essential for CLI reporting and validators.
   - Extended persistence: optional sparse_flag parquet, richer S5_VALIDATION.json metrics, and the validation helper now enforce embed equality, PK uniqueness, and Σ=1 tolerances.
   - Added targeted tests for persistence + validation alongside existing builder/policy tests; suite passes.

* 6:11am:
   - Added dedicated deterministic context + policy metadata for S5 (packages/engine/src/engine/layers/l1/seg_1A/s5_currency_weights/contexts.py:10) and introduced an L2 runner that validates ingress surfaces, stages writes, and atomically promotes partitions via the dataset dictionary.
   - Normalised S5 persistence: canonical shard name part-00000.parquet and _passed.flag now records the SHA-256 over S5_VALIDATION.json.
   - Wired S5 into the segment orchestrator—policy artefact is resolved (or defaulted), added to the manifest extras, and the runner output is surfaced through a new S5StateContext.
   - CLI now reports S5 artefact locations and persists them in the JSON summary.
   - Extended the shared failure taxonomy with S5-specific error codes used by the new runner.

* 6:29am:
   - Added deterministic inputs dataclass and merchant-currency derivation helpers, plus optional shard writer.
   - Extended the S5 runner to resolve κₘ, stage/publish merchant_currency, and carry policy metadata + output paths.
   - Updated the Segment 1A orchestrator to feed merchant inputs and expose the new state context; CLI now logs and serialises the additional artefact.
   - Registered new error codes and ensured _passed.flag carries the SHA digest, with expanded unit coverage for merchant currency derivation/persistence.

* 6:51am:
   - Builder now captures all spec-mandated metadata (floors triggered, override counters, rounding ULPS, coverage, N0/N_eff, etc.) so per-currency records can be rendered directly.
   - Persistence builds the spec-compliant S5_VALIDATION.json, including run-level aggregates, RNG deltas, schema refs, and _passed.flag digest; helper exposed for reuse/tests.
   - Runner stages structured N0–N4 logs, snapshots RNG trace totals, builds the new receipt in staging, and atomically publishes all artefacts, logging merchant-currency derivation when present.
   - Orchestrator/CLI now surface merchant-currency context and respect the richer S5 outputs.
   - Tests updated/expanded to cover new metadata and receipt generation paths.

* 7:26am:
   - Merchant share vectors now flow end-to-end
     - Ingest: the merchant schema accepts optional settlement_currency and settlement_currency_vector, and the S0 foundation logic normalises them into deterministic {ISO4217: weight} share vectors
     - Orchestration: Segment 1A passes those vectors via MerchantCurrencyInput, so each merchant reaches S5 with either an ingress share vector or a single-currency fallback.
     - Receipt builder: S5 persistence now exports spec-compliant receipts and exposes build_receipt_payload for reuse/tests.
     - Coverage: new regression test verifies S0 captures share vectors, and the S5 suite still passes.

* 7:38am:
   - S5 runner logs all stages (N0–N4, including N2b) to a deterministic JSONL file and returns that path in the run context; the log entries include the mandated fields and we surface the path via the orchestrator/CLI.
   - Structured receipt handling enforces zero RNG deltas per spec—any interaction now raises `E_RNG_INTERACTION` before publish, and the receipt records staged metrics only after passing that guard.
   - Added targeted tests covering stage log emission, receipt content, and the RNG-failure path to protect the new behaviour (tests/engine/layers/l1/seg_1A/s5_currency_weights/test_runner.py plus supporting S0 share-vector test).

* 11:33am:
   - Contracts & Dictionary – Added the S6 policy artefact, RNG gumbel_key stream, seed/parameter-scoped validation receipt, and optional membership dataset to contracts/dataset_dictionary/l1/seg_1A/layer1.1A.yaml. Created JSON-Schema stubs for the membership table and S6 receipt, and registered the new policy schema under layer1/schemas.layer1.yaml#/policy/s6_selection.
   - Config & Documentation – Authored config/allocation/s6_selection_policy.yaml with conservative defaults and logged the rationale in docs/engineering-decisions/state6_selection_policy.md. Updated the logbook to capture the start of S6 work.
   - Module Scaffolding – Introduced packages/engine/src/engine/layers/l1/seg_1A/s6_foreign_selection/ with placeholder modules (policy, loader, builder, persist, runner, validate) ready for implementation.

* 12:27pm:
   - Integrated the full S6 foreign-selection stack and wired it into the Segment 1A pipeline with receipts and coverage.
      - Core policy+kernel: added robust policy parsing with overrides and a deterministic selection engine that enforces Gumbel scoring, caps, and reason codes
      - IO + governance: implemented disk loader with PASS gating, RNG event writer, membership/receipt persistence, and validator helpers; runner now emits gumbel events, membership, and an S6 receipt with expected metrics.
      - Orchestration & CLI: Scenario runner now resolves the S6 policy, executes the new runner, tracks artefacts in the run result, and the CLI summary exposes S6 outputs alongside earlier states
      - Tests: added focused unit/integration tests for policy parsing, selection logic, and an end-to-end runner smoke that synthesises the required artefacts.
      - Updated .pre-commit-config.yaml:48 to run the new Segment 1A S6 pytest suite instead of the outdated S0 hook (python -m pytest tests/engine/layers/l1/seg_1A/s6_foreign_selection).
      - Verified the suite in PowerShell: python -m pytest tests/engine/layers/l1/seg_1A/s6_foreign_selection now passes (5 tests).

* 1:33pm:
   - Elevated the S6 validator to the full spec surface: structural checks now confirm S5 PASS, receipt hashes, gumbel event coverage, membership reconciliation, and RNG trace counts, with key re-derivation in log_all mode.
   - Runner metrics expanded (membership_rows, trace_events, rng_isolation_ok, logging mode flag) and receipts now record the enriched telemetry; CLI + scenario context surface the additional diagnostics.
   - Added regression tests for validator workflows, zero-weight domains, and reduced-logging policy overrides; new helper fixtures collapse duplicated setup, and the pytest hook now gates the S6 suite pre-commit.

* 2:24pm:
   - Added a full S6 validation engine that enforces S5 PASS gating, receipt integrity, re-derives Philox draws for the reduced-logging mode, checks membership/event alignment, and records metrics such as membership rows, trace totals, logging mode, and RNG isolation. The gumbel event writer now emits the spec-compliant u field, and the S6 receipt schema captures the new telemetry.
   - Scenario runner and CLI now treat S6 like the earlier states: the orchestrator triggers `validate_outputs` unless `--no-validate-s6` is supplied, propagates the validation payload, and the CLI summary logs the expanded metrics. CLI tests fabricate S6 context accordingly.
   - Extended S6 regression coverage with new fixtures for zero-weight domains and reduced logging policies, plus the validator smoke.

* 4:10pm:
   - Added S7 to the dataset dictionary and registered new RNG event streams plus the integerisation policy artefact so downstream tooling understands residual and Dirichlet logs.
   - Implemented the Layer‑1 Segment‑1A S7 integer allocation package with policy loading, deterministic context building, allocation kernel, RNG writers, and validation helpers (packages/engine/src/engine/layers/l1/seg_1A/s7_integer_allocation/...).
   - Integrated S7 into the scenario orchestrator and CLI (new policy resolution, validation toggle, JSON summary, and logging) and supplied the default governed policy file.
   - Created targeted unit tests covering policy parsing, loader behaviour, and allocation logic.
