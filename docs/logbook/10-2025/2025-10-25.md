# Logbook
### Date: 25th October 2025
### Project: Fraud Detection System
### Reference commits: Check commits on this date (if any)

* 4:37am:
   - Reworked the hurdle-training helpers so the dispersion head now carries explicit merchant/channel/GDP metadata and enforces the corridor in training: packages/engine/src/engine/training/hurdle/design.py:21-133 gains the cached dispersion features, while packages/engine/src/engine/training/hurdle/fit.py:5-245 rebuilt the dispersion fit to (i) aggregate counts into MCC×channel×ln GDP bins, (ii) clip φ into [5e‑3, 5], and (iii) fall back deterministically if bins thin out.
   - Exported a fresh dispersion bundle under config/models/hurdle/exports/version=2025-10-24/20251024T234923Z/nb_dispersion_coefficients.yaml:1, leaving the sealed 2025‑10‑09 hurdle coefficients in place; the runbook now calls out both paths explicitly (docs/runbooks/segment1a_1b_execution.md:21-35).
   - Segment 1A smoke runs now execute through S2 without the earlier ERR_S2_NUMERIC_INVALID, but they fail the corridor validator: with the sealed hurdle coefficients plus the new dispersion file, the latest attempt produced parameter_hash=530943e1c3d6174db18c1b722c79866b9447787c3e4bef1247ccdfade28a9e7f, manifest_fingerprint=bb25220a187b89e000b87b9fe2ef135bf84f9870c1fe14f9a4475519d5afe374 and the validator reported rho_reject=0.2494, p99=3, cusum_max=10.72. (Using the freshly trained hurdle coefficients pushed rho even higher at 0.253.) So the numeric floor is fixed, but NB mean/dispersion still need tuning to bring rejections below the 6 % policy.

* 5:30am:
   - Derived the multi-merchant `mu`/`phi` vectors from the `runs/local_layer1_regen2` design parquet and solved for the intercept shift needed to hit the corridor target (`rho≈0.06`). This yielded a +0.749 log-mean bump (intercept ≈ 1.508) for `config/models/hurdle/exports/version=2025-10-24/20251024T234923Z/hurdle_coefficients.yaml`.
   - Re-ran Segment 1A with the 2025‑10‑24 coefficient pair (`runs/local_layer1_regen3`, `parameter_hash=4022858cfa02091ccd7ece5ea88586b5e3c2e24e6903188e56bf8083eba1d4f6`). Result: `rho_reject=0.0582`, `p99=1`, but the CUSUM gate still tripped at `Smax=15.17` (bursty single-rejection streaks despite the improved mean).
   - Tried an even larger intercept shift (+1.0 total, `runs/local_layer1_regen4`) to see if near-zero rejections would drop the CUSUM. Outcome: `rho_reject=0.0340`, `p99=1`, but `Smax` actually worsened (21.88) because rare single rejections now produce z-scores>5. Restored the intercept to the +0.749 setting and concluded that a uniform intercept tweak is insufficient; need MCC/channel-specific adjustments (or revised φ corridors) to break the rejection clusters that drive the CUSUM breach.

* 7:08am:
   - Computed MCC×channel-specific acceptance deltas from the regen2 design snapshot (solving per-segment α≈0.94), solved the resulting linear system to isolate MCC offsets plus a CP vs CNP channel delta, and wrote those shifts into `config/models/hurdle/exports/version=2025-10-24/20251024T234923Z/hurdle_coefficients.yaml` (intercept remains +0.749).
   - Segment 1A smoke (`runs/local_layer1_regen5`, `parameter_hash=8d84f5ecd38ad0c89727b81ec1c9ef74f27b916d53c609d703bdac8ebe5cf070`, `manifest_fingerprint=da910b598008f10f6fad39d43b4f49425b0a36243a9c3f5af564afe731762f70`) still failed the corridor validator: `rho_reject=0.0650`, `p99=1`, `cusum_max=20.27`. The NB mean adjustments pulled `rho` close to spec, but the admitted merchant mix changed (4 386 multis vs 4 264 previously), so the per-segment deltas drifted. Need another iteration (recompute deltas off the new deterministic context) or consider shaping φ to curb the CUSUM spikes rather than relying solely on β_μ.

* 7:57am:
   - Recomputed the MCC×channel deltas using the regen5 deterministic context and rewrote the governed `beta_mu` accordingly (still anchored at +0.749 intercept).
   - Segment 1A smoke (`runs/local_layer1_regen6`, `parameter_hash=22f2549488f011816bb664a93862a19c95dee08bedb046f8671eca5c4d03d524`, `manifest_fingerprint=decffc96e71410666cc6c24d55b4b858e796b3ac9a31509a9031b951731651b2`) finally hit `rho_reject=0.0591` with `p99=1`, but CUSUM remained above the gate (`Smax=11.49`). The remaining breach is now mainly driven by sparse MCCs at the tail, so the next iteration needs either MCC-specific φ boosts or softer α targets for those segments.
