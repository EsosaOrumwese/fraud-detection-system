# Logbook
### Date: 22nd October 2025
### Project: Fraud Detection System
### Reference commits: Check commits on this date (if any)

* 5:53pm:
   - Added the 1B gate orchestration (`packages/engine/src/engine/layers/l1/seg_1B/s0_gate/l2/runner.py` plus its L0/L1 helpers) to load index.json, recompute the ASCII-lex SHA256, enforce _passed.flag, validate reference surfaces, check outlet catalogue lineage with Polars, and publish an idempotent `s0_gate_receipt_1B`.
   - Recorded the contract surface for 1B (`contracts/dataset_dictionary/l1/seg_1B/layer1.1B.yaml`, `contracts/schemas/layer1/schemas.1B.yaml`) so dictionary resolution and schema validation mirror the spec.
   - Introduced Segment 1B shared utilities (`packages/engine/src/engine/layers/l1/seg_1B/shared/dictionary.py`, `.../shared/schema.py`) and the failure taxonomy (`.../s0_gate/exceptions.py`) to keep error codes and refs consistent with the design.
   - Exercised the gate behaviour with focused pytest coverage (`tests/engine/l1/seg_1B/test_s0_gate.py`), covering success, hash mismatches, idempotent reruns, and immutable-rewrite protection.

* 6:18pm:
   - `contracts/dataset_dictionary/l1/seg_1B/layer1.1B.yaml` now registers tile_index and its companion tile_bounds with the correct {`parameter_hash`} partitioning, sort keys, and schema refs.
   - `contracts/schemas/layer1/schemas.1B.yaml` gained reusable defs (`iso2`, `uint32`, `uint64`) plus formal table schemas for both datasets (PK `[country_iso,tile_id]`, bounded lon/lat, predicate enum, ellipsoidal area constraints).
   - Created `packages/engine/src/engine/layers/l1/seg_1B/s1_tile_index/` with L0–L3 subpackages and module docstrings, ready for the concrete implementation.
   - Noted the upcoming state in `packages/engine/src/engine/layers/l1/seg_1B/__init__.py`.

* 6:28pm:
   - Added pyproj to pyproject.toml:23 so we can compute ellipsoidal cell areas per the S1 spec.
   - `packages/engine/src/engine/layers/l1/seg_1B/s1_tile_index/l0/loaders.py` new dataclasses (`IsoCountryTable`, `CountryPolygons`, `PopulationRaster`, `TileBounds`) plus loader functions for ISO parquet, GeoParquet country shapes (with prepared geometries), and the population raster (affine transform + `Geod` for WGS84 areas). Includes deterministic tile ID, centroid, bounds, polygon, and area helpers.
   - `l1/geometry.py`: `TileMetrics` dataclass and `compute_tile_metrics` helper that derives tile ID, centroid, bounds, and ellipsoidal area from the raster metadata.
   - `l1/predicates.py`: `InclusionRule` enum (`center`, `any_overlap`) and `evaluate_inclusion` to apply predicates using prepared country geometries and tile metrics.
   - `s1_tile_index/__init__.py`: now re-exports the new loaders, geometry helpers, and predicate evaluator for higher layers.

* 6:41pm:
   - Built the full Tile Index runner (`packages/engine/src/engine/layers/l1/seg_1B/s1_tile_index/l2/runner.py`) to load the sealed references, enumerate raster cells per country, evaluate the inclusion rule, and materialise both `tile_index` and `tile_bounds` partitions atomically. It now emits the required run report, per-country summaries, and determinism hash outside the data partition.
   - The new validator (`packages/engine/src/engine/layers/l1/seg_1B/s1_tile_index/l3/validator.py`) reloads the references, re-computes cell metrics, checks schema/path law, FK, centroid/area tolerances, predicate compliance, and confirms the determinism receipt hash. Geometry helpers in l1/geometry.py and predicate checks in l1/predicates.py back the orchestrator and validator.
   - Added the shared loaders (l0/loaders.py) and summary utilities, plus wired everything through s1_tile_index/__init__.py for easy reuse.
   - Declared the pyproj dependency in pyproject.toml:23 for ellipsoidal area calculations.

* 7:08pm:
   - Added orchestration for S1: `packages/engine/src/engine/layers/l1/seg_1B/s1_tile_index/l2/runner.py#L1` now loads sealed ISO/polygon/raster inputs, enumerates eligible cells, writes `tile_index` & `tile_bounds` partitions atomically, emits run reports, per-country summaries, and a determinism hash consistent with S0’s hashing law.
   - Built the validation harness `packages/engine/src/engine/layers/l1/seg_1B/s1_tile_index/l3/validator.py#L1` to re-open the outputs, recompute geometry, enforce schema/path/PK, ISO FK, centroid/area limits, predicate compliance, and cross-check the determinism receipt.
   - Supporting primitives in `l0`/`l1`: loaders handle ISO tables, prepared country geometries, and raster-derived metrics; predicates cover `center` vs `any_overlap`. Updated `s1_tile_index/__init__.py#L1` to expose the runner, validator, metrics, and helpers.
   - Added CLI packages/engine/src/engine/cli/s1_tile_index.py#L1 plus pyproject.toml:25 entry (engine-s1-tile-index) for quick run/validate launches.
   - Brought pyproj into pyproject.toml:19 so we can compute ellipsoidal areas exactly.
   - Integration test tests/engine/l1/seg_1B/test_s1_tile_index.py#L1 exercises the full pipeline (with patched raster loader) and ensures the validator passes; ran python -m pytest tests/engine/l1/seg_1B/test_s1_tile_index.py.

* 7:23pm:
   - `packages/engine/src/engine/layers/l1/seg_1B/s1_tile_index/l2/runner.py` captures wall/CPU time via `time.perf_counter()`/`process_time()`, estimates bytes read from the sealed raster/vector artefacts, and writes those metrics into the PAT section of the run report. Added `_safe_stat_size` helper to keep things deterministic if a file is missing.
   - Validation hardened in `packages/engine/src/engine/layers/l1/seg_1B/s1_tile_index/l3/validator.py`: tile bounds are now compared against recomputed cell geometry (west/east/south/north) and the sort check is lightweight but reliable.
   - Swapped `GeoSeries.union_all()` for the deprecated `unary_union` in `l0/loaders.py`, keeping shapely happy.
   - The integration test `tests/engine/l1/seg_1B/test_s1_tile_index.py` watches for the new telemetry values (countries processed, cells included).

* 10:25pm:
   - Built a thin integration fixture for S2 in tests/engine/l1/seg_1B/test_s2_tile_weights.py:65 exercising happy-path preparation and the canonical E101_TILE_INDEX_MISSING failure, giving us a multi-country sandbox that mirrors the spec’s sample inputs.
   - Added the S2 failure taxonomy in packages/engine/src/engine/layers/l1/seg_1B/s2_tile_weights/exceptions.py:10 so every contract breach bubbles up with the spec’s codes while you iterate.
   - Wired authority alignment via RunnerConfig/GovernedParameters and the PAT counter scaffolding in packages/engine/src/engine/layers/l1/seg_1B/s2_tile_weights/l2/runner.py:28, ensuring dictionary resolution, governed basis/dp recording, and run-report hooks are ready before we add weighting logic.
   - Implemented ingress guardrails in packages/engine/src/engine/layers/l1/seg_1B/s2_tile_weights/l0/tile_index.py:36 and packages/engine/src/engine/layers/l1/seg_1B/s2_tile_weights/l1/guards.py:13, covering partition discovery, PK hygiene, ISO FK coverage, and enforcing dictionary sort order so downstream kernels inherit a clean, deterministic frame.
   - Added the S2 ingestion/mass layer: TileIndexPartition now captures byte size and enforces raster_row/raster_col availability (packages/engine/src/engine/layers/l1/seg_1B/s2_tile_weights/l0/tile_index.py:16), while the new mass engine handles uniform, area_m2, and raster-derived bases with deterministic sanity checks (l1/masses.py:23, _population_intensity at l1/masses.py:51) and feeds PAT byte counters.
   - Implemented deterministic largest-remainder quantisation with zero-mass fallback and monotonicity enforcement (l1/quantize.py:25, _enforce_monotonicity at l1/quantize.py:115), exposing results via MassComputation / QuantisationResult and updating the runner orchestration to track emitted rows and country counts (l2/runner.py:108, l2/runner.py:167).
   - Wired observability: the run-report builder assembles governed knobs, ingress versions, PAT counters, and per-country summaries (l3/observability.py:12), and the S2 test suite now covers mass computation (including population raster stubbing), quantisation behaviour/fallback, and the report payload.
   - Implemented deterministic tile weight materialisation with atomic publish, determinism receipts, run-report and summary emission (packages/engine/src/engine/layers/l1/seg_1B/s2_tile_weights/l2/runner.py:193, :265, :323), and wired PatCounters to enforce §11 PAT checks (same file :62, :105).
   - Population mass loader now records raster byte references to support PAT ratio enforcement (packages/engine/src/engine/layers/l1/seg_1B/s2_tile_weights/l1/masses.py:60).
   - Run-report builder accepts determinism receipts without introducing runtime cycles (packages/engine/src/engine/layers/l1/seg_1B/s2_tile_weights/l3/observability.py:14).
   - Added full validator covering FK/coverage, re-quantisation, zero-mass fallback, and determinism receipt checks (packages/engine/src/engine/layers/l1/seg_1B/s2_tile_weights/l3/validator.py:20).
   - Expanded the S2 test suite to cover mass/quantisation, materialisation + validator, and report generation
   - Added tile_weights to the contract surfaces so the writer and validator have authoritative metadata (contracts/dataset_dictionary/l1/seg_1B/layer1.1B.yaml:201, contracts/schemas/layer1/schemas.1B.yaml:175).
   - Extended the S2 runner with PAT-aware counters, baseline measurement, and an atomic materialisation pipeline that emits determinism receipts and evidence artefacts (packages/engine/src/engine/layers/l1/seg_1B/s2_tile_weights/l2/runner.py:63, :206, :260, :324).
   - Captured raster byte references during mass computation to support PAT ratio checks (packages/engine/src/engine/layers/l1/seg_1B/s2_tile_weights/l1/masses.py:60).
   - Refined observability and validation: run reports now record determinism receipts (packages/engine/src/engine/layers/l1/seg_1B/s2_tile_weights/l3/observability.py:14), and a new validator recomputes masses, checks FK/coverage, and enforces deterministic receipts (packages/engine/src/engine/layers/l1/seg_1B/s2_tile_weights/l3/validator.py:20).
   - Introduced a CLI entry point that drives the prepare → quantify → materialise workflow and exposes validation (packages/engine/src/engine/cli/s2_tile_weights.py:1, packages/engine/src/engine/cli/__init__.py:9).
   - Expanded the S2 test suite to cover quantisation, reporting, full materialisation + validation, and the updated runner behaviour 