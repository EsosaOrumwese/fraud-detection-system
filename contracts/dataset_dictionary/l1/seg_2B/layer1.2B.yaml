# Layer-1 · Segment 2B — Dataset Dictionary
version: "v1.0.0"

lifecycle:
  phase: alpha
  last_reviewed:
  approver: "Layer 1 Governance"

ci_policy:
  allow_placeholders: true
  placeholder_markers: [TBD, null]
  block_on_phase: [beta, stable]

layer:
  id: layer1
  name: Merchant Location Realism

datasets:
  # === 2B.S0 outputs ===
  - id: s0_gate_receipt_2B
    status: approved
    owner_subsegment: 2B
    description: Gate receipt attesting upstream verification, identity, and catalogue-only resolution.
    version: '{manifest_fingerprint}'
    format: json
    path: data/layer1/2B/s0_gate_receipt/manifest_fingerprint={manifest_fingerprint}/s0_gate_receipt_2B.json
    partitioning: [manifest_fingerprint]
    ordering: []
    schema_ref: schemas.2B.yaml#/validation/s0_gate_receipt_v1
    lineage:
      produced_by: 2B.S0
      consumed_by: [2B]
      final_in_layer: false
    retention_days: 365
    pii: false
    licence: Proprietary-Internal

  - id: sealed_inputs_2B
    status: approved
    owner_subsegment: 2B
    description: Authoritative inventory of every asset sealed by 2B.S0 for the manifest.
    version: '{manifest_fingerprint}'
    format: json
    path: data/layer1/2B/sealed_inputs/manifest_fingerprint={manifest_fingerprint}/sealed_inputs_2B.json
    partitioning: [manifest_fingerprint]
    ordering: []
    schema_ref: schemas.2B.yaml#/validation/sealed_inputs_2B
    lineage:
      produced_by: 2B.S0
      consumed_by: [2B]
      final_in_layer: false
    retention_days: 365
    pii: false
    licence: Proprietary-Internal

  # === Upstream gate (1B) ===
  - id: validation_bundle_1B
    status: approved
    owner_subsegment: 1B
    description: Fingerprint-scoped PASS bundle for Segment 1B; 2B verifies it before any read.
    version: '{manifest_fingerprint}'
    format: folder
    path: data/layer1/1B/validation/manifest_fingerprint={manifest_fingerprint}/
    partitioning: [manifest_fingerprint]
    ordering: []
    schema_ref: schemas.layer1.yaml#/validation/validation_bundle/index_schema
    lineage:
      produced_by: 1B.validation
      consumed_by: [2B]
      final_in_layer: false
    retention_days: 1095
    pii: false
    licence: Proprietary-Internal

  - id: validation_passed_flag_1B
    status: approved
    owner_subsegment: 1B
    description: Companion single-line flag carrying the SHA-256 digest of the 1B validation bundle.
    version: '{manifest_fingerprint}'
    format: text
    path: data/layer1/1B/validation/manifest_fingerprint={manifest_fingerprint}/_passed.flag
    partitioning: [manifest_fingerprint]
    ordering: []
    schema_ref: schemas.1B.yaml#/validation/passed_flag
    lineage:
      produced_by: 1B.validation
      consumed_by: [2B]
      final_in_layer: false
    retention_days: 1095
    pii: false
    licence: Proprietary-Internal

  # === Cross-segment egress consumed by 2B ===
  - id: site_locations
    status: approved
    owner_subsegment: 1B
    description: Immutable per-site lon/lat coordinates emitted by Segment 1B.
    version: '{seed}.{manifest_fingerprint}'
    format: parquet
    path: data/layer1/1B/site_locations/seed={seed}/manifest_fingerprint={manifest_fingerprint}/
    partitioning: [seed, manifest_fingerprint]
    ordering: [merchant_id, legal_country_iso, site_order]
    schema_ref: schemas.1B.yaml#/egress/site_locations
    lineage:
      produced_by: 1B.egress
      consumed_by: [2A, 2B]
      final_in_layer: true
    retention_days: 1095
    pii: false
    licence: Proprietary-Internal

  # === Required pins from 2A (read-only; required for 2B v1 local-time day-effects) ===
  - id: site_timezones
    status: approved
    owner_subsegment: 2A
    description: Per-site IANA tzid assignments emitted by 2A; REQUIRED input for 2B v1 tz-grouping + day-effects.
    version: '{seed}.{manifest_fingerprint}'
    format: parquet
    path: data/layer1/2A/site_timezones/seed={seed}/manifest_fingerprint={manifest_fingerprint}/
    partitioning: [seed, manifest_fingerprint]
    ordering: [merchant_id, legal_country_iso, site_order]
    schema_ref: schemas.2A.yaml#/egress/site_timezones
    lineage:
      produced_by: 2A
      consumed_by: [2B]
      final_in_layer: false
    retention_days: 365
    pii: false
    licence: Proprietary-Internal

  # === Optional cache from 2A (read-only; performance/consistency helper) ===
  - id: tz_timetable_cache
    status: optional
    owner_subsegment: 2A
    description: Fingerprint-scoped cache of tz transitions compiled by 2A.
    version: '{manifest_fingerprint}'
    format: folder
    path: data/layer1/2A/tz_timetable_cache/manifest_fingerprint={manifest_fingerprint}/
    partitioning: [manifest_fingerprint]
    ordering: []
    schema_ref: schemas.2A.yaml#/cache/tz_timetable_cache
    lineage:
      produced_by: 2A.S3
      consumed_by: [2B]
      final_in_layer: false
    retention_days: 365
    pii: false
    licence: Proprietary-Internal

  # === 2B policy packs (captured by S0) ===
  - id: route_rng_policy_v1
    status: approved
    owner_subsegment: 2B
    description: Philox sub-stream layout & RNG budgets for routing states.
    version: '{policy_version}'
    format: json
    path: config/layer1/2B/policy/route_rng_policy_v1.json
    partitioning: []
    ordering: []
    schema_ref: schemas.2B.yaml#/policy/route_rng_policy_v1
    lineage:
      produced_by: 2B.governance
      consumed_by: [2B]
      final_in_layer: false
    retention_days: 1825
    pii: false
    licence: Proprietary-Internal

  - id: virtual_edge_policy_v1
    status: approved
    owner_subsegment: 2B
    description: Sealed virtual-edge catalogue containing edges, weights, and attributes.
    version: '{policy_version}'
    format: json
    path: config/layer1/2B/policy/virtual_edge_policy_v1.json
    partitioning: []
    ordering: []
    schema_ref: schemas.2B.yaml#/policy/virtual_edge_policy_v1
    lineage:
      produced_by: 2B.governance
      consumed_by: [2B]
      final_in_layer: false
    retention_days: 1825
    pii: false
    licence: Proprietary-Internal

  - id: alias_layout_policy_v1
    status: approved
    owner_subsegment: 2B
    description: Alias table byte layout, alignment, and decode invariants.
    version: '{policy_version}'
    format: json
    path: config/layer1/2B/policy/alias_layout_policy_v1.json
    partitioning: []
    ordering: []
    schema_ref: schemas.2B.yaml#/policy/alias_layout_policy_v1
    lineage:
      produced_by: 2B.governance
      consumed_by: [2B]
      final_in_layer: false
    retention_days: 1825
    pii: false
    licence: Proprietary-Internal

  - id: day_effect_policy_v1
    status: approved
    owner_subsegment: 2B
    description: Daily modulation cadence, variance, and clipping configuration for S3.
    version: '{policy_version}'
    format: json
    path: config/layer1/2B/policy/day_effect_policy_v1.json
    partitioning: []
    ordering: []
    schema_ref: schemas.2B.yaml#/policy/day_effect_policy_v1
    lineage:
      produced_by: 2B.governance
      consumed_by: [2B]
      final_in_layer: false
    retention_days: 1825
    pii: false
    licence: Proprietary-Internal

  # === 2B.S1 output ===
  - id: s1_site_weights
    status: approved
    owner_subsegment: 2B
    description: Frozen per-site probability law emitted by S1 for alias construction.
    version: '{seed}.{manifest_fingerprint}'
    format: parquet
    path: data/layer1/2B/s1_site_weights/seed={seed}/manifest_fingerprint={manifest_fingerprint}/
    partitioning: [seed, manifest_fingerprint]
    ordering: [merchant_id, legal_country_iso, site_order]
    schema_ref: schemas.2B.yaml#/plan/s1_site_weights
    lineage:
      produced_by: 2B.S1
      consumed_by: [2B]
      final_in_layer: false
    retention_days: 365
    pii: false
    licence: Proprietary-Internal

  # === 2B.S2 outputs ===
  - id: s2_alias_index
    status: approved
    owner_subsegment: 2B
    description: JSON index describing alias blob slices, offsets, and digests.
    version: '{seed}.{manifest_fingerprint}'
    format: json
    path: data/layer1/2B/s2_alias_index/seed={seed}/manifest_fingerprint={manifest_fingerprint}/index.json
    partitioning: [seed, manifest_fingerprint]
    ordering: [merchant_id]
    schema_ref: schemas.2B.yaml#/plan/s2_alias_index
    lineage:
      produced_by: 2B.S2
      consumed_by: [2B]
      final_in_layer: false
    retention_days: 365
    pii: false
    licence: Proprietary-Internal

  - id: s2_alias_blob
    status: approved
    owner_subsegment: 2B
    description: Contiguous binary blob containing per-merchant alias tables.
    version: '{seed}.{manifest_fingerprint}'
    format: binary
    path: data/layer1/2B/s2_alias_blob/seed={seed}/manifest_fingerprint={manifest_fingerprint}/alias.bin
    partitioning: [seed, manifest_fingerprint]
    ordering: []
    schema_ref: schemas.2B.yaml#/binary/s2_alias_blob
    lineage:
      produced_by: 2B.S2
      consumed_by: [2B]
      final_in_layer: false
    retention_days: 365
    pii: false
    licence: Proprietary-Internal

  # === 2B.S3 output ===
  - id: s3_day_effects
    status: approved
    owner_subsegment: 2B
    description: Per-merchant × UTC-day × tz-group gamma multipliers for day-scale co-movement.
    version: '{seed}.{manifest_fingerprint}'
    format: parquet
    path: data/layer1/2B/s3_day_effects/seed={seed}/manifest_fingerprint={manifest_fingerprint}/
    partitioning: [seed, manifest_fingerprint]
    ordering: [merchant_id, utc_day, tz_group_id]
    schema_ref: schemas.2B.yaml#/plan/s3_day_effects
    lineage:
      produced_by: 2B.S3
      consumed_by: [2B]
      final_in_layer: false
    retention_days: 365
    pii: false
    licence: Proprietary-Internal

  # === 2B.S4 output ===
  - id: s4_group_weights
    status: approved
    owner_subsegment: 2B
    description: Per-merchant × UTC-day × tz-group mix used to pick tz-group prior to static alias.
    version: '{seed}.{manifest_fingerprint}'
    format: parquet
    path: data/layer1/2B/s4_group_weights/seed={seed}/manifest_fingerprint={manifest_fingerprint}/
    partitioning: [seed, manifest_fingerprint]
    ordering: [merchant_id, utc_day, tz_group_id]
    schema_ref: schemas.2B.yaml#/plan/s4_group_weights
    lineage:
      produced_by: 2B.S4
      consumed_by: [2B]
      final_in_layer: false
    retention_days: 365
    pii: false
    licence: Proprietary-Internal

  # === 2B.S5 (optional) selection log ===
  - id: s5_selection_log
    status: optional
    owner_subsegment: 2B
    description: Optional per-arrival trace for routing selections; arrival-ordered JSONL.
    version: '{seed}.{parameter_hash}.{run_id}'
    format: jsonl
    path: data/layer1/2B/s5_selection_log/seed={seed}/parameter_hash={parameter_hash}/run_id={run_id}/utc_day={utc_day}/selection_log.jsonl
    partitioning: [seed, parameter_hash, run_id, utc_day]
    ordering: [utc_timestamp]
    schema_ref: schemas.2B.yaml#/trace/s5_selection_log_row
    lineage:
      produced_by: 2B.S5
      consumed_by: [2B]
      final_in_layer: false
    retention_days: 30
    pii: false
    licence: Proprietary-Internal

  - id: s6_edge_log
    status: optional
    owner_subsegment: 2B
    description: Per-arrival virtual-edge selections captured as a diagnostic log.
    version: '{seed}.{parameter_hash}.{run_id}'
    format: jsonl
    path: logs/layer1/2B/edge/seed={seed}/parameter_hash={parameter_hash}/run_id={run_id}/utc_day={utc_day}/s6_edge_log.jsonl
    partitioning: [seed, parameter_hash, run_id, utc_day]
    ordering: [utc_timestamp]
    schema_ref: schemas.2B.yaml#/trace/s6_edge_log_row
    lineage:
      produced_by: 2B.S6
      consumed_by: [2B]
      final_in_layer: false
    retention_days: 30
    pii: false
    licence: Proprietary-Internal

  # === 2B RNG logs (run-scoped) ===
  - id: rng_audit_log
    status: approved
    owner_subsegment: 2B
    description: RNG run audit (identity/config) - one row at run start for 2B routing runs.
    version: '{run_id}'
    format: jsonl
    path: logs/layer1/2B/rng/audit/seed={seed}/parameter_hash={parameter_hash}/run_id={run_id}/rng_audit_log.jsonl
    partitioning: [seed, parameter_hash, run_id]
    ordering: []
    schema_ref: schemas.layer1.yaml#/rng/core/rng_audit_log
    lineage:
      produced_by: 2B
      consumed_by: [2B]
      final_in_layer: false
    retention_days: 365
    pii: false
    licence: Proprietary-Internal

  - id: rng_trace_log
    status: approved
    owner_subsegment: 2B
    description: RNG cumulative trace - append exactly one row after each event append for 2B routing runs.
    version: '{run_id}'
    format: jsonl
    path: logs/layer1/2B/rng/trace/seed={seed}/parameter_hash={parameter_hash}/run_id={run_id}/rng_trace_log.jsonl
    partitioning: [seed, parameter_hash, run_id]
    ordering: []
    schema_ref: schemas.layer1.yaml#/rng/core/rng_trace_log
    lineage:
      produced_by: 2B
      consumed_by: [2B]
      final_in_layer: false
    retention_days: 365
    pii: false
    licence: Proprietary-Internal

  # === 2B RNG event families (run-scoped) ===
  - id: rng_event_alias_pick_group
    status: approved
    owner_subsegment: 2B
    description: RNG events for 2B.S5 tz-group selection (single-uniform; Stage A).
    version: '{run_id}'
    format: jsonl
    path: logs/layer1/2B/rng/events/alias_pick_group/seed={seed}/parameter_hash={parameter_hash}/run_id={run_id}/part-*.jsonl
    partitioning: [seed, parameter_hash, run_id]
    ordering: []
    schema_ref: schemas.layer1.yaml#/rng/events/alias_pick_group
    lineage:
      produced_by: 2B.S5
      consumed_by: [2B]
      final_in_layer: false
    retention_days: 30
    pii: false
    licence: Proprietary-Internal

  - id: rng_event_alias_pick_site
    status: approved
    owner_subsegment: 2B
    description: RNG events for 2B.S5 site selection (single-uniform; Stage B).
    version: '{run_id}'
    format: jsonl
    path: logs/layer1/2B/rng/events/alias_pick_site/seed={seed}/parameter_hash={parameter_hash}/run_id={run_id}/part-*.jsonl
    partitioning: [seed, parameter_hash, run_id]
    ordering: []
    schema_ref: schemas.layer1.yaml#/rng/events/alias_pick_site
    lineage:
      produced_by: 2B.S5
      consumed_by: [2B]
      final_in_layer: false
    retention_days: 30
    pii: false
    licence: Proprietary-Internal

  - id: rng_event_cdn_edge_pick
    status: approved
    owner_subsegment: 2B
    description: RNG events for 2B.S6 virtual-edge pick (single-uniform).
    version: '{run_id}'
    format: jsonl
    path: logs/layer1/2B/rng/events/cdn_edge_pick/seed={seed}/parameter_hash={parameter_hash}/run_id={run_id}/part-*.jsonl
    partitioning: [seed, parameter_hash, run_id]
    ordering: []
    schema_ref: schemas.layer1.yaml#/rng/events/cdn_edge_pick
    lineage:
      produced_by: 2B.S6
      consumed_by: [2B]
      final_in_layer: false
    retention_days: 30
    pii: false
    licence: Proprietary-Internal

  # === 2B.S7 - audit report (authoritative) ===
  - id: s7_audit_report
    status: approved
    owner_subsegment: 2B
    description: Deterministic audit report emitted by S7 (validators, evidence, run metadata).
    version: '{seed}.{manifest_fingerprint}'
    format: json
    path: data/layer1/2B/s7_audit_report/seed={seed}/manifest_fingerprint={manifest_fingerprint}/s7_audit_report.json
    partitioning: [seed, manifest_fingerprint]
    ordering: []
    schema_ref: schemas.2B.yaml#/validation/s7_audit_report_v1
    lineage:
      produced_by: 2B.S7
      consumed_by: [2B]
      final_in_layer: false
    retention_days: 365
    pii: false
    licence: Proprietary-Internal

  # === 2B.S8 - Validation bundle (authoritative) ===
  - id: validation_bundle_2B
    status: approved
    owner_subsegment: 2B
    description: Directory artefact containing the 2B validation bundle contents.
    version: '{manifest_fingerprint}'
    format: folder
    path: data/layer1/2B/validation/manifest_fingerprint={manifest_fingerprint}/
    partitioning: [manifest_fingerprint]
    ordering: []
    schema_ref: schemas.2B.yaml#/validation/validation_bundle_index_2B
    lineage:
      produced_by: 2B.S8
      consumed_by: []
      final_in_layer: true
    retention_days: 1095
    pii: false
    licence: Proprietary-Internal

  - id: validation_bundle_index_2B
    status: approved
    owner_subsegment: 2B
    description: index.json enumerating evidence files plus their SHA-256 digests.
    version: '{manifest_fingerprint}'
    format: json
    path: data/layer1/2B/validation/manifest_fingerprint={manifest_fingerprint}/index.json
    partitioning: [manifest_fingerprint]
    ordering: []
    schema_ref: schemas.2B.yaml#/validation/validation_bundle_index_2B
    lineage:
      produced_by: 2B.S8
      consumed_by: []
      final_in_layer: true
    retention_days: 1095
    pii: false
    licence: Proprietary-Internal

  - id: validation_passed_flag_2B
    status: approved
    owner_subsegment: 2B
    description: Companion flag containing the SHA-256 digest of the 2B validation bundle.
    version: '{manifest_fingerprint}'
    format: text
    path: data/layer1/2B/validation/manifest_fingerprint={manifest_fingerprint}/_passed.flag
    partitioning: [manifest_fingerprint]
    ordering: []
    schema_ref: schemas.1B.yaml#/validation/passed_flag
    lineage:
      produced_by: 2B.S8
      consumed_by: []
      final_in_layer: true
    retention_days: 1095
    pii: false
    licence: Proprietary-Internal
