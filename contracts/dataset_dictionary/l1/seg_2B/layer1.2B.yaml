version: '1.0'

lifecycle:
  phase: alpha
  last_reviewed:
  approver: "Layer 1 Governance"

ci_policy:
  allow_placeholders: true
  placeholder_markers: [TBD, null]
  block_on_phase: [beta, stable]

layer:
  id: layer1
  name: Merchant Location Realism

catalogue:
  dictionary_version: "2025.11.08"
  registry_version: "2025.11.08"

# ---------------------------------------------------------------------------
# Cross-segment inputs consumed by Segment 2B
# ---------------------------------------------------------------------------
reference_data:
  - id: site_locations
    status: approved
    owner_subsegment: 1B
    description: "Per-site coordinates (order-free). Read only after verifying 1B PASS."
    version: "{seed}.{manifest_fingerprint}"
    format: parquet
    path: data/layer1/1B/site_locations/seed={seed}/fingerprint={manifest_fingerprint}/
    partitioning: [seed, fingerprint]
    ordering: [merchant_id, legal_country_iso, site_order]
    schema_ref: schemas.1B.yaml#/egress/site_locations
    lineage:
      produced_by: 1B.S8
      consumed_by: [2B]
      final_in_layer: true
    retention_days: 365
    pii: false
    license: Proprietary-Internal

  - id: merchant_mcc_map
    status: approved
    owner_subsegment: 2A
    description: "Authoritative merchantâ†’MCC ledger emitted by Segment 2A."
    version: "{seed}.{manifest_fingerprint}"
    format: parquet
    path: data/layer1/2A/merchant_mcc_map/seed={seed}/fingerprint={manifest_fingerprint}/merchant_mcc_map.parquet
    partitioning: [seed, fingerprint]
    ordering: [merchant_id]
    schema_ref: schemas.2A.yaml#/reference/merchant_mcc_map
    lineage:
      produced_by: 2A.S0
      consumed_by: [2B]
      final_in_layer: false
    retention_days: 365
    pii: false
    license: Proprietary-Internal

  - id: site_timezones
    status: optional
    owner_subsegment: 2A
    description: "Final per-site IANA tzid with provenance; optional pin for routing audits."
    version: "{seed}.{manifest_fingerprint}"
    format: parquet
    path: data/layer1/2A/site_timezones/seed={seed}/fingerprint={manifest_fingerprint}/
    partitioning: [seed, fingerprint]
    ordering: [merchant_id, legal_country_iso, site_order]
    schema_ref: schemas.2A.yaml#/egress/site_timezones
    lineage:
      produced_by: 2A.S2
      consumed_by: [2B]
      final_in_layer: true
    retention_days: 365
    pii: false
    license: Proprietary-Internal

  - id: tz_timetable_cache
    status: optional
    owner_subsegment: 2A
    description: "Fingerprint-scoped cache manifest for tz transitions."
    version: "{manifest_fingerprint}"
    format: files
    path: data/layer1/2A/tz_timetable_cache/fingerprint={manifest_fingerprint}/
    partitioning: [fingerprint]
    ordering: []
    schema_ref: schemas.2A.yaml#/cache/tz_timetable_cache
    lineage:
      produced_by: 2A.S3
      consumed_by: [2B]
      final_in_layer: false
    retention_days: 365
    pii: false
    license: Proprietary-Internal

# ---------------------------------------------------------------------------
# Policy packs sealed by 2B.S0 (token-less)
# ---------------------------------------------------------------------------
policies:
  - id: route_rng_policy_v1
    status: approved
    owner_subsegment: 2B
    description: "Philox stream/substream declarations for routing + virtual edge selection."
    version: "2025.11"
    format: json
    path: contracts/policies/l1/seg_2B/route_rng_policy_v1.json
    partitioning: []
    ordering: []
    schema_ref: schemas.2B.yaml#/policy/route_rng_policy_v1
    lineage:
      produced_by: 2B.policy
      consumed_by: [2B]
      final_in_layer: false
    retention_days: 365
    pii: false
    license: Proprietary-Internal

  - id: alias_layout_policy_v1
    status: approved
    owner_subsegment: 2B
    description: "Binary layout guidance for alias table blobs."
    version: "2025.11"
    format: json
    path: contracts/policies/l1/seg_2B/alias_layout_policy_v1.json
    partitioning: []
    ordering: []
    schema_ref: schemas.2B.yaml#/policy/alias_layout_policy_v1
    lineage:
      produced_by: 2B.policy
      consumed_by: [2B]
      final_in_layer: false
    retention_days: 365
    pii: false
    license: Proprietary-Internal

  - id: virtual_edge_policy_v1
    status: approved
    owner_subsegment: 2B
    description: "Edge catalogue + weighting rules for virtual merchants."
    version: "2025.11"
    format: json
    path: contracts/policies/l1/seg_2B/virtual_edge_policy_v1.json
    partitioning: []
    ordering: []
    schema_ref: schemas.2B.yaml#/policy/virtual_edge_policy_v1
    lineage:
      produced_by: 2B.policy
      consumed_by: [2B]
      final_in_layer: false
    retention_days: 365
    pii: false
    license: Proprietary-Internal

  - id: virtual_rules_policy_v1
    status: approved
    owner_subsegment: 2B
    description: "MCC/channel classification rules for virtual merchants."
    version: "2025.11"
    format: json
    path: contracts/policies/l1/seg_2B/virtual_rules_policy_v1.json
    partitioning: []
    ordering: []
    schema_ref: schemas.2B.yaml#/policy/virtual_rules_policy_v1
    lineage:
      produced_by: 2B.policy
      consumed_by: [2B]
      final_in_layer: false
    retention_days: 365
    pii: false
    license: Proprietary-Internal

  - id: day_effect_policy_v1
    status: approved
    owner_subsegment: 2B
    description: "Variance + RNG policy for corporate-day modulation draws."
    version: "2025.11"
    format: json
    path: contracts/policies/l1/seg_2B/day_effect_policy_v1.json
    partitioning: []
    ordering: []
    schema_ref: schemas.2B.yaml#/policy/day_effect_policy_v1
    lineage:
      produced_by: 2B.policy
      consumed_by: [2B]
      final_in_layer: false
    retention_days: 365
    pii: false
    license: Proprietary-Internal

# ---------------------------------------------------------------------------
# Gate artefacts resolved by 2B
# ---------------------------------------------------------------------------
datasets:
  - id: validation_bundle_1B
    status: approved
    owner_subsegment: 1B
    description: "Segment 1B validation bundle proving PASS for a manifest fingerprint."
    version: "{manifest_fingerprint}"
    format: files
    path: data/layer1/1B/validation/fingerprint={manifest_fingerprint}/
    partitioning: [fingerprint]
    ordering: []
    schema_ref: schemas.1B.yaml#/validation/validation_bundle_1B
    lineage:
      produced_by: 1B.S9
      consumed_by: [2B]
      final_in_layer: false
    retention_days: 1095
    pii: false
    license: Proprietary-Internal

  - id: validation_passed_flag_1B
    status: approved
    owner_subsegment: 1B
    description: "_passed.flag companion to the Segment 1B validation bundle."
    version: "{manifest_fingerprint}"
    format: text
    path: data/layer1/1B/validation/fingerprint={manifest_fingerprint}/_passed.flag
    partitioning: [fingerprint]
    ordering: []
    schema_ref: schemas.layer1.yaml#/validation/passed_flag
    lineage:
      produced_by: 1B.S9
      consumed_by: [2B]
      final_in_layer: false
    retention_days: 1095
    pii: false
    license: Proprietary-Internal

  - id: validation_bundle_2B
    status: draft
    owner_subsegment: 2B
    description: "Segment 2B validation bundle proving PASS for a manifest fingerprint (index.json)."
    version: "{manifest_fingerprint}"
    format: json
    path: data/layer1/2B/validation/fingerprint={manifest_fingerprint}/index.json
    partitioning: [fingerprint]
    ordering: []
    schema_ref: schemas.layer1.yaml#/validation/validation_bundle/index_schema
    lineage:
      produced_by: 2B.S8
      consumed_by: [2B]
      final_in_layer: false
    retention_days: 1095
    pii: false
    license: Proprietary-Internal

  - id: validation_passed_flag_2B
    status: draft
    owner_subsegment: 2B
    description: "_passed.flag companion to the Segment 2B validation bundle."
    version: "{manifest_fingerprint}"
    format: text
    path: data/layer1/2B/validation/fingerprint={manifest_fingerprint}/_passed.flag
    partitioning: [fingerprint]
    ordering: []
    schema_ref: schemas.layer1.yaml#/validation/passed_flag
    lineage:
      produced_by: 2B.S8
      consumed_by: [2B]
      final_in_layer: false
    retention_days: 1095
    pii: false
    license: Proprietary-Internal

  - id: s0_gate_receipt_2B
    status: approved
    owner_subsegment: 2B
    description: "Receipt emitted by Segment 2B S0 after verifying upstream PASS and sealing inputs."
    version: "{manifest_fingerprint}"
    format: json
    path: data/layer1/2B/s0_gate_receipt/fingerprint={manifest_fingerprint}/s0_gate_receipt.json
    partitioning: [fingerprint]
    ordering: []
    schema_ref: schemas.2B.yaml#/validation/s0_gate_receipt_v1
    lineage:
      produced_by: 2B.S0
      consumed_by: [2B]
      final_in_layer: false
    retention_days: 365
    pii: false
    license: Proprietary-Internal

  - id: sealed_inputs_v1
    status: approved
    owner_subsegment: 2B
    description: "Fingerprint-scoped inventory enumerating every asset sealed by 2B.S0."
    version: "{manifest_fingerprint}"
    format: json
    path: data/layer1/2B/sealed_inputs/fingerprint={manifest_fingerprint}/sealed_inputs_v1.json
    partitioning: [fingerprint]
    ordering: []
    schema_ref: schemas.2B.yaml#/validation/sealed_inputs_v1
    lineage:
      produced_by: 2B.S0
      consumed_by: [2B]
      final_in_layer: false
    retention_days: 365
    pii: false
    license: Proprietary-Internal

  - id: s0_run_report_2B
    status: draft
    owner_subsegment: 2B
    description: "Control-plane run report for 2B S0 gate."
    version: "{manifest_fingerprint}"
    format: json
    path: control/s0_gate/fingerprint={manifest_fingerprint}/s0_run_report.json
    partitioning: [fingerprint]
    ordering: []
    schema_ref: null
    lineage:
      produced_by: 2B.S0
      consumed_by: [2B]
      final_in_layer: false
    retention_days: 365
    pii: false
    license: Proprietary-Internal

  - id: s2_alias_index
    status: approved
    owner_subsegment: 2B
    description: "Per-merchant alias index describing offsets into the contiguous alias blob."
    version: "{seed}.{manifest_fingerprint}"
    format: json
    path: data/layer1/2B/s2_alias_index/seed={seed}/fingerprint={manifest_fingerprint}/index.json
    partitioning: [seed, fingerprint]
    ordering: []
    schema_ref: schemas.2B.yaml#/plan/s2_alias_index
    lineage:
      produced_by: 2B.S2
      consumed_by: [2B]
      final_in_layer: false
    retention_days: 365
    pii: false
    license: Proprietary-Internal

  - id: s2_alias_blob
    status: approved
    owner_subsegment: 2B
    description: "Binary blob containing all merchant alias tables in the policy-declared layout."
    version: "{seed}.{manifest_fingerprint}"
    format: binary
    path: data/layer1/2B/s2_alias_blob/seed={seed}/fingerprint={manifest_fingerprint}/alias.bin
    partitioning: [seed, fingerprint]
    ordering: []
    schema_ref: schemas.2B.yaml#/binary/s2_alias_blob
    lineage:
      produced_by: 2B.S2
      consumed_by: [2B]
      final_in_layer: false
    retention_days: 365
    pii: false
    license: Proprietary-Internal

  - id: s3_day_effects
    status: approved
    owner_subsegment: 2B
    description: "Per-merchant, per-day, per-tz-group corporate-day modulation factors."
    version: "{seed}.{manifest_fingerprint}"
    format: parquet
    path: data/layer1/2B/s3_day_effects/seed={seed}/fingerprint={manifest_fingerprint}/
    partitioning: [seed, fingerprint]
    ordering: [merchant_id, utc_day, tz_group_id]
    schema_ref: schemas.2B.yaml#/plan/s3_day_effects
    lineage:
      produced_by: 2B.S3
      consumed_by: [2B]
      final_in_layer: false
    retention_days: 365
    pii: false
    license: Proprietary-Internal

  - id: s4_group_weights
    status: approved
    owner_subsegment: 2B
    description: "Per-merchant, per-day, per-tz-group deterministic routing mix emitted by S4."
    version: "{seed}.{manifest_fingerprint}"
    format: parquet
    path: data/layer1/2B/s4_group_weights/seed={seed}/fingerprint={manifest_fingerprint}/
    partitioning: [seed, fingerprint]
    ordering: [merchant_id, utc_day, tz_group_id]
    schema_ref: schemas.2B.yaml#/plan/s4_group_weights
    lineage:
      produced_by: 2B.S4
      consumed_by: [2B]
      final_in_layer: false
    retention_days: 365
    pii: false
    license: Proprietary-Internal

  - id: s5_selection_log
    status: optional
    owner_subsegment: 2B
    description: "Per-arrival diagnostic router log (two-stage selection). Emitted only when policy enables it."
    version: "{seed}.{parameter_hash}.{run_id}"
    format: jsonl
    path: data/layer1/2B/s5_selection_log/seed={seed}/parameter_hash={parameter_hash}/run_id={run_id}/utc_day={utc_day}/selection_log.jsonl
    partitioning: [seed, parameter_hash, run_id, utc_day]
    ordering: []
    schema_ref: schemas.2B.yaml#/trace/s5_selection_log_row
    lineage:
      produced_by: 2B.S5
      consumed_by: [2B]
    final_in_layer: false
    retention_days: 90
    pii: false
    license: Proprietary-Internal

  - id: s7_audit_report
    status: approved
    owner_subsegment: 2B
    description: "Authoritative audit record emitted by Segment 2B S7."
    version: "{seed}.{manifest_fingerprint}"
    format: json
    path: data/layer1/2B/s7_audit_report/seed={seed}/fingerprint={manifest_fingerprint}/s7_audit_report.json
    partitioning: [seed, fingerprint]
    ordering: []
    schema_ref: schemas.2B.yaml#/validation/s7_audit_report_v1
    lineage:
      produced_by: 2B.S7
      consumed_by: [2B]
      final_in_layer: false
    retention_days: 365
    pii: false
    license: Proprietary-Internal

  - id: s6_edge_log
    status: optional
    owner_subsegment: 2B
    description: "Virtual-edge diagnostic log (virtual arrivals only). Writes only when dictionary entry is present."
    version: "{seed}.{parameter_hash}.{run_id}"
    format: jsonl
    path: data/layer1/2B/s6_edge_log/seed={seed}/parameter_hash={parameter_hash}/run_id={run_id}/utc_day={utc_day}/edge_log.jsonl
    partitioning: [seed, parameter_hash, run_id, utc_day]
    ordering: []
    schema_ref: schemas.2B.yaml#/trace/s6_edge_log_row
    lineage:
      produced_by: 2B.S6
      consumed_by: [2B]
      final_in_layer: false
    retention_days: 90
    pii: false
    license: Proprietary-Internal

  - id: s1_site_weights
    status: approved
    owner_subsegment: 2B
    description: "Frozen per-site probability weights per merchant."
    version: "{seed}.{manifest_fingerprint}"
    format: parquet
    path: data/layer1/2B/s1_site_weights/seed={seed}/fingerprint={manifest_fingerprint}/
    partitioning: [seed, fingerprint]
    ordering: [merchant_id, legal_country_iso, site_order]
    schema_ref: schemas.2B.yaml#/plan/s1_site_weights
    lineage:
      produced_by: 2B.S1
      consumed_by: [2B]
      final_in_layer: false
    retention_days: 365
    pii: false
    license: Proprietary-Internal

logs:
  rng_event_alias_pick_group:
    status: draft
    owner_subsegment: 2B
    description: "RNG event stream for the tz-group selection draw (Stage A)."
    version: '{run_id}'
    format: jsonl
    path: logs/rng/events/alias_pick_group/seed={seed}/parameter_hash={parameter_hash}/run_id={run_id}/
    partitioning: [seed, parameter_hash, run_id]
    ordering: []
    schema_ref: schemas.layer1.yaml#/rng/events/alias_pick_group
    lineage:
      produced_by: 2B.S5
      consumed_by: [2B]
      final_in_layer: false
    retention_days: 365
    pii: false
    license: Proprietary-Internal

  rng_event_alias_pick_site:
    status: draft
    owner_subsegment: 2B
    description: "RNG event stream for the site selection draw (Stage B)."
    version: '{run_id}'
    format: jsonl
    path: logs/rng/events/alias_pick_site/seed={seed}/parameter_hash={parameter_hash}/run_id={run_id}/
    partitioning: [seed, parameter_hash, run_id]
    ordering: []
    schema_ref: schemas.layer1.yaml#/rng/events/alias_pick_site
    lineage:
      produced_by: 2B.S5
      consumed_by: [2B]
      final_in_layer: false
    retention_days: 365
    pii: false
    license: Proprietary-Internal

  rng_event_cdn_edge_pick:
    status: draft
    owner_subsegment: 2B
    description: "RNG event stream for virtual-edge selection (virtual merchants only)."
    version: '{run_id}'
    format: jsonl
    path: logs/rng/events/cdn_edge_pick/seed={seed}/parameter_hash={parameter_hash}/run_id={run_id}/
    partitioning: [seed, parameter_hash, run_id]
    ordering: []
    schema_ref: schemas.layer1.yaml#/rng/events/cdn_edge_pick
    lineage:
      produced_by: 2B.S6
      consumed_by: [2B]
      final_in_layer: false
    retention_days: 365
    pii: false
    license: Proprietary-Internal

  rng_audit_log:
    status: draft
    owner_subsegment: 2B
    description: "Run-scoped RNG audit envelope for Segment 2B router runs."
    version: '{run_id}'
    format: jsonl
    path: logs/rng/audit/seed={seed}/parameter_hash={parameter_hash}/run_id={run_id}/rng_audit_log.jsonl
    partitioning: [seed, parameter_hash, run_id]
    ordering: []
    schema_ref: schemas.layer1.yaml#/rng/core/rng_audit_log
    lineage:
      produced_by: [2B.S5, 2B.S6]
      consumed_by: [2B]
      final_in_layer: false
    retention_days: 365
    pii: false
    license: Proprietary-Internal

  rng_trace_log:
    status: draft
    owner_subsegment: 2B
    description: "Cumulative RNG trace for Segment 2B router substreams."
    version: '{run_id}'
    format: jsonl
    path: logs/rng/trace/seed={seed}/parameter_hash={parameter_hash}/run_id={run_id}/rng_trace_log.jsonl
    partitioning: [seed, parameter_hash, run_id]
    ordering: []
    schema_ref: schemas.layer1.yaml#/rng/core/rng_trace_log
    lineage:
      produced_by: [2B.S5, 2B.S6]
      consumed_by: [2B]
      final_in_layer: false
    retention_days: 365
    pii: false
    license: Proprietary-Internal
