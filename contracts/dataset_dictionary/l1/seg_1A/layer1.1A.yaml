version: '1.0'
layer: layer1
segment: seg_1A
states: [s0, s1, s2, s3, s4, s5, s6, s7, s8, s9]

reference:
  transaction_schema_merchant_ids:
    description: Normalised merchant universe used to seed S0 ingress.
    format: parquet
    path: reference/layer1/transaction_schema_merchant_ids/2026-01-03/transaction_schema_merchant_ids.parquet
    schema_ref: schemas.ingress.layer1.yaml#/merchant_ids
    partitioning: []
    owner: reference
    retention_days: 365
  iso3166_canonical_2024:
    description: Canonical ISO-3166-1 alpha-2 reference (FK authority).
    format: parquet
    path: reference/iso/iso3166_canonical/2024-12-31/iso3166.parquet
    schema_ref: schemas.ingress.layer1.yaml#/iso3166_canonical_2024
    partitioning: []
    owner: reference
    retention_days: 365
  world_countries:
    description: Global country polygons (EPSG:4326) derived from Natural Earth with synthetic coverage for microstates.
    format: parquet
    path: reference/spatial/world_countries/2025-10-08/world_countries.parquet
    schema_ref: l1/seg_1A/world_countries.schema.json
    partitioning: []
    owner: reference
    retention_days: 365
  tz_world_2025a:
    description: IANA timezone polygons (2025a) intersected with world countries.
    format: parquet
    path: reference/spatial/tz_world/2025-10-08/tz_world_2025a.parquet
    schema_ref: l1/seg_1A/tz_world_2025a.schema.json
    partitioning: []
    owner: reference
    retention_days: 365
  population_raster_2025:
    description: Global population raster (2025) in EPSG:4326.
    format: tif
    path: reference/spatial/population_raster/2025/population_raster_2025.tif
    schema_ref: l1/seg_1A/population_raster.schema.json
    partitioning: []
    owner: reference
    retention_days: 365
  settlement_shares_2024Q4:
    description: Currency-to-country settlement shares used by S0.
    format: parquet
    path: reference/network/settlement_shares/2024Q4/settlement_shares.parquet
    schema_ref: l1/seg_1A/settlement_shares.schema.json
    partitioning: []
    owner: reference
    retention_days: 365
  ccy_country_shares_2024Q4:
    description: Currency-to-country usage shares consumed by S5/S6 smoothing.
    format: parquet
    path: reference/network/ccy_country_shares/2024Q4/ccy_country_shares.parquet
    schema_ref: l1/seg_1A/ccy_country_shares.schema.json
    partitioning: []
    owner: reference
    retention_days: 365
  iso_legal_tender_2024:
    description: Canonical ISO2 to primary legal tender mapping used when emitting merchant_currency.
    format: parquet
    path: reference/iso/iso_legal_tender/2024/iso_legal_tender.parquet
    schema_ref: l1/seg_1A/iso_legal_tender.schema.json
    partitioning: []
    owner: reference
    retention_days: 365

parameters:
  ccy_smoothing_params:
    description: Governed smoothing policy for S5 currency→country weight expansion (contributes to parameter_hash).
    format: yaml
    path: config/allocation/ccy_smoothing_params.yaml
    schema_ref: null
    partitioning: []
    owner: 1A
    retention_days: 0
  s6_selection_policy:
    description: Governed selection policy for S6 foreign-set selection (contributes to parameter_hash).
    format: yaml
    path: config/allocation/s6_selection_policy.yaml
    schema_ref: layer1/schemas.layer1.yaml#/policy/s6_selection
    partitioning: []
    owner: 1A
    retention_days: 0
  s7_integerisation_policy:
    description: Governed integer allocation policy for S7 (bounds, Dirichlet toggles; contributes to parameter_hash).
    format: yaml
    path: config/allocation/s7_integerisation_policy.yaml
    schema_ref: layer1/schemas.layer1.yaml#/policy/s7_integerisation
    partitioning: []
    owner: 1A
    retention_days: 0

model:
  crossborder_eligibility_flags:
    description: Parameter-scoped eligibility flags for cross-border expansion policy.
    format: parquet
    path: parameter_scoped/parameter_hash={parameter_hash}/crossborder_eligibility_flags.parquet
    schema_ref: l1/seg_1A/s0_outputs.schema.json#/prep/crossborder_eligibility_flags
    partitioning: [parameter_hash]
    owner: 1A
    retention_days: 180

  hurdle_design_matrix:
    description: Deterministic design vectors for hurdle/NB models.
    format: parquet
    path: data/layer1/1A/hurdle_design_matrix/parameter_hash={parameter_hash}/part-*.parquet
    schema_ref: l1/seg_1A/s0_outputs.schema.json#/model/hurdle_design_matrix
    partitioning: [parameter_hash]
    owner: 1A
    retention_days: 90

  hurdle_pi_probs:
    description: Optional per-merchant hurdle logistic outputs (diagnostics).
    format: parquet
    path: data/layer1/1A/hurdle_pi_probs/parameter_hash={parameter_hash}/part-*.parquet
    schema_ref: l1/seg_1A/s0_outputs.schema.json#/model/hurdle_pi_probs
    partitioning: [parameter_hash]
    owner: 1A
    retention_days: 30
  crossborder_features:
    description: Deterministic merchant openness features used by S4.
    format: parquet
    path: data/layer1/1A/crossborder_features/parameter_hash={parameter_hash}/part-*.parquet
    schema_ref: schemas.1A.yaml#/model/crossborder_features
    partitioning: [parameter_hash]
    owner: 1A
    retention_days: 365

allocation:
  ccy_country_weights_cache:
    description: Currency→country weights cache emitted by S5 (parameter-scoped authority for downstream selection).
    format: parquet
    path: data/layer1/1A/ccy_country_weights_cache/parameter_hash={parameter_hash}/part-*.parquet
    schema_ref: schemas.1A.yaml#/prep/ccy_country_weights_cache
    partitioning: [parameter_hash]
    owner: 1A
    retention_days: 365
  merchant_currency:
    description: Optional merchant settlement currency cache (κₘ) produced by S5.0 when inputs are present.
    format: parquet
    path: data/layer1/1A/merchant_currency/parameter_hash={parameter_hash}/part-*.parquet
    schema_ref: schemas.1A.yaml#/prep/merchant_currency
    partitioning: [parameter_hash]
    owner: 1A
    retention_days: 365
  sparse_flag:
    description: Per-currency sparsity diagnostics emitted by S5 (supports monitoring only).
    format: parquet
    path: data/layer1/1A/sparse_flag/parameter_hash={parameter_hash}/part-*.parquet
    schema_ref: schemas.1A.yaml#/prep/sparse_flag
    partitioning: [parameter_hash]
    owner: 1A
    retention_days: 365

validation:
  validation_bundle:
    description: Fingerprint-scoped validation pack emitted at the end of S0.
    format: directory
    path: data/layer1/1A/validation/fingerprint={manifest_fingerprint}/
    schema_ref: l1/seg_1A/s0_outputs.schema.json#/validation_bundle
    partitioning: [fingerprint]
    owner: 1A
    retention_days: 365
  validation_bundle_1A:
    description: Fingerprint-scoped validation pack emitted at the end of S0.
    format: directory
    path: data/layer1/1A/validation/fingerprint={manifest_fingerprint}/
    schema_ref: l1/seg_1A/s0_outputs.schema.json#/validation_bundle
    partitioning: [fingerprint]
    owner: 1A
    retention_days: 365
  validation_passed_flag_1A:
    description: HashGate PASS flag for the 1A validation bundle.
    format: text
    path: data/layer1/1A/validation/fingerprint={manifest_fingerprint}/_passed.flag
    schema_ref: schemas.layer1.yaml#/validation/passed_flag
    partitioning: [fingerprint]
    owner: 1A
    retention_days: 365
  s6_validation_receipt:
    description: Seed/parameter-scoped PASS receipt for S6 foreign-set selection (S6_VALIDATION.json + _passed.flag).
    format: directory
    path: data/layer1/1A/s6/seed={seed}/parameter_hash={parameter_hash}/
    schema_ref: l1/seg_1A/s6_validation.schema.json
    partitioning: [seed, parameter_hash]
    owner: 1A
    retention_days: 365

rng_logs:
  rng_audit_log:
    description: Run-scoped RNG audit envelope.
    format: jsonl
    path: logs/rng/audit/seed={seed}/parameter_hash={parameter_hash}/run_id={run_id}/rng_audit_log.jsonl
    schema_ref: layer1/schemas.layer1.yaml#/rng/core/rng_audit_log/record
    partitioning: [seed, parameter_hash, run_id]
    owner: 1A
    retention_days: 365

  rng_trace_log:
    description: Cumulative RNG trace by module/substream.
    format: jsonl
    path: logs/rng/trace/seed={seed}/parameter_hash={parameter_hash}/run_id={run_id}/rng_trace_log.jsonl
    schema_ref: layer1/schemas.layer1.yaml#/rng/core/rng_trace_log/record
    partitioning: [seed, parameter_hash, run_id]
    owner: 1A
    retention_days: 365

  rng_event_anchor:
    description: Anchor event emitted once per run to prove stream availability.
    format: jsonl
    path: logs/rng/events/core/seed={seed}/parameter_hash={parameter_hash}/run_id={run_id}/part-*.jsonl
    schema_ref: layer1/schemas.layer1.yaml#/rng/events/anchor
    partitioning: [seed, parameter_hash, run_id]
    owner: 1A
    retention_days: 365

  rng_event_hurdle_bernoulli:
    description: Merchant-keyed Bernoulli draws that decide single vs multi-site (S1 output).
    format: jsonl
    path: logs/rng/events/hurdle_bernoulli/seed={seed}/parameter_hash={parameter_hash}/run_id={run_id}/part-*.jsonl
    schema_ref: layer1/schemas.layer1.yaml#/rng/events/hurdle_bernoulli
    partitioning: [seed, parameter_hash, run_id]
    owner: 1A
    retention_days: 180

  rng_event_gamma_component:
    description: Gamma draws used by the NB sampler for multi-site merchants.
    format: jsonl
    path: logs/rng/events/gamma_component/seed={seed}/parameter_hash={parameter_hash}/run_id={run_id}/part-*.jsonl
    schema_ref: layer1/schemas.layer1.yaml#/rng/events/gamma_component
    partitioning: [seed, parameter_hash, run_id]
    owner: 1A
    retention_days: 180
    gating:
      gated_by: rng_event_hurdle_bernoulli
      predicate: is_multi == true

  rng_event_poisson_component:
    description: Poisson draws used in NB composition (context="nb") and S4 ZTP sampling (context="ztp").
    format: jsonl
    path: logs/rng/events/poisson_component/seed={seed}/parameter_hash={parameter_hash}/run_id={run_id}/part-*.jsonl
    schema_ref: layer1/schemas.layer1.yaml#/rng/events/poisson_component
    partitioning: [seed, parameter_hash, run_id]
    owner: 1A
    ordering: [merchant_id, attempt]
    retention_days: 180
    gating:
      gated_by: rng_event_hurdle_bernoulli
      predicate: is_multi == true

  rng_event_nb_final:
    description: Final Negative Binomial outlet counts (accepted draws).
    format: jsonl
    path: logs/rng/events/nb_final/seed={seed}/parameter_hash={parameter_hash}/run_id={run_id}/part-*.jsonl
    schema_ref: layer1/schemas.layer1.yaml#/rng/events/nb_final
    partitioning: [seed, parameter_hash, run_id]
    owner: 1A
    retention_days: 180
    gating:
      gated_by: rng_event_hurdle_bernoulli
      predicate: is_multi == true

  rng_event_ztp_rejection:
    description: Zero rejection markers emitted by the S4 ZTP sampler.
    format: jsonl
    path: logs/rng/events/ztp_rejection/seed={seed}/parameter_hash={parameter_hash}/run_id={run_id}/part-*.jsonl
    schema_ref: layer1/schemas.layer1.yaml#/rng/events/ztp_rejection
    partitioning: [seed, parameter_hash, run_id]
    owner: 1A
    retention_days: 180
    gating:
      gated_by: rng_event_hurdle_bernoulli
      predicate: is_multi == true

  rng_event_ztp_retry_exhausted:
    description: Retry exhaustion markers emitted when S4 hits the governed zero-attempt cap.
    format: jsonl
    path: logs/rng/events/ztp_retry_exhausted/seed={seed}/parameter_hash={parameter_hash}/run_id={run_id}/part-*.jsonl
    schema_ref: layer1/schemas.layer1.yaml#/rng/events/ztp_retry_exhausted
    partitioning: [seed, parameter_hash, run_id]
    owner: 1A
    retention_days: 180
    gating:
      gated_by: rng_event_hurdle_bernoulli
      predicate: is_multi == true

  rng_event_ztp_final:
    description: Non-consuming finaliser emitted by the S4 ZTP sampler (fixes K_target and regime).
    format: jsonl
    path: logs/rng/events/ztp_final/seed={seed}/parameter_hash={parameter_hash}/run_id={run_id}/part-*.jsonl
    schema_ref: layer1/schemas.layer1.yaml#/rng/events/ztp_final
    partitioning: [seed, parameter_hash, run_id]
    owner: 1A
    retention_days: 180
    gating:
      gated_by: rng_event_hurdle_bernoulli
      predicate: is_multi == true
  rng_event_gumbel_key:
    description: Gumbel-key draws emitted by S6 foreign-set selection (considered vs selected logging per policy).
    format: jsonl
    path: logs/rng/events/gumbel_key/seed={seed}/parameter_hash={parameter_hash}/run_id={run_id}/part-*.jsonl
    schema_ref: layer1/schemas.layer1.yaml#/rng/events/gumbel_key
    partitioning: [seed, parameter_hash, run_id]
    owner: 1A
    retention_days: 180
  rng_event_residual_rank:
    description: Non-consuming residual ranking records emitted by S7 integer allocation (one per domain country).
    format: jsonl
    path: logs/rng/events/residual_rank/seed={seed}/parameter_hash={parameter_hash}/run_id={run_id}/part-*.jsonl
    schema_ref: layer1/schemas.layer1.yaml#/rng/events/residual_rank
    partitioning: [seed, parameter_hash, run_id]
    owner: 1A
    retention_days: 180
  rng_event_dirichlet_gamma_vector:
    description: Optional Dirichlet gamma vector draws emitted by S7 when the feature lane is enabled.
    format: jsonl
    path: logs/rng/events/dirichlet_gamma_vector/seed={seed}/parameter_hash={parameter_hash}/run_id={run_id}/part-*.jsonl
    schema_ref: layer1/schemas.layer1.yaml#/rng/events/dirichlet_gamma_vector
    partitioning: [seed, parameter_hash, run_id]
    owner: 1A
    retention_days: 180
  'rng_event.sequence_finalize':
    description: Non-consuming sequence-finalise events emitted by S8 per (merchant, country) block.
    format: jsonl
    path: logs/rng/events/sequence_finalize/seed={seed}/parameter_hash={parameter_hash}/run_id={run_id}/part-*.jsonl
    schema_ref: layer1/schemas.layer1.yaml#/rng/events/sequence_finalize
    partitioning: [seed, parameter_hash, run_id]
    owner: 1A
    retention_days: 180
    gating:
      gated_by: rng_event_hurdle_bernoulli
      predicate: is_multi == true
  'rng_event.site_sequence_overflow':
    description: Guardrail events triggered when S8 would exceed six-digit sequence space.
    format: jsonl
    path: logs/rng/events/site_sequence_overflow/seed={seed}/parameter_hash={parameter_hash}/run_id={run_id}/part-*.jsonl
    schema_ref: layer1/schemas.layer1.yaml#/rng/events/site_sequence_overflow
    partitioning: [seed, parameter_hash, run_id]
    owner: 1A
    retention_days: 180
    gating:
      gated_by: rng_event_hurdle_bernoulli
      predicate: is_multi == true

crossborder:

  s3_candidate_set:
    description: Ordered cross-border candidate universe (home + admissible foreign countries).
    format: parquet
    path: data/layer1/1A/s3_candidate_set/parameter_hash={parameter_hash}/part-*.parquet
    schema_ref: l1/seg_1A/s3_outputs.schema.json#/candidate_set
    partitioning: [parameter_hash]
    owner: 1A
    retention_days: 365

  s3_base_weight_priors:
    description: Deterministic base-weight priors per candidate country (fixed-dp strings).
    format: parquet
    path: data/layer1/1A/s3_base_weight_priors/parameter_hash={parameter_hash}/part-*.parquet
    schema_ref: l1/seg_1A/s3_outputs.schema.json#/base_weight_priors
    partitioning: [parameter_hash]
    owner: 1A
    retention_days: 365

  s3_integerised_counts:
    description: Integer outlet allocations per candidate country (sum equals S2 N) with residual ranking.
    format: parquet
    path: data/layer1/1A/s3_integerised_counts/parameter_hash={parameter_hash}/part-*.parquet
    schema_ref: l1/seg_1A/s3_outputs.schema.json#/integerised_counts
    partitioning: [parameter_hash]
    owner: 1A
    retention_days: 365

  s3_site_sequence:
    description: Deterministic within-country site sequencing (optional; zero-padded IDs when enabled).
    format: parquet
    path: data/layer1/1A/s3_site_sequence/parameter_hash={parameter_hash}/part-*.parquet
    schema_ref: l1/seg_1A/s3_outputs.schema.json#/site_sequence
    partitioning: [parameter_hash]
    owner: 1A
    retention_days: 365

selection:

  s6_membership:
    description: Optional foreign membership pairs emitted by S6 when policy enables (re-derivable convenience surface; embeds no order).
    format: parquet
    path: data/layer1/1A/s6_membership/seed={seed}/parameter_hash={parameter_hash}/part-*.parquet
    schema_ref: l1/seg_1A/s6_membership.schema.json
    partitioning: [seed, parameter_hash]
    owner: 1A
    retention_days: 365

egress:

  outlet_catalogue:
    description: Immutable outlet catalogue emitted by S8 (within-country sequencing only).
    format: parquet
    path: data/layer1/1A/outlet_catalogue/seed={seed}/fingerprint={manifest_fingerprint}/part-*.parquet
    schema_ref: schemas.1A.yaml#/egress/outlet_catalogue
    partitioning: [seed, fingerprint]
    owner: 1A
    retention_days: 365
