version: '1.0'

lifecycle:
  phase: alpha
  last_reviewed: 2025-10-18
  approver: "Layer 1 Governance"

ci_policy:
  allow_placeholders: true
  placeholder_markers: [TBD, null]
  block_on_phase: [beta, stable]

layer:
  id: layer1
  name: Merchant Location Realism

reference_data:
  iso3166_canonical_2024:
    status: approved
    owner_subsegment: ingress
    description: Canonical ISO 3166-1 alpha-2 list for FK checks.
    version: '2024-12-31'
    format: parquet
    path: reference/iso/iso3166_canonical/2024-12-31/iso3166.parquet
    partitioning: []
    ordering: []
    schema_ref: schemas.ingress.layer1.yaml#/iso3166_canonical_2024
    lineage:
      produced_by:
      consumed_by: [1B]
      final_in_layer: false
    retention_days: 1095
    pii: false
    license: CC-BY-4.0

  world_countries:
    status: approved
    owner_subsegment: ingress
    description: Country polygons (GeoParquet) used by 1B.
    version: '2024'
    format: parquet
    path: reference/spatial/world_countries/2024/world_countries.parquet
    partitioning: []
    ordering: []
    schema_ref: schemas.ingress.layer1.yaml#/world_countries
    lineage:
      produced_by:
      consumed_by: [1B]
      final_in_layer: false
    retention_days: 1095
    pii: false
    license: ODbL-1.0

  population_raster_2025:
    status: approved
    owner_subsegment: ingress
    description: Population raster (COG) used as spatial prior in 1B.
    version: '2025'
    format: cog_geotiff
    path: reference/spatial/population/2025/population.tif
    partitioning: []
    ordering: []
    schema_ref: schemas.ingress.layer1.yaml#/population_raster_2025
    lineage:
      produced_by:
      consumed_by: [1B]
      final_in_layer: false
    retention_days: 1095
    pii: false
    license: ODbL-1.0

  tz_world_2025a:
    status: approved
    owner_subsegment: ingress
    description: Time-zone polygons used by 1B for civil-time legality checks.
    version: '2025a'
    format: parquet
    path: reference/spatial/tz_world/2025a/tz_world.parquet
    partitioning: []
    ordering: []
    schema_ref: schemas.ingress.layer1.yaml#/tz_world_2025a
    lineage:
      produced_by:
      consumed_by: [1B]
      final_in_layer: false
    retention_days: 1095
    pii: false
    license: ODbL-1.0

  validation_bundle_1A:
    status: approved
    owner_subsegment: 1A
    description: 1A validator outputs for the fingerprint (basis of consumer gate for outlet_catalogue).
    version: '{manifest_fingerprint}'
    format: directory
    path: data/layer1/1A/validation/fingerprint={manifest_fingerprint}/
    partitioning: [fingerprint]
    ordering: []
    schema_ref: schemas.1A.yaml#/validation/validation_bundle
    lineage:
      produced_by: 1A.S9
      consumed_by: [1B]
      final_in_layer: false
    retention_days: 365
    pii: false
    license: Proprietary-Internal
    notes: 'S0 computes SHA-256 over ASCII-lex index listing (flag excluded); presence of _passed.flag gates outlet_catalogue.'

  outlet_catalogue:
    status: approved
    owner_subsegment: 1A
    description: Immutable outlet stubs; order-free (join S3 for inter-country order).
    version: '{manifest_fingerprint}'
    format: parquet
    path: data/layer1/1A/outlet_catalogue/seed={seed}/fingerprint={manifest_fingerprint}/
    partitioning: [seed, fingerprint]
    ordering: [merchant_id, legal_country_iso, site_order]
    schema_ref: schemas.1A.yaml#/egress/outlet_catalogue
    lineage:
      produced_by: 1A
      consumed_by: [1B]
      final_in_layer: true
    retention_days: 365
    pii: false
    license: Proprietary-Internal
    notes: 'Read only after verifying 1A bundle flag (_passed.flag). No PASS → no read.'

  s3_candidate_set:
    status: approved
    owner_subsegment: 1A
    description: Sole inter-country order authority (join on candidate_rank; home=0).
    version: '{parameter_hash}'
    format: parquet
    path: data/layer1/1A/s3_candidate_set/parameter_hash={parameter_hash}/
    partitioning: [parameter_hash]
    ordering: []
    schema_ref: schemas.1A.yaml#/s3/candidate_set
    lineage:
      produced_by: 1A
      consumed_by: [1B]
      final_in_layer: false
    retention_days: 365
    pii: false
    license: Proprietary-Internal

datasets:
  s0_gate_receipt_1B:
    status: approved
    owner_subsegment: 1B
    description: Fingerprint-scoped receipt proving 1A PASS verification; enumerates sealed inputs for 1B.
    version: '{manifest_fingerprint}'
    format: json
    path: data/layer1/1B/s0_gate_receipt/fingerprint={manifest_fingerprint}/s0_gate_receipt.json
    partitioning: [fingerprint]
    ordering: []
    schema_ref: schemas.1B.yaml#/validation/s0_gate_receipt
    lineage:
      produced_by: 1B.S0
      consumed_by: [1B]
      final_in_layer: false
    retention_days: 365
    pii: false
    license: Proprietary-Internal

  tile_index:
    status: approved
    owner_subsegment: 1B
    description: Eligible raster cells per country after clip.
    version: '{parameter_hash}'
    format: parquet
    path: data/layer1/1B/tile_index/parameter_hash={parameter_hash}/
    partitioning: [parameter_hash]
    ordering: [country_iso, tile_id]
    schema_ref: schemas.1B.yaml#/prep/tile_index
    lineage:
      produced_by: 1B.S1
      consumed_by: [1B]
      final_in_layer: false
    retention_days: 365
    pii: false
    license: Proprietary-Internal

  tile_bounds:
    status: approved
    owner_subsegment: 1B
    description: Rectangle bounds per eligible tile (S1 companion to tile_index).
    version: '{parameter_hash}'
    format: parquet
    path: data/layer1/1B/tile_bounds/parameter_hash={parameter_hash}/
    partitioning: [parameter_hash]
    ordering: [country_iso, tile_id]
    schema_ref: schemas.1B.yaml#/prep/tile_bounds
    lineage:
      produced_by: 1B.S1
      consumed_by: [1B]
      final_in_layer: false
    retention_days: 365
    pii: false
    license: Proprietary-Internal

  tile_weights:
    status: draft
    owner_subsegment: 1B
    description: Fixed-decimal tile weights per eligible tile.
    version: '{parameter_hash}'
    format: parquet
    path: data/layer1/1B/tile_weights/parameter_hash={parameter_hash}/
    partitioning: [parameter_hash]
    ordering: [country_iso, tile_id]
    schema_ref: schemas.1B.yaml#/prep/tile_weights
    lineage:
      produced_by: 1B.S2
      consumed_by: [1B]
      final_in_layer: false
    retention_days: 365
    pii: false
    license: Proprietary-Internal

  s3_requirements:
    status: approved
    owner_subsegment: 1B
    description: Deterministic site counts per (merchant_id, legal_country_iso) for this run.
    version: '{seed}.{manifest_fingerprint}.{parameter_hash}'
    format: parquet
    path: data/layer1/1B/s3_requirements/seed={seed}/fingerprint={manifest_fingerprint}/parameter_hash={parameter_hash}/
    partitioning: [seed, fingerprint, parameter_hash]
    ordering: [merchant_id, legal_country_iso]
    schema_ref: schemas.1B.yaml#/plan/s3_requirements
    lineage:
      produced_by: 1B.S3
      consumed_by: [1B]
      final_in_layer: false
    retention_days: 365
    pii: false
    license: Proprietary-Internal

  s4_alloc_plan:
    status: approved
    owner_subsegment: 1B
    description: Per-tile integer allocations that sum to S3 n_sites (RNG-free; positives only).
    version: '{seed}.{manifest_fingerprint}.{parameter_hash}'
    format: parquet
    path: data/layer1/1B/s4_alloc_plan/seed={seed}/fingerprint={manifest_fingerprint}/parameter_hash={parameter_hash}/
    partitioning: [seed, fingerprint, parameter_hash]
    ordering: [merchant_id, legal_country_iso, tile_id]
    schema_ref: schemas.1B.yaml#/plan/s4_alloc_plan
    lineage:
      produced_by: 1B.S4
      consumed_by: [1B]
      final_in_layer: false
    retention_days: 365
    pii: false
    license: Proprietary-Internal

  s5_site_tile_assignment:
    status: draft
    owner_subsegment: 1B
    description: RNG-driven site→tile assignment; exactly one row per site.
    version: '{seed}.{manifest_fingerprint}.{parameter_hash}'
    format: parquet
    path: data/layer1/1B/s5_site_tile_assignment/seed={seed}/fingerprint={manifest_fingerprint}/parameter_hash={parameter_hash}/
    partitioning: [seed, fingerprint, parameter_hash]
    ordering: [merchant_id, legal_country_iso, site_order]
    schema_ref: schemas.1B.yaml#/plan/s5_site_tile_assignment
    lineage:
      produced_by: 1B.S5
      consumed_by: [1B]
      final_in_layer: false
    retention_days: 365
    pii: false
    license: Proprietary-Internal

  s6_site_jitter:
    status: draft
    owner_subsegment: 1B
    description: In-pixel jitter deltas per site with point-in-country enforcement.
    version: '{seed}.{manifest_fingerprint}.{parameter_hash}'
    format: parquet
    path: data/layer1/1B/s6_site_jitter/seed={seed}/fingerprint={manifest_fingerprint}/parameter_hash={parameter_hash}/
    partitioning: [seed, fingerprint, parameter_hash]
    ordering: [merchant_id, legal_country_iso, site_order]
    schema_ref: schemas.1B.yaml#/plan/s6_site_jitter
    lineage:
      produced_by: 1B.S6
      consumed_by: [1B]
      final_in_layer: false
    retention_days: 365
    pii: false
    license: Proprietary-Internal

  s7_site_synthesis:
    status: draft
    owner_subsegment: 1B
    description: Final per-site coordinates after jitter; exactly one record per site.
    version: '{seed}.{manifest_fingerprint}.{parameter_hash}'
    format: parquet
    path: data/layer1/1B/s7_site_synthesis/seed={seed}/fingerprint={manifest_fingerprint}/parameter_hash={parameter_hash}/
    partitioning: [seed, fingerprint, parameter_hash]
    ordering: [merchant_id, legal_country_iso, site_order]
    schema_ref: schemas.1B.yaml#/plan/s7_site_synthesis
    lineage:
      produced_by: 1B.S7
      consumed_by: [1B]
      final_in_layer: false
    retention_days: 365
    pii: false
    license: Proprietary-Internal

  site_locations:
    status: draft
    owner_subsegment: 1B
    description: Location egress after deduping/upcasting S7 coordinates; exactly one row per site.
    version: '{seed}.{manifest_fingerprint}'
    format: parquet
    path: data/layer1/1B/site_locations/seed={seed}/fingerprint={manifest_fingerprint}/
    partitioning: [seed, fingerprint]
    ordering: [merchant_id, legal_country_iso, site_order]
    schema_ref: schemas.1B.yaml#/egress/site_locations
    lineage:
      produced_by: 1B.S8
      consumed_by: [1B]
      final_in_layer: true
    retention_days: 365
    pii: false
    license: Proprietary-Internal

  s3_run_report:
    status: draft
    owner_subsegment: 1B
    description: Control-plane run report for S3 requirements (outside dataset partition).
    version: '{seed}.{manifest_fingerprint}.{parameter_hash}'
    format: json
    path: control/s3_requirements/seed={seed}/fingerprint={manifest_fingerprint}/parameter_hash={parameter_hash}/s3_run_report.json
    partitioning: [seed, fingerprint, parameter_hash]
    ordering: []
    schema_ref: null
    lineage:
      produced_by: 1B.S3
      consumed_by: [1B]
      final_in_layer: false
    retention_days: 30
    pii: false
    license: Proprietary-Internal

  validation_bundle_1B:
    status: draft
    owner_subsegment: 1B
    description: Segment 1B validation bundle emitted by S9.
    version: '{manifest_fingerprint}'
    format: directory
    path: data/layer1/1B/validation/fingerprint={manifest_fingerprint}/bundle/
    partitioning: [fingerprint]
    ordering: []
    schema_ref: schemas.1B.yaml#/validation/bundle
    lineage:
      produced_by: 1B.S9
      consumed_by: []
      final_in_layer: false
    retention_days: 365
    pii: false
    license: Proprietary-Internal

  validation_passed_flag_1B:
    status: draft
    owner_subsegment: 1B
    description: PASS flag for the Segment 1B validation bundle.
    version: '{manifest_fingerprint}'
    format: file
    path: data/layer1/1B/validation/fingerprint={manifest_fingerprint}/bundle/_passed.flag
    partitioning: [fingerprint]
    ordering: []
    schema_ref: schemas.1B.yaml#/validation/pass_flag
    lineage:
      produced_by: 1B.S9
      consumed_by: []
      final_in_layer: false
    retention_days: 365
    pii: false
    license: Proprietary-Internal

  s4_run_report:
    status: draft
    owner_subsegment: 1B
    description: Control-plane run report for S4 allocation plan (outside dataset partition).
    version: '{seed}.{manifest_fingerprint}.{parameter_hash}'
    format: json
    path: control/s4_alloc_plan/seed={seed}/fingerprint={manifest_fingerprint}/parameter_hash={parameter_hash}/s4_run_report.json
    partitioning: [seed, fingerprint, parameter_hash]
    ordering: []
    schema_ref: null
    lineage:
      produced_by: 1B.S4
      consumed_by: [1B]
      final_in_layer: false
    retention_days: 30
    pii: false
    license: Proprietary-Internal

  s5_run_report:
    status: draft
    owner_subsegment: 1B
    description: Control-plane run report for S5 assignment publish.
    version: '{seed}.{manifest_fingerprint}.{parameter_hash}'
    format: json
    path: control/s5_site_tile_assignment/seed={seed}/fingerprint={manifest_fingerprint}/parameter_hash={parameter_hash}/s5_run_report.json
    partitioning: [seed, fingerprint, parameter_hash]
    ordering: []
    schema_ref: schemas.1B.yaml#/control/s5_run_report
    lineage:
      produced_by: 1B.S5
      consumed_by: [1B]
      final_in_layer: false
    retention_days: 30
    pii: false
    license: Proprietary-Internal

  s6_run_report:
    status: draft
    owner_subsegment: 1B
    description: Control-plane counters for S6 jitter publish.
    version: '{seed}.{manifest_fingerprint}.{parameter_hash}'
    format: json
    path: control/s6_site_jitter/seed={seed}/fingerprint={manifest_fingerprint}/parameter_hash={parameter_hash}/s6_run_report.json
    partitioning: [seed, fingerprint, parameter_hash]
    ordering: []
    schema_ref: schemas.1B.yaml#/control/s6_run_report
    lineage:
      produced_by: 1B.S6
      consumed_by: [1B]
      final_in_layer: false
    retention_days: 30
    pii: false
    license: Proprietary-Internal

  s7_run_summary:
    status: draft
    owner_subsegment: 1B
    description: Control-plane run summary for S7 site synthesis publish.
    version: '{seed}.{manifest_fingerprint}.{parameter_hash}'
    format: json
    path: data/layer1/1B/s7_site_synthesis/seed={seed}/fingerprint={manifest_fingerprint}/parameter_hash={parameter_hash}/s7_run_summary.json
    partitioning: [seed, fingerprint, parameter_hash]
    ordering: []
    schema_ref: schemas.1B.yaml#/control/s7_run_summary
    lineage:
      produced_by: 1B.S7
      consumed_by: [1B]
      final_in_layer: false
    retention_days: 30
    pii: false
    license: Proprietary-Internal

  s8_run_summary:
    status: draft
    owner_subsegment: 1B
    description: Control-plane run summary for S8 site_locations publish.
    version: '{seed}.{manifest_fingerprint}'
    format: json
    path: data/layer1/1B/site_locations/seed={seed}/fingerprint={manifest_fingerprint}/s8_run_summary.json
    partitioning: [seed, fingerprint]
    ordering: []
    schema_ref: schemas.1B.yaml#/control/s8_run_summary
    lineage:
      produced_by: 1B.S8
      consumed_by: [1B]
      final_in_layer: false
    retention_days: 30
    pii: false
    license: Proprietary-Internal

logs:
  rng_event_site_tile_assign:
    status: draft
    owner_subsegment: 1B
    description: RNG events for S5 site→tile assignment (one event per site).
    version: '{run_id}'
    format: jsonl
    path: logs/rng/events/site_tile_assign/seed={seed}/parameter_hash={parameter_hash}/run_id={run_id}/
    partitioning: [seed, parameter_hash, run_id]
    ordering: []
    schema_ref: schemas.layer1.yaml#/rng/events/site_tile_assign
    lineage:
      produced_by: 1B.S5
      consumed_by: [1B]
      final_in_layer: false
    retention_days: 30
    pii: false
    license: Proprietary-Internal

  rng_event_in_cell_jitter:
    status: draft
    owner_subsegment: 1B
    description: RNG events for S6 in-pixel jitter (one event per attempt).
    version: '{run_id}'
    format: jsonl
    path: logs/rng/events/in_cell_jitter/seed={seed}/parameter_hash={parameter_hash}/run_id={run_id}/
    partitioning: [seed, parameter_hash, run_id]
    ordering: []
    schema_ref: schemas.layer1.yaml#/rng/events/in_cell_jitter
    lineage:
      produced_by: 1B.S6
      consumed_by: [1B]
      final_in_layer: false
    retention_days: 30
    pii: false
    license: Proprietary-Internal

  rng_audit_log:
    status: draft
    owner_subsegment: 1B
    description: Run-scoped RNG audit envelope for Segment 1B publishes.
    version: '{run_id}'
    format: jsonl
    path: logs/rng/audit/seed={seed}/parameter_hash={parameter_hash}/run_id={run_id}/rng_audit_log.jsonl
    partitioning: [seed, parameter_hash, run_id]
    ordering: []
    schema_ref: schemas.layer1.yaml#/rng/core/rng_audit_log
    lineage:
      produced_by: 1B.S6
      consumed_by: [1B]
      final_in_layer: false
    retention_days: 365
    pii: false
    license: Proprietary-Internal

  rng_trace_log:
    status: draft
    owner_subsegment: 1B
    description: Cumulative RNG trace (per event append) for Segment 1B substreams.
    version: '{run_id}'
    format: jsonl
    path: logs/rng/trace/seed={seed}/parameter_hash={parameter_hash}/run_id={run_id}/rng_trace_log.jsonl
    partitioning: [seed, parameter_hash, run_id]
    ordering: []
    schema_ref: schemas.layer1.yaml#/rng/core/rng_trace_log
    lineage:
      produced_by: 1B.S6
      consumed_by: [1B]
      final_in_layer: false
    retention_days: 365
    pii: false
    license: Proprietary-Internal
