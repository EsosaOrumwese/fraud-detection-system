version: '1.0'
$id: schemas.3A.yaml
$schema: https://json-schema.org/draft/2020-12/schema
description: "Layer-1 · Segment 3A (Cross-Zone Merchants) — schema pack."

$defs:
  hex64:
    $ref: 'schemas.layer1.yaml#/$defs/hex64'
  uint64:
    $ref: 'schemas.layer1.yaml#/$defs/uint64'
  iso2:
    $ref: 'schemas.layer1.yaml#/$defs/iso2'
  rfc3339_micros:
    $ref: 'schemas.layer1.yaml#/$defs/rfc3339_micros'
  iana_tzid:
    $ref: 'schemas.layer1.yaml#/$defs/iana_tzid'
  id64:
    $ref: 'schemas.layer1.yaml#/$defs/id64'

validation:
  s0_gate_receipt_3A:
    type: object
    additionalProperties: false
    required:
      - version
      - manifest_fingerprint
      - parameter_hash
      - seed
      - verified_at_utc
      - upstream_gates
      - catalogue_versions
      - sealed_policy_set
    properties:
      version: { type: string }
      manifest_fingerprint: { $ref: '#/$defs/hex64' }
      parameter_hash: { $ref: '#/$defs/hex64' }
      seed: { $ref: '#/$defs/uint64' }
      verified_at_utc: { $ref: '#/$defs/rfc3339_micros' }
      upstream_gates:
        type: object
        additionalProperties: false
        required: [segment_1A, segment_1B, segment_2A]
        properties:
          segment_1A: &gate_status
            type: object
            additionalProperties: false
            required: [bundle_id, bundle_path, flag_path, sha256_hex, status]
            properties:
              bundle_id:  { type: string }
              bundle_path:{ type: string }
              flag_path:  { type: string }
              sha256_hex: { $ref: '#/$defs/hex64' }
              status:     { type: string, enum: [PASS] }
          segment_1B: *gate_status
          segment_2A: *gate_status
      catalogue_versions:
        type: object
        additionalProperties: true
      sealed_policy_set:
        type: array
        items:
          type: object
          additionalProperties: false
          required: [logical_id, owner_segment, role, sha256_hex, schema_ref]
          properties:
            logical_id:    { type: string }
            owner_segment: { type: string, enum: [1A, 1B, 2A, 2B, 3A, ingress] }
            role:          { type: string }
            sha256_hex:    { $ref: '#/$defs/hex64' }
            schema_ref:    { type: string }
            path:          { type: string }
            notes:         { type: string }

  sealed_inputs_3A:
    type: object
    additionalProperties: false
    required:
      - manifest_fingerprint
      - owner_segment
      - artefact_kind
      - logical_id
      - path
      - schema_ref
      - sha256_hex
      - role
    properties:
      manifest_fingerprint: { $ref: '#/$defs/hex64' }
      owner_segment: { type: string }
      artefact_kind: { type: string }
      logical_id:    { type: string }
      path:          { type: string }
      schema_ref:    { type: string }
      sha256_hex:    { $ref: '#/$defs/hex64' }
      role:          { type: string }
      license_class: { type: string }
      experiment_tag:{ type: string }
      notes:         { type: string }

  zone_alloc_universe_hash:
    type: object
    additionalProperties: false
    required:
      - manifest_fingerprint
      - parameter_hash
      - zone_alpha_digest
      - theta_digest
      - zone_floor_digest
      - day_effect_digest
      - zone_alloc_parquet_digest
      - routing_universe_hash
    properties:
      manifest_fingerprint:    { $ref: '#/$defs/hex64' }
      parameter_hash:          { $ref: '#/$defs/hex64' }
      zone_alpha_digest:       { $ref: '#/$defs/hex64' }
      theta_digest:            { $ref: '#/$defs/hex64' }
      zone_floor_digest:       { $ref: '#/$defs/hex64' }
      day_effect_digest:       { $ref: '#/$defs/hex64' }
      zone_alloc_parquet_digest: { $ref: '#/$defs/hex64' }
      routing_universe_hash:   { $ref: '#/$defs/hex64' }
      version:                 { type: string }
      created_at_utc:          { $ref: '#/$defs/rfc3339_micros' }
      notes:                   { type: string }

  s6_validation_report_3A:
    type: object
    additionalProperties: false
    required:
      - manifest_fingerprint
      - parameter_hash
      - overall_status
      - checks_passed_count
      - checks_failed_count
      - checks_warn_count
      - checks
    properties:
      manifest_fingerprint: { $ref: '#/$defs/hex64' }
      parameter_hash:       { $ref: '#/$defs/hex64' }
      overall_status:       { type: string, enum: [PASS, FAIL] }
      checks_passed_count:  { type: integer, minimum: 0 }
      checks_failed_count:  { type: integer, minimum: 0 }
      checks_warn_count:    { type: integer, minimum: 0 }
      checks:
        type: array
        items:
          type: object
          additionalProperties: false
          required: [check_id, status, severity, affected_count]
          properties:
            check_id:       { type: string }
            status:         { type: string, enum: [PASS, WARN, FAIL] }
            severity:       { type: string, enum: [INFO, WARN, ERROR] }
            affected_count: { type: integer, minimum: 0 }
            notes:          { type: string }
      metrics:
        type: object
        additionalProperties: true

  s6_issue_table_3A:
    type: object
    additionalProperties: false
    required:
      - manifest_fingerprint
      - issue_code
      - check_id
      - severity
      - message
    properties:
      manifest_fingerprint: { $ref: '#/$defs/hex64' }
      issue_code:           { type: string }
      check_id:             { type: string }
      severity:             { type: string, enum: [INFO, WARN, ERROR] }
      message:              { type: string }
      merchant_id:          { $ref: '#/$defs/id64' }
      legal_country_iso:    { $ref: '#/$defs/iso2' }
      tzid:                 { $ref: '#/$defs/iana_tzid' }
      details:              { type: string }

  s6_receipt_3A:
    type: object
    additionalProperties: false
    required:
      - manifest_fingerprint
      - parameter_hash
      - s6_version
      - overall_status
      - checks_passed_count
      - checks_failed_count
      - checks_warn_count
      - check_status_map
      - validation_report_digest
    properties:
      manifest_fingerprint:      { $ref: '#/$defs/hex64' }
      parameter_hash:            { $ref: '#/$defs/hex64' }
      s6_version:                { type: string }
      overall_status:            { type: string, enum: [PASS, FAIL] }
      checks_passed_count:       { type: integer, minimum: 0 }
      checks_failed_count:       { type: integer, minimum: 0 }
      checks_warn_count:         { type: integer, minimum: 0 }
      check_status_map:
        type: object
        additionalProperties:
          type: object
          additionalProperties: false
          required: [status]
          properties:
            status:   { type: string, enum: [PASS, WARN, FAIL] }
            severity: { type: string, enum: [INFO, WARN, ERROR] }
      validation_report_digest: { $ref: '#/$defs/hex64' }
      issue_table_digest:       { $ref: '#/$defs/hex64' }
      created_at_utc:           { $ref: '#/$defs/rfc3339_micros' }
      notes:                    { type: string }

plan:
  s1_escalation_queue:
    type: table
    description: "Per-merchant escalation decisions prior to zone sampling."
    primary_key: [merchant_id, legal_country_iso]
    partition_keys: [seed, manifest_fingerprint]
    sort_keys: [merchant_id, legal_country_iso]
    columns_strict: true
    columns:
      - { name: seed,                $ref: '#/$defs/uint64',          nullable: false }
      - { name: manifest_fingerprint,         $ref: '#/$defs/hex64',           nullable: false }
      - { name: merchant_id,         $ref: '#/$defs/id64',            nullable: false }
      - { name: legal_country_iso,   $ref: '#/$defs/iso2',            nullable: false }
      - { name: site_count,          type: integer, minimum: 1,       nullable: false }
      - { name: zone_count_country,  type: integer, minimum: 0,       nullable: false }
      - { name: is_escalated,        type: boolean,                   nullable: false }
      - { name: decision_reason,     type: string,                    nullable: false }
      - { name: mixture_policy_id,   type: string,                    nullable: false }
      - { name: mixture_policy_version, type: string,                 nullable: false }
      - { name: theta_digest,        $ref: '#/$defs/hex64',           nullable: true }
      - { name: eligible_for_escalation, type: boolean,               nullable: true }
      - { name: dominant_zone_share_bucket, type: string,             nullable: true }
      - { name: notes,               type: string,                    nullable: true }

  s2_country_zone_priors:
    type: table
    description: "Parameter-scoped Dirichlet priors per country and tzid."
    primary_key: [country_iso, tzid]
    partition_keys: [parameter_hash]
    sort_keys: [country_iso, tzid]
    columns_strict: true
    columns:
      - { name: parameter_hash,      $ref: '#/$defs/hex64',           nullable: false }
      - { name: country_iso,         $ref: '#/$defs/iso2',            nullable: false }
      - { name: tzid,                $ref: '#/$defs/iana_tzid',       nullable: false }
      - { name: alpha_raw,           type: number, minimum: 0.0,      nullable: false }
      - { name: alpha_effective,     type: number, exclusiveMinimum: 0.0, nullable: false }
      - { name: alpha_sum_country,   type: number, exclusiveMinimum: 0.0, nullable: false }
      - { name: prior_pack_id,       type: string,                    nullable: false }
      - { name: prior_pack_version,  type: string,                    nullable: false }
      - { name: floor_policy_id,     type: string,                    nullable: false }
      - { name: floor_policy_version,type: string,                    nullable: false }
      - { name: floor_applied,       type: boolean,                   nullable: false }
      - { name: bump_applied,        type: boolean,                   nullable: false }
      - { name: share_effective,     type: number, minimum: 0.0, maximum: 1.0, nullable: false }
      - { name: notes,               type: string,                    nullable: true }

  s3_zone_shares:
    type: table
    description: "Dirichlet share draws per merchant×country×zone."
    primary_key: [merchant_id, legal_country_iso, tzid]
    partition_keys: [seed, manifest_fingerprint]
    sort_keys: [merchant_id, legal_country_iso, tzid]
    columns_strict: true
    columns:
      - { name: seed,                $ref: '#/$defs/uint64',          nullable: false }
      - { name: manifest_fingerprint,         $ref: '#/$defs/hex64',           nullable: false }
      - { name: merchant_id,         $ref: '#/$defs/id64',            nullable: false }
      - { name: legal_country_iso,   $ref: '#/$defs/iso2',            nullable: false }
      - { name: tzid,                $ref: '#/$defs/iana_tzid',       nullable: false }
      - { name: share_drawn,         type: number, minimum: 0.0, maximum: 1.0, nullable: false }
      - { name: share_sum_country,   type: number, exclusiveMinimum: 0.0, nullable: false }
      - { name: alpha_sum_country,   type: number, exclusiveMinimum: 0.0, nullable: false }
      - { name: prior_pack_id,       type: string,                    nullable: false }
      - { name: prior_pack_version,  type: string,                    nullable: false }
      - { name: floor_policy_id,     type: string,                    nullable: false }
      - { name: floor_policy_version,type: string,                    nullable: false }
      - { name: rng_module,          type: string,                    nullable: false }
      - { name: rng_substream_label, type: string,                    nullable: false }
      - { name: rng_stream_id,       type: string,                    nullable: false }
      - { name: rng_event_id,        type: string,                    nullable: true }
      - { name: notes,               type: string,                    nullable: true }

  s4_zone_counts:
    type: table
    description: "Integer outlet counts per merchant×country×zone after floors/bump."
    primary_key: [merchant_id, legal_country_iso, tzid]
    partition_keys: [seed, manifest_fingerprint]
    sort_keys: [merchant_id, legal_country_iso, tzid]
    columns_strict: true
    columns:
      - { name: seed,                $ref: '#/$defs/uint64',          nullable: false }
      - { name: manifest_fingerprint,         $ref: '#/$defs/hex64',           nullable: false }
      - { name: merchant_id,         $ref: '#/$defs/id64',            nullable: false }
      - { name: legal_country_iso,   $ref: '#/$defs/iso2',            nullable: false }
      - { name: tzid,                $ref: '#/$defs/iana_tzid',       nullable: false }
      - { name: zone_site_count,     type: integer, minimum: 0,       nullable: false }
      - { name: zone_site_count_sum, type: integer, minimum: 0,       nullable: false }
      - { name: share_sum_country,   type: number, exclusiveMinimum: 0.0, nullable: false }
      - { name: fractional_target,   type: number,                    nullable: true }
      - { name: residual_rank,       type: integer, minimum: 1,       nullable: true }
      - { name: prior_pack_id,       type: string,                    nullable: false }
      - { name: prior_pack_version,  type: string,                    nullable: false }
      - { name: floor_policy_id,     type: string,                    nullable: false }
      - { name: floor_policy_version,type: string,                    nullable: false }
      - { name: alpha_sum_country,   type: number, exclusiveMinimum: 0.0, nullable: true }
      - { name: notes,               type: string,                    nullable: true }

egress:
  zone_alloc:
    type: table
    description: "Cross-layer zone allocation egress per merchant×country×zone."
    primary_key: [merchant_id, legal_country_iso, tzid]
    partition_keys: [seed, manifest_fingerprint]
    sort_keys: [merchant_id, legal_country_iso, tzid]
    columns_strict: true
    columns:
      - { name: seed,                $ref: '#/$defs/uint64',          nullable: false }
      - { name: manifest_fingerprint,         $ref: '#/$defs/hex64',           nullable: false }
      - { name: merchant_id,         $ref: '#/$defs/id64',            nullable: false }
      - { name: legal_country_iso,   $ref: '#/$defs/iso2',            nullable: false }
      - { name: tzid,                $ref: '#/$defs/iana_tzid',       nullable: false }
      - { name: zone_site_count,     type: integer, minimum: 0,       nullable: false }
      - { name: zone_site_count_sum, type: integer, minimum: 0,       nullable: false }
      - { name: site_count,          type: integer, minimum: 1,       nullable: false }
      - { name: prior_pack_id,       type: string,                    nullable: false }
      - { name: prior_pack_version,  type: string,                    nullable: false }
      - { name: floor_policy_id,     type: string,                    nullable: false }
      - { name: floor_policy_version,type: string,                    nullable: false }
      - { name: mixture_policy_id,   type: string,                    nullable: false }
      - { name: mixture_policy_version, type: string,                 nullable: false }
      - { name: day_effect_policy_id,    type: string,                nullable: false }
      - { name: day_effect_policy_version,type: string,               nullable: false }
      - { name: routing_universe_hash,   $ref: '#/$defs/hex64',       nullable: false }
      - { name: alpha_sum_country,   type: number, exclusiveMinimum: 0.0, nullable: true }
      - { name: notes,               type: string,                    nullable: true }

policy:
    zone_mixture_policy_v1:
      type: object
      additionalProperties: false
      required: [policy_id, version, theta_mix, rules]
      properties:
        policy_id: { const: zone_mixture_policy_3A }
        version:   { type: string, minLength: 1 }
        theta_mix: { type: number, minimum: 0.0, maximum: 1.0 }
        rules:
          type: array
          minItems: 1
          items:
            type: object
            additionalProperties: false
            required: [metric, threshold, decision_reason]
            properties:
              metric:
                type: string
                enum: [site_count_lt, zone_count_country_le, site_count_ge, zone_count_country_ge]
              threshold:       { type: number }
              decision_reason:
                type: string
                enum: [forced_monolithic, below_min_sites, legacy_default, forced_escalation, default_escalation]
              bucket:          { type: string }

  country_zone_alphas_v1:
    type: object
    additionalProperties: false
    required: [version, countries]
    properties:
      version:   { type: string }
      countries:
        type: object
        additionalProperties:
          type: object
          additionalProperties: false
          required: [tzid_alphas]
          properties:
            tzid_alphas:
              type: array
              minItems: 1
              items:
                    type: object
                    additionalProperties: false
                    required: [tzid, alpha]
                    properties:
                      tzid:  { $ref: '#/$defs/iana_tzid' }
                      alpha: { type: number, exclusiveMinimum: 0.0 }
            notes: { type: string }

  zone_floor_policy_v1:
    type: object
    additionalProperties: false
    required: [version, floors]
    properties:
      version: { type: string }
      floors:
        type: array
        items:
          type: object
          additionalProperties: false
          required: [tzid, floor_value, bump_threshold]
          properties:
            tzid:           { $ref: '#/$defs/iana_tzid' }
            floor_value:    { type: number, minimum: 0.0 }
            bump_threshold: { type: number, minimum: 0.0, maximum: 1.0 }
            notes:          { type: string }
