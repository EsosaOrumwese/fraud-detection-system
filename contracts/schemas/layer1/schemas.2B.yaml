version: '1.0'
$id: schemas.2B.yaml
$schema: https://json-schema.org/draft/2020-12/schema
description: "Layer-1 Segment 2B schema pack. JSON-Schema is the sole shape authority."

# -- Validation artefacts ---------------------------------------------------
validation:

  s0_gate_receipt_v1:
    type: object
    additionalProperties: false
    required:
      [
        segment,
        state,
        manifest_fingerprint,
        seed,
        parameter_hash,
        verified_at_utc,
        validation_bundle_path,
        flag_sha256_hex,
        sealed_inputs,
        catalogue_resolution,
        determinism_receipt,
      ]
    properties:
      segment:
        type: string
        const: "2B"
      state:
        type: string
        const: "S0"
      manifest_fingerprint:
        $ref: 'schemas.layer1.yaml#/$defs/hex64'
      seed:
        type: string
        minLength: 1
      parameter_hash:
        $ref: 'schemas.layer1.yaml#/$defs/hex64'
      verified_at_utc:
        $ref: 'schemas.layer1.yaml#/$defs/rfc3339_micros'
      validation_bundle_path:
        type: string
        minLength: 1
      flag_sha256_hex:
        $ref: 'schemas.layer1.yaml#/$defs/hex64'
      notes:
        type: string
      sealed_inputs:
        type: array
        minItems: 1
        items:
          type: object
          additionalProperties: false
          required: [id, partition, schema_ref]
          properties:
            id: { type: string, minLength: 1 }
            partition:
              type: array
              items: { type: string }
            schema_ref: { type: string, minLength: 1 }
      catalogue_resolution:
        type: object
        additionalProperties: false
        required: [dictionary_version, registry_version]
        properties:
          dictionary_version: { type: string, minLength: 1 }
          registry_version: { type: string, minLength: 1 }
      determinism_receipt:
        type: object
        additionalProperties: false
        properties:
          engine_commit: { type: string }
          python_version: { type: string }
          platform: { type: string }
          policy_ids:
            type: array
            items: { type: string }
          policy_digests:
            type: array
            items: { $ref: 'schemas.layer1.yaml#/$defs/hex64' }

  sealed_inputs_v1:
    type: array
    minItems: 1
    items:
      type: object
      additionalProperties: false
      required: [asset_id, version_tag, sha256_hex, path, partition]
      properties:
        asset_id: { type: string, minLength: 1 }
        version_tag: { type: string, minLength: 1 }
        sha256_hex: { $ref: 'schemas.layer1.yaml#/$defs/hex64' }
        path: { type: string, minLength: 1 }
        partition:
          type: array
          items: { type: string }
        schema_ref: { type: string }

# -- Policy packs -----------------------------------------------------------
policy:

  route_rng_policy_v1:
    type: object
    additionalProperties: false
    required: [version_tag, algorithm, substreams]
    properties:
      version_tag: { type: string, minLength: 1 }
      algorithm: { type: string, minLength: 1 }
      substreams:
        type: array
        minItems: 1
        items:
          type: object
          additionalProperties: false
          required: [id, label, max_uniforms]
          properties:
            id: { type: string, minLength: 1 }
            label: { type: string, minLength: 1 }
            max_uniforms:
              type: integer
              minimum: 1
      notes: { type: string }

  alias_layout_policy_v1:
    type: object
    additionalProperties: false
    required:
      [
        version_tag,
        weight_source,
        floor_spec,
        normalisation_epsilon,
        quantised_bits,
        quantisation_epsilon,
        layout_version,
        endianness,
        alignment_bytes,
        encode_spec,
        decode_law,
      ]
    properties:
      version_tag: { type: string, minLength: 1 }
      weight_source:
        type: object
        additionalProperties: false
        required: [id, mode]
        properties:
          id: { type: string, minLength: 1 }
          mode: { type: string, enum: [uniform, column] }
          column: { type: string }
      floor_spec:
        type: object
        additionalProperties: false
        required: [mode, fallback]
        properties:
          mode: { type: string, enum: [absolute, relative, none] }
          value: { type: number }
          fallback: { type: string, enum: [uniform] }
      cap_spec:
        type: object
        additionalProperties: false
        properties:
          mode: { type: string, enum: [none, absolute, relative] }
          value: { type: number }
      normalisation_epsilon:
        type: number
        exclusiveMinimum: 0
      quantised_bits:
        type: integer
        minimum: 1
      quantisation_epsilon:
        type: number
        exclusiveMinimum: 0
      tiny_negative_epsilon:
        type: number
        exclusiveMinimum: 0
      layout_version:
        type: string
        minLength: 1
      endianness:
        type: string
        enum: [little, big]
      alignment_bytes:
        type: integer
        minimum: 1
      encode_spec:
        type: object
        additionalProperties: false
        required:
          [
            site_order_bytes,
            prob_mass_bytes,
            alias_site_order_bytes,
            padding_value,
            checksum,
          ]
        properties:
          site_order_bytes:
            type: integer
            minimum: 1
          prob_mass_bytes:
            type: integer
            minimum: 1
          alias_site_order_bytes:
            type: integer
            minimum: 1
          padding_value:
            type: string
            pattern: "^0x[0-9a-fA-F]{2}$"
          checksum:
            type: object
            additionalProperties: false
            required: [algorithm]
            properties:
              algorithm:
                type: string
                enum: [sha256]
      decode_law:
        type: string
        minLength: 1
      notes: { type: string }

  virtual_edge_policy_v1:
    type: object
    additionalProperties: false
    required: [version_tag, default_edges]
    properties:
      version_tag: { type: string, minLength: 1 }
      default_edges:
        type: array
        minItems: 1
        items:
          type: object
          additionalProperties: false
          required: [edge_id, country_iso, weight]
          properties:
            edge_id: { type: string, minLength: 1 }
            country_iso: { $ref: 'schemas.layer1.yaml#/$defs/iso2' }
            weight: { type: number }
      geo_metadata:
        type: object
        additionalProperties:
          type: object
          additionalProperties: false
          required: [lat, lon]
          properties:
            lat: { type: number }
            lon: { type: number }
      notes: { type: string }

  day_effect_policy_v1:
    type: object
    additionalProperties: false
    required:
      [
        version_tag,
        rng_engine,
        rng_stream_id,
        sigma_gamma,
        day_range,
        draws_per_row,
        record_fields,
        created_utc_policy_echo,
        rng_key_hi,
        rng_key_lo,
        base_counter_hi,
        base_counter_lo,
      ]
    properties:
      version_tag: { type: string, minLength: 1 }
      rng_engine: { type: string, minLength: 1 }
      rng_stream_id: { type: string, minLength: 1 }
      sigma_gamma:
        type: number
        exclusiveMinimum: 0
      day_range:
        type: object
        additionalProperties: false
        required: [start_day, end_day]
        properties:
          start_day:
            type: string
            pattern: '^\d{4}-\d{2}-\d{2}$'
          end_day:
            type: string
            pattern: '^\d{4}-\d{2}-\d{2}$'
      draws_per_row:
        type: integer
        enum: [1]
      record_fields:
        type: array
        minItems: 1
        items: { type: string, minLength: 1 }
      created_utc_policy_echo: { type: boolean }
      rng_key_hi:
        type: integer
        minimum: 0
      rng_key_lo:
        type: integer
        minimum: 0
      base_counter_hi:
        type: integer
        minimum: 0
      base_counter_lo:
        type: integer
        minimum: 0
      calendar: { type: string }
      notes: { type: string }

# -- Plan tables ------------------------------------------------------------
plan:

  s1_site_weights:
    type: table
    description: "Frozen per-site probability weights per merchant."
    primary_key: [merchant_id, legal_country_iso, site_order]
    partition_keys: [seed, fingerprint]
    sort_keys: [merchant_id, legal_country_iso, site_order]
    columns_strict: true
    columns:
      - name: merchant_id
        $ref: 'schemas.layer1.yaml#/$defs/id64'
        nullable: false
      - name: legal_country_iso
        $ref: 'schemas.layer1.yaml#/$defs/iso2'
        nullable: false
      - name: site_order
        type: integer
        minimum: 1
        nullable: false
      - name: p_weight
        type: number
        minimum: 0
        maximum: 1
        nullable: false
      - name: weight_source
        type: string
        nullable: false
      - name: quantised_bits
        type: integer
        minimum: 1
        nullable: false
      - name: floor_applied
        type: boolean
        nullable: false
      - name: created_utc
        $ref: 'schemas.layer1.yaml#/$defs/rfc3339_micros'
        nullable: false

  s3_day_effects:
    type: table
    description: "Per-merchant, per-day, per-tz-group corporate-day modulation factors."
    primary_key: [merchant_id, utc_day, tz_group_id]
    partition_keys: [seed, fingerprint]
    sort_keys: [merchant_id, utc_day, tz_group_id]
    columns_strict: true
    columns:
      - name: merchant_id
        $ref: 'schemas.layer1.yaml#/$defs/id64'
        nullable: false
      - name: utc_day
        type: string
        pattern: '^\d{4}-\d{2}-\d{2}$'
        nullable: false
      - name: tz_group_id
        type: string
        minLength: 1
        nullable: false
      - name: gamma
        type: number
        exclusiveMinimum: 0
        nullable: false
      - name: log_gamma
        type: number
        nullable: false
      - name: sigma_gamma
        type: number
        exclusiveMinimum: 0
        nullable: false
      - name: rng_stream_id
        type: string
        minLength: 1
        nullable: false
      - name: rng_counter_hi
        type: integer
        minimum: 0
        maximum: 18446744073709551615
        nullable: false
      - name: rng_counter_lo
        type: integer
        minimum: 0
        maximum: 18446744073709551615
        nullable: false
      - name: created_utc
        $ref: 'schemas.layer1.yaml#/$defs/rfc3339_micros'
        nullable: false

  s4_group_weights:
    type: table
    description: "Per-merchant, per-day, per-tz-group deterministic routing mix (RNG-free)."
    primary_key: [merchant_id, utc_day, tz_group_id]
    partition_keys: [seed, fingerprint]
    sort_keys: [merchant_id, utc_day, tz_group_id]
    columns_strict: true
    columns:
      - name: merchant_id
        $ref: 'schemas.layer1.yaml#/$defs/id64'
        nullable: false
      - name: utc_day
        type: string
        pattern: '^\d{4}-\d{2}-\d{2}$'
        nullable: false
      - name: tz_group_id
        type: string
        minLength: 1
        nullable: false
      - name: p_group
        type: number
        minimum: 0
        maximum: 1
        nullable: false
      - name: base_share
        type: number
        minimum: 0
        maximum: 1
        nullable: false
      - name: gamma
        type: number
        exclusiveMinimum: 0
        nullable: false
      - name: created_utc
        $ref: 'schemas.layer1.yaml#/$defs/rfc3339_micros'
        nullable: false
      - name: mass_raw
        type: number
        minimum: 0
        nullable: true
      - name: denom_raw
        type: number
        minimum: 0
        nullable: true

  s2_alias_index:
    type: object
    description: "Alias index describing each merchant slice inside the alias blob."
    additionalProperties: false
    required:
      [
        layout_version,
        endianness,
        alignment_bytes,
        quantised_bits,
        created_utc,
        policy_id,
        policy_digest,
        blob_sha256,
        blob_size_bytes,
        merchants_count,
        merchants,
      ]
    properties:
      layout_version: { type: string, minLength: 1 }
      endianness: { type: string, enum: [little, big] }
      alignment_bytes: { type: integer, minimum: 1 }
      quantised_bits: { type: integer, minimum: 1 }
      created_utc: { $ref: 'schemas.layer1.yaml#/$defs/rfc3339_micros' }
      policy_id: { type: string, const: "alias_layout_policy_v1" }
      policy_digest: { $ref: 'schemas.layer1.yaml#/$defs/hex64' }
      blob_sha256: { $ref: 'schemas.layer1.yaml#/$defs/hex64' }
      blob_size_bytes: { type: integer, minimum: 0 }
      merchants_count: { type: integer, minimum: 0 }
      merchants:
        type: array
        items:
          type: object
          additionalProperties: false
          required:
            [merchant_id, offset, length, sites, quantised_bits, checksum]
          properties:
            merchant_id: { $ref: 'schemas.layer1.yaml#/$defs/id64' }
            offset: { type: integer, minimum: 0 }
            length: { type: integer, minimum: 0 }
            sites: { type: integer, minimum: 1 }
            quantised_bits: { type: integer, minimum: 1 }
            checksum: { $ref: 'schemas.layer1.yaml#/$defs/hex64' }

binary:

  s2_alias_blob:
    type: object
    description: "Metadata contract for the alias blob; layout/bytes governed by alias_layout_policy_v1."
    additionalProperties: false
    required:
      [layout_version, endianness, alignment_bytes, quantised_bits, blob_sha256, blob_size_bytes]
    properties:
      layout_version: { type: string, minLength: 1 }
      endianness: { type: string, enum: [little, big] }
      alignment_bytes: { type: integer, minimum: 1 }
      quantised_bits: { type: integer, minimum: 1 }
      blob_sha256: { $ref: 'schemas.layer1.yaml#/$defs/hex64' }
      blob_size_bytes: { type: integer, minimum: 0 }
