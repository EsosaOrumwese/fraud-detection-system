version: '1.0'
$id: schemas.2B.yaml
$schema: https://json-schema.org/draft/2020-12/schema
description: "Layer-1 Segment 2B schema pack. JSON-Schema is the sole shape authority."

# Local definitions for 2B-specific schema reuse
$defs:
  partition_kv:
    type: object
    additionalProperties:
      type: string
    minProperties: 0

# -- Validation artefacts ---------------------------------------------------
validation:

  s0_gate_receipt_v1:
    type: object
    additionalProperties: false
    required:
      [
        manifest_fingerprint,
        seed,
        parameter_hash,
        verified_at_utc,
        sealed_inputs,
        catalogue_resolution,
        determinism_receipt,
      ]
    properties:
      manifest_fingerprint:
        $ref: 'schemas.layer1.yaml#/$defs/hex64'
      seed:
        $ref: 'schemas.layer1.yaml#/$defs/uint64'
      parameter_hash:
        $ref: 'schemas.layer1.yaml#/$defs/hex64'
      verified_at_utc:
        $ref: 'schemas.layer1.yaml#/$defs/rfc3339_micros'
      sealed_inputs:
        type: array
        minItems: 1
        items:
          type: object
          additionalProperties: false
          required: [id, partition, schema_ref]
          properties:
            id: { type: string, minLength: 1 }
            partition:
              $ref: '#/$defs/partition_kv'
            schema_ref: { type: string, minLength: 1 }
      catalogue_resolution:
        type: object
        additionalProperties: false
        required: [dictionary_version, registry_version]
        properties:
          dictionary_version: { type: string, minLength: 1 }
          registry_version: { type: string, minLength: 1 }
      determinism_receipt:
        type: object
        additionalProperties: false
        properties:
          engine_commit: { type: string }
          python_version: { type: string }
          platform: { type: string }
          policy_ids:
            type: array
            items: { type: string }
          policy_digests:
            type: array
            items: { $ref: 'schemas.layer1.yaml#/$defs/hex64' }

  sealed_inputs_v1:
    type: array
    items:
      type: object
      additionalProperties: false
      required: [asset_id, version_tag, sha256_hex, path, partition]
      properties:
        asset_id: { type: string, minLength: 1 }
        version_tag: { type: string, minLength: 1 }
        sha256_hex: { $ref: 'schemas.layer1.yaml#/$defs/hex64' }
        path: { type: string, minLength: 1 }
        partition:
          $ref: '#/$defs/partition_kv'
        schema_ref: { type: string }

  s7_audit_report_v1:
    type: object
    additionalProperties: false
    required:
      [
        component,
        fingerprint,
        seed,
        created_utc,
        catalogue_resolution,
        inputs_digest,
        checks,
        metrics,
        summary,
      ]
    properties:
      component: { const: "2B.S7" }
      fingerprint: { $ref: "schemas.layer1.yaml#/$defs/hex64" }
      seed: { $ref: "schemas.layer1.yaml#/$defs/uint64" }
      created_utc: { $ref: "schemas.layer1.yaml#/$defs/rfc3339_micros" }
      catalogue_resolution:
        type: object
        additionalProperties: false
        required: [dictionary_version, registry_version]
        properties:
          dictionary_version: { type: string, minLength: 1 }
          registry_version: { type: string, minLength: 1 }
      inputs_digest:
        type: object
        additionalProperties: true
      checks:
        type: array
        minItems: 1
        items:
          type: object
          additionalProperties: false
          required: [id, status, codes]
          properties:
            id: { type: string, minLength: 1 }
            status: { type: string, enum: [PASS, FAIL, WARN] }
            codes:
              type: array
              minItems: 1
              items: { type: string, minLength: 1 }
            context: { type: object }
      metrics:
        type: object
        additionalProperties: false
        properties:
          merchants_total: { type: integer, minimum: 0 }
          groups_total: { type: integer, minimum: 0 }
          days_total: { type: integer, minimum: 0 }
          selections_checked: { type: integer, minimum: 0 }
          draws_expected: { type: integer, minimum: 0 }
          draws_observed: { type: integer, minimum: 0 }
          alias_decode_max_abs_delta: { type: number }
          max_abs_mass_error_s4: { type: number }
      summary:
        type: object
        additionalProperties: false
        required: [overall_status, warn_count, fail_count]
        properties:
          overall_status: { type: string, enum: [PASS, FAIL] }
          warn_count: { type: integer, minimum: 0 }
          fail_count: { type: integer, minimum: 0 }

# -- Policy packs -----------------------------------------------------------
policy:

  route_rng_policy_v1:
    type: object
    additionalProperties: true

  alias_layout_policy_v1:
    type: object
    additionalProperties: true

  virtual_edge_policy_v1:
    type: object
    additionalProperties: false
    required: [policy_id, version_tag, edges]
    properties:
      policy_id:   { const: virtual_edge_policy_v1 }
      version_tag: { type: string, minLength: 1 }
      edges:
        type: array
        minItems: 1
        items:
          type: object
          additionalProperties: false
          required: [edge_id, ip_country, edge_lat, edge_lon]
          oneOf:
            - required: [weight]
            - required: [country_weights]
          properties:
            edge_id:     { type: string, minLength: 1 }
            ip_country:  { $ref: 'schemas.layer1.yaml#/$defs/iso2' }
            edge_lat:    { type: number, minimum: -90, maximum: 90 }
            edge_lon:    { type: number, exclusiveMinimum: -180, maximum: 180 }
            weight:      { type: number, exclusiveMinimum: 0 }
            country_weights:
              type: object
              additionalProperties: { type: number, minimum: 0 }
              minProperties: 1
      notes:       { type: string }

  day_effect_policy_v1:
    type: object
    additionalProperties: true

# -- Plan tables ------------------------------------------------------------
plan:

  s1_site_weights:
    type: table
    description: "Frozen per-site probability weights per merchant."
    primary_key: [merchant_id, legal_country_iso, site_order]
    partition_keys: [seed, fingerprint]
    sort_keys: [merchant_id, legal_country_iso, site_order]
    columns_strict: true
    columns:
      - name: merchant_id
        $ref: 'schemas.layer1.yaml#/$defs/id64'
        nullable: false
      - name: legal_country_iso
        $ref: 'schemas.layer1.yaml#/$defs/iso2'
        nullable: false
      - name: site_order
        type: integer
        minimum: 1
        nullable: false
      - name: p_weight
        type: number
        minimum: 0
        maximum: 1
        nullable: false
      - name: weight_source
        type: string
        nullable: false
      - name: quantised_bits
        type: integer
        minimum: 1
        nullable: false
      - name: floor_applied
        type: boolean
        nullable: false
      - name: created_utc
        $ref: 'schemas.layer1.yaml#/$defs/rfc3339_micros'
        nullable: false

  s3_day_effects:
    type: table
    description: "Per-merchant, per-day, per-tz-group corporate-day modulation factors."
    primary_key: [merchant_id, utc_day, tz_group_id]
    partition_keys: [seed, fingerprint]
    sort_keys: [merchant_id, utc_day, tz_group_id]
    columns_strict: true
    columns:
      - name: merchant_id
        $ref: 'schemas.layer1.yaml#/$defs/id64'
        nullable: false
      - name: utc_day
        type: string
        pattern: '^\d{4}-\d{2}-\d{2}$'
        nullable: false
      - name: tz_group_id
        type: string
        minLength: 1
        nullable: false
      - name: gamma
        type: number
        exclusiveMinimum: 0
        nullable: false
      - name: log_gamma
        type: number
        nullable: false
      - name: sigma_gamma
        type: number
        exclusiveMinimum: 0
        nullable: false
      - name: rng_stream_id
        type: string
        minLength: 1
        nullable: false
      - name: rng_counter_hi
        type: integer
        minimum: 0
        maximum: 18446744073709551615
        nullable: false
      - name: rng_counter_lo
        type: integer
        minimum: 0
        maximum: 18446744073709551615
        nullable: false
      - name: created_utc
        $ref: 'schemas.layer1.yaml#/$defs/rfc3339_micros'
        nullable: false

  s4_group_weights:
    type: table
    description: "Per-merchant, per-day, per-tz-group deterministic routing mix (RNG-free)."
    primary_key: [merchant_id, utc_day, tz_group_id]
    partition_keys: [seed, fingerprint]
    sort_keys: [merchant_id, utc_day, tz_group_id]
    columns_strict: true
    columns:
      - name: merchant_id
        $ref: 'schemas.layer1.yaml#/$defs/id64'
        nullable: false
      - name: utc_day
        type: string
        pattern: '^\d{4}-\d{2}-\d{2}$'
        nullable: false
      - name: tz_group_id
        type: string
        minLength: 1
        nullable: false
      - name: p_group
        type: number
        minimum: 0
        maximum: 1
        nullable: false
      - name: base_share
        type: number
        minimum: 0
        maximum: 1
        nullable: false
      - name: gamma
        type: number
        exclusiveMinimum: 0
        nullable: false
      - name: created_utc
        $ref: 'schemas.layer1.yaml#/$defs/rfc3339_micros'
        nullable: false
      - name: mass_raw
        type: number
        minimum: 0
        nullable: true
      - name: denom_raw
        type: number
        minimum: 0
        nullable: true

  s2_alias_index:
    type: object
    description: "Alias index describing each merchant slice inside the alias blob."
    additionalProperties: false
    required:
      [
        layout_version,
        endianness,
        alignment_bytes,
        quantised_bits,
        created_utc,
        policy_id,
        policy_digest,
        blob_sha256,
        blob_size_bytes,
        merchants_count,
        merchants,
      ]
    properties:
      layout_version: { type: string, minLength: 1 }
      endianness: { type: string, enum: [little, big] }
      alignment_bytes: { type: integer, minimum: 1 }
      quantised_bits: { type: integer, minimum: 1 }
      created_utc: { $ref: 'schemas.layer1.yaml#/$defs/rfc3339_micros' }
      policy_id: { type: string, const: "alias_layout_policy_v1" }
      policy_digest: { $ref: 'schemas.layer1.yaml#/$defs/hex64' }
      blob_sha256: { $ref: 'schemas.layer1.yaml#/$defs/hex64' }
      blob_size_bytes: { type: integer, minimum: 0 }
      merchants_count: { type: integer, minimum: 0 }
      merchants:
        type: array
        items:
          type: object
          additionalProperties: false
          required:
            [merchant_id, offset, length, sites, quantised_bits, checksum]
          properties:
            merchant_id: { $ref: 'schemas.layer1.yaml#/$defs/id64' }
            offset: { type: integer, minimum: 0 }
            length: { type: integer, minimum: 0 }
            sites: { type: integer, minimum: 1 }
            quantised_bits: { type: integer, minimum: 1 }
            checksum: { $ref: 'schemas.layer1.yaml#/$defs/hex64' }

binary:

  s2_alias_blob:
    type: object
    description: "Metadata contract for the alias blob; layout/bytes governed by alias_layout_policy_v1."
    additionalProperties: false
    required:
      [layout_version, endianness, alignment_bytes, quantised_bits, blob_sha256, blob_size_bytes]
    properties:
      layout_version: { type: string, minLength: 1 }
      endianness: { type: string, enum: [little, big] }
      alignment_bytes: { type: integer, minimum: 1 }
      quantised_bits: { type: integer, minimum: 1 }
      blob_sha256: { $ref: 'schemas.layer1.yaml#/$defs/hex64' }
      blob_size_bytes: { type: integer, minimum: 0 }

trace:

  s5_selection_log_row:
    type: object
    additionalProperties: false
    required:
      [
        seed,
        parameter_hash,
        run_id,
        utc_day,
        utc_timestamp,
        merchant_id,
        tz_group_id,
        site_id,
        rng_stream_id,
        ctr_group_hi,
        ctr_group_lo,
        ctr_site_hi,
        ctr_site_lo,
        manifest_fingerprint,
        created_utc,
      ]
    properties:
      seed: { $ref: 'schemas.layer1.yaml#/$defs/uint64' }
      parameter_hash: { $ref: 'schemas.layer1.yaml#/$defs/hex64' }
      run_id: { $ref: 'schemas.layer1.yaml#/$defs/hex32' }
      utc_day:
        type: string
        pattern: '^\d{4}-\d{2}-\d{2}$'
      utc_timestamp: { $ref: 'schemas.layer1.yaml#/$defs/rfc3339_micros' }
      merchant_id: { $ref: 'schemas.layer1.yaml#/$defs/id64' }
      tz_group_id: { $ref: 'schemas.layer1.yaml#/$defs/iana_tzid' }
      site_id: { $ref: 'schemas.layer1.yaml#/$defs/id64' }
      selection_seq:
        $ref: 'schemas.layer1.yaml#/$defs/uint64'
        nullable: true
        description: 'Monotone arrival sequence (optional).'
      rng_stream_id: { type: string, minLength: 1 }
      ctr_group_hi: { $ref: 'schemas.layer1.yaml#/$defs/uint64' }
      ctr_group_lo: { $ref: 'schemas.layer1.yaml#/$defs/uint64' }
      ctr_site_hi: { $ref: 'schemas.layer1.yaml#/$defs/uint64' }
      ctr_site_lo: { $ref: 'schemas.layer1.yaml#/$defs/uint64' }
      manifest_fingerprint: { $ref: 'schemas.layer1.yaml#/$defs/hex64' }
      created_utc: { $ref: 'schemas.layer1.yaml#/$defs/rfc3339_micros' }
      notes: { type: string, nullable: true }

  s6_edge_log_row:
    type: object
    additionalProperties: false
    required:
      [
        seed,
        parameter_hash,
        run_id,
        utc_day,
        utc_timestamp,
        merchant_id,
        is_virtual,
        tz_group_id,
        site_id,
        edge_id,
        ip_country,
        edge_lat,
        edge_lon,
        rng_stream_id,
        ctr_edge_hi,
        ctr_edge_lo,
        manifest_fingerprint,
        created_utc,
      ]
    properties:
      seed: { $ref: 'schemas.layer1.yaml#/$defs/uint64' }
      parameter_hash: { $ref: 'schemas.layer1.yaml#/$defs/hex64' }
      run_id: { $ref: 'schemas.layer1.yaml#/$defs/hex32' }
      utc_day:
        type: string
        pattern: '^\d{4}-\d{2}-\d{2}$'
      utc_timestamp: { $ref: 'schemas.layer1.yaml#/$defs/rfc3339_micros' }
      merchant_id: { $ref: 'schemas.layer1.yaml#/$defs/id64' }
      is_virtual: { type: boolean }
      tz_group_id: { $ref: 'schemas.layer1.yaml#/$defs/iana_tzid' }
      site_id: { $ref: 'schemas.layer1.yaml#/$defs/id64' }
      edge_id: { type: string, minLength: 1 }
      ip_country: { $ref: 'schemas.layer1.yaml#/$defs/iso2' }
      edge_lat:
        type: number
        minimum: -90
        maximum: 90
      edge_lon:
        type: number
        exclusiveMinimum: -180
        maximum: 180
      edge_latlon_source: { type: string, nullable: true }
      selection_seq:
        $ref: 'schemas.layer1.yaml#/$defs/uint64'
        nullable: true
      rng_stream_id: { type: string, minLength: 1 }
      ctr_edge_hi: { $ref: 'schemas.layer1.yaml#/$defs/uint64' }
      ctr_edge_lo: { $ref: 'schemas.layer1.yaml#/$defs/uint64' }
      manifest_fingerprint: { $ref: 'schemas.layer1.yaml#/$defs/hex64' }
      created_utc: { $ref: 'schemas.layer1.yaml#/$defs/rfc3339_micros' }
      notes: { type: string, nullable: true }
