$schema: "https://json-schema.org/draft/2020-12/schema"
$id: schemas.layer3.yaml
title: "Layer-3 shared schema pack (gate & validation)"
description: >-
  Shared schema anchors for Layer-3 segments. Gate receipts and sealed-input
  manifests live here (since they point to upstream layers), as do the segment
  validation bundle/report/flag structures. Business datasets remain in each
  segmentâ€™s local schema pack.
type: object
additionalProperties: false

$defs:
  hex64:
    type: string
    pattern: "^[0-9a-f]{64}$"

gate:
  description: "Segment gate receipts and sealed-input manifests"
  type: object
  additionalProperties: false
  properties:
    6A:
      type: object
      additionalProperties: false
      properties:
        s0_gate_receipt_6A:
          type: object
          additionalProperties: false
          required:
            - manifest_fingerprint
            - parameter_hash
            - spec_version_6A
            - upstream_segments
            - contracts_6A
            - sealed_inputs_digest_6A
          properties:
            manifest_fingerprint: { $ref: "#/$defs/hex64" }
            parameter_hash:       { $ref: "#/$defs/hex64" }
            spec_version_6A:      { type: string }
            upstream_segments:
              type: object
              additionalProperties:
                type: object
                additionalProperties: false
                required: [status, bundle_path, bundle_sha256, flag_path]
                properties:
                  status:        { type: string, enum: [PASS, FAIL, MISSING] }
                  bundle_path:   { type: string }
                  bundle_sha256: { $ref: "#/$defs/hex64" }
                  flag_path:     { type: string }
            contracts_6A:
              type: object
              additionalProperties:
                type: object
                additionalProperties: false
                required: [logical_id, path, sha256_hex]
                properties:
                  logical_id:  { type: string }
                  path:        { type: string }
                  sha256_hex:  { $ref: "#/$defs/hex64" }
                  schema_ref:  { type: string }
                  role:        { type: string }
            sealed_inputs_digest_6A: { $ref: "#/$defs/hex64" }
            prior_packs:
              type: array
              items:
                type: object
                additionalProperties: false
                required: [logical_id, version, role]
                properties:
                  logical_id: { type: string }
                  version:    { type: string }
                  role:       { type: string }
                  schema_ref: { type: ["null", "string"] }
                  path:       { type: ["null", "string"] }
                  sha256_hex: { $ref: "#/$defs/hex64" }

        sealed_inputs_6A:
          type: object
          additionalProperties: false
          required:
            - manifest_fingerprint
            - owner_layer
            - owner_segment
            - manifest_key
            - path_template
            - partition_keys
            - schema_ref
            - role
            - status
            - read_scope
            - sha256_hex
          properties:
            manifest_fingerprint: { $ref: "#/$defs/hex64" }
            owner_layer:
              type: integer
              enum: [1, 2, 3]
            owner_segment: { type: string }
            manifest_key:  { type: string }
            path_template: { type: string }
            partition_keys:
              type: array
              items: { type: string }
            schema_ref: { type: string }
            role:        { type: string }
            status:
              type: string
              enum: [REQUIRED, OPTIONAL, IGNORED]
            read_scope:
              type: string
              enum: [ROW_LEVEL, METADATA_ONLY]
            sha256_hex: { $ref: "#/$defs/hex64" }
            upstream_bundle_id: { type: ["null", "string"] }
            notes:              { type: ["null", "string"] }

    6B:
      type: object
      additionalProperties: false
      properties:
        s0_gate_receipt_6B:
          type: object
          additionalProperties: false
          required:
            - manifest_fingerprint
            - parameter_hash
            - spec_version_6B
            - upstream_segments
            - contracts_6B
            - sealed_inputs_digest_6B
          properties:
            manifest_fingerprint: { $ref: "#/$defs/hex64" }
            parameter_hash:       { $ref: "#/$defs/hex64" }
            spec_version_6B:      { type: string }
            upstream_segments:
              type: object
              additionalProperties:
                type: object
                additionalProperties: false
                required: [status, bundle_path, bundle_sha256, flag_path]
                properties:
                  status:        { type: string, enum: [PASS, FAIL, MISSING] }
                  bundle_path:   { type: string }
                  bundle_sha256: { $ref: "#/$defs/hex64" }
                  flag_path:     { type: string }
            contracts_6B:
              type: object
              additionalProperties:
                type: object
                additionalProperties: false
                required: [logical_id, path, sha256_hex]
                properties:
                  logical_id:  { type: string }
                  path:        { type: string }
                  sha256_hex:  { $ref: "#/$defs/hex64" }
                  schema_ref:  { type: string }
                  role:        { type: string }
            sealed_inputs_digest_6B: { $ref: "#/$defs/hex64" }

        sealed_inputs_6B:
          type: object
          additionalProperties: false
          required:
            - manifest_fingerprint
            - owner_layer
            - owner_segment
            - manifest_key
            - path_template
            - partition_keys
            - schema_ref
            - role
            - status
            - read_scope
            - sha256_hex
          properties:
            manifest_fingerprint: { $ref: "#/$defs/hex64" }
            owner_layer:
              type: integer
              enum: [1, 2, 3]
            owner_segment: { type: string }
            manifest_key:  { type: string }
            path_template: { type: string }
            partition_keys:
              type: array
              items: { type: string }
            schema_ref: { type: string }
            role:        { type: string }
            status:
              type: string
              enum: [REQUIRED, OPTIONAL, IGNORED]
            read_scope:
              type: string
              enum: [ROW_LEVEL, METADATA_ONLY]
            sha256_hex: { $ref: "#/$defs/hex64" }
            upstream_bundle_id: { type: ["null", "string"] }
            notes:              { type: ["null", "string"] }

validation:
  description: "Segment validation bundles, reports and flags"
  type: object
  additionalProperties: false
  properties:
    6A:
      type: object
      additionalProperties: false
      properties:
        validation_report_6A:
          type: object
          additionalProperties: false
          required:
            - manifest_fingerprint
            - parameter_hash
            - spec_version_6A
            - overall_status
            - upstream_segments
            - segment_states
            - checks
          properties:
            manifest_fingerprint: { $ref: "#/$defs/hex64" }
            parameter_hash:       { $ref: "#/$defs/hex64" }
            spec_version_6A:      { type: string }
            overall_status:       { type: string, enum: [PASS, WARN, FAIL] }
            upstream_segments:
              type: object
              additionalProperties:
                type: object
                additionalProperties: false
                required: [status, bundle_sha256, flag_path]
                properties:
                  status:        { type: string }
                  bundle_sha256: { $ref: "#/$defs/hex64" }
                  flag_path:     { type: string }
            segment_states:
              type: object
              additionalProperties: { type: string }
            checks:
              type: array
              items:
                type: object
                additionalProperties: false
                required: [check_id, severity, result]
                properties:
                  check_id:  { type: string }
                  severity:  { type: string, enum: [REQUIRED, WARN_ONLY, INFO] }
                  result:    { type: string, enum: [PASS, WARN, FAIL] }
                  metrics:   { type: object, additionalProperties: true }
                  thresholds:{ type: object, additionalProperties: true }

        validation_issue_table_6A:
          type: object
          additionalProperties: false
          required:
            - manifest_fingerprint
            - check_id
            - issue_id
            - severity
            - scope_type
            - message
          properties:
            manifest_fingerprint: { $ref: "#/$defs/hex64" }
            check_id:             { type: string }
            issue_id:             { type: ["string", "integer"] }
            severity:             { type: string, enum: [WARN, FAIL] }
            scope_type:           { type: string }
            seed:                 { type: ["null", "integer", "string"] }
            scenario_id:          { type: ["null", "integer", "string"] }
            flow_id:              { type: ["null", "integer", "string"] }
            case_id:              { type: ["null", "integer", "string"] }
            event_seq:            { type: ["null", "integer"] }
            message:              { type: string }
            metrics:              { type: object, additionalProperties: true }

        validation_bundle_index_6A:
          type: object
          additionalProperties: false
          required:
            - manifest_fingerprint
            - parameter_hash
            - spec_version_6A
            - items
          properties:
            manifest_fingerprint: { $ref: "#/$defs/hex64" }
            parameter_hash:       { $ref: "#/$defs/hex64" }
            spec_version_6A:      { type: string }
            items:
              type: array
              items:
                type: object
                additionalProperties: false
                required: [path, sha256_hex, role]
                properties:
                  path:       { type: string }
                  sha256_hex: { $ref: "#/$defs/hex64" }
                  role:       { type: string }
                  schema_ref: { type: ["null", "string"] }

        passed_flag_6A:
          type: string
          pattern: "^sha256_hex = [0-9a-f]{64}$"

    6B:
      type: object
      additionalProperties: false
      properties:
        s5_validation_report:
          type: object
          additionalProperties: false
          required:
            - manifest_fingerprint
            - parameter_hash
            - spec_version_6B
            - overall_status
            - upstream_segments
            - segment_states
            - checks
          properties:
            manifest_fingerprint: { $ref: "#/$defs/hex64" }
            parameter_hash:       { $ref: "#/$defs/hex64" }
            spec_version_6B:      { type: string }
            overall_status:       { type: string, enum: [PASS, WARN, FAIL] }
            upstream_segments:
              type: object
              additionalProperties:
                type: object
                additionalProperties: false
                required: [status, bundle_sha256, flag_path]
                properties:
                  status:        { type: string }
                  bundle_sha256: { $ref: "#/$defs/hex64" }
                  flag_path:     { type: string }
            segment_states:
              type: object
              additionalProperties: { type: string }
            checks:
              type: array
              items:
                type: object
                additionalProperties: false
                required: [check_id, severity, result]
                properties:
                  check_id:  { type: string }
                  severity:  { type: string, enum: [REQUIRED, WARN_ONLY, INFO] }
                  result:    { type: string, enum: [PASS, WARN, FAIL] }
                  metrics:   { type: object, additionalProperties: true }
                  thresholds:{ type: object, additionalProperties: true }

        s5_issue_table:
          type: object
          additionalProperties: false
          required:
            - manifest_fingerprint
            - check_id
            - issue_id
            - severity
            - scope_type
            - message
          properties:
            manifest_fingerprint: { $ref: "#/$defs/hex64" }
            check_id:             { type: string }
            issue_id:             { type: ["string", "integer"] }
            severity:             { type: string, enum: [WARN, FAIL] }
            scope_type:           { type: string }
            seed:                 { type: ["null", "integer", "string"] }
            scenario_id:          { type: ["null", "integer", "string"] }
            flow_id:              { type: ["null", "integer", "string"] }
            case_id:              { type: ["null", "integer", "string"] }
            event_seq:            { type: ["null", "integer"] }
            message:              { type: string }
            metrics:              { type: object, additionalProperties: true }

        validation_bundle_index_6B:
          type: object
          additionalProperties: false
          required:
            - manifest_fingerprint
            - parameter_hash
            - spec_version_6B
            - items
          properties:
            manifest_fingerprint: { $ref: "#/$defs/hex64" }
            parameter_hash:       { $ref: "#/$defs/hex64" }
            spec_version_6B:      { type: string }
            items:
              type: array
              items:
                type: object
                additionalProperties: false
                required: [path, sha256_hex, role]
                properties:
                  path:       { type: string }
                  sha256_hex: { $ref: "#/$defs/hex64" }
                  role:       { type: string }
                  schema_ref: { type: ["null", "string"] }

        passed_flag_6B:
          type: string
          pattern: "^sha256_hex = [0-9a-f]{64}$"
