schema_version: 1
config_id: device_linkage_rules_6A
config_version: v1

bindings:
  party_taxonomy_ref: taxonomy_party_6A
  account_taxonomy_ref: taxonomy_account_types_6A
  instrument_taxonomy_ref: taxonomy_instrument_types_6A
  device_taxonomy_ref: taxonomy_devices_6A

device_groups:
  groups:
    - group_id: BACKEND_SERVER
      device_types: [SERVER]
      semantics: "Backend or automated clients."
    - group_id: COMPUTER_PORTABLE
      device_types: [LAPTOP]
      semantics: "Portable computers."
    - group_id: CONSUMER_PERSONAL
      device_types: [MOBILE_PHONE, WEARABLE]
      semantics: "Personal consumer devices."
    - group_id: CONSUMER_SHARED
      device_types: [DESKTOP, TABLET]
      semantics: "Shared household devices."
    - group_id: IOT_OTHER
      device_types: [IOT_DEVICE]
      semantics: "IoT and embedded devices."
    - group_id: MERCHANT_TERMINAL
      device_types: [POS_TERMINAL, ATM, KIOSK]
      semantics: "Merchant terminals."
  group_priority:
    CONSUMER_PERSONAL: 10
    CONSUMER_SHARED: 20
    COMPUTER_PORTABLE: 30
    MERCHANT_TERMINAL: 40
    BACKEND_SERVER: 50
    IOT_OTHER: 60

link_role_vocabulary:
  - role_id: ASSOCIATED_ACCOUNT_ACCESS
    label: Account access
    description: "Device can access the account (app/web/terminal context)."
    required_nonnull_fields: [account_id]
    allowed_field_patterns:
      - { pattern_id: ACC_ONLY, party_id: OPTIONAL, account_id: REQUIRED, instrument_id: FORBIDDEN, merchant_id: FORBIDDEN }

  - role_id: ASSOCIATED_INSTRUMENT_ACCESS
    label: Instrument access
    description: "Device can access the instrument credential."
    required_nonnull_fields: [instrument_id]
    allowed_field_patterns:
      - { pattern_id: INSTR_ONLY, party_id: OPTIONAL, account_id: FORBIDDEN, instrument_id: REQUIRED, merchant_id: FORBIDDEN }

  - role_id: MERCHANT_TERMINAL
    label: Merchant terminal
    description: "Device is a merchant-owned terminal."
    required_nonnull_fields: [merchant_id]
    allowed_field_patterns:
      - { pattern_id: TERM_ONLY, party_id: FORBIDDEN, account_id: FORBIDDEN, instrument_id: FORBIDDEN, merchant_id: REQUIRED }

  - role_id: PRIMARY_OWNER
    label: Primary owner
    description: "Primary owner of a device."
    required_nonnull_fields: [party_id]
    allowed_field_patterns:
      - { pattern_id: OWNER_PARTY, party_id: REQUIRED, account_id: FORBIDDEN, instrument_id: FORBIDDEN, merchant_id: FORBIDDEN }

  - role_id: SECONDARY_USER
    label: Secondary user
    description: "Additional party using a shared device."
    required_nonnull_fields: [party_id]
    allowed_field_patterns:
      - { pattern_id: COUSER, party_id: REQUIRED, account_id: FORBIDDEN, instrument_id: FORBIDDEN, merchant_id: FORBIDDEN }

owner_policy:
  owner_kind_by_group:
    BACKEND_SERVER: MERCHANT
    COMPUTER_PORTABLE: PARTY
    CONSUMER_PERSONAL: PARTY
    CONSUMER_SHARED: PARTY
    IOT_OTHER: PARTY
    MERCHANT_TERMINAL: MERCHANT
  primary_owner_role_id: PRIMARY_OWNER
  merchant_owner_role_id: MERCHANT_TERMINAL
  selection_scope: WITHIN_DEVICE_CELL_ONLY

sharing_policy:
  p_shared_by_group:
    BACKEND_SERVER: 0.00
    COMPUTER_PORTABLE: 0.08
    CONSUMER_PERSONAL: 0.03
    CONSUMER_SHARED: 0.25
    IOT_OTHER: 0.06
    MERCHANT_TERMINAL: 0.00
  shared_party_count_model_by_group:
    COMPUTER_PORTABLE: { model_id: geometric_capK_v1, min_k: 2, max_k: 4, p: 0.65 }
    CONSUMER_PERSONAL: { model_id: geometric_capK_v1, min_k: 2, max_k: 4, p: 0.70 }
    CONSUMER_SHARED: { model_id: geometric_capK_v1, min_k: 2, max_k: 6, p: 0.55 }
    IOT_OTHER: { model_id: geometric_capK_v1, min_k: 2, max_k: 3, p: 0.60 }

access_policy:
  accounts_per_device_by_group:
    BACKEND_SERVER: { model_id: zi_poisson_capK_v1, min_k: 0, max_k: 4, p_zero: 0.35, mu: 1.0 }
    COMPUTER_PORTABLE: { model_id: zi_poisson_capK_v1, min_k: 0, max_k: 6, p_zero: 0.08, mu: 1.9 }
    CONSUMER_PERSONAL: { model_id: zi_poisson_capK_v1, min_k: 0, max_k: 5, p_zero: 0.05, mu: 1.6 }
    CONSUMER_SHARED: { model_id: zi_poisson_capK_v1, min_k: 0, max_k: 8, p_zero: 0.15, mu: 2.2 }
    IOT_OTHER: { model_id: zi_poisson_capK_v1, min_k: 0, max_k: 3, p_zero: 0.25, mu: 1.1 }
    MERCHANT_TERMINAL: { model_id: zi_poisson_capK_v1, min_k: 0, max_k: 2, p_zero: 0.60, mu: 0.6 }
  account_selection_scope: OWNERS_ONLY

  instruments_per_device_by_group:
    COMPUTER_PORTABLE: { model_id: zi_poisson_capK_v1, min_k: 0, max_k: 6, p_zero: 0.12, mu: 1.3 }
    CONSUMER_PERSONAL: { model_id: zi_poisson_capK_v1, min_k: 0, max_k: 6, p_zero: 0.10, mu: 1.4 }
    CONSUMER_SHARED: { model_id: zi_poisson_capK_v1, min_k: 0, max_k: 8, p_zero: 0.18, mu: 1.8 }
    IOT_OTHER: { model_id: zi_poisson_capK_v1, min_k: 0, max_k: 3, p_zero: 0.30, mu: 0.8 }
  instrument_selection_scope: FROM_SELECTED_ACCOUNTS_ONLY

degree_caps:
  per_device_by_group:
    BACKEND_SERVER: { max_parties: 0, max_accounts: 4, max_instruments: 0, max_merchants: 1 }
    COMPUTER_PORTABLE: { max_parties: 4, max_accounts: 6, max_instruments: 6, max_merchants: 0 }
    CONSUMER_PERSONAL: { max_parties: 4, max_accounts: 5, max_instruments: 6, max_merchants: 0 }
    CONSUMER_SHARED: { max_parties: 6, max_accounts: 8, max_instruments: 8, max_merchants: 0 }
    IOT_OTHER: { max_parties: 3, max_accounts: 3, max_instruments: 2, max_merchants: 0 }
    MERCHANT_TERMINAL: { max_parties: 0, max_accounts: 2, max_instruments: 0, max_merchants: 1 }
  per_entity_global:
    max_devices_per_party: 20
    max_devices_per_account: 12
    max_devices_per_instrument: 8
    max_devices_per_merchant: 40

forbidden_combinations:
  - rule_id: TERMINAL_NO_PARTY
    when: { device_group_id: MERCHANT_TERMINAL }
    forbid: { role_id: [PRIMARY_OWNER, SECONDARY_USER] }
  - rule_id: OWNER_NO_MERCHANT_FIELD
    when: { role_id: PRIMARY_OWNER }
    forbid: { merchant_id: ANY }
  - rule_id: BACKEND_NO_SECONDARY
    when: { device_group_id: BACKEND_SERVER }
    forbid: { role_id: [SECONDARY_USER] }

realism_targets:
  shared_fraction_range_by_group:
    COMPUTER_PORTABLE: { min: 0.02, max: 0.18 }
    CONSUMER_PERSONAL: { min: 0.00, max: 0.08 }
    CONSUMER_SHARED: { min: 0.10, max: 0.40 }
    IOT_OTHER: { min: 0.01, max: 0.15 }
  mean_parties_per_shared_device_range_by_group:
    CONSUMER_PERSONAL: { min: 2.0, max: 3.0 }
    CONSUMER_SHARED: { min: 2.2, max: 4.5 }
  mean_accounts_per_device_range_by_group:
    CONSUMER_PERSONAL: { min: 0.8, max: 2.8 }
    CONSUMER_SHARED: { min: 1.0, max: 3.8 }
  mean_instruments_per_device_range_by_group:
    CONSUMER_PERSONAL: { min: 0.6, max: 2.6 }
    CONSUMER_SHARED: { min: 0.8, max: 3.2 }
  fraction_devices_with_any_account_access_range_by_group:
    CONSUMER_PERSONAL: { min: 0.70, max: 0.98 }
    CONSUMER_SHARED: { min: 0.65, max: 0.98 }
  fraction_devices_with_any_instrument_access_range_by_group:
    CONSUMER_PERSONAL: { min: 0.55, max: 0.95 }
    CONSUMER_SHARED: { min: 0.55, max: 0.95 }
  enrichment_rules:
    - rule_id: SHARED_MORE_PARTIES
      compare: { group_a: CONSUMER_SHARED, group_b: CONSUMER_PERSONAL }
      min_ratio_mean_parties: 1.6

acceptance_checks:
  require_exactly_one_primary_owner_per_device: true
  require_terminal_devices_have_merchant_owner: true
  enforce_degree_caps: true
  enforce_forbidden_combinations: true

notes: >
  Device linkage rules keep ownership and access edges bounded while ensuring
  shared devices materially exist without dominating the population.
