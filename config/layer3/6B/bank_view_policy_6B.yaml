schema_version: 1
policy_id: bank_view_policy_6B
policy_version: v1

vocabulary:
  auth_decision_vocab: [APPROVE, DECLINE, REVIEW, CHALLENGE]
  detection_outcome_vocab: [DETECTED_AT_AUTH, DETECTED_POST_AUTH, NOT_DETECTED]
  bank_view_label_vocab:
    - BANK_CONFIRMED_FRAUD
    - BANK_CONFIRMED_LEGIT
    - NO_CASE_OPENED
    - CUSTOMER_DISPUTE_REJECTED
    - CHARGEBACK_WRITTEN_OFF
  dispute_outcome_vocab: [FILED, NOT_FILED]
  chargeback_type_vocab: [UNAUTHORISED, SERVICE_DISPUTE, OTHER]
  chargeback_outcome_vocab: [BANK_WIN, BANK_LOSS, PARTIAL, NONE]

inputs_allowed:
  required_sources: [s4_flow_truth_labels_6B, s3_flow_anchor_with_fraud_6B, s3_event_stream_with_fraud_6B]
  optional_sources: [s5_party_fraud_roles_6A, s5_account_fraud_roles_6A, s5_device_fraud_roles_6A]

auth_decision_model:
  mode: DETERMINISTIC_PLUS_MIXTURE_V1
  rules:
    - rule_id: AUTH_ALWAYS_DECLINE_CARD_TESTING
      when: { truth_subtype_in: [CARD_TESTING], channel_group_in: [ECOM, POS, HYBRID] }
      deterministic_decision: DECLINE

    - rule_id: AUTH_DEFAULT_MIX
      when: { any: true }
      pi_decision:
        - { auth_decision: APPROVE, prob: 0.965 }
        - { auth_decision: REVIEW, prob: 0.020 }
        - { auth_decision: CHALLENGE, prob: 0.010 }
        - { auth_decision: DECLINE, prob: 0.005 }
      rng_family: rng_event_detection_delay
      decision_id: auth_decision

detection_model:
  eligibility_rules:
    - { rule_id: DETECT_FRAUD_ABUSE, when: { truth_label_in: [FRAUD, ABUSE] }, eligible: true }
    - { rule_id: DETECT_LEGIT_RARE_FP, when: { truth_label_in: [LEGIT] }, eligible: true }

  class_conditioning:
    enabled: true
    fail_on_missing_profile: true
    merchant_class_globs:
      - "data/layer2/5A/merchant_class_profile/**/parameter_hash={parameter_hash}/manifest_fingerprint={manifest_fingerprint}/**/*.parquet"
      - "data/layer2/5A/merchant_class_profile/**/manifest_fingerprint={manifest_fingerprint}/**/*.parquet"
      - "runs/local_full_run-*/**/data/layer2/5A/merchant_class_profile/**/parameter_hash={parameter_hash}/manifest_fingerprint={manifest_fingerprint}/**/*.parquet"
      - "runs/local_full_run-*/**/data/layer2/5A/merchant_class_profile/**/manifest_fingerprint={manifest_fingerprint}/**/*.parquet"

  p_detect_by_truth_subtype:
    NONE: 0.002
    CARD_TESTING: 0.60
    ATO: 0.35
    REFUND_ABUSE: 0.20
    FRIENDLY_FRAUD: 0.10
    MERCHANT_COLLUSION: 0.25

  p_detect_class_multiplier:
    bills_utilities: 0.85
    consumer_daytime: 0.70
    evening_weekend: 1.10
    fuel_convenience: 1.35
    office_hours: 1.20
    online_24h: 2.00
    online_bursty: 2.80
    travel_hospitality: 1.70
    __UNK__: 1.00

  p_legit_fp_class_multiplier:
    bills_utilities: 0.55
    consumer_daytime: 0.60
    evening_weekend: 0.90
    fuel_convenience: 1.15
    office_hours: 0.95
    online_24h: 1.70
    online_bursty: 2.40
    travel_hospitality: 1.40
    __UNK__: 1.00

  p_detect_at_auth_given_detect:
    CARD_TESTING: 0.60
    ATO: 0.20
    REFUND_ABUSE: 0.08
    FRIENDLY_FRAUD: 0.05
    MERCHANT_COLLUSION: 0.15
    NONE: 0.40

  delay_model_id_for_post_auth_detection: DETECTION_DELAY_V1
  rng_family: rng_event_detection_delay
  decision_ids: [detect_flag, detect_at_auth_flag, detect_delay]

dispute_model:
  eligibility_rules:
    - { rule_id: DISPUTE_ELIGIBLE_ALL, when: { any: true }, eligible: true }

  p_dispute_by_truth_subtype:
    NONE: 0.002
    CARD_TESTING: 0.08
    ATO: 0.45
    REFUND_ABUSE: 0.35
    FRIENDLY_FRAUD: 0.55
    MERCHANT_COLLUSION: 0.12

  p_dispute_class_multiplier:
    bills_utilities: 0.75
    consumer_daytime: 0.70
    evening_weekend: 1.05
    fuel_convenience: 1.30
    office_hours: 1.10
    online_24h: 1.80
    online_bursty: 2.30
    travel_hospitality: 2.40
    __UNK__: 1.00

  delay_model_id_for_dispute: DISPUTE_DELAY_V1
  rng_family: rng_event_dispute_delay
  decision_ids: [dispute_flag, dispute_delay]

chargeback_model:
  eligibility_rules:
    - { rule_id: CB_ONLY_IF_DISPUTE, when: { dispute_filed: true }, eligible: true }
    - { rule_id: CB_ELSE_NOT, when: { dispute_filed: false }, eligible: false }

  p_chargeback_given_dispute:
    CARD_TESTING: 0.25
    ATO: 0.50
    REFUND_ABUSE: 0.25
    FRIENDLY_FRAUD: 0.40
    MERCHANT_COLLUSION: 0.20
    NONE: 0.05

  p_chargeback_class_multiplier:
    bills_utilities: 0.70
    consumer_daytime: 0.65
    evening_weekend: 1.00
    fuel_convenience: 1.25
    office_hours: 1.05
    online_24h: 1.60
    online_bursty: 2.10
    travel_hospitality: 1.85
    __UNK__: 1.00

  pi_chargeback_type:
    default:
      - { chargeback_type: UNAUTHORISED, prob: 0.70 }
      - { chargeback_type: SERVICE_DISPUTE, prob: 0.20 }
      - { chargeback_type: OTHER, prob: 0.10 }

  pi_chargeback_outcome:
    FRAUD:
      - { chargeback_outcome: BANK_LOSS, prob: 0.75 }
      - { chargeback_outcome: BANK_WIN, prob: 0.15 }
      - { chargeback_outcome: PARTIAL, prob: 0.10 }
    ABUSE:
      - { chargeback_outcome: BANK_LOSS, prob: 0.35 }
      - { chargeback_outcome: BANK_WIN, prob: 0.55 }
      - { chargeback_outcome: PARTIAL, prob: 0.10 }
    LEGIT:
      - { chargeback_outcome: BANK_LOSS, prob: 0.05 }
      - { chargeback_outcome: BANK_WIN, prob: 0.90 }
      - { chargeback_outcome: PARTIAL, prob: 0.05 }

  delay_model_id_for_chargeback: CHARGEBACK_DELAY_V1
  rng_family: rng_event_chargeback_delay
  decision_ids: [chargeback_flag, chargeback_type, chargeback_outcome, chargeback_delay]

case_lifecycle_model:
  open_case_when:
    - { rule_id: OPEN_ON_DETECTION, when: { detection_outcome_in: [DETECTED_AT_AUTH, DETECTED_POST_AUTH] }, open: true }
    - { rule_id: OPEN_ON_REVIEW, when: { auth_decision_in: [REVIEW, CHALLENGE] }, open: true }
    - { rule_id: OPEN_ON_DISPUTE, when: { dispute_filed: true }, open: true }

  case_open_ts_rule: MIN_OF_AVAILABLE
  case_close_delay_model_id: CASE_CLOSE_DELAY_V1
  rng_family: rng_event_case_timeline
  decision_ids: [case_close_delay]
  no_case_label: NO_CASE_OPENED

final_label_map:
  mode: rule_table_v1
  rules:
    - rule_id: LABEL_CHARGEBACK_WRITTEN_OFF
      when: { chargeback_outcome: BANK_LOSS }
      bank_view_label: CHARGEBACK_WRITTEN_OFF

    - rule_id: LABEL_DISPUTE_REJECTED
      when: { dispute_filed: true, chargeback_outcome_in: [BANK_WIN, PARTIAL] }
      bank_view_label: CUSTOMER_DISPUTE_REJECTED

    - rule_id: LABEL_CONFIRMED_FRAUD
      when: { truth_label_in: [FRAUD, ABUSE], detection_outcome_in: [DETECTED_AT_AUTH, DETECTED_POST_AUTH] }
      bank_view_label: BANK_CONFIRMED_FRAUD

    - rule_id: LABEL_CONFIRMED_LEGIT
      when: { truth_label: LEGIT }
      bank_view_label: BANK_CONFIRMED_LEGIT

    - rule_id: LABEL_NO_CASE
      when: { case_opened: false }
      bank_view_label: NO_CASE_OPENED

event_label_hints:
  detection_action_window:
    mark_is_detection_action_if_event_ts_between: [detection_ts_utc_minus, detection_ts_utc_plus]
    window_seconds: 60
  case_event_window:
    mark_is_case_event_if_event_ts_between: [case_opened_ts_utc_minus, case_closed_ts_utc_plus]
    window_seconds: 300

constraints:
  fail_on_unknown_enum: true
  require_one_row_per_flow: true
  require_timestamps_consistent_with_events: true
  forbid_time_travel: true

realism_targets:
  false_positive_rate_range: { min: 0.0005, max: 0.02 }
  detection_rate_range_by_truth_label:
    FRAUD: { min: 0.05, max: 0.95 }
    ABUSE: { min: 0.01, max: 0.60 }
    LEGIT: { min: 0.0001, max: 0.05 }
notes: "Bank-view outcomes are probabilistic via label_rng_policy_6B only."
