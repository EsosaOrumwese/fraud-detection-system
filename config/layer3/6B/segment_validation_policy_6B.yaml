schema_version: 1
policy_id: segment_validation_policy_6B
policy_version: v1

seal_rules:
  fail_on_any_required_failure: true
  fail_on_any_warn_failure: false
  warn_still_pass_max_fraction: 0.02
  info_never_blocks_pass: true
  required_check_min_coverage: 1.0
  bundle_hashing_law:
    mode: index_json_ascii_lex_raw_bytes_excluding_passed_flag

check_groups:
  - { group_id: UPSTREAM_GATES, description: "Upstream HashGates and sealed inputs." }
  - { group_id: SCHEMA_AND_KEYS, description: "Schema conformance and PK uniqueness." }
  - { group_id: COVERAGE_PARITY, description: "1:1 coverage across stages." }
  - { group_id: RNG_ACCOUNTING, description: "RNG families, budgets, and trace reconciliation." }
  - { group_id: TEMPORAL_INVARIANTS, description: "Monotone timestamps and in-horizon checks." }
  - { group_id: BEHAVIOURAL_REALISM, description: "Baseline realism corridors." }
  - { group_id: FRAUD_REALISM, description: "Campaign and mutation realism corridors." }
  - { group_id: BANK_VIEW_REALISM, description: "Detection/dispute/chargeback realism." }
  - { group_id: CASE_TIMELINE_REALISM, description: "Case volumes and duration realism." }

checks:
  - check_id: REQ_UPSTREAM_HASHGATES
    group_id: UPSTREAM_GATES
    severity: REQUIRED
    applies_to: [S0]
    expected_scope: fingerprint
    method: verify_upstream_passed_flags_and_digests
    fail_message: "Upstream HashGate verification failed or missing."

  - check_id: REQ_SEALED_INPUTS_PRESENT
    group_id: UPSTREAM_GATES
    severity: REQUIRED
    applies_to: [S0]
    expected_scope: fingerprint
    method: verify_sealed_inputs_required
    fail_message: "Required sealed policy/config inputs missing or unsealed."

  - check_id: REQ_PK_UNIQUENESS
    group_id: SCHEMA_AND_KEYS
    severity: REQUIRED
    applies_to: [S1, S2, S3, S4]
    expected_scope: seed_scenario
    method: pk_uniqueness_zero_duplicates
    threshold_ref: thresholds.max_duplicate_pk_count
    fail_message: "Duplicate primary keys detected."

  - check_id: REQ_FLOW_EVENT_PARITY
    group_id: COVERAGE_PARITY
    severity: REQUIRED
    applies_to: [S2, S3, S4]
    expected_scope: seed_scenario
    method: flow_event_parity_exact
    fail_message: "Flow/event parity mismatch across stages."

  - check_id: REQ_FLOW_LABEL_COVERAGE
    group_id: COVERAGE_PARITY
    severity: REQUIRED
    applies_to: [S4]
    expected_scope: seed_scenario
    method: flow_truth_and_bankview_cover_all_flows_exactly_once
    fail_message: "Truth/bank view coverage mismatch for flows."

  - check_id: REQ_RNG_BUDGETS
    group_id: RNG_ACCOUNTING
    severity: REQUIRED
    applies_to: [S1, S2, S3, S4]
    expected_scope: seed_scenario
    method: rng_families_and_budgets_match_policies
    threshold_ref: thresholds.rng_budget_violation_max
    fail_message: "RNG budgets/families do not match policy."

  - check_id: REQ_TIME_MONOTONE
    group_id: TEMPORAL_INVARIANTS
    severity: REQUIRED
    applies_to: [S2, S3, S4]
    expected_scope: seed_scenario
    method: event_timestamps_monotone_per_flow
    threshold_ref: thresholds.time_monotonicity_violation_max
    fail_message: "Event timestamps are not monotone per flow."

  - check_id: REQ_SCENARIO_OOB
    group_id: TEMPORAL_INVARIANTS
    severity: REQUIRED
    applies_to: [S2, S3, S4]
    expected_scope: seed_scenario
    method: timestamps_within_scenario_horizon
    threshold_ref: thresholds.scenario_oob_timestamp_max
    fail_message: "Timestamps outside scenario horizon."

  - check_id: WARN_BASELINE_REALISM
    group_id: BEHAVIOURAL_REALISM
    severity: WARN
    applies_to: [S2]
    expected_scope: seed_scenario
    method: baseline_realism_corridors
    threshold_ref: realism_corridors.baseline
    fail_message: "Baseline realism corridors violated."

  - check_id: WARN_FRAUD_REALISM
    group_id: FRAUD_REALISM
    severity: WARN
    applies_to: [S3]
    expected_scope: seed_scenario
    method: fraud_campaign_and_mutation_corridors
    threshold_ref: realism_corridors.fraud
    fail_message: "Fraud overlay realism corridors violated."

  - check_id: WARN_BANK_VIEW_REALISM
    group_id: BANK_VIEW_REALISM
    severity: WARN
    applies_to: [S4]
    expected_scope: seed_scenario
    method: bank_view_corridors
    threshold_ref: realism_corridors.bank_view
    fail_message: "Bank view realism corridors violated."

  - check_id: WARN_CASE_REALISM
    group_id: CASE_TIMELINE_REALISM
    severity: WARN
    applies_to: [S4]
    expected_scope: seed_scenario
    method: case_timeline_corridors
    threshold_ref: realism_corridors.cases
    fail_message: "Case timeline realism corridors violated."

thresholds:
  max_duplicate_pk_count: 0
  rng_budget_violation_max: 0
  time_monotonicity_violation_max: 0
  scenario_oob_timestamp_max: 0
  max_missing_fraction: 0.001

rng_accounting:
  rng_policies_required:
    - rng_policy_6B
    - flow_rng_policy_6B
    - fraud_rng_policy_6B
    - label_rng_policy_6B
  require_non_consuming_envelopes_when_deterministic: true

realism_corridors:
  baseline:
    decline_rate_range_by_channel:
      ECOM: { min: 0.01, max: 0.25 }
      POS: { min: 0.005, max: 0.20 }
      ATM: { min: 0.01, max: 0.30 }
    refund_rate_range_by_channel:
      ECOM: { min: 0.001, max: 0.08 }
      POS: { min: 0.001, max: 0.08 }
    multi_flow_fraction_range: { min: 0.01, max: 0.25 }
  fraud:
    fraud_fraction_range: { min: 0.0005, max: 0.10 }
    mutation_axis_coverage_min: 3
  bank_view:
    false_positive_rate_range: { min: 0.0005, max: 0.02 }
    detection_rate_range_by_truth_label:
      FRAUD: { min: 0.05, max: 0.95 }
      ABUSE: { min: 0.01, max: 0.60 }
      LEGIT: { min: 0.0001, max: 0.05 }
  cases:
    case_involvement_fraction_range: { min: 0.0005, max: 0.20 }
    mean_flows_per_case_range: { min: 1.1, max: 20.0 }
    mean_case_duration_range_seconds: { min: 3600.0, max: 1728000.0 }
    chargeback_case_fraction_range: { min: 0.0001, max: 0.05 }

reporting:
  include_issue_table: true
  issue_table_max_rows: 20000
  validation_bundle_contents:
    - s5_validation_report_6B.json
    - s5_issue_table_6B.parquet
notes: "S5 validation is fail-closed on required checks; realism corridors emit WARN by default."
