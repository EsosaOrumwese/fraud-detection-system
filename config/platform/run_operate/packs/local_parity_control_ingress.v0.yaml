version: 1
pack_id: local_parity_control_ingress_v0
description: "Control/Ingress always-on processes for local parity."
active_run:
  required: false
  source_path: runs/fraud-platform/ACTIVE_RUN_ID
defaults:
  cwd: .
  env:
    PYTHONUNBUFFERED: "1"
    PYTHONPATH: src
    RUN_OPERATE_PYTHON: ${RUN_OPERATE_PYTHON:-.venv/Scripts/python.exe}
    PLATFORM_STORE_ROOT: ${PLATFORM_STORE_ROOT:-s3://fraud-platform}
    PLATFORM_RUN_ID: ${ACTIVE_PLATFORM_RUN_ID:-}
    OBJECT_STORE_ENDPOINT: ${PARITY_OBJECT_STORE_ENDPOINT}
    OBJECT_STORE_REGION: ${PARITY_OBJECT_STORE_REGION}
    ORACLE_ROOT: ${ORACLE_ROOT}
    ORACLE_ENGINE_RUN_ROOT: ${ORACLE_ENGINE_RUN_ROOT}
    ORACLE_SCENARIO_ID: ${ORACLE_SCENARIO_ID}
    ORACLE_STREAM_VIEW_ROOT: ${ORACLE_STREAM_VIEW_ROOT}
    IG_ADMISSION_DSN: ${PARITY_IG_ADMISSION_DSN}
    WSP_CHECKPOINT_DSN: ${PARITY_WSP_CHECKPOINT_DSN}
    EVENT_BUS_STREAM: ${PARITY_EVENT_BUS_STREAM}
    EVENT_BUS_REGION: ${PARITY_EVENT_BUS_REGION}
    EVENT_BUS_ENDPOINT_URL: ${PARITY_EVENT_BUS_ENDPOINT_URL}
    CONTROL_BUS_STREAM: ${PARITY_CONTROL_BUS_STREAM}
    CONTROL_BUS_REGION: ${PARITY_CONTROL_BUS_REGION}
    CONTROL_BUS_ENDPOINT_URL: ${PARITY_CONTROL_BUS_ENDPOINT_URL}
    IG_INGEST_URL: ${PARITY_IG_INGEST_URL}
    AWS_ACCESS_KEY_ID: ${PARITY_MINIO_ACCESS_KEY}
    AWS_SECRET_ACCESS_KEY: ${PARITY_MINIO_SECRET_KEY}
    AWS_EC2_METADATA_DISABLED: ${PARITY_AWS_EC2_METADATA_DISABLED}
    AWS_DEFAULT_REGION: ${PARITY_CONTROL_BUS_REGION}
    AWS_ENDPOINT_URL: ${PARITY_CONTROL_BUS_ENDPOINT_URL}
    WSP_MAX_EVENTS_PER_OUTPUT: ${WSP_MAX_EVENTS_PER_OUTPUT:-500000}
    WSP_READY_REQUIRED_PACKS: ${WSP_READY_REQUIRED_PACKS:-config/platform/run_operate/packs/local_parity_rtdl_core.v0.yaml,config/platform/run_operate/packs/local_parity_rtdl_decision_lane.v0.yaml,config/platform/run_operate/packs/local_parity_case_labels.v0.yaml,config/platform/run_operate/packs/local_parity_obs_gov.v0.yaml}
    WSP_READY_REQUIRE_ACTIVE_RUN_MATCH: ${WSP_READY_REQUIRE_ACTIVE_RUN_MATCH:-1}
    WSP_READY_REQUIRED_PACK_CHECK_INTERVAL_SECONDS: ${WSP_READY_REQUIRED_PACK_CHECK_INTERVAL_SECONDS:-2}
    WSP_READY_REQUIRED_PACK_LOG_INTERVAL_SECONDS: ${WSP_READY_REQUIRED_PACK_LOG_INTERVAL_SECONDS:-20}
processes:
  - id: ig_service
    command:
      - ${RUN_OPERATE_PYTHON}
      - -m
      - fraud_detection.ingestion_gate.service
      - --profile
      - config/platform/profiles/local_parity.yaml
      - --host
      - ${IG_HOST:-127.0.0.1}
      - --port
      - ${IG_PORT:-8081}
    readiness:
      type: tcp
      host: ${IG_HOST:-127.0.0.1}
      port: ${IG_PORT:-8081}
      timeout_seconds: 2.0
  - id: wsp_ready_consumer
    command:
      - ${RUN_OPERATE_PYTHON}
      - -m
      - fraud_detection.world_streamer_producer.ready_consumer
      - --profile
      - config/platform/profiles/local_parity.yaml
      - --poll-seconds
      - ${WSP_READY_POLL_SECONDS:-0.5}
      - --max-events-per-output
      - ${WSP_MAX_EVENTS_PER_OUTPUT}
    readiness:
      type: process_alive
