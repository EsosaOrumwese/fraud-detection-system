version: 1
pack_id: local_parity_rtdl_core_v0
description: "RTDL live-capable worker pack (IEG/OFP/CSFB) for local parity."
active_run:
  required: true
  source_path: runs/fraud-platform/ACTIVE_RUN_ID
defaults:
  cwd: .
  env:
    PYTHONUNBUFFERED: "1"
    PYTHONPATH: src
    RUN_OPERATE_PYTHON: ${RUN_OPERATE_PYTHON:-.venv/Scripts/python.exe}
    PLATFORM_STORE_ROOT: ${PLATFORM_STORE_ROOT:-s3://fraud-platform}
    PLATFORM_RUN_ID: ${ACTIVE_PLATFORM_RUN_ID}
    OBJECT_STORE_ENDPOINT: ${PARITY_OBJECT_STORE_ENDPOINT}
    OBJECT_STORE_REGION: ${PARITY_OBJECT_STORE_REGION}
    ORACLE_ROOT: ${ORACLE_ROOT}
    IG_ADMISSION_DSN: ${PARITY_IG_ADMISSION_DSN}
    WSP_CHECKPOINT_DSN: ${PARITY_WSP_CHECKPOINT_DSN}
    EVENT_BUS_STREAM: ${PARITY_EVENT_BUS_STREAM}
    EVENT_BUS_REGION: ${PARITY_EVENT_BUS_REGION}
    EVENT_BUS_ENDPOINT_URL: ${PARITY_EVENT_BUS_ENDPOINT_URL}
    CONTROL_BUS_STREAM: ${PARITY_CONTROL_BUS_STREAM}
    CONTROL_BUS_REGION: ${PARITY_CONTROL_BUS_REGION}
    CONTROL_BUS_ENDPOINT_URL: ${PARITY_CONTROL_BUS_ENDPOINT_URL}
    IEG_HEALTH_AMBER_WATERMARK_AGE_SECONDS: ${IEG_HEALTH_AMBER_WATERMARK_AGE_SECONDS:-500000000}
    IEG_HEALTH_RED_WATERMARK_AGE_SECONDS: ${IEG_HEALTH_RED_WATERMARK_AGE_SECONDS:-800000000}
    IEG_HEALTH_AMBER_CHECKPOINT_AGE_SECONDS: ${IEG_HEALTH_AMBER_CHECKPOINT_AGE_SECONDS:-86400}
    IEG_HEALTH_RED_CHECKPOINT_AGE_SECONDS: ${IEG_HEALTH_RED_CHECKPOINT_AGE_SECONDS:-172800}
    OFP_HEALTH_AMBER_WATERMARK_AGE_SECONDS: ${OFP_HEALTH_AMBER_WATERMARK_AGE_SECONDS:-500000000}
    OFP_HEALTH_RED_WATERMARK_AGE_SECONDS: ${OFP_HEALTH_RED_WATERMARK_AGE_SECONDS:-800000000}
    OFP_HEALTH_AMBER_CHECKPOINT_AGE_SECONDS: ${OFP_HEALTH_AMBER_CHECKPOINT_AGE_SECONDS:-86400}
    OFP_HEALTH_RED_CHECKPOINT_AGE_SECONDS: ${OFP_HEALTH_RED_CHECKPOINT_AGE_SECONDS:-172800}
    OFP_HEALTH_AMBER_MISSING_FEATURES: ${OFP_HEALTH_AMBER_MISSING_FEATURES:-100000}
    OFP_HEALTH_RED_MISSING_FEATURES: ${OFP_HEALTH_RED_MISSING_FEATURES:-200000}
    OFP_HEALTH_AMBER_STALE_GRAPH_VERSION: ${OFP_HEALTH_AMBER_STALE_GRAPH_VERSION:-50}
    OFP_HEALTH_RED_STALE_GRAPH_VERSION: ${OFP_HEALTH_RED_STALE_GRAPH_VERSION:-200}
    OFP_HEALTH_AMBER_SNAPSHOT_FAILURES: ${OFP_HEALTH_AMBER_SNAPSHOT_FAILURES:-50}
    OFP_HEALTH_RED_SNAPSHOT_FAILURES: ${OFP_HEALTH_RED_SNAPSHOT_FAILURES:-200}
    CSFB_HEALTH_AMBER_WATERMARK_AGE_SECONDS: ${CSFB_HEALTH_AMBER_WATERMARK_AGE_SECONDS:-500000000}
    CSFB_HEALTH_RED_WATERMARK_AGE_SECONDS: ${CSFB_HEALTH_RED_WATERMARK_AGE_SECONDS:-800000000}
    CSFB_HEALTH_AMBER_CHECKPOINT_AGE_SECONDS: ${CSFB_HEALTH_AMBER_CHECKPOINT_AGE_SECONDS:-86400}
    CSFB_HEALTH_RED_CHECKPOINT_AGE_SECONDS: ${CSFB_HEALTH_RED_CHECKPOINT_AGE_SECONDS:-172800}
    AWS_ACCESS_KEY_ID: ${PARITY_MINIO_ACCESS_KEY}
    AWS_SECRET_ACCESS_KEY: ${PARITY_MINIO_SECRET_KEY}
    AWS_EC2_METADATA_DISABLED: ${PARITY_AWS_EC2_METADATA_DISABLED}
processes:
  - id: ieg_projector
    command:
      - ${RUN_OPERATE_PYTHON}
      - -m
      - fraud_detection.identity_entity_graph.projector
      - --profile
      - config/platform/profiles/local_parity.yaml
    env:
      IEG_REQUIRED_PLATFORM_RUN_ID: ${ACTIVE_PLATFORM_RUN_ID}
      IEG_PROJECTION_DSN: ${PARITY_IEG_PROJECTION_DSN}
    readiness:
      type: process_alive
  - id: ofp_projector
    command:
      - ${RUN_OPERATE_PYTHON}
      - -m
      - fraud_detection.online_feature_plane.projector
      - --profile
      - config/platform/profiles/local_parity.yaml
    env:
      OFP_REQUIRED_PLATFORM_RUN_ID: ${ACTIVE_PLATFORM_RUN_ID}
      OFP_EVENT_BUS_START_POSITION: ${OFP_EVENT_BUS_START_POSITION:-trim_horizon}
      OFP_PROJECTION_DSN: ${PARITY_OFP_PROJECTION_DSN}
      OFP_SNAPSHOT_INDEX_DSN: ${PARITY_OFP_SNAPSHOT_INDEX_DSN}
    readiness:
      type: process_alive
  - id: csfb_intake
    command:
      - ${RUN_OPERATE_PYTHON}
      - -m
      - fraud_detection.context_store_flow_binding.intake
      - --policy
      - config/platform/profiles/local_parity.yaml
    env:
      CSFB_REQUIRED_PLATFORM_RUN_ID: ${ACTIVE_PLATFORM_RUN_ID}
      CSFB_PROJECTION_DSN: ${PARITY_CSFB_PROJECTION_DSN}
      CSFB_EVENT_BUS_START_POSITION: ${CSFB_EVENT_BUS_START_POSITION:-trim_horizon}
    readiness:
      type: process_alive
